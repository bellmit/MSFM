<HTML><HEAD><META CONTENT="text/html; charset=ISO-8859-1" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Thu Mar 03 13:21:58 CST 2011)</TH></TR><TR><TD CLASS="nv">[<A HREF="../coverage.html">all classes</A>][<A HREF="55.html">com.cboe.server.util.productData</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">ProductDataCacheImpl.java</SPAN>]</H2><TABLE CELLSPACING="0" WIDTH="100%"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>ProductDataCacheImpl.java</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/132)</TD><TD CLASS="h">0%   (0/6795)</TD><TD CLASS="h">0%   (0/1297)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">ProductDataCacheImpl</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/125)</TD><TD CLASS="h">0%   (0/6232)</TD><TD CLASS="h">0%   (0/1205)</TD></TR><TR><TD CLASS="f"><A HREF="#1">&lt;static initializer&gt;</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">ProductDataCacheImpl (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/106)</TD><TD CLASS="h">0%   (0/24)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$000 (ProductDataCacheImpl): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$002 (ProductDataCacheImpl, boolean): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$100 (ProductDataCacheImpl): Logger</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$1000 (ProductDataCacheImpl, ProductClassDataImpl, ProductDataImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$1100 (ProductDataCacheImpl, ReportingClassDataImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$1200 (ProductDataCacheImpl, ProductDataImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$200 (ProductDataCacheImpl): Exception []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$300 (ProductDataCacheImpl): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$310 (ProductDataCacheImpl): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/8)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$400 (ProductDataCacheImpl): ArrayList</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$500 (ProductDataCacheImpl, int, IntHashMap, IntHashMap, IntHashMap, Co...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$600 (ProductDataCacheImpl): ConcurrentIntHashMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$700 (ProductDataCacheImpl): IntHashMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$800 (ProductDataCacheImpl): ConcurrentIntHashMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$900 (ProductDataCacheImpl): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$908 (ProductDataCacheImpl): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/8)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#13">addNewProd (ProductClassDataImpl, int, ProductStruct, ProductInformationStruc...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/57)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">addNewProd (int, ProductStructV4): ProductDataImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/85)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR><TD CLASS="f"><A HREF="#15">addNewProdToCache (ProductClassDataImpl, Set, ProductStruct, ProductDataImpl,...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/59)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#16">adminShowClasses (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/114)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR><TD CLASS="f"><A HREF="#17">adminShowLinkageClasses (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/115)</TD><TD CLASS="h">0%   (0/25)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#18">adminShowProduct (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/227)</TD><TD CLASS="h">0%   (0/39)</TD></TR><TR><TD CLASS="f"><A HREF="#19">adminShowProducts (String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/435)</TD><TD CLASS="h">0%   (0/65)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1a">adminShowRolloutClasses (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/128)</TD><TD CLASS="h">0%   (0/25)</TD></TR><TR><TD CLASS="f"><A HREF="#1b">adminSpreadTradeServerRolloutIndicator (String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/72)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1c">allAdjustmentsAppliedNotice (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1d">calculatePriceDifferenceForCall (ProductLegData, ProductLegData, ProductLegDa...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/36)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1e">calculatePriceDifferenceForPut (ProductLegData, ProductLegData, ProductLegDat...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/36)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#1f">calculatePriceDifferenceForVerticles (ProductLegData, ProductLegData, Product...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/49)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#20">calculatePriceProtectionForStrategy (ProductDataImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/42)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#21">calculatePriceProtectionForStrategyProducts (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/29)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#22">calculatePriceProtectionForThreeLegsStrategy (ProductDataImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/251)</TD><TD CLASS="h">0%   (0/43)</TD></TR><TR><TD CLASS="f"><A HREF="#23">calculatePriceProtectionForVerticalStrategy (ProductDataImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/77)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#24">checkLegProds (ConcurrentIntHashMap, StrategyLegStruct [], StrategyStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/142)</TD><TD CLASS="h">0%   (0/27)</TD></TR><TR><TD CLASS="f"><A HREF="#25">clearCache (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/37)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#26">cloneProdCacheWithAddition (ProductClassDataImpl, ProductStruct [], StrategyS...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/123)</TD><TD CLASS="h">0%   (0/25)</TD></TR><TR><TD CLASS="f"><A HREF="#27">cloneProdCacheWithAddition (ProductClassDataImpl, ProductStruct, ProductInfor...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/35)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#28">cloneProdCacheWithAddition (ProductStructV4 [], StrategyStruct [], ProductCla...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/38)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#29">createProdCacheStruct (ConcurrentIntHashMap, ProductStructV4 [], StrategyStru...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/71)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2a">createProdClassCacheStruct (ProductClassStructV3): ProductClassDataImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/126)</TD><TD CLASS="h">0%   (0/31)</TD></TR><TR><TD CLASS="f"><A HREF="#2b">createProductCacheStruct (ProductStruct, ProductInformationStruct): ProductDa...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2c">createProductCacheStruct (ProductStructV4): ProductDataImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/46)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#2d">createProductCacheStruct (StrategyStruct): ProductDataImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2e">createRptClassCacheStruct (IntHashMap, ReportingClassStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/47)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#2f">downLoadAdditionalClassesAndSessions (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/169)</TD><TD CLASS="h">0%   (0/29)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#30">downloadPCSGroup (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/221)</TD><TD CLASS="h">0%   (0/34)</TD></TR><TR><TD CLASS="f"><A HREF="#31">downloadSpreadNormalizationStrategy (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/14)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#32">dump (MsgBuilder, String, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#33">dumpAll (MsgBuilder): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/27)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#34">dumpOneClass (MsgBuilder, int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/70)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR><TD CLASS="f"><A HREF="#35">dumpOneProd (MsgBuilder, int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#36">fetchClassStructFromGlobal (int, boolean): ProductClassStructV3</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/85)</TD><TD CLASS="h">0%   (0/24)</TD></TR><TR><TD CLASS="f"><A HREF="#37">fetchProductStructFromGlobal (int): ProductStructV4</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/138)</TD><TD CLASS="h">0%   (0/21)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#38">fetchStrategyStructByClassFromGlobal (int, boolean): StrategyStruct []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/127)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR><TD CLASS="f"><A HREF="#39">fetchStrategyStructByProdFromGlobal (int): StrategyStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/159)</TD><TD CLASS="h">0%   (0/22)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3a">getAllClassKeys (): Integer []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#3b">getAllSessionNamesForCache (): Set</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3c">getAssociatedStrategyKeys (int): Set</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#3d">getBusinessDay (): BusinessDayStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/59)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3e">getDownloadException (): Exception []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#3f">getLocalProductDataCacheCount (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#40">getParsedPostOrStation (String, int): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#41">getProductClassData (int): ProductClassData</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#42">getProductClassDataBySymbolRegex (String): List</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#43">getProductClassKeysByGroup (String): int []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#44">getProductData (int): ProductData</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/40)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#45">getReportingClassData (int): ReportingClassData</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/36)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#46">getSpreadNormalizationStrategyType (): short</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#47">getStrategyPriceProtection (double): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/14)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#48">initCacheForClassDownload (int, IntHashMap, IntHashMap, IntHashMap, Concurren...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/134)</TD><TD CLASS="h">0%   (0/29)</TD></TR><TR><TD CLASS="f"><A HREF="#49">isStrategy (ProductStruct): StrategyStruct []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/40)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4a">notifyListeners (ProductClassDataImpl, ProductDataImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/66)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR><TD CLASS="f"><A HREF="#4b">notifyListeners (ProductDataImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/51)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4c">notifyListeners (ReportingClassDataImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/51)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#4d">parseNonZeroIntKeyParam (String): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4e">populateProdState (ProductDataImpl): ProductDataImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#4f">postInitialize (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#50">postStart (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#51">priceAdjustmentAppliedNotice (PendingAdjustmentStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#52">priceAdjustmentUpdatedNotice (PendingAdjustmentStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#53">registerForUpdates (int, ProductDataCache$ProductClassDataUpdateListener): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/61)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#54">registerForUpdates (int, ProductDataCache$ProductDataUpdateListener): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/61)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR><TD CLASS="f"><A HREF="#55">registerForUpdates (int, ProductDataCache$ReportingClassDataUpdateListener): ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/61)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#56">setAdditionalSessions (String []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/60)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#57">setClassState (ClassStateStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#58">setCommonConfig (DIFCommonConfig): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/46)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#59">setGroupNames (List): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5a">setIgnoreLowSeqNumbers (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#5b">setLogger (Logger): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5c">setProdStateBySession (String, int, ProductDataImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/135)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR><TD CLASS="f"><A HREF="#5d">setProductConfigurationService (ProductConfigurationService): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5e">setProductMaintenanceService (ProductMaintenanceService): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#5f">setProductQueryService (ProductQueryService): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#60">setProductStates (int, String, ProductStateStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#61">setSpreadServerRolloutCompleted (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#62">setTempRolloutFlag (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/97)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR><TD CLASS="f"><A HREF="#63">setTradingSessionService (TradingSessionService): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#64">startDataDownload (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/61)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR><TD CLASS="f"><A HREF="#65">updateCachedProd (ProductStruct, ProductInformationStruct, short, StrategyLeg...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/118)</TD><TD CLASS="h">0%   (0/25)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#66">updateLinkageIndicator (LinkageIndicatorResultStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/68)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR><TD CLASS="f"><A HREF="#67">updateProdCache (ConcurrentIntHashMap, ProductStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#68">updateProdCache (ConcurrentIntHashMap, ProductStructV4 []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#69">updateProdCache (ConcurrentIntHashMap, StrategyStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6a">updateProdClassCache (ProductClassDataImpl, ProductClassStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/82)</TD><TD CLASS="h">0%   (0/22)</TD></TR><TR><TD CLASS="f"><A HREF="#6b">updateProdClassCache (ProductClassDataImpl, ProductClassStructV3): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/82)</TD><TD CLASS="h">0%   (0/22)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6c">updateProdState (ProductStateStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/140)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR><TD CLASS="f"><A HREF="#6d">updateProduct (ProductStruct, ProductInformationStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6e">updateProduct (ProductStruct, short, StrategyLegStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#6f">updateProductClass (ProductClassStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/51)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#70">updateProductClassV3 (ProductClassStructV3): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/51)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR><TD CLASS="f"><A HREF="#71">updateProductOpenInterest (int, ProductOpenInterestStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#72">updateProductStrategy (StrategyStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#73">updateProductV4 (ProductStructV4): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#74">updateQPEIndicator (int, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/43)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#75">updateReportingClass (ReportingClassStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#76">updateRptClassCache (IntHashMap, ReportingClassStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/27)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#77">updateRptClassCacheWithAddition (ReportingClassStruct []): IntHashMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#78">updateWithLegInfo (ProductDataImpl, StrategyStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#79">updateWithLegInfo (ProductDataImpl, short, StrategyLegStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/64)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7a">verifyProdClassQueryStatus (int): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#7b">verifyProductQueryStatus (int): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7c">waitForDownloadToComplete (): Exception []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/58)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR><TD CLASS="f"><A HREF="#7d">writeBasicProductDescription (PrintWriter, ProductData, MsgBuilder): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/130)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#7e">ProductDataCacheImpl$1</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#7e">ProductDataCacheImpl$1 (ProductDataCacheImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#80">compare (ProductClassData, ProductClassData): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#81">ProductDataCacheImpl$2</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#81">ProductDataCacheImpl$2 (ProductDataCacheImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#83">compare (ProductData, ProductData): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#84">ProductDataCacheImpl$ProductDataDownload</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/539)</TD><TD CLASS="h">0%   (0/90)</TD></TR><TR><TD CLASS="f"><A HREF="#84">ProductDataCacheImpl$ProductDataDownload (ProductDataCacheImpl, int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#86">downloadProducts (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/349)</TD><TD CLASS="h">0%   (0/67)</TD></TR><TR><TD CLASS="f"><A HREF="#87">run (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/180)</TD><TD CLASS="h">0%   (0/19)</TD></TR></TABLE><P></P><TABLE CLASS="s" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="l">1</TD><TD>package com.cboe.server.util.productData;</TD></TR><TR><TD CLASS="l">2</TD><TD> </TD></TR><TR><TD CLASS="l">3</TD><TD>import java.io.CharArrayWriter;</TD></TR><TR><TD CLASS="l">4</TD><TD>import java.io.PrintWriter;</TD></TR><TR><TD CLASS="l">5</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">6</TD><TD>import java.util.Collections;</TD></TR><TR><TD CLASS="l">7</TD><TD>import java.util.Comparator;</TD></TR><TR><TD CLASS="l">8</TD><TD>import java.util.HashMap;</TD></TR><TR><TD CLASS="l">9</TD><TD>import java.util.HashSet;</TD></TR><TR><TD CLASS="l">10</TD><TD>import java.util.Iterator;</TD></TR><TR><TD CLASS="l">11</TD><TD>import java.util.List;</TD></TR><TR><TD CLASS="l">12</TD><TD>import java.util.Map;</TD></TR><TR><TD CLASS="l">13</TD><TD>import java.util.NoSuchElementException;</TD></TR><TR><TD CLASS="l">14</TD><TD>import java.util.Set;</TD></TR><TR><TD CLASS="l">15</TD><TD>import java.util.StringTokenizer;</TD></TR><TR><TD CLASS="l">16</TD><TD>import java.util.regex.Pattern;</TD></TR><TR><TD CLASS="l">17</TD><TD> </TD></TR><TR><TD CLASS="l">18</TD><TD>import com.cboe.domain.util.DateWrapper;</TD></TR><TR><TD CLASS="l">19</TD><TD>import com.cboe.domain.util.PriceFactory;</TD></TR><TR><TD CLASS="l">20</TD><TD>import com.cboe.domain.util.ProductStructBuilder;</TD></TR><TR><TD CLASS="l">21</TD><TD>import com.cboe.domain.util.TradingSessionNameHelper;</TD></TR><TR><TD CLASS="l">22</TD><TD>import com.cboe.domain.util.intMaps.ConcurrentIntHashMap;</TD></TR><TR><TD CLASS="l">23</TD><TD>import com.cboe.domain.util.intMaps.IntHashMap;</TD></TR><TR><TD CLASS="l">24</TD><TD>import com.cboe.domain.util.intMaps.IntMapEntry;</TD></TR><TR><TD CLASS="l">25</TD><TD>import com.cboe.exceptions.AuthorizationException;</TD></TR><TR><TD CLASS="l">26</TD><TD>import com.cboe.exceptions.CommunicationException;</TD></TR><TR><TD CLASS="l">27</TD><TD>import com.cboe.exceptions.DataValidationException;</TD></TR><TR><TD CLASS="l">28</TD><TD>import com.cboe.exceptions.NotFoundException;</TD></TR><TR><TD CLASS="l">29</TD><TD>import com.cboe.exceptions.SystemException;</TD></TR><TR><TD CLASS="l">30</TD><TD>import com.cboe.idl.cmiConstants.ListingStates;</TD></TR><TR><TD CLASS="l">31</TD><TD>import com.cboe.idl.cmiConstants.OptionTypes;</TD></TR><TR><TD CLASS="l">32</TD><TD>import com.cboe.idl.cmiConstants.ProductStates;</TD></TR><TR><TD CLASS="l">33</TD><TD>import com.cboe.idl.cmiConstants.ProductTypes;</TD></TR><TR><TD CLASS="l">34</TD><TD>import com.cboe.idl.cmiConstants.Sides;</TD></TR><TR><TD CLASS="l">35</TD><TD>import com.cboe.idl.cmiConstants.StrategyTypes;</TD></TR><TR><TD CLASS="l">36</TD><TD>import com.cboe.idl.cmiErrorCodes.NotFoundCodes;</TD></TR><TR><TD CLASS="l">37</TD><TD>import com.cboe.idl.cmiProduct.ClassStruct;</TD></TR><TR><TD CLASS="l">38</TD><TD>import com.cboe.idl.cmiProduct.PendingAdjustmentStruct;</TD></TR><TR><TD CLASS="l">39</TD><TD>import com.cboe.idl.cmiProduct.ProductStruct;</TD></TR><TR><TD CLASS="l">40</TD><TD>import com.cboe.idl.cmiProduct.ReportingClassStruct;</TD></TR><TR><TD CLASS="l">41</TD><TD>import com.cboe.idl.cmiSession.ClassStateStruct;</TD></TR><TR><TD CLASS="l">42</TD><TD>import com.cboe.idl.cmiSession.ProductStateStruct;</TD></TR><TR><TD CLASS="l">43</TD><TD>import com.cboe.idl.cmiSession.SessionClassStruct;</TD></TR><TR><TD CLASS="l">44</TD><TD>import com.cboe.idl.cmiSession.SessionProductStruct;</TD></TR><TR><TD CLASS="l">45</TD><TD>import com.cboe.idl.cmiStrategy.StrategyLegStruct;</TD></TR><TR><TD CLASS="l">46</TD><TD>import com.cboe.idl.cmiStrategy.StrategyStruct;</TD></TR><TR><TD CLASS="l">47</TD><TD>import com.cboe.idl.product.LinkageIndicatorResultStruct;</TD></TR><TR><TD CLASS="l">48</TD><TD>import com.cboe.idl.product.ProductClassStruct;</TD></TR><TR><TD CLASS="l">49</TD><TD>import com.cboe.idl.product.ProductClassStructV3;</TD></TR><TR><TD CLASS="l">50</TD><TD>import com.cboe.idl.product.ProductInformationStruct;</TD></TR><TR><TD CLASS="l">51</TD><TD>import com.cboe.idl.product.ProductOpenInterestStruct;</TD></TR><TR><TD CLASS="l">52</TD><TD>import com.cboe.idl.product.ProductStructV4;</TD></TR><TR><TD CLASS="l">53</TD><TD>import com.cboe.idl.session.BusinessDaySessionStruct;</TD></TR><TR><TD CLASS="l">54</TD><TD>import com.cboe.idl.session.BusinessDayStruct;</TD></TR><TR><TD CLASS="l">55</TD><TD>import com.cboe.infrastructureServices.foundationFramework.exceptionHandling.FatalFoundationFrameworkException;</TD></TR><TR><TD CLASS="l">56</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.Log;</TD></TR><TR><TD CLASS="l">57</TD><TD>import com.cboe.interfaces.businessServices.ProductQueryService;</TD></TR><TR><TD CLASS="l">58</TD><TD>import com.cboe.interfaces.businessServices.TradingSessionService;</TD></TR><TR><TD CLASS="l">59</TD><TD>import com.cboe.interfaces.domain.Price;</TD></TR><TR><TD CLASS="l">60</TD><TD>import com.cboe.interfaces.domain.TradingProduct;</TD></TR><TR><TD CLASS="l">61</TD><TD>import com.cboe.interfaces.events.ProductStateConsumer;</TD></TR><TR><TD CLASS="l">62</TD><TD>import com.cboe.interfaces.events.ProductStatusConsumer;</TD></TR><TR><TD CLASS="l">63</TD><TD>import com.cboe.interfaces.internalBusinessServices.ProductConfigurationService;</TD></TR><TR><TD CLASS="l">64</TD><TD>import com.cboe.interfaces.internalBusinessServices.ProductMaintenanceService;</TD></TR><TR><TD CLASS="l">65</TD><TD>import com.cboe.interfaces.productData.ProductClassData;</TD></TR><TR><TD CLASS="l">66</TD><TD>import com.cboe.interfaces.productData.ProductData;</TD></TR><TR><TD CLASS="l">67</TD><TD>import com.cboe.interfaces.productData.ProductDataCache;</TD></TR><TR><TD CLASS="l">68</TD><TD>import com.cboe.interfaces.productData.ProductLegData;</TD></TR><TR><TD CLASS="l">69</TD><TD>import com.cboe.interfaces.productData.ReportingClassData;</TD></TR><TR><TD CLASS="l">70</TD><TD>import com.cboe.server.dependencyFramework.DIFCommonConfig;</TD></TR><TR><TD CLASS="l">71</TD><TD>import com.cboe.server.dependencyFramework.DIFObject;</TD></TR><TR><TD CLASS="l">72</TD><TD>import com.cboe.server.dependencyFramework.FFCommand;</TD></TR><TR><TD CLASS="l">73</TD><TD>import com.cboe.server.dependencyFramework.FFProperty;</TD></TR><TR><TD CLASS="l">74</TD><TD>import com.cboe.server.dependencyFramework.FFServiceDependency;</TD></TR><TR><TD CLASS="l">75</TD><TD>import com.cboe.server.logger.Logger;</TD></TR><TR><TD CLASS="l"><A NAME="0">76</A></TD><TD>import com.cboe.server.logger.MsgBuilder;</TD></TR><TR><TD CLASS="l">77</TD><TD>import com.cboe.server.util.ConstantIntMapper;</TD></TR><TR><TD CLASS="l">78</TD><TD>import com.cboe.util.ExceptionBuilder;</TD></TR><TR><TD CLASS="l">79</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">80</TD><TD>public final class ProductDataCacheImpl implements DIFObject, ProductStateConsumer, ProductStatusConsumer, ProductDataCache</TD></TR><TR><TD CLASS="l">81</TD><TD>{</TD></TR><TR><TD CLASS="l"><A NAME="1">82</A></TD><TD>    //TODO: Could hurt GC if all BCs request downloads at the same time</TD></TR><TR><TD CLASS="l">83</TD><TD>        private static final int DOWNLOAD_PDS_THREAD_COUNT = 3; //15;</TD></TR><TR><TD CLASS="l">84</TD><TD>        private static final int LOG_EVERY_N_PERCENT = 10;</TD></TR><TR><TD CLASS="l">85</TD><TD>        private static final String SESS_LIST_DELIMITER = &#34;|&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">86</TD><TD>        private static final Pattern SESS_LIST_SPLIT = Pattern.compile(&#34;\\&#34;+SESS_LIST_DELIMITER);</TD></TR><TR CLASS="z"><TD CLASS="l">87</TD><TD>        private final String OHS = &#34;OHS&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">88</TD><TD>        private final String SESSION = &#34;SESSION&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">89</TD><TD>        private final boolean CLONE_AND_SWAP = false;</TD></TR><TR><TD CLASS="l">90</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">91</TD><TD>        private final StrategyStruct[] EMPTY_LEGS = new StrategyStruct[0];</TD></TR><TR><TD CLASS="l">92</TD><TD>        </TD></TR><TR><TD CLASS="l">93</TD><TD>        private static final String TSS_SVC = &#34;TSS&#34;;</TD></TR><TR><TD CLASS="l">94</TD><TD>    private static final String PMS_SVC = &#34;PMS&#34;;</TD></TR><TR><TD CLASS="l">95</TD><TD>    private static final String PQS_SVC = &#34;PQS&#34;;</TD></TR><TR><TD CLASS="l">96</TD><TD> </TD></TR><TR><TD CLASS="l">97</TD><TD>        private Logger logger;</TD></TR><TR><TD CLASS="l">98</TD><TD>        private ProductConfigurationService pcs;</TD></TR><TR><TD CLASS="l">99</TD><TD>        private ProductQueryService pqs;</TD></TR><TR><TD CLASS="l">100</TD><TD>        private ProductMaintenanceService pms;</TD></TR><TR><TD CLASS="l">101</TD><TD>        private TradingSessionService tss;</TD></TR><TR><TD CLASS="l">102</TD><TD>        private DIFCommonConfig commonConfig;</TD></TR><TR><TD CLASS="l">103</TD><TD>        private boolean ignoreLowSeqNumbers;</TD></TR><TR><TD CLASS="l">104</TD><TD>        private String spreadServerRolloutCompleted;;</TD></TR><TR><TD CLASS="l">105</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">106</TD><TD>        private volatile int isDownloaded = -1; //0 means download completed</TD></TR><TR CLASS="z"><TD CLASS="l">107</TD><TD>        volatile boolean isPriceProtectionCalculationDoneForStrategy = false;</TD></TR><TR><TD CLASS="l">108</TD><TD>        private volatile Exception[] downloadException;</TD></TR><TR CLASS="z"><TD CLASS="l">109</TD><TD>        private volatile boolean hasDownloadException = false;</TD></TR><TR><TD CLASS="l">110</TD><TD> </TD></TR><TR><TD CLASS="l">111</TD><TD>        private List&lt;String&gt; groupNames;</TD></TR><TR CLASS="z"><TD CLASS="l">112</TD><TD>        private final ArrayList&lt;Integer&gt; classKeys = new ArrayList&lt;Integer&gt;(); // list of class keys for local group.</TD></TR><TR><TD CLASS="l">113</TD><TD>        private final Map&lt;String, int[]&gt; classKeysByGroup;</TD></TR><TR><TD CLASS="l">114</TD><TD>    private final IntHashMap&lt;ArrayList&lt;ProductDataUpdateListener&gt;&gt; productUpdateListeners;</TD></TR><TR><TD CLASS="l">115</TD><TD>        private final IntHashMap&lt;ArrayList&lt;ReportingClassDataUpdateListener&gt;&gt; reportingClassUpdateListeners;</TD></TR><TR><TD CLASS="l">116</TD><TD>        private final IntHashMap&lt;ArrayList&lt;ProductClassDataUpdateListener&gt;&gt; productClassUpdateListeners;</TD></TR><TR><TD CLASS="l">117</TD><TD>        private final IntHashMap&lt;String&gt; allClassSessionNames;  // ClassKey-SessionName key-value pair</TD></TR><TR><TD CLASS="l">118</TD><TD>        private final ConcurrentIntHashMap&lt;Set&lt;Integer&gt;&gt; associatedStrategiesPerProduct;</TD></TR><TR><TD CLASS="l">119</TD><TD>        private final ConcurrentIntHashMap&lt;ProductClassDataImpl&gt; allProdClassData;</TD></TR><TR><TD CLASS="l">120</TD><TD>        private final IntHashMap&lt;String&gt; allClassUnderlyingSessionNames;  // ClassKey-UnderlyingSessionName key-value pair</TD></TR><TR><TD CLASS="l">121</TD><TD>        </TD></TR><TR><TD CLASS="l">122</TD><TD>        private volatile ConcurrentIntHashMap&lt;ProductDataImpl&gt; allProdData;</TD></TR><TR><TD CLASS="l">123</TD><TD>        private volatile IntHashMap&lt;ReportingClassDataImpl&gt; allReportingClassData;</TD></TR><TR><TD CLASS="l">124</TD><TD> </TD></TR><TR><TD CLASS="l">125</TD><TD>        // When querying for product not in the cache, do not query global services</TD></TR><TR><TD CLASS="l">126</TD><TD>        // if the prod key is in this map and the system time is less than the non-0 timeout.</TD></TR><TR><TD CLASS="l">127</TD><TD>        // This will avoid &#34;spinning&#34; on global calls for bad inbound data.</TD></TR><TR><TD CLASS="l">128</TD><TD>        //</TD></TR><TR><TD CLASS="l">129</TD><TD>        private static final int BAD_KEY_TIMEOUT = 1000; // at most, query at 1 second intervals for new product.</TD></TR><TR CLASS="z"><TD CLASS="l">130</TD><TD>        private final Map&lt;Integer, Long&gt; badProdKeyTimeout = Collections.synchronizedMap(new HashMap&lt;Integer, Long&gt;());</TD></TR><TR CLASS="z"><TD CLASS="l">131</TD><TD>        private final Map&lt;Integer, Long&gt; badClassKeyTimeout = Collections.synchronizedMap(new HashMap&lt;Integer, Long&gt;());</TD></TR><TR><TD CLASS="l">132</TD><TD> </TD></TR><TR><TD CLASS="l">133</TD><TD>        private boolean[] tempRolloutFlags; // temp mapping of rollout flags during download.</TD></TR><TR><TD CLASS="l">134</TD><TD>        private IntHashMap&lt;LinkageIndicatorResultStruct&gt; linkageIRSS; // mapKey = classKey</TD></TR><TR CLASS="z"><TD CLASS="l">135</TD><TD>        private final ConstantIntMapper PROD_STATE_MAPPER = ConstantIntMapper.getMapper(ProductStates.class);</TD></TR><TR><TD CLASS="l">136</TD><TD> </TD></TR><TR><TD CLASS="l">137</TD><TD>        private Set&lt;String&gt; sessNamesSet;</TD></TR><TR><TD CLASS="l">138</TD><TD>        private String[] additionalSessions;</TD></TR><TR><TD CLASS="l">139</TD><TD>        private Set&lt;String&gt; allSessionsForCache;</TD></TR><TR><TD CLASS="l">140</TD><TD> </TD></TR><TR><TD CLASS="l">141</TD><TD>        private volatile boolean downloadStarted;</TD></TR><TR><TD CLASS="l">142</TD><TD>        /*</TD></TR><TR><TD CLASS="l">143</TD><TD>         * The delimiter for post and station; Not a very elegant way, but we might</TD></TR><TR><TD CLASS="l">144</TD><TD>         * have to pick it up from a property</TD></TR><TR><TD CLASS="l">145</TD><TD>         */</TD></TR><TR><TD CLASS="l">146</TD><TD>        public static final String deLimiterForPostAndStation = &#34;_&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">147</TD><TD>        private int linkageDisabledCount =0;</TD></TR><TR><TD CLASS="l">148</TD><TD> </TD></TR><TR><TD CLASS="l">149</TD><TD>        </TD></TR><TR><TD CLASS="l">150</TD><TD>        private short spreadNormalizationStrategyType;</TD></TR><TR><TD CLASS="l">151</TD><TD>        ////////////////////////////////////////////////////////</TD></TR><TR><TD CLASS="l"><A NAME="2">152</A></TD><TD>        //</TD></TR><TR><TD CLASS="l">153</TD><TD>        //  Mutators and framework hooks:</TD></TR><TR><TD CLASS="l">154</TD><TD>        //</TD></TR><TR><TD CLASS="l">155</TD><TD>        public ProductDataCacheImpl()</TD></TR><TR CLASS="z"><TD CLASS="l">156</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">157</TD><TD>                classKeysByGroup = new HashMap&lt;String, int[]&gt;(17);</TD></TR><TR CLASS="z"><TD CLASS="l">158</TD><TD>                allProdClassData = new ConcurrentIntHashMap&lt;ProductClassDataImpl&gt;(8000);</TD></TR><TR><TD CLASS="l">159</TD><TD>                //TODO: what should be the initial size???</TD></TR><TR CLASS="z"><TD CLASS="l">160</TD><TD>                allReportingClassData = new IntHashMap&lt;ReportingClassDataImpl&gt;(8000);</TD></TR><TR CLASS="z"><TD CLASS="l">161</TD><TD>                allProdData = new ConcurrentIntHashMap&lt;ProductDataImpl&gt;(10007);</TD></TR><TR CLASS="z"><TD CLASS="l">162</TD><TD>                allClassSessionNames = new IntHashMap&lt;String&gt;(1003);</TD></TR><TR CLASS="z"><TD CLASS="l">163</TD><TD>                associatedStrategiesPerProduct = new ConcurrentIntHashMap&lt;Set&lt;Integer&gt;&gt;(10007);</TD></TR><TR CLASS="z"><TD CLASS="l">164</TD><TD>                allClassUnderlyingSessionNames = new IntHashMap&lt;String&gt;(1003);</TD></TR><TR><TD CLASS="l">165</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">166</TD><TD>                productUpdateListeners = new IntHashMap&lt;ArrayList&lt;ProductDataUpdateListener&gt;&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">167</TD><TD>                reportingClassUpdateListeners = new IntHashMap&lt;ArrayList&lt;ReportingClassDataUpdateListener&gt;&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">168</TD><TD>                productClassUpdateListeners = new IntHashMap&lt;ArrayList&lt;ProductClassDataUpdateListener&gt;&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="58">169</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">170</TD><TD> </TD></TR><TR><TD CLASS="l">171</TD><TD>        public final void setCommonConfig(DIFCommonConfig p_commonConfig)</TD></TR><TR><TD CLASS="l">172</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">173</TD><TD>                commonConfig = p_commonConfig;</TD></TR><TR CLASS="z"><TD CLASS="l">174</TD><TD>                HashSet&lt;String&gt; distinctSessNames = new HashSet&lt;String&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">175</TD><TD>                for (String sess : commonConfig.getSessionNames())</TD></TR><TR><TD CLASS="l">176</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">177</TD><TD>                        distinctSessNames.add(sess);</TD></TR><TR><TD CLASS="l">178</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">179</TD><TD>                sessNamesSet = distinctSessNames;</TD></TR><TR CLASS="z"><TD CLASS="l">180</TD><TD>                if (allSessionsForCache==null)</TD></TR><TR CLASS="z"><TD CLASS="l">181</TD><TD>                    allSessionsForCache = new HashSet&lt;String&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">182</TD><TD>                allSessionsForCache.addAll(distinctSessNames);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="59">183</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">184</TD><TD> </TD></TR><TR><TD CLASS="l">185</TD><TD>        public void setGroupNames(List&lt;String&gt; p_groupNames)</TD></TR><TR><TD CLASS="l">186</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">187</TD><TD>                this.groupNames = p_groupNames;</TD></TR><TR CLASS="z"><TD CLASS="l">188</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="5f">189</A></TD><TD> </TD></TR><TR><TD CLASS="l">190</TD><TD>        @FFServiceDependency</TD></TR><TR><TD CLASS="l">191</TD><TD>        public void setProductQueryService(ProductQueryService p_pqs)</TD></TR><TR><TD CLASS="l">192</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">193</TD><TD>                this.pqs = p_pqs;</TD></TR><TR CLASS="z"><TD CLASS="l">194</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="5d">195</A></TD><TD> </TD></TR><TR><TD CLASS="l">196</TD><TD>        @FFServiceDependency</TD></TR><TR><TD CLASS="l">197</TD><TD>        public void setProductConfigurationService(ProductConfigurationService p_pcs)</TD></TR><TR><TD CLASS="l">198</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">199</TD><TD>                this.pcs = p_pcs;</TD></TR><TR CLASS="z"><TD CLASS="l">200</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="5e">201</A></TD><TD> </TD></TR><TR><TD CLASS="l">202</TD><TD>        @FFServiceDependency</TD></TR><TR><TD CLASS="l">203</TD><TD>        public void setProductMaintenanceService(ProductMaintenanceService p_pms)</TD></TR><TR><TD CLASS="l">204</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">205</TD><TD>                this.pms = p_pms;</TD></TR><TR CLASS="z"><TD CLASS="l">206</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="63">207</A></TD><TD> </TD></TR><TR><TD CLASS="l">208</TD><TD>        @FFServiceDependency</TD></TR><TR><TD CLASS="l">209</TD><TD>        public void setTradingSessionService(TradingSessionService p_tss)</TD></TR><TR><TD CLASS="l">210</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">211</TD><TD>                tss = p_tss;</TD></TR><TR CLASS="z"><TD CLASS="l">212</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="4f">213</A></TD><TD> </TD></TR><TR><TD CLASS="l">214</TD><TD>        public void postInitialize() throws FatalFoundationFrameworkException</TD></TR><TR><TD CLASS="l">215</TD><TD>        {</TD></TR><TR><TD CLASS="l">216</TD><TD>                // (validate that homes &amp; config are set)</TD></TR><TR CLASS="z"><TD CLASS="l">217</TD><TD>                if (groupNames == null)</TD></TR><TR><TD CLASS="l">218</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">219</TD><TD>                        throw new FatalFoundationFrameworkException(&#34;groupNames was not set (is null)!&#34;);</TD></TR><TR><TD CLASS="l">220</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">221</TD><TD>                if (commonConfig == null)</TD></TR><TR><TD CLASS="l">222</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">223</TD><TD>                        throw new FatalFoundationFrameworkException(&#34;commonConfig is null!&#34;);</TD></TR><TR><TD CLASS="l">224</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">225</TD><TD>                if (commonConfig.getSessionNames()==null)</TD></TR><TR><TD CLASS="l">226</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">227</TD><TD>                        throw new FatalFoundationFrameworkException(&#34;commonConfig missing session names!&#34;);</TD></TR><TR><TD CLASS="l">228</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">229</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="50">230</A></TD><TD> </TD></TR><TR><TD CLASS="l">231</TD><TD>        public void postStart() throws FatalFoundationFrameworkException</TD></TR><TR><TD CLASS="l">232</TD><TD>        {</TD></TR><TR><TD CLASS="l">233</TD><TD>                // (validate that services are non-null)</TD></TR><TR CLASS="z"><TD CLASS="l">234</TD><TD>                if (this.pqs == null)</TD></TR><TR><TD CLASS="l">235</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">236</TD><TD>                        throw new FatalFoundationFrameworkException(&#34;pqs is null!&#34;);</TD></TR><TR><TD CLASS="l">237</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">238</TD><TD>                if (this.pcs == null)</TD></TR><TR><TD CLASS="l">239</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">240</TD><TD>                        throw new FatalFoundationFrameworkException(&#34;pcs is null!&#34;);</TD></TR><TR><TD CLASS="l">241</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">242</TD><TD>                if (this.pms == null)</TD></TR><TR><TD CLASS="l">243</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">244</TD><TD>                        throw new FatalFoundationFrameworkException(&#34;pms is null!&#34;);</TD></TR><TR><TD CLASS="l">245</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">246</TD><TD>                if (this.tss == null)</TD></TR><TR><TD CLASS="l">247</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">248</TD><TD>                        throw new FatalFoundationFrameworkException(&#34;tss is null!&#34;);</TD></TR><TR><TD CLASS="l">249</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5b">250</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">251</TD><TD> </TD></TR><TR><TD CLASS="l">252</TD><TD>        public void setLogger(Logger p_logger)</TD></TR><TR><TD CLASS="l">253</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">254</TD><TD>                this.logger = p_logger;</TD></TR><TR CLASS="z"><TD CLASS="l">255</TD><TD>        }</TD></TR><TR><TD CLASS="l">256</TD><TD> </TD></TR><TR><TD CLASS="l">257</TD><TD>        ///////////////////////////////////////////////////////////</TD></TR><TR><TD CLASS="l">258</TD><TD>        //</TD></TR><TR><TD CLASS="l">259</TD><TD>        // Public interface methods:</TD></TR><TR><TD CLASS="l"><A NAME="46">260</A></TD><TD>        //</TD></TR><TR><TD CLASS="l">261</TD><TD>        </TD></TR><TR><TD CLASS="l">262</TD><TD>   public short getSpreadNormalizationStrategyType()</TD></TR><TR><TD CLASS="l">263</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">264</TD><TD>         return spreadNormalizationStrategyType;</TD></TR><TR><TD CLASS="l">265</TD><TD>    }</TD></TR><TR><TD CLASS="l">266</TD><TD> </TD></TR><TR><TD CLASS="l">267</TD><TD>        /**</TD></TR><TR><TD CLASS="l">268</TD><TD>         * @throws SystemException</TD></TR><TR><TD CLASS="l"><A NAME="44">269</A></TD><TD>         * @see com.cboe.server.interfaces.productData.ProductDataCache#getProductData(int)</TD></TR><TR><TD CLASS="l">270</TD><TD>         */</TD></TR><TR><TD CLASS="l">271</TD><TD>        public ProductData getProductData(int p_productKey) throws NotFoundException, SystemException</TD></TR><TR><TD CLASS="l">272</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">273</TD><TD>            ProductDataImpl data = allProdData.get(p_productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">274</TD><TD>                if (data == null)</TD></TR><TR><TD CLASS="l">275</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">276</TD><TD>                                ProductStructV4 v4raw = fetchProductStructFromGlobal(p_productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">277</TD><TD>                                if (v4raw!=null)</TD></TR><TR><TD CLASS="l">278</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">279</TD><TD>                                        data=addNewProd(p_productKey, v4raw);</TD></TR><TR><TD CLASS="l">280</TD><TD>                                }</TD></TR><TR><TD CLASS="l">281</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">282</TD><TD>                if (data == null)</TD></TR><TR><TD CLASS="l">283</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">284</TD><TD>                        MsgBuilder msg = MsgBuilder.get().add(&#34;ProductDataCacheImpl.getProductData-&gt;Product &#34;).add(p_productKey).add(&#34; not found!&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">285</TD><TD>                        logger.alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">286</TD><TD>                        throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">287</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">288</TD><TD>                return data;</TD></TR><TR><TD CLASS="l">289</TD><TD>        }</TD></TR><TR><TD CLASS="l">290</TD><TD> </TD></TR><TR><TD CLASS="l">291</TD><TD>        private final ProductDataImpl addNewProd(</TD></TR><TR><TD CLASS="l"><A NAME="14">292</A></TD><TD>                        int p_productKey,</TD></TR><TR><TD CLASS="l">293</TD><TD>                        final ProductStructV4 v4raw)</TD></TR><TR><TD CLASS="l">294</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">295</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">296</TD><TD>            StrategyStruct[] legsRaw = isStrategy(v4raw.product);</TD></TR><TR CLASS="z"><TD CLASS="l">297</TD><TD>            if (legsRaw!=null)</TD></TR><TR><TD CLASS="l">298</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">299</TD><TD>                boolean isStrategy = legsRaw.length&gt;0 &amp;&amp; legsRaw[0].strategyLegs.length&gt;0;</TD></TR><TR CLASS="z"><TD CLASS="l">300</TD><TD>                final ProductClassDataImpl classData = allProdClassData.get(v4raw.product.productKeys.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">301</TD><TD>                final ProductStructV4[] v4raws = new ProductStructV4[]{v4raw};</TD></TR><TR CLASS="z"><TD CLASS="l">302</TD><TD>                        final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdMap = cloneProdCacheWithAddition(v4raws, legsRaw, classData, isStrategy);</TD></TR><TR CLASS="z"><TD CLASS="l">303</TD><TD>                        if (newProdMap == null)</TD></TR><TR CLASS="z"><TD CLASS="l">304</TD><TD>                                return null;</TD></TR><TR CLASS="z"><TD CLASS="l">305</TD><TD>                        updateProdCache(newProdMap, v4raws);</TD></TR><TR CLASS="z"><TD CLASS="l">306</TD><TD>                        notifyListeners(classData, newProdMap.get(p_productKey));</TD></TR><TR><TD CLASS="l">307</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">308</TD><TD>                        logger.info(MsgBuilder.get().add(&#34;Dynamically added&#34;).add(&#34;product&#34;, p_productKey));</TD></TR><TR CLASS="z"><TD CLASS="l">309</TD><TD>                        return newProdMap.get(p_productKey);</TD></TR><TR><TD CLASS="l">310</TD><TD>                }</TD></TR><TR><TD CLASS="l">311</TD><TD>                else</TD></TR><TR><TD CLASS="l">312</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">313</TD><TD>                        logger.info(MsgBuilder.get().add(&#34;Ignoring query for&#34;).add(&#34;product&#34;, p_productKey)</TD></TR><TR><TD CLASS="l">314</TD><TD>                                        .add(&#34; (prod class not in process)&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">315</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">316</TD><TD>                }</TD></TR><TR><TD CLASS="l">317</TD><TD>        }</TD></TR><TR><TD CLASS="l">318</TD><TD> </TD></TR><TR><TD CLASS="l">319</TD><TD>        private final ProductDataImpl addNewProd(</TD></TR><TR><TD CLASS="l">320</TD><TD>                final ProductClassDataImpl classData,</TD></TR><TR><TD CLASS="l">321</TD><TD>                        int p_productKey,</TD></TR><TR><TD CLASS="l">322</TD><TD>                        final ProductStruct raw,</TD></TR><TR><TD CLASS="l">323</TD><TD>                        final ProductInformationStruct p_pinfo,</TD></TR><TR><TD CLASS="l"><A NAME="13">324</A></TD><TD>                        short p_strategyType,</TD></TR><TR><TD CLASS="l">325</TD><TD>                        final StrategyLegStruct[] p_strategyLegs)</TD></TR><TR><TD CLASS="l">326</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">327</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">328</TD><TD>                if (classData != null)</TD></TR><TR><TD CLASS="l">329</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">330</TD><TD>                        final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdMap = cloneProdCacheWithAddition(</TD></TR><TR><TD CLASS="l">331</TD><TD>                                classData, </TD></TR><TR><TD CLASS="l">332</TD><TD>                                        raw,</TD></TR><TR><TD CLASS="l">333</TD><TD>                                        p_pinfo,</TD></TR><TR><TD CLASS="l">334</TD><TD>                                        p_strategyType,</TD></TR><TR><TD CLASS="l">335</TD><TD>                                        p_strategyLegs);</TD></TR><TR CLASS="z"><TD CLASS="l">336</TD><TD>                        if (newProdMap == null)</TD></TR><TR CLASS="z"><TD CLASS="l">337</TD><TD>                                return null;</TD></TR><TR CLASS="z"><TD CLASS="l">338</TD><TD>                        updateProdCache(newProdMap, new ProductStruct[] {raw});</TD></TR><TR CLASS="z"><TD CLASS="l">339</TD><TD>                        notifyListeners(classData, newProdMap.get(p_productKey));</TD></TR><TR CLASS="z"><TD CLASS="l">340</TD><TD>                        logger.info(MsgBuilder.get().add(&#34;Dynamically added&#34;).add(&#34;product&#34;, p_productKey));</TD></TR><TR CLASS="z"><TD CLASS="l">341</TD><TD>                        return newProdMap.get(p_productKey);</TD></TR><TR><TD CLASS="l">342</TD><TD>                }</TD></TR><TR><TD CLASS="l">343</TD><TD>                else</TD></TR><TR><TD CLASS="l">344</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">345</TD><TD>                        logger.info(MsgBuilder.get().add(&#34;Ignoring query for&#34;).add(&#34;product&#34;, p_productKey)</TD></TR><TR><TD CLASS="l">346</TD><TD>                                        .add(&#34; (prod class no in process)&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">347</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">348</TD><TD>                }</TD></TR><TR><TD CLASS="l">349</TD><TD>        }</TD></TR><TR><TD CLASS="l">350</TD><TD> </TD></TR><TR><TD CLASS="l">351</TD><TD>        private final void updateProdCache(</TD></TR><TR><TD CLASS="l">352</TD><TD>                        final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdMap,</TD></TR><TR><TD CLASS="l">353</TD><TD>                        final ProductStruct[] updates)</TD></TR><TR><TD CLASS="l"><A NAME="67">354</A></TD><TD>        {</TD></TR><TR><TD CLASS="l">355</TD><TD>                if (CLONE_AND_SWAP)</TD></TR><TR><TD CLASS="l">356</TD><TD>                        this.allProdData = newProdMap;</TD></TR><TR><TD CLASS="l">357</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">358</TD><TD>                for (ProductStruct updated : updates)</TD></TR><TR><TD CLASS="l">359</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">360</TD><TD>                        notifyListeners(newProdMap.get(updated.productKeys.productKey));</TD></TR><TR><TD CLASS="l">361</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">362</TD><TD>        }</TD></TR><TR><TD CLASS="l">363</TD><TD> </TD></TR><TR><TD CLASS="l">364</TD><TD>        private final void updateProdCache(</TD></TR><TR><TD CLASS="l">365</TD><TD>                        final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdMap,</TD></TR><TR><TD CLASS="l">366</TD><TD>                        final StrategyStruct[] updates)</TD></TR><TR><TD CLASS="l"><A NAME="69">367</A></TD><TD>        {</TD></TR><TR><TD CLASS="l">368</TD><TD>                if (CLONE_AND_SWAP)</TD></TR><TR><TD CLASS="l">369</TD><TD>                        this.allProdData = newProdMap;</TD></TR><TR><TD CLASS="l">370</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">371</TD><TD>                for (StrategyStruct updated : updates)</TD></TR><TR><TD CLASS="l">372</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">373</TD><TD>                        notifyListeners(newProdMap.get(updated.product.productKeys.productKey));</TD></TR><TR><TD CLASS="l">374</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">375</TD><TD>        }</TD></TR><TR><TD CLASS="l">376</TD><TD> </TD></TR><TR><TD CLASS="l">377</TD><TD>        private final void updateProdCache(</TD></TR><TR><TD CLASS="l">378</TD><TD>                        final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdMap,</TD></TR><TR><TD CLASS="l">379</TD><TD>                        final ProductStructV4[] updates)</TD></TR><TR><TD CLASS="l"><A NAME="68">380</A></TD><TD>        {</TD></TR><TR><TD CLASS="l">381</TD><TD>                if (CLONE_AND_SWAP)</TD></TR><TR><TD CLASS="l">382</TD><TD>                        this.allProdData = newProdMap;</TD></TR><TR><TD CLASS="l">383</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">384</TD><TD>                for (ProductStructV4 updated : updates)</TD></TR><TR><TD CLASS="l">385</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">386</TD><TD>                        notifyListeners(newProdMap.get(updated.product.productKeys.productKey));</TD></TR><TR><TD CLASS="l">387</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="7b">388</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">389</TD><TD> </TD></TR><TR><TD CLASS="l">390</TD><TD>        private final boolean verifyProductQueryStatus(int p_productKey)</TD></TR><TR><TD CLASS="l">391</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">392</TD><TD>                Long badKeyTimeout = this.badProdKeyTimeout.get(p_productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">393</TD><TD>                if (badKeyTimeout != null)</TD></TR><TR><TD CLASS="l">394</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">395</TD><TD>                        final long timeout = badKeyTimeout.longValue();</TD></TR><TR CLASS="z"><TD CLASS="l">396</TD><TD>                        if (timeout &gt; 0 &amp;&amp; timeout &gt; System.currentTimeMillis())</TD></TR><TR><TD CLASS="l">397</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">398</TD><TD>                                logger.alarm(MsgBuilder.get().add(&#34;PMS query NotFound too recently: not calling again so soon.&#34;)</TD></TR><TR><TD CLASS="l">399</TD><TD>                                                .add(&#34;prodKey&#34;, p_productKey));</TD></TR><TR CLASS="z"><TD CLASS="l">400</TD><TD>                                return false;</TD></TR><TR><TD CLASS="l">401</TD><TD>                        }</TD></TR><TR><TD CLASS="l">402</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">403</TD><TD>                return true;</TD></TR><TR><TD CLASS="l"><A NAME="7a">404</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">405</TD><TD> </TD></TR><TR><TD CLASS="l">406</TD><TD>        private final boolean verifyProdClassQueryStatus(int p_classKey)</TD></TR><TR><TD CLASS="l">407</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">408</TD><TD>                Long badKeyTimeout = this.badClassKeyTimeout.get(p_classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">409</TD><TD>                if (badKeyTimeout != null)</TD></TR><TR><TD CLASS="l">410</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">411</TD><TD>                        final long timeout = badKeyTimeout.longValue();</TD></TR><TR CLASS="z"><TD CLASS="l">412</TD><TD>                        if (timeout &gt; 0 &amp;&amp; timeout &gt; System.currentTimeMillis())</TD></TR><TR><TD CLASS="l">413</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">414</TD><TD>                                logger.alarm(MsgBuilder.get().add(&#34;PMS query NotFound too recently: not calling again so soon.&#34;)</TD></TR><TR><TD CLASS="l">415</TD><TD>                                                .add(&#34;prodClassKey&#34;, p_classKey));</TD></TR><TR CLASS="z"><TD CLASS="l">416</TD><TD>                                return false;</TD></TR><TR><TD CLASS="l">417</TD><TD>                        }</TD></TR><TR><TD CLASS="l">418</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">419</TD><TD>                return true;</TD></TR><TR><TD CLASS="l">420</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="37">421</A></TD><TD> </TD></TR><TR><TD CLASS="l">422</TD><TD>        private final ProductStructV4 fetchProductStructFromGlobal(int p_productKey)</TD></TR><TR><TD CLASS="l">423</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">424</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">425</TD><TD>            StringBuffer sb=new StringBuffer();</TD></TR><TR CLASS="z"><TD CLASS="l">426</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">427</TD><TD>            if (!verifyProductQueryStatus(p_productKey))</TD></TR><TR><TD CLASS="l">428</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">429</TD><TD>                logger.alarm(msg.add(&#34;Prod &#34;).add(p_productKey).add(&#34; still within bad key timeout range; won't try to fetach it from Global until time out&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">430</TD><TD>                return null;</TD></TR><TR><TD CLASS="l">431</TD><TD>            }</TD></TR><TR><TD CLASS="l">432</TD><TD>                try        {</TD></TR><TR CLASS="z"><TD CLASS="l">433</TD><TD>                        logger.info(msg.add(&#34;Fetching&#34;).add(&#34; product::&#34;,p_productKey)</TD></TR><TR><TD CLASS="l">434</TD><TD>                                        .add(&#34;from global server (PMS&amp;TSS)...&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">435</TD><TD>                        msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">436</TD><TD>                        ProductStructV4 prodStructV4 = pms.getProductsByKeyV4(new int[] { p_productKey })[0];</TD></TR><TR CLASS="z"><TD CLASS="l">437</TD><TD>                        logger.info(msg.add(&#34;Fetched&#34;).add(&#34; product::&#34;,p_productKey)</TD></TR><TR><TD CLASS="l">438</TD><TD>                                        .add(&#34;from global server (PMS&amp;TSS).&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">439</TD><TD>                        msg.clear();</TD></TR><TR><TD CLASS="l">440</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">441</TD><TD>                        return prodStructV4;</TD></TR><TR><TD CLASS="l">442</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">443</TD><TD>                catch (SystemException e)</TD></TR><TR><TD CLASS="l">444</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">445</TD><TD>                        throw new SystemException(MsgBuilder.get().add(PMS_SVC).add(&#34; Sys error &#34; ).add(e.getMessage()).end(), e.details);</TD></TR><TR><TD CLASS="l">446</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">447</TD><TD>                catch (CommunicationException e)</TD></TR><TR><TD CLASS="l">448</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">449</TD><TD>                        throw new SystemException(MsgBuilder.get().add(PMS_SVC).add(&#34; Comm error&#34;).end(), e.details);</TD></TR><TR><TD CLASS="l">450</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">451</TD><TD>                catch (DataValidationException e)</TD></TR><TR><TD CLASS="l">452</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">453</TD><TD>                        Log.exception(msg.add(&#34;Failed to find all info for&#34;).add(&#34;product&#34;,p_productKey)</TD></TR><TR><TD CLASS="l">454</TD><TD>                                        .add(&#34;Caused&#34;).add(&#34;DataValidationException&#34;,e.details.message)</TD></TR><TR><TD CLASS="l">455</TD><TD>                                        .add(&#34;code&#34;,e.details.error).end(), e);</TD></TR><TR CLASS="z"><TD CLASS="l">456</TD><TD>                        badProdKeyTimeout.put(p_productKey, System.currentTimeMillis()+BAD_KEY_TIMEOUT);</TD></TR><TR CLASS="z"><TD CLASS="l">457</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">458</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">459</TD><TD>                catch (AuthorizationException e)</TD></TR><TR><TD CLASS="l">460</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">461</TD><TD>                        throw new SystemException(msg.add(PMS_SVC).add(&#34; Authorization error&#34;).end(), e.details);</TD></TR><TR><TD CLASS="l">462</TD><TD>                }</TD></TR><TR><TD CLASS="l">463</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="39">464</A></TD><TD> </TD></TR><TR><TD CLASS="l">465</TD><TD>        private final StrategyStruct fetchStrategyStructByProdFromGlobal(int p_productKey)</TD></TR><TR><TD CLASS="l">466</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">467</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">468</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">469</TD><TD>                if (!verifyProductQueryStatus(p_productKey))</TD></TR><TR><TD CLASS="l">470</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">471</TD><TD>                    logger.alarm(msg.add(&#34;Strategy Prod &#34;).add(p_productKey).add(&#34; still within bad key timeout range; won't try to fetach it from Global until time out&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">472</TD><TD>                    return null;</TD></TR><TR><TD CLASS="l">473</TD><TD>                }</TD></TR><TR><TD CLASS="l">474</TD><TD>                </TD></TR><TR><TD CLASS="l">475</TD><TD>                try</TD></TR><TR><TD CLASS="l">476</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">477</TD><TD>                        logger.info(msg.add(&#34;Fetching&#34;).add(&#34; strategy product::&#34;,p_productKey)</TD></TR><TR><TD CLASS="l">478</TD><TD>                                        .add(&#34; from global server (PMS&amp;TSS)...&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">479</TD><TD>                        msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">480</TD><TD>                        StrategyStruct strategy = pqs.getStrategyByKey(p_productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">481</TD><TD>                        logger.info(msg.add(&#34;Fetched&#34;).add(&#34; strategy product::&#34;,p_productKey)</TD></TR><TR><TD CLASS="l">482</TD><TD>                                        .add(&#34; from global server (PMS&amp;TSS).&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">483</TD><TD>                        return strategy;</TD></TR><TR><TD CLASS="l">484</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">485</TD><TD>                catch (SystemException e)</TD></TR><TR><TD CLASS="l">486</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">487</TD><TD>                        throw new SystemException(MsgBuilder.get().add(PQS_SVC).add(&#34; Sys error &#34; ).add(e.getMessage()).end(), e.details);</TD></TR><TR><TD CLASS="l">488</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">489</TD><TD>                catch (CommunicationException e)</TD></TR><TR><TD CLASS="l">490</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">491</TD><TD>                        throw new SystemException(MsgBuilder.get().add(PQS_SVC).add(&#34; Comm error&#34;).add(e.getMessage()).end(), e.details);</TD></TR><TR><TD CLASS="l">492</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">493</TD><TD>                catch (DataValidationException e)</TD></TR><TR><TD CLASS="l">494</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">495</TD><TD>                        Log.exception(msg.add(PQS_SVC).add(&#34;Failed to find all info for&#34;).add(&#34; product &#34;,p_productKey)</TD></TR><TR><TD CLASS="l">496</TD><TD>                                        .add(&#34;Caused&#34;).add(&#34;DataValidationException&#34;,e.details.message)</TD></TR><TR><TD CLASS="l">497</TD><TD>                                        .add(&#34;code&#34;,e.details.error).end(), e);</TD></TR><TR CLASS="z"><TD CLASS="l">498</TD><TD>                        badProdKeyTimeout.put(p_productKey, System.currentTimeMillis()+BAD_KEY_TIMEOUT);</TD></TR><TR CLASS="z"><TD CLASS="l">499</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">500</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">501</TD><TD>                catch (AuthorizationException e)</TD></TR><TR><TD CLASS="l">502</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">503</TD><TD>                        throw new SystemException(msg.add(PQS_SVC).add(&#34; Authorization error&#34;).add(e.getMessage()).end(), e.details);</TD></TR><TR><TD CLASS="l">504</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">505</TD><TD>                catch (NotFoundException e)</TD></TR><TR><TD CLASS="l">506</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">507</TD><TD>                        Log.exception(msg.add(PQS_SVC).add(&#34;Failed to find strategy info for&#34;).add(&#34;product&#34;,p_productKey)</TD></TR><TR><TD CLASS="l">508</TD><TD>                                        .add(&#34;Caused&#34;).add(&#34;NotFoundException&#34;,e.details.message)</TD></TR><TR><TD CLASS="l">509</TD><TD>                                        .add(&#34;code&#34;,e.details.error).end(), e);</TD></TR><TR CLASS="z"><TD CLASS="l">510</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">511</TD><TD>                }</TD></TR><TR><TD CLASS="l">512</TD><TD>        }</TD></TR><TR><TD CLASS="l">513</TD><TD> </TD></TR><TR><TD CLASS="l">514</TD><TD>        private final StrategyStruct[] fetchStrategyStructByClassFromGlobal(</TD></TR><TR><TD CLASS="l"><A NAME="38">515</A></TD><TD>                        int p_classKey,</TD></TR><TR><TD CLASS="l">516</TD><TD>                        boolean p_setDownloadException)</TD></TR><TR><TD CLASS="l">517</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">518</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">519</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR><TD CLASS="l">520</TD><TD>                try</TD></TR><TR><TD CLASS="l">521</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">522</TD><TD>                        logger.info(msg.add(&#34;Fetching&#34;).add(&#34; strategy products by class::&#34;,p_classKey)</TD></TR><TR><TD CLASS="l">523</TD><TD>                                        .add(&#34; from global server (PMS&amp;TSS)...&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">524</TD><TD>                        msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">525</TD><TD>                        StrategyStruct[] legsRaw = pqs.getStrategiesByClass(p_classKey, false);</TD></TR><TR CLASS="z"><TD CLASS="l">526</TD><TD>                        logger.info(msg.add(&#34;Fetched&#34;).add(&#34; strategy products by class::&#34;,p_classKey)</TD></TR><TR><TD CLASS="l">527</TD><TD>                                        .add(&#34; from global server (PMS&amp;TSS)...&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">528</TD><TD>                        msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">529</TD><TD>                        return legsRaw;</TD></TR><TR><TD CLASS="l">530</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">531</TD><TD>                catch (SystemException e)</TD></TR><TR><TD CLASS="l">532</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">533</TD><TD>                        throw new SystemException(MsgBuilder.get().add(PQS_SVC).add(&#34; Sys error &#34; ).add(e.getMessage()).end(), e.details);</TD></TR><TR><TD CLASS="l">534</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">535</TD><TD>                catch (CommunicationException e)</TD></TR><TR><TD CLASS="l">536</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">537</TD><TD>                        throw new SystemException(MsgBuilder.get().add(PQS_SVC).add(&#34; Comm error&#34;).add(e.getMessage()).end(), e.details);</TD></TR><TR><TD CLASS="l">538</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">539</TD><TD>                catch (DataValidationException e)</TD></TR><TR><TD CLASS="l">540</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">541</TD><TD>                        if (p_setDownloadException)</TD></TR><TR><TD CLASS="l">542</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">543</TD><TD>                                throw new SystemException(msg.add(PQS_SVC).add(&#34; data error&#34;).add(e.getMessage()).end(), e.details);</TD></TR><TR><TD CLASS="l">544</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">545</TD><TD>                        Log.exception(msg.add(PQS_SVC).add(&#34;Failed to find strategy info for&#34;).add(&#34; class &#34;,p_classKey)</TD></TR><TR><TD CLASS="l">546</TD><TD>                                        .add(&#34;Caused&#34;).add(&#34;DataValidationException&#34;,e.details.message)</TD></TR><TR><TD CLASS="l">547</TD><TD>                                        .add(&#34;code&#34;,e.details.error).end(), e);</TD></TR><TR CLASS="z"><TD CLASS="l">548</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">549</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">550</TD><TD>                catch (AuthorizationException e)</TD></TR><TR><TD CLASS="l">551</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">552</TD><TD>                        throw new SystemException(msg.add(PQS_SVC).add(&#34; Authorization error&#34;).add(e.getMessage()).end(), e.details);</TD></TR><TR><TD CLASS="l">553</TD><TD>                }</TD></TR><TR><TD CLASS="l">554</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="4e">555</A></TD><TD> </TD></TR><TR><TD CLASS="l">556</TD><TD>        private final ProductDataImpl populateProdState(final ProductDataImpl prodData)</TD></TR><TR><TD CLASS="l">557</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">558</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">559</TD><TD>                if (prodData==null)</TD></TR><TR CLASS="z"><TD CLASS="l">560</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">561</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">562</TD><TD>                int p_productKey = prodData.getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">563</TD><TD>                for (String sess : getAllSessionNamesForCache())</TD></TR><TR><TD CLASS="l">564</TD><TD>                {</TD></TR><TR><TD CLASS="l">565</TD><TD>            try</TD></TR><TR><TD CLASS="l">566</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">567</TD><TD>                setProdStateBySession(sess, p_productKey, prodData);</TD></TR><TR><TD CLASS="l">568</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">569</TD><TD>            catch (DataValidationException e)</TD></TR><TR><TD CLASS="l">570</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">571</TD><TD>                return null;</TD></TR><TR CLASS="z"><TD CLASS="l">572</TD><TD>            }</TD></TR><TR><TD CLASS="l">573</TD><TD>                }</TD></TR><TR><TD CLASS="l">574</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">575</TD><TD>                return prodData;</TD></TR><TR><TD CLASS="l">576</TD><TD>        }</TD></TR><TR><TD CLASS="l">577</TD><TD>        </TD></TR><TR><TD CLASS="l">578</TD><TD>        private final void setProdStateBySession(String sess, int p_productKey, final ProductDataImpl prodData)</TD></TR><TR><TD CLASS="l">579</TD><TD>        throws SystemException, DataValidationException</TD></TR><TR><TD CLASS="l"><A NAME="5c">580</A></TD><TD>                {</TD></TR><TR><TD CLASS="l">581</TD><TD>                        try</TD></TR><TR><TD CLASS="l">582</TD><TD>                        {</TD></TR><TR><TD CLASS="l">583</TD><TD>                                //TODO: if a prod qualifies for &gt;1 sessions, the later state overrides the earlier one?</TD></TR><TR CLASS="z"><TD CLASS="l">584</TD><TD>            if (TradingSessionNameHelper.isNotApplicableSession(sess))</TD></TR><TR CLASS="z"><TD CLASS="l">585</TD><TD>                return;</TD></TR><TR CLASS="z"><TD CLASS="l">586</TD><TD>            final SessionProductStruct sessProd = tss.getProductBySessionForKey(sess, p_productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">587</TD><TD>                                prodData.setState(sess, sessProd.productState);</TD></TR><TR CLASS="z"><TD CLASS="l">588</TD><TD>                                prodData.setStateSeqNum(sess, sessProd.productStateTransactionSequenceNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">589</TD><TD>            logger.info(MsgBuilder.get().add(&#34;Set state for product::&#34;).add(p_productKey).add(&#34; on session::&#34;).add(sess).add(&#34; to state=&#34;+sessProd.productState));</TD></TR><TR><TD CLASS="l">590</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">591</TD><TD>                        catch (NotFoundException e)</TD></TR><TR><TD CLASS="l">592</TD><TD>                        {</TD></TR><TR><TD CLASS="l">593</TD><TD>                                // (not an error)</TD></TR><TR><TD CLASS="l">594</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">595</TD><TD>                        catch (SystemException e)</TD></TR><TR><TD CLASS="l">596</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">597</TD><TD>            Log.exception(MsgBuilder.get().add(TSS_SVC ).add(&#34; Sys error on tss.getProductBySessionForKey(&#34; ).add(sess).add(p_productKey).add(&#34;::&#34;).add(e.getMessage()).end(), e);</TD></TR><TR><TD CLASS="l">598</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">599</TD><TD>                        catch (CommunicationException e)</TD></TR><TR><TD CLASS="l">600</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">601</TD><TD>            Log.exception(MsgBuilder.get().add(TSS_SVC ).add(&#34; Comm erroron on tss.getProductBySessionForKey(&#34; ).add(sess).add(p_productKey).end(), e);</TD></TR><TR><TD CLASS="l">602</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">603</TD><TD>                        catch (DataValidationException e)</TD></TR><TR><TD CLASS="l">604</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">605</TD><TD>            Log.exception(MsgBuilder.get().add(TSS_SVC).add(&#34;Failed to find all info for &#34;).add(&#34;session&#34;, sess).add(&#34;product&#34;,p_productKey)</TD></TR><TR><TD CLASS="l">606</TD><TD>                                                .add(&#34;Caused&#34;).add(&#34;DataValidationException&#34;,e.details.message)</TD></TR><TR><TD CLASS="l">607</TD><TD>                    .add(&#34;code&#34;,e.details.error).end(), e);</TD></TR><TR CLASS="z"><TD CLASS="l">608</TD><TD>                                badProdKeyTimeout.put(p_productKey, System.currentTimeMillis()+BAD_KEY_TIMEOUT);</TD></TR><TR><TD CLASS="l">609</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">610</TD><TD>        catch (AuthorizationException e)</TD></TR><TR><TD CLASS="l">611</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">612</TD><TD>            throw new SystemException(MsgBuilder.get().add(TSS_SVC ).add(&#34; Authorization error on tss.getProductBySessionForKey(&#34; ).add(sess).add(p_productKey).end(), e.details);</TD></TR><TR CLASS="z"><TD CLASS="l">613</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">614</TD><TD>        }</TD></TR><TR><TD CLASS="l">615</TD><TD> </TD></TR><TR><TD CLASS="l">616</TD><TD>        /**</TD></TR><TR><TD CLASS="l">617</TD><TD>         * Hit the global server processes to build a new ProductData for the</TD></TR><TR><TD CLASS="l">618</TD><TD>         * given product key.</TD></TR><TR><TD CLASS="l">619</TD><TD>         * @param p_productKey</TD></TR><TR><TD CLASS="l">620</TD><TD>         * @throws SystemException</TD></TR><TR><TD CLASS="l"><A NAME="2c">621</A></TD><TD>         */</TD></TR><TR><TD CLASS="l">622</TD><TD>        private final ProductDataImpl createProductCacheStruct(final ProductStructV4 prodStructV4)</TD></TR><TR><TD CLASS="l">623</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">624</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">625</TD><TD>                logger.info(MsgBuilder.get().add(&#34;caching prod::&#34;).add(prodStructV4.product.productKeys.productKey).add(&#34; of class::&#34;).add(prodStructV4.product.productKeys.classKey));</TD></TR><TR CLASS="z"><TD CLASS="l">626</TD><TD>                final ProductDataImpl prodData = new ProductDataImpl(prodStructV4.product, getAllSessionNamesForCache());</TD></TR><TR CLASS="z"><TD CLASS="l">627</TD><TD>                prodData.setRestrictedIndicator(prodStructV4.restrictedProductIndicator);</TD></TR><TR CLASS="z"><TD CLASS="l">628</TD><TD>                if(prodStructV4.closingPrice !=null) {</TD></TR><TR CLASS="z"><TD CLASS="l">629</TD><TD>                        prodData.setClosingPrice(prodStructV4.closingPrice);</TD></TR><TR><TD CLASS="l">630</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">631</TD><TD>                if(prodStructV4.closingSuffix !=null) {</TD></TR><TR CLASS="z"><TD CLASS="l">632</TD><TD>                        prodData.setClosingSuffix(prodStructV4.closingSuffix);</TD></TR><TR><TD CLASS="l">633</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">634</TD><TD>                return prodData;</TD></TR><TR><TD CLASS="l">635</TD><TD>        }</TD></TR><TR><TD CLASS="l">636</TD><TD> </TD></TR><TR><TD CLASS="l">637</TD><TD>        private final ProductDataImpl createProductCacheStruct(</TD></TR><TR><TD CLASS="l"><A NAME="2b">638</A></TD><TD>                        final ProductStruct prodStruct,</TD></TR><TR><TD CLASS="l">639</TD><TD>                        ProductInformationStruct p_pinfo)</TD></TR><TR><TD CLASS="l">640</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">641</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">642</TD><TD>                final ProductDataImpl prodData = new ProductDataImpl(prodStruct, getAllSessionNamesForCache());</TD></TR><TR CLASS="z"><TD CLASS="l">643</TD><TD>                if (p_pinfo==null)</TD></TR><TR CLASS="z"><TD CLASS="l">644</TD><TD>                        p_pinfo = ProductStructBuilder.buildProductInformationStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">645</TD><TD>                prodData.setRestrictedIndicator(p_pinfo.restrictedIndicator);</TD></TR><TR CLASS="z"><TD CLASS="l">646</TD><TD>                return prodData;</TD></TR><TR><TD CLASS="l">647</TD><TD>        }</TD></TR><TR><TD CLASS="l">648</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="78">649</A></TD><TD>        private final void updateWithLegInfo(</TD></TR><TR><TD CLASS="l">650</TD><TD>                        final ProductDataImpl prodData,</TD></TR><TR><TD CLASS="l">651</TD><TD>                        final StrategyStruct strategy)</TD></TR><TR><TD CLASS="l">652</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">653</TD><TD>                logger.info(MsgBuilder.get().add(&#34;caching prod::&#34;).add(prodData.getProductKey()).add(&#34; of class::&#34;).add(prodData.getClassKey()).add(&#34; with leg information&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">654</TD><TD>                updateWithLegInfo(prodData, strategy.strategyType, strategy.strategyLegs);</TD></TR><TR CLASS="z"><TD CLASS="l">655</TD><TD>        }</TD></TR><TR><TD CLASS="l">656</TD><TD> </TD></TR><TR><TD CLASS="l">657</TD><TD>        private final void updateWithLegInfo(</TD></TR><TR><TD CLASS="l"><A NAME="79">658</A></TD><TD>                        final ProductDataImpl prodData,</TD></TR><TR><TD CLASS="l">659</TD><TD>                        short p_strategyType,</TD></TR><TR><TD CLASS="l">660</TD><TD>                        final StrategyLegStruct[] p_strategyLegs)</TD></TR><TR><TD CLASS="l">661</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">662</TD><TD>                prodData.updateLegs(p_strategyLegs);</TD></TR><TR CLASS="z"><TD CLASS="l">663</TD><TD>                prodData.setStrategyType(p_strategyType);</TD></TR><TR><TD CLASS="l">664</TD><TD>                Set&lt;Integer&gt; spreadProductsForEachLeg;</TD></TR><TR CLASS="z"><TD CLASS="l">665</TD><TD>                for(int i=0 ; i &lt; p_strategyLegs.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">666</TD><TD>                        int legProd = p_strategyLegs[i].product;</TD></TR><TR><TD CLASS="l">667</TD><TD>                        </TD></TR><TR><TD CLASS="l">668</TD><TD>                        //in case multiple threads are trying to update the legPtod associated strategy set</TD></TR><TR CLASS="z"><TD CLASS="l">669</TD><TD>                        synchronized(associatedStrategiesPerProduct)</TD></TR><TR><TD CLASS="l">670</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">671</TD><TD>                                if(associatedStrategiesPerProduct.get(legProd) == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">672</TD><TD>                                        spreadProductsForEachLeg = new HashSet&lt;Integer&gt;();</TD></TR><TR><TD CLASS="l">673</TD><TD>                                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">674</TD><TD>                                        spreadProductsForEachLeg = associatedStrategiesPerProduct.get(legProd);</TD></TR><TR><TD CLASS="l">675</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">676</TD><TD>                                spreadProductsForEachLeg.add(prodData.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">677</TD><TD>                                associatedStrategiesPerProduct.put(legProd, spreadProductsForEachLeg);</TD></TR><TR CLASS="z"><TD CLASS="l">678</TD><TD>                        }</TD></TR><TR><TD CLASS="l">679</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">680</TD><TD>                calculatePriceProtectionForStrategy(prodData);</TD></TR><TR CLASS="z"><TD CLASS="l">681</TD><TD>        }</TD></TR><TR><TD CLASS="l">682</TD><TD> </TD></TR><TR><TD CLASS="l">683</TD><TD>        private final ConcurrentIntHashMap&lt;ProductDataImpl&gt; cloneProdCacheWithAddition(</TD></TR><TR><TD CLASS="l">684</TD><TD>                        final ProductStructV4[] v4raw,</TD></TR><TR><TD CLASS="l">685</TD><TD>                        final StrategyStruct[] legsRaw,</TD></TR><TR><TD CLASS="l">686</TD><TD>                        final ProductClassDataImpl prodClass,</TD></TR><TR><TD CLASS="l">687</TD><TD>                        boolean isStrategy)</TD></TR><TR><TD CLASS="l"><A NAME="28">688</A></TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">689</TD><TD>        {</TD></TR><TR><TD CLASS="l">690</TD><TD>                // Update cache:</TD></TR><TR><TD CLASS="l">691</TD><TD>                //</TD></TR><TR CLASS="z"><TD CLASS="l">692</TD><TD>                if (prodClass==null)</TD></TR><TR CLASS="z"><TD CLASS="l">693</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">694</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">695</TD><TD>                int size = isStrategy ? (legsRaw==null ? 0 : legsRaw.length) : (v4raw==null ? 0 : v4raw.length);</TD></TR><TR CLASS="z"><TD CLASS="l">696</TD><TD>                if (size&gt;0)</TD></TR><TR><TD CLASS="l">697</TD><TD>                {</TD></TR><TR><TD CLASS="l">698</TD><TD>                        if (CLONE_AND_SWAP)</TD></TR><TR><TD CLASS="l">699</TD><TD>                        {</TD></TR><TR><TD CLASS="l">700</TD><TD>                                final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdDataMap = new ConcurrentIntHashMap&lt;ProductDataImpl&gt;(allProdData.size()+size*5);</TD></TR><TR><TD CLASS="l">701</TD><TD>                                int count = createProdCacheStruct(newProdDataMap, v4raw, legsRaw, prodClass, isStrategy);</TD></TR><TR><TD CLASS="l">702</TD><TD>                                if (count&gt;0)</TD></TR><TR><TD CLASS="l">703</TD><TD>                                        return newProdDataMap;</TD></TR><TR><TD CLASS="l">704</TD><TD>                        }</TD></TR><TR><TD CLASS="l">705</TD><TD>                        else</TD></TR><TR><TD CLASS="l">706</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">707</TD><TD>                                int count = createProdCacheStruct(allProdData, v4raw, legsRaw, prodClass, isStrategy);</TD></TR><TR CLASS="z"><TD CLASS="l">708</TD><TD>                                if (count&gt;0)</TD></TR><TR CLASS="z"><TD CLASS="l">709</TD><TD>                                        return allProdData;</TD></TR><TR><TD CLASS="l">710</TD><TD>                        }</TD></TR><TR><TD CLASS="l">711</TD><TD>                }</TD></TR><TR><TD CLASS="l">712</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">713</TD><TD>                return null;</TD></TR><TR><TD CLASS="l">714</TD><TD>        }</TD></TR><TR><TD CLASS="l">715</TD><TD> </TD></TR><TR><TD CLASS="l">716</TD><TD>        private final int createProdCacheStruct(</TD></TR><TR><TD CLASS="l">717</TD><TD>                        final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdDataMap,</TD></TR><TR><TD CLASS="l">718</TD><TD>                        final ProductStructV4[] v4raw,</TD></TR><TR><TD CLASS="l">719</TD><TD>                        final StrategyStruct[] legsRaw,</TD></TR><TR><TD CLASS="l"><A NAME="29">720</A></TD><TD>                        final ProductClassDataImpl prodClass,</TD></TR><TR><TD CLASS="l">721</TD><TD>                        boolean isStrategy)</TD></TR><TR><TD CLASS="l">722</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">723</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">724</TD><TD>                int count = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">725</TD><TD>                int size = isStrategy ? (legsRaw==null ? 0 : legsRaw.length) : (v4raw==null ? 0 : v4raw.length);</TD></TR><TR CLASS="z"><TD CLASS="l">726</TD><TD>                ProductDataImpl data = null;</TD></TR><TR CLASS="z"><TD CLASS="l">727</TD><TD>                for (int i=0; i&lt;size; i++)</TD></TR><TR><TD CLASS="l">728</TD><TD>                {</TD></TR><TR><TD CLASS="l">729</TD><TD>                    //assume when class changes, all prods in it may change</TD></TR><TR><TD CLASS="l">730</TD><TD>                    //if newProdDataMap.containsKey(isStrategy ? legsRaw[i].product.productKeys.productKey : v4raw[i].product.productKeys.productKey))</TD></TR><TR><TD CLASS="l">731</TD><TD>                    //   continue;</TD></TR><TR CLASS="z"><TD CLASS="l">732</TD><TD>                        data = isStrategy ? createProductCacheStruct(legsRaw[i]) : createProductCacheStruct(v4raw[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">733</TD><TD>                        data = populateProdState(data);</TD></TR><TR CLASS="z"><TD CLASS="l">734</TD><TD>                        if (data!=null)</TD></TR><TR><TD CLASS="l">735</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">736</TD><TD>                                if (count==0 &amp;&amp; CLONE_AND_SWAP)</TD></TR><TR><TD CLASS="l">737</TD><TD>                                {</TD></TR><TR><TD CLASS="l">738</TD><TD>                                    newProdDataMap.putAll(allProdData);</TD></TR><TR><TD CLASS="l">739</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">740</TD><TD>                                newProdDataMap.put(data.getProductKey(), data);</TD></TR><TR CLASS="z"><TD CLASS="l">741</TD><TD>                                prodClass.update(isStrategy ? legsRaw[i].product : v4raw[i].product);</TD></TR><TR CLASS="z"><TD CLASS="l">742</TD><TD>                                        count++;</TD></TR><TR><TD CLASS="l">743</TD><TD>                                }</TD></TR><TR><TD CLASS="l">744</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">745</TD><TD>                return count;</TD></TR><TR><TD CLASS="l">746</TD><TD>        }</TD></TR><TR><TD CLASS="l">747</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2d">748</A></TD><TD>        private final ProductDataImpl createProductCacheStruct(</TD></TR><TR><TD CLASS="l">749</TD><TD>                        final StrategyStruct strategy)</TD></TR><TR><TD CLASS="l">750</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">751</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">752</TD><TD>                final ProductDataImpl data = createProductCacheStruct(strategy.product, null);</TD></TR><TR CLASS="z"><TD CLASS="l">753</TD><TD>                updateWithLegInfo(data, strategy);</TD></TR><TR CLASS="z"><TD CLASS="l">754</TD><TD>                return data;</TD></TR><TR><TD CLASS="l">755</TD><TD>        }</TD></TR><TR><TD CLASS="l">756</TD><TD> </TD></TR><TR><TD CLASS="l">757</TD><TD>        private final ConcurrentIntHashMap&lt;ProductDataImpl&gt; cloneProdCacheWithAddition(</TD></TR><TR><TD CLASS="l">758</TD><TD>                final ProductClassDataImpl classData,</TD></TR><TR><TD CLASS="l">759</TD><TD>                        final ProductStruct raw,</TD></TR><TR><TD CLASS="l">760</TD><TD>                        final ProductInformationStruct p_pinfo,</TD></TR><TR><TD CLASS="l"><A NAME="27">761</A></TD><TD>                        short strategyType,</TD></TR><TR><TD CLASS="l">762</TD><TD>                        final StrategyLegStruct[] legsRaw)</TD></TR><TR><TD CLASS="l">763</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">764</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">765</TD><TD>        if (classData != null)</TD></TR><TR><TD CLASS="l">766</TD><TD>        {</TD></TR><TR><TD CLASS="l">767</TD><TD>            // Update cache:</TD></TR><TR><TD CLASS="l">768</TD><TD>            //</TD></TR><TR CLASS="z"><TD CLASS="l">769</TD><TD>            ProductDataImpl data = createProductCacheStruct(raw, p_pinfo);</TD></TR><TR><TD CLASS="l">770</TD><TD>            ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdDataMap;</TD></TR><TR><TD CLASS="l">771</TD><TD>            if (CLONE_AND_SWAP)</TD></TR><TR><TD CLASS="l">772</TD><TD>            {</TD></TR><TR><TD CLASS="l">773</TD><TD>                newProdDataMap = new ConcurrentIntHashMap&lt;ProductDataImpl&gt;(allProdData.size()+5);</TD></TR><TR><TD CLASS="l">774</TD><TD>                newProdDataMap.putAll(allProdData);</TD></TR><TR><TD CLASS="l">775</TD><TD>            }</TD></TR><TR><TD CLASS="l">776</TD><TD>            else</TD></TR><TR><TD CLASS="l">777</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">778</TD><TD>                newProdDataMap = allProdData;</TD></TR><TR><TD CLASS="l">779</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">780</TD><TD>            Set&lt;ProductStruct&gt; newProds = new HashSet&lt;ProductStruct&gt;(1);</TD></TR><TR CLASS="z"><TD CLASS="l">781</TD><TD>            final ConcurrentIntHashMap&lt;ProductDataImpl&gt; temp2 = addNewProdToCache(classData, newProds, raw, data, legsRaw, null, strategyType, newProdDataMap);</TD></TR><TR CLASS="z"><TD CLASS="l">782</TD><TD>            if (temp2==null)</TD></TR><TR CLASS="z"><TD CLASS="l">783</TD><TD>                return null;</TD></TR><TR CLASS="z"><TD CLASS="l">784</TD><TD>            classData.update(newProds);                </TD></TR><TR><TD CLASS="l">785</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">786</TD><TD>                return null;</TD></TR><TR><TD CLASS="l">787</TD><TD>        }</TD></TR><TR><TD CLASS="l">788</TD><TD>        </TD></TR><TR><TD CLASS="l">789</TD><TD>        private final ConcurrentIntHashMap&lt;ProductDataImpl&gt; addNewProdToCache(</TD></TR><TR><TD CLASS="l">790</TD><TD>                final ProductClassDataImpl classData,</TD></TR><TR><TD CLASS="l">791</TD><TD>                final Set&lt;ProductStruct&gt; updated,</TD></TR><TR><TD CLASS="l">792</TD><TD>                final ProductStruct raw,</TD></TR><TR><TD CLASS="l">793</TD><TD>                ProductDataImpl newProdData,</TD></TR><TR><TD CLASS="l">794</TD><TD>                final StrategyLegStruct[] legsRaw,</TD></TR><TR><TD CLASS="l">795</TD><TD>                StrategyStruct legs,</TD></TR><TR><TD CLASS="l"><A NAME="15">796</A></TD><TD>                short strategyType,</TD></TR><TR><TD CLASS="l">797</TD><TD>                final ConcurrentIntHashMap&lt;ProductDataImpl&gt; prodDataMap)</TD></TR><TR><TD CLASS="l">798</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">799</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">800</TD><TD>        if (newProdData.isStrategy())</TD></TR><TR><TD CLASS="l">801</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">802</TD><TD>            if (legsRaw==null)</TD></TR><TR><TD CLASS="l">803</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">804</TD><TD>                if (legs==null)</TD></TR><TR CLASS="z"><TD CLASS="l">805</TD><TD>                    legs = fetchStrategyStructByProdFromGlobal(newProdData.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">806</TD><TD>                if (legs==null)</TD></TR><TR CLASS="z"><TD CLASS="l">807</TD><TD>                    newProdData=null;</TD></TR><TR><TD CLASS="l">808</TD><TD>                else</TD></TR><TR CLASS="z"><TD CLASS="l">809</TD><TD>                    updateWithLegInfo(newProdData, legs);</TD></TR><TR><TD CLASS="l">810</TD><TD>            }</TD></TR><TR><TD CLASS="l">811</TD><TD>            else</TD></TR><TR><TD CLASS="l">812</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">813</TD><TD>                updateWithLegInfo(newProdData, strategyType, legsRaw);</TD></TR><TR><TD CLASS="l">814</TD><TD>            }</TD></TR><TR><TD CLASS="l">815</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">816</TD><TD>        newProdData = populateProdState(newProdData);</TD></TR><TR CLASS="z"><TD CLASS="l">817</TD><TD>        if (newProdData!=null)</TD></TR><TR><TD CLASS="l">818</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">819</TD><TD>            if (newProdData.isStrategy())</TD></TR><TR><TD CLASS="l">820</TD><TD>            {</TD></TR><TR><TD CLASS="l">821</TD><TD>                try</TD></TR><TR><TD CLASS="l">822</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">823</TD><TD>                    checkLegProds(prodDataMap, legsRaw, legs);</TD></TR><TR><TD CLASS="l">824</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">825</TD><TD>                catch (DataValidationException e)</TD></TR><TR><TD CLASS="l">826</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">827</TD><TD>                    return null;</TD></TR><TR CLASS="z"><TD CLASS="l">828</TD><TD>                }</TD></TR><TR><TD CLASS="l">829</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">830</TD><TD>            prodDataMap.put(newProdData.getProductKey(), newProdData);</TD></TR><TR CLASS="z"><TD CLASS="l">831</TD><TD>            updated.add(raw);</TD></TR><TR CLASS="z"><TD CLASS="l">832</TD><TD>            return prodDataMap;</TD></TR><TR><TD CLASS="l">833</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">834</TD><TD>        return null;</TD></TR><TR><TD CLASS="l">835</TD><TD>        }</TD></TR><TR><TD CLASS="l">836</TD><TD>        </TD></TR><TR><TD CLASS="l">837</TD><TD>        private final void checkLegProds(</TD></TR><TR><TD CLASS="l">838</TD><TD>                final ConcurrentIntHashMap&lt;ProductDataImpl&gt; prodMap,</TD></TR><TR><TD CLASS="l"><A NAME="24">839</A></TD><TD>                StrategyLegStruct[] legsRaw,</TD></TR><TR><TD CLASS="l">840</TD><TD>                final StrategyStruct legs)</TD></TR><TR><TD CLASS="l">841</TD><TD>        throws SystemException, DataValidationException</TD></TR><TR><TD CLASS="l">842</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">843</TD><TD>            ProductStructV4 legProdStruct = null;</TD></TR><TR CLASS="z"><TD CLASS="l">844</TD><TD>            ProductData legProdData = null;</TD></TR><TR CLASS="z"><TD CLASS="l">845</TD><TD>            StrategyStruct[] legsRawOfLeg = null;</TD></TR><TR CLASS="z"><TD CLASS="l">846</TD><TD>            ProductClassDataImpl legClassData = null;</TD></TR><TR CLASS="z"><TD CLASS="l">847</TD><TD>            if (legsRaw != null)</TD></TR><TR><TD CLASS="l">848</TD><TD>            {</TD></TR><TR><TD CLASS="l">849</TD><TD>            }</TD></TR><TR><TD CLASS="l">850</TD><TD>            else</TD></TR><TR><TD CLASS="l">851</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">852</TD><TD>                legsRaw = legs.strategyLegs;</TD></TR><TR><TD CLASS="l">853</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">854</TD><TD>            for (StrategyLegStruct legProd : legsRaw)</TD></TR><TR><TD CLASS="l">855</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">856</TD><TD>                if (prodMap.containsKey(legProd.product))</TD></TR><TR CLASS="z"><TD CLASS="l">857</TD><TD>                    continue;</TD></TR><TR CLASS="z"><TD CLASS="l">858</TD><TD>                legProdStruct = fetchProductStructFromGlobal(legProd.product);</TD></TR><TR CLASS="z"><TD CLASS="l">859</TD><TD>                if (legProdStruct==null)</TD></TR><TR CLASS="z"><TD CLASS="l">860</TD><TD>                    throw ExceptionBuilder.dataValidationException(&#34;Leg prod::&#34;+legProdStruct+&#34; is among the bad keys; abort look up&#34;, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">861</TD><TD>                if (legProdStruct.product.listingState != ListingStates.ACTIVE)</TD></TR><TR CLASS="z"><TD CLASS="l">862</TD><TD>                    throw ExceptionBuilder.dataValidationException(&#34;Inactive leg prod::&#34;+legProdStruct, 0);</TD></TR><TR><TD CLASS="l">863</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">864</TD><TD>                legProdData = createProductCacheStruct(legProdStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">865</TD><TD>                legsRawOfLeg = isStrategy(legProdStruct.product);</TD></TR><TR CLASS="z"><TD CLASS="l">866</TD><TD>                if (legsRawOfLeg==null)</TD></TR><TR><TD CLASS="l">867</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">868</TD><TD>                    throw ExceptionBuilder.dataValidationException(&#34;Invalid leg prod with invalid class for the session::&#34;+legProdStruct, 0);                        </TD></TR><TR><TD CLASS="l">869</TD><TD>                }</TD></TR><TR><TD CLASS="l">870</TD><TD>                else</TD></TR><TR><TD CLASS="l">871</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">872</TD><TD>                legClassData = allProdClassData.get(legProdStruct.product.productKeys.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">873</TD><TD>                if (legClassData==null)</TD></TR><TR CLASS="z"><TD CLASS="l">874</TD><TD>                    throw ExceptionBuilder.dataValidationException(&#34;Invalid leg prod with invalid class for the session::&#34;+legProdStruct, 0);</TD></TR><TR><TD CLASS="l">875</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">876</TD><TD>                    if (legsRawOfLeg.length==0 || legsRawOfLeg[0].strategyLegs.length==0)</TD></TR><TR CLASS="z"><TD CLASS="l">877</TD><TD>                   continue;</TD></TR><TR CLASS="z"><TD CLASS="l">878</TD><TD>                    else if (legsRawOfLeg.length==1)</TD></TR><TR><TD CLASS="l">879</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">880</TD><TD>                       checkLegProds(prodMap, null, legsRawOfLeg[0]);</TD></TR><TR CLASS="z"><TD CLASS="l">881</TD><TD>                   legClassData.update(legProdStruct.product);</TD></TR><TR><TD CLASS="l">882</TD><TD>                    }</TD></TR><TR><TD CLASS="l">883</TD><TD>                }</TD></TR><TR><TD CLASS="l">884</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">885</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="49">886</A></TD><TD>        </TD></TR><TR><TD CLASS="l">887</TD><TD>        private final StrategyStruct[] isStrategy(ProductStruct raw)</TD></TR><TR><TD CLASS="l">888</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">889</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">890</TD><TD>            ProductClassDataImpl classData = allProdClassData.get(raw.productKeys.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">891</TD><TD>            if (classData != null)</TD></TR><TR><TD CLASS="l">892</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">893</TD><TD>                boolean isStrategy = classData.getProductType() == ProductTypes.STRATEGY;</TD></TR><TR CLASS="z"><TD CLASS="l">894</TD><TD>                if (isStrategy)</TD></TR><TR><TD CLASS="l">895</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">896</TD><TD>                    StrategyStruct legs = fetchStrategyStructByProdFromGlobal(raw.productKeys.productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">897</TD><TD>                    if (legs == null)</TD></TR><TR CLASS="z"><TD CLASS="l">898</TD><TD>                        return EMPTY_LEGS;</TD></TR><TR><TD CLASS="l">899</TD><TD>                    else</TD></TR><TR CLASS="z"><TD CLASS="l">900</TD><TD>                        return new StrategyStruct[] {legs};</TD></TR><TR><TD CLASS="l">901</TD><TD>                }</TD></TR><TR><TD CLASS="l">902</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">903</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">904</TD><TD>        }</TD></TR><TR><TD CLASS="l">905</TD><TD> </TD></TR><TR><TD CLASS="l">906</TD><TD>        private final ConcurrentIntHashMap&lt;ProductDataImpl&gt; cloneProdCacheWithAddition(</TD></TR><TR><TD CLASS="l">907</TD><TD>                final ProductClassDataImpl classData,</TD></TR><TR><TD CLASS="l">908</TD><TD>                        final ProductStruct[] raw,</TD></TR><TR><TD CLASS="l"><A NAME="26">909</A></TD><TD>                        final StrategyStruct[] legsRaw,</TD></TR><TR><TD CLASS="l">910</TD><TD>                        boolean isStrategy)</TD></TR><TR><TD CLASS="l">911</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">912</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">913</TD><TD>            if (classData==null) return null;</TD></TR><TR><TD CLASS="l">914</TD><TD>                // Update cache:</TD></TR><TR><TD CLASS="l">915</TD><TD>                //</TD></TR><TR CLASS="z"><TD CLASS="l">916</TD><TD>                int size = isStrategy ? (legsRaw==null?0:legsRaw.length) : (raw==null ? 0 : raw.length);</TD></TR><TR CLASS="z"><TD CLASS="l">917</TD><TD>                if (size&gt;0)</TD></TR><TR><TD CLASS="l">918</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">919</TD><TD>                        boolean isFirst=true;</TD></TR><TR CLASS="z"><TD CLASS="l">920</TD><TD>                        ProductDataImpl data = null;</TD></TR><TR CLASS="z"><TD CLASS="l">921</TD><TD>                        ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdDataMap = null;</TD></TR><TR CLASS="z"><TD CLASS="l">922</TD><TD>                        ConcurrentIntHashMap&lt;ProductDataImpl&gt; temp2 = null;</TD></TR><TR CLASS="z"><TD CLASS="l">923</TD><TD>                        Set&lt;ProductStruct&gt; newProds = new HashSet&lt;ProductStruct&gt;(size);</TD></TR><TR CLASS="z"><TD CLASS="l">924</TD><TD>                        ProductStruct temp = null;</TD></TR><TR CLASS="z"><TD CLASS="l">925</TD><TD>                        for (int i=0; i&lt;size; i++)</TD></TR><TR><TD CLASS="l">926</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">927</TD><TD>                            temp = isStrategy ? legsRaw[i].product : raw[i];</TD></TR><TR><TD CLASS="l">928</TD><TD>                            //assuming when a class changes, its prods change too</TD></TR><TR><TD CLASS="l">929</TD><TD>                            //if (allProdData.containsKey(temp.productKeys.productKey))</TD></TR><TR><TD CLASS="l">930</TD><TD>                            //   continue;</TD></TR><TR CLASS="z"><TD CLASS="l">931</TD><TD>                                data = isStrategy ? createProductCacheStruct(legsRaw[i]) : createProductCacheStruct(raw[i], null);</TD></TR><TR CLASS="z"><TD CLASS="l">932</TD><TD>                                if (data!=null)</TD></TR><TR><TD CLASS="l">933</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">934</TD><TD>                                    if (isFirst)</TD></TR><TR><TD CLASS="l">935</TD><TD>                                    {</TD></TR><TR><TD CLASS="l">936</TD><TD>                                        if (CLONE_AND_SWAP)</TD></TR><TR><TD CLASS="l">937</TD><TD>                                        {</TD></TR><TR><TD CLASS="l">938</TD><TD>                                            newProdDataMap = new ConcurrentIntHashMap&lt;ProductDataImpl&gt;(allProdData.size()+size*5);</TD></TR><TR><TD CLASS="l">939</TD><TD>                                            newProdDataMap.putAll(this.allProdData);</TD></TR><TR><TD CLASS="l">940</TD><TD>                                        }</TD></TR><TR><TD CLASS="l">941</TD><TD>                                        else</TD></TR><TR><TD CLASS="l">942</TD><TD>                                        {</TD></TR><TR CLASS="z"><TD CLASS="l">943</TD><TD>                                            newProdDataMap = allProdData;</TD></TR><TR><TD CLASS="l">944</TD><TD>                                        }</TD></TR><TR><TD CLASS="l">945</TD><TD>                                    }</TD></TR><TR CLASS="z"><TD CLASS="l">946</TD><TD>                                    if (isStrategy)</TD></TR><TR><TD CLASS="l">947</TD><TD>                                    {</TD></TR><TR CLASS="z"><TD CLASS="l">948</TD><TD>                                        temp2 = addNewProdToCache(classData, newProds, temp, data, null, legsRaw[i], legsRaw[i].strategyType, newProdDataMap);</TD></TR><TR><TD CLASS="l">949</TD><TD>                                    }</TD></TR><TR><TD CLASS="l">950</TD><TD>                                    else</TD></TR><TR><TD CLASS="l">951</TD><TD>                                    {</TD></TR><TR CLASS="z"><TD CLASS="l">952</TD><TD>                                        temp2 = addNewProdToCache(classData, newProds, temp, data, null, null, (short)0, newProdDataMap);</TD></TR><TR><TD CLASS="l">953</TD><TD>                                    }</TD></TR><TR CLASS="z"><TD CLASS="l">954</TD><TD>                                    if (temp2!=null)</TD></TR><TR CLASS="z"><TD CLASS="l">955</TD><TD>                                       isFirst = false;</TD></TR><TR><TD CLASS="l">956</TD><TD>                                }</TD></TR><TR><TD CLASS="l">957</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">958</TD><TD>                        if (isFirst)</TD></TR><TR CLASS="z"><TD CLASS="l">959</TD><TD>                            return allProdData;</TD></TR><TR><TD CLASS="l">960</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">961</TD><TD>                        classData.update(newProds);</TD></TR><TR CLASS="z"><TD CLASS="l">962</TD><TD>                        return newProdDataMap;</TD></TR><TR><TD CLASS="l">963</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">964</TD><TD>                return null;</TD></TR><TR><TD CLASS="l">965</TD><TD>        }</TD></TR><TR><TD CLASS="l">966</TD><TD> </TD></TR><TR><TD CLASS="l">967</TD><TD>        private final void updateProdClassCache(</TD></TR><TR><TD CLASS="l"><A NAME="6b">968</A></TD><TD>                        final ProductClassDataImpl classData,</TD></TR><TR><TD CLASS="l">969</TD><TD>                        final ProductClassStructV3 raw)</TD></TR><TR><TD CLASS="l">970</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">971</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">972</TD><TD>                if (classData != null) {</TD></TR><TR><TD CLASS="l">973</TD><TD>                        //Update reporting class data cache</TD></TR><TR CLASS="z"><TD CLASS="l">974</TD><TD>                        StrategyStruct[] legsRaw = null;</TD></TR><TR CLASS="z"><TD CLASS="l">975</TD><TD>                        boolean isStrategy = classData.getProductType() == ProductTypes.STRATEGY;</TD></TR><TR CLASS="z"><TD CLASS="l">976</TD><TD>                        if (isStrategy)</TD></TR><TR><TD CLASS="l">977</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">978</TD><TD>                                legsRaw = this.fetchStrategyStructByClassFromGlobal(classData.getClassKey(), false);</TD></TR><TR CLASS="z"><TD CLASS="l">979</TD><TD>                                if (legsRaw == null)</TD></TR><TR CLASS="z"><TD CLASS="l">980</TD><TD>                                        return;</TD></TR><TR><TD CLASS="l">981</TD><TD>                        }</TD></TR><TR><TD CLASS="l">982</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">983</TD><TD>                        final IntHashMap&lt;ReportingClassDataImpl&gt; newRptClassMap = updateRptClassCacheWithAddition(raw.info.reportingClasses);</TD></TR><TR CLASS="z"><TD CLASS="l">984</TD><TD>                        if (newRptClassMap==null)</TD></TR><TR CLASS="z"><TD CLASS="l">985</TD><TD>                                return;</TD></TR><TR><TD CLASS="l">986</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">987</TD><TD>                        final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdMap = cloneProdCacheWithAddition(raw.products, legsRaw, classData, isStrategy);</TD></TR><TR CLASS="z"><TD CLASS="l">988</TD><TD>                        if (newProdMap==null)</TD></TR><TR CLASS="z"><TD CLASS="l">989</TD><TD>                                return;</TD></TR><TR><TD CLASS="l">990</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">991</TD><TD>                        updateRptClassCache(newRptClassMap, raw.info.reportingClasses);</TD></TR><TR CLASS="z"><TD CLASS="l">992</TD><TD>                        if (isStrategy)</TD></TR><TR CLASS="z"><TD CLASS="l">993</TD><TD>                                updateProdCache(newProdMap, legsRaw);</TD></TR><TR><TD CLASS="l">994</TD><TD>                        else</TD></TR><TR CLASS="z"><TD CLASS="l">995</TD><TD>                                updateProdCache(newProdMap, raw.products);</TD></TR><TR><TD CLASS="l">996</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">997</TD><TD>                        allProdClassData.put(classData.getClassKey(), classData);</TD></TR><TR CLASS="z"><TD CLASS="l">998</TD><TD>                        if (classData.isLinkageDisabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">999</TD><TD>                            linkageDisabledCount++;</TD></TR><TR><TD CLASS="l">1000</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1001</TD><TD>                        notifyListeners(classData, null);</TD></TR><TR><TD CLASS="l">1002</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1003</TD><TD>        }</TD></TR><TR><TD CLASS="l">1004</TD><TD> </TD></TR><TR><TD CLASS="l">1005</TD><TD>        private final void updateProdClassCache(</TD></TR><TR><TD CLASS="l"><A NAME="6a">1006</A></TD><TD>                        final ProductClassDataImpl classData,</TD></TR><TR><TD CLASS="l">1007</TD><TD>                        final ProductClassStruct raw)</TD></TR><TR><TD CLASS="l">1008</TD><TD>        throws SystemException</TD></TR><TR><TD CLASS="l">1009</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1010</TD><TD>                if (classData != null) {</TD></TR><TR><TD CLASS="l">1011</TD><TD>                        //Update reporting class data cache</TD></TR><TR CLASS="z"><TD CLASS="l">1012</TD><TD>                        StrategyStruct[] legsRaw = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1013</TD><TD>                        boolean isStrategy = classData.getProductType() == ProductTypes.STRATEGY;</TD></TR><TR CLASS="z"><TD CLASS="l">1014</TD><TD>                        if (isStrategy)</TD></TR><TR><TD CLASS="l">1015</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1016</TD><TD>                                legsRaw = this.fetchStrategyStructByClassFromGlobal(classData.getClassKey(), false);</TD></TR><TR CLASS="z"><TD CLASS="l">1017</TD><TD>                                if (legsRaw == null)</TD></TR><TR CLASS="z"><TD CLASS="l">1018</TD><TD>                                        return;</TD></TR><TR><TD CLASS="l">1019</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1020</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1021</TD><TD>                        final IntHashMap&lt;ReportingClassDataImpl&gt; newRptClassMap = updateRptClassCacheWithAddition(raw.info.reportingClasses);</TD></TR><TR CLASS="z"><TD CLASS="l">1022</TD><TD>                        if (newRptClassMap==null)</TD></TR><TR CLASS="z"><TD CLASS="l">1023</TD><TD>                                return;</TD></TR><TR><TD CLASS="l">1024</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1025</TD><TD>                        final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdMap = cloneProdCacheWithAddition(classData, raw.products, legsRaw, isStrategy);</TD></TR><TR CLASS="z"><TD CLASS="l">1026</TD><TD>                        if (newProdMap==null)</TD></TR><TR CLASS="z"><TD CLASS="l">1027</TD><TD>                                return;</TD></TR><TR><TD CLASS="l">1028</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1029</TD><TD>                        updateRptClassCache(newRptClassMap, raw.info.reportingClasses);</TD></TR><TR CLASS="z"><TD CLASS="l">1030</TD><TD>                        if (isStrategy)</TD></TR><TR CLASS="z"><TD CLASS="l">1031</TD><TD>                                updateProdCache(newProdMap, legsRaw);</TD></TR><TR><TD CLASS="l">1032</TD><TD>                        else</TD></TR><TR CLASS="z"><TD CLASS="l">1033</TD><TD>                                updateProdCache(newProdMap, raw.products);</TD></TR><TR><TD CLASS="l">1034</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">1035</TD><TD>            allProdClassData.put(classData.getClassKey(), classData);</TD></TR><TR CLASS="z"><TD CLASS="l">1036</TD><TD>            if (classData.isLinkageDisabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1037</TD><TD>                linkageDisabledCount++;</TD></TR><TR><TD CLASS="l">1038</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1039</TD><TD>            notifyListeners(classData, null);</TD></TR><TR><TD CLASS="l">1040</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1041</TD><TD>        }</TD></TR><TR><TD CLASS="l">1042</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="36">1043</A></TD><TD>        public final ProductClassStructV3 fetchClassStructFromGlobal(</TD></TR><TR><TD CLASS="l">1044</TD><TD>                        int classKey, boolean p_setDownloadException)</TD></TR><TR><TD CLASS="l">1045</TD><TD>        throws Exception</TD></TR><TR><TD CLASS="l">1046</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1047</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">1048</TD><TD>                logger.info(msg.add(&#34;fetchClassStructFromGlobal() class::&#34;).add(classKey));</TD></TR><TR CLASS="z"><TD CLASS="l">1049</TD><TD>                msg.clear();</TD></TR><TR><TD CLASS="l">1050</TD><TD>                </TD></TR><TR><TD CLASS="l">1051</TD><TD>                ProductClassStructV3  prodClassStructV3;</TD></TR><TR><TD CLASS="l">1052</TD><TD>                try</TD></TR><TR><TD CLASS="l">1053</TD><TD>                {</TD></TR><TR><TD CLASS="l">1054</TD><TD>                        // Include active classes and products, but not reporting classes</TD></TR><TR><TD CLASS="l">1055</TD><TD>                        // (we don't have reason to care for reporting classes at this point)</TD></TR><TR><TD CLASS="l">1056</TD><TD>                        // we do for contract size :-) 10/08/2007</TD></TR><TR CLASS="z"><TD CLASS="l">1057</TD><TD>                        prodClassStructV3 = pqs.getProductClassByKeyV3(classKey, true, true, true);</TD></TR><TR><TD CLASS="l">1058</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1059</TD><TD>                catch (NotFoundException ex)</TD></TR><TR><TD CLASS="l">1060</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1061</TD><TD>                        badClassKeyTimeout.put(classKey, System.currentTimeMillis()+BAD_KEY_TIMEOUT);</TD></TR><TR CLASS="z"><TD CLASS="l">1062</TD><TD>                        msg.add(PQS_SVC);</TD></TR><TR CLASS="z"><TD CLASS="l">1063</TD><TD>                        msg.add(&#34; NotFoundException for&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1064</TD><TD>                        msg.add(&#34;prodClassKey&#34;, classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1065</TD><TD>                        Log.exception(msg.end(), ex);</TD></TR><TR CLASS="z"><TD CLASS="l">1066</TD><TD>                        if (p_setDownloadException)</TD></TR><TR><TD CLASS="l">1067</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1068</TD><TD>                                throw ex;</TD></TR><TR><TD CLASS="l">1069</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1070</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">1071</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1072</TD><TD>                catch (Exception ex)</TD></TR><TR><TD CLASS="l">1073</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1074</TD><TD>                        msg.add(&#34;ProductDownload: &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1075</TD><TD>                        msg.add(PQS_SVC);</TD></TR><TR CLASS="z"><TD CLASS="l">1076</TD><TD>                        msg.add(&#34; Fatal exception for&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1077</TD><TD>                        msg.add(&#34;prodClassKey&#34;, classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1078</TD><TD>                        Log.exception(msg.end(), ex);</TD></TR><TR CLASS="z"><TD CLASS="l">1079</TD><TD>                        if (p_setDownloadException)</TD></TR><TR><TD CLASS="l">1080</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1081</TD><TD>                                throw ex;</TD></TR><TR><TD CLASS="l">1082</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1083</TD><TD>                        return null;</TD></TR><TR CLASS="z"><TD CLASS="l">1084</TD><TD>                }</TD></TR><TR><TD CLASS="l">1085</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1086</TD><TD>                return prodClassStructV3;</TD></TR><TR><TD CLASS="l">1087</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="2a">1088</A></TD><TD> </TD></TR><TR><TD CLASS="l">1089</TD><TD>        private final ProductClassDataImpl createProdClassCacheStruct(</TD></TR><TR><TD CLASS="l">1090</TD><TD>                final ProductClassStructV3 prodClassStructV3)</TD></TR><TR><TD CLASS="l">1091</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1092</TD><TD>                final ProductClassDataImpl classData = new ProductClassDataImpl(prodClassStructV3.info);</TD></TR><TR CLASS="z"><TD CLASS="l">1093</TD><TD>                classData.setSpreadServerRolloutCompleted(this.spreadServerRolloutCompleted);</TD></TR><TR><TD CLASS="l">1094</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">1095</TD><TD>                String post = getParsedPostOrStation(prodClassStructV3.productLocation.postNumber, classData.getClassKey());</TD></TR><TR CLASS="z"><TD CLASS="l">1096</TD><TD>                String station = getParsedPostOrStation(prodClassStructV3.productLocation.stationNumber,classData.getClassKey());</TD></TR><TR CLASS="z"><TD CLASS="l">1097</TD><TD>                String extensions = prodClassStructV3.extensions;</TD></TR><TR><TD CLASS="l">1098</TD><TD>                // update sessionName information to ProductClassData for non strategy product</TD></TR><TR><TD CLASS="l">1099</TD><TD>                // because we only care about leg product</TD></TR><TR CLASS="z"><TD CLASS="l">1100</TD><TD>                if(post!=null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1101</TD><TD>                        classData.setPostNumber(post);</TD></TR><TR><TD CLASS="l">1102</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1103</TD><TD>                if(station!=null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1104</TD><TD>                        classData.setStationNumber(station);</TD></TR><TR><TD CLASS="l">1105</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1106</TD><TD>                if(extensions!=null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1107</TD><TD>                        classData.setExtensions(extensions);</TD></TR><TR><TD CLASS="l">1108</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1109</TD><TD>                classData.setMultiListIndicator(prodClassStructV3.multiList);</TD></TR><TR><TD CLASS="l">1110</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1111</TD><TD>                        String sessionName = allClassSessionNames.get(classData.getClassKey());</TD></TR><TR CLASS="z"><TD CLASS="l">1112</TD><TD>                if (sessionName != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1113</TD><TD>                    String[] sessions = SESS_LIST_SPLIT.split(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">1114</TD><TD>                    if (sessions.length&gt;0)</TD></TR><TR CLASS="z"><TD CLASS="l">1115</TD><TD>                        classData.setSessionNames(sessions);</TD></TR><TR><TD CLASS="l">1116</TD><TD>                }</TD></TR><TR><TD CLASS="l">1117</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">1118</TD><TD>                if (classData != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1119</TD><TD>                    String underlyingSessionName = allClassUnderlyingSessionNames.get(classData.getClassKey());</TD></TR><TR CLASS="z"><TD CLASS="l">1120</TD><TD>                    if (underlyingSessionName != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1121</TD><TD>                        classData.setUnderlyingSessionName(underlyingSessionName);</TD></TR><TR><TD CLASS="l">1122</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1123</TD><TD>                }</TD></TR><TR><TD CLASS="l">1124</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1125</TD><TD>                int classKey = classData.getClassKey();</TD></TR><TR><TD CLASS="l">1126</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1127</TD><TD>                if (tempRolloutFlags != null)</TD></TR><TR><TD CLASS="l">1128</TD><TD>        {             </TD></TR><TR CLASS="z"><TD CLASS="l">1129</TD><TD>            for (int i =0; i &lt; this.classKeys.size(); i++)</TD></TR><TR><TD CLASS="l">1130</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1131</TD><TD>                if (classKeys.get(i) == classKey){</TD></TR><TR CLASS="z"><TD CLASS="l">1132</TD><TD>                    classData.setRolloutIndicator(tempRolloutFlags[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">1133</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1134</TD><TD>                }</TD></TR><TR><TD CLASS="l">1135</TD><TD>            }</TD></TR><TR><TD CLASS="l">1136</TD><TD>        }</TD></TR><TR><TD CLASS="l">1137</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1138</TD><TD>                LinkageIndicatorResultStruct lkgIRSS = linkageIRSS.get(classData.getClassKey());</TD></TR><TR CLASS="z"><TD CLASS="l">1139</TD><TD>                if (lkgIRSS != null)</TD></TR><TR><TD CLASS="l">1140</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1141</TD><TD>                        classData.setLinkageIndicator(lkgIRSS.linkageIndicator);</TD></TR><TR><TD CLASS="l">1142</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1143</TD><TD>                return classData;</TD></TR><TR><TD CLASS="l">1144</TD><TD>        }</TD></TR><TR><TD CLASS="l">1145</TD><TD>        </TD></TR><TR><TD CLASS="l">1146</TD><TD>        private final ProductClassStructV3 initCacheForClassDownload(</TD></TR><TR><TD CLASS="l">1147</TD><TD>                        int classKey,</TD></TR><TR><TD CLASS="l">1148</TD><TD>                        final IntHashMap&lt;ProductClassDataImpl&gt; newClassMap,</TD></TR><TR><TD CLASS="l">1149</TD><TD>                        final IntHashMap&lt;ProductClassStructV3&gt; newClassRaw,</TD></TR><TR><TD CLASS="l">1150</TD><TD>                        final IntHashMap&lt;ReportingClassDataImpl&gt; newRptClassMap,</TD></TR><TR><TD CLASS="l"><A NAME="48">1151</A></TD><TD>                        final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdMap,</TD></TR><TR><TD CLASS="l">1152</TD><TD>                        boolean p_setDownloadException)</TD></TR><TR><TD CLASS="l">1153</TD><TD>        throws Exception</TD></TR><TR><TD CLASS="l">1154</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1155</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">1156</TD><TD>                logger.info(msg.add(&#34;caching class::&#34;).add(classKey));</TD></TR><TR CLASS="z"><TD CLASS="l">1157</TD><TD>                msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1158</TD><TD>                if (! verifyProdClassQueryStatus(classKey))</TD></TR><TR CLASS="z"><TD CLASS="l">1159</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">1160</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1161</TD><TD>                ProductClassStructV3 raw = null;</TD></TR><TR><TD CLASS="l">1162</TD><TD>                try</TD></TR><TR><TD CLASS="l">1163</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1164</TD><TD>                        raw = fetchClassStructFromGlobal(classKey, p_setDownloadException);</TD></TR><TR CLASS="z"><TD CLASS="l">1165</TD><TD>                        if (raw == null)</TD></TR><TR CLASS="z"><TD CLASS="l">1166</TD><TD>                                return null;</TD></TR><TR><TD CLASS="l">1167</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1168</TD><TD>                catch(Exception e)</TD></TR><TR><TD CLASS="l">1169</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1170</TD><TD>                        throw e;</TD></TR><TR CLASS="z"><TD CLASS="l">1171</TD><TD>                }</TD></TR><TR><TD CLASS="l">1172</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">1173</TD><TD>                final ProductClassDataImpl classData = createProdClassCacheStruct(raw);</TD></TR><TR CLASS="z"><TD CLASS="l">1174</TD><TD>        boolean isStrategy = classData.getProductType() == ProductTypes.STRATEGY;</TD></TR><TR CLASS="z"><TD CLASS="l">1175</TD><TD>        StrategyStruct[] legsRaw = null;</TD></TR><TR><TD CLASS="l">1176</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1177</TD><TD>        if (isStrategy)</TD></TR><TR><TD CLASS="l">1178</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1179</TD><TD>                        legsRaw = this.fetchStrategyStructByClassFromGlobal(classData.getClassKey(), false);</TD></TR><TR CLASS="z"><TD CLASS="l">1180</TD><TD>                        if (legsRaw == null)</TD></TR><TR CLASS="z"><TD CLASS="l">1181</TD><TD>                                return null;</TD></TR><TR><TD CLASS="l">1182</TD><TD>        }</TD></TR><TR><TD CLASS="l">1183</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">1184</TD><TD>                int count = createProdCacheStruct(newProdMap, raw.products, legsRaw, classData, isStrategy);</TD></TR><TR CLASS="z"><TD CLASS="l">1185</TD><TD>                if (count == 0)</TD></TR><TR><TD CLASS="l">1186</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1187</TD><TD>                        logger.alarm(msg.add(&#34;Class::&#34;).add(classKey).add(&#34; added ZERO of its products to cache&#34;));</TD></TR><TR><TD CLASS="l">1188</TD><TD>                        //return null;</TD></TR><TR><TD CLASS="l">1189</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1190</TD><TD>                if (raw.info.reportingClasses!=null &amp;&amp; raw.info.reportingClasses.length&gt;0)</TD></TR><TR><TD CLASS="l">1191</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1192</TD><TD>                    createRptClassCacheStruct(newRptClassMap, raw.info.reportingClasses);</TD></TR><TR><TD CLASS="l">1193</TD><TD>                }</TD></TR><TR><TD CLASS="l">1194</TD><TD>                else</TD></TR><TR><TD CLASS="l">1195</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1196</TD><TD>                        logger.alarm(msg.add(&#34;Class::&#34;).add(classKey).add(&#34; does not have any reporting class struct&#34;));</TD></TR><TR><TD CLASS="l">1197</TD><TD>                }</TD></TR><TR><TD CLASS="l">1198</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">1199</TD><TD>                newClassRaw.put(classKey, raw);</TD></TR><TR CLASS="z"><TD CLASS="l">1200</TD><TD>                newClassMap.put(classKey, classData);</TD></TR><TR CLASS="z"><TD CLASS="l">1201</TD><TD>                logger.info(msg.add(&#34;cached class::&#34;).add(classKey).add(&#34; with &#34;).add(classData.getProductKeys().length).add(&#34; products&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1202</TD><TD>                return raw;</TD></TR><TR><TD CLASS="l"><A NAME="42">1203</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">1204</TD><TD> </TD></TR><TR><TD CLASS="l">1205</TD><TD>        public final List&lt;ProductClassData&gt; getProductClassDataBySymbolRegex(String p_regex)</TD></TR><TR><TD CLASS="l">1206</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1207</TD><TD>                ArrayList&lt;ProductClassData&gt; list = new ArrayList&lt;ProductClassData&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1208</TD><TD>                for (ProductClassData classData : allProdClassData.values())</TD></TR><TR><TD CLASS="l">1209</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1210</TD><TD>                        if (classData.getClassSymbol().matches(p_regex))</TD></TR><TR><TD CLASS="l"><A NAME="7e">1211</A></TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1212</TD><TD>                                list.add(classData);</TD></TR><TR><TD CLASS="l">1213</TD><TD>                        }</TD></TR><TR><TD CLASS="l"><A NAME="80">1214</A></TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1215</TD><TD>                Collections.sort(list, new Comparator&lt;ProductClassData&gt;() {</TD></TR><TR><TD CLASS="l">1216</TD><TD>                        public int compare(ProductClassData p_o1, ProductClassData p_o2)</TD></TR><TR><TD CLASS="l">1217</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1218</TD><TD>                                return p_o1.getClassSymbol().compareTo(p_o2.getClassSymbol());</TD></TR><TR><TD CLASS="l">1219</TD><TD>                        }} );</TD></TR><TR CLASS="z"><TD CLASS="l">1220</TD><TD>                return list;</TD></TR><TR><TD CLASS="l">1221</TD><TD>        }</TD></TR><TR><TD CLASS="l">1222</TD><TD> </TD></TR><TR><TD CLASS="l">1223</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1224</TD><TD>         * @throws NotFoundException</TD></TR><TR><TD CLASS="l"><A NAME="41">1225</A></TD><TD>         * @see com.cboe.server.interfaces.productData.ProductDataCache#getProductClassData(int)</TD></TR><TR><TD CLASS="l">1226</TD><TD>         */</TD></TR><TR><TD CLASS="l">1227</TD><TD>        public ProductClassData getProductClassData(int p_productClassKey) throws NotFoundException</TD></TR><TR><TD CLASS="l">1228</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1229</TD><TD>                ProductClassData classData = allProdClassData.get(p_productClassKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1230</TD><TD>                if (classData == null)</TD></TR><TR><TD CLASS="l">1231</TD><TD>                {</TD></TR><TR><TD CLASS="l">1232</TD><TD>                        // TODO: hit global server on a local cache miss!!!!!!</TD></TR><TR><TD CLASS="l">1233</TD><TD> </TD></TR><TR><TD CLASS="l">1234</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1235</TD><TD>                if (classData == null)</TD></TR><TR><TD CLASS="l">1236</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1237</TD><TD>                        throw ExceptionBuilder.notFoundException(MsgBuilder.get().add(&#34;Class::&#34;).add(p_productClassKey ).add(&#34; not found&#34;).end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">1238</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1239</TD><TD>                return classData;</TD></TR><TR><TD CLASS="l">1240</TD><TD>        }</TD></TR><TR><TD CLASS="l">1241</TD><TD> </TD></TR><TR><TD CLASS="l">1242</TD><TD>        ///////////////////////////////////////////////////////////</TD></TR><TR><TD CLASS="l">1243</TD><TD>        //</TD></TR><TR><TD CLASS="l">1244</TD><TD>        // Product update callbacks:</TD></TR><TR><TD CLASS="l">1245</TD><TD>        //</TD></TR><TR><TD CLASS="l">1246</TD><TD> </TD></TR><TR><TD CLASS="l">1247</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1248</TD><TD>         * ProductStateConsumer method implementation</TD></TR><TR><TD CLASS="l"><A NAME="57">1249</A></TD><TD>         */</TD></TR><TR><TD CLASS="l">1250</TD><TD>        public void setClassState(ClassStateStruct p_newState)</TD></TR><TR><TD CLASS="l">1251</TD><TD>        {</TD></TR><TR><TD CLASS="l">1252</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1253</TD><TD>        }</TD></TR><TR><TD CLASS="l">1254</TD><TD> </TD></TR><TR><TD CLASS="l">1255</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1256</TD><TD>         * ProductStateConsumer method implementation</TD></TR><TR><TD CLASS="l"><A NAME="60">1257</A></TD><TD>         */</TD></TR><TR><TD CLASS="l">1258</TD><TD>        public void setProductStates(int p_classKey, String p_sessionName, ProductStateStruct[] p_productStates)</TD></TR><TR><TD CLASS="l">1259</TD><TD>        {</TD></TR><TR><TD CLASS="l">1260</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1261</TD><TD>                if (!this.allProdClassData.containsKey(p_classKey))</TD></TR><TR><TD CLASS="l">1262</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1263</TD><TD>                        return; // we don't have this class mapped - ignore the product update.</TD></TR><TR><TD CLASS="l">1264</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1265</TD><TD>                for (ProductStateStruct prodState : p_productStates)</TD></TR><TR><TD CLASS="l">1266</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1267</TD><TD>                        updateProdState(prodState);</TD></TR><TR><TD CLASS="l">1268</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1269</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="6c">1270</A></TD><TD> </TD></TR><TR><TD CLASS="l">1271</TD><TD>        private final void updateProdState(</TD></TR><TR><TD CLASS="l">1272</TD><TD>                        final ProductStateStruct prodState)</TD></TR><TR><TD CLASS="l">1273</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1274</TD><TD>                final ProductDataImpl prodData = this.allProdData.get(prodState.productKeys.productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1275</TD><TD>                if (prodData == null)</TD></TR><TR CLASS="z"><TD CLASS="l">1276</TD><TD>                        return;</TD></TR><TR><TD CLASS="l">1277</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1278</TD><TD>                if (!ignoreLowSeqNumbers &amp;&amp; prodState.productStateTransactionSequenceNumber  &lt; prodData.getStateSeqNum(prodState.sessionName))</TD></TR><TR><TD CLASS="l">1279</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1280</TD><TD>                        logger.info(MsgBuilder.get().add(&#34;Ignored prod state &#34;)</TD></TR><TR><TD CLASS="l">1281</TD><TD>                                        .add(&#34;prodKey&#34;, prodState.productKeys.productKey).add(&#34;of&#34;)</TD></TR><TR><TD CLASS="l">1282</TD><TD>                                        .add(&#34;state&#34;, prodState.productState)</TD></TR><TR><TD CLASS="l">1283</TD><TD>                                        .add(&#34;stateName&#34;, PROD_STATE_MAPPER.getName(prodState.productState, &#34;??&#34;))</TD></TR><TR><TD CLASS="l">1284</TD><TD>                                        .add(&#34;because&#34;)</TD></TR><TR><TD CLASS="l">1285</TD><TD>                                        .add(&#34;seqNum&#34;, prodState.productStateTransactionSequenceNumber)</TD></TR><TR><TD CLASS="l">1286</TD><TD>                                        .add(&#34;&lt;&#34;)</TD></TR><TR><TD CLASS="l">1287</TD><TD>                                        .add(&#34;mySeqNum&#34;, prodData.getStateSeqNum(prodState.sessionName)));</TD></TR><TR><TD CLASS="l">1288</TD><TD>                }</TD></TR><TR><TD CLASS="l">1289</TD><TD>                else</TD></TR><TR><TD CLASS="l">1290</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1291</TD><TD>                        final boolean stateSet = prodData.setState(prodState.sessionName, prodState.productState);</TD></TR><TR CLASS="z"><TD CLASS="l">1292</TD><TD>                        if (logger.isDebugOn())</TD></TR><TR><TD CLASS="l">1293</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1294</TD><TD>                                if (stateSet)</TD></TR><TR><TD CLASS="l">1295</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1296</TD><TD>                                        logger.debug(MsgBuilder.get().add(&#34;Set prod state for &#34;)</TD></TR><TR><TD CLASS="l">1297</TD><TD>                                                        .add(&#34;sess&#34;, prodState.sessionName)</TD></TR><TR><TD CLASS="l">1298</TD><TD>                                                        .add(&#34;prodKey&#34;, prodState.productKeys.productKey).add(&#34;to&#34;)</TD></TR><TR><TD CLASS="l">1299</TD><TD>                                                        .add(&#34;state&#34;, prodState.productState)</TD></TR><TR><TD CLASS="l">1300</TD><TD>                                                        .add(&#34;stateName&#34;, PROD_STATE_MAPPER.getName(prodState.productState, &#34;??&#34;)));</TD></TR><TR><TD CLASS="l">1301</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1302</TD><TD>                                else</TD></TR><TR><TD CLASS="l">1303</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1304</TD><TD>                                        logger.debug(MsgBuilder.get().add(&#34;Ignored prod state &#34;)</TD></TR><TR><TD CLASS="l">1305</TD><TD>                                                        .add(&#34;unsupportedSession&#34;, prodState.sessionName)</TD></TR><TR><TD CLASS="l">1306</TD><TD>                                                        .add(&#34;prodKey&#34;, prodState.productKeys.productKey).add(&#34;to&#34;)</TD></TR><TR><TD CLASS="l">1307</TD><TD>                                                        .add(&#34;state&#34;, prodState.productState)</TD></TR><TR><TD CLASS="l">1308</TD><TD>                                                        .add(&#34;stateName&#34;, PROD_STATE_MAPPER.getName(prodState.productState, &#34;??&#34;)));</TD></TR><TR><TD CLASS="l">1309</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1310</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1311</TD><TD>                        prodData.setStateSeqNum(prodState.sessionName, prodState.productStateTransactionSequenceNumber);</TD></TR><TR><TD CLASS="l">1312</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1313</TD><TD>        }</TD></TR><TR><TD CLASS="l">1314</TD><TD> </TD></TR><TR><TD CLASS="l">1315</TD><TD>        /**</TD></TR><TR><TD CLASS="l"><A NAME="1c">1316</A></TD><TD>         * ProductStatusConsumer method implementation</TD></TR><TR><TD CLASS="l">1317</TD><TD>         */</TD></TR><TR><TD CLASS="l">1318</TD><TD>        public void allAdjustmentsAppliedNotice()</TD></TR><TR><TD CLASS="l">1319</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1320</TD><TD>        }</TD></TR><TR><TD CLASS="l">1321</TD><TD> </TD></TR><TR><TD CLASS="l">1322</TD><TD>        /**</TD></TR><TR><TD CLASS="l"><A NAME="51">1323</A></TD><TD>         * ProductStatusConsumer method implementation</TD></TR><TR><TD CLASS="l">1324</TD><TD>         */</TD></TR><TR><TD CLASS="l">1325</TD><TD>        public void priceAdjustmentAppliedNotice(PendingAdjustmentStruct p_appliedAdjustment)</TD></TR><TR><TD CLASS="l">1326</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1327</TD><TD>        }</TD></TR><TR><TD CLASS="l">1328</TD><TD> </TD></TR><TR><TD CLASS="l">1329</TD><TD>        /**</TD></TR><TR><TD CLASS="l"><A NAME="52">1330</A></TD><TD>         * ProductStatusConsumer method implementation</TD></TR><TR><TD CLASS="l">1331</TD><TD>         */</TD></TR><TR><TD CLASS="l">1332</TD><TD>        public void priceAdjustmentUpdatedNotice(PendingAdjustmentStruct p_updatedAdjustment)</TD></TR><TR><TD CLASS="l">1333</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1334</TD><TD>        }</TD></TR><TR><TD CLASS="l">1335</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="6d">1336</A></TD><TD>        public void updateProduct(</TD></TR><TR><TD CLASS="l">1337</TD><TD>                        final ProductStruct p_updatedProduct,</TD></TR><TR><TD CLASS="l">1338</TD><TD>                        final ProductInformationStruct p_pinfo)</TD></TR><TR><TD CLASS="l">1339</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1340</TD><TD>                updateCachedProd(p_updatedProduct, p_pinfo, (short)-1, null);</TD></TR><TR CLASS="z"><TD CLASS="l">1341</TD><TD>        }</TD></TR><TR><TD CLASS="l">1342</TD><TD> </TD></TR><TR><TD CLASS="l">1343</TD><TD>        private final void updateCachedProd(</TD></TR><TR><TD CLASS="l">1344</TD><TD>                        final ProductStruct p_updatedProduct,</TD></TR><TR><TD CLASS="l"><A NAME="65">1345</A></TD><TD>                        ProductInformationStruct p_pinfo,</TD></TR><TR><TD CLASS="l">1346</TD><TD>                        short p_strategyType,</TD></TR><TR><TD CLASS="l">1347</TD><TD>                        final StrategyLegStruct[] p_strategyLegs)</TD></TR><TR><TD CLASS="l">1348</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1349</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">1350</TD><TD>                logger.info(msg.add(&#34;updateProduct&#34;, p_updatedProduct));</TD></TR><TR CLASS="z"><TD CLASS="l">1351</TD><TD>                msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1352</TD><TD>                final int prodKey = p_updatedProduct.productKeys.productKey;</TD></TR><TR CLASS="z"><TD CLASS="l">1353</TD><TD>                final ProductClassDataImpl classData = allProdClassData.get(p_updatedProduct.productKeys.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1354</TD><TD>                ProductDataImpl prodData = allProdData.get(prodKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1355</TD><TD>                if (p_pinfo==null)</TD></TR><TR CLASS="z"><TD CLASS="l">1356</TD><TD>                        p_pinfo = ProductStructBuilder.buildProductInformationStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1357</TD><TD>                if (prodData == null)</TD></TR><TR><TD CLASS="l">1358</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1359</TD><TD>                        if (classData != null)</TD></TR><TR><TD CLASS="l">1360</TD><TD>                        {</TD></TR><TR><TD CLASS="l">1361</TD><TD>                                try</TD></TR><TR><TD CLASS="l">1362</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1363</TD><TD>                                        addNewProd(classData, prodKey, p_updatedProduct, p_pinfo, p_strategyType, p_strategyLegs);</TD></TR><TR><TD CLASS="l">1364</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">1365</TD><TD>                                catch (SystemException e)</TD></TR><TR><TD CLASS="l">1366</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1367</TD><TD>                                        Log.exception(msg.add(&#34;Failed to add product::&#34;).add(prodKey).end(), e);</TD></TR><TR CLASS="z"><TD CLASS="l">1368</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1369</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1370</TD><TD>                        else</TD></TR><TR><TD CLASS="l">1371</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1372</TD><TD>                                logger.info(msg.add(&#34;Ignoring update for&#34;).add(&#34;product&#34;, prodKey)</TD></TR><TR><TD CLASS="l">1373</TD><TD>                                                .add(&#34; (prod class no in process)&#34;));</TD></TR><TR><TD CLASS="l">1374</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1375</TD><TD>                }</TD></TR><TR><TD CLASS="l">1376</TD><TD>                else</TD></TR><TR><TD CLASS="l">1377</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1378</TD><TD>                        prodData = prodData.update(p_updatedProduct, (short)0, null);</TD></TR><TR CLASS="z"><TD CLASS="l">1379</TD><TD>                        prodData.setRestrictedIndicator(p_pinfo.restrictedIndicator);</TD></TR><TR CLASS="z"><TD CLASS="l">1380</TD><TD>                        allProdData.put(prodKey, prodData);</TD></TR><TR CLASS="z"><TD CLASS="l">1381</TD><TD>                        if (p_strategyLegs != null)</TD></TR><TR><TD CLASS="l">1382</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1383</TD><TD>                                logger.info(msg.add(&#34;product::&#34;).add(prodKey).add(&#34; is a strategy; update strategy portion&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1384</TD><TD>                                updateWithLegInfo(prodData, p_strategyType, p_strategyLegs);</TD></TR><TR><TD CLASS="l">1385</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1386</TD><TD>                }</TD></TR><TR><TD CLASS="l">1387</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1388</TD><TD>                if (prodData != null)</TD></TR><TR><TD CLASS="l">1389</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1390</TD><TD>                        notifyListeners(prodData);</TD></TR><TR CLASS="z"><TD CLASS="l">1391</TD><TD>                        logger.info(msg.add(&#34;Dynamically updated&#34;).add(&#34;product&#34;, prodData.getProductKey()));</TD></TR><TR><TD CLASS="l">1392</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1393</TD><TD>        }</TD></TR><TR><TD CLASS="l">1394</TD><TD> </TD></TR><TR><TD CLASS="l">1395</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1396</TD><TD>         * ProductStatusConsumer method implementation</TD></TR><TR><TD CLASS="l">1397</TD><TD>         * @param p_strategyLegs - the leg struct array.  May be null is not a strategy.</TD></TR><TR><TD CLASS="l">1398</TD><TD>         * @param p_strategyType - the type of strategy (value from StrategyTypes constants or 0 is not a strategy)</TD></TR><TR><TD CLASS="l">1399</TD><TD>         */</TD></TR><TR><TD CLASS="l">1400</TD><TD>        public void updateProduct(</TD></TR><TR><TD CLASS="l"><A NAME="6e">1401</A></TD><TD>                        final ProductStruct p_updatedProduct,</TD></TR><TR><TD CLASS="l">1402</TD><TD>                        short p_strategyType,</TD></TR><TR><TD CLASS="l">1403</TD><TD>                        final StrategyLegStruct[] p_strategyLegs)</TD></TR><TR><TD CLASS="l">1404</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1405</TD><TD>                updateCachedProd(p_updatedProduct, null, p_strategyType, p_strategyLegs);</TD></TR><TR CLASS="z"><TD CLASS="l">1406</TD><TD>        }</TD></TR><TR><TD CLASS="l">1407</TD><TD> </TD></TR><TR><TD CLASS="l">1408</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1409</TD><TD>         * ProductStatusConsumer method implementation</TD></TR><TR><TD CLASS="l"><A NAME="6f">1410</A></TD><TD>         */</TD></TR><TR><TD CLASS="l">1411</TD><TD>        public void updateProductClass(</TD></TR><TR><TD CLASS="l">1412</TD><TD>                        final ProductClassStruct p_updatedClass)</TD></TR><TR><TD CLASS="l">1413</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1414</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">1415</TD><TD>                logger.info(msg.add(&#34;updateProductClass&#34;, p_updatedClass.info));</TD></TR><TR CLASS="z"><TD CLASS="l">1416</TD><TD>                msg.clear();</TD></TR><TR><TD CLASS="l">1417</TD><TD> </TD></TR><TR><TD CLASS="l">1418</TD><TD>                // NOTE: We can't add new prod class yet: we'll need to know if it's in our route group or not.</TD></TR><TR><TD CLASS="l">1419</TD><TD>                //       Another project needs to handle this case.</TD></TR><TR><TD CLASS="l">1420</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1421</TD><TD>                final ProductClassDataImpl classData = allProdClassData.get(p_updatedClass.info.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1422</TD><TD>                if (classData == null)</TD></TR><TR><TD CLASS="l">1423</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1424</TD><TD>                        logger.info(msg.add(&#34;Ignoring update of&#34;).add(&#34;class&#34;, p_updatedClass.info)</TD></TR><TR><TD CLASS="l">1425</TD><TD>                                        .add(&#34;since it is not configured in this process.&#34;));</TD></TR><TR><TD CLASS="l">1426</TD><TD>                }</TD></TR><TR><TD CLASS="l">1427</TD><TD>                else</TD></TR><TR><TD CLASS="l">1428</TD><TD>                {</TD></TR><TR><TD CLASS="l">1429</TD><TD>                        try</TD></TR><TR><TD CLASS="l">1430</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1431</TD><TD>                                updateProdClassCache(classData, p_updatedClass);</TD></TR><TR><TD CLASS="l">1432</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1433</TD><TD>                        catch (SystemException se)</TD></TR><TR><TD CLASS="l">1434</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1435</TD><TD>                                Log.exception(msg.add(&#34;Failed to update class::&#34;).add(classData.getClassKey()).end(), se);</TD></TR><TR CLASS="z"><TD CLASS="l">1436</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1437</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1438</TD><TD>        }</TD></TR><TR><TD CLASS="l">1439</TD><TD> </TD></TR><TR><TD CLASS="l">1440</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1441</TD><TD>         * ProductStatusConsumer method implementation</TD></TR><TR><TD CLASS="l"><A NAME="72">1442</A></TD><TD>         */</TD></TR><TR><TD CLASS="l">1443</TD><TD>        public void updateProductStrategy(</TD></TR><TR><TD CLASS="l">1444</TD><TD>                        final StrategyStruct p_updatedStrategy)</TD></TR><TR><TD CLASS="l">1445</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1446</TD><TD>                updateCachedProd(p_updatedStrategy.product, null, p_updatedStrategy.strategyType, p_updatedStrategy.strategyLegs);</TD></TR><TR CLASS="z"><TD CLASS="l">1447</TD><TD>        }</TD></TR><TR><TD CLASS="l">1448</TD><TD> </TD></TR><TR><TD CLASS="l">1449</TD><TD>        /**</TD></TR><TR><TD CLASS="l"><A NAME="74">1450</A></TD><TD>         * ProductStatusConsumer method implementation</TD></TR><TR><TD CLASS="l">1451</TD><TD>         */</TD></TR><TR><TD CLASS="l">1452</TD><TD>        public void updateQPEIndicator(int p_classKey, boolean p_indicator)</TD></TR><TR><TD CLASS="l">1453</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1454</TD><TD>                final ProductClassDataImpl classData = this.allProdClassData.get(p_classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1455</TD><TD>                if (classData != null)</TD></TR><TR><TD CLASS="l">1456</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1457</TD><TD>            synchronized (new Object()) // synch to flush thread local memory back to main.</TD></TR><TR><TD CLASS="l">1458</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1459</TD><TD>                classData.setRolloutIndicator(p_indicator);</TD></TR><TR CLASS="z"><TD CLASS="l">1460</TD><TD>            }</TD></TR><TR><TD CLASS="l">1461</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1462</TD><TD>                        notifyListeners(classData, null);</TD></TR><TR CLASS="z"><TD CLASS="l">1463</TD><TD>                        logger.info(MsgBuilder.get().add(&#34;Updated rollout indicator&#34;)</TD></TR><TR><TD CLASS="l">1464</TD><TD>                                        .add(&#34;classKey&#34;, p_classKey)</TD></TR><TR><TD CLASS="l">1465</TD><TD>                                        .add(&#34;indicator&#34;, p_indicator));</TD></TR><TR><TD CLASS="l">1466</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1467</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="66">1468</A></TD><TD> </TD></TR><TR><TD CLASS="l">1469</TD><TD>        public void updateLinkageIndicator(</TD></TR><TR><TD CLASS="l">1470</TD><TD>                        final LinkageIndicatorResultStruct[] linkageIndicatorResult)</TD></TR><TR><TD CLASS="l">1471</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1472</TD><TD>                ProductClassDataImpl prodData = null;</TD></TR><TR><TD CLASS="l">1473</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1474</TD><TD>                for (int i =0; i &lt; linkageIndicatorResult.length; i++)</TD></TR><TR><TD CLASS="l">1475</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1476</TD><TD>                        String oldValue = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1477</TD><TD>                        String newValue = null;</TD></TR><TR><TD CLASS="l">1478</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1479</TD><TD>                        prodData = this.allProdClassData.get(linkageIndicatorResult[i].classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1480</TD><TD>                        if (prodData != null)</TD></TR><TR><TD CLASS="l">1481</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1482</TD><TD>                                oldValue = prodData.isLinkageDisabled()?&#34;DISABLED&#34;:&#34;ENABLED&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1483</TD><TD>                                prodData.setLinkageIndicator(linkageIndicatorResult[i].linkageIndicator);</TD></TR><TR CLASS="z"><TD CLASS="l">1484</TD><TD>                                newValue = prodData.isLinkageDisabled()?&#34;DISABLE&#34;:&#34;ENABLE&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1485</TD><TD>                                notifyListeners(prodData, null);</TD></TR><TR CLASS="z"><TD CLASS="l">1486</TD><TD>                                logger.info(MsgBuilder.get().add(&#34;Updated LinkageIndicator indicator&#34;)</TD></TR><TR><TD CLASS="l">1487</TD><TD>                                                .add(&#34;classKey&#34;, linkageIndicatorResult[i].classKey)</TD></TR><TR><TD CLASS="l">1488</TD><TD>                                                .add(&#34;linkage Indicator Old= &#34;, oldValue)</TD></TR><TR><TD CLASS="l">1489</TD><TD>                                                .add(&#34;linkage Indicator New=&#34;,newValue));</TD></TR><TR><TD CLASS="l">1490</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1491</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1492</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="70">1493</A></TD><TD> </TD></TR><TR><TD CLASS="l">1494</TD><TD>        public void updateProductClassV3(</TD></TR><TR><TD CLASS="l">1495</TD><TD>                        final ProductClassStructV3 updatedClass)</TD></TR><TR><TD CLASS="l">1496</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1497</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">1498</TD><TD>                logger.info(msg.add(&#34;updateProductClassV3&#34;, updatedClass.info));</TD></TR><TR CLASS="z"><TD CLASS="l">1499</TD><TD>                msg.clear();</TD></TR><TR><TD CLASS="l">1500</TD><TD> </TD></TR><TR><TD CLASS="l">1501</TD><TD>                // NOTE: We can't add new prod class yet: we'll need to know if it's in our route group or not.</TD></TR><TR><TD CLASS="l">1502</TD><TD>                //       Another project needs to handle this case.</TD></TR><TR><TD CLASS="l">1503</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1504</TD><TD>                final ProductClassDataImpl classData = allProdClassData.get(updatedClass.info.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1505</TD><TD>                if (classData == null)</TD></TR><TR><TD CLASS="l">1506</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1507</TD><TD>                        logger.info(msg.add(&#34;Ignoring update of&#34;).add(&#34;class&#34;, updatedClass.info)</TD></TR><TR><TD CLASS="l">1508</TD><TD>                                        .add(&#34;since it is not configured in this process.&#34;));</TD></TR><TR><TD CLASS="l">1509</TD><TD>                }</TD></TR><TR><TD CLASS="l">1510</TD><TD>                else</TD></TR><TR><TD CLASS="l">1511</TD><TD>                {</TD></TR><TR><TD CLASS="l">1512</TD><TD>                        try</TD></TR><TR><TD CLASS="l">1513</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1514</TD><TD>                                updateProdClassCache(classData, updatedClass);</TD></TR><TR><TD CLASS="l">1515</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1516</TD><TD>                        catch (SystemException se)</TD></TR><TR><TD CLASS="l">1517</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1518</TD><TD>                                Log.exception(msg.add(&#34;Failed to update class::&#34;).add(classData.getClassKey()).end(), se);</TD></TR><TR CLASS="z"><TD CLASS="l">1519</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1520</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1521</TD><TD>        }</TD></TR><TR><TD CLASS="l">1522</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="73">1523</A></TD><TD>        public void updateProductV4(</TD></TR><TR><TD CLASS="l">1524</TD><TD>                        final ProductStructV4 updatedProduct)</TD></TR><TR><TD CLASS="l">1525</TD><TD>        {</TD></TR><TR><TD CLASS="l">1526</TD><TD>                //TODO to be implemented on OHS:EOD/REPORTING</TD></TR><TR CLASS="z"><TD CLASS="l">1527</TD><TD>        }</TD></TR><TR><TD CLASS="l">1528</TD><TD> </TD></TR><TR><TD CLASS="l">1529</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1530</TD><TD>         * ProductStatusConsumer method implementation</TD></TR><TR><TD CLASS="l">1531</TD><TD>         * TODO: Do we need to check if the prodClassKey is in our classKeys?</TD></TR><TR><TD CLASS="l"><A NAME="75">1532</A></TD><TD>         */</TD></TR><TR><TD CLASS="l">1533</TD><TD>        public void updateReportingClass(</TD></TR><TR><TD CLASS="l">1534</TD><TD>                        final ReportingClassStruct p_updatedClass)</TD></TR><TR><TD CLASS="l">1535</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1536</TD><TD>                if (p_updatedClass==null)</TD></TR><TR CLASS="z"><TD CLASS="l">1537</TD><TD>                        return;</TD></TR><TR CLASS="z"><TD CLASS="l">1538</TD><TD>                IntHashMap&lt;ReportingClassDataImpl&gt; newMap = updateRptClassCacheWithAddition(new ReportingClassStruct[] {p_updatedClass});</TD></TR><TR CLASS="z"><TD CLASS="l">1539</TD><TD>                if (newMap==null)</TD></TR><TR CLASS="z"><TD CLASS="l">1540</TD><TD>                        return;</TD></TR><TR CLASS="z"><TD CLASS="l">1541</TD><TD>                updateRptClassCache(newMap, new ReportingClassStruct[] {p_updatedClass});</TD></TR><TR CLASS="z"><TD CLASS="l">1542</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="77">1543</A></TD><TD> </TD></TR><TR><TD CLASS="l">1544</TD><TD>        private final IntHashMap&lt;ReportingClassDataImpl&gt; updateRptClassCacheWithAddition(</TD></TR><TR><TD CLASS="l">1545</TD><TD>                        final ReportingClassStruct[] p_updatedClasses)</TD></TR><TR><TD CLASS="l">1546</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1547</TD><TD>                if (p_updatedClasses==null || p_updatedClasses.length==0)</TD></TR><TR CLASS="z"><TD CLASS="l">1548</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">1549</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1550</TD><TD>            createRptClassCacheStruct(allReportingClassData, p_updatedClasses);</TD></TR><TR><TD CLASS="l">1551</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1552</TD><TD>            return allReportingClassData;</TD></TR><TR><TD CLASS="l">1553</TD><TD>        }</TD></TR><TR><TD CLASS="l">1554</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2e">1555</A></TD><TD>        private void createRptClassCacheStruct(</TD></TR><TR><TD CLASS="l">1556</TD><TD>                        final IntHashMap&lt;ReportingClassDataImpl&gt; rptMap,</TD></TR><TR><TD CLASS="l">1557</TD><TD>                        final ReportingClassStruct[] p_updatedClasses)</TD></TR><TR><TD CLASS="l">1558</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1559</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">1560</TD><TD>                for (ReportingClassStruct p_updatedClass : p_updatedClasses)</TD></TR><TR><TD CLASS="l">1561</TD><TD>                {</TD></TR><TR><TD CLASS="l">1562</TD><TD>                    //rpt class data is immutable and non-changeable intraday, if exists, pass</TD></TR><TR><TD CLASS="l">1563</TD><TD>                    /**</TD></TR><TR><TD CLASS="l">1564</TD><TD>                    if (allReportingClassData.containsKey(p_updatedClass.classKey))</TD></TR><TR><TD CLASS="l">1565</TD><TD>                        continue;</TD></TR><TR><TD CLASS="l">1566</TD><TD>                */   </TD></TR><TR CLASS="z"><TD CLASS="l">1567</TD><TD>                        ReportingClassDataImpl temp = new ReportingClassDataImpl(p_updatedClass);</TD></TR><TR CLASS="z"><TD CLASS="l">1568</TD><TD>                        rptMap.put(p_updatedClass.classKey, temp);</TD></TR><TR CLASS="z"><TD CLASS="l">1569</TD><TD>                        logger.debug(msg.add(&#34;Dynamically added reporting class &#34;)</TD></TR><TR><TD CLASS="l">1570</TD><TD>                                        .add(&#34;[key:symbol]=&#34;, p_updatedClass.classKey)</TD></TR><TR><TD CLASS="l">1571</TD><TD>                                        .add(&#34;:&#34;).add(p_updatedClass.reportingClassSymbol));</TD></TR><TR CLASS="z"><TD CLASS="l">1572</TD><TD>            msg.clear();</TD></TR><TR><TD CLASS="l">1573</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1574</TD><TD>        }</TD></TR><TR><TD CLASS="l">1575</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="76">1576</A></TD><TD>        private final void updateRptClassCache(</TD></TR><TR><TD CLASS="l">1577</TD><TD>                        final IntHashMap&lt;ReportingClassDataImpl&gt; newMap,</TD></TR><TR><TD CLASS="l">1578</TD><TD>                        final ReportingClassStruct[] p_updatedClasses)</TD></TR><TR><TD CLASS="l">1579</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1580</TD><TD>                this.allReportingClassData = newMap;</TD></TR><TR CLASS="z"><TD CLASS="l">1581</TD><TD>                for (ReportingClassStruct updated : p_updatedClasses)</TD></TR><TR><TD CLASS="l">1582</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1583</TD><TD>                        notifyListeners(newMap.get(updated.classKey));</TD></TR><TR><TD CLASS="l">1584</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3b">1585</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">1586</TD><TD> </TD></TR><TR><TD CLASS="l">1587</TD><TD>        private final Set&lt;String&gt; getAllSessionNamesForCache()</TD></TR><TR><TD CLASS="l">1588</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1589</TD><TD>            return allSessionsForCache;</TD></TR><TR><TD CLASS="l">1590</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="3a">1591</A></TD><TD> </TD></TR><TR><TD CLASS="l">1592</TD><TD>        //This method returns the Consolidated list of Classes  for the configured OHServer</TD></TR><TR><TD CLASS="l">1593</TD><TD>        public Integer[] getAllClassKeys()</TD></TR><TR><TD CLASS="l">1594</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1595</TD><TD>                return classKeys.toArray(new Integer[classKeys.size()]);</TD></TR><TR><TD CLASS="l">1596</TD><TD>        }</TD></TR><TR><TD CLASS="l">1597</TD><TD> </TD></TR><TR><TD CLASS="l">1598</TD><TD>        ///////////////////////////////////////////////////////////////</TD></TR><TR><TD CLASS="l">1599</TD><TD>        //</TD></TR><TR><TD CLASS="l">1600</TD><TD>        // Download data from Global services:</TD></TR><TR><TD CLASS="l"><A NAME="3e">1601</A></TD><TD>        //</TD></TR><TR><TD CLASS="l">1602</TD><TD> </TD></TR><TR><TD CLASS="l">1603</TD><TD>        public Exception[] getDownloadException()</TD></TR><TR><TD CLASS="l">1604</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1605</TD><TD>                return downloadException;</TD></TR><TR><TD CLASS="l">1606</TD><TD>        }</TD></TR><TR><TD CLASS="l">1607</TD><TD>        </TD></TR><TR><TD CLASS="l"><A NAME="31">1608</A></TD><TD>        protected void downloadSpreadNormalizationStrategy()throws FatalFoundationFrameworkException</TD></TR><TR><TD CLASS="l">1609</TD><TD>        {</TD></TR><TR><TD CLASS="l">1610</TD><TD>            try</TD></TR><TR><TD CLASS="l">1611</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1612</TD><TD>                spreadNormalizationStrategyType = this.pqs.getSpreadNormalizationStrategyType();</TD></TR><TR><TD CLASS="l">1613</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1614</TD><TD>            catch(Exception e)</TD></TR><TR><TD CLASS="l">1615</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1616</TD><TD>                throw new FatalFoundationFrameworkException(e, &#34;Failed SpreadNormalizationStrategyType download&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1617</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="30">1618</A></TD><TD>        }    </TD></TR><TR><TD CLASS="l">1619</TD><TD> </TD></TR><TR><TD CLASS="l">1620</TD><TD>        public void downloadPCSGroup() throws FatalFoundationFrameworkException</TD></TR><TR><TD CLASS="l">1621</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1622</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">1623</TD><TD>                linkageIRSS = new IntHashMap&lt;LinkageIndicatorResultStruct&gt;(allProdClassData.size());</TD></TR><TR CLASS="z"><TD CLASS="l">1624</TD><TD>                logger.info(msg.add(&#34;Downloading PCS class keys for&#34;)</TD></TR><TR><TD CLASS="l">1625</TD><TD>                                .add(&#34;groups&#34;, groupNames));</TD></TR><TR CLASS="z"><TD CLASS="l">1626</TD><TD>                msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1627</TD><TD>                for (String grpName : groupNames)</TD></TR><TR><TD CLASS="l">1628</TD><TD>                {</TD></TR><TR><TD CLASS="l">1629</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">1630</TD><TD>                        logger.info(msg.add(&#34;  Downloading PCS class keys for&#34;)</TD></TR><TR><TD CLASS="l">1631</TD><TD>                                        .add(&#34;group&#34;, grpName));</TD></TR><TR CLASS="z"><TD CLASS="l">1632</TD><TD>                        msg.clear();</TD></TR><TR><TD CLASS="l">1633</TD><TD> </TD></TR><TR><TD CLASS="l">1634</TD><TD>                        int[] pcsKeys;</TD></TR><TR><TD CLASS="l">1635</TD><TD>                        try</TD></TR><TR><TD CLASS="l">1636</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1637</TD><TD>                                pcsKeys = pcs.getProductClassesForGroup(grpName);</TD></TR><TR CLASS="z"><TD CLASS="l">1638</TD><TD>                                classKeys.ensureCapacity(classKeys.size()+pcsKeys.length);</TD></TR><TR CLASS="z"><TD CLASS="l">1639</TD><TD>                                for (int key : pcsKeys)</TD></TR><TR><TD CLASS="l">1640</TD><TD>                                {</TD></TR><TR><TD CLASS="l">1641</TD><TD>                                    </TD></TR><TR CLASS="z"><TD CLASS="l">1642</TD><TD>                                        classKeys.add(key);</TD></TR><TR CLASS="z"><TD CLASS="l">1643</TD><TD>                                        msg.add(key).add(&#34;,&#34;);</TD></TR><TR><TD CLASS="l">1644</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1645</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1646</TD><TD>                                msg.newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">1647</TD><TD>                                msg.add(&#34;Got &#34;).add(pcsKeys.length)</TD></TR><TR><TD CLASS="l">1648</TD><TD>                                   .add(&#34; PCS class keys for&#34;)</TD></TR><TR><TD CLASS="l">1649</TD><TD>                                   .add(&#34;group&#34;, grpName);</TD></TR><TR CLASS="z"><TD CLASS="l">1650</TD><TD>                                logger.info(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1651</TD><TD>                msg.clear();</TD></TR><TR><TD CLASS="l">1652</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">1653</TD><TD>                                LinkageIndicatorResultStruct[] linkageIndPerGroup =  pms.getLinkageIndicators(OHS,SESSION,pcsKeys);</TD></TR><TR CLASS="z"><TD CLASS="l">1654</TD><TD>                                msg.add(&#34;Got &#34;).add(linkageIndPerGroup.length)</TD></TR><TR><TD CLASS="l">1655</TD><TD>                                   .add(&#34; linkage indicator class keys for&#34;)</TD></TR><TR><TD CLASS="l">1656</TD><TD>                                   .add(&#34;group&#34;, grpName);</TD></TR><TR CLASS="z"><TD CLASS="l">1657</TD><TD>                                logger.info(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1658</TD><TD>                                msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1659</TD><TD>                for (LinkageIndicatorResultStruct linkageIRS : linkageIndPerGroup)</TD></TR><TR><TD CLASS="l">1660</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1661</TD><TD>                        LinkageIndicatorResultStruct prevVal = linkageIRSS.put(linkageIRS.classKey, linkageIRS);</TD></TR><TR CLASS="z"><TD CLASS="l">1662</TD><TD>                        if (prevVal != null)</TD></TR><TR><TD CLASS="l">1663</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1664</TD><TD>                                logger.info(MsgBuilder.get().add(&#34;Linkage indicator for class &#34;)</TD></TR><TR><TD CLASS="l">1665</TD><TD>                                                .add(linkageIRS.classKey).add(&#34; occurs more than once: using most recent value.&#34;)</TD></TR><TR><TD CLASS="l">1666</TD><TD>                                                .add(&#34;prevValSess&#34;, prevVal.sessionName).add(&#34;currValSess&#34;, linkageIRS.sessionName));</TD></TR><TR><TD CLASS="l">1667</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1668</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1669</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1670</TD><TD>                        catch (Exception ex)</TD></TR><TR><TD CLASS="l">1671</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1672</TD><TD>                                throw new FatalFoundationFrameworkException(ex, &#34;Failed PCS download&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1673</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1674</TD><TD>                        this.classKeysByGroup.put(grpName, pcsKeys);</TD></TR><TR CLASS="z"><TD CLASS="l">1675</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1676</TD><TD>                msg.add(&#34;Downloaded total &#34;).add(linkageIRSS.keySet().size()).add(&#34; linkage indicators.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1677</TD><TD>                msg.newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">1678</TD><TD>                msg.add(&#34;Downloaded total &#34;).add(classKeys.size()).add(&#34; classes.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1679</TD><TD>                logger.info(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1680</TD><TD>        }</TD></TR><TR><TD CLASS="l">1681</TD><TD> </TD></TR><TR><TD CLASS="l">1682</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1683</TD><TD>         * Wait for the PQS / TSS download to complete.</TD></TR><TR><TD CLASS="l"><A NAME="7c">1684</A></TD><TD>         * @return The exception that caused the download to abort.  (null indicates success)</TD></TR><TR><TD CLASS="l">1685</TD><TD>         */</TD></TR><TR><TD CLASS="l">1686</TD><TD>        public Exception[] waitForDownloadToComplete()</TD></TR><TR><TD CLASS="l">1687</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1688</TD><TD>                if (!downloadStarted)</TD></TR><TR><TD CLASS="l">1689</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1690</TD><TD>                        if (isDownloaded==-1)</TD></TR><TR CLASS="z"><TD CLASS="l">1691</TD><TD>                                startDataDownload();</TD></TR><TR><TD CLASS="l">1692</TD><TD>                        else</TD></TR><TR CLASS="z"><TD CLASS="l">1693</TD><TD>                                return downloadException;</TD></TR><TR><TD CLASS="l">1694</TD><TD>                }</TD></TR><TR><TD CLASS="l">1695</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">1696</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR><TD CLASS="l">1697</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1698</TD><TD>                while (downloadStarted &amp;&amp; isDownloaded&gt;0)</TD></TR><TR><TD CLASS="l">1699</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1700</TD><TD>                        logger.info(msg.add(&#34;Waiting for PDS download to complete, &#34;).add(isDownloaded).add(&#34; Threads are yest to complete&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1701</TD><TD>                        msg.clear();</TD></TR><TR><TD CLASS="l">1702</TD><TD>                        try</TD></TR><TR><TD CLASS="l">1703</TD><TD>                        {</TD></TR><TR><TD CLASS="l">1704</TD><TD>                                // bizarre-wait-case avoidance: wake up every second and recheck</TD></TR><TR CLASS="z"><TD CLASS="l">1705</TD><TD>                                Thread.sleep(1000);</TD></TR><TR><TD CLASS="l">1706</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1707</TD><TD>                        catch (InterruptedException e)</TD></TR><TR><TD CLASS="l">1708</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1709</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1710</TD><TD>                }</TD></TR><TR><TD CLASS="l">1711</TD><TD>                // isDownloaded==0</TD></TR><TR><TD CLASS="l">1712</TD><TD>                // (%99.999 percent of the time, isDownloaded will be true)</TD></TR><TR CLASS="z"><TD CLASS="l">1713</TD><TD>                logger.info(msg.add(&#34;All PDS download threads have completed downloading, and hasException=&#34;).add(hasDownloadException));</TD></TR><TR CLASS="z"><TD CLASS="l">1714</TD><TD>                downloadStarted = false;</TD></TR><TR CLASS="z"><TD CLASS="l">1715</TD><TD>                isDownloaded = -2;</TD></TR><TR CLASS="z"><TD CLASS="l">1716</TD><TD>                return downloadException;</TD></TR><TR><TD CLASS="l">1717</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="64">1718</A></TD><TD> </TD></TR><TR><TD CLASS="l">1719</TD><TD> </TD></TR><TR><TD CLASS="l">1720</TD><TD>        public synchronized void startDataDownload()</TD></TR><TR><TD CLASS="l">1721</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1722</TD><TD>                if (downloadStarted)</TD></TR><TR><TD CLASS="l">1723</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1724</TD><TD>                        logger.info(MsgBuilder.get()</TD></TR><TR><TD CLASS="l">1725</TD><TD>                                        .add(&#34;Ignoring call to startDataDownload: download has already been started.&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1726</TD><TD>                        return;</TD></TR><TR><TD CLASS="l">1727</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1728</TD><TD>                isDownloaded = DOWNLOAD_PDS_THREAD_COUNT;</TD></TR><TR CLASS="z"><TD CLASS="l">1729</TD><TD>                downloadStarted = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1730</TD><TD>                hasDownloadException = false;</TD></TR><TR CLASS="z"><TD CLASS="l">1731</TD><TD>                downloadException = new Exception[DOWNLOAD_PDS_THREAD_COUNT];</TD></TR><TR CLASS="z"><TD CLASS="l">1732</TD><TD>                clearCache();</TD></TR><TR CLASS="z"><TD CLASS="l">1733</TD><TD>                downloadSpreadNormalizationStrategy();</TD></TR><TR CLASS="z"><TD CLASS="l">1734</TD><TD>                downloadPCSGroup();</TD></TR><TR CLASS="z"><TD CLASS="l">1735</TD><TD>                downLoadAdditionalClassesAndSessions();</TD></TR><TR CLASS="z"><TD CLASS="l">1736</TD><TD>                logger.info(MsgBuilder.get()</TD></TR><TR><TD CLASS="l">1737</TD><TD>                                .add(&#34;Start download total of &#34;)</TD></TR><TR><TD CLASS="l">1738</TD><TD>                                .add(classKeys.size())</TD></TR><TR><TD CLASS="l">1739</TD><TD>                                .add(&#34; trading classes via &#34;)</TD></TR><TR><TD CLASS="l">1740</TD><TD>                                .add(DOWNLOAD_PDS_THREAD_COUNT)</TD></TR><TR><TD CLASS="l">1741</TD><TD>                                .add(&#34; Threads&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1742</TD><TD>                for (int i=0; i&lt;DOWNLOAD_PDS_THREAD_COUNT; i++)</TD></TR><TR><TD CLASS="l">1743</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1744</TD><TD>                        new ProductDataDownload(i).start();</TD></TR><TR><TD CLASS="l">1745</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="25">1746</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">1747</TD><TD> </TD></TR><TR><TD CLASS="l">1748</TD><TD>        private final void clearCache()</TD></TR><TR><TD CLASS="l">1749</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1750</TD><TD>                classKeysByGroup.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1751</TD><TD>                allProdClassData.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1752</TD><TD>                allReportingClassData.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1753</TD><TD>                allProdData.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1754</TD><TD>                allClassSessionNames.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1755</TD><TD>                associatedStrategiesPerProduct.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1756</TD><TD>                allClassUnderlyingSessionNames.clear();</TD></TR><TR><TD CLASS="l">1757</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1758</TD><TD>                productUpdateListeners.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1759</TD><TD>                reportingClassUpdateListeners.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1760</TD><TD>                productClassUpdateListeners.clear();</TD></TR><TR><TD CLASS="l">1761</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">1762</TD><TD>                badProdKeyTimeout.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1763</TD><TD>                badClassKeyTimeout.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1764</TD><TD>        }</TD></TR><TR><TD CLASS="l">1765</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="84">1766</A></TD><TD>        private class ProductDataDownload extends Thread</TD></TR><TR><TD CLASS="l">1767</TD><TD>        {</TD></TR><TR><TD CLASS="l">1768</TD><TD>                private final int hashCode;</TD></TR><TR><TD CLASS="l">1769</TD><TD>                public ProductDataDownload(int hashCode)</TD></TR><TR CLASS="z"><TD CLASS="l">1770</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1771</TD><TD>                        super(&#34;ProductDataDownload&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1772</TD><TD>                        this.hashCode = hashCode;</TD></TR><TR CLASS="z"><TD CLASS="l">1773</TD><TD>                }</TD></TR><TR><TD CLASS="l"><A NAME="87">1774</A></TD><TD> </TD></TR><TR><TD CLASS="l">1775</TD><TD>                @Override</TD></TR><TR><TD CLASS="l">1776</TD><TD>                public void run()</TD></TR><TR><TD CLASS="l">1777</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1778</TD><TD>                        MsgBuilder msg = MsgBuilder.get();</TD></TR><TR><TD CLASS="l">1779</TD><TD>                        try</TD></TR><TR><TD CLASS="l">1780</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1781</TD><TD>                                if (hasDownloadException)</TD></TR><TR><TD CLASS="l">1782</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1783</TD><TD>                                        logger.info(msg.add(&#34;Thread[&#34;).add(hashCode).add(&#34;] Skipping download: Exception has occured on other threads!&#34;));</TD></TR><TR><TD CLASS="l">1784</TD><TD>                                        return;</TD></TR><TR><TD CLASS="l">1785</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">1786</TD><TD>                                downloadException[hashCode] = null;</TD></TR><TR><TD CLASS="l">1787</TD><TD>                                try</TD></TR><TR><TD CLASS="l">1788</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1789</TD><TD>                                        downloadProducts(hashCode);</TD></TR><TR><TD CLASS="l">1790</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">1791</TD><TD>                                catch (Exception ex)</TD></TR><TR><TD CLASS="l">1792</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1793</TD><TD>                                        hasDownloadException=true;</TD></TR><TR CLASS="z"><TD CLASS="l">1794</TD><TD>                                        downloadException[hashCode] = ex;</TD></TR><TR CLASS="z"><TD CLASS="l">1795</TD><TD>                                        Log.exception(msg.add(&#34;Exception occured on Thread[&#34;).add(hashCode).add(&#34;], abort whole download&#34;).end(), ex);</TD></TR><TR CLASS="z"><TD CLASS="l">1796</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1797</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1798</TD><TD>                                logger.info(msg.add(&#34;Thread[&#34;).add(hashCode).add(&#34;] exiting run()&#34;));</TD></TR><TR><TD CLASS="l">1799</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1800</TD><TD>                        finally</TD></TR><TR><TD CLASS="l">1801</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1802</TD><TD>                                synchronized(ProductDataDownload.class)</TD></TR><TR><TD CLASS="l">1803</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1804</TD><TD>                                        if (isDownloaded &gt; 0)</TD></TR><TR CLASS="z"><TD CLASS="l">1805</TD><TD>                                                isDownloaded--;</TD></TR><TR CLASS="z"><TD CLASS="l">1806</TD><TD>                                        if (isDownloaded==0)</TD></TR><TR CLASS="z"><TD CLASS="l">1807</TD><TD>                                                logger.info(msg.add(&#34;All PDS download threads have completed downloading, and hasException=&#34;).add(hasDownloadException));</TD></TR><TR CLASS="z"><TD CLASS="l">1808</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">1809</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1810</TD><TD>                }</TD></TR><TR><TD CLASS="l"><A NAME="86">1811</A></TD><TD> </TD></TR><TR><TD CLASS="l">1812</TD><TD>                private void downloadProducts(int hashCode)</TD></TR><TR><TD CLASS="l">1813</TD><TD>                throws Exception</TD></TR><TR><TD CLASS="l">1814</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1815</TD><TD>                        MsgBuilder msg = MsgBuilder.get().add(&#34;Thread[&#34;).add(hashCode).add(&#34;] ProductDownload: &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1816</TD><TD>                        msg.add(&#34;PQS product download started&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1817</TD><TD>                        final long msStart = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">1818</TD><TD>                        logger.info(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1819</TD><TD>                        msg.clear();</TD></TR><TR><TD CLASS="l">1820</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1821</TD><TD>                        final int numClasses = classKeys.size();</TD></TR><TR><TD CLASS="l">1822</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">1823</TD><TD>                        int prevLogEveryN = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1824</TD><TD>                        int classCount = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1825</TD><TD>                        final IntHashMap&lt;ReportingClassDataImpl&gt; newRptClassMap = new IntHashMap&lt;ReportingClassDataImpl&gt;(8000);</TD></TR><TR CLASS="z"><TD CLASS="l">1826</TD><TD>                        final ConcurrentIntHashMap&lt;ProductDataImpl&gt; newProdMap = new ConcurrentIntHashMap&lt;ProductDataImpl&gt;(10007);</TD></TR><TR CLASS="z"><TD CLASS="l">1827</TD><TD>                        final IntHashMap&lt;ProductClassDataImpl&gt; newClassMap = new IntHashMap&lt;ProductClassDataImpl&gt;(8000);</TD></TR><TR CLASS="z"><TD CLASS="l">1828</TD><TD>                        final IntHashMap&lt;ProductClassStructV3&gt; newClassRaw = new IntHashMap&lt;ProductClassStructV3&gt;(8000);</TD></TR><TR><TD CLASS="l">1829</TD><TD> </TD></TR><TR><TD CLASS="l">1830</TD><TD>                        ProductClassStructV3 prodClassStruct;</TD></TR><TR CLASS="z"><TD CLASS="l">1831</TD><TD>                        for (int classKey : classKeys)</TD></TR><TR><TD CLASS="l">1832</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1833</TD><TD>                                if (hasDownloadException)</TD></TR><TR><TD CLASS="l">1834</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1835</TD><TD>                                        msg.add(&#34;Abort Thread[&#34;).add(hashCode).add(&#34;] of PDS download due to exceptions on other threads&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1836</TD><TD>                                        logger.alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1837</TD><TD>                                        msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1838</TD><TD>                                        break;</TD></TR><TR><TD CLASS="l">1839</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">1840</TD><TD>                                if (classKey % DOWNLOAD_PDS_THREAD_COUNT != hashCode)</TD></TR><TR CLASS="z"><TD CLASS="l">1841</TD><TD>                                        continue;</TD></TR><TR><TD CLASS="l">1842</TD><TD>                                </TD></TR><TR><TD CLASS="l">1843</TD><TD>                                try</TD></TR><TR><TD CLASS="l">1844</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1845</TD><TD>                                        prodClassStruct = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1846</TD><TD>                                        prodClassStruct = initCacheForClassDownload(</TD></TR><TR><TD CLASS="l">1847</TD><TD>                                                        classKey,</TD></TR><TR><TD CLASS="l">1848</TD><TD>                                                        newClassMap,</TD></TR><TR><TD CLASS="l">1849</TD><TD>                                                        newClassRaw,</TD></TR><TR><TD CLASS="l">1850</TD><TD>                                                        newRptClassMap,</TD></TR><TR><TD CLASS="l">1851</TD><TD>                                                        newProdMap,</TD></TR><TR><TD CLASS="l">1852</TD><TD>                                                        true);</TD></TR><TR CLASS="z"><TD CLASS="l">1853</TD><TD>                                } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1854</TD><TD>                                        msg.add(&#34;FAILED on&#34;).add(&#34;classKey&#34;, classKey).add(e.getMessage());</TD></TR><TR CLASS="z"><TD CLASS="l">1855</TD><TD>                                        Log.exception(msg.end(), e);</TD></TR><TR CLASS="z"><TD CLASS="l">1856</TD><TD>                                        throw e;</TD></TR><TR CLASS="z"><TD CLASS="l">1857</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1858</TD><TD>                                </TD></TR><TR CLASS="z"><TD CLASS="l">1859</TD><TD>                                if (prodClassStruct == null)</TD></TR><TR><TD CLASS="l">1860</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1861</TD><TD>                                        msg.add(&#34;FAILED on&#34;).add(&#34;classKey&#34;, classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1862</TD><TD>                                        logger.alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1863</TD><TD>                                        throw ExceptionBuilder.systemException(msg.end(), 0);</TD></TR><TR><TD CLASS="l">1864</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1865</TD><TD> </TD></TR><TR><TD CLASS="l">1866</TD><TD>                                // It's important in increment classCount *here*: after array indexing, but before</TD></TR><TR><TD CLASS="l">1867</TD><TD>                                // percentage calculations.</TD></TR><TR><TD CLASS="l">1868</TD><TD>                                //</TD></TR><TR CLASS="z"><TD CLASS="l">1869</TD><TD>                                classCount++;</TD></TR><TR><TD CLASS="l">1870</TD><TD>                                /**</TD></TR><TR><TD CLASS="l">1871</TD><TD>                                msg.add(&#34;finished download class::&#34;).add(classKey).add(&#34; with &#34;).add(newClassMap.get(classKey).getProductKeys().length).add(&#34; products&#34;).add(&#34;\n&#34;);</TD></TR><TR><TD CLASS="l">1872</TD><TD>                                logger.info(msg);</TD></TR><TR><TD CLASS="l">1873</TD><TD>                                msg.clear();</TD></TR><TR><TD CLASS="l">1874</TD><TD>                                */</TD></TR><TR CLASS="z"><TD CLASS="l">1875</TD><TD>                                int percentComplete = (100*(classCount)) / numClasses;</TD></TR><TR CLASS="z"><TD CLASS="l">1876</TD><TD>                                int nPercent = percentComplete/LOG_EVERY_N_PERCENT;</TD></TR><TR CLASS="z"><TD CLASS="l">1877</TD><TD>                                if (nPercent != prevLogEveryN)</TD></TR><TR><TD CLASS="l">1878</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1879</TD><TD>                                        msg.add(&#34;Thread[&#34;).add(hashCode).add(&#34;] Product Download: &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1880</TD><TD>                                        msg.add(&#34;PQS product classes downloaded: &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1881</TD><TD>                                        msg.add(&#34;count&#34;, classCount);</TD></TR><TR CLASS="z"><TD CLASS="l">1882</TD><TD>                                        msg.add(&#34;%complete&#34;, percentComplete);</TD></TR><TR CLASS="z"><TD CLASS="l">1883</TD><TD>                                        logger.info(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1884</TD><TD>                                        msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1885</TD><TD>                                        prevLogEveryN = nPercent;</TD></TR><TR><TD CLASS="l">1886</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">1887</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1888</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1889</TD><TD>                        if (classCount &gt; 0 &amp;&amp; !hasDownloadException)</TD></TR><TR><TD CLASS="l">1890</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1891</TD><TD>                                synchronized(ProductDataCacheImpl.this)</TD></TR><TR><TD CLASS="l">1892</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1893</TD><TD>                                        allProdClassData.putAll(newClassMap);</TD></TR><TR CLASS="z"><TD CLASS="l">1894</TD><TD>                                        allReportingClassData.putAll(newRptClassMap);</TD></TR><TR CLASS="z"><TD CLASS="l">1895</TD><TD>                                        allProdData.putAll(newProdMap);</TD></TR><TR CLASS="z"><TD CLASS="l">1896</TD><TD>                                        for (ProductClassDataImpl prodClass : newClassMap.values())</TD></TR><TR><TD CLASS="l">1897</TD><TD>                                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1898</TD><TD>                                                if (prodClass.isLinkageDisabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1899</TD><TD>                                                        linkageDisabledCount++;</TD></TR><TR><TD CLASS="l">1900</TD><TD>                                                }</TD></TR><TR><TD CLASS="l">1901</TD><TD>                                                /**</TD></TR><TR><TD CLASS="l">1902</TD><TD>                                                msg.add(&#34;merged into prod cache -- class::&#34;).add(prodClass.getClassKey()).add(&#34; with &#34;).add(prodClass.getProductKeys().length).add(&#34; products&#34;);</TD></TR><TR><TD CLASS="l">1903</TD><TD>                                                logger.info(msg);</TD></TR><TR><TD CLASS="l">1904</TD><TD>                                                msg.clear();</TD></TR><TR><TD CLASS="l">1905</TD><TD>                                                */</TD></TR><TR CLASS="z"><TD CLASS="l">1906</TD><TD>                                                notifyListeners(prodClass, null);</TD></TR><TR><TD CLASS="l">1907</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1908</TD><TD>                                                ProductClassStructV3 raw = newClassRaw.get(prodClass.getClassKey());</TD></TR><TR CLASS="z"><TD CLASS="l">1909</TD><TD>                                                for (ReportingClassStruct updated : raw.info.reportingClasses)</TD></TR><TR><TD CLASS="l">1910</TD><TD>                                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1911</TD><TD>                                                        notifyListeners(newRptClassMap.get(updated.classKey));</TD></TR><TR><TD CLASS="l">1912</TD><TD>                                                }</TD></TR><TR CLASS="z"><TD CLASS="l">1913</TD><TD>                                                for (ProductStructV4 updated : raw.products)</TD></TR><TR><TD CLASS="l">1914</TD><TD>                                                {</TD></TR><TR CLASS="z"><TD CLASS="l">1915</TD><TD>                                                        notifyListeners(newProdMap.get(updated.product.productKeys.productKey));</TD></TR><TR><TD CLASS="l">1916</TD><TD>                                                }</TD></TR><TR CLASS="z"><TD CLASS="l">1917</TD><TD>                                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1918</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1919</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1920</TD><TD> </TD></TR><TR><TD CLASS="l">1921</TD><TD>                        // populate</TD></TR><TR CLASS="z"><TD CLASS="l">1922</TD><TD>                        final long msElapsed = System.currentTimeMillis() - msStart;</TD></TR><TR CLASS="z"><TD CLASS="l">1923</TD><TD>                        msg.add(&#34;Product Download: &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1924</TD><TD>                        msg.add(&#34;PQS product download completed for Thread[&#34;).add(hashCode).add(&#34;] numClasses=&#34;, numClasses);</TD></TR><TR CLASS="z"><TD CLASS="l">1925</TD><TD>                        msg.add(&#34;Number of Disabled Linkage classes &#34;).add(&#34;linkageDisabledCount=&#34;,linkageDisabledCount);</TD></TR><TR CLASS="z"><TD CLASS="l">1926</TD><TD>                        msg.add(&#34;. &#34;).add(&#34;Time lapse=&#34;,  msElapsed+&#34;ms&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1927</TD><TD>                        logger.info(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1928</TD><TD>                        msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1929</TD><TD>                }</TD></TR><TR><TD CLASS="l">1930</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="1b">1931</A></TD><TD>        ///////////////////////////////////////////////////////////////</TD></TR><TR><TD CLASS="l">1932</TD><TD>    @FFCommand(description = &#34;Shows/updates SpreadTradeServerRolloutIndicator to Enabled/Disabled/NA&#34;, paramDescriptions={&#34;display/change&#34;,&#34;value (true, false or NA)(optional if first parameter is display&#34;})</TD></TR><TR><TD CLASS="l">1933</TD><TD>    public String adminSpreadTradeServerRolloutIndicator(String displayChange, String flagValue)</TD></TR><TR><TD CLASS="l">1934</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1935</TD><TD>        if (displayChange.equalsIgnoreCase(&#34;-display&#34;))</TD></TR><TR><TD CLASS="l">1936</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1937</TD><TD>            return &#34;SpreadTradeServerRolloutIndicator is currently set to: &#34; + this.spreadServerRolloutCompleted;</TD></TR><TR><TD CLASS="l">1938</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1939</TD><TD>        else if (displayChange.equalsIgnoreCase(&#34;-change&#34;))</TD></TR><TR><TD CLASS="l">1940</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1941</TD><TD>            MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">1942</TD><TD>            msg.add(&#34;Received admin request to CHANGE SpreadTradeServerRolloutIndicator to: &#34; + flagValue);</TD></TR><TR CLASS="z"><TD CLASS="l">1943</TD><TD>            logger.info( msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1944</TD><TD>            if (!flagValue.equalsIgnoreCase(&#34;true&#34;) &amp;&amp; !flagValue.equalsIgnoreCase(&#34;false&#34;) &amp;&amp; !flagValue.equalsIgnoreCase(&#34;NA&#34;))</TD></TR><TR><TD CLASS="l">1945</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1946</TD><TD>                return &#34;flagValue flag can be [true, false or NA]&#34;;</TD></TR><TR><TD CLASS="l">1947</TD><TD>            }</TD></TR><TR><TD CLASS="l">1948</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1949</TD><TD>            List&lt;ProductClassData&gt; productClassList = getProductClassDataBySymbolRegex(&#34;.*&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1950</TD><TD>            Iterator productClassIter = productClassList.iterator();</TD></TR><TR><TD CLASS="l">1951</TD><TD>          </TD></TR><TR CLASS="z"><TD CLASS="l">1952</TD><TD>            while(productClassIter.hasNext())</TD></TR><TR><TD CLASS="l">1953</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1954</TD><TD>                ProductClassDataImpl pcData = (ProductClassDataImpl)productClassIter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">1955</TD><TD>                pcData.setSpreadServerRolloutCompleted(flagValue);</TD></TR><TR CLASS="z"><TD CLASS="l">1956</TD><TD>            }</TD></TR><TR><TD CLASS="l">1957</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1958</TD><TD>            return msg.toString();</TD></TR><TR><TD CLASS="l">1959</TD><TD>        }</TD></TR><TR><TD CLASS="l">1960</TD><TD>        else</TD></TR><TR><TD CLASS="l">1961</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1962</TD><TD>            return &#34;Accepted arguments are : [-display or -change] and [true/false/NA] &#34;;</TD></TR><TR><TD CLASS="l">1963</TD><TD>        }</TD></TR><TR><TD CLASS="l">1964</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="16">1965</A></TD><TD> </TD></TR><TR><TD CLASS="l">1966</TD><TD>        @FFCommand(description=&#34;show product information for classes&#34;, paramDescriptions=&#34;classSym (optional)&#34;)</TD></TR><TR><TD CLASS="l">1967</TD><TD>        public String adminShowClasses(String p_classSym)</TD></TR><TR><TD CLASS="l">1968</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1969</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR><TD CLASS="l">1970</TD><TD>                List&lt;ProductClassData&gt; list;</TD></TR><TR CLASS="z"><TD CLASS="l">1971</TD><TD>                if (p_classSym == null || p_classSym.length()==0)</TD></TR><TR><TD CLASS="l">1972</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1973</TD><TD>                        list = getProductClassDataBySymbolRegex(&#34;.*&#34;);</TD></TR><TR><TD CLASS="l">1974</TD><TD>                }</TD></TR><TR><TD CLASS="l">1975</TD><TD>                else</TD></TR><TR><TD CLASS="l">1976</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1977</TD><TD>                        list = getProductClassDataBySymbolRegex(p_classSym);</TD></TR><TR><TD CLASS="l">1978</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1979</TD><TD>                if (list.size() == 0)</TD></TR><TR><TD CLASS="l">1980</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1981</TD><TD>                        return msg.add(&#34;No such product class&#34;).add(&#34;symbol&#34;, p_classSym).end();</TD></TR><TR><TD CLASS="l">1982</TD><TD>                }</TD></TR><TR><TD CLASS="l">1983</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1984</TD><TD>                msg.addLeftJust(&#34;classKey&#34;, 12).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">1985</TD><TD>                msg.addLeftJust(&#34;sym&#34;, 5).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">1986</TD><TD>                msg.addLeftJust(&#34;type&#34;, 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">1987</TD><TD>                msg.addLeftJust(&#34;listing&#34;, 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">1988</TD><TD>                msg.newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">1989</TD><TD>                for (ProductClassData data : list)</TD></TR><TR><TD CLASS="l">1990</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1991</TD><TD>                        msg.addLeftJust(data.getClassKey(), 12).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">1992</TD><TD>                        msg.addLeftJust(data.getClassSymbol(), 5).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">1993</TD><TD>                        msg.addLeftJust(ConstantIntMapper.getMapper(ProductTypes.class)</TD></TR><TR><TD CLASS="l">1994</TD><TD>                                        .getName(data.getProductType()), 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">1995</TD><TD>                        msg.addLeftJust(ConstantIntMapper.getMapper(ListingStates.class)</TD></TR><TR><TD CLASS="l">1996</TD><TD>                                        .getName(data.getListingState()), 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">1997</TD><TD>                        msg.newLine();</TD></TR><TR><TD CLASS="l">1998</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1999</TD><TD>                return msg.end();</TD></TR><TR><TD CLASS="l">2000</TD><TD>        }</TD></TR><TR><TD CLASS="l">2001</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="19">2002</A></TD><TD>        @FFCommand(description=&#34;show products information for a class&#34;,</TD></TR><TR><TD CLASS="l">2003</TD><TD>                        paramDescriptions={&#34;classSym&#34;,&#34;type (ex, option)&#34;})</TD></TR><TR><TD CLASS="l">2004</TD><TD>                        public String adminShowProducts(String p_classSym, String p_type)</TD></TR><TR><TD CLASS="l">2005</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2006</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">2007</TD><TD>                int type = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2008</TD><TD>                String typeName=null;</TD></TR><TR CLASS="z"><TD CLASS="l">2009</TD><TD>                for (String aTypeName : ConstantIntMapper.getMapper(ProductTypes.class).getNames())</TD></TR><TR><TD CLASS="l">2010</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2011</TD><TD>                        if (p_type.equalsIgnoreCase(aTypeName))</TD></TR><TR><TD CLASS="l">2012</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2013</TD><TD>                                typeName = aTypeName;</TD></TR><TR CLASS="z"><TD CLASS="l">2014</TD><TD>                                type = ConstantIntMapper.getMapper(ProductTypes.class).getIntValue(aTypeName, -1);</TD></TR><TR CLASS="z"><TD CLASS="l">2015</TD><TD>                                break;</TD></TR><TR><TD CLASS="l">2016</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2017</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2018</TD><TD>                if (typeName == null)</TD></TR><TR><TD CLASS="l">2019</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2020</TD><TD>                        return msg.add(&#34;Invalid type&#34;).add(&#34;arg#2&#34;,p_type).end();</TD></TR><TR><TD CLASS="l">2021</TD><TD>                }</TD></TR><TR><TD CLASS="l">2022</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2023</TD><TD>                List&lt;ProductClassData&gt; classList = getProductClassDataBySymbolRegex(p_classSym);</TD></TR><TR CLASS="z"><TD CLASS="l">2024</TD><TD>                ProductClassData classData = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2025</TD><TD>                for (ProductClassData aClassData : classList)</TD></TR><TR><TD CLASS="l">2026</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2027</TD><TD>                        if (aClassData.getProductType() == type)</TD></TR><TR><TD CLASS="l">2028</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2029</TD><TD>                                classData = aClassData;</TD></TR><TR CLASS="z"><TD CLASS="l">2030</TD><TD>                                break;</TD></TR><TR><TD CLASS="l">2031</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2032</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2033</TD><TD>                if (classData == null)</TD></TR><TR><TD CLASS="l">2034</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2035</TD><TD>                        return msg.add(&#34;No match for&#34;).add(&#34;classSym&#34;, p_classSym)</TD></TR><TR><TD CLASS="l">2036</TD><TD>                        .add(&#34;prodType&#34;).add(typeName).end();</TD></TR><TR><TD CLASS="l">2037</TD><TD>                }</TD></TR><TR><TD CLASS="l">2038</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2039</TD><TD>                msg.add(&#34;Products&#34;, classData.getProductKeys().length)</TD></TR><TR><TD CLASS="l">2040</TD><TD>                .add(&#34;for&#34;).add(&#34;classSym&#34;, p_classSym).add(':').newLine();</TD></TR><TR><TD CLASS="l">2041</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2042</TD><TD>                msg.newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2043</TD><TD>                List&lt;ProductDataImpl&gt; list = new ArrayList&lt;ProductDataImpl&gt;(classData.getProductKeys().length);</TD></TR><TR CLASS="z"><TD CLASS="l">2044</TD><TD>                for (int prodKey : classData.getProductKeys())</TD></TR><TR><TD CLASS="l">2045</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2046</TD><TD>                        ProductData prod = allProdData.get(prodKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2047</TD><TD>                        if (prod == null)</TD></TR><TR><TD CLASS="l">2048</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="81">2049</A></TD><TD>                                msg.add(&#34;prodKey&#34;, prodKey).add(&#34;not in cache!&#34;).newLine();</TD></TR><TR><TD CLASS="l">2050</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2051</TD><TD>                        list.add((ProductDataImpl)prod);</TD></TR><TR><TD CLASS="l"><A NAME="83">2052</A></TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2053</TD><TD>                Collections.sort(list, new Comparator&lt;ProductData&gt;() {</TD></TR><TR><TD CLASS="l">2054</TD><TD>                        public int compare(ProductData p_o1, ProductData p_o2)</TD></TR><TR><TD CLASS="l">2055</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2056</TD><TD>                                return p_o1.getName().compareTo(p_o2.getName());</TD></TR><TR><TD CLASS="l">2057</TD><TD>                        }});</TD></TR><TR><TD CLASS="l">2058</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2059</TD><TD>                msg.addLeftJust(&#34;prodKey&#34;, 12).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2060</TD><TD>                msg.addLeftJust(&#34;type&#34;, 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2061</TD><TD>                msg.addLeftJust(&#34;listing&#34;, 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2062</TD><TD>                msg.addLeftJust(&#34;sym&#34;, 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2063</TD><TD>                msg.addLeftJust(&#34;price&#34;, 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2064</TD><TD>                msg.addLeftJust(&#34;expire&#34;, 10).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2065</TD><TD>                msg.addLeftJust(&#34;opType&#34;, 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2066</TD><TD>                if (type == ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">2067</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2068</TD><TD>                        msg.addLeftJust(&#34;stgyType&#34;, 8).add(' ');</TD></TR><TR><TD CLASS="l">2069</TD><TD>                }</TD></TR><TR><TD CLASS="l">2070</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2071</TD><TD>                msg.addLeftJust(&#34;sess&#34;, 7).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2072</TD><TD>                msg.addLeftJust(&#34;seq&#34;, 3).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2073</TD><TD>                msg.addLeftJust(&#34;state&#34;, 7).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2074</TD><TD>                msg.newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2075</TD><TD>                for (ProductDataImpl prodData : list)</TD></TR><TR><TD CLASS="l">2076</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2077</TD><TD>                        final int pos = msg.length();</TD></TR><TR CLASS="z"><TD CLASS="l">2078</TD><TD>                        msg.addLeftJust(prodData.getProductKey(), 12).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2079</TD><TD>                        msg.addLeftJust(ConstantIntMapper.getMapper(ProductTypes.class)</TD></TR><TR><TD CLASS="l">2080</TD><TD>                                        .getName(prodData.getProductType()), 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2081</TD><TD>                        msg.addLeftJust(ConstantIntMapper.getMapper(ListingStates.class)</TD></TR><TR><TD CLASS="l">2082</TD><TD>                                        .getName(prodData.getListingState()), 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2083</TD><TD>                        msg.addLeftJust(classData.getClassSymbol(), 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2084</TD><TD>                        msg.addLeftJust(prodData.getExercisePrice(), 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2085</TD><TD>                        msg.addLeftJust(prodData.getExpirationDate(), 10).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2086</TD><TD>                        msg.addLeftJust(ConstantIntMapper.getMapper(OptionTypes.class)</TD></TR><TR><TD CLASS="l">2087</TD><TD>                                        .getName(prodData.getOptionType()), 8).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2088</TD><TD>                        if (type == ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">2089</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2090</TD><TD>                                msg.addLeftJust(ConstantIntMapper.getMapper(StrategyTypes.class)</TD></TR><TR><TD CLASS="l">2091</TD><TD>                                                .getName(prodData.getStrategyType()), 8).add(' ');</TD></TR><TR><TD CLASS="l">2092</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2093</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2094</TD><TD>                        final int offset = msg.length()-pos;</TD></TR><TR><TD CLASS="l">2095</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2096</TD><TD>                        String[] sessions =prodData.getSessions();</TD></TR><TR CLASS="z"><TD CLASS="l">2097</TD><TD>                        if (sessions.length == 0)</TD></TR><TR><TD CLASS="l">2098</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2099</TD><TD>                                msg.add(&#34;(no sessions)&#34;).newLine();</TD></TR><TR><TD CLASS="l">2100</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2101</TD><TD>                        else</TD></TR><TR><TD CLASS="l">2102</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2103</TD><TD>                                for (int i = 0; i &lt; sessions.length; i++)</TD></TR><TR><TD CLASS="l">2104</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">2105</TD><TD>                                        if (i&gt;0)</TD></TR><TR><TD CLASS="l">2106</TD><TD>                                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2107</TD><TD>                                                msg.addLeftJust(&#34;&#34;, offset);</TD></TR><TR><TD CLASS="l">2108</TD><TD>                                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2109</TD><TD>                                        msg.addLeftJust(sessions[i], 7).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2110</TD><TD>                                        msg.addLeftJust(prodData.getStateSeqNum(sessions[i]), 3).add(' ');</TD></TR><TR CLASS="z"><TD CLASS="l">2111</TD><TD>                                        msg.addLeftJust(ConstantIntMapper.getMapper(ProductStates.class)</TD></TR><TR><TD CLASS="l">2112</TD><TD>                                                        .getName(prodData.getState(sessions[i])), 7).newLine();</TD></TR><TR><TD CLASS="l">2113</TD><TD>                                }</TD></TR><TR><TD CLASS="l">2114</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2115</TD><TD>                        for (ProductLegData legData : prodData.getLegs())</TD></TR><TR><TD CLASS="l">2116</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2117</TD><TD>                                msg.add(&#34;    LEG:&#34;).add(&#34;product&#34;, legData.getProductKey()).add(' ')</TD></TR><TR><TD CLASS="l">2118</TD><TD>                                .add(&#34;ratio&#34;, legData.getRatioQuantity()).add(' ')</TD></TR><TR><TD CLASS="l">2119</TD><TD>                                .add(&#34;side&#34;, legData.getSide()).add(' ').newLine();</TD></TR><TR><TD CLASS="l">2120</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="40">2121</A></TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2122</TD><TD>                return msg.end();</TD></TR><TR><TD CLASS="l">2123</TD><TD>        }</TD></TR><TR><TD CLASS="l">2124</TD><TD>        private final String getParsedPostOrStation(String primtivePostOrStation, int classKey) {</TD></TR><TR CLASS="z"><TD CLASS="l">2125</TD><TD>                StringTokenizer str = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2126</TD><TD>                String actualValue = null;</TD></TR><TR><TD CLASS="l">2127</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">2128</TD><TD>                        str = new StringTokenizer(primtivePostOrStation, deLimiterForPostAndStation);</TD></TR><TR CLASS="z"><TD CLASS="l">2129</TD><TD>                        str.nextToken(); //String description</TD></TR><TR CLASS="z"><TD CLASS="l">2130</TD><TD>                        actualValue = str.nextToken();</TD></TR><TR><TD CLASS="l">2131</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2132</TD><TD>                catch (NoSuchElementException nfe) {</TD></TR><TR CLASS="z"><TD CLASS="l">2133</TD><TD>                        return null; // This could be a strategy class</TD></TR><TR CLASS="z"><TD CLASS="l">2134</TD><TD>                }</TD></TR><TR><TD CLASS="l">2135</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2136</TD><TD>                return actualValue;</TD></TR><TR><TD CLASS="l">2137</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="18">2138</A></TD><TD> </TD></TR><TR><TD CLASS="l">2139</TD><TD>        @FFCommand(description=&#34;show product information for prod key&#34;, paramDescriptions=&#34;prodKey&#34;)</TD></TR><TR><TD CLASS="l">2140</TD><TD>        public String adminShowProduct(String p_prodKey)</TD></TR><TR><TD CLASS="l">2141</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2142</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">2143</TD><TD>                CharArrayWriter charOut = new CharArrayWriter();</TD></TR><TR CLASS="z"><TD CLASS="l">2144</TD><TD>                PrintWriter out = new PrintWriter(charOut);</TD></TR><TR><TD CLASS="l">2145</TD><TD>                try</TD></TR><TR><TD CLASS="l">2146</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2147</TD><TD>                        ProductDataImpl prod = (ProductDataImpl) getProductData(Integer.parseInt(p_prodKey));</TD></TR><TR CLASS="z"><TD CLASS="l">2148</TD><TD>                        writeBasicProductDescription(out, prod, msg);</TD></TR><TR><TD CLASS="l">2149</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2150</TD><TD>                        if (prod.getSessions()==null)</TD></TR><TR><TD CLASS="l">2151</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2152</TD><TD>                                out.println(&#34;State:       (none)&#34;);</TD></TR><TR><TD CLASS="l">2153</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2154</TD><TD>                        else</TD></TR><TR><TD CLASS="l">2155</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2156</TD><TD>                                for (String sess : prod.getSessions())</TD></TR><TR><TD CLASS="l">2157</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">2158</TD><TD>                                        out.println(msg.addLeftJust(&#34;State[&#34;+sess+&#34;]:&#34;, 17).add(prod.getState(sess)));</TD></TR><TR CLASS="z"><TD CLASS="l">2159</TD><TD>                                        msg.clear();</TD></TR><TR><TD CLASS="l">2160</TD><TD>                                }</TD></TR><TR><TD CLASS="l">2161</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2162</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2163</TD><TD>                        if (prod.isStrategy())</TD></TR><TR><TD CLASS="l">2164</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2165</TD><TD>                                List&lt;ProductLegData&gt; legs = prod.getLegs();</TD></TR><TR CLASS="z"><TD CLASS="l">2166</TD><TD>                                msg.add(&#34;StrategyType: &#34;)</TD></TR><TR><TD CLASS="l">2167</TD><TD>                                   .add(ConstantIntMapper.getMapper(StrategyTypes.class).getName(prod.getStrategyType()));</TD></TR><TR CLASS="z"><TD CLASS="l">2168</TD><TD>                                msg.newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2169</TD><TD>                                msg.add(&#34;NumLegs: &#34;).add(legs.size());</TD></TR><TR CLASS="z"><TD CLASS="l">2170</TD><TD>                                out.println(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2171</TD><TD>                                msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">2172</TD><TD>                                for (int i=0; i &lt; legs.size(); i++)</TD></TR><TR><TD CLASS="l">2173</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">2174</TD><TD>                                        ProductLegData leg = legs.get(i);</TD></TR><TR CLASS="z"><TD CLASS="l">2175</TD><TD>                                        msg.add(&#34; Leg &#34;).add(i+1).add(&#34;/&#34;).add(legs.size()).add(&#34; ratio:           &#34;).add(leg.getRatioQuantity());</TD></TR><TR CLASS="z"><TD CLASS="l">2176</TD><TD>                                        msg.newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2177</TD><TD>                                        msg.add(&#34; Leg &#34;).add(i+1).add(&#34;/&#34;).add(legs.size()).add(&#34; side:            &#34;).add(leg.getSide());</TD></TR><TR CLASS="z"><TD CLASS="l">2178</TD><TD>                                        out.println(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2179</TD><TD>                                        msg.clear();</TD></TR><TR><TD CLASS="l">2180</TD><TD>                                        try</TD></TR><TR><TD CLASS="l">2181</TD><TD>                                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2182</TD><TD>                                                msg.add(&#34; Leg &#34;).add(i+1).add(&#34;/&#34;).add(legs.size()).add(&#34; &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2183</TD><TD>                                                writeBasicProductDescription(out, getProductData(leg.getProductKey()),msg);</TD></TR><TR><TD CLASS="l">2184</TD><TD>                                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2185</TD><TD>                                        catch (Exception ex)</TD></TR><TR><TD CLASS="l">2186</TD><TD>                                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2187</TD><TD>                                                msg.add(&#34;Leg[&#34;).add(i).add(&#34;] details = [ERROR finding leg details] &#34;).add(ex);</TD></TR><TR CLASS="z"><TD CLASS="l">2188</TD><TD>                                                out.println(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2189</TD><TD>                                                msg.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">2190</TD><TD>                                        }</TD></TR><TR><TD CLASS="l">2191</TD><TD>                                }</TD></TR><TR><TD CLASS="l">2192</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2193</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2194</TD><TD>                catch (NotFoundException e)</TD></TR><TR><TD CLASS="l">2195</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2196</TD><TD>                        return msg.add(&#34;No product data found for key &#34;).add(p_prodKey).add(&#34;: &#34;).add(e).end();</TD></TR><TR><TD CLASS="l">2197</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2198</TD><TD>                catch (Exception e)</TD></TR><TR><TD CLASS="l">2199</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2200</TD><TD>                        Log.exception(msg.add(&#34;Exception executing admin command to find &#34;).add(p_prodKey).add(e).toString(), e);</TD></TR><TR CLASS="z"><TD CLASS="l">2201</TD><TD>                        return msg.end();</TD></TR><TR CLASS="z"><TD CLASS="l">2202</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2203</TD><TD>                out.flush();</TD></TR><TR CLASS="z"><TD CLASS="l">2204</TD><TD>                return charOut.toString();</TD></TR><TR><TD CLASS="l"><A NAME="7d">2205</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">2206</TD><TD> </TD></TR><TR><TD CLASS="l">2207</TD><TD>        private void writeBasicProductDescription(PrintWriter out, ProductData prod, MsgBuilder p_prefix)</TD></TR><TR><TD CLASS="l">2208</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2209</TD><TD>                p_prefix.add(&#34;ClassKey:        &#34;).add(prod.getClassKey()).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2210</TD><TD>                p_prefix.add(&#34;RptClassKey:     &#34;).add(prod.getRptClassKey()).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2211</TD><TD>                p_prefix.add(&#34;ProductKey:      &#34;).add(prod.getProductKey()).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2212</TD><TD>                p_prefix.add(&#34;ProductSymbol:   &#34;).add(prod.getProductSymbol()).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2213</TD><TD>                p_prefix.add(&#34;ReportingClass:  &#34;).add(prod.getReportingClass()).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2214</TD><TD>                p_prefix.add(&#34;ProductType:     &#34;).add(ConstantIntMapper.getMapper(ProductTypes.class).getName(prod.getProductType())).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2215</TD><TD>                p_prefix.add(&#34;OptionType:      &#34;).add(ConstantIntMapper.getMapper(OptionTypes.class).getName(prod.getOptionType())).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2216</TD><TD>                p_prefix.add(&#34;ListingState:    &#34;).add(ConstantIntMapper.getMapper(ListingStates.class).getName(prod.getListingState())).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2217</TD><TD>                p_prefix.add(&#34;ExercisePrice:   &#34;).add(prod.getExercisePrice()).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2218</TD><TD>                p_prefix.add(&#34;ExpirationDate:  &#34;).add(new DateWrapper(prod.getExpirationDate()).format()).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2219</TD><TD>                p_prefix.add(&#34;ClosingSuffix:   &#34;).add(prod.getClosingSuffix()).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2220</TD><TD>                p_prefix.add(&#34;ClosingPrice:    &#34;).add((prod.getClosingPrice()==null ? &#34;null&#34; : PriceFactory.create(prod.getClosingPrice()))).newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2221</TD><TD>                p_prefix.add(&#34;isRestricted:    &#34;).add(prod.isRestrictedIndicator()).newLine();</TD></TR><TR><TD CLASS="l">2222</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">2223</TD><TD>                out.print(p_prefix);</TD></TR><TR CLASS="z"><TD CLASS="l">2224</TD><TD>                p_prefix.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">2225</TD><TD>        }</TD></TR><TR><TD CLASS="l">2226</TD><TD> </TD></TR><TR><TD CLASS="l">2227</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2228</TD><TD>         * get current business day</TD></TR><TR><TD CLASS="l">2229</TD><TD>         * @return</TD></TR><TR><TD CLASS="l"><A NAME="3d">2230</A></TD><TD>         * @throws FatalFoundationFrameworkException</TD></TR><TR><TD CLASS="l">2231</TD><TD>         */</TD></TR><TR><TD CLASS="l">2232</TD><TD>        private BusinessDayStruct getBusinessDay()</TD></TR><TR><TD CLASS="l">2233</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2234</TD><TD>                BusinessDayStruct businessDayStruct = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2235</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR><TD CLASS="l">2236</TD><TD> </TD></TR><TR><TD CLASS="l">2237</TD><TD>                // get all trading sessions from TradingSessionService</TD></TR><TR><TD CLASS="l">2238</TD><TD>                try</TD></TR><TR><TD CLASS="l">2239</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2240</TD><TD>                        businessDayStruct = tss.getCurrentBusinessDay();</TD></TR><TR><TD CLASS="l">2241</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2242</TD><TD>                catch (SystemException se)</TD></TR><TR><TD CLASS="l">2243</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2244</TD><TD>                        Log.exception(msg.add(&#34;System Exception while calling getCurrentBusinessDay&#34;).add(se).toString(), se);</TD></TR><TR CLASS="z"><TD CLASS="l">2245</TD><TD>                        throw new FatalFoundationFrameworkException(se, msg.end());</TD></TR><TR><TD CLASS="l">2246</TD><TD> </TD></TR><TR><TD CLASS="l">2247</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2248</TD><TD>                catch (CommunicationException ce)</TD></TR><TR><TD CLASS="l">2249</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2250</TD><TD>                        Log.exception(msg</TD></TR><TR><TD CLASS="l">2251</TD><TD>                                        .add(&#34;Communication Exception while calling getCurrentBusinessDay&#34;)</TD></TR><TR><TD CLASS="l">2252</TD><TD>                                        .add(ce).toString(), ce);</TD></TR><TR CLASS="z"><TD CLASS="l">2253</TD><TD>                        throw new FatalFoundationFrameworkException(ce, msg.end());</TD></TR><TR><TD CLASS="l">2254</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2255</TD><TD>                catch (AuthorizationException ae)</TD></TR><TR><TD CLASS="l">2256</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2257</TD><TD>                        Log.exception(msg</TD></TR><TR><TD CLASS="l">2258</TD><TD>                                        .add(&#34;Authorization Exception while calling getCurrentBusinessDay&#34;)</TD></TR><TR><TD CLASS="l">2259</TD><TD>                                        .add(ae).toString(), ae);</TD></TR><TR CLASS="z"><TD CLASS="l">2260</TD><TD>                        throw new FatalFoundationFrameworkException(ae, msg.end());</TD></TR><TR CLASS="z"><TD CLASS="l">2261</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2262</TD><TD>                return businessDayStruct;</TD></TR><TR><TD CLASS="l">2263</TD><TD>        }</TD></TR><TR><TD CLASS="l">2264</TD><TD> </TD></TR><TR><TD CLASS="l">2265</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2266</TD><TD>         * Get current business day</TD></TR><TR><TD CLASS="l">2267</TD><TD>         * and use it to get classKey and session name pair.</TD></TR><TR><TD CLASS="l">2268</TD><TD>         * In addition, get classes for additional sessions</TD></TR><TR><TD CLASS="l"><A NAME="2f">2269</A></TD><TD>         *</TD></TR><TR><TD CLASS="l">2270</TD><TD>         */</TD></TR><TR><TD CLASS="l">2271</TD><TD>        public void downLoadAdditionalClassesAndSessions()</TD></TR><TR><TD CLASS="l">2272</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2273</TD><TD>                BusinessDayStruct businessDayStruct = getBusinessDay();</TD></TR><TR><TD CLASS="l">2274</TD><TD> </TD></TR><TR><TD CLASS="l">2275</TD><TD>                // get all trading sessions from TradingSessionService</TD></TR><TR CLASS="z"><TD CLASS="l">2276</TD><TD>                BusinessDaySessionStruct[] activeSessions = businessDayStruct.activeSessions;</TD></TR><TR><TD CLASS="l">2277</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2278</TD><TD>                int numInAdditionalSessions=0;</TD></TR><TR CLASS="z"><TD CLASS="l">2279</TD><TD>                int numAdded=0;</TD></TR><TR><TD CLASS="l">2280</TD><TD> </TD></TR><TR><TD CLASS="l">2281</TD><TD>                // for each active session, load classKey - sessionName Map</TD></TR><TR CLASS="z"><TD CLASS="l">2282</TD><TD>                for (BusinessDaySessionStruct session : activeSessions) {</TD></TR><TR CLASS="z"><TD CLASS="l">2283</TD><TD>                        for (SessionClassStruct sessionClass: session.sessionClasses) {</TD></TR><TR CLASS="z"><TD CLASS="l">2284</TD><TD>                                ClassStruct classStruct = sessionClass.classStruct;</TD></TR><TR CLASS="z"><TD CLASS="l">2285</TD><TD>                                allClassUnderlyingSessionNames.put(classStruct.classKey, sessionClass.underlyingSessionName);</TD></TR><TR><TD CLASS="l">2286</TD><TD> </TD></TR><TR><TD CLASS="l">2287</TD><TD>                                // we don't care about underlying session and notApplicable session so bypass it</TD></TR><TR CLASS="z"><TD CLASS="l">2288</TD><TD>                                if (!TradingSessionNameHelper.isUnderlyingSession(sessionClass.sessionName)</TD></TR><TR><TD CLASS="l">2289</TD><TD>                                                &amp;&amp; !TradingSessionNameHelper.isNotApplicableSession(sessionClass.sessionName)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2290</TD><TD>                                        String sessions = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2291</TD><TD>                                        if (allClassSessionNames.containsKey(classStruct.classKey))</TD></TR><TR><TD CLASS="l">2292</TD><TD>                                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2293</TD><TD>                                                sessions = allClassSessionNames.get(classStruct.classKey) + SESS_LIST_DELIMITER + sessionClass.sessionName;</TD></TR><TR><TD CLASS="l">2294</TD><TD>                                        }</TD></TR><TR><TD CLASS="l">2295</TD><TD>                                        else</TD></TR><TR CLASS="z"><TD CLASS="l">2296</TD><TD>                                                sessions = sessionClass.sessionName;</TD></TR><TR CLASS="z"><TD CLASS="l">2297</TD><TD>                                        allClassSessionNames.put(classStruct.classKey, sessions);</TD></TR><TR><TD CLASS="l">2298</TD><TD>                                        //if additionalSessions contains the sessionName,</TD></TR><TR><TD CLASS="l">2299</TD><TD>                                        // add product classes for the session</TD></TR><TR CLASS="z"><TD CLASS="l">2300</TD><TD>                                        for (String additionalSessionName : additionalSessions) {</TD></TR><TR CLASS="z"><TD CLASS="l">2301</TD><TD>                                                if (additionalSessionName != null &amp;&amp; additionalSessionName.equals(sessionClass.sessionName)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2302</TD><TD>                                                        numInAdditionalSessions++;</TD></TR><TR CLASS="z"><TD CLASS="l">2303</TD><TD>                                                        if (!classKeys.contains(classStruct.classKey))</TD></TR><TR><TD CLASS="l">2304</TD><TD>                                                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2305</TD><TD>                                                                numAdded++;</TD></TR><TR><TD CLASS="l">2306</TD><TD>                                                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2307</TD><TD>                                                        classKeys.add(classStruct.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2308</TD><TD>                                                        break;</TD></TR><TR><TD CLASS="l">2309</TD><TD>                                                }</TD></TR><TR><TD CLASS="l">2310</TD><TD>                                        }</TD></TR><TR><TD CLASS="l">2311</TD><TD>                                }</TD></TR><TR><TD CLASS="l">2312</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2313</TD><TD>                }</TD></TR><TR><TD CLASS="l">2314</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2315</TD><TD>                if (numInAdditionalSessions&gt;0)</TD></TR><TR><TD CLASS="l">2316</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2317</TD><TD>                        MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">2318</TD><TD>                        msg.add(&#34;Found &#34;).add(numInAdditionalSessions).add(&#34; classes in additional sessions to include in cache.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2319</TD><TD>                        msg.newLine();</TD></TR><TR CLASS="z"><TD CLASS="l">2320</TD><TD>                        msg.add(&#34;... of which &#34;).add(numAdded).add(&#34; were not already in the list.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2321</TD><TD>                        logger.info(msg);</TD></TR><TR><TD CLASS="l">2322</TD><TD>                }</TD></TR><TR><TD CLASS="l">2323</TD><TD> </TD></TR><TR><TD CLASS="l">2324</TD><TD>                // load rollout flags</TD></TR><TR CLASS="z"><TD CLASS="l">2325</TD><TD>                setTempRolloutFlag();</TD></TR><TR CLASS="z"><TD CLASS="l">2326</TD><TD>        }</TD></TR><TR><TD CLASS="l">2327</TD><TD> </TD></TR><TR><TD CLASS="l">2328</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2329</TD><TD>         * populate temp rollout flag</TD></TR><TR><TD CLASS="l"><A NAME="62">2330</A></TD><TD>         *</TD></TR><TR><TD CLASS="l">2331</TD><TD>         */</TD></TR><TR><TD CLASS="l">2332</TD><TD>        private void setTempRolloutFlag()</TD></TR><TR><TD CLASS="l">2333</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2334</TD><TD>                MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">2335</TD><TD>                logger.info(msg.add(&#34;Downloading rollout indicators for class keys&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">2336</TD><TD>                msg.clear();</TD></TR><TR><TD CLASS="l">2337</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">2338</TD><TD>                int arraySize = classKeys.size();</TD></TR><TR CLASS="z"><TD CLASS="l">2339</TD><TD>                this.tempRolloutFlags = new boolean[arraySize];</TD></TR><TR CLASS="z"><TD CLASS="l">2340</TD><TD>                int[] tempPCSKeys = new int[arraySize];</TD></TR><TR><TD CLASS="l">2341</TD><TD>                //To build the call the classKeys (array of int) to get the QPE rollout flag</TD></TR><TR CLASS="z"><TD CLASS="l">2342</TD><TD>                for(int index = 0; index &lt; arraySize; index++)</TD></TR><TR><TD CLASS="l">2343</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2344</TD><TD>                        tempRolloutFlags[index] = false;</TD></TR><TR CLASS="z"><TD CLASS="l">2345</TD><TD>                        tempPCSKeys[index] = classKeys.get(index);</TD></TR><TR><TD CLASS="l">2346</TD><TD>                }</TD></TR><TR><TD CLASS="l">2347</TD><TD> </TD></TR><TR><TD CLASS="l">2348</TD><TD>                try</TD></TR><TR><TD CLASS="l">2349</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2350</TD><TD>                        int[] rolledOutClasses = pms.getQpeClasses(tempPCSKeys);</TD></TR><TR CLASS="z"><TD CLASS="l">2351</TD><TD>                        for (int rolledOutKey: rolledOutClasses)</TD></TR><TR><TD CLASS="l">2352</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2353</TD><TD>                                int idx = this.classKeys.indexOf(new Integer(rolledOutKey));</TD></TR><TR CLASS="z"><TD CLASS="l">2354</TD><TD>                                if (idx &gt;= 0)</TD></TR><TR><TD CLASS="l">2355</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">2356</TD><TD>                                        this.tempRolloutFlags[idx] = true;</TD></TR><TR><TD CLASS="l">2357</TD><TD>                                }</TD></TR><TR><TD CLASS="l">2358</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2359</TD><TD>                        logger.info(msg.add(&#34;Done download rollout indicators for class keys:&#34;)</TD></TR><TR><TD CLASS="l">2360</TD><TD>                                        .add(&#34;#rolledOut&#34;,rolledOutClasses.length));</TD></TR><TR><TD CLASS="l">2361</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2362</TD><TD>                catch (Exception ex)</TD></TR><TR><TD CLASS="l">2363</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2364</TD><TD>                        throw new FatalFoundationFrameworkException(ex, &#34;Failed PMS rollout indicator download&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2365</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2366</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="56">2367</A></TD><TD> </TD></TR><TR><TD CLASS="l">2368</TD><TD>        @FFProperty</TD></TR><TR><TD CLASS="l">2369</TD><TD>        protected void setAdditionalSessions(String[] additionalSessions)</TD></TR><TR><TD CLASS="l">2370</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2371</TD><TD>                if (additionalSessions == null)</TD></TR><TR CLASS="z"><TD CLASS="l">2372</TD><TD>                        additionalSessions = new String[0];</TD></TR><TR CLASS="z"><TD CLASS="l">2373</TD><TD>                this.additionalSessions = additionalSessions;</TD></TR><TR CLASS="z"><TD CLASS="l">2374</TD><TD>                logger.info(MsgBuilder.get().add(&#34;setAdditionalSessions: number of additional sessions: &#34;)</TD></TR><TR><TD CLASS="l">2375</TD><TD>                                .add(additionalSessions.length)</TD></TR><TR><TD CLASS="l">2376</TD><TD>                                .add(&#34; first additional session name: &#34;)</TD></TR><TR><TD CLASS="l">2377</TD><TD>                                .add(additionalSessions[0]));</TD></TR><TR CLASS="z"><TD CLASS="l">2378</TD><TD>                if (allSessionsForCache==null)</TD></TR><TR CLASS="z"><TD CLASS="l">2379</TD><TD>                    allSessionsForCache = new HashSet&lt;String&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">2380</TD><TD>                for (String additionalSession : additionalSessions)</TD></TR><TR><TD CLASS="l">2381</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2382</TD><TD>                    if(additionalSession != null &amp;&amp; !additionalSession.trim().equals(&#34;&#34;))</TD></TR><TR><TD CLASS="l">2383</TD><TD>                    {    </TD></TR><TR CLASS="z"><TD CLASS="l">2384</TD><TD>                        allSessionsForCache.add(additionalSession);</TD></TR><TR><TD CLASS="l">2385</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2386</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2387</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="71">2388</A></TD><TD> </TD></TR><TR><TD CLASS="l">2389</TD><TD>        public void updateProductOpenInterest(int classKey, ProductOpenInterestStruct[] openInterestForProducts)</TD></TR><TR><TD CLASS="l">2390</TD><TD>        {</TD></TR><TR><TD CLASS="l">2391</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2392</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="45">2393</A></TD><TD> </TD></TR><TR><TD CLASS="l">2394</TD><TD>        public ReportingClassData getReportingClassData(int reportingClassKey)</TD></TR><TR><TD CLASS="l">2395</TD><TD>        throws NotFoundException, SystemException</TD></TR><TR><TD CLASS="l">2396</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2397</TD><TD>                ReportingClassData reportingClass = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2398</TD><TD>                reportingClass = allReportingClassData.get(reportingClassKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2399</TD><TD>                if (reportingClass == null)</TD></TR><TR><TD CLASS="l">2400</TD><TD>                {</TD></TR><TR><TD CLASS="l">2401</TD><TD>                        // TODO: hit global server on a local cache miss!!!!!!</TD></TR><TR><TD CLASS="l">2402</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2403</TD><TD>                if (reportingClass == null)</TD></TR><TR><TD CLASS="l">2404</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2405</TD><TD>                        MsgBuilder msg = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">2406</TD><TD>                        logger.alarm(msg.add(&#34;reportingClass with key: [&#34; + reportingClassKey + &#34;] can not be found.&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">2407</TD><TD>                        throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">2408</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2409</TD><TD>                return reportingClass;</TD></TR><TR><TD CLASS="l">2410</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="5a">2411</A></TD><TD> </TD></TR><TR><TD CLASS="l">2412</TD><TD>        @FFProperty</TD></TR><TR><TD CLASS="l">2413</TD><TD>        public void setIgnoreLowSeqNumbers(boolean p_ignoreLowSeqNumbers)</TD></TR><TR><TD CLASS="l">2414</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2415</TD><TD>                ignoreLowSeqNumbers = p_ignoreLowSeqNumbers;</TD></TR><TR CLASS="z"><TD CLASS="l">2416</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="61">2417</A></TD><TD> </TD></TR><TR><TD CLASS="l">2418</TD><TD>    @FFProperty</TD></TR><TR><TD CLASS="l">2419</TD><TD>    public void setSpreadServerRolloutCompleted(String p_rolloutCompleted)</TD></TR><TR><TD CLASS="l">2420</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2421</TD><TD>        this.spreadServerRolloutCompleted = p_rolloutCompleted;</TD></TR><TR CLASS="z"><TD CLASS="l">2422</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="1a">2423</A></TD><TD>    </TD></TR><TR><TD CLASS="l">2424</TD><TD>    @FFCommand(description = &#34;Shows List of Rollout Enabled/Disabled Classes&#34;, paramDescriptions = { &#34;-enabled | -disabled&#34;})</TD></TR><TR><TD CLASS="l">2425</TD><TD>    public String adminShowRolloutClasses(String enabledDisabled)</TD></TR><TR><TD CLASS="l">2426</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2427</TD><TD>        StringBuffer rv = new StringBuffer();</TD></TR><TR CLASS="z"><TD CLASS="l">2428</TD><TD>        StringBuffer ohsEnabledClasses = new StringBuffer();</TD></TR><TR CLASS="z"><TD CLASS="l">2429</TD><TD>        StringBuffer ohsDisablededClasses = new StringBuffer();</TD></TR><TR CLASS="z"><TD CLASS="l">2430</TD><TD>        int ohsEnableCount = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2431</TD><TD>        int ohsDisableCount = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2432</TD><TD>        List&lt;ProductClassData&gt; productClassList = getProductClassDataBySymbolRegex(&#34;.*&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2433</TD><TD>        Iterator productClassIter = productClassList.iterator();</TD></TR><TR><TD CLASS="l">2434</TD><TD>      </TD></TR><TR CLASS="z"><TD CLASS="l">2435</TD><TD>        while(productClassIter.hasNext())</TD></TR><TR><TD CLASS="l">2436</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2437</TD><TD>            ProductClassData pcData = (ProductClassData)productClassIter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">2438</TD><TD>            StringBuffer linakgeClassInfo = new StringBuffer(pcData.getClassSymbol()).append(&#34;-&#34;).append(pcData.getProductType())</TD></TR><TR><TD CLASS="l">2439</TD><TD>                                                             .append(&#34;(&#34;).append(pcData.getClassKey()).append(&#34;),&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2440</TD><TD>            if(pcData.getRolloutIndicator())</TD></TR><TR><TD CLASS="l">2441</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2442</TD><TD>                ohsEnabledClasses.append(linakgeClassInfo.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2443</TD><TD>                ohsEnableCount++;</TD></TR><TR CLASS="z"><TD CLASS="l">2444</TD><TD>                if( (ohsEnableCount % 10) == 0)</TD></TR><TR><TD CLASS="l">2445</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2446</TD><TD>                    ohsEnabledClasses.append(&#34;\n&#34;);</TD></TR><TR><TD CLASS="l">2447</TD><TD>                }</TD></TR><TR><TD CLASS="l">2448</TD><TD>            }</TD></TR><TR><TD CLASS="l">2449</TD><TD>            else</TD></TR><TR><TD CLASS="l">2450</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2451</TD><TD>                ohsDisablededClasses.append(linakgeClassInfo.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2452</TD><TD>                ohsDisableCount++;</TD></TR><TR CLASS="z"><TD CLASS="l">2453</TD><TD>                if( (ohsDisableCount % 10) == 0)</TD></TR><TR><TD CLASS="l">2454</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2455</TD><TD>                    ohsDisablededClasses.append(&#34;\n&#34;);</TD></TR><TR><TD CLASS="l">2456</TD><TD>                }                    </TD></TR><TR><TD CLASS="l">2457</TD><TD> </TD></TR><TR><TD CLASS="l">2458</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2459</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2460</TD><TD>        if ((&#34;-enabled&#34;.equalsIgnoreCase(enabledDisabled)) || enabledDisabled.trim().length() == 0)</TD></TR><TR><TD CLASS="l">2461</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2462</TD><TD>            rv.append(&#34;Classes Enabled for ROLLOUT &#34; + &#34;(&#34; + ohsEnableCount + &#34;): \n&#34;</TD></TR><TR><TD CLASS="l">2463</TD><TD>                      + ohsEnabledClasses.toString() );</TD></TR><TR><TD CLASS="l">2464</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2465</TD><TD>        if (&#34;-disabled&#34;.equalsIgnoreCase(enabledDisabled))</TD></TR><TR><TD CLASS="l">2466</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2467</TD><TD>            rv.append(&#34;Classes Disabled for ROLLOUT &#34; + &#34;(&#34; + ohsDisableCount + &#34;): \n&#34;</TD></TR><TR><TD CLASS="l">2468</TD><TD>                    + ohsDisablededClasses.toString() );</TD></TR><TR><TD CLASS="l">2469</TD><TD> </TD></TR><TR><TD CLASS="l">2470</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2471</TD><TD>        return rv.toString();</TD></TR><TR><TD CLASS="l">2472</TD><TD>    }</TD></TR><TR><TD CLASS="l">2473</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="17">2474</A></TD><TD> </TD></TR><TR><TD CLASS="l">2475</TD><TD>        @FFCommand(description = &#34;Shows List of Linkage Enabled/Disabled Classes&#34;, paramDescriptions = { &#34;-enabled | -disabled&#34;})</TD></TR><TR><TD CLASS="l">2476</TD><TD>        public String adminShowLinkageClasses(String enabledDisabled)</TD></TR><TR><TD CLASS="l">2477</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2478</TD><TD>                MsgBuilder temp = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">2479</TD><TD>                MsgBuilder linkageEnabledClasses = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">2480</TD><TD>                MsgBuilder linkageDisablededClasses = MsgBuilder.get();</TD></TR><TR CLASS="z"><TD CLASS="l">2481</TD><TD>                int linkageEnableCount = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2482</TD><TD>                int linkageDisableCount = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2483</TD><TD>                List&lt;ProductClassData&gt; productClassList = getProductClassDataBySymbolRegex(&#34;.*&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2484</TD><TD>                Iterator&lt;ProductClassData&gt; productClassIter = productClassList.iterator();</TD></TR><TR><TD CLASS="l">2485</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2486</TD><TD>                while(productClassIter.hasNext())</TD></TR><TR><TD CLASS="l">2487</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2488</TD><TD>                        ProductClassData pcData = productClassIter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">2489</TD><TD>                        temp.add(pcData.getClassSymbol())</TD></TR><TR><TD CLASS="l">2490</TD><TD>                          .add(&#34;-&#34;)</TD></TR><TR><TD CLASS="l">2491</TD><TD>                          .add(pcData.getProductType())</TD></TR><TR><TD CLASS="l">2492</TD><TD>                          .add(&#34;(&#34;).add(pcData.getClassKey()).add(&#34;),&#34;);</TD></TR><TR><TD CLASS="l">2493</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2494</TD><TD>                        if(pcData.isLinkageDisabled())</TD></TR><TR><TD CLASS="l">2495</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2496</TD><TD>                                linkageDisablededClasses.add(temp.end());</TD></TR><TR CLASS="z"><TD CLASS="l">2497</TD><TD>                                linkageDisableCount++;</TD></TR><TR CLASS="z"><TD CLASS="l">2498</TD><TD>                                if( (linkageDisableCount % 10) == 0)</TD></TR><TR><TD CLASS="l">2499</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">2500</TD><TD>                                        linkageDisablededClasses.newLine();</TD></TR><TR><TD CLASS="l">2501</TD><TD>                                }</TD></TR><TR><TD CLASS="l">2502</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2503</TD><TD>                        else</TD></TR><TR><TD CLASS="l">2504</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2505</TD><TD>                                linkageEnabledClasses.add(temp.end());</TD></TR><TR CLASS="z"><TD CLASS="l">2506</TD><TD>                                linkageEnableCount++;</TD></TR><TR CLASS="z"><TD CLASS="l">2507</TD><TD>                                if( (linkageEnableCount % 10) == 0)</TD></TR><TR><TD CLASS="l">2508</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">2509</TD><TD>                                        linkageEnabledClasses.newLine();</TD></TR><TR><TD CLASS="l">2510</TD><TD>                                }</TD></TR><TR><TD CLASS="l">2511</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2512</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2513</TD><TD>                if ((&#34;-enabled&#34;.equalsIgnoreCase(enabledDisabled)) || enabledDisabled.trim().length() == 0)</TD></TR><TR><TD CLASS="l">2514</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2515</TD><TD>                        temp.add(&#34;Classes Enabled for Linkage &#34;)</TD></TR><TR><TD CLASS="l">2516</TD><TD>                            .add(&#34;(&#34;)</TD></TR><TR><TD CLASS="l">2517</TD><TD>                            .add(linkageEnableCount)</TD></TR><TR><TD CLASS="l">2518</TD><TD>                            .add(&#34;):&#34;)</TD></TR><TR><TD CLASS="l">2519</TD><TD>                            .newLine()</TD></TR><TR><TD CLASS="l">2520</TD><TD>                        .add(linkageEnabledClasses.end());</TD></TR><TR><TD CLASS="l">2521</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2522</TD><TD>                if (&#34;-disabled&#34;.equalsIgnoreCase(enabledDisabled))</TD></TR><TR><TD CLASS="l">2523</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2524</TD><TD>                        temp.add(&#34;Classes Disabled for Linkage &#34;)</TD></TR><TR><TD CLASS="l">2525</TD><TD>                            .add(&#34;(&#34;)</TD></TR><TR><TD CLASS="l">2526</TD><TD>                            .add(linkageDisableCount)</TD></TR><TR><TD CLASS="l">2527</TD><TD>                            .add(&#34;):&#34;)</TD></TR><TR><TD CLASS="l">2528</TD><TD>                            .newLine()</TD></TR><TR><TD CLASS="l">2529</TD><TD>                            .add(linkageDisablededClasses.end());</TD></TR><TR><TD CLASS="l">2530</TD><TD> </TD></TR><TR><TD CLASS="l">2531</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2532</TD><TD>                return temp.end();</TD></TR><TR><TD CLASS="l"><A NAME="3c">2533</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">2534</TD><TD> </TD></TR><TR><TD CLASS="l">2535</TD><TD>        public Set&lt;Integer&gt; getAssociatedStrategyKeys(int p_productKey)</TD></TR><TR><TD CLASS="l">2536</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2537</TD><TD>                return associatedStrategiesPerProduct.get(p_productKey);</TD></TR><TR><TD CLASS="l"><A NAME="43">2538</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">2539</TD><TD> </TD></TR><TR><TD CLASS="l">2540</TD><TD>        public int[] getProductClassKeysByGroup(String p_groupName)</TD></TR><TR><TD CLASS="l">2541</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2542</TD><TD>                return classKeysByGroup.get(p_groupName);</TD></TR><TR><TD CLASS="l">2543</TD><TD>        }</TD></TR><TR><TD CLASS="l">2544</TD><TD> </TD></TR><TR><TD CLASS="l">2545</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2546</TD><TD>         * Register for notifications when the attributes (or data object) for a product changes.</TD></TR><TR><TD CLASS="l">2547</TD><TD>         * If the data is currently findable by the cache, the listener will be given an</TD></TR><TR><TD CLASS="l">2548</TD><TD>         * initial callback by this registration method (completed before this method returns).</TD></TR><TR><TD CLASS="l">2549</TD><TD>         * </TD></TR><TR><TD CLASS="l">2550</TD><TD>         * @param p_reportingClassKey</TD></TR><TR><TD CLASS="l"><A NAME="54">2551</A></TD><TD>         * @param p_listener</TD></TR><TR><TD CLASS="l">2552</TD><TD>         */</TD></TR><TR><TD CLASS="l">2553</TD><TD>        public void registerForUpdates(int p_productKey, ProductDataUpdateListener p_listener)</TD></TR><TR><TD CLASS="l">2554</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2555</TD><TD>                ProductData prodData = null;</TD></TR><TR><TD CLASS="l">2556</TD><TD>                try</TD></TR><TR><TD CLASS="l">2557</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2558</TD><TD>                        prodData = getProductData(p_productKey);</TD></TR><TR><TD CLASS="l">2559</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2560</TD><TD>                catch (Exception e)</TD></TR><TR><TD CLASS="l">2561</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2562</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2563</TD><TD>                if (prodData != null)</TD></TR><TR><TD CLASS="l">2564</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2565</TD><TD>                        p_listener.acceptUpdate(prodData);</TD></TR><TR><TD CLASS="l">2566</TD><TD>                }</TD></TR><TR><TD CLASS="l">2567</TD><TD> </TD></TR><TR><TD CLASS="l">2568</TD><TD>                ArrayList&lt;ProductDataUpdateListener&gt; list;</TD></TR><TR CLASS="z"><TD CLASS="l">2569</TD><TD>                synchronized (productUpdateListeners)</TD></TR><TR><TD CLASS="l">2570</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2571</TD><TD>                        list = this.productUpdateListeners.get(p_productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2572</TD><TD>                        if (list == null)</TD></TR><TR><TD CLASS="l">2573</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2574</TD><TD>                                this.productUpdateListeners.put(p_productKey, list = new ArrayList&lt;ProductDataUpdateListener&gt;());</TD></TR><TR><TD CLASS="l">2575</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2576</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2577</TD><TD>                synchronized (list)</TD></TR><TR><TD CLASS="l">2578</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2579</TD><TD>                        list.add(p_listener);</TD></TR><TR CLASS="z"><TD CLASS="l">2580</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2581</TD><TD>        }</TD></TR><TR><TD CLASS="l">2582</TD><TD> </TD></TR><TR><TD CLASS="l">2583</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2584</TD><TD>         * Register for notifications when the attributes (or data object) for a reporting class change.</TD></TR><TR><TD CLASS="l">2585</TD><TD>         * If the data is currently findable by the cache, the listener will be given an</TD></TR><TR><TD CLASS="l">2586</TD><TD>         * initial callback by this registration method (completed before this method returns).</TD></TR><TR><TD CLASS="l">2587</TD><TD>         * </TD></TR><TR><TD CLASS="l">2588</TD><TD>         * @param p_reportingClassKey</TD></TR><TR><TD CLASS="l"><A NAME="55">2589</A></TD><TD>         * @param p_listener</TD></TR><TR><TD CLASS="l">2590</TD><TD>         */</TD></TR><TR><TD CLASS="l">2591</TD><TD>        public void registerForUpdates(int p_reportingClassKey, ReportingClassDataUpdateListener p_listener)</TD></TR><TR><TD CLASS="l">2592</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2593</TD><TD>                ReportingClassData rptData = null;</TD></TR><TR><TD CLASS="l">2594</TD><TD>                try</TD></TR><TR><TD CLASS="l">2595</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2596</TD><TD>                        rptData = getReportingClassData(p_reportingClassKey);</TD></TR><TR><TD CLASS="l">2597</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2598</TD><TD>                catch (Exception e)</TD></TR><TR><TD CLASS="l">2599</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2600</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2601</TD><TD>                if (rptData != null)</TD></TR><TR><TD CLASS="l">2602</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2603</TD><TD>                        p_listener.acceptUpdate(rptData);</TD></TR><TR><TD CLASS="l">2604</TD><TD>                }</TD></TR><TR><TD CLASS="l">2605</TD><TD> </TD></TR><TR><TD CLASS="l">2606</TD><TD>                ArrayList&lt;ReportingClassDataUpdateListener&gt; list;</TD></TR><TR CLASS="z"><TD CLASS="l">2607</TD><TD>                synchronized (reportingClassUpdateListeners)</TD></TR><TR><TD CLASS="l">2608</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2609</TD><TD>                        list = this.reportingClassUpdateListeners.get(p_reportingClassKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2610</TD><TD>                        if (list == null)</TD></TR><TR><TD CLASS="l">2611</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2612</TD><TD>                                this.reportingClassUpdateListeners.put(p_reportingClassKey, list = new ArrayList&lt;ReportingClassDataUpdateListener&gt;());</TD></TR><TR><TD CLASS="l">2613</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2614</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2615</TD><TD>                synchronized (list)</TD></TR><TR><TD CLASS="l">2616</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2617</TD><TD>                        list.add(p_listener);</TD></TR><TR CLASS="z"><TD CLASS="l">2618</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2619</TD><TD>        }</TD></TR><TR><TD CLASS="l">2620</TD><TD> </TD></TR><TR><TD CLASS="l">2621</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2622</TD><TD>         * Register for notifications when the attributes of product class may have changed.</TD></TR><TR><TD CLASS="l">2623</TD><TD>         * If the data is currently findable by the cache, the listener will be given an</TD></TR><TR><TD CLASS="l">2624</TD><TD>         * initial callback by this registration method (completed before this method returns).</TD></TR><TR><TD CLASS="l">2625</TD><TD>         * </TD></TR><TR><TD CLASS="l">2626</TD><TD>         * @param p_classKey</TD></TR><TR><TD CLASS="l"><A NAME="53">2627</A></TD><TD>         * @param p_listener</TD></TR><TR><TD CLASS="l">2628</TD><TD>         */</TD></TR><TR><TD CLASS="l">2629</TD><TD>        public void registerForUpdates(int p_classKey, ProductClassDataUpdateListener p_listener)</TD></TR><TR><TD CLASS="l">2630</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2631</TD><TD>                ProductClassData classData = null;</TD></TR><TR><TD CLASS="l">2632</TD><TD>                try</TD></TR><TR><TD CLASS="l">2633</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2634</TD><TD>                        classData = getProductClassData(p_classKey);</TD></TR><TR><TD CLASS="l">2635</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2636</TD><TD>                catch (Exception e)</TD></TR><TR><TD CLASS="l">2637</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2638</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2639</TD><TD>                if (classData != null)</TD></TR><TR><TD CLASS="l">2640</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2641</TD><TD>                        p_listener.acceptUpdate(classData);</TD></TR><TR><TD CLASS="l">2642</TD><TD>                }</TD></TR><TR><TD CLASS="l">2643</TD><TD> </TD></TR><TR><TD CLASS="l">2644</TD><TD>                ArrayList&lt;ProductClassDataUpdateListener&gt; list;</TD></TR><TR CLASS="z"><TD CLASS="l">2645</TD><TD>                synchronized (productClassUpdateListeners)</TD></TR><TR><TD CLASS="l">2646</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2647</TD><TD>                        list = this.productClassUpdateListeners.get(p_classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2648</TD><TD>                        if (list == null)</TD></TR><TR><TD CLASS="l">2649</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2650</TD><TD>                                this.productClassUpdateListeners.put(p_classKey, list = new ArrayList&lt;ProductClassDataUpdateListener&gt;());</TD></TR><TR><TD CLASS="l">2651</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2652</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2653</TD><TD>                synchronized (list)</TD></TR><TR><TD CLASS="l">2654</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2655</TD><TD>                        list.add(p_listener);</TD></TR><TR CLASS="z"><TD CLASS="l">2656</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2657</TD><TD>        }</TD></TR><TR><TD CLASS="l">2658</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="4b">2659</A></TD><TD> </TD></TR><TR><TD CLASS="l">2660</TD><TD>        private void notifyListeners(final ProductDataImpl p_updated)</TD></TR><TR><TD CLASS="l">2661</TD><TD>        {</TD></TR><TR><TD CLASS="l">2662</TD><TD>                final ArrayList&lt;ProductDataUpdateListener&gt; list;</TD></TR><TR CLASS="z"><TD CLASS="l">2663</TD><TD>                synchronized (productUpdateListeners)</TD></TR><TR><TD CLASS="l">2664</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2665</TD><TD>                        list = this.productUpdateListeners.get(p_updated.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">2666</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2667</TD><TD>                if (list != null)</TD></TR><TR><TD CLASS="l">2668</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2669</TD><TD>                        synchronized (list)</TD></TR><TR><TD CLASS="l">2670</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2671</TD><TD>                                final int len = list.size();</TD></TR><TR CLASS="z"><TD CLASS="l">2672</TD><TD>                                for (int i = 0; i &lt; len; i++)</TD></TR><TR><TD CLASS="l">2673</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">2674</TD><TD>                                        list.get(i).acceptUpdate(p_updated);</TD></TR><TR><TD CLASS="l">2675</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">2676</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2677</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2678</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="4c">2679</A></TD><TD> </TD></TR><TR><TD CLASS="l">2680</TD><TD>        private void notifyListeners(final ReportingClassDataImpl p_updated)</TD></TR><TR><TD CLASS="l">2681</TD><TD>        {</TD></TR><TR><TD CLASS="l">2682</TD><TD>                final ArrayList&lt;ReportingClassDataUpdateListener&gt; list;</TD></TR><TR CLASS="z"><TD CLASS="l">2683</TD><TD>                synchronized (reportingClassUpdateListeners)</TD></TR><TR><TD CLASS="l">2684</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2685</TD><TD>                        list = this.reportingClassUpdateListeners.get(p_updated.getReportingClassKey());</TD></TR><TR CLASS="z"><TD CLASS="l">2686</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2687</TD><TD>                if (list != null)</TD></TR><TR><TD CLASS="l">2688</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2689</TD><TD>                        synchronized (list)</TD></TR><TR><TD CLASS="l">2690</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2691</TD><TD>                                final int len = list.size();</TD></TR><TR CLASS="z"><TD CLASS="l">2692</TD><TD>                                for (int i = 0; i &lt; len; i++)</TD></TR><TR><TD CLASS="l">2693</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">2694</TD><TD>                                        list.get(i).acceptUpdate(p_updated);</TD></TR><TR><TD CLASS="l">2695</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">2696</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2697</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2698</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="4a">2699</A></TD><TD> </TD></TR><TR><TD CLASS="l">2700</TD><TD>        private void notifyListeners(final ProductClassDataImpl p_updated, final ProductDataImpl p_newProduct)</TD></TR><TR><TD CLASS="l">2701</TD><TD>        {</TD></TR><TR><TD CLASS="l">2702</TD><TD>                final ArrayList&lt;ProductClassDataUpdateListener&gt; list;</TD></TR><TR CLASS="z"><TD CLASS="l">2703</TD><TD>                synchronized (productClassUpdateListeners)</TD></TR><TR><TD CLASS="l">2704</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2705</TD><TD>                        list = this.productClassUpdateListeners.get(p_updated.getClassKey());</TD></TR><TR CLASS="z"><TD CLASS="l">2706</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2707</TD><TD>                if (list != null)</TD></TR><TR><TD CLASS="l">2708</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2709</TD><TD>                        synchronized (list)</TD></TR><TR><TD CLASS="l">2710</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2711</TD><TD>                                final int len = list.size();</TD></TR><TR CLASS="z"><TD CLASS="l">2712</TD><TD>                                for (int i = 0; i &lt; len; i++)</TD></TR><TR><TD CLASS="l">2713</TD><TD>                                {</TD></TR><TR CLASS="z"><TD CLASS="l">2714</TD><TD>                                        if (p_newProduct != null)</TD></TR><TR><TD CLASS="l">2715</TD><TD>                                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2716</TD><TD>                                                list.get(i).acceptUpdate(p_updated);</TD></TR><TR><TD CLASS="l">2717</TD><TD>                                        }</TD></TR><TR><TD CLASS="l">2718</TD><TD>                                        else</TD></TR><TR><TD CLASS="l">2719</TD><TD>                                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2720</TD><TD>                                                list.get(i).acceptProductListUpdate(p_updated, p_newProduct);</TD></TR><TR><TD CLASS="l">2721</TD><TD>                                        }</TD></TR><TR><TD CLASS="l">2722</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">2723</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2724</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2725</TD><TD>                if (p_newProduct != null)</TD></TR><TR><TD CLASS="l">2726</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2727</TD><TD>                        notifyListeners(p_newProduct);</TD></TR><TR><TD CLASS="l">2728</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2729</TD><TD>        }</TD></TR><TR><TD CLASS="l">2730</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2731</TD><TD>         * Calls the sub method when the strategy is vertical or leg size is three.</TD></TR><TR><TD CLASS="l">2732</TD><TD>         * </TD></TR><TR><TD CLASS="l">2733</TD><TD>         * @author Cognizant Technology Solutions</TD></TR><TR><TD CLASS="l"><A NAME="20">2734</A></TD><TD>         */</TD></TR><TR><TD CLASS="l">2735</TD><TD>        private final void calculatePriceProtectionForStrategy(ProductDataImpl product) {</TD></TR><TR><TD CLASS="l">2736</TD><TD>                try</TD></TR><TR><TD CLASS="l">2737</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2738</TD><TD>                        if (product.isStrategy() &amp;&amp; product.getStrategyType() == StrategyTypes.VERTICAL) {</TD></TR><TR CLASS="z"><TD CLASS="l">2739</TD><TD>                                calculatePriceProtectionForVerticalStrategy(product);</TD></TR><TR><TD CLASS="l">2740</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2741</TD><TD>                        if (product.isStrategy() &amp;&amp; product.getLegs().size() == 3) {</TD></TR><TR CLASS="z"><TD CLASS="l">2742</TD><TD>                                calculatePriceProtectionForThreeLegsStrategy(product);</TD></TR><TR><TD CLASS="l">2743</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2744</TD><TD>                }catch(Exception e)</TD></TR><TR><TD CLASS="l">2745</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2746</TD><TD>                        Log.exception(MsgBuilder.get().add(&#34; Failed for Strategy product key: [&#34; + product.getProductKey() + &#34;] caused &#34;+e).end(), e);</TD></TR><TR CLASS="z"><TD CLASS="l">2747</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2748</TD><TD>        }</TD></TR><TR><TD CLASS="l">2749</TD><TD> </TD></TR><TR><TD CLASS="l">2750</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2751</TD><TD>     * It calculates the reasonable price for both the verticals (Call Call and Put Put).</TD></TR><TR><TD CLASS="l">2752</TD><TD>     * </TD></TR><TR><TD CLASS="l">2753</TD><TD>     * @author Cognizant Technology Solutions</TD></TR><TR><TD CLASS="l"><A NAME="23">2754</A></TD><TD>     * @param product</TD></TR><TR><TD CLASS="l">2755</TD><TD>     * @return</TD></TR><TR><TD CLASS="l">2756</TD><TD>     */</TD></TR><TR><TD CLASS="l">2757</TD><TD>    public void calculatePriceProtectionForVerticalStrategy(ProductDataImpl product) {</TD></TR><TR CLASS="z"><TD CLASS="l">2758</TD><TD>        int priceDifference = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2759</TD><TD>        ProductLegData firstLeg = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2760</TD><TD>        ProductLegData secondLeg = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2761</TD><TD>        firstLeg = product.getLegs().get(0);</TD></TR><TR CLASS="z"><TD CLASS="l">2762</TD><TD>        secondLeg = product.getLegs().get(1);</TD></TR><TR CLASS="z"><TD CLASS="l">2763</TD><TD>        final  ProductData firstLegData = allProdData.get(firstLeg.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">2764</TD><TD>        final  ProductData secondLegData = allProdData.get(secondLeg.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">2765</TD><TD>        if(firstLegData == null || secondLegData == null)</TD></TR><TR><TD CLASS="l">2766</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2767</TD><TD>            return;</TD></TR><TR><TD CLASS="l">2768</TD><TD>        }</TD></TR><TR><TD CLASS="l">2769</TD><TD> </TD></TR><TR><TD CLASS="l">2770</TD><TD>        // When both legs are CALL.</TD></TR><TR CLASS="z"><TD CLASS="l">2771</TD><TD>        if ( firstLegData.getOptionType() == OptionTypes.CALL</TD></TR><TR><TD CLASS="l">2772</TD><TD>                &amp;&amp;  secondLegData.getOptionType() == OptionTypes.CALL) {</TD></TR><TR CLASS="z"><TD CLASS="l">2773</TD><TD>            priceDifference = calculatePriceDifferenceForVerticles(firstLeg, secondLeg, firstLegData, secondLegData);</TD></TR><TR CLASS="z"><TD CLASS="l">2774</TD><TD>            product.setPriceProtectionForStrategy(priceDifference);</TD></TR><TR><TD CLASS="l">2775</TD><TD>        }</TD></TR><TR><TD CLASS="l">2776</TD><TD>        // When both legs are PUT.</TD></TR><TR CLASS="z"><TD CLASS="l">2777</TD><TD>        else if (firstLegData.getOptionType() == OptionTypes.PUT</TD></TR><TR><TD CLASS="l">2778</TD><TD>                &amp;&amp; secondLegData.getOptionType() == OptionTypes.PUT) {</TD></TR><TR CLASS="z"><TD CLASS="l">2779</TD><TD>            priceDifference = calculatePriceDifferenceForVerticles(firstLeg, secondLeg, firstLegData, secondLegData);</TD></TR><TR CLASS="z"><TD CLASS="l">2780</TD><TD>            product.setPriceProtectionForStrategy(priceDifference * -1);</TD></TR><TR><TD CLASS="l">2781</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2782</TD><TD>    }</TD></TR><TR><TD CLASS="l">2783</TD><TD> </TD></TR><TR><TD CLASS="l">2784</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2785</TD><TD>         * It calculates the price difference between exercise prices of two legs</TD></TR><TR><TD CLASS="l">2786</TD><TD>         * (sellSidePrice and buySidePrice) of vertical strategy.If difference is</TD></TR><TR><TD CLASS="l">2787</TD><TD>         * positive,it sets it to 1;if it is negative, sets it to -1 and if the</TD></TR><TR><TD CLASS="l">2788</TD><TD>         * difference is 0, sets it to 0.</TD></TR><TR><TD CLASS="l">2789</TD><TD>         * </TD></TR><TR><TD CLASS="l">2790</TD><TD>         * @author Cognizant Technology Solutions</TD></TR><TR><TD CLASS="l">2791</TD><TD>         * @param firstLeg</TD></TR><TR><TD CLASS="l">2792</TD><TD>         * @param secondLeg</TD></TR><TR><TD CLASS="l">2793</TD><TD>         * @param firstLegData</TD></TR><TR><TD CLASS="l">2794</TD><TD>         * @param secondLegData</TD></TR><TR><TD CLASS="l"><A NAME="1f">2795</A></TD><TD>         * @return priceDifference</TD></TR><TR><TD CLASS="l">2796</TD><TD>         */</TD></TR><TR><TD CLASS="l">2797</TD><TD>        public int calculatePriceDifferenceForVerticles(final ProductLegData firstLeg,</TD></TR><TR><TD CLASS="l">2798</TD><TD>                        final ProductLegData secondLeg, final ProductData firstLegData, final ProductData secondLegData) {</TD></TR><TR CLASS="z"><TD CLASS="l">2799</TD><TD>                Price buySidePrice = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2800</TD><TD>                Price sellSidePrice = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2801</TD><TD>                if (Sides.BUY==firstLeg.getSide() &amp;&amp; Sides.SELL==secondLeg.getSide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2802</TD><TD>                        buySidePrice = firstLegData.getExercisePrice();</TD></TR><TR CLASS="z"><TD CLASS="l">2803</TD><TD>                        sellSidePrice = secondLegData.getExercisePrice();</TD></TR><TR CLASS="z"><TD CLASS="l">2804</TD><TD>                } else if (Sides.SELL==firstLeg.getSide() &amp;&amp; Sides.BUY==secondLeg.getSide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2805</TD><TD>                        sellSidePrice = firstLegData.getExercisePrice();</TD></TR><TR CLASS="z"><TD CLASS="l">2806</TD><TD>                        buySidePrice = secondLegData.getExercisePrice();</TD></TR><TR><TD CLASS="l">2807</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2808</TD><TD>                if(buySidePrice!=null &amp;&amp; sellSidePrice!=null)</TD></TR><TR CLASS="z"><TD CLASS="l">2809</TD><TD>                        return getStrategyPriceProtection(sellSidePrice.toDouble()-buySidePrice.toDouble());</TD></TR><TR><TD CLASS="l">2810</TD><TD>                else</TD></TR><TR CLASS="z"><TD CLASS="l">2811</TD><TD>                        return getStrategyPriceProtection(0);</TD></TR><TR><TD CLASS="l"><A NAME="47">2812</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">2813</TD><TD> </TD></TR><TR><TD CLASS="l">2814</TD><TD>        public int getStrategyPriceProtection(double priceDifference)</TD></TR><TR><TD CLASS="l">2815</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2816</TD><TD>                if(priceDifference &gt; 0)</TD></TR><TR CLASS="z"><TD CLASS="l">2817</TD><TD>                        return TradingProduct.CREDIT;</TD></TR><TR CLASS="z"><TD CLASS="l">2818</TD><TD>                else if(priceDifference &lt; 0)</TD></TR><TR CLASS="z"><TD CLASS="l">2819</TD><TD>                        return TradingProduct.DEBIT;</TD></TR><TR><TD CLASS="l">2820</TD><TD>                else</TD></TR><TR CLASS="z"><TD CLASS="l">2821</TD><TD>                        return 0;</TD></TR><TR><TD CLASS="l">2822</TD><TD>        }</TD></TR><TR><TD CLASS="l">2823</TD><TD> </TD></TR><TR><TD CLASS="l">2824</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2825</TD><TD>     * It takes all the products one by one from the allProdData cache and</TD></TR><TR><TD CLASS="l">2826</TD><TD>     * calculate the price difference if product is of strategy type.</TD></TR><TR><TD CLASS="l">2827</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="21">2828</A></TD><TD>     * @author Cognizant Technology Solutions</TD></TR><TR><TD CLASS="l">2829</TD><TD>     * @return void</TD></TR><TR><TD CLASS="l">2830</TD><TD>     */</TD></TR><TR><TD CLASS="l">2831</TD><TD>    public void calculatePriceProtectionForStrategyProducts(){</TD></TR><TR CLASS="z"><TD CLASS="l">2832</TD><TD>        for ( IntMapEntry&lt;ProductDataImpl&gt; products : allProdData.entrySet())</TD></TR><TR><TD CLASS="l">2833</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2834</TD><TD>            ProductDataImpl product = products.getValue();</TD></TR><TR CLASS="z"><TD CLASS="l">2835</TD><TD>            if(product != null &amp;&amp; product.isStrategy()){</TD></TR><TR CLASS="z"><TD CLASS="l">2836</TD><TD>                calculatePriceProtectionForStrategy(product);</TD></TR><TR><TD CLASS="l">2837</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2838</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2839</TD><TD>        this.isPriceProtectionCalculationDoneForStrategy=true;</TD></TR><TR CLASS="z"><TD CLASS="l">2840</TD><TD>    }</TD></TR><TR><TD CLASS="l">2841</TD><TD> </TD></TR><TR><TD CLASS="l">2842</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2843</TD><TD>     * It calculates the reasonable price for the three legs wherein the legs</TD></TR><TR><TD CLASS="l">2844</TD><TD>     * have summation of their ratio as 4, have the same expiration month and</TD></TR><TR><TD CLASS="l">2845</TD><TD>     * belong to Call Call Call or Put Put put group. Whichever leg has ratio 2</TD></TR><TR><TD CLASS="l">2846</TD><TD>     * is considered to be the second leg.</TD></TR><TR><TD CLASS="l">2847</TD><TD>     * </TD></TR><TR><TD CLASS="l">2848</TD><TD>     * @author Cognizant Technology Solutions</TD></TR><TR><TD CLASS="l"><A NAME="22">2849</A></TD><TD>     * @param product</TD></TR><TR><TD CLASS="l">2850</TD><TD>     * @return</TD></TR><TR><TD CLASS="l">2851</TD><TD>     */</TD></TR><TR><TD CLASS="l">2852</TD><TD>    private final void calculatePriceProtectionForThreeLegsStrategy(ProductDataImpl product) {</TD></TR><TR CLASS="z"><TD CLASS="l">2853</TD><TD>        int priceDifference = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2854</TD><TD>        ProductLegData firstLeg = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2855</TD><TD>        ProductLegData secondLeg = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2856</TD><TD>        ProductLegData thirdLeg = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2857</TD><TD>        Price firstPrice = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2858</TD><TD>        Price middlePrice = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2859</TD><TD>        Price thirdPrice = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2860</TD><TD>        Double averagePrice = 0.0;</TD></TR><TR CLASS="z"><TD CLASS="l">2861</TD><TD>        List&lt;ProductLegData&gt; legs = product.getLegs();</TD></TR><TR CLASS="z"><TD CLASS="l">2862</TD><TD>        int ratioCount =0;</TD></TR><TR CLASS="z"><TD CLASS="l">2863</TD><TD>        for(ProductLegData leg:legs)</TD></TR><TR><TD CLASS="l">2864</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2865</TD><TD>            ratioCount+=leg.getRatioQuantity();</TD></TR><TR><TD CLASS="l">2866</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2867</TD><TD>        if (ratioCount==4){</TD></TR><TR CLASS="z"><TD CLASS="l">2868</TD><TD>            if(legs.get(0).getRatioQuantity()==legs.get(1).getRatioQuantity())</TD></TR><TR><TD CLASS="l">2869</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2870</TD><TD>                firstLeg = legs.get(0);</TD></TR><TR CLASS="z"><TD CLASS="l">2871</TD><TD>                secondLeg = legs.get(2);</TD></TR><TR CLASS="z"><TD CLASS="l">2872</TD><TD>                thirdLeg = legs.get(1);</TD></TR><TR><TD CLASS="l">2873</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2874</TD><TD>            else if (legs.get(1).getRatioQuantity()==legs.get(2).getRatioQuantity())</TD></TR><TR><TD CLASS="l">2875</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2876</TD><TD>                firstLeg = legs.get(1);</TD></TR><TR CLASS="z"><TD CLASS="l">2877</TD><TD>                secondLeg = legs.get(0);</TD></TR><TR CLASS="z"><TD CLASS="l">2878</TD><TD>                thirdLeg = legs.get(2);</TD></TR><TR><TD CLASS="l">2879</TD><TD>            }</TD></TR><TR><TD CLASS="l">2880</TD><TD>            else</TD></TR><TR><TD CLASS="l">2881</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2882</TD><TD>                firstLeg = legs.get(0);</TD></TR><TR CLASS="z"><TD CLASS="l">2883</TD><TD>                secondLeg = legs.get(1);</TD></TR><TR CLASS="z"><TD CLASS="l">2884</TD><TD>                thirdLeg = legs.get(2);</TD></TR><TR><TD CLASS="l">2885</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2886</TD><TD>            final  ProductData firstLegData = allProdData.get(firstLeg.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">2887</TD><TD>            final  ProductData secondLegData = allProdData.get(secondLeg.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">2888</TD><TD>            final  ProductData thirdLegData = allProdData.get(thirdLeg.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">2889</TD><TD>            if(firstLegData == null || secondLegData == null || thirdLegData == null)</TD></TR><TR><TD CLASS="l">2890</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2891</TD><TD>                return;</TD></TR><TR><TD CLASS="l">2892</TD><TD>            }</TD></TR><TR><TD CLASS="l">2893</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2894</TD><TD>            byte month=firstLegData.getExpirationDate().month;</TD></TR><TR CLASS="z"><TD CLASS="l">2895</TD><TD>            short year=firstLegData.getExpirationDate().year;</TD></TR><TR CLASS="z"><TD CLASS="l">2896</TD><TD>            if(month==secondLegData.getExpirationDate().month &amp;&amp; month==thirdLegData.getExpirationDate().month</TD></TR><TR><TD CLASS="l">2897</TD><TD>                    &amp;&amp; year==secondLegData.getExpirationDate().year &amp;&amp; year==thirdLegData.getExpirationDate().year)</TD></TR><TR><TD CLASS="l">2898</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2899</TD><TD>                firstPrice = firstLegData.getExercisePrice();</TD></TR><TR CLASS="z"><TD CLASS="l">2900</TD><TD>                middlePrice = secondLegData.getExercisePrice();</TD></TR><TR CLASS="z"><TD CLASS="l">2901</TD><TD>                thirdPrice = thirdLegData.getExercisePrice();</TD></TR><TR CLASS="z"><TD CLASS="l">2902</TD><TD>                averagePrice = ((firstPrice.toDouble()+thirdPrice.toDouble())/2);</TD></TR><TR><TD CLASS="l">2903</TD><TD>                // When all legs are CALL.</TD></TR><TR CLASS="z"><TD CLASS="l">2904</TD><TD>                if ((firstLegData.getClassKey() == secondLegData.getClassKey() &amp;&amp; secondLegData.getClassKey() == thirdLegData.getClassKey())</TD></TR><TR><TD CLASS="l">2905</TD><TD>                        &amp;&amp; firstLeg.getRatioQuantity() == 1 &amp;&amp; secondLeg.getRatioQuantity() == 2 &amp;&amp; thirdLeg.getRatioQuantity() == 1){</TD></TR><TR CLASS="z"><TD CLASS="l">2906</TD><TD>                    if ( firstLegData.getOptionType() == OptionTypes.CALL</TD></TR><TR><TD CLASS="l">2907</TD><TD>                            &amp;&amp;  secondLegData.getOptionType() == OptionTypes.CALL &amp;&amp; thirdLegData.getOptionType() == OptionTypes.CALL) {</TD></TR><TR CLASS="z"><TD CLASS="l">2908</TD><TD>                        priceDifference = calculatePriceDifferenceForCall(firstLeg, secondLeg, thirdLeg, middlePrice, averagePrice);</TD></TR><TR><TD CLASS="l">2909</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2910</TD><TD>                    // When all legs are PUT.</TD></TR><TR CLASS="z"><TD CLASS="l">2911</TD><TD>                    else if (firstLegData.getOptionType()    == OptionTypes.PUT</TD></TR><TR><TD CLASS="l">2912</TD><TD>                            &amp;&amp; secondLegData.getOptionType() == OptionTypes.PUT &amp;&amp; thirdLegData.getOptionType() == OptionTypes.PUT) {</TD></TR><TR CLASS="z"><TD CLASS="l">2913</TD><TD>                        priceDifference = calculatePriceDifferenceForPut(firstLeg, secondLeg, thirdLeg, middlePrice, averagePrice);</TD></TR><TR><TD CLASS="l">2914</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">2915</TD><TD>                    product.setPriceProtectionForStrategy(priceDifference);</TD></TR><TR><TD CLASS="l">2916</TD><TD>                }</TD></TR><TR><TD CLASS="l">2917</TD><TD>            }</TD></TR><TR><TD CLASS="l">2918</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2919</TD><TD>    }</TD></TR><TR><TD CLASS="l">2920</TD><TD> </TD></TR><TR><TD CLASS="l">2921</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2922</TD><TD>         * It calculates the price difference between legs of call group.Middle</TD></TR><TR><TD CLASS="l">2923</TD><TD>         * price (price of second leg) is compared with the average price of first</TD></TR><TR><TD CLASS="l">2924</TD><TD>         * and third legs.If middle price is greater than average price, we check</TD></TR><TR><TD CLASS="l">2925</TD><TD>         * whether the three legs form Buy sell Buy group or Sell Buy Sell group.If</TD></TR><TR><TD CLASS="l">2926</TD><TD>         * it is Buy Sell Buy,+1 is returned and if it is Sell Buy Sell group, -1 is</TD></TR><TR><TD CLASS="l">2927</TD><TD>         * returned.</TD></TR><TR><TD CLASS="l">2928</TD><TD>         * </TD></TR><TR><TD CLASS="l">2929</TD><TD>         * @author Cognizant Technology Solutions</TD></TR><TR><TD CLASS="l">2930</TD><TD>         * @param firstLeg</TD></TR><TR><TD CLASS="l">2931</TD><TD>         * @param secondLeg</TD></TR><TR><TD CLASS="l">2932</TD><TD>         * @param thirdLeg</TD></TR><TR><TD CLASS="l">2933</TD><TD>         * @param middlePrice</TD></TR><TR><TD CLASS="l">2934</TD><TD>         * @param averagePrice</TD></TR><TR><TD CLASS="l">2935</TD><TD>         * @return priceDifference</TD></TR><TR><TD CLASS="l">2936</TD><TD>         */</TD></TR><TR><TD CLASS="l"><A NAME="1d">2937</A></TD><TD>        public int calculatePriceDifferenceForCall(final ProductLegData firstLeg,</TD></TR><TR><TD CLASS="l">2938</TD><TD>                        final ProductLegData secondLeg, final ProductLegData thirdLeg, final Price middlePrice,</TD></TR><TR><TD CLASS="l">2939</TD><TD>                        Double averagePrice) {</TD></TR><TR><TD CLASS="l">2940</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2941</TD><TD>                if (middlePrice.toDouble() &gt;= averagePrice) {</TD></TR><TR CLASS="z"><TD CLASS="l">2942</TD><TD>                        if (Sides.BUY == firstLeg.getSide() &amp;&amp; Sides.SELL == secondLeg.getSide()</TD></TR><TR><TD CLASS="l">2943</TD><TD>                                        &amp;&amp; Sides.BUY == thirdLeg.getSide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2944</TD><TD>                                return TradingProduct.CREDIT;</TD></TR><TR CLASS="z"><TD CLASS="l">2945</TD><TD>                        } else if (Sides.SELL == firstLeg.getSide() &amp;&amp; Sides.BUY == secondLeg.getSide()</TD></TR><TR><TD CLASS="l">2946</TD><TD>                                        &amp;&amp; Sides.SELL == thirdLeg.getSide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2947</TD><TD>                                return TradingProduct.DEBIT;</TD></TR><TR><TD CLASS="l">2948</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2949</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2950</TD><TD>                return 0;</TD></TR><TR><TD CLASS="l">2951</TD><TD>        }</TD></TR><TR><TD CLASS="l">2952</TD><TD> </TD></TR><TR><TD CLASS="l">2953</TD><TD>        /**</TD></TR><TR><TD CLASS="l">2954</TD><TD>         * It calculates the price difference between legs of put group.Middle</TD></TR><TR><TD CLASS="l">2955</TD><TD>         * price (price of second leg) is compared with the average price of first</TD></TR><TR><TD CLASS="l">2956</TD><TD>         * and third legs.If middle price is less than average price, we check</TD></TR><TR><TD CLASS="l">2957</TD><TD>         * whether the three legs form Buy sell Buy group or Sell Buy Sell group.If</TD></TR><TR><TD CLASS="l">2958</TD><TD>         * it is Buy Sell Buy,+1 is returned and if it is Sell Buy Sell group, -1 is</TD></TR><TR><TD CLASS="l">2959</TD><TD>         * returned.</TD></TR><TR><TD CLASS="l">2960</TD><TD>         * </TD></TR><TR><TD CLASS="l">2961</TD><TD>         * @author Cognizant Technology Solutions</TD></TR><TR><TD CLASS="l">2962</TD><TD>         * @param firstLeg</TD></TR><TR><TD CLASS="l">2963</TD><TD>         * @param secondLeg</TD></TR><TR><TD CLASS="l">2964</TD><TD>         * @param thirdLeg</TD></TR><TR><TD CLASS="l">2965</TD><TD>         * @param middlePrice</TD></TR><TR><TD CLASS="l">2966</TD><TD>         * @param averagePrice</TD></TR><TR><TD CLASS="l">2967</TD><TD>         * @return priceDifference</TD></TR><TR><TD CLASS="l">2968</TD><TD>         */</TD></TR><TR><TD CLASS="l"><A NAME="1e">2969</A></TD><TD>        private final int calculatePriceDifferenceForPut(final ProductLegData firstLeg,</TD></TR><TR><TD CLASS="l">2970</TD><TD>                        final ProductLegData secondLeg, final ProductLegData thirdLeg, final Price middlePrice,</TD></TR><TR><TD CLASS="l">2971</TD><TD>                        Double averagePrice) {</TD></TR><TR><TD CLASS="l">2972</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2973</TD><TD>                if (middlePrice.toDouble() &lt;= averagePrice) {</TD></TR><TR CLASS="z"><TD CLASS="l">2974</TD><TD>                        if (Sides.BUY == firstLeg.getSide() &amp;&amp; Sides.SELL == secondLeg.getSide()</TD></TR><TR><TD CLASS="l">2975</TD><TD>                                        &amp;&amp; Sides.BUY == thirdLeg.getSide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2976</TD><TD>                                return TradingProduct.CREDIT;</TD></TR><TR CLASS="z"><TD CLASS="l">2977</TD><TD>                        } else if (Sides.SELL == firstLeg.getSide() &amp;&amp; Sides.BUY == secondLeg.getSide()</TD></TR><TR><TD CLASS="l">2978</TD><TD>                                        &amp;&amp; Sides.SELL == thirdLeg.getSide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2979</TD><TD>                                return TradingProduct.DEBIT;</TD></TR><TR><TD CLASS="l">2980</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2981</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2982</TD><TD>                return 0;</TD></TR><TR><TD CLASS="l"><A NAME="4d">2983</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">2984</TD><TD>        </TD></TR><TR><TD CLASS="l">2985</TD><TD>        private final int parseNonZeroIntKeyParam(String nonZeroIntKeyParam)</TD></TR><TR><TD CLASS="l">2986</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2987</TD><TD>            if (nonZeroIntKeyParam==null) return 0;</TD></TR><TR><TD CLASS="l">2988</TD><TD>            try</TD></TR><TR><TD CLASS="l">2989</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2990</TD><TD>                return Integer.parseInt(nonZeroIntKeyParam);</TD></TR><TR><TD CLASS="l">2991</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2992</TD><TD>            catch (Exception e)</TD></TR><TR><TD CLASS="l">2993</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2994</TD><TD>                return 0;</TD></TR><TR><TD CLASS="l">2995</TD><TD>            }</TD></TR><TR><TD CLASS="l"><A NAME="32">2996</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">2997</TD><TD>        </TD></TR><TR><TD CLASS="l">2998</TD><TD>        final void dump(MsgBuilder buf, String classKeyParam, String prodKeyParam)</TD></TR><TR><TD CLASS="l">2999</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3000</TD><TD>            int classToCheck = parseNonZeroIntKeyParam(classKeyParam);</TD></TR><TR CLASS="z"><TD CLASS="l">3001</TD><TD>            if (classToCheck&gt;0)</TD></TR><TR><TD CLASS="l">3002</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3003</TD><TD>                int prodToCheck = parseNonZeroIntKeyParam(prodKeyParam);</TD></TR><TR CLASS="z"><TD CLASS="l">3004</TD><TD>                if (prodToCheck&gt;0)</TD></TR><TR CLASS="z"><TD CLASS="l">3005</TD><TD>                    dumpOneProd(buf, prodToCheck);</TD></TR><TR><TD CLASS="l">3006</TD><TD>                else</TD></TR><TR CLASS="z"><TD CLASS="l">3007</TD><TD>                    dumpOneClass(buf, classToCheck);</TD></TR><TR CLASS="z"><TD CLASS="l">3008</TD><TD>            }</TD></TR><TR><TD CLASS="l">3009</TD><TD>            else</TD></TR><TR><TD CLASS="l">3010</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3011</TD><TD>                dumpAll(buf);</TD></TR><TR><TD CLASS="l">3012</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="33">3013</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">3014</TD><TD>        </TD></TR><TR><TD CLASS="l">3015</TD><TD>        private final void dumpAll(MsgBuilder buf)</TD></TR><TR><TD CLASS="l">3016</TD><TD>        {            </TD></TR><TR CLASS="z"><TD CLASS="l">3017</TD><TD>            buf.add(&#34;###start prod cache dump###\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3018</TD><TD>        for (int classKey : allProdClassData.keySet())</TD></TR><TR><TD CLASS="l">3019</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3020</TD><TD>            dumpOneClass(buf, classKey); </TD></TR><TR><TD CLASS="l">3021</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3022</TD><TD>        buf.add(&#34;###end prod cache dump###\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="35">3023</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">3024</TD><TD>        </TD></TR><TR><TD CLASS="l">3025</TD><TD>        private final void dumpOneProd(MsgBuilder buf, int prodKey)</TD></TR><TR><TD CLASS="l">3026</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3027</TD><TD>            ProductData prodData = allProdData.get(prodKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3028</TD><TD>        buf.add(prodKey).add(&#34;\n&#34;).add(prodData);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="34">3029</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">3030</TD><TD>        </TD></TR><TR><TD CLASS="l">3031</TD><TD>        private final void dumpOneClass(MsgBuilder buf, int classKey)</TD></TR><TR><TD CLASS="l">3032</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3033</TD><TD>            final String delim = &#34;=&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">3034</TD><TD>            final String delim2 = &#34;\n&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">3035</TD><TD>            ProductClassData classData = null;</TD></TR><TR CLASS="z"><TD CLASS="l">3036</TD><TD>        classData = allProdClassData.get(classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3037</TD><TD>        buf.add(&#34;dump class::&#34;).add(classKey).add(delim2).add(classData);</TD></TR><TR CLASS="z"><TD CLASS="l">3038</TD><TD>        int[] prodKeys = classData.getProductKeys();</TD></TR><TR CLASS="z"><TD CLASS="l">3039</TD><TD>        buf.add(&#34;prod data underneath, total of &#34;).add(prodKeys.length).add(prodKeys.length==0?&#34;&#34;:&#34; --&#34;).add(delim2);</TD></TR><TR CLASS="z"><TD CLASS="l">3040</TD><TD>        for (int prodKey : prodKeys)</TD></TR><TR><TD CLASS="l">3041</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3042</TD><TD>            dumpOneProd(buf, prodKey);</TD></TR><TR><TD CLASS="l">3043</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3044</TD><TD>        buf.add(&#34;end dump class::&#34;).add(classKey).add(delim2);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3f">3045</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">3046</TD><TD> </TD></TR><TR><TD CLASS="l">3047</TD><TD>    public long getLocalProductDataCacheCount()</TD></TR><TR><TD CLASS="l">3048</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3049</TD><TD>        return this.allProdData.size();</TD></TR><TR><TD CLASS="l">3050</TD><TD>    }</TD></TR><TR><TD CLASS="l">3051</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="nv">[<A HREF="../coverage.html">all classes</A>][<A HREF="55.html">com.cboe.server.util.productData</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.0.5312</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>