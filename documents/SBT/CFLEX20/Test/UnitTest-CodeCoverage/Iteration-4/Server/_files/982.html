<HTML><HEAD><META CONTENT="text/html; charset=UTF-8" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="tl"><A HREF="http://www.eclemma.org/">EMMA</A> Coverage Report (generated Mon Aug 01 06:28:17 CDT 2011)</TH></TR><TR><TD CLASS="nv">[<A HREF="../Coverage.html">all classes</A>][<A HREF="72.html">com.cboe.internalBusinessServices.productStateService</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">ProductStateServiceLocalImpl.java</SPAN>]</H2><TABLE CELLSPACING="0" WIDTH="100%"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>ProductStateServiceLocalImpl.java</TD><TD CLASS="h">20%  (1/5)</TD><TD CLASS="h">11%  (16/146)</TD><TD CLASS="h">4%   (340/8543)</TD><TD CLASS="h">5%   (78.6/1593)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">ProductStateServiceLocalImpl$ProdStateTimerPropertyConusmer</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/114)</TD><TD CLASS="h">0%   (0/24)</TD></TR><TR><TD CLASS="f"><A HREF="#0">ProductStateServiceLocalImpl$ProdStateTimerPropertyConusmer (ProductStateServ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">channelUpdate (ChannelEvent): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/105)</TD><TD CLASS="h">0%   (0/21)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#3">ProductStateServiceLocalImpl$ProductBuildThread</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/627)</TD><TD CLASS="h">0%   (0/69)</TD></TR><TR><TD CLASS="f"><A HREF="#3">ProductStateServiceLocalImpl$ProductBuildThread (ProductStateServiceLocalImpl...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5">buildClass (ProductClassStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/135)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR><TD CLASS="f"><A HREF="#6">buildStrategyClass (ProductClassStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/255)</TD><TD CLASS="h">0%   (0/24)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7">createProducts (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/174)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR><TD CLASS="f"><A HREF="#8">run (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#9">shouldCreateProxyTradingClass (ProductClassStruct): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#a">ProductStateServiceLocalImpl$SessionStatusThread</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/508)</TD><TD CLASS="h">0%   (0/78)</TD></TR><TR><TD CLASS="f"><A HREF="#a">ProductStateServiceLocalImpl$SessionStatusThread (ProductStateServiceLocalImp...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/37)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">addClassToSession (String, TradingClass, SessionClassDetailStruct, long): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/112)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR><TD CLASS="f"><A HREF="#d">removeClassFromSession (String, TradingClass, SessionClassDetailStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/91)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#e">run (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/218)</TD><TD CLASS="h">0%   (0/31)</TD></TR><TR><TD CLASS="f"><A HREF="#f">setSessionStatusOfProducts (SessionClassDetailStruct, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/50)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#10">ProductStateServiceLocalImpl$TradingPropertyFetchThread</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/208)</TD><TD CLASS="h">0%   (0/31)</TD></TR><TR><TD CLASS="f"><A HREF="#10">ProductStateServiceLocalImpl$TradingPropertyFetchThread (ProductStateServiceL...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#12">loadProperties (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/126)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR><TD CLASS="f"><A HREF="#13">loadPropertyForClass (ProductClassStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">run (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/50)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#15">ProductStateServiceLocalImpl</A></TD><TD>100% (1/1)</TD><TD CLASS="h">12%  (16/129)</TD><TD CLASS="h">5%   (340/7086)</TD><TD CLASS="h">6%   (78.6/1391)</TD></TR><TR><TD CLASS="f"><A HREF="#16">access$0 (ProductStateServiceLocalImpl): HashMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#17">access$1 (ProductStateServiceLocalImpl, String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#18">access$2 (ProductStateServiceLocalImpl): HashMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#19">access$3 (ProductStateServiceLocalImpl, TradingSessionElementStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1a">addProduct (ProductStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/72)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1b">addProductImmediately (ProductStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/126)</TD><TD CLASS="h">0%   (0/27)</TD></TR><TR><TD CLASS="f"><A HREF="#1c">addStateChangeListener (StateChangeListener): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1d">addStrategy (StrategyStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/102)</TD><TD CLASS="h">0%   (0/20)</TD></TR><TR><TD CLASS="f"><A HREF="#1e">addStrategyImmediately (StrategyStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/104)</TD><TD CLASS="h">0%   (0/24)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1f">addVetoableStateChangeListener (VetoableStateChangeListener): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#20">adminForceAllProductStates (String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/39)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#21">adminForceProductStateByClass (String, String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/90)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR><TD CLASS="f"><A HREF="#22">adminGetTradingPropertyCachedByClass (String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/910)</TD><TD CLASS="h">0%   (0/163)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#23">adminIsDpmForClass (String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/44)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#24">adminIsEDpmForClass (String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/42)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#25">adminSetAllProductStates (String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/41)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#26">adminSetProductStateByClass (String, String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/123)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#27">adminSetProductStateByProduct (String, String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/51)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#28">adminShowAllProductStatesGroupBy (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/136)</TD><TD CLASS="h">0%   (0/24)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#29">adminShowProductTypeStateGroupBy (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/165)</TD><TD CLASS="h">0%   (0/26)</TD></TR><TR><TD CLASS="f"><A HREF="#2a">adminShowSeriesStateGroupBy (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/113)</TD><TD CLASS="h">0%   (0/20)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2b">areProductsInStateForOpeningRequest (TradingClass, short, short): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/100)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR><TD CLASS="f"><A HREF="#2c">buildProducts (ArrayList, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/86)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2d">changeSessionStatus (String, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#2e">changeSessionStatus (String, short, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2f">completeStateChange (TradingProductImpl, short, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#30">configureProducts (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/202)</TD><TD CLASS="h">0%   (0/36)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#31">convertProductStateToClassState (short): short</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/21)</TD></TR><TR><TD CLASS="f"><A HREF="#32">create (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#33">createBroker (TradingProduct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#34">createOrderBook (TradingProduct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#35">createProductStateTimer (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/39)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#36">createTradingPropertyConsumer (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/65)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#37">doProductStateChange (TradingProduct, short, boolean): ProductStateChangeCommand</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/75)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR><TD CLASS="f"><A HREF="#38">doSessionStatusUpdate (String, short, TradingSessionElementClassesDetailStruc...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/142)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#39">fetchTradingProperties (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/125)</TD><TD CLASS="h">0%   (0/25)</TD></TR><TR><TD CLASS="f"><A HREF="#3a">getClassKeysForBuddyClasses (): int []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/38)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3b">getCurrentMarketStateChangePublisher (): CurrentMarketStateChangeConsumer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/35)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#3c">getElementClassesForSession (String): TradingSessionElementClassesDetailStruc...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/147)</TD><TD CLASS="h">0%   (0/21)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3d">getFailedClassesName (ArrayList, ArrayList): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/57)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR><TD CLASS="f"><A HREF="#3e">getMyInterceptor (): ProductStateServiceLocal</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3f">getProductClassData (int): ProductClassData</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#40">getProductDataCache (int): ProductData</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#41">getProductName (TradingProduct): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/96)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR><TD CLASS="f"><A HREF="#42">getProductStatePublisher (): ProductStateConsumer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#43">getProductStateTimer (): HashMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#44">getProductStatesStruct (TradingProduct [], int): ProductStateStruct []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/49)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#45">getPropertyConsumerHome (): PropertyConsumerHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#46">getSettlementPricesForClass (String, ClassSettlementStruct): ClassSettlementS...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/71)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#47">getSleepInterval (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#48">getStateAsString (short): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#49">getTradingClass (int): TradingClass</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#4a">getTradingClassHome (): TradingClassHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4b">getTradingClassSessionElementMap (): HashMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#4c">getTradingProduct (int): TradingProduct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4d">getTradingSessionElementStructForClass (int): TradingSessionElementStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/18)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#4e">getTradingSessionElements (String): TradingSessionElementStruct []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4f">handleCommand (TradingProduct, ProductStateChangeCommand): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#50">isClassKey (String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#51">isHaltRequestWhileDerivativeIsInPreOpenState (TradingClass, short): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/37)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#52">isProductStateTimerOnBC (String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/84)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#53">isSpreadTradeServer (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#54">notifyListenersForProductStateChange (TradingProduct [], int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/42)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#55">notifyVetoableStateChangeListeners (TradingProduct, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#56">populateTradingClassSessionElementMap (TradingSessionElementStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/43)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#57">populateTradingSessionElement (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/43)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR><TD CLASS="f"><A HREF="#58">populateTradingSessionElement (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/75)</TD><TD CLASS="h">0%   (0/20)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#59">postInitialize (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#5a">processStateChangeForDerivative (TradingClass, int, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/200)</TD><TD CLASS="h">0%   (0/25)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5b">publishClassStateChange (TradingClass, short, ProductStateConsumer): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#5c">publishProductStateChange (TradingProduct [], boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5d">publishProductStateChange (TradingProduct [], int, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/122)</TD><TD CLASS="h">0%   (0/22)</TD></TR><TR><TD CLASS="f"><A HREF="#5e">publishProductStateChange (TradingProduct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5f">publishProductStateChangeToCurrentMarket (TradingProduct [], CurrentMarketSta...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/112)</TD><TD CLASS="h">0%   (0/27)</TD></TR><TR><TD CLASS="f"><A HREF="#60">publishProductStatesForClasses (int [], String, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/393)</TD><TD CLASS="h">0%   (0/73)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#61">publishProductStatesForGroupForSession (String, String, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/82)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR><TD CLASS="f"><A HREF="#62">publishProductStatesForOpenSession (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/80)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#63">publishProductStatesForSession (String, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/69)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR><TD CLASS="f"><A HREF="#64">registerTimer (ProductStateChangeTimer, int, TradingSessionElementStruct, lon...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/69)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#65">removeStateChangeListener (StateChangeListener): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#66">removeTimer (ProductStateChangeTimer): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/36)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#67">removeVetoableStateChangeListener (VetoableStateChangeListener): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#68">resetTimer (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#69">resetTimer (TradingSessionElementStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/157)</TD><TD CLASS="h">0%   (0/28)</TD></TR><TR><TD CLASS="f"><A HREF="#6a">setAllProductStates (String, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6b">setAllProductStates (String, short, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/61)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR><TD CLASS="f"><A HREF="#6c">setEnableProductStateChangeByUnderlying (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6d">setFastProductStateForSTSEnabledClass (TradingProduct, short, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#6e">setListingStateByClass (int, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6f">setListingStateByProduct (int, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#70">setMaxCountCurMktStatsForClassPerMessage (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#71">setMaximumClassStateChangeThread (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#72">setMinimumClassStateChangePerThread (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#73">setNumberBuildThreads (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#74">setNumberOfClassesToPublish (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#75">setProductState (TradingProduct, short, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#76">setProductStateByClass (String, int, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#77">setProductStateByClass (String, int, short, boolean): ErrorCodeResultStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/118)</TD><TD CLASS="h">0%   (0/20)</TD></TR><TR><TD CLASS="f"><A HREF="#78">setProductStateByClass (TradingClass, short, boolean): ErrorCodeResultStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/168)</TD><TD CLASS="h">0%   (0/38)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#79">setProductStateByClassLocal (String, int, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/56)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#7a">setProductStateByClassV2 (String, int, short): ErrorCodeResultStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7b">setProductStateByProduct (String, int, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR><TD CLASS="f"><A HREF="#7c">setProductStateBySymbol (String, short, boolean): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/109)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7d">setProductStateWhenCurrentTransactionSuccessful (TradingProduct, short, boole...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#7e">setProductStatesForSelectedClasses (TradingClass [], short, boolean, boolean)...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/93)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7f">setPublishInterval (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#80">setSleepInterval (long): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#81">showAllProductStatesIncludingProxiesCallback (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/57)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#82">stringifyStruct (Object, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#83">toTimerTypeString (int): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#84">tradingSessionEvent (TradingSessionEventType, TradingSessionStruct, Object): ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/69)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#85">updateTradingSessionElement (TradingSessionElementStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/36)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#86">writeNumericKeysToString (int []): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/46)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#87">acceptUnderlyingProductState (int, short): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">4%   (4/106)</TD><TD CLASS="h">10%  (2/20)</TD></TR><TR><TD CLASS="f"><A HREF="#88">assertNotNull (Object, String): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">21%  (3/14)</TD><TD CLASS="h">50%  (2/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#89">initializeCacheForOpening (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>80%  (64/80)</TD><TD>86%  (12/14)</TD></TR><TR><TD CLASS="f"><A HREF="#8a">getUnderlyingProductKeys (): int []</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>92%  (33/36)</TD><TD>98%  (6.8/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8b">dumpDerivativeByUnderlyingMap (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>97%  (85/88)</TD><TD>99%  (12.9/13)</TD></TR><TR><TD CLASS="f"><A HREF="#15">&lt;static initializer&gt;</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (11/11)</TD><TD>100% (4/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8d">ProductStateServiceLocalImpl (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (65/65)</TD><TD>100% (14/14)</TD></TR><TR><TD CLASS="f"><A HREF="#8e">postStart (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (43/43)</TD><TD>100% (9/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8f">setBrokerHome (BrokerHome): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#90">setMarketDataHome (MarketDataHome): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#91">setOrderBookHome (OrderBookHome): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#92">setProductDataCacheHome (ProductDataCacheHome): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#93">setTradingClassHome (TradingClassHome): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#94">setTradingProductHome (TradingProductHome): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#95">setTradingSessionService (TradingSessionService): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#96">setUnderlyingMapSize (int): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (2/2)</TD></TR></TABLE><P></P><TABLE CLASS="s" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="l">1</TD><TD>package com.cboe.internalBusinessServices.productStateService;</TD></TR><TR><TD CLASS="l">2</TD><TD> </TD></TR><TR><TD CLASS="l">3</TD><TD>// fixme - need to look at transactions</TD></TR><TR><TD CLASS="l">4</TD><TD> </TD></TR><TR><TD CLASS="l">5</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">6</TD><TD>import java.util.Enumeration;</TD></TR><TR><TD CLASS="l">7</TD><TD>import java.util.HashMap;</TD></TR><TR><TD CLASS="l">8</TD><TD>import java.util.Iterator;</TD></TR><TR><TD CLASS="l">9</TD><TD>import java.util.List;</TD></TR><TR><TD CLASS="l">10</TD><TD>import java.util.Set;</TD></TR><TR><TD CLASS="l">11</TD><TD> </TD></TR><TR><TD CLASS="l">12</TD><TD>import javax.swing.event.EventListenerList;</TD></TR><TR><TD CLASS="l">13</TD><TD> </TD></TR><TR><TD CLASS="l">14</TD><TD>import com.cboe.domain.dateTime.DateTimeImpl;</TD></TR><TR><TD CLASS="l">15</TD><TD>import com.cboe.domain.property.PropertyServiceFacadeHome;</TD></TR><TR><TD CLASS="l">16</TD><TD>import com.cboe.domain.tradingProperty.RolloutFlagByBCGroup;</TD></TR><TR><TD CLASS="l">17</TD><TD>import com.cboe.domain.tradingProperty.TradingPropertyFactoryHome;</TD></TR><TR><TD CLASS="l">18</TD><TD>import com.cboe.domain.tradingProperty.TradingPropertyTypeImpl;</TD></TR><TR><TD CLASS="l">19</TD><TD>import com.cboe.domain.util.DateWrapper;</TD></TR><TR><TD CLASS="l">20</TD><TD>import com.cboe.domain.util.StructBuilder;</TD></TR><TR><TD CLASS="l">21</TD><TD>import com.cboe.domain.util.TradingSessionNameHelper;</TD></TR><TR><TD CLASS="l">22</TD><TD>import com.cboe.domain.util.intMaps.ConcurrentIntHashMap;</TD></TR><TR><TD CLASS="l">23</TD><TD>import com.cboe.exceptions.AlreadyExistsException;</TD></TR><TR><TD CLASS="l">24</TD><TD>import com.cboe.exceptions.AuthorizationException;</TD></TR><TR><TD CLASS="l">25</TD><TD>import com.cboe.exceptions.CommunicationException;</TD></TR><TR><TD CLASS="l">26</TD><TD>import com.cboe.exceptions.DataValidationException;</TD></TR><TR><TD CLASS="l">27</TD><TD>import com.cboe.exceptions.NotAcceptedException;</TD></TR><TR><TD CLASS="l">28</TD><TD>import com.cboe.exceptions.NotFoundException;</TD></TR><TR><TD CLASS="l">29</TD><TD>import com.cboe.exceptions.OrderBookAlreadyExistsException;</TD></TR><TR><TD CLASS="l">30</TD><TD>import com.cboe.exceptions.SystemException;</TD></TR><TR><TD CLASS="l">31</TD><TD>import com.cboe.exceptions.TransactionFailedException;</TD></TR><TR><TD CLASS="l">32</TD><TD>import com.cboe.idl.cmiConstants.ClassStates;</TD></TR><TR><TD CLASS="l">33</TD><TD>import com.cboe.idl.cmiConstants.ClassStatesOperations;</TD></TR><TR><TD CLASS="l">34</TD><TD>import com.cboe.idl.cmiConstants.ProductClass;</TD></TR><TR><TD CLASS="l">35</TD><TD>import com.cboe.idl.cmiConstants.ProductStates;</TD></TR><TR><TD CLASS="l">36</TD><TD>import com.cboe.idl.cmiConstants.ProductStatesOperations;</TD></TR><TR><TD CLASS="l">37</TD><TD>import com.cboe.idl.cmiConstants.ProductTypes;</TD></TR><TR><TD CLASS="l">38</TD><TD>import com.cboe.idl.cmiErrorCodes.DataValidationCodes;</TD></TR><TR><TD CLASS="l">39</TD><TD>import com.cboe.idl.cmiProduct.EPWStruct;</TD></TR><TR><TD CLASS="l">40</TD><TD>import com.cboe.idl.cmiProduct.ProductNameStruct;</TD></TR><TR><TD CLASS="l">41</TD><TD>import com.cboe.idl.cmiProduct.ProductStruct;</TD></TR><TR><TD CLASS="l">42</TD><TD>import com.cboe.idl.cmiSession.ClassStateStruct;</TD></TR><TR><TD CLASS="l">43</TD><TD>import com.cboe.idl.cmiSession.ProductStateStruct;</TD></TR><TR><TD CLASS="l">44</TD><TD>import com.cboe.idl.cmiSession.SessionClassDetailStruct;</TD></TR><TR><TD CLASS="l">45</TD><TD>import com.cboe.idl.cmiSession.SessionClassStruct;</TD></TR><TR><TD CLASS="l">46</TD><TD>import com.cboe.idl.cmiStrategy.StrategyStruct;</TD></TR><TR><TD CLASS="l">47</TD><TD>import com.cboe.idl.cmiUtil.KeyDescriptionStruct;</TD></TR><TR><TD CLASS="l">48</TD><TD>import com.cboe.idl.constants.ProgramInterfaces;</TD></TR><TR><TD CLASS="l">49</TD><TD>import com.cboe.idl.marketData.CurrentMarketStateChangeStruct;</TD></TR><TR><TD CLASS="l">50</TD><TD>import com.cboe.idl.product.ClassSettlementStruct;</TD></TR><TR><TD CLASS="l">51</TD><TD>import com.cboe.idl.product.ErrorCodeResultStruct;</TD></TR><TR><TD CLASS="l">52</TD><TD>import com.cboe.idl.product.ProductClassStruct;</TD></TR><TR><TD CLASS="l">53</TD><TD>import com.cboe.idl.product.ProductSettlementStruct;</TD></TR><TR><TD CLASS="l">54</TD><TD>import com.cboe.idl.property.PropertyGroupStruct;</TD></TR><TR><TD CLASS="l">55</TD><TD>import com.cboe.idl.session.TradingSessionElementClassesDetailStruct;</TD></TR><TR><TD CLASS="l">56</TD><TD>import com.cboe.idl.session.TradingSessionElementStruct;</TD></TR><TR><TD CLASS="l">57</TD><TD>import com.cboe.idl.session.TradingSessionStruct;</TD></TR><TR><TD CLASS="l">58</TD><TD>import com.cboe.idl.tradingProperty.AllocationStrategyStructV2;</TD></TR><TR><TD CLASS="l">59</TD><TD>import com.cboe.idl.tradingProperty.AuctionBooleanStruct;</TD></TR><TR><TD CLASS="l">60</TD><TD>import com.cboe.idl.tradingProperty.AuctionLongStruct;</TD></TR><TR><TD CLASS="l">61</TD><TD>import com.cboe.idl.tradingProperty.AuctionOrderSizeTicksStruct;</TD></TR><TR><TD CLASS="l">62</TD><TD>import com.cboe.idl.tradingProperty.AuctionRangeStruct;</TD></TR><TR><TD CLASS="l">63</TD><TD>import com.cboe.idl.tradingProperty.DpmRightsScaleStruct;</TD></TR><TR><TD CLASS="l">64</TD><TD>import com.cboe.idl.tradingProperty.GlobalTradingPropertyTypes;</TD></TR><TR><TD CLASS="l">65</TD><TD>import com.cboe.idl.tradingProperty.InternalizationPercentageStruct;</TD></TR><TR><TD CLASS="l">66</TD><TD>import com.cboe.idl.tradingProperty.TimeRangeStruct;</TD></TR><TR><TD CLASS="l">67</TD><TD>import com.cboe.idl.util.RoutingParameterStruct;</TD></TR><TR><TD CLASS="l">68</TD><TD>import com.cboe.infrastructureServices.foundationFramework.FoundationFramework;</TD></TR><TR><TD CLASS="l">69</TD><TD>import com.cboe.infrastructureServices.foundationFramework.HomeFactory;</TD></TR><TR><TD CLASS="l">70</TD><TD>import com.cboe.infrastructureServices.foundationFramework.exceptionHandling.FatalFoundationFrameworkException;</TD></TR><TR><TD CLASS="l">71</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.Log;</TD></TR><TR><TD CLASS="l">72</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.RouteNameHelper;</TD></TR><TR><TD CLASS="l">73</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.Transaction;</TD></TR><TR><TD CLASS="l">74</TD><TD>import com.cboe.interfaces.businessServices.TradingSessionEventType;</TD></TR><TR><TD CLASS="l">75</TD><TD>import com.cboe.interfaces.businessServices.TradingSessionService;</TD></TR><TR><TD CLASS="l">76</TD><TD>import com.cboe.interfaces.businessServices.TradingSessionServiceHome;</TD></TR><TR><TD CLASS="l">77</TD><TD>import com.cboe.interfaces.domain.BrokerHome;</TD></TR><TR><TD CLASS="l">78</TD><TD>import com.cboe.interfaces.domain.OrderBook;</TD></TR><TR><TD CLASS="l">79</TD><TD>import com.cboe.interfaces.domain.OrderBookHome;</TD></TR><TR><TD CLASS="l">80</TD><TD>import com.cboe.interfaces.domain.Price;</TD></TR><TR><TD CLASS="l">81</TD><TD>import com.cboe.interfaces.domain.TradingClass;</TD></TR><TR><TD CLASS="l">82</TD><TD>import com.cboe.interfaces.domain.TradingClassHome;</TD></TR><TR><TD CLASS="l">83</TD><TD>import com.cboe.interfaces.domain.TradingProduct;</TD></TR><TR><TD CLASS="l">84</TD><TD>import com.cboe.interfaces.domain.TradingProductHome;</TD></TR><TR><TD CLASS="l">85</TD><TD>import com.cboe.interfaces.domain.TradingProductStateListener;</TD></TR><TR><TD CLASS="l">86</TD><TD>import com.cboe.interfaces.domain.marketData.MarketDataHome;</TD></TR><TR><TD CLASS="l">87</TD><TD>import com.cboe.interfaces.domain.session.BusinessDayListener;</TD></TR><TR><TD CLASS="l">88</TD><TD>import com.cboe.interfaces.domain.tradingProperty.RolloutFlagByBC;</TD></TR><TR><TD CLASS="l">89</TD><TD>import com.cboe.interfaces.events.ProductStateConsumer;</TD></TR><TR><TD CLASS="l">90</TD><TD>import com.cboe.interfaces.events.PropertyConsumerHome;</TD></TR><TR><TD CLASS="l">91</TD><TD>import com.cboe.interfaces.internalBusinessServices.ProductStateServiceLocal;</TD></TR><TR><TD CLASS="l">92</TD><TD>import com.cboe.interfaces.internalBusinessServices.ProductStateServiceLocalHome;</TD></TR><TR><TD CLASS="l">93</TD><TD>import com.cboe.interfaces.internalBusinessServices.StateChangeListener;</TD></TR><TR><TD CLASS="l">94</TD><TD>import com.cboe.interfaces.internalBusinessServices.StateChangeVetoException;</TD></TR><TR><TD CLASS="l">95</TD><TD>import com.cboe.interfaces.internalBusinessServices.TradingSessionListener;</TD></TR><TR><TD CLASS="l">96</TD><TD>import com.cboe.interfaces.internalBusinessServices.UnderlyingProductStateService;</TD></TR><TR><TD CLASS="l">97</TD><TD>import com.cboe.interfaces.internalBusinessServices.VetoableStateChangeListener;</TD></TR><TR><TD CLASS="l">98</TD><TD>import com.cboe.interfaces.internalEvents.CurrentMarketStateChangeConsumer;</TD></TR><TR><TD CLASS="l">99</TD><TD>import com.cboe.interfaces.internalEvents.CurrentMarketStateChangeConsumerHome;</TD></TR><TR><TD CLASS="l">100</TD><TD>import com.cboe.interfaces.productData.ProductClassData;</TD></TR><TR><TD CLASS="l">101</TD><TD>import com.cboe.interfaces.productData.ProductData;</TD></TR><TR><TD CLASS="l">102</TD><TD>import com.cboe.interfaces.productData.ProductDataCacheHome;</TD></TR><TR><TD CLASS="l">103</TD><TD>import com.cboe.server.dependencyFramework.DIFBObject;</TD></TR><TR><TD CLASS="l">104</TD><TD>import com.cboe.server.dependencyFramework.FFCommand;</TD></TR><TR><TD CLASS="l">105</TD><TD>import com.cboe.server.dependencyFramework.FFHomeDependency;</TD></TR><TR><TD CLASS="l">106</TD><TD>import com.cboe.server.dependencyFramework.FFProperty;</TD></TR><TR><TD CLASS="l">107</TD><TD>import com.cboe.server.dependencyFramework.FFServiceDependency;</TD></TR><TR><TD CLASS="l">108</TD><TD>import com.cboe.server.events.EventHomes;</TD></TR><TR><TD CLASS="l">109</TD><TD>import com.cboe.server.internalEvents.CurrentMarketStateChangeConsumerHomeNoPubImpl;</TD></TR><TR><TD CLASS="l">110</TD><TD>import com.cboe.server.internalEvents.CurrentMarketStateChangeObjectCollector;</TD></TR><TR><TD CLASS="l">111</TD><TD>import com.cboe.server.internalEvents.CurrentMarketStateChangesClassKeyComparator;</TD></TR><TR><TD CLASS="l">112</TD><TD>import com.cboe.server.internalEvents.CurrentMarketStateChangesHolder;</TD></TR><TR><TD CLASS="l">113</TD><TD>import com.cboe.server.internalEvents.InternalEventHomes;</TD></TR><TR><TD CLASS="l">114</TD><TD>import com.cboe.server.util.BusinessServicesHelper;</TD></TR><TR><TD CLASS="l">115</TD><TD>import com.cboe.server.util.ConfigurationGroupHelper;</TD></TR><TR><TD CLASS="l">116</TD><TD>import com.cboe.server.util.ConstantIntMapper;</TD></TR><TR><TD CLASS="l">117</TD><TD>import com.cboe.server.util.FFStatusQuery;</TD></TR><TR><TD CLASS="l">118</TD><TD>import com.cboe.server.util.TradingClassCommandTransactionListener;</TD></TR><TR><TD CLASS="l">119</TD><TD>import com.cboe.util.ChannelKey;</TD></TR><TR><TD CLASS="l">120</TD><TD>import com.cboe.util.ChannelType;</TD></TR><TR><TD CLASS="l">121</TD><TD>import com.cboe.util.ExceptionBuilder;</TD></TR><TR><TD CLASS="l">122</TD><TD>import com.cboe.util.channel.ChannelEvent;</TD></TR><TR><TD CLASS="l">123</TD><TD>import com.cboe.util.event.EventChannelListener;</TD></TR><TR><TD CLASS="l">124</TD><TD> </TD></TR><TR><TD CLASS="l">125</TD><TD> </TD></TR><TR><TD CLASS="l">126</TD><TD>/**</TD></TR><TR><TD CLASS="l">127</TD><TD> * ProductStateServiceImpl is responsible for coordinating product state changes</TD></TR><TR><TD CLASS="l">128</TD><TD> * for all products.  It works closely with the &lt;code&gt;BrokerService&lt;/code&gt; to</TD></TR><TR><TD CLASS="l">129</TD><TD> * insure that the state changes happen in an orderly fashion.</TD></TR><TR><TD CLASS="l">130</TD><TD> *</TD></TR><TR><TD CLASS="l">131</TD><TD> * @version 3a_5</TD></TR><TR><TD CLASS="l">132</TD><TD> * @author David Wegener</TD></TR><TR><TD CLASS="l">133</TD><TD> * @since Increment 3</TD></TR><TR><TD CLASS="l"><A NAME="15">134</A></TD><TD> * @see com.cboe.interfaces.internalBusinessServices.ProductStateService</TD></TR><TR><TD CLASS="l">135</TD><TD> */</TD></TR><TR CLASS="c"><TD CLASS="l">136</TD><TD>public class ProductStateServiceLocalImpl extends DIFBObject implements ProductStateServiceLocal, TradingSessionListener, UnderlyingProductStateService {</TD></TR><TR><TD CLASS="l">137</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">138</TD><TD>    private final static ConstantIntMapper productStatesMapper = ConstantIntMapper.getMapper(ProductStatesOperations.class);</TD></TR><TR CLASS="c"><TD CLASS="l">139</TD><TD>    private final static ConstantIntMapper classStatesMapper = ConstantIntMapper.getMapper(ClassStatesOperations.class);</TD></TR><TR><TD CLASS="l">140</TD><TD>    protected TradingClassHome cachedTradingClassHome;</TD></TR><TR><TD CLASS="l">141</TD><TD>    protected TradingProductHome cachedTradingProductHome;</TD></TR><TR><TD CLASS="l">142</TD><TD>    protected MarketDataHome cachedMarketDataHome;</TD></TR><TR><TD CLASS="l">143</TD><TD>    protected OrderBookHome cachedOrderBookHome;</TD></TR><TR><TD CLASS="l">144</TD><TD>    protected BrokerHome brokerHome;</TD></TR><TR><TD CLASS="l">145</TD><TD>    protected EventListenerList vetoableListenerList;</TD></TR><TR><TD CLASS="l">146</TD><TD>    protected TradingSessionService theTradingSessionService;</TD></TR><TR><TD CLASS="l"><A NAME="16">147</A></TD><TD> </TD></TR><TR><TD CLASS="l">148</TD><TD>    //protected static int publishSequenceNumberBase = ((int)System.currentTimeMillies()/1000)*10000;</TD></TR><TR><TD CLASS="l">149</TD><TD>    private ProductDataCacheHome productDataCacheHome;</TD></TR><TR><TD CLASS="l">150</TD><TD>    private PropertyConsumerHome propertyConsumerHome;</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="96% line coverage (65 out of 68 instructions)">151</TD><TD TITLE="96% line coverage (65 out of 68 instructions)">    private HashMap&lt;String,TradingSessionElementStruct[]&gt; tradingSessionElementMap = new HashMap&lt;String, TradingSessionElementStruct[]&gt;();</TD></TR><TR CLASS="c"><TD CLASS="l">152</TD><TD>    private HashMap&lt;Integer,TradingSessionElementStruct&gt; tradingClassSessionElementMap = new HashMap&lt;Integer,TradingSessionElementStruct&gt;();</TD></TR><TR CLASS="c"><TD CLASS="l">153</TD><TD>    private HashMap&lt;String,ProductStateChangeTimer&gt; tradingSessionTimerMap = new HashMap&lt;String, ProductStateChangeTimer&gt;();</TD></TR><TR><TD CLASS="l">154</TD><TD> </TD></TR><TR><TD CLASS="l">155</TD><TD>    // for HybridFailover re-publish</TD></TR><TR><TD CLASS="l">156</TD><TD>    protected int numberOfClassesToPublish; // property read from ProductStateServiceHomeImpl</TD></TR><TR><TD CLASS="l">157</TD><TD>    protected int publishInterval;</TD></TR><TR><TD CLASS="l">158</TD><TD>    protected int maxCountCurMktStates;</TD></TR><TR><TD CLASS="l">159</TD><TD>    private int numberOfClassStateChangePerThread; // property read from ProductStateServiceHomeImpl</TD></TR><TR><TD CLASS="l">160</TD><TD>    private int maximumClassStateChangeThread; // property read from ProductStateServiceHomeImpl</TD></TR><TR><TD CLASS="l">161</TD><TD>    private int numberOfBuildThreads;</TD></TR><TR><TD CLASS="l">162</TD><TD>    private int underlyingMapSize;</TD></TR><TR><TD CLASS="l">163</TD><TD>    private boolean enableProductStateChangeByUnderlying;</TD></TR><TR><TD CLASS="l">164</TD><TD> </TD></TR><TR><TD CLASS="l">165</TD><TD>    protected ProductStateConsumer productStatePublisher;</TD></TR><TR><TD CLASS="l">166</TD><TD>    protected ProductStateCollector productStateCollector;</TD></TR><TR><TD CLASS="l">167</TD><TD>    protected CurrentMarketStateChangeConsumer currentMarketStateChangePublisher;</TD></TR><TR CLASS="c"><TD CLASS="l">168</TD><TD>    private HashMap&lt;String, EventChannelListener&gt; propertyUpdateListeners = new HashMap&lt;String, EventChannelListener&gt;();</TD></TR><TR CLASS="c"><TD CLASS="l">169</TD><TD>    private HashMap&lt;String, Boolean&gt; timerBySession = new HashMap&lt;String, Boolean&gt;();</TD></TR><TR><TD CLASS="l">170</TD><TD> </TD></TR><TR><TD CLASS="l">171</TD><TD>    /* variables added for product state ar commands */ </TD></TR><TR><TD CLASS="l">172</TD><TD>    public static final int MAX_NO_OF_STATES = 11; </TD></TR><TR><TD CLASS="l">173</TD><TD>    public static final int MAX_NO_OF_PROD_TYPES = 12;</TD></TR><TR CLASS="c"><TD CLASS="l">174</TD><TD>    protected long sleepInterval = 0;</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="18">175</A></TD><TD>    private String clusterID=&#34;&#34;;</TD></TR><TR><TD CLASS="l">176</TD><TD>    private static final String CLUSTER_PROPERTY=&#34;prefixCluster&#34;;</TD></TR><TR><TD CLASS="l">177</TD><TD>    /* Map of underlying classes by Derivatives */</TD></TR><TR><TD CLASS="l">178</TD><TD>    private ConcurrentIntHashMap &lt;List&gt; derivativesByUnderlying;</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="96% line coverage (65 out of 68 instructions)">179</TD><TD TITLE="96% line coverage (65 out of 68 instructions)">    private HashMap&lt;String, Boolean&gt;   productStateTimerBySession = new HashMap&lt;String, Boolean&gt;();</TD></TR><TR><TD CLASS="l">180</TD><TD>    </TD></TR><TR><TD CLASS="l">181</TD><TD>    /**</TD></TR><TR><TD CLASS="l">182</TD><TD>     * Class for loading trading properties from global in slave mode. The trading properties are are cached in</TD></TR><TR><TD CLASS="l">183</TD><TD>     * trading class home. On goMaster, the trading class impl fetches from the cache and if the property doesn't exist</TD></TR><TR><TD CLASS="l">184</TD><TD>     * for a class then it creates a new trading parameters class and fetches all parameters from global.</TD></TR><TR><TD CLASS="l">185</TD><TD>     *</TD></TR><TR><TD CLASS="l">186</TD><TD>     * @author singh</TD></TR><TR><TD CLASS="l">187</TD><TD>     *</TD></TR><TR><TD CLASS="l">188</TD><TD>     */</TD></TR><TR><TD CLASS="l">189</TD><TD>    class TradingPropertyFetchThread extends Thread</TD></TR><TR><TD CLASS="l">190</TD><TD>    {</TD></TR><TR><TD CLASS="l">191</TD><TD>        protected int myThreadNumber;</TD></TR><TR><TD CLASS="l">192</TD><TD>        protected int numberBuildThreads;</TD></TR><TR><TD CLASS="l">193</TD><TD>        protected ProductClassStruct[] configuredClasses;</TD></TR><TR><TD CLASS="l">194</TD><TD>        protected String sessionName;</TD></TR><TR><TD CLASS="l">195</TD><TD> </TD></TR><TR><TD CLASS="l">196</TD><TD>        TradingPropertyFetchThread(int threadNumber, int numberBuildThreads, ProductClassStruct[] configuredClasses) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="10">197</A></TD><TD>            super(&#34;TradingPropertyFetchThread_&#34; + threadNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">198</TD><TD>            myThreadNumber = threadNumber;</TD></TR><TR CLASS="z"><TD CLASS="l">199</TD><TD>            this.numberBuildThreads = numberBuildThreads;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="12">200</A></TD><TD>            this.configuredClasses = configuredClasses;</TD></TR><TR CLASS="z"><TD CLASS="l">201</TD><TD>        }</TD></TR><TR><TD CLASS="l">202</TD><TD> </TD></TR><TR><TD CLASS="l">203</TD><TD>        protected void loadProperties () {</TD></TR><TR CLASS="z"><TD CLASS="l">204</TD><TD>            int count = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">205</TD><TD>            int totalCount = (configuredClasses.length / numberBuildThreads) + (configuredClasses.length % numberBuildThreads &lt;= myThreadNumber ? 1 : 0);</TD></TR><TR><TD CLASS="l">206</TD><TD>         </TD></TR><TR CLASS="z"><TD CLASS="l">207</TD><TD>            for (int i = 0; i &lt; configuredClasses.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">208</TD><TD>                if ((i % numberBuildThreads) == myThreadNumber) {</TD></TR><TR><TD CLASS="l">209</TD><TD>                    try {</TD></TR><TR CLASS="z"><TD CLASS="l">210</TD><TD>                        if (count % 100 == 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">211</TD><TD>                            Log.information(this.getName() + &#34;&gt;&gt;&gt; loading properties for classes in session &#34; + sessionName + &#34;... &#34; + count + &#34; of &#34; + totalCount);</TD></TR><TR><TD CLASS="l">212</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">213</TD><TD>                        count++;</TD></TR><TR CLASS="z"><TD CLASS="l">214</TD><TD>                        loadPropertyForClass(configuredClasses[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">215</TD><TD>                    } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">216</TD><TD>                        Log.exception(ProductStateServiceLocalImpl.this, &#34; Unable to load property for class, key = &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">217</TD><TD>                                                + configuredClasses[i].info.classKey + &#34;, class Symbol=&#34; + configuredClasses[i].info.classSymbol, e);</TD></TR><TR CLASS="z"><TD CLASS="l">218</TD><TD>                    } catch (Throwable t) {</TD></TR><TR CLASS="z"><TD CLASS="l">219</TD><TD>                        t.printStackTrace();</TD></TR><TR CLASS="z"><TD CLASS="l">220</TD><TD>                        Log.alarm(ProductStateServiceLocalImpl.this, &#34;Unable to load property for class, key = &#34; + configuredClasses[i].info.classKey</TD></TR><TR CLASS="z"><TD CLASS="l">221</TD><TD>                                                + &#34;, class Symbol=&#34; + configuredClasses[i].info.classSymbol);</TD></TR><TR><TD CLASS="l">222</TD><TD>                    }</TD></TR><TR><TD CLASS="l">223</TD><TD>                }</TD></TR><TR><TD CLASS="l"><A NAME="14">224</A></TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">225</TD><TD>        }</TD></TR><TR><TD CLASS="l">226</TD><TD> </TD></TR><TR><TD CLASS="l">227</TD><TD>        public void run() {</TD></TR><TR CLASS="z"><TD CLASS="l">228</TD><TD>            String[] sessionNameList = TradingSessionNameHelper.getConfiguredSessionNames();</TD></TR><TR><TD CLASS="l">229</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">230</TD><TD>            for (int i = 0; (sessionNameList != null) &amp;&amp; (i &lt; sessionNameList.length); i++)</TD></TR><TR><TD CLASS="l">231</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">232</TD><TD>                sessionName = sessionNameList[i];</TD></TR><TR CLASS="z"><TD CLASS="l">233</TD><TD>                if (TradingSessionNameHelper.isUnderlyingSession(sessionName) == false) {</TD></TR><TR CLASS="z"><TD CLASS="l">234</TD><TD>                    Log.information(this.getName() + &#34; Loading trading properties for classes in session: &#34; + sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">235</TD><TD>                    loadProperties ();</TD></TR><TR CLASS="z"><TD CLASS="l">236</TD><TD>                    Log.information(this.getName()+&#34; Completed trading loading properties for classes in session: &#34; + sessionName);</TD></TR><TR><TD CLASS="l">237</TD><TD>                }</TD></TR><TR><TD CLASS="l">238</TD><TD>                </TD></TR><TR><TD CLASS="l"><A NAME="13">239</A></TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">240</TD><TD>        }</TD></TR><TR><TD CLASS="l">241</TD><TD> </TD></TR><TR><TD CLASS="l">242</TD><TD>        protected void loadPropertyForClass(ProductClassStruct struct) {</TD></TR><TR CLASS="z"><TD CLASS="l">243</TD><TD>            cachedTradingClassHome.fetchTradingProperty(sessionName, struct.info.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">244</TD><TD>        }</TD></TR><TR><TD CLASS="l">245</TD><TD>    }</TD></TR><TR><TD CLASS="l">246</TD><TD>/**</TD></TR><TR><TD CLASS="l">247</TD><TD> * Thread to build configured products.</TD></TR><TR><TD CLASS="l">248</TD><TD> */</TD></TR><TR><TD CLASS="l">249</TD><TD>class ProductBuildThread extends Thread {</TD></TR><TR><TD CLASS="l">250</TD><TD> </TD></TR><TR><TD CLASS="l">251</TD><TD>    protected int myThreadNumber;</TD></TR><TR><TD CLASS="l">252</TD><TD>    protected int numberBuildThreads;</TD></TR><TR><TD CLASS="l">253</TD><TD>    protected ProductClassStruct[] configuredClasses;</TD></TR><TR><TD CLASS="l">254</TD><TD> </TD></TR><TR><TD CLASS="l">255</TD><TD>    ProductBuildThread(int threadNumber, int numberBuildThreads, ProductClassStruct[] configuredClasses) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3">256</A></TD><TD>        super(&#34;ProductBuildThread_&#34; + threadNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">257</TD><TD>        myThreadNumber = threadNumber;</TD></TR><TR CLASS="z"><TD CLASS="l">258</TD><TD>        this.numberBuildThreads = numberBuildThreads;</TD></TR><TR CLASS="z"><TD CLASS="l">259</TD><TD>        this.configuredClasses = configuredClasses;</TD></TR><TR CLASS="z"><TD CLASS="l">260</TD><TD>    }</TD></TR><TR><TD CLASS="l">261</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="5">262</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">263</TD><TD>     * Builds products for a non-strategy class.</TD></TR><TR><TD CLASS="l">264</TD><TD>     */</TD></TR><TR><TD CLASS="l">265</TD><TD>    protected void buildClass(ProductClassStruct newClass) {</TD></TR><TR CLASS="z"><TD CLASS="l">266</TD><TD>        boolean success = false;</TD></TR><TR><TD CLASS="l">267</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">268</TD><TD>        Transaction.startTransaction();</TD></TR><TR><TD CLASS="l">269</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">270</TD><TD>            if (shouldCreateProxyTradingClass(newClass))</TD></TR><TR><TD CLASS="l">271</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">272</TD><TD>                getTradingClassHome().createProxy(newClass);</TD></TR><TR><TD CLASS="l">273</TD><TD>            }</TD></TR><TR><TD CLASS="l">274</TD><TD>            else</TD></TR><TR><TD CLASS="l">275</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">276</TD><TD>            cachedTradingClassHome.create(newClass);</TD></TR><TR><TD CLASS="l">277</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">278</TD><TD>            success = Transaction.commit();            </TD></TR><TR><TD CLASS="l">279</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">280</TD><TD>        finally {</TD></TR><TR CLASS="z"><TD CLASS="l">281</TD><TD>            if (success) {</TD></TR><TR CLASS="z"><TD CLASS="l">282</TD><TD>                Log.debug(ProductStateServiceLocalImpl.this, getName()+&#34; Products built for class &#34; + newClass.info.classSymbol + &#34;/&#34; + newClass.info.classKey);</TD></TR><TR><TD CLASS="l">283</TD><TD>            }</TD></TR><TR><TD CLASS="l">284</TD><TD>            else {</TD></TR><TR CLASS="z"><TD CLASS="l">285</TD><TD>                Transaction.rollback();</TD></TR><TR CLASS="z"><TD CLASS="l">286</TD><TD>                Log.alarm(ProductStateServiceLocalImpl.this, getName()+&#34; Unable to build products for class &#34; + newClass.info.classSymbol + &#34;/&#34; + newClass.info.classKey + &#34;/&#34; + newClass.info.productType);</TD></TR><TR><TD CLASS="l">287</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">288</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">289</TD><TD>    }</TD></TR><TR><TD CLASS="l">290</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="9">291</A></TD><TD>    private boolean shouldCreateProxyTradingClass(ProductClassStruct p_newClass)</TD></TR><TR><TD CLASS="l">292</TD><TD>    {</TD></TR><TR><TD CLASS="l">293</TD><TD>            try</TD></TR><TR><TD CLASS="l">294</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">295</TD><TD>                return ConfigurationGroupHelper.createProxyObject(p_newClass.info.classKey);</TD></TR><TR><TD CLASS="l">296</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">297</TD><TD>            catch (Exception e)</TD></TR><TR><TD CLASS="l">298</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">299</TD><TD>                Log.exception(&#34;Unable to find prod class data for class: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">300</TD><TD>                        + p_newClass.info.classKey + &#34;/&#34; + p_newClass.info.productType + &#34;/&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">301</TD><TD>                        + p_newClass.info.classSymbol, e);</TD></TR><TR><TD CLASS="l">302</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">303</TD><TD>                throw new RuntimeException(e);</TD></TR><TR><TD CLASS="l">304</TD><TD>            }</TD></TR><TR><TD CLASS="l">305</TD><TD>    }</TD></TR><TR><TD CLASS="l">306</TD><TD> </TD></TR><TR><TD CLASS="l">307</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="6">308</A></TD><TD>     * Builds products for a strategy class.</TD></TR><TR><TD CLASS="l">309</TD><TD>     */</TD></TR><TR><TD CLASS="l">310</TD><TD>    protected void buildStrategyClass(ProductClassStruct newClass) {</TD></TR><TR><TD CLASS="l">311</TD><TD>   </TD></TR><TR CLASS="z"><TD CLASS="l">312</TD><TD>        boolean success = false;       </TD></TR><TR><TD CLASS="l">313</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">314</TD><TD>        Transaction.startTransaction();</TD></TR><TR><TD CLASS="l">315</TD><TD> </TD></TR><TR><TD CLASS="l">316</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">317</TD><TD>            StrategyStruct[] strategyDefs =  BusinessServicesHelper.getProductQueryService().getStrategiesByClass(newClass.info.classKey, true);</TD></TR><TR><TD CLASS="l">318</TD><TD>             </TD></TR><TR CLASS="z"><TD CLASS="l">319</TD><TD>            if (shouldCreateProxyTradingClass(newClass))</TD></TR><TR><TD CLASS="l">320</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">321</TD><TD>                getTradingClassHome().createProxy(newClass, strategyDefs);</TD></TR><TR><TD CLASS="l">322</TD><TD>            }</TD></TR><TR><TD CLASS="l">323</TD><TD>            else</TD></TR><TR><TD CLASS="l">324</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">325</TD><TD>                TradingClass tClass = getTradingClassHome().create(newClass, strategyDefs);</TD></TR><TR CLASS="z"><TD CLASS="l">326</TD><TD>                TradingProduct[] products = tClass.getProducts(true);</TD></TR><TR CLASS="z"><TD CLASS="l">327</TD><TD>                for (TradingProduct tradingProduct : products) </TD></TR><TR><TD CLASS="l">328</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">329</TD><TD>                    if (tradingProduct.getProductKeys().productType != ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">330</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">331</TD><TD>                        Log.information(ProductStateServiceLocalImpl.this, &#34;Strategy class &#34;+tClass.getClassSymbol()+&#34; has product that is not a strategy: &#34;+tradingProduct.getProductKey());</TD></TR><TR><TD CLASS="l">332</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">333</TD><TD>                    if (tradingProduct.getStrategyLegs().length==0)</TD></TR><TR><TD CLASS="l">334</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">335</TD><TD>                        Log.information(ProductStateServiceLocalImpl.this, &#34;Strategy class &#34;+tClass.getClassSymbol()+&#34; has product without legs: &#34;+tradingProduct.getProductKey());</TD></TR><TR><TD CLASS="l">336</TD><TD>                    }</TD></TR><TR><TD CLASS="l">337</TD><TD>                }</TD></TR><TR><TD CLASS="l">338</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">339</TD><TD>            success = Transaction.commit();</TD></TR><TR><TD CLASS="l">340</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">341</TD><TD>        catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">342</TD><TD>            Log.exception(ProductStateServiceLocalImpl.this, &#34;Unable to build strategies for &#34; + newClass.info.classSymbol, e);</TD></TR><TR><TD CLASS="l">343</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">344</TD><TD>        catch (Throwable t) {</TD></TR><TR CLASS="z"><TD CLASS="l">345</TD><TD>            Log.exception (new Exception(t));</TD></TR><TR><TD CLASS="l">346</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">347</TD><TD>        finally {</TD></TR><TR CLASS="z"><TD CLASS="l">348</TD><TD>            if (success) {</TD></TR><TR CLASS="z"><TD CLASS="l">349</TD><TD>                Log.debug(ProductStateServiceLocalImpl.this, &#34;Strategy products built for class &#34; + newClass.info.classSymbol);</TD></TR><TR><TD CLASS="l">350</TD><TD>            }</TD></TR><TR><TD CLASS="l">351</TD><TD>            else {</TD></TR><TR CLASS="z"><TD CLASS="l">352</TD><TD>                Transaction.rollback();</TD></TR><TR CLASS="z"><TD CLASS="l">353</TD><TD>                Log.alarm(ProductStateServiceLocalImpl.this, &#34;Unable to build strategies for class &#34; + newClass.info.classSymbol + &#34;/&#34; + newClass.info.productType);</TD></TR><TR><TD CLASS="l">354</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">355</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">356</TD><TD>    }</TD></TR><TR><TD CLASS="l">357</TD><TD> </TD></TR><TR><TD CLASS="l">358</TD><TD>    /**</TD></TR><TR><TD CLASS="l">359</TD><TD>     * Builds products in two passes.  First pass builds all classes except strategies.  Second pass builds</TD></TR><TR><TD CLASS="l">360</TD><TD>     * strategies for classes built in first pass.</TD></TR><TR><TD CLASS="l"><A NAME="8">361</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">362</TD><TD>    public void run() {</TD></TR><TR><TD CLASS="l">363</TD><TD>        // configure all non-strategy classes - need these defined first so references can be</TD></TR><TR><TD CLASS="l">364</TD><TD>        // found when strategies are defined.</TD></TR><TR CLASS="z"><TD CLASS="l">365</TD><TD>        createProducts(false);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="7">366</A></TD><TD>        createProducts(true);</TD></TR><TR CLASS="z"><TD CLASS="l">367</TD><TD>    }</TD></TR><TR><TD CLASS="l">368</TD><TD> </TD></TR><TR><TD CLASS="l">369</TD><TD>    private void createProducts(boolean p_strategies) {</TD></TR><TR CLASS="z"><TD CLASS="l">370</TD><TD>        Log.information(this.getName() + &#34;&gt;&gt;&gt; Building classes in progress: &#34;+(p_strategies?&#34;&#34;:&#34;non-&#34;)+&#34;strategy classes only&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">371</TD><TD>        int count = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">372</TD><TD>        for (int i = 0; i &lt; configuredClasses.length; i++) </TD></TR><TR><TD CLASS="l">373</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">374</TD><TD>            if ((i % numberBuildThreads) == myThreadNumber) </TD></TR><TR><TD CLASS="l">375</TD><TD>            {</TD></TR><TR><TD CLASS="l">376</TD><TD>                try</TD></TR><TR><TD CLASS="l">377</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">378</TD><TD>                   if (!p_strategies &amp;&amp; configuredClasses[i].info.productType != ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">379</TD><TD>                   {</TD></TR><TR CLASS="z"><TD CLASS="l">380</TD><TD>                       buildClass(configuredClasses[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">381</TD><TD>                       if((count++) % 10 == 0)</TD></TR><TR CLASS="z"><TD CLASS="l">382</TD><TD>                           Log.information(this.getName() + &#34;&gt;&gt;&gt; Building classes in progress... built &#34; + count + (p_strategies?&#34; &#34;:&#34; non-&#34;)+&#34;strategy classes&#34;);</TD></TR><TR><TD CLASS="l">383</TD><TD>                   }</TD></TR><TR CLASS="z"><TD CLASS="l">384</TD><TD>                   if (p_strategies &amp;&amp; configuredClasses[i].info.productType == ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">385</TD><TD>                   {</TD></TR><TR CLASS="z"><TD CLASS="l">386</TD><TD>                       buildStrategyClass(configuredClasses[i]); </TD></TR><TR CLASS="z"><TD CLASS="l">387</TD><TD>                       if((count++) % 10 == 0)</TD></TR><TR CLASS="z"><TD CLASS="l">388</TD><TD>                           Log.information(this.getName() + &#34;&gt;&gt;&gt; Building classes in progress... built &#34; + count + (p_strategies?&#34; &#34;:&#34; non-&#34;)+&#34;strategy classes&#34;);</TD></TR><TR><TD CLASS="l">389</TD><TD>                   }</TD></TR><TR><TD CLASS="l">390</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">391</TD><TD>                catch (Exception e)</TD></TR><TR><TD CLASS="l">392</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">393</TD><TD>                   Log.exception(ProductStateServiceLocalImpl.this, &#34;Unable to build class, key = &#34; + configuredClasses[i].info.classKey + &#34;, class Symbol=&#34; + configuredClasses[i].info.classSymbol, e);</TD></TR><TR><TD CLASS="l">394</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">395</TD><TD>                catch (Throwable t)</TD></TR><TR><TD CLASS="l">396</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">397</TD><TD>                    t.printStackTrace();</TD></TR><TR CLASS="z"><TD CLASS="l">398</TD><TD>                    Log.alarm(ProductStateServiceLocalImpl.this, &#34;Unable to build class, key = &#34; + configuredClasses[i].info.classKey + &#34;, class Symbol=&#34; + configuredClasses[i].info.classSymbol);</TD></TR><TR><TD CLASS="l">399</TD><TD>                }</TD></TR><TR><TD CLASS="l">400</TD><TD>            }</TD></TR><TR><TD CLASS="l">401</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">402</TD><TD>    }</TD></TR><TR><TD CLASS="l">403</TD><TD>} // end of ProductBuildThread inner class</TD></TR><TR><TD CLASS="l">404</TD><TD> </TD></TR><TR><TD CLASS="l">405</TD><TD>/**</TD></TR><TR><TD CLASS="l">406</TD><TD> * Thread to change status of products in a session.</TD></TR><TR><TD CLASS="l">407</TD><TD> */</TD></TR><TR><TD CLASS="l">408</TD><TD>class SessionStatusThread extends Thread {</TD></TR><TR><TD CLASS="l">409</TD><TD> </TD></TR><TR><TD CLASS="l">410</TD><TD>    protected String sessionName;</TD></TR><TR><TD CLASS="l">411</TD><TD>    protected short initialState;</TD></TR><TR><TD CLASS="l">412</TD><TD>    protected int myThreadNumber;</TD></TR><TR><TD CLASS="l">413</TD><TD>    protected int numberBuildThreads;</TD></TR><TR><TD CLASS="l">414</TD><TD>    protected TradingSessionElementClassesDetailStruct[] sessionElements;</TD></TR><TR><TD CLASS="l">415</TD><TD>    private boolean strategies;</TD></TR><TR CLASS="z"><TD CLASS="l">416</TD><TD>    private boolean useCommand=false;</TD></TR><TR><TD CLASS="l">417</TD><TD>    SessionStatusThread(String sessionName, short initialState, int threadNumber, int numberBuildThreads, TradingSessionElementClassesDetailStruct[] sessionClasses, boolean p_strategies,boolean useCommand) {</TD></TR><TR CLASS="z"><TD CLASS="l">418</TD><TD>        super(&#34;SessionStatusThread_&#34; + threadNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">419</TD><TD>        this.sessionName = sessionName;</TD></TR><TR CLASS="z"><TD CLASS="l">420</TD><TD>        this.initialState = initialState;</TD></TR><TR CLASS="z"><TD CLASS="l">421</TD><TD>        myThreadNumber = threadNumber;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="a">422</A></TD><TD>        this.numberBuildThreads = numberBuildThreads;</TD></TR><TR CLASS="z"><TD CLASS="l">423</TD><TD>        this.sessionElements = sessionClasses;</TD></TR><TR CLASS="z"><TD CLASS="l">424</TD><TD>        this.strategies = p_strategies;</TD></TR><TR CLASS="z"><TD CLASS="l">425</TD><TD>        this.useCommand = useCommand;</TD></TR><TR CLASS="z"><TD CLASS="l">426</TD><TD>    }</TD></TR><TR><TD CLASS="l">427</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="c">428</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">429</TD><TD>     * Adds a class to a session.</TD></TR><TR><TD CLASS="l">430</TD><TD>     */</TD></TR><TR><TD CLASS="l">431</TD><TD>    protected void addClassToSession(String sessionName, TradingClass sessionClass, SessionClassDetailStruct sessionClassDetail, long productCloseTime) {</TD></TR><TR CLASS="z"><TD CLASS="l">432</TD><TD>        boolean success = false;</TD></TR><TR CLASS="z"><TD CLASS="l">433</TD><TD>        if (useCommand)</TD></TR><TR><TD CLASS="l">434</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">435</TD><TD>                TradingClassSessionUpdateCommand command = new TradingClassSessionUpdateCommand(sessionName,sessionClass,sessionClassDetail,productCloseTime);</TD></TR><TR><TD CLASS="l">436</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">437</TD><TD>                                sessionClass.acceptCommand(command, false);</TD></TR><TR CLASS="z"><TD CLASS="l">438</TD><TD>                        } catch (NotAcceptedException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">439</TD><TD>                                Log.exception(ProductStateServiceLocalImpl.this,e);</TD></TR><TR><TD CLASS="l">440</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">441</TD><TD>                return;</TD></TR><TR><TD CLASS="l">442</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">443</TD><TD>        Transaction.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">444</TD><TD>        Log.debug(ProductStateServiceLocalImpl.this, &#34;Adding products for class &#34; + sessionClass.getClassSymbol() + &#34; to session &#34; + sessionName);</TD></TR><TR><TD CLASS="l">445</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">446</TD><TD>            sessionClass.addToSession(sessionName, sessionClassDetail, productCloseTime);</TD></TR><TR CLASS="z"><TD CLASS="l">447</TD><TD>            success = Transaction.commit();</TD></TR><TR><TD CLASS="l">448</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">449</TD><TD>        finally {</TD></TR><TR CLASS="z"><TD CLASS="l">450</TD><TD>            if (success) {</TD></TR><TR CLASS="z"><TD CLASS="l">451</TD><TD>                Log.debug(ProductStateServiceLocalImpl.this, &#34; addClassToSession: All products added for &#34; + sessionClass.getClassSymbol());</TD></TR><TR><TD CLASS="l">452</TD><TD>            }</TD></TR><TR><TD CLASS="l">453</TD><TD>            else {</TD></TR><TR CLASS="z"><TD CLASS="l">454</TD><TD>                Transaction.rollback();</TD></TR><TR CLASS="z"><TD CLASS="l">455</TD><TD>                Log.alarm(ProductStateServiceLocalImpl.this, &#34; addClassToSession: Unable to add products for class &#34; + sessionClass.getClassSymbol() + &#34; to session &#34; + sessionName);</TD></TR><TR><TD CLASS="l">456</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">457</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">458</TD><TD>    }</TD></TR><TR><TD CLASS="l">459</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="d">460</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">461</TD><TD>     * Removes a class from a session.</TD></TR><TR><TD CLASS="l">462</TD><TD>     */</TD></TR><TR><TD CLASS="l">463</TD><TD>    protected void removeClassFromSession(String sessionName, TradingClass sessionClass, SessionClassDetailStruct sessionClassDetail) {</TD></TR><TR CLASS="z"><TD CLASS="l">464</TD><TD>        boolean success = false;</TD></TR><TR CLASS="z"><TD CLASS="l">465</TD><TD>        Transaction.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">466</TD><TD>        if(Log.isDebugOn())</TD></TR><TR CLASS="z"><TD CLASS="l">467</TD><TD>            Log.debug(ProductStateServiceLocalImpl.this, &#34;Removing products for class &#34; + sessionClass.getClassSymbol() + &#34; from session &#34; + sessionName);</TD></TR><TR><TD CLASS="l">468</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">469</TD><TD>            sessionClass.removeFromSession(sessionName, sessionClassDetail);</TD></TR><TR CLASS="z"><TD CLASS="l">470</TD><TD>            success = Transaction.commit();</TD></TR><TR><TD CLASS="l">471</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">472</TD><TD>        finally {</TD></TR><TR CLASS="z"><TD CLASS="l">473</TD><TD>            if (success) {</TD></TR><TR CLASS="z"><TD CLASS="l">474</TD><TD>                Log.debug(ProductStateServiceLocalImpl.this, &#34;All products removed for &#34; + sessionClass.getClassSymbol());</TD></TR><TR><TD CLASS="l">475</TD><TD>            }</TD></TR><TR><TD CLASS="l">476</TD><TD>            else {</TD></TR><TR CLASS="z"><TD CLASS="l">477</TD><TD>                Transaction.rollback();</TD></TR><TR CLASS="z"><TD CLASS="l">478</TD><TD>                Log.alarm(ProductStateServiceLocalImpl.this, &#34;Unable to remove products for class &#34; + sessionClass.getClassSymbol() + &#34; from session &#34; + sessionName);</TD></TR><TR><TD CLASS="l">479</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">480</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">481</TD><TD>    }</TD></TR><TR><TD CLASS="l">482</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="e">483</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">484</TD><TD>     * Changes session status for classes assigned to this thread.</TD></TR><TR><TD CLASS="l">485</TD><TD>     */</TD></TR><TR><TD CLASS="l">486</TD><TD>    public void run() {</TD></TR><TR CLASS="z"><TD CLASS="l">487</TD><TD>        int count = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">488</TD><TD>        long productCloseTime = 0L;</TD></TR><TR CLASS="z"><TD CLASS="l">489</TD><TD>        for (int j=0; j&lt;sessionElements.length; j++)</TD></TR><TR><TD CLASS="l">490</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">491</TD><TD>            productCloseTime = DateWrapper.convertToMillis(sessionElements[j].tradingSessionElementInfo.productCloseTime);</TD></TR><TR CLASS="z"><TD CLASS="l">492</TD><TD>            SessionClassDetailStruct[] sessionClasses = sessionElements[j].sessionClassesDetail;</TD></TR><TR CLASS="z"><TD CLASS="l">493</TD><TD>            for (int i = 0; i &lt; sessionClasses.length; i++)</TD></TR><TR><TD CLASS="l">494</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">495</TD><TD>                if (!strategies &amp;&amp; sessionClasses[i].classDetail.classStruct.productType == ProductTypes.STRATEGY)</TD></TR><TR CLASS="z"><TD CLASS="l">496</TD><TD>                    continue;</TD></TR><TR CLASS="z"><TD CLASS="l">497</TD><TD>                if (strategies &amp;&amp; sessionClasses[i].classDetail.classStruct.productType != ProductTypes.STRATEGY)</TD></TR><TR CLASS="z"><TD CLASS="l">498</TD><TD>                    continue;</TD></TR><TR><TD CLASS="l">499</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">500</TD><TD>                if (i % numberBuildThreads == myThreadNumber) {</TD></TR><TR><TD CLASS="l">501</TD><TD>                    try {</TD></TR><TR CLASS="z"><TD CLASS="l">502</TD><TD>                        TradingClass currentClass = cachedTradingClassHome.findByKey(sessionClasses[i].classDetail.classStruct.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">503</TD><TD>                        if(currentClass != null)</TD></TR><TR><TD CLASS="l">504</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">505</TD><TD>                            if (initialState == ProductStates.CLOSED) {</TD></TR><TR CLASS="z"><TD CLASS="l">506</TD><TD>                                 if(count%10 == 0){</TD></TR><TR CLASS="z"><TD CLASS="l">507</TD><TD>                                    Log.information(this.getName() +&#34; key=&#34;+currentClass.getProductClassKey()+&#34; ProductStateService Adding classes to session in progress...&#34;);</TD></TR><TR><TD CLASS="l">508</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">509</TD><TD>                                count++;</TD></TR><TR><TD CLASS="l">510</TD><TD>                               </TD></TR><TR CLASS="z"><TD CLASS="l">511</TD><TD>                                addClassToSession(sessionName, currentClass, sessionClasses[i], productCloseTime);</TD></TR><TR><TD CLASS="l">512</TD><TD>                            }</TD></TR><TR CLASS="z"><TD CLASS="l">513</TD><TD>                            else if (initialState == ProductStates.NO_SESSION) {</TD></TR><TR CLASS="z"><TD CLASS="l">514</TD><TD>                                if(count%10 == 0){</TD></TR><TR CLASS="z"><TD CLASS="l">515</TD><TD>                                    Log.information(this.getName() +&#34;&gt;&gt;&gt; key=&#34;+currentClass.getProductClassKey()+&#34; ProductStateService Removing classes from session in progress...&#34;);</TD></TR><TR><TD CLASS="l">516</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">517</TD><TD>                                count++;</TD></TR><TR CLASS="z"><TD CLASS="l">518</TD><TD>                                removeClassFromSession(sessionName, currentClass, sessionClasses[i]);</TD></TR><TR><TD CLASS="l">519</TD><TD>                            }</TD></TR><TR><TD CLASS="l">520</TD><TD>                            else {</TD></TR><TR CLASS="z"><TD CLASS="l">521</TD><TD>                                Log.alarm(this.getName() +&#34;&gt;&gt;&gt; key=&#34;+currentClass.getProductClassKey()+&#34; Unexpected intial product state of &#34; + initialState);</TD></TR><TR CLASS="z"><TD CLASS="l">522</TD><TD>                                return;</TD></TR><TR><TD CLASS="l">523</TD><TD>                            }</TD></TR><TR><TD CLASS="l">524</TD><TD>                        }</TD></TR><TR><TD CLASS="l">525</TD><TD>                        else</TD></TR><TR><TD CLASS="l">526</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">527</TD><TD>                            Log.information(&#34;Class not actually running on the server to process product state: &#34; + sessionClasses[i].classDetail.classStruct.classKey);</TD></TR><TR><TD CLASS="l">528</TD><TD>                        }</TD></TR><TR><TD CLASS="l">529</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">530</TD><TD>                    catch (NotFoundException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">531</TD><TD>                        Log.information(this.getName() +&#34;&gt;&gt;&gt; Ignoring class &#34; + sessionClasses[i].classDetail.classStruct.classSymbol);</TD></TR><TR><TD CLASS="l">532</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">533</TD><TD>                    catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">534</TD><TD>                        Log.exception(this.getName() +&#34;&gt;&gt;&gt; Failed adding the following class to session: &#34; + sessionClasses[i].classDetail.classStruct.classSymbol, e);</TD></TR><TR><TD CLASS="l">535</TD><TD>                    }</TD></TR><TR><TD CLASS="l">536</TD><TD>                }</TD></TR><TR><TD CLASS="l">537</TD><TD>            }</TD></TR><TR><TD CLASS="l">538</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">539</TD><TD>    }</TD></TR><TR><TD CLASS="l">540</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="f">541</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">542</TD><TD>     * Sets the session status for products in the session.</TD></TR><TR><TD CLASS="l">543</TD><TD>     */</TD></TR><TR><TD CLASS="l">544</TD><TD>    protected void setSessionStatusOfProducts(SessionClassDetailStruct sessionClassDetail, boolean newStatus) {</TD></TR><TR CLASS="z"><TD CLASS="l">545</TD><TD>        for (int i = 0; i &lt; sessionClassDetail.products.length; i++) {</TD></TR><TR><TD CLASS="l">546</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">547</TD><TD>                TradingProduct sessionProduct = cachedTradingProductHome.findByKey(sessionClassDetail.products[i].productStruct.productKeys.productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">548</TD><TD>                sessionProduct.setEnabledForSession(newStatus);</TD></TR><TR><TD CLASS="l">549</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">550</TD><TD>            catch (NotFoundException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">551</TD><TD>                Log.alarm(ProductStateServiceLocalImpl.this, &#34;Product(&#34; + sessionClassDetail.products[i].productStruct.productKeys.productKey + &#34;) in session(&#34; + sessionName + &#34;) is not found&#34;);</TD></TR><TR><TD CLASS="l">552</TD><TD>            }</TD></TR><TR><TD CLASS="l">553</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">554</TD><TD>    }</TD></TR><TR><TD CLASS="l">555</TD><TD>} // end of SessionStatusThread inner class</TD></TR><TR><TD CLASS="l">556</TD><TD> </TD></TR><TR><TD CLASS="l">557</TD><TD>/**</TD></TR><TR><TD CLASS="l"><A NAME="8d">558</A></TD><TD> * Construct a &lt;code&gt;ProductStateServiceLocalImpl&lt;/code&gt; with an &lt;code&gt;EventListenerList&lt;/code&gt;</TD></TR><TR><TD CLASS="l">559</TD><TD> *</TD></TR><TR><TD CLASS="l">560</TD><TD> * @since Increment 3</TD></TR><TR><TD CLASS="l">561</TD><TD> */</TD></TR><TR CLASS="c"><TD CLASS="l">562</TD><TD>public ProductStateServiceLocalImpl() {</TD></TR><TR CLASS="c"><TD CLASS="l">563</TD><TD>    vetoableListenerList = new EventListenerList();</TD></TR><TR CLASS="c"><TD CLASS="l">564</TD><TD>    productStateCollector = new ProductStateCollector();</TD></TR><TR CLASS="c"><TD CLASS="l">565</TD><TD>    clusterID = System.getProperty(CLUSTER_PROPERTY);</TD></TR><TR CLASS="c"><TD CLASS="l">566</TD><TD>    clusterID = System.getProperty(&#34;prefix&#34;)+clusterID;</TD></TR><TR><TD CLASS="l">567</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">568</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="53">569</A></TD><TD>}</TD></TR><TR><TD CLASS="l">570</TD><TD> </TD></TR><TR><TD CLASS="l">571</TD><TD>public static boolean isSpreadTradeServer()</TD></TR><TR><TD CLASS="l">572</TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">573</TD><TD>    return ConfigurationGroupHelper.isSpreadTradeServer();</TD></TR><TR><TD CLASS="l">574</TD><TD>}</TD></TR><TR><TD CLASS="l">575</TD><TD> </TD></TR><TR><TD CLASS="l">576</TD><TD>/**</TD></TR><TR><TD CLASS="l">577</TD><TD> * Processes intraday product add.</TD></TR><TR><TD CLASS="l">578</TD><TD> *</TD></TR><TR><TD CLASS="l"><A NAME="1a">579</A></TD><TD> * @see ProductStateServiceLocal#addProduct</TD></TR><TR><TD CLASS="l">580</TD><TD> */</TD></TR><TR><TD CLASS="l">581</TD><TD>public void addProduct(ProductStruct aProduct){</TD></TR><TR><TD CLASS="l">582</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">583</TD><TD>        TradingClass tradingClass = cachedTradingClassHome.findByKey(aProduct.productKeys.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">584</TD><TD>        if (tradingClass.isProxy() == false)</TD></TR><TR><TD CLASS="l">585</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">586</TD><TD>            AddProductCommand aCommand = new AddProductCommand(aProduct);</TD></TR><TR CLASS="z"><TD CLASS="l">587</TD><TD>            int productKey = aProduct.productKeys.productKey;</TD></TR><TR><TD CLASS="l">588</TD><TD>            try</TD></TR><TR><TD CLASS="l">589</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">590</TD><TD>                getProductDataCache(productKey);</TD></TR><TR><TD CLASS="l">591</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">592</TD><TD>            catch (Exception exe)</TD></TR><TR><TD CLASS="l">593</TD><TD>            {</TD></TR><TR><TD CLASS="l">594</TD><TD>                Log</TD></TR><TR CLASS="z"><TD CLASS="l">595</TD><TD>                        .alarm(&#34;ProductStateServiceLocalImpl&gt;&gt;&gt;addStrategy: Calling Global, instead of command failed will try to add through command:&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">596</TD><TD>                                + productKey);</TD></TR><TR><TD CLASS="l">597</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">598</TD><TD>            tradingClass.acceptCommand(aCommand, false); // false indicate not putting the</TD></TR><TR><TD CLASS="l">599</TD><TD>                                                             // command into queue. Execute it</TD></TR><TR><TD CLASS="l">600</TD><TD>                                                             // immediately.</TD></TR><TR><TD CLASS="l">601</TD><TD>        }</TD></TR><TR><TD CLASS="l">602</TD><TD>        else</TD></TR><TR><TD CLASS="l">603</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">604</TD><TD>            addProductImmediately(aProduct);</TD></TR><TR><TD CLASS="l">605</TD><TD>        }</TD></TR><TR><TD CLASS="l">606</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">607</TD><TD>    catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">608</TD><TD>        String prodString = &#34;&#34; + aProduct.productKeys.classKey + &#34;-&#34; + aProduct.productKeys.productKey;</TD></TR><TR CLASS="z"><TD CLASS="l">609</TD><TD>        Log.information(&#34;ProductStateServiceLocalImpl&gt;&gt;&gt;addStrategy: StrategyProduct:&#34; +prodString+ &#34; cannot be added.&#34;+e.getMessage());</TD></TR><TR><TD CLASS="l">610</TD><TD>        //Log.exception(&#34;ProductStateServiceLocalImpl&gt;&gt;&gt;addStrategy: StrategyProduct:&#34; + prodString + &#34; cannot be added.&#34;, e);</TD></TR><TR><TD CLASS="l">611</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">612</TD><TD>}</TD></TR><TR><TD CLASS="l">613</TD><TD> </TD></TR><TR><TD CLASS="l">614</TD><TD>/**</TD></TR><TR><TD CLASS="l">615</TD><TD> * Process the intraday product addition without any delay</TD></TR><TR><TD CLASS="l">616</TD><TD> *</TD></TR><TR><TD CLASS="l">617</TD><TD> * Note: It is important that this method has to be wrapped in a command. And synchronized on the</TD></TR><TR><TD CLASS="l"><A NAME="1b">618</A></TD><TD> * command execution level. Otherwide a race conditions with another thread trying to do the same thing</TD></TR><TR><TD CLASS="l">619</TD><TD> * will occurs. Synchronization on this method will not resolve the problem.</TD></TR><TR><TD CLASS="l">620</TD><TD> */</TD></TR><TR><TD CLASS="l">621</TD><TD>public void addProductImmediately(ProductStruct product) {</TD></TR><TR CLASS="z"><TD CLASS="l">622</TD><TD>    if (getTradingProduct(product.productKeys.productKey) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">623</TD><TD>        return;  // already created by another thread.</TD></TR><TR><TD CLASS="l">624</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">625</TD><TD>    TradingClass tradingClass = getTradingClass(product.productKeys.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">626</TD><TD>    if (tradingClass == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">627</TD><TD>        Log.alarm(&#34;ProductStateServiceLocalImpl &gt;&gt; addProductImmediately. TradingClass not found:&#34; + product.productKeys.classKey );</TD></TR><TR CLASS="z"><TD CLASS="l">628</TD><TD>        return;</TD></TR><TR><TD CLASS="l">629</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">630</TD><TD>    TradingProduct tradingProduct = null;</TD></TR><TR CLASS="z"><TD CLASS="l">631</TD><TD>    boolean success = false;</TD></TR><TR><TD CLASS="l">632</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">633</TD><TD>        Transaction.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">634</TD><TD>        tradingProduct = cachedTradingProductHome.create(tradingClass, product, true);</TD></TR><TR CLASS="z"><TD CLASS="l">635</TD><TD>        createOrderBook(tradingProduct);</TD></TR><TR CLASS="z"><TD CLASS="l">636</TD><TD>        createBroker(tradingProduct);</TD></TR><TR><TD CLASS="l">637</TD><TD>        try</TD></TR><TR><TD CLASS="l">638</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">639</TD><TD>            if (tradingClass.isProxy() == false)</TD></TR><TR><TD CLASS="l">640</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">641</TD><TD>            cachedMarketDataHome.create(tradingClass.getSessionName(), product.productKeys.productKey, tradingClass.getProductClassKey());</TD></TR><TR><TD CLASS="l">642</TD><TD>            }</TD></TR><TR><TD CLASS="l">643</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">644</TD><TD>        catch (AlreadyExistsException ex)</TD></TR><TR><TD CLASS="l">645</TD><TD>        {</TD></TR><TR><TD CLASS="l">646</TD><TD>            // this is ok: product's market data may have been created while slave.</TD></TR><TR><TD CLASS="l">647</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">648</TD><TD>        success = Transaction.commit();</TD></TR><TR><TD CLASS="l">649</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">650</TD><TD>    catch (Exception e){</TD></TR><TR CLASS="z"><TD CLASS="l">651</TD><TD>        Log.alarm(&#34;ProductStateServiceLocalImpls &gt;&gt; addProductImmediately. TradingProduct creation failed: &#34; + product.productKeys.productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">652</TD><TD>        Log.exception(e);</TD></TR><TR><TD CLASS="l">653</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">654</TD><TD>    finally {</TD></TR><TR CLASS="z"><TD CLASS="l">655</TD><TD>        if (success) {</TD></TR><TR CLASS="z"><TD CLASS="l">656</TD><TD>            if (tradingClass.isProxy() == false)</TD></TR><TR><TD CLASS="l">657</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">658</TD><TD>                publishProductStateChange(tradingProduct);</TD></TR><TR CLASS="z"><TD CLASS="l">659</TD><TD>                ((TradingProductImpl)tradingProduct).notifyStateChangeListeners(tradingProduct.getCurrentStateCode());</TD></TR><TR><TD CLASS="l">660</TD><TD>            }</TD></TR><TR><TD CLASS="l">661</TD><TD>        }</TD></TR><TR><TD CLASS="l">662</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">663</TD><TD>            Transaction.rollback();</TD></TR><TR><TD CLASS="l">664</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">665</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">666</TD><TD>}</TD></TR><TR><TD CLASS="l">667</TD><TD> </TD></TR><TR><TD CLASS="l">668</TD><TD>/**</TD></TR><TR><TD CLASS="l">669</TD><TD> * For intra-day adds that support product-level locking, the broker needs to be initialized</TD></TR><TR><TD CLASS="l">670</TD><TD> * when the trading product is being added.  This is called by both product and strategy create</TD></TR><TR><TD CLASS="l">671</TD><TD> * methods.</TD></TR><TR><TD CLASS="l">672</TD><TD> *  </TD></TR><TR><TD CLASS="l">673</TD><TD> * @param p_tradingProduct</TD></TR><TR><TD CLASS="l">674</TD><TD> */</TD></TR><TR><TD CLASS="l"><A NAME="33">675</A></TD><TD>protected void createBroker(TradingProduct p_tradingProduct)</TD></TR><TR><TD CLASS="l">676</TD><TD>{</TD></TR><TR><TD CLASS="l">677</TD><TD>    // findByProduct() triggers product-level-lock creation if the product is</TD></TR><TR><TD CLASS="l">678</TD><TD>    // of an applicable type.</TD></TR><TR CLASS="z"><TD CLASS="l">679</TD><TD>    if(p_tradingProduct.isProxy())</TD></TR><TR><TD CLASS="l">680</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">681</TD><TD>        brokerHome.findByProxyProduct(p_tradingProduct);</TD></TR><TR><TD CLASS="l">682</TD><TD>    }</TD></TR><TR><TD CLASS="l">683</TD><TD>    else</TD></TR><TR><TD CLASS="l">684</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">685</TD><TD>        brokerHome.findByProduct(p_tradingProduct.getProductKey());</TD></TR><TR><TD CLASS="l">686</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">687</TD><TD>}</TD></TR><TR><TD CLASS="l">688</TD><TD> </TD></TR><TR><TD CLASS="l">689</TD><TD>/**</TD></TR><TR><TD CLASS="l">690</TD><TD> * Adds a &lt;code&gt;StateChangeListener&lt;/code&gt; to this service.</TD></TR><TR><TD CLASS="l">691</TD><TD> *</TD></TR><TR><TD CLASS="l"><A NAME="1c">692</A></TD><TD> * @see ProductStateServiceLocal#addStateChangeListener</TD></TR><TR><TD CLASS="l">693</TD><TD> * @since Increment 5</TD></TR><TR><TD CLASS="l">694</TD><TD> */</TD></TR><TR><TD CLASS="l">695</TD><TD>public void addStateChangeListener(StateChangeListener listener) {</TD></TR><TR CLASS="z"><TD CLASS="l">696</TD><TD>    productStateCollector.addProductStateListener(listener);</TD></TR><TR CLASS="z"><TD CLASS="l">697</TD><TD>}</TD></TR><TR><TD CLASS="l">698</TD><TD>/**</TD></TR><TR><TD CLASS="l">699</TD><TD> * Processes intraday strategy addition through command processor</TD></TR><TR><TD CLASS="l"><A NAME="1d">700</A></TD><TD> *</TD></TR><TR><TD CLASS="l">701</TD><TD> * @see ProductStateServiceLocal#addStrategy</TD></TR><TR><TD CLASS="l">702</TD><TD> */</TD></TR><TR><TD CLASS="l">703</TD><TD>public void addStrategy(StrategyStruct aStrategy){</TD></TR><TR CLASS="z"><TD CLASS="l">704</TD><TD>    if(sleepInterval &gt; 0) {</TD></TR><TR><TD CLASS="l">705</TD><TD>        try</TD></TR><TR><TD CLASS="l">706</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">707</TD><TD>            Thread.sleep(sleepInterval);</TD></TR><TR><TD CLASS="l">708</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">709</TD><TD>        catch (InterruptedException e)</TD></TR><TR><TD CLASS="l">710</TD><TD>        {</TD></TR><TR><TD CLASS="l">711</TD><TD>        }</TD></TR><TR><TD CLASS="l">712</TD><TD>    }</TD></TR><TR><TD CLASS="l">713</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">714</TD><TD>        TradingClass tradingClass = cachedTradingClassHome.findByKey(aStrategy.product.productKeys.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">715</TD><TD>        int productKey = aStrategy.product.productKeys.productKey;</TD></TR><TR><TD CLASS="l">716</TD><TD>        try</TD></TR><TR><TD CLASS="l">717</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">718</TD><TD>            getProductDataCache(productKey);</TD></TR><TR><TD CLASS="l">719</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">720</TD><TD>        catch(Exception exe)</TD></TR><TR><TD CLASS="l">721</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">722</TD><TD>            Log.alarm(&#34;ProductStateServiceLocalImpl&gt;&gt;&gt;addStrategy: Calling Global, instead of command failed will try to add through command:&#34; + productKey);</TD></TR><TR><TD CLASS="l">723</TD><TD>            </TD></TR><TR><TD CLASS="l">724</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">725</TD><TD>        if (tradingClass.isProxy()){</TD></TR><TR CLASS="z"><TD CLASS="l">726</TD><TD>            addStrategyImmediately(aStrategy);</TD></TR><TR CLASS="z"><TD CLASS="l">727</TD><TD>            return;</TD></TR><TR><TD CLASS="l">728</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">729</TD><TD>        AddStrategyCommand aCommand = new AddStrategyCommand(aStrategy);</TD></TR><TR CLASS="z"><TD CLASS="l">730</TD><TD>        tradingClass.acceptCommand(aCommand,false); //false indicate not putting the command into queue. Execute it immediately</TD></TR><TR><TD CLASS="l">731</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">732</TD><TD>    catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">733</TD><TD>        String aProduct = &#34;&#34; + aStrategy.product.productKeys.classKey + &#34;-&#34; + aStrategy.product.productKeys.productKey;</TD></TR><TR CLASS="z"><TD CLASS="l">734</TD><TD>        Log.information(&#34;ProductStateServiceLocalImpl&gt;&gt;&gt;addStrategy: StrategyProduct:&#34; + aProduct + &#34; cannot be added.&#34;+e.getMessage());</TD></TR><TR><TD CLASS="l">735</TD><TD>        //Log.exception(&#34;ProductStateServiceLocalImpl&gt;&gt;&gt;addStrategy: StrategyProduct:&#34; + aProduct + &#34; cannot be added.&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">736</TD><TD>    } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">737</TD><TD>        sleepInterval = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">738</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">739</TD><TD>}</TD></TR><TR><TD CLASS="l">740</TD><TD> </TD></TR><TR><TD CLASS="l">741</TD><TD>/**</TD></TR><TR><TD CLASS="l">742</TD><TD> * Process intraday strategy addition without delay.</TD></TR><TR><TD CLASS="l">743</TD><TD> *</TD></TR><TR><TD CLASS="l">744</TD><TD> * Note: It is important that this method has to be wrapped in a command. And synchronized on the</TD></TR><TR><TD CLASS="l">745</TD><TD> * command execution level. Otherwide two race conditions: 1) with strategy leg events. 2). with</TD></TR><TR><TD CLASS="l">746</TD><TD> * another thread trying to add the same strategy. Synchronization on this method will not resolve</TD></TR><TR><TD CLASS="l">747</TD><TD> * the problems.</TD></TR><TR><TD CLASS="l"><A NAME="1e">748</A></TD><TD> */</TD></TR><TR><TD CLASS="l">749</TD><TD>public void addStrategyImmediately(StrategyStruct strategy) {</TD></TR><TR><TD CLASS="l">750</TD><TD>    </TD></TR><TR><TD CLASS="l">751</TD><TD>    //Log.exception(&#34;########PSSLI addStrategyImmediately#######&#34;+strategy.product.productKeys.productKey, new Exception());</TD></TR><TR CLASS="z"><TD CLASS="l">752</TD><TD>    if (getTradingProduct(strategy.product.productKeys.productKey) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">753</TD><TD>        return;  // already created by another thread.</TD></TR><TR><TD CLASS="l">754</TD><TD>    }</TD></TR><TR><TD CLASS="l">755</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">756</TD><TD>    TradingClass tradingClass = getTradingClass(strategy.product.productKeys.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">757</TD><TD>    if (tradingClass == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">758</TD><TD>        Log.information(&#34;ProductStateServiceLocalImpl &gt;&gt; addStrategyImmediately. TradingClass not found:&#34; + strategy.product.productKeys.classKey );</TD></TR><TR CLASS="z"><TD CLASS="l">759</TD><TD>        return;</TD></TR><TR><TD CLASS="l">760</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">761</TD><TD>    TradingProduct tradingProduct = null;</TD></TR><TR CLASS="z"><TD CLASS="l">762</TD><TD>    boolean success = false;</TD></TR><TR><TD CLASS="l">763</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">764</TD><TD>        Transaction.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">765</TD><TD>        tradingProduct = cachedTradingProductHome.create(tradingClass, strategy, true);</TD></TR><TR CLASS="z"><TD CLASS="l">766</TD><TD>        createOrderBook(tradingProduct);</TD></TR><TR CLASS="z"><TD CLASS="l">767</TD><TD>        createBroker(tradingProduct);</TD></TR><TR CLASS="z"><TD CLASS="l">768</TD><TD>        success = Transaction.commit();</TD></TR><TR><TD CLASS="l">769</TD><TD>        try</TD></TR><TR><TD CLASS="l">770</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">771</TD><TD>            cachedMarketDataHome.create(tradingClass.getSessionName(), strategy.product.productKeys.productKey, tradingClass.getProductClassKey());</TD></TR><TR><TD CLASS="l">772</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">773</TD><TD>        catch (Exception ex)</TD></TR><TR><TD CLASS="l">774</TD><TD>        {</TD></TR><TR><TD CLASS="l">775</TD><TD>            // this is ok: product's market data may have been created while slave.</TD></TR><TR><TD CLASS="l">776</TD><TD>        }</TD></TR><TR><TD CLASS="l">777</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">778</TD><TD>    catch (Exception e){</TD></TR><TR CLASS="z"><TD CLASS="l">779</TD><TD>        Log.alarm(&#34;ProductStateServiceLocalImpl &gt;&gt; addStrategyImmediately. TradingProduct creation failed: &#34; + strategy.product.productKeys.productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">780</TD><TD>        Log.exception(e);</TD></TR><TR><TD CLASS="l">781</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">782</TD><TD>    finally {</TD></TR><TR CLASS="z"><TD CLASS="l">783</TD><TD>        if (success) {</TD></TR><TR CLASS="z"><TD CLASS="l">784</TD><TD>            publishProductStateChange(tradingProduct);</TD></TR><TR><TD CLASS="l">785</TD><TD>        }</TD></TR><TR><TD CLASS="l">786</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">787</TD><TD>            Transaction.rollback();</TD></TR><TR><TD CLASS="l">788</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">789</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">790</TD><TD>}</TD></TR><TR><TD CLASS="l">791</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="4c">792</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">793</TD><TD>     * return TradingProduct given the product key. Null is returned if none is found</TD></TR><TR><TD CLASS="l">794</TD><TD>     */</TD></TR><TR><TD CLASS="l">795</TD><TD>    protected TradingProduct getTradingProduct(int prodKey){</TD></TR><TR CLASS="z"><TD CLASS="l">796</TD><TD>        TradingProduct result = null;</TD></TR><TR><TD CLASS="l">797</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">798</TD><TD>            result = cachedTradingProductHome.findByKey(prodKey);</TD></TR><TR><TD CLASS="l">799</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">800</TD><TD>        catch (NotFoundException e){</TD></TR><TR><TD CLASS="l">801</TD><TD>           //doing nothing if not found</TD></TR><TR><TD CLASS="l">802</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">803</TD><TD>        return result;</TD></TR><TR><TD CLASS="l">804</TD><TD>    }</TD></TR><TR><TD CLASS="l">805</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="49">806</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">807</TD><TD>     * return TradingClass given the product class key. Null is returned if none is found</TD></TR><TR><TD CLASS="l">808</TD><TD>     */</TD></TR><TR><TD CLASS="l">809</TD><TD>    protected TradingClass getTradingClass(int classKey){</TD></TR><TR CLASS="z"><TD CLASS="l">810</TD><TD>        TradingClass result = null;</TD></TR><TR><TD CLASS="l">811</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">812</TD><TD>            result = cachedTradingClassHome.findByKey(classKey);</TD></TR><TR><TD CLASS="l">813</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">814</TD><TD>        catch (NotFoundException e) {</TD></TR><TR><TD CLASS="l">815</TD><TD>            //doing nothing if not found</TD></TR><TR><TD CLASS="l">816</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">817</TD><TD>        return result;</TD></TR><TR><TD CLASS="l">818</TD><TD>    }</TD></TR><TR><TD CLASS="l">819</TD><TD> </TD></TR><TR><TD CLASS="l">820</TD><TD>/**</TD></TR><TR><TD CLASS="l">821</TD><TD> * Adds a &lt;code&gt;VetoableStateChangeListener&lt;/code&gt; to this service.</TD></TR><TR><TD CLASS="l">822</TD><TD> *</TD></TR><TR><TD CLASS="l"><A NAME="1f">823</A></TD><TD> * @see ProductStateServiceLocal#addVetoableStateChangeListener</TD></TR><TR><TD CLASS="l">824</TD><TD> * @since Increment 3</TD></TR><TR><TD CLASS="l">825</TD><TD> */</TD></TR><TR><TD CLASS="l">826</TD><TD>public void addVetoableStateChangeListener(VetoableStateChangeListener listener) {</TD></TR><TR CLASS="z"><TD CLASS="l">827</TD><TD>    vetoableListenerList.add(VetoableStateChangeListener.class, listener);</TD></TR><TR CLASS="z"><TD CLASS="l">828</TD><TD>}</TD></TR><TR><TD CLASS="l">829</TD><TD>/**</TD></TR><TR><TD CLASS="l">830</TD><TD> * Changes status of a trading session.</TD></TR><TR><TD CLASS="l">831</TD><TD> *</TD></TR><TR><TD CLASS="l">832</TD><TD> * @param sessionName trading session to be started</TD></TR><TR><TD CLASS="l"><A NAME="2d">833</A></TD><TD> * @param initialState new state for products of session</TD></TR><TR><TD CLASS="l">834</TD><TD> */</TD></TR><TR><TD CLASS="l">835</TD><TD>public void changeSessionStatus(String sessionName, short initialState) </TD></TR><TR><TD CLASS="l">836</TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">837</TD><TD>        changeSessionStatus(sessionName,initialState,true);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2e">838</A></TD><TD>}</TD></TR><TR><TD CLASS="l">839</TD><TD> </TD></TR><TR><TD CLASS="l">840</TD><TD>public void changeSessionStatus(String sessionName, short initialState,boolean useCommand) </TD></TR><TR><TD CLASS="l">841</TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">842</TD><TD>    TradingSessionElementClassesDetailStruct[] classes = getElementClassesForSession(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">843</TD><TD>    doSessionStatusUpdate(sessionName, initialState, classes, false,useCommand); // create non-strategies</TD></TR><TR><TD CLASS="l">844</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">845</TD><TD>    if (initialState == ProductStates.CLOSED)</TD></TR><TR><TD CLASS="l">846</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">847</TD><TD>        getTradingClassHome().createProxyObjects();</TD></TR><TR><TD CLASS="l">848</TD><TD>    }</TD></TR><TR><TD CLASS="l">849</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">850</TD><TD>    doSessionStatusUpdate(sessionName, initialState, classes, true,useCommand); // create strategies</TD></TR><TR CLASS="z"><TD CLASS="l">851</TD><TD>    Log.information(this, &#34;Completed status change for products in &#34; + sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">852</TD><TD>}</TD></TR><TR><TD CLASS="l">853</TD><TD> </TD></TR><TR><TD CLASS="l">854</TD><TD>private void doSessionStatusUpdate(String sessionName, short initialState,</TD></TR><TR><TD CLASS="l"><A NAME="38">855</A></TD><TD>        TradingSessionElementClassesDetailStruct[] classes, boolean p_strategies,boolean useCommand)</TD></TR><TR><TD CLASS="l">856</TD><TD>{</TD></TR><TR><TD CLASS="l">857</TD><TD>    //updateTradingClassHome(classes); //future usage</TD></TR><TR><TD CLASS="l">858</TD><TD>//    int numberBuildThreads = ((ProductStateServiceLocalHomeImpl) getBOHome()).getNumberBuildThreads();</TD></TR><TR CLASS="z"><TD CLASS="l">859</TD><TD>    SessionStatusThread[] threads = new SessionStatusThread[numberOfBuildThreads];</TD></TR><TR CLASS="z"><TD CLASS="l">860</TD><TD>    if (initialState == ProductStates.CLOSED) {</TD></TR><TR CLASS="z"><TD CLASS="l">861</TD><TD>        Log.information(this, &#34;Adding &#34; + classes.length + &#34; configured classes to &#34; + sessionName +</TD></TR><TR CLASS="z"><TD CLASS="l">862</TD><TD>                &#34; The number of build threads is=&#34; + numberOfBuildThreads + &#34;.  Will filter for &#34;+(p_strategies?&#34;&#34;:&#34;non-&#34;)+&#34;strategies&#34;);</TD></TR><TR><TD CLASS="l">863</TD><TD>    }</TD></TR><TR><TD CLASS="l">864</TD><TD>    else {</TD></TR><TR CLASS="z"><TD CLASS="l">865</TD><TD>        Log.information(this, &#34;Removing &#34; + classes.length + &#34; configured classes from &#34; + sessionName +</TD></TR><TR CLASS="z"><TD CLASS="l">866</TD><TD>                &#34; The number of build threads is=&#34; + numberOfBuildThreads + &#34;.  Will filter for &#34;+(p_strategies?&#34;&#34;:&#34;non-&#34;)+&#34;strategies&#34;);</TD></TR><TR><TD CLASS="l">867</TD><TD>    }</TD></TR><TR><TD CLASS="l">868</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">869</TD><TD>    for (int threadNumber = 0; threadNumber &lt; numberOfBuildThreads; threadNumber++) {</TD></TR><TR CLASS="z"><TD CLASS="l">870</TD><TD>        threads[threadNumber] = new SessionStatusThread(sessionName, initialState, threadNumber, numberOfBuildThreads, classes, p_strategies,useCommand);</TD></TR><TR CLASS="z"><TD CLASS="l">871</TD><TD>        threads[threadNumber].start();</TD></TR><TR><TD CLASS="l">872</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">873</TD><TD>    Log.information(this, &#34;Waiting for threads to complete.  Filtering for &#34;+(p_strategies?&#34;&#34;:&#34;non-&#34;)+&#34;strategies...&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">874</TD><TD>    for (int i = 0; i &lt; numberOfBuildThreads; i++) {</TD></TR><TR><TD CLASS="l">875</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">876</TD><TD>            threads[i].join();</TD></TR><TR><TD CLASS="l">877</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">878</TD><TD>        catch (InterruptedException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">879</TD><TD>            Log.alarm(this, &#34;Interrupted while waiting for threads to complete - ending wait&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">880</TD><TD>            return;</TD></TR><TR><TD CLASS="l">881</TD><TD>        }</TD></TR><TR><TD CLASS="l">882</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">883</TD><TD>    Log.information(this, &#34;Threads are complete.  Filtered for &#34;+(p_strategies?&#34;&#34;:&#34;non-&#34;)+&#34;strategies.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">884</TD><TD>}</TD></TR><TR><TD CLASS="l">885</TD><TD>/**</TD></TR><TR><TD CLASS="l">886</TD><TD> * Completes product state change.</TD></TR><TR><TD CLASS="l">887</TD><TD> *</TD></TR><TR><TD CLASS="l">888</TD><TD> * @param product trading product with state change in progress</TD></TR><TR><TD CLASS="l"><A NAME="2f">889</A></TD><TD> * @param newState new state for the product</TD></TR><TR><TD CLASS="l">890</TD><TD> * @param immediate if true, state change is being done immediately.</TD></TR><TR><TD CLASS="l">891</TD><TD> */</TD></TR><TR><TD CLASS="l">892</TD><TD>protected void completeStateChange(TradingProductImpl product, short newState, boolean immediate) {</TD></TR><TR CLASS="z"><TD CLASS="l">893</TD><TD>    product.completeStateChange(newState, immediate);</TD></TR><TR CLASS="z"><TD CLASS="l">894</TD><TD>    publishProductStateChange(product);</TD></TR><TR><TD CLASS="l">895</TD><TD>    //add this product to list of products for which state changed, with trading class</TD></TR><TR CLASS="z"><TD CLASS="l">896</TD><TD>    product.getTradingClass().addProductForStateChangeNotification(product);</TD></TR><TR CLASS="z"><TD CLASS="l">897</TD><TD>}</TD></TR><TR><TD CLASS="l">898</TD><TD>/**</TD></TR><TR><TD CLASS="l">899</TD><TD> * For Open session, publish the product states as long as the product</TD></TR><TR><TD CLASS="l">900</TD><TD> * is neither in &#34;Close&#34; nor &#34;No_Session&#34; state.</TD></TR><TR><TD CLASS="l">901</TD><TD> * Normally called on failover to publish &#34;Halted&#34; state.</TD></TR><TR><TD CLASS="l"><A NAME="62">902</A></TD><TD> * @author singh    Modified to block more at time of publishing prod. state change - 8/31/05</TD></TR><TR><TD CLASS="l">903</TD><TD> *</TD></TR><TR><TD CLASS="l">904</TD><TD> */</TD></TR><TR><TD CLASS="l">905</TD><TD>protected void publishProductStatesForOpenSession() {</TD></TR><TR CLASS="z"><TD CLASS="l">906</TD><TD>    String sessionName = TradingSessionNameHelper.getOpenConfiguredSessionName();</TD></TR><TR CLASS="z"><TD CLASS="l">907</TD><TD>    if (null != sessionName) {</TD></TR><TR CLASS="z"><TD CLASS="l">908</TD><TD>        TradingClass[] configuredClasses = cachedTradingClassHome.findAllConfiguredForSession(sessionName);</TD></TR><TR><TD CLASS="l">909</TD><TD>        TradingProduct[] products;</TD></TR><TR><TD CLASS="l">910</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">911</TD><TD>        TradingProduct[] list = new TradingProduct[100];</TD></TR><TR CLASS="z"><TD CLASS="l">912</TD><TD>        int listCount = 0;</TD></TR><TR><TD CLASS="l">913</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">914</TD><TD>        for (int i = 0; i &lt; configuredClasses.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">915</TD><TD>            products = configuredClasses[i].getProducts(true);</TD></TR><TR><TD CLASS="l">916</TD><TD> </TD></TR><TR><TD CLASS="l">917</TD><TD>            // block at class level for publishing events. Create an array of trading products that need their states</TD></TR><TR><TD CLASS="l">918</TD><TD>            // published.</TD></TR><TR CLASS="z"><TD CLASS="l">919</TD><TD>            if (list.length &lt; products.length)</TD></TR><TR><TD CLASS="l">920</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">921</TD><TD>                list = new TradingProduct [products.length * 2];</TD></TR><TR><TD CLASS="l">922</TD><TD>            }</TD></TR><TR><TD CLASS="l">923</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">924</TD><TD>            listCount = 0;</TD></TR><TR><TD CLASS="l">925</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">926</TD><TD>            for (int j = 0; j &lt; products.length; j ++) {</TD></TR><TR CLASS="z"><TD CLASS="l">927</TD><TD>                if ( products[j].getCurrentStateCode() != ProductStates.NO_SESSION &amp;&amp;</TD></TR><TR CLASS="z"><TD CLASS="l">928</TD><TD>                        products[j].getCurrentStateCode() != ProductStates.CLOSED ) {</TD></TR><TR CLASS="z"><TD CLASS="l">929</TD><TD>                    list[listCount++] = products[j];</TD></TR><TR><TD CLASS="l">930</TD><TD>                }</TD></TR><TR><TD CLASS="l">931</TD><TD>            }</TD></TR><TR><TD CLASS="l">932</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">933</TD><TD>            if (listCount &gt; 0)</TD></TR><TR><TD CLASS="l">934</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">935</TD><TD>                publishProductStateChange(list, listCount, false);</TD></TR><TR CLASS="z"><TD CLASS="l">936</TD><TD>                notifyListenersForProductStateChange(list, listCount);</TD></TR><TR><TD CLASS="l">937</TD><TD>            }</TD></TR><TR><TD CLASS="l">938</TD><TD>        }</TD></TR><TR><TD CLASS="l">939</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">940</TD><TD>}</TD></TR><TR><TD CLASS="l">941</TD><TD>   </TD></TR><TR><TD CLASS="l">942</TD><TD>/**</TD></TR><TR><TD CLASS="l">943</TD><TD> * This method populates an internal hashmap with trading classes in slave mode to save time in go master.</TD></TR><TR><TD CLASS="l">944</TD><TD> * Most of the time is spent in querying for trading properties. By loading these in the slave mode, we save time</TD></TR><TR><TD CLASS="l">945</TD><TD> * in go master.</TD></TR><TR><TD CLASS="l">946</TD><TD> * @author singh</TD></TR><TR><TD CLASS="l"><A NAME="39">947</A></TD><TD> *</TD></TR><TR><TD CLASS="l">948</TD><TD> */</TD></TR><TR><TD CLASS="l">949</TD><TD>public void fetchTradingProperties ()</TD></TR><TR><TD CLASS="l">950</TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">951</TD><TD>    Log.information(&#34;Loading trading properties&#34;);</TD></TR><TR><TD CLASS="l">952</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">953</TD><TD>        int[] classKeys = ConfigurationGroupHelper.getClassKeysForRouteName();</TD></TR><TR><TD CLASS="l">954</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">955</TD><TD>        int[] proxyClassKeys = getClassKeysForBuddyClasses();</TD></TR><TR><TD CLASS="l">956</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">957</TD><TD>        int[] classKeysIncludingProxyClassKeys = new int[classKeys.length + proxyClassKeys.length];</TD></TR><TR><TD CLASS="l">958</TD><TD>        </TD></TR><TR><TD CLASS="l">959</TD><TD>        //Add the Proxy classes to the list. </TD></TR><TR CLASS="z"><TD CLASS="l">960</TD><TD>        System.arraycopy(classKeys, 0, classKeysIncludingProxyClassKeys, 0, classKeys.length);</TD></TR><TR CLASS="z"><TD CLASS="l">961</TD><TD>        System.arraycopy(proxyClassKeys, 0, classKeysIncludingProxyClassKeys, classKeys.length, proxyClassKeys.length);</TD></TR><TR><TD CLASS="l">962</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">963</TD><TD>        ProductClassStruct[] configuredClasses = BusinessServicesHelper.getProductQueryService().getProductClassesByKey( classKeysIncludingProxyClassKeys, true, true, true );</TD></TR><TR><TD CLASS="l">964</TD><TD>        </TD></TR><TR><TD CLASS="l">965</TD><TD>//        int numberBuildThreads = ((ProductStateServiceLocalHomeImpl) getBOHome()).getNumberBuildThreads();</TD></TR><TR><TD CLASS="l">966</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">967</TD><TD>        Log.information(this, &#34;Starting &#34; + numberOfBuildThreads + &#34; threads for getting trading properties of &#34; + configuredClasses.length + &#34; configured classes&#34;);</TD></TR><TR><TD CLASS="l">968</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">969</TD><TD>        cachedTradingClassHome.initTradingPropertyCache (classKeys.length);</TD></TR><TR><TD CLASS="l">970</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">971</TD><TD>        TradingPropertyFetchThread[] threads = new TradingPropertyFetchThread[numberOfBuildThreads];</TD></TR><TR><TD CLASS="l">972</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">973</TD><TD>        for (int threadNumber = 0; threadNumber &lt; numberOfBuildThreads; threadNumber++) {</TD></TR><TR CLASS="z"><TD CLASS="l">974</TD><TD>            threads[threadNumber] = new TradingPropertyFetchThread(threadNumber, numberOfBuildThreads, configuredClasses);</TD></TR><TR CLASS="z"><TD CLASS="l">975</TD><TD>            threads[threadNumber].start();</TD></TR><TR><TD CLASS="l">976</TD><TD>        }</TD></TR><TR><TD CLASS="l">977</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">978</TD><TD>        Log.information(this, &#34;Waiting for threads to complete loading trading properties&#34;);</TD></TR><TR><TD CLASS="l">979</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">980</TD><TD>        for (int i = 0; i &lt; numberOfBuildThreads; i++) {</TD></TR><TR><TD CLASS="l">981</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">982</TD><TD>                threads[i].join();</TD></TR><TR><TD CLASS="l">983</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">984</TD><TD>            catch (InterruptedException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">985</TD><TD>                Log.alarm(this, &#34;Interrupted while waiting for threads - assume wait should end&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">986</TD><TD>                return;</TD></TR><TR><TD CLASS="l">987</TD><TD>            }</TD></TR><TR><TD CLASS="l">988</TD><TD>        }</TD></TR><TR><TD CLASS="l">989</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">990</TD><TD>    catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">991</TD><TD>        Log.exception( this, &#34;Failed to load trading properties&#34;, e);</TD></TR><TR><TD CLASS="l">992</TD><TD>    }</TD></TR><TR><TD CLASS="l">993</TD><TD>    finally</TD></TR><TR CLASS="z"><TD CLASS="l">994</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">995</TD><TD>        Log.information(&#34;Done loading trading properties&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">996</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">997</TD><TD>}</TD></TR><TR><TD CLASS="l">998</TD><TD> </TD></TR><TR><TD CLASS="l">999</TD><TD>/**</TD></TR><TR><TD CLASS="l"><A NAME="30">1000</A></TD><TD> * Configures service with products.</TD></TR><TR><TD CLASS="l">1001</TD><TD> */</TD></TR><TR><TD CLASS="l">1002</TD><TD>protected void configureProducts() {</TD></TR><TR><TD CLASS="l">1003</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">1004</TD><TD>        int[] classKeysForRouteName = ConfigurationGroupHelper.getClassKeysForRouteName();</TD></TR><TR><TD CLASS="l">1005</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1006</TD><TD>        int[] proxyClassKeys = getClassKeysForBuddyClasses();</TD></TR><TR><TD CLASS="l">1007</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1008</TD><TD>        int[] classKeys = new int[classKeysForRouteName.length + proxyClassKeys.length];</TD></TR><TR><TD CLASS="l">1009</TD><TD>        </TD></TR><TR><TD CLASS="l">1010</TD><TD>        //Add the Proxy classes to the list. </TD></TR><TR CLASS="z"><TD CLASS="l">1011</TD><TD>        System.arraycopy(classKeysForRouteName, 0, classKeys, 0, classKeysForRouteName.length);</TD></TR><TR CLASS="z"><TD CLASS="l">1012</TD><TD>        System.arraycopy(proxyClassKeys, 0, classKeys, classKeysForRouteName.length, proxyClassKeys.length);</TD></TR><TR><TD CLASS="l">1013</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1014</TD><TD>        Log.information(this, &#34;Retrieved classes &#34; + (classKeys != null? classKeys.length : 0) + &#34; for routename &#34; + RouteNameHelper.getRouteName());</TD></TR><TR><TD CLASS="l">1015</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1016</TD><TD>        ProductClassStruct[] configuredClasses = BusinessServicesHelper.getProductQueryService().getProductClassesByKey( classKeys, true, true, true );</TD></TR><TR><TD CLASS="l">1017</TD><TD>        // build classes in two steps - first create options and then strategies.</TD></TR><TR CLASS="z"><TD CLASS="l">1018</TD><TD>        ArrayList&lt;ProductClassStruct&gt; nonStrategies = new ArrayList&lt;ProductClassStruct&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1019</TD><TD>        ArrayList&lt;ProductClassStruct&gt; strategies = new ArrayList&lt;ProductClassStruct&gt;();</TD></TR><TR><TD CLASS="l">1020</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1021</TD><TD>        for (ProductClassStruct struct : configuredClasses)</TD></TR><TR><TD CLASS="l">1022</TD><TD>        {            </TD></TR><TR CLASS="z"><TD CLASS="l">1023</TD><TD>            if (struct.info.productType != ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">1024</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1025</TD><TD>                nonStrategies.add(struct);</TD></TR><TR><TD CLASS="l">1026</TD><TD>            }</TD></TR><TR><TD CLASS="l">1027</TD><TD>            else</TD></TR><TR><TD CLASS="l">1028</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1029</TD><TD>                strategies.add(struct);</TD></TR><TR><TD CLASS="l">1030</TD><TD>            }</TD></TR><TR><TD CLASS="l">1031</TD><TD>        }</TD></TR><TR><TD CLASS="l">1032</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1033</TD><TD>        final boolean sessionIsOpen = TradingSessionNameHelper.getOpenConfiguredSessionName() != null;</TD></TR><TR><TD CLASS="l">1034</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1035</TD><TD>        Log.information(this, &#34;Configured non_strategy products: &#34; + nonStrategies.size() + &#34; sessionIsOpen=&#34;+sessionIsOpen);</TD></TR><TR CLASS="z"><TD CLASS="l">1036</TD><TD>        if (nonStrategies.size() != 0)</TD></TR><TR><TD CLASS="l">1037</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1038</TD><TD>            buildProducts(nonStrategies, &#34;non-strategy classes&#34;);</TD></TR><TR><TD CLASS="l">1039</TD><TD>        }</TD></TR><TR><TD CLASS="l">1040</TD><TD>        else</TD></TR><TR><TD CLASS="l">1041</TD><TD>        {</TD></TR><TR><TD CLASS="l">1042</TD><TD>            // ask trading class home to load proxies (options because you are in spread trade server)</TD></TR><TR CLASS="z"><TD CLASS="l">1043</TD><TD>            Log.information(&#34;PSSLI: server has no non-strategy products to create&#34;);</TD></TR><TR><TD CLASS="l">1044</TD><TD>        }</TD></TR><TR><TD CLASS="l">1045</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1046</TD><TD>        if (sessionIsOpen)</TD></TR><TR><TD CLASS="l">1047</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1048</TD><TD>            getTradingClassHome().createProxyObjects();</TD></TR><TR><TD CLASS="l">1049</TD><TD>        }</TD></TR><TR><TD CLASS="l">1050</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1051</TD><TD>        Log.information(this, &#34;Configured strategy product count = &#34; + strategies.size() + &#34; sessionIsOpen=&#34;+sessionIsOpen);</TD></TR><TR><TD CLASS="l">1052</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1053</TD><TD>        if (strategies.size() != 0)</TD></TR><TR><TD CLASS="l">1054</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1055</TD><TD>            buildProducts(strategies, &#34;strategy classes&#34;);</TD></TR><TR><TD CLASS="l">1056</TD><TD>        }</TD></TR><TR><TD CLASS="l">1057</TD><TD>        else</TD></TR><TR><TD CLASS="l">1058</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1059</TD><TD>            Log.information(&#34;PSSLI: server has no strategy products to create&#34;);</TD></TR><TR><TD CLASS="l">1060</TD><TD>        }</TD></TR><TR><TD CLASS="l">1061</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1062</TD><TD>        cachedTradingProductHome.completedBuildTradingProducts();</TD></TR><TR><TD CLASS="l">1063</TD><TD> </TD></TR><TR><TD CLASS="l">1064</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1065</TD><TD>        String sessionName = TradingSessionNameHelper.getOpenConfiguredSessionName();</TD></TR><TR CLASS="z"><TD CLASS="l">1066</TD><TD>        if( sessionName != null &amp;&amp; ! sessionName.equals(&#34;&#34;) )</TD></TR><TR><TD CLASS="l">1067</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1068</TD><TD>            Log.information(this, &#34;CDXFF - Adding products to session[&#34; + sessionName + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1069</TD><TD>            this.changeSessionStatus(sessionName, ProductStates.CLOSED);</TD></TR><TR CLASS="z"><TD CLASS="l">1070</TD><TD>            Log.information(this, &#34;CDXFF - Added products to session[&#34; + sessionName + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">1071</TD><TD>        }</TD></TR><TR><TD CLASS="l">1072</TD><TD>        </TD></TR><TR><TD CLASS="l">1073</TD><TD>        //Apply product state update from distributed cache in started as slave</TD></TR><TR CLASS="z"><TD CLASS="l">1074</TD><TD>        cachedTradingProductHome.updateFromSync();</TD></TR><TR><TD CLASS="l">1075</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1076</TD><TD>        getTradingClassHome().completedBuildTradingClasses();</TD></TR><TR CLASS="z"><TD CLASS="l">1077</TD><TD>        Log.information(this, &#34;All configured classes have been built&#34;);</TD></TR><TR><TD CLASS="l">1078</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1079</TD><TD>    catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1080</TD><TD>        Log.exception( this, &#34;Failed to configure product classes&#34;, e);</TD></TR><TR><TD CLASS="l">1081</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1082</TD><TD>}</TD></TR><TR><TD CLASS="l">1083</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2c">1084</A></TD><TD>private void buildProducts(ArrayList&lt;ProductClassStruct&gt; p_products, String msg)</TD></TR><TR><TD CLASS="l">1085</TD><TD>{</TD></TR><TR><TD CLASS="l">1086</TD><TD>    // int numberBuildThreads = ((ProductStateServiceLocalHomeImpl) getBOHome()).getNumberBuildThreads();</TD></TR><TR><TD CLASS="l">1087</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1088</TD><TD>    ProductBuildThread[] threads = new ProductBuildThread[numberOfBuildThreads];</TD></TR><TR CLASS="z"><TD CLASS="l">1089</TD><TD>    ProductClassStruct[] array = new ProductClassStruct[p_products.size()];</TD></TR><TR><TD CLASS="l">1090</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">1091</TD><TD>    p_products.toArray(array);</TD></TR><TR><TD CLASS="l">1092</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">1093</TD><TD>    Log.information(this, &#34;Building &#34; + msg + &#34;(count = &#34; + p_products.size() + &#34;) using &#34; + numberOfBuildThreads + &#34; threads.&#34;);</TD></TR><TR><TD CLASS="l">1094</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">1095</TD><TD>    for (int threadNumber = 0; threadNumber &lt; numberOfBuildThreads; threadNumber++)</TD></TR><TR><TD CLASS="l">1096</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1097</TD><TD>        threads[threadNumber] = new ProductBuildThread(threadNumber, numberOfBuildThreads, array);</TD></TR><TR><TD CLASS="l">1098</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1099</TD><TD>        threads[threadNumber].start();</TD></TR><TR><TD CLASS="l">1100</TD><TD>    }</TD></TR><TR><TD CLASS="l">1101</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1102</TD><TD>    Log.information(this, &#34;Waiting for threads to complete (ProductBuildThreads for &#34; + msg + &#34;)&#34;);</TD></TR><TR><TD CLASS="l">1103</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1104</TD><TD>    for (int i = 0; i &lt; numberOfBuildThreads; i++)</TD></TR><TR><TD CLASS="l">1105</TD><TD>    {</TD></TR><TR><TD CLASS="l">1106</TD><TD>        try</TD></TR><TR><TD CLASS="l">1107</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1108</TD><TD>            threads[i].join();</TD></TR><TR><TD CLASS="l">1109</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1110</TD><TD>        catch (InterruptedException e)</TD></TR><TR><TD CLASS="l">1111</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1112</TD><TD>            Log.alarm(this, &#34;Interrupted while waiting for threads - assume wait should end&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1113</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1114</TD><TD>        }</TD></TR><TR><TD CLASS="l">1115</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1116</TD><TD>}</TD></TR><TR><TD CLASS="l">1117</TD><TD> </TD></TR><TR><TD CLASS="l">1118</TD><TD>/**</TD></TR><TR><TD CLASS="l">1119</TD><TD> * Initializes newly created instance.</TD></TR><TR><TD CLASS="l"><A NAME="32">1120</A></TD><TD> *</TD></TR><TR><TD CLASS="l">1121</TD><TD> * @param name name of this service</TD></TR><TR><TD CLASS="l">1122</TD><TD> */</TD></TR><TR><TD CLASS="l">1123</TD><TD>public void create(String name) {</TD></TR><TR CLASS="z"><TD CLASS="l">1124</TD><TD>    super.create(name);</TD></TR><TR CLASS="z"><TD CLASS="l">1125</TD><TD>}</TD></TR><TR><TD CLASS="l">1126</TD><TD>/**</TD></TR><TR><TD CLASS="l">1127</TD><TD> * Create order book for new product or strategy.</TD></TR><TR><TD CLASS="l">1128</TD><TD> *</TD></TR><TR><TD CLASS="l">1129</TD><TD> * @param product product or strategy being added</TD></TR><TR><TD CLASS="l">1130</TD><TD> */</TD></TR><TR><TD CLASS="l">1131</TD><TD>protected void createOrderBook(TradingProduct product)</TD></TR><TR><TD CLASS="l"><A NAME="34">1132</A></TD><TD>throws DataValidationException</TD></TR><TR><TD CLASS="l">1133</TD><TD>{</TD></TR><TR><TD CLASS="l">1134</TD><TD>    try</TD></TR><TR><TD CLASS="l">1135</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1136</TD><TD>        cachedOrderBookHome.create(OrderBookHome.HOME_NAME + product.getProductKey(), product);</TD></TR><TR><TD CLASS="l">1137</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1138</TD><TD>    catch (OrderBookAlreadyExistsException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1139</TD><TD>        Log.alarm(this, &#34;Order book already exists for product or strategy added intraday: &#34; + product);</TD></TR><TR><TD CLASS="l">1140</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1141</TD><TD>}</TD></TR><TR><TD CLASS="l">1142</TD><TD>/**</TD></TR><TR><TD CLASS="l">1143</TD><TD> * Either completes the product state change or returns a command that will complete the request.</TD></TR><TR><TD CLASS="l">1144</TD><TD> *</TD></TR><TR><TD CLASS="l">1145</TD><TD> * @param tradingProduct product having state changed</TD></TR><TR><TD CLASS="l">1146</TD><TD> * @param productState   state to set the product to.  This should be one of</TD></TR><TR><TD CLASS="l">1147</TD><TD> *                       the states defined in the &lt;code&gt;ProductStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l">1148</TD><TD> * @param immediate      flag indicating whether or not the state change shoud be done</TD></TR><TR><TD CLASS="l">1149</TD><TD> *                       immediately.  Normally, the state change is completed via a queue.</TD></TR><TR><TD CLASS="l"><A NAME="37">1150</A></TD><TD> * @exception            TransactionFailedException when a state change cannot be completed.</TD></TR><TR><TD CLASS="l">1151</TD><TD> */</TD></TR><TR><TD CLASS="l">1152</TD><TD>public ProductStateChangeCommand doProductStateChange(TradingProduct tradingProduct, short productState, boolean immediate) throws TransactionFailedException {</TD></TR><TR><TD CLASS="l">1153</TD><TD>    // product state changes only allowed for enabled products.</TD></TR><TR CLASS="z"><TD CLASS="l">1154</TD><TD>    if (!tradingProduct.isEnabledForSession()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1155</TD><TD>        throw ExceptionBuilder.transactionFailedException(&#34;State change not allowed for product not enabled for session, key = &#34; + tradingProduct.getProductKey(), 0);</TD></TR><TR><TD CLASS="l">1156</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1157</TD><TD>    ProductStateChangeCommand command = null;</TD></TR><TR><TD CLASS="l">1158</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">1159</TD><TD>        notifyVetoableStateChangeListeners(tradingProduct, productState);</TD></TR><TR CLASS="z"><TD CLASS="l">1160</TD><TD>        TradingProductImpl productImpl = (TradingProductImpl) tradingProduct;</TD></TR><TR CLASS="z"><TD CLASS="l">1161</TD><TD>        short fromState = productImpl.getTargetStateCode();</TD></TR><TR CLASS="z"><TD CLASS="l">1162</TD><TD>        short newState = productImpl.setState(productState, immediate);</TD></TR><TR CLASS="z"><TD CLASS="l">1163</TD><TD>        if (immediate) {</TD></TR><TR CLASS="z"><TD CLASS="l">1164</TD><TD>            completeStateChange(productImpl, newState, immediate);</TD></TR><TR><TD CLASS="l">1165</TD><TD>        }</TD></TR><TR><TD CLASS="l">1166</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">1167</TD><TD>            command = new ProductStateChangeCommand(productImpl, fromState, newState); // fixme - may want to use pool</TD></TR><TR><TD CLASS="l">1168</TD><TD>        }</TD></TR><TR><TD CLASS="l">1169</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1170</TD><TD>    catch (StateChangeVetoException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1171</TD><TD>        Log.debug(this, &#34;SetProductState vetoed for ProductKey &#34; + tradingProduct + &#34; &#34; + e);</TD></TR><TR CLASS="z"><TD CLASS="l">1172</TD><TD>        throw ExceptionBuilder.transactionFailedException(&#34;Product state change for product (&#34; + tradingProduct + &#34;) has been vetoed&#34;, 0);</TD></TR><TR><TD CLASS="l">1173</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1174</TD><TD>    return command;</TD></TR><TR><TD CLASS="l">1175</TD><TD>}</TD></TR><TR><TD CLASS="l">1176</TD><TD>/**</TD></TR><TR><TD CLASS="l">1177</TD><TD> * Performs admin request to force all products to a state.</TD></TR><TR><TD CLASS="l">1178</TD><TD> *</TD></TR><TR><TD CLASS="l">1179</TD><TD> * @param strState  the state to sell the products</TD></TR><TR><TD CLASS="l">1180</TD><TD> * @return description of result</TD></TR><TR><TD CLASS="l"><A NAME="20">1181</A></TD><TD> */</TD></TR><TR><TD CLASS="l">1182</TD><TD>@FFCommand(description=&#34;Force the state for all products (use when command queues is stopped)&#34;,</TD></TR><TR><TD CLASS="l">1183</TD><TD>        paramDescriptions = {&#34;Session name&#34;, &#34;State to set all products to&#34;})</TD></TR><TR><TD CLASS="l">1184</TD><TD>public String adminForceAllProductStates(String sessionName, String strState) {</TD></TR><TR CLASS="z"><TD CLASS="l">1185</TD><TD>    if (strState == null ){</TD></TR><TR CLASS="z"><TD CLASS="l">1186</TD><TD>        Log.information(&#34;Could not set product states; no state specified&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1187</TD><TD>        return &#34;Could not set product states; no state specified&#34;;</TD></TR><TR><TD CLASS="l">1188</TD><TD>    }</TD></TR><TR><TD CLASS="l">1189</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">1190</TD><TD>        short state = Short.parseShort(strState);</TD></TR><TR CLASS="z"><TD CLASS="l">1191</TD><TD>        setAllProductStates(sessionName, state, true /* do state change immediately */);</TD></TR><TR CLASS="z"><TD CLASS="l">1192</TD><TD>        return &#34;All Product States set to &#34; + state;</TD></TR><TR><TD CLASS="l">1193</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1194</TD><TD>    catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1195</TD><TD>        Log.information(&#34;Exception while setting all product states &#34; + e );</TD></TR><TR CLASS="z"><TD CLASS="l">1196</TD><TD>        return &#34;Exception while setting all product states &#34; + e;</TD></TR><TR><TD CLASS="l">1197</TD><TD>    }</TD></TR><TR><TD CLASS="l">1198</TD><TD>}</TD></TR><TR><TD CLASS="l">1199</TD><TD>/**</TD></TR><TR><TD CLASS="l">1200</TD><TD> * Performs admin request to set states for all products of a class.</TD></TR><TR><TD CLASS="l">1201</TD><TD> *</TD></TR><TR><TD CLASS="l">1202</TD><TD> * @param strClassKey the class key or class symbol of the product class on which to set the state</TD></TR><TR><TD CLASS="l">1203</TD><TD> * @param strState the  state to which to set the class</TD></TR><TR><TD CLASS="l">1204</TD><TD> * @return description of result</TD></TR><TR><TD CLASS="l"><A NAME="21">1205</A></TD><TD> */</TD></TR><TR><TD CLASS="l">1206</TD><TD>@FFCommand(description=&#34;Forces the state for all products in a class (use when command queue is stopped)&#34;,</TD></TR><TR><TD CLASS="l">1207</TD><TD>        paramDescriptions = {&#34;Session name&#34;, &#34;ProductClass key or symbol&#34;, &#34;State to set all products in the class to&#34;})</TD></TR><TR><TD CLASS="l">1208</TD><TD>public String adminForceProductStateByClass(String sessionName, String strClassKey, String strState) {</TD></TR><TR CLASS="z"><TD CLASS="l">1209</TD><TD>    if ( sessionName == null || strClassKey == null || strState == null ){</TD></TR><TR CLASS="z"><TD CLASS="l">1210</TD><TD>        Log.information(&#34;Could not set product states; no state specified&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1211</TD><TD>        return &#34;Usage: setProductStateByClass sessionName classKey state&#34;;</TD></TR><TR><TD CLASS="l">1212</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1213</TD><TD>    if (isClassKey(strClassKey)) {</TD></TR><TR><TD CLASS="l">1214</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1215</TD><TD>            int classKey = Integer.parseInt(strClassKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1216</TD><TD>            short state = Short.parseShort(strState);</TD></TR><TR CLASS="z"><TD CLASS="l">1217</TD><TD>            setProductStateByClass(sessionName, classKey, state, true /* do change immediately */);</TD></TR><TR CLASS="z"><TD CLASS="l">1218</TD><TD>            return &#34;All products for class &#34; + classKey + &#34; set to &#34; + state;</TD></TR><TR><TD CLASS="l">1219</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1220</TD><TD>        catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1221</TD><TD>            Log.information(&#34;Exception while setting product states for class (&#34; + strClassKey + &#34;): &#34; + e);</TD></TR><TR CLASS="z"><TD CLASS="l">1222</TD><TD>            return &#34;Exception while setting product states for class: &#34; + e;</TD></TR><TR><TD CLASS="l">1223</TD><TD>        }</TD></TR><TR><TD CLASS="l">1224</TD><TD>    }</TD></TR><TR><TD CLASS="l">1225</TD><TD>    else {</TD></TR><TR><TD CLASS="l">1226</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1227</TD><TD>            short state = Short.parseShort(strState);</TD></TR><TR CLASS="z"><TD CLASS="l">1228</TD><TD>            return setProductStateBySymbol(strClassKey, state, true /* do change immediately */);</TD></TR><TR><TD CLASS="l">1229</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1230</TD><TD>        catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1231</TD><TD>            Log.information(&#34;Exception while setting product states for class symbol (&#34; + strClassKey + &#34;): &#34; + e);</TD></TR><TR CLASS="z"><TD CLASS="l">1232</TD><TD>            return &#34;Exception while setting product states for class: &#34; + e;</TD></TR><TR><TD CLASS="l">1233</TD><TD>        }</TD></TR><TR><TD CLASS="l">1234</TD><TD>    }</TD></TR><TR><TD CLASS="l">1235</TD><TD>}</TD></TR><TR><TD CLASS="l"><A NAME="3e">1236</A></TD><TD>/**</TD></TR><TR><TD CLASS="l">1237</TD><TD> * Gets reference to this service through home so calls will go through the interceptor.</TD></TR><TR><TD CLASS="l">1238</TD><TD> */</TD></TR><TR><TD CLASS="l">1239</TD><TD>protected ProductStateServiceLocal getMyInterceptor() {</TD></TR><TR CLASS="z"><TD CLASS="l">1240</TD><TD>    return ((ProductStateServiceLocalHome) getBOHome()).findLocal();</TD></TR><TR><TD CLASS="l">1241</TD><TD>}</TD></TR><TR><TD CLASS="l">1242</TD><TD> </TD></TR><TR><TD CLASS="l">1243</TD><TD>/**</TD></TR><TR><TD CLASS="l"><A NAME="42">1244</A></TD><TD> * Gets stub used to publish product state events.</TD></TR><TR><TD CLASS="l">1245</TD><TD> */</TD></TR><TR><TD CLASS="l">1246</TD><TD>protected ProductStateConsumer getProductStatePublisher() {</TD></TR><TR><TD CLASS="l">1247</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1248</TD><TD>    if( productStatePublisher == null ) productStatePublisher = EventHomes.getProductStateConsumerHome().find();</TD></TR><TR CLASS="z"><TD CLASS="l">1249</TD><TD>    return productStatePublisher;</TD></TR><TR><TD CLASS="l">1250</TD><TD>}</TD></TR><TR><TD CLASS="l">1251</TD><TD>/**</TD></TR><TR><TD CLASS="l">1252</TD><TD> * This will get a refrence to the &lt;code&gt;OrderBookHome&lt;/code&gt; for this</TD></TR><TR><TD CLASS="l">1253</TD><TD> * process.</TD></TR><TR><TD CLASS="l">1254</TD><TD> *</TD></TR><TR><TD CLASS="l">1255</TD><TD> * @return      OrderBookHome for this process.</TD></TR><TR><TD CLASS="l"><A NAME="91">1256</A></TD><TD> */</TD></TR><TR><TD CLASS="l">1257</TD><TD>    @FFHomeDependency</TD></TR><TR><TD CLASS="l">1258</TD><TD>    public final void setOrderBookHome(OrderBookHome p_orderBookHome)</TD></TR><TR><TD CLASS="l">1259</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">1260</TD><TD>        cachedOrderBookHome = p_orderBookHome;</TD></TR><TR CLASS="c"><TD CLASS="l">1261</TD><TD>        }</TD></TR><TR><TD CLASS="l">1262</TD><TD> </TD></TR><TR><TD CLASS="l">1263</TD><TD>/**</TD></TR><TR><TD CLASS="l">1264</TD><TD> * This will get a refrence to the &lt;code&gt;ProductDataCacheHome&lt;/code&gt; for this</TD></TR><TR><TD CLASS="l">1265</TD><TD> * process.</TD></TR><TR><TD CLASS="l">1266</TD><TD> *</TD></TR><TR><TD CLASS="l">1267</TD><TD> * @return      ProductDataCacheHome for this process.</TD></TR><TR><TD CLASS="l"><A NAME="92">1268</A></TD><TD> */</TD></TR><TR><TD CLASS="l">1269</TD><TD>    @FFHomeDependency</TD></TR><TR><TD CLASS="l">1270</TD><TD>    public final void setProductDataCacheHome(ProductDataCacheHome p_productDataCacheHome)</TD></TR><TR><TD CLASS="l">1271</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">1272</TD><TD>        productDataCacheHome = p_productDataCacheHome;</TD></TR><TR CLASS="c"><TD CLASS="l">1273</TD><TD>}</TD></TR><TR><TD CLASS="l">1274</TD><TD> </TD></TR><TR><TD CLASS="l">1275</TD><TD> </TD></TR><TR><TD CLASS="l">1276</TD><TD>/**</TD></TR><TR><TD CLASS="l">1277</TD><TD> * This will get a refrence to the &lt;code&gt;ProductDataCacheHome&lt;/code&gt; for this</TD></TR><TR><TD CLASS="l">1278</TD><TD> * process.</TD></TR><TR><TD CLASS="l"><A NAME="40">1279</A></TD><TD> *</TD></TR><TR><TD CLASS="l">1280</TD><TD> * @return      ProductDataCacheHome for this process.</TD></TR><TR><TD CLASS="l">1281</TD><TD> */</TD></TR><TR><TD CLASS="l">1282</TD><TD>public ProductData getProductDataCache(int productKey) throws Exception {</TD></TR><TR CLASS="z"><TD CLASS="l">1283</TD><TD>    return productDataCacheHome.find().getProductData(productKey);</TD></TR><TR><TD CLASS="l">1284</TD><TD>}</TD></TR><TR><TD CLASS="l"><A NAME="3f">1285</A></TD><TD> </TD></TR><TR><TD CLASS="l">1286</TD><TD>public final ProductClassData getProductClassData(int classKey)</TD></TR><TR><TD CLASS="l">1287</TD><TD>throws NotFoundException, SystemException</TD></TR><TR><TD CLASS="l">1288</TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">1289</TD><TD>    return productDataCacheHome.find().getProductClassData(classKey);</TD></TR><TR><TD CLASS="l">1290</TD><TD>}</TD></TR><TR><TD CLASS="l"><A NAME="8f">1291</A></TD><TD> </TD></TR><TR><TD CLASS="l">1292</TD><TD>    @FFHomeDependency</TD></TR><TR><TD CLASS="l">1293</TD><TD>    public final void setBrokerHome(BrokerHome p_brokerHome)</TD></TR><TR><TD CLASS="l">1294</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">1295</TD><TD>        brokerHome = p_brokerHome;</TD></TR><TR CLASS="c"><TD CLASS="l">1296</TD><TD>}</TD></TR><TR><TD CLASS="l">1297</TD><TD> </TD></TR><TR><TD CLASS="l">1298</TD><TD>/**</TD></TR><TR><TD CLASS="l">1299</TD><TD> * Calculates the settlement prices for all products in the requested class.</TD></TR><TR><TD CLASS="l">1300</TD><TD> *</TD></TR><TR><TD CLASS="l">1301</TD><TD> * @param sessionName session for which prices are being calculated.  Value used for routing only.</TD></TR><TR><TD CLASS="l">1302</TD><TD> * @param previousSettlementPrices prices are only used if product did not trade today</TD></TR><TR><TD CLASS="l"><A NAME="46">1303</A></TD><TD> * @return new settlement prices for product.  NO_PRICE will be used if price can not be determined.</TD></TR><TR><TD CLASS="l">1304</TD><TD> */</TD></TR><TR><TD CLASS="l">1305</TD><TD>public ClassSettlementStruct getSettlementPricesForClass(String sessionName, ClassSettlementStruct previousSettlementPrices)</TD></TR><TR><TD CLASS="l">1306</TD><TD>        throws DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">1307</TD><TD>    ClassSettlementStruct result = new ClassSettlementStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1308</TD><TD>    result.settlements = new ProductSettlementStruct[previousSettlementPrices.settlements.length];</TD></TR><TR CLASS="z"><TD CLASS="l">1309</TD><TD>    for (int i = 0; i &lt; previousSettlementPrices.settlements.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1310</TD><TD>        result.settlements[i] = new ProductSettlementStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1311</TD><TD>        result.settlements[i].productKeys = previousSettlementPrices.settlements[i].productKeys;</TD></TR><TR><TD CLASS="l">1312</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1313</TD><TD>            TradingProduct product = cachedTradingProductHome.findByKey(previousSettlementPrices.settlements[i].productKeys.productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1314</TD><TD>            Price newSettlementPrice = product.calculateSettlementPrice(previousSettlementPrices.settlements[i].settlementPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">1315</TD><TD>            result.settlements[i].settlementPrice = newSettlementPrice.toStruct();</TD></TR><TR><TD CLASS="l">1316</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1317</TD><TD>        catch (NotFoundException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1318</TD><TD>            throw new DataValidationException(e.details);</TD></TR><TR><TD CLASS="l">1319</TD><TD>        }</TD></TR><TR><TD CLASS="l">1320</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1321</TD><TD>    return result;</TD></TR><TR><TD CLASS="l">1322</TD><TD>}</TD></TR><TR><TD CLASS="l">1323</TD><TD>/**</TD></TR><TR><TD CLASS="l">1324</TD><TD> * This will get a refrence to the &lt;code&gt;TradingClassHome&lt;/code&gt; for this</TD></TR><TR><TD CLASS="l">1325</TD><TD> * process.</TD></TR><TR><TD CLASS="l">1326</TD><TD> *</TD></TR><TR><TD CLASS="l">1327</TD><TD> * @return      TradingClassHome for this process.</TD></TR><TR><TD CLASS="l"><A NAME="93">1328</A></TD><TD> */</TD></TR><TR><TD CLASS="l">1329</TD><TD>    @FFHomeDependency</TD></TR><TR><TD CLASS="l">1330</TD><TD>    public final void setTradingClassHome(TradingClassHome p_tradingClassHome)</TD></TR><TR><TD CLASS="l">1331</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">1332</TD><TD>        cachedTradingClassHome = p_tradingClassHome;</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="4a">1333</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">1334</TD><TD> </TD></TR><TR><TD CLASS="l">1335</TD><TD>    public TradingClassHome getTradingClassHome()</TD></TR><TR><TD CLASS="l">1336</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1337</TD><TD>    return cachedTradingClassHome;</TD></TR><TR><TD CLASS="l">1338</TD><TD>}</TD></TR><TR><TD CLASS="l">1339</TD><TD> </TD></TR><TR><TD CLASS="l">1340</TD><TD>/**</TD></TR><TR><TD CLASS="l">1341</TD><TD> * This will get a refrence to the &lt;code&gt;TradingProductHome&lt;/code&gt; for this</TD></TR><TR><TD CLASS="l">1342</TD><TD> * process.</TD></TR><TR><TD CLASS="l">1343</TD><TD> *</TD></TR><TR><TD CLASS="l">1344</TD><TD> * @return      TradingProductHome for this process.</TD></TR><TR><TD CLASS="l"><A NAME="94">1345</A></TD><TD> */</TD></TR><TR><TD CLASS="l">1346</TD><TD>    @FFHomeDependency</TD></TR><TR><TD CLASS="l">1347</TD><TD>    public final void setTradingProductHome(TradingProductHome p_tradingProductHome)</TD></TR><TR><TD CLASS="l">1348</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">1349</TD><TD>        cachedTradingProductHome = p_tradingProductHome;</TD></TR><TR CLASS="c"><TD CLASS="l">1350</TD><TD>        }</TD></TR><TR><TD CLASS="l">1351</TD><TD> </TD></TR><TR><TD CLASS="l">1352</TD><TD>/**</TD></TR><TR><TD CLASS="l">1353</TD><TD> * This will get a refrence to the &lt;code&gt;MarketDataHome&lt;/code&gt; for this</TD></TR><TR><TD CLASS="l">1354</TD><TD> * process.</TD></TR><TR><TD CLASS="l">1355</TD><TD> *</TD></TR><TR><TD CLASS="l">1356</TD><TD> * @return      MarketDataHome for this process.</TD></TR><TR><TD CLASS="l"><A NAME="90">1357</A></TD><TD> */</TD></TR><TR><TD CLASS="l">1358</TD><TD>    @FFHomeDependency</TD></TR><TR><TD CLASS="l">1359</TD><TD>    public final void setMarketDataHome(MarketDataHome p_marketDataHome)</TD></TR><TR><TD CLASS="l">1360</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">1361</TD><TD>        cachedMarketDataHome = p_marketDataHome;</TD></TR><TR CLASS="c"><TD CLASS="l">1362</TD><TD>        }</TD></TR><TR><TD CLASS="l">1363</TD><TD> </TD></TR><TR><TD CLASS="l">1364</TD><TD> </TD></TR><TR><TD CLASS="l">1365</TD><TD>/**</TD></TR><TR><TD CLASS="l">1366</TD><TD> * Puts the command in the queue for processing.</TD></TR><TR><TD CLASS="l">1367</TD><TD> *</TD></TR><TR><TD CLASS="l">1368</TD><TD> * @param product product being changed</TD></TR><TR><TD CLASS="l">1369</TD><TD> * @param command command to be queued</TD></TR><TR><TD CLASS="l">1370</TD><TD> */</TD></TR><TR><TD CLASS="l"><A NAME="4f">1371</A></TD><TD>protected void handleCommand(TradingProduct product, ProductStateChangeCommand command) {</TD></TR><TR><TD CLASS="l">1372</TD><TD>    try {</TD></TR><TR><TD CLASS="l">1373</TD><TD>        // (execute within product-level lock if such a lock exists, otherwise this call</TD></TR><TR><TD CLASS="l">1374</TD><TD>        // will delegate to the class-level command processor)</TD></TR><TR CLASS="z"><TD CLASS="l">1375</TD><TD>        product.acceptCommand(command, true);</TD></TR><TR><TD CLASS="l">1376</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1377</TD><TD>    catch (NotAcceptedException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1378</TD><TD>        Log.alarm(this, &#34;Cannot use state command - setting state immediately&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1379</TD><TD>        command.execute();</TD></TR><TR><TD CLASS="l">1380</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1381</TD><TD>}</TD></TR><TR><TD CLASS="l">1382</TD><TD>/**</TD></TR><TR><TD CLASS="l"><A NAME="50">1383</A></TD><TD> * Tests to see if string is a class key.</TD></TR><TR><TD CLASS="l">1384</TD><TD> */</TD></TR><TR><TD CLASS="l">1385</TD><TD>protected boolean isClassKey(String value) {</TD></TR><TR><TD CLASS="l">1386</TD><TD>    // assume that value is a key if it starts with a digit</TD></TR><TR CLASS="z"><TD CLASS="l">1387</TD><TD>    return value.length() &gt; 0 &amp;&amp; Character.isDigit(value.charAt(0)) &amp;&amp; Character.isDigit(value.charAt(1));</TD></TR><TR><TD CLASS="l">1388</TD><TD>}</TD></TR><TR><TD CLASS="l">1389</TD><TD> </TD></TR><TR><TD CLASS="l">1390</TD><TD>/**</TD></TR><TR><TD CLASS="l">1391</TD><TD> * Notifies the &lt;code&gt;VetoableStateChangeListeners&lt;/code&gt; that a state change is about</TD></TR><TR><TD CLASS="l">1392</TD><TD> * to occur.  Listeners can veto the state change by throwing a &lt;code&gt;StateChangeVetoException&lt;/code&gt;.</TD></TR><TR><TD CLASS="l">1393</TD><TD> *</TD></TR><TR><TD CLASS="l">1394</TD><TD> * @param product   product key for the product whose state is changing</TD></TR><TR><TD CLASS="l"><A NAME="55">1395</A></TD><TD> * @param newState  new state of the product</TD></TR><TR><TD CLASS="l">1396</TD><TD> * @exception       StateChangeVetoException if a listener vetos the change.</TD></TR><TR><TD CLASS="l">1397</TD><TD> */</TD></TR><TR><TD CLASS="l">1398</TD><TD>protected void notifyVetoableStateChangeListeners(TradingProduct product, short newState) throws StateChangeVetoException{</TD></TR><TR CLASS="z"><TD CLASS="l">1399</TD><TD>    Object[] listeners = vetoableListenerList.getListenerList();</TD></TR><TR CLASS="z"><TD CLASS="l">1400</TD><TD>    short currentState = product.getCurrentStateCode();</TD></TR><TR CLASS="z"><TD CLASS="l">1401</TD><TD>    for (int i = listeners.length-2; i &gt;= 0; i-=2) {</TD></TR><TR CLASS="z"><TD CLASS="l">1402</TD><TD>        if (listeners[i] == VetoableStateChangeListener.class) {</TD></TR><TR CLASS="z"><TD CLASS="l">1403</TD><TD>            ((VetoableStateChangeListener) listeners[i+1]).stateChangeEvent(product, currentState, newState);</TD></TR><TR><TD CLASS="l">1404</TD><TD>        }</TD></TR><TR><TD CLASS="l">1405</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1406</TD><TD>}</TD></TR><TR><TD CLASS="l">1407</TD><TD>/**</TD></TR><TR><TD CLASS="l"><A NAME="31">1408</A></TD><TD> * Convert product state constant value to class state constant value.</TD></TR><TR><TD CLASS="l">1409</TD><TD> */</TD></TR><TR><TD CLASS="l">1410</TD><TD>protected short convertProductStateToClassState(short productState) {</TD></TR><TR><TD CLASS="l">1411</TD><TD>    short classState;</TD></TR><TR CLASS="z"><TD CLASS="l">1412</TD><TD>    switch (productState) {</TD></TR><TR><TD CLASS="l">1413</TD><TD>        case ProductStates.HALTED :</TD></TR><TR CLASS="z"><TD CLASS="l">1414</TD><TD>            classState = ClassStates.HALTED;</TD></TR><TR CLASS="z"><TD CLASS="l">1415</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1416</TD><TD>        case ProductStates.SUSPENDED :</TD></TR><TR CLASS="z"><TD CLASS="l">1417</TD><TD>            classState = ClassStates.SUSPENDED;</TD></TR><TR CLASS="z"><TD CLASS="l">1418</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1419</TD><TD>        case ProductStates.PRE_OPEN :</TD></TR><TR CLASS="z"><TD CLASS="l">1420</TD><TD>            classState = ClassStates.PRE_OPEN;</TD></TR><TR CLASS="z"><TD CLASS="l">1421</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1422</TD><TD>        case ProductStates.OPENING_ROTATION :</TD></TR><TR CLASS="z"><TD CLASS="l">1423</TD><TD>            classState = ClassStates.OPENING_ROTATION;</TD></TR><TR CLASS="z"><TD CLASS="l">1424</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1425</TD><TD>        case ProductStates.OPEN :</TD></TR><TR CLASS="z"><TD CLASS="l">1426</TD><TD>            classState = ClassStates.OPEN;</TD></TR><TR CLASS="z"><TD CLASS="l">1427</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1428</TD><TD>        case ProductStates.FAST_MARKET :</TD></TR><TR CLASS="z"><TD CLASS="l">1429</TD><TD>            classState = ClassStates.FAST_MARKET;</TD></TR><TR CLASS="z"><TD CLASS="l">1430</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1431</TD><TD>        case ProductStates.ENDING_HOLD :</TD></TR><TR CLASS="z"><TD CLASS="l">1432</TD><TD>            classState = ClassStates.ENDING_HOLD;</TD></TR><TR CLASS="z"><TD CLASS="l">1433</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1434</TD><TD>        case ProductStates.NO_SESSION :</TD></TR><TR CLASS="z"><TD CLASS="l">1435</TD><TD>            classState = ClassStates.NO_SESSION;</TD></TR><TR CLASS="z"><TD CLASS="l">1436</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1437</TD><TD>        case ProductStates.ON_HOLD :</TD></TR><TR CLASS="z"><TD CLASS="l">1438</TD><TD>            classState = ClassStates.ON_HOLD;</TD></TR><TR CLASS="z"><TD CLASS="l">1439</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1440</TD><TD>        default :</TD></TR><TR><TD CLASS="l">1441</TD><TD>            // default to closed</TD></TR><TR CLASS="z"><TD CLASS="l">1442</TD><TD>            classState = ClassStates.CLOSED;</TD></TR><TR><TD CLASS="l">1443</TD><TD>            break;</TD></TR><TR><TD CLASS="l">1444</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1445</TD><TD>    return classState;</TD></TR><TR><TD CLASS="l">1446</TD><TD>}</TD></TR><TR><TD CLASS="l">1447</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="5b">1448</A></TD><TD>/**</TD></TR><TR><TD CLASS="l">1449</TD><TD> * Publish class level state change.</TD></TR><TR><TD CLASS="l">1450</TD><TD> */</TD></TR><TR><TD CLASS="l">1451</TD><TD>protected void publishClassStateChange(TradingClass productClass, short newClassState, ProductStateConsumer productStatePublisher) {</TD></TR><TR CLASS="z"><TD CLASS="l">1452</TD><TD>    ClassStateStruct classState = new ClassStateStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1453</TD><TD>    classState.classKey = productClass.getProductClassKey();</TD></TR><TR CLASS="z"><TD CLASS="l">1454</TD><TD>    classState.sessionName = productClass.getSessionName();</TD></TR><TR CLASS="z"><TD CLASS="l">1455</TD><TD>    classState.classState = newClassState;</TD></TR><TR CLASS="z"><TD CLASS="l">1456</TD><TD>    classState.classStateTransactionSequenceNumber = productClass.getNextSequence();</TD></TR><TR CLASS="z"><TD CLASS="l">1457</TD><TD>    productStatePublisher.setClassState(classState);</TD></TR><TR CLASS="z"><TD CLASS="l">1458</TD><TD>}</TD></TR><TR><TD CLASS="l"><A NAME="5e">1459</A></TD><TD>/**</TD></TR><TR><TD CLASS="l">1460</TD><TD> * Publish product state changes.</TD></TR><TR><TD CLASS="l">1461</TD><TD> */</TD></TR><TR><TD CLASS="l">1462</TD><TD>protected void publishProductStateChange(TradingProduct product) { //ProductStateConsumer productStatePublisher) {</TD></TR><TR CLASS="z"><TD CLASS="l">1463</TD><TD>    TradingProduct[] products = new TradingProduct[1];</TD></TR><TR CLASS="z"><TD CLASS="l">1464</TD><TD>    products[0] = product;</TD></TR><TR CLASS="z"><TD CLASS="l">1465</TD><TD>    publishProductStateChange(products, false);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5c">1466</A></TD><TD>}</TD></TR><TR><TD CLASS="l">1467</TD><TD> </TD></TR><TR><TD CLASS="l">1468</TD><TD>    public void publishProductStateChange(TradingProduct[] products, boolean flagRepublish)</TD></TR><TR><TD CLASS="l">1469</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1470</TD><TD>        publishProductStateChange (products, products.length, flagRepublish);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5d">1471</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1472</TD><TD> </TD></TR><TR><TD CLASS="l">1473</TD><TD>    protected void publishProductStateChange (TradingProduct[] products, int numProducts, boolean flagRepublish)</TD></TR><TR><TD CLASS="l">1474</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1475</TD><TD>        final String subName = &#34;ProductStateServiceLocalImpl.publishProductStateChange: &#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1476</TD><TD>        final String methodName = &#34;publishProductStateChange: &#34;;</TD></TR><TR><TD CLASS="l">1477</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1478</TD><TD>        if( numProducts == 0 )</TD></TR><TR><TD CLASS="l">1479</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1480</TD><TD>            Log.information(this, methodName + &#34;received argument TradingProduct[] with 0 elements&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1481</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1482</TD><TD>        }</TD></TR><TR><TD CLASS="l">1483</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1484</TD><TD>        String sessionName = products[0].getTradingClass().getSessionName();</TD></TR><TR CLASS="z"><TD CLASS="l">1485</TD><TD>        int classKey = products[0].getProductKeys().classKey;</TD></TR><TR><TD CLASS="l">1486</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1487</TD><TD>        ProductStateStruct[] productStates = new ProductStateStruct[numProducts];</TD></TR><TR CLASS="z"><TD CLASS="l">1488</TD><TD>        int[] productKeys = new int[numProducts];</TD></TR><TR><TD CLASS="l">1489</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1490</TD><TD>        for( int i = 0; i &lt; numProducts; i++ )</TD></TR><TR><TD CLASS="l">1491</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1492</TD><TD>            productStates[i] = new ProductStateStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1493</TD><TD>            productStates[i].productKeys = products[i].getProductKeys();</TD></TR><TR CLASS="z"><TD CLASS="l">1494</TD><TD>            productStates[i].productState = products[i].getCurrentStateCode();</TD></TR><TR CLASS="z"><TD CLASS="l">1495</TD><TD>            productKeys[i] = products[i].getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">1496</TD><TD>            if( flagRepublish )</TD></TR><TR><TD CLASS="l">1497</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1498</TD><TD>                productStates[i].productStateTransactionSequenceNumber = products[i].getCurrentSequence();</TD></TR><TR><TD CLASS="l">1499</TD><TD>            }</TD></TR><TR><TD CLASS="l">1500</TD><TD>            else</TD></TR><TR><TD CLASS="l">1501</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1502</TD><TD>                productStates[i].productStateTransactionSequenceNumber = products[i].getNextSequence();</TD></TR><TR><TD CLASS="l">1503</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1504</TD><TD>            productStates[i].sessionName = products[i].getTradingClass().getSessionName();</TD></TR><TR><TD CLASS="l">1505</TD><TD> </TD></TR><TR><TD CLASS="l">1506</TD><TD>        } // end for</TD></TR><TR><TD CLASS="l">1507</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1508</TD><TD>        if( Log.isDebugOn() )</TD></TR><TR><TD CLASS="l">1509</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1510</TD><TD>            Log.debug(subName + &#34;calling setProductStates for &#34; + sessionName + &#34; class &#34; + classKey + &#34; product keys &#34; + writeNumericKeysToString(productKeys));</TD></TR><TR><TD CLASS="l">1511</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1512</TD><TD>        productStateCollector.setProductStates(products[0].getTradingClass(),productStates,products);</TD></TR><TR><TD CLASS="l">1513</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1514</TD><TD>    } // end publishProductStateChange</TD></TR><TR><TD CLASS="l">1515</TD><TD> </TD></TR><TR><TD CLASS="l">1516</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1517</TD><TD>     * Publish product states for class keys and session</TD></TR><TR><TD CLASS="l">1518</TD><TD>     *</TD></TR><TR><TD CLASS="l">1519</TD><TD>     * @param classKeys</TD></TR><TR><TD CLASS="l">1520</TD><TD>     * @param sessionName</TD></TR><TR><TD CLASS="l">1521</TD><TD>     * @param publishTo code for channel to publish TradingSession, CurentMarket, or both</TD></TR><TR><TD CLASS="l">1522</TD><TD>     * @exception   CommunicationException</TD></TR><TR><TD CLASS="l">1523</TD><TD>     * @exception   AuthorizationException</TD></TR><TR><TD CLASS="l">1524</TD><TD>     * @exception   SystemException</TD></TR><TR><TD CLASS="l">1525</TD><TD>     * @exception   DataValidationException</TD></TR><TR><TD CLASS="l"><A NAME="60">1526</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1527</TD><TD>    public void publishProductStatesForClasses(int[] classKeys, String sessionName, short publishTo)</TD></TR><TR><TD CLASS="l">1528</TD><TD>            throws CommunicationException, AuthorizationException, SystemException, DataValidationException</TD></TR><TR><TD CLASS="l">1529</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1530</TD><TD>        final String subName = &#34;ProductStateServiceLocalImpl.publishProductStatesForClasses: &#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1531</TD><TD>        final String methodName = &#34;publishProductStatesForClasses: &#34;;</TD></TR><TR><TD CLASS="l">1532</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1533</TD><TD>        if( Log.isDebugOn() )</TD></TR><TR><TD CLASS="l">1534</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1535</TD><TD>            Log.debug(subName + &#34;received arguments class keys &#34; + writeNumericKeysToString(classKeys) + &#34;, &#34; + sessionName + &#34;, publishTo=&#34; + publishTo);</TD></TR><TR><TD CLASS="l">1536</TD><TD>        }</TD></TR><TR><TD CLASS="l">1537</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1538</TD><TD>        ArrayList&lt;TradingClass&gt; tradingClassList = new ArrayList&lt;TradingClass&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1539</TD><TD>        TradingProduct[] products = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1540</TD><TD>        TradingClass tradingClass = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1541</TD><TD>        String errorDescription = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1542</TD><TD>        StringBuffer classKeyNotFoundStr = new StringBuffer(&#34;{&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1543</TD><TD>        StringBuffer invalidSessionForClassStr = new StringBuffer(&#34;{&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1544</TD><TD>        int countPublishedClasses = 0;</TD></TR><TR><TD CLASS="l">1545</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1546</TD><TD>        if( classKeys.length == 0 )</TD></TR><TR><TD CLASS="l">1547</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1548</TD><TD>            errorDescription = &#34;Can't republish for &#34; + sessionName + &#34; - argument classKeys[] has 0 elements&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1549</TD><TD>            Log.information(this, errorDescription);</TD></TR><TR CLASS="z"><TD CLASS="l">1550</TD><TD>            throw ExceptionBuilder.dataValidationException(errorDescription, DataValidationCodes.INVALID_GROUP);</TD></TR><TR><TD CLASS="l">1551</TD><TD>        }</TD></TR><TR><TD CLASS="l">1552</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1553</TD><TD>        for( int i = 0; i &lt; classKeys.length; i++ )</TD></TR><TR><TD CLASS="l">1554</TD><TD>        {</TD></TR><TR><TD CLASS="l">1555</TD><TD>            // validate class key</TD></TR><TR><TD CLASS="l">1556</TD><TD>//            if( cachedTradingClassHome == null ) cachedTradingClassHome = getTradingClassHome();</TD></TR><TR><TD CLASS="l">1557</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1558</TD><TD>            tradingClass = null;</TD></TR><TR><TD CLASS="l">1559</TD><TD>            try</TD></TR><TR><TD CLASS="l">1560</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1561</TD><TD>                tradingClass = cachedTradingClassHome.findByKey(classKeys[i]);</TD></TR><TR><TD CLASS="l">1562</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1563</TD><TD>            catch( NotFoundException e )</TD></TR><TR><TD CLASS="l">1564</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1565</TD><TD>                classKeyNotFoundStr = classKeyNotFoundStr.append(classKeys[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">1566</TD><TD>                classKeyNotFoundStr = classKeyNotFoundStr.append(&#34;, &#34;);</TD></TR><TR><TD CLASS="l">1567</TD><TD>            }</TD></TR><TR><TD CLASS="l">1568</TD><TD>            // validate session name</TD></TR><TR CLASS="z"><TD CLASS="l">1569</TD><TD>            if( tradingClass != null )</TD></TR><TR><TD CLASS="l">1570</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1571</TD><TD>                if( !tradingClass.getSessionName().equals(sessionName) )</TD></TR><TR><TD CLASS="l">1572</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1573</TD><TD>                    invalidSessionForClassStr = invalidSessionForClassStr.append(classKeys[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">1574</TD><TD>                    invalidSessionForClassStr = invalidSessionForClassStr.append(&#34; belongs to &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1575</TD><TD>                    invalidSessionForClassStr = invalidSessionForClassStr.append(tradingClass.getSessionName());</TD></TR><TR CLASS="z"><TD CLASS="l">1576</TD><TD>                    invalidSessionForClassStr = invalidSessionForClassStr.append(&#34;, &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1577</TD><TD>                    if( Log.isDebugOn() )</TD></TR><TR><TD CLASS="l">1578</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">1579</TD><TD>                        Log.debug(subName + &#34;invalid session &#34; + sessionName + &#34; for class &#34; + classKeys[i] + &#34;; the class belongs to &#34; + tradingClass.getSessionName());</TD></TR><TR><TD CLASS="l">1580</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1581</TD><TD>                }</TD></TR><TR><TD CLASS="l">1582</TD><TD>                else</TD></TR><TR><TD CLASS="l">1583</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1584</TD><TD>                    tradingClassList.add(tradingClass);</TD></TR><TR CLASS="z"><TD CLASS="l">1585</TD><TD>                    if( Log.isDebugOn() )</TD></TR><TR><TD CLASS="l">1586</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">1587</TD><TD>                        Log.debug(subName + &#34;found TradingClass for class &#34; + classKeys[i] + &#34; &#34; + sessionName);</TD></TR><TR><TD CLASS="l">1588</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1589</TD><TD>                } // end if ( ! tradingClass.getSessionName().equals(sessionName) )</TD></TR><TR><TD CLASS="l">1590</TD><TD>            } // end if( tradingClass != null )</TD></TR><TR><TD CLASS="l">1591</TD><TD> </TD></TR><TR><TD CLASS="l">1592</TD><TD>        } // end for</TD></TR><TR><TD CLASS="l">1593</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1594</TD><TD>        classKeyNotFoundStr = classKeyNotFoundStr.append(&#34;}&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1595</TD><TD>        invalidSessionForClassStr = invalidSessionForClassStr.append(&#34;}&#34;);</TD></TR><TR><TD CLASS="l">1596</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1597</TD><TD>        if( classKeyNotFoundStr.length() &gt; 2 )</TD></TR><TR><TD CLASS="l">1598</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1599</TD><TD>            errorDescription += &#34;Republish aborted for class keys &#34; + classKeyNotFoundStr +</TD></TR><TR CLASS="z"><TD CLASS="l">1600</TD><TD>                    &#34; - no TradingClass found in session &#34; + sessionName + &#34;\n&#34;;</TD></TR><TR><TD CLASS="l">1601</TD><TD>        }</TD></TR><TR><TD CLASS="l">1602</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1603</TD><TD>        if( invalidSessionForClassStr.length() &gt; 2 )</TD></TR><TR><TD CLASS="l">1604</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1605</TD><TD>            errorDescription += &#34;Republish aborted - the classes belong to another session &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">1606</TD><TD>                    invalidSessionForClassStr;</TD></TR><TR><TD CLASS="l">1607</TD><TD>        }</TD></TR><TR><TD CLASS="l">1608</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1609</TD><TD>        if( errorDescription.length() &gt; 1 )</TD></TR><TR><TD CLASS="l">1610</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1611</TD><TD>            Log.information(this, methodName + errorDescription);</TD></TR><TR CLASS="z"><TD CLASS="l">1612</TD><TD>            if( Log.isDebugOn() )</TD></TR><TR><TD CLASS="l">1613</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1614</TD><TD>                Log.debug(subName + errorDescription);</TD></TR><TR><TD CLASS="l">1615</TD><TD>            }</TD></TR><TR><TD CLASS="l">1616</TD><TD>        }</TD></TR><TR><TD CLASS="l">1617</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1618</TD><TD>        if( tradingClassList.size() == 0 )</TD></TR><TR><TD CLASS="l">1619</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1620</TD><TD>            throw ExceptionBuilder.dataValidationException(errorDescription, 0);</TD></TR><TR><TD CLASS="l">1621</TD><TD>        }</TD></TR><TR><TD CLASS="l">1622</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1623</TD><TD>        countPublishedClasses = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1624</TD><TD>        for( int i = 0; i &lt; tradingClassList.size(); i++ )</TD></TR><TR><TD CLASS="l">1625</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1626</TD><TD>            tradingClass = ( TradingClass ) tradingClassList.get(i);</TD></TR><TR CLASS="z"><TD CLASS="l">1627</TD><TD>            products = tradingClass.getProducts(true); // get enabled products only</TD></TR><TR><TD CLASS="l">1628</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1629</TD><TD>            if( products.length == 0 )</TD></TR><TR><TD CLASS="l">1630</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1631</TD><TD>                errorDescription = &#34;Republish aborted for class key &#34; + tradingClass.getProductClassKey() +</TD></TR><TR CLASS="z"><TD CLASS="l">1632</TD><TD>                        &#34; &#34; + sessionName + &#34; - no product key found&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1633</TD><TD>                Log.information(this, methodName + errorDescription);</TD></TR><TR CLASS="z"><TD CLASS="l">1634</TD><TD>                continue;</TD></TR><TR><TD CLASS="l">1635</TD><TD>            }</TD></TR><TR><TD CLASS="l">1636</TD><TD> </TD></TR><TR><TD CLASS="l">1637</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1638</TD><TD>            if( publishTo == ProgramInterfaces.CMI || publishTo == ProgramInterfaces.ALL )</TD></TR><TR><TD CLASS="l">1639</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1640</TD><TD>                Log.information(this, methodName + &#34;publishTo is &#34; + publishTo + &#34;, calling publishProductStateChange for class key &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">1641</TD><TD>                                tradingClass.getProductClassKey() + &#34; with &#34; + products.length + &#34; products for &#34; + sessionName);</TD></TR><TR><TD CLASS="l">1642</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1643</TD><TD>                publishProductStateChange(products, true);</TD></TR><TR><TD CLASS="l">1644</TD><TD>            }</TD></TR><TR><TD CLASS="l">1645</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1646</TD><TD>            if( publishTo == ProgramInterfaces.ADAPTERS || publishTo == ProgramInterfaces.ALL )</TD></TR><TR><TD CLASS="l">1647</TD><TD>            {</TD></TR><TR><TD CLASS="l">1648</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1649</TD><TD>                Log.information(this, methodName + &#34;publishTo is &#34; + publishTo + &#34;, calling publishProductStateChangeToCurrentMarket for class key &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">1650</TD><TD>                               tradingClass.getProductClassKey() + &#34; with &#34; + products.length + &#34; products for &#34; + sessionName);</TD></TR><TR><TD CLASS="l">1651</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1652</TD><TD>                publishProductStateChangeToCurrentMarket(products, getCurrentMarketStateChangePublisher(), true);</TD></TR><TR><TD CLASS="l">1653</TD><TD>            }</TD></TR><TR><TD CLASS="l">1654</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1655</TD><TD>            countPublishedClasses++;</TD></TR><TR CLASS="z"><TD CLASS="l">1656</TD><TD>            if( numberOfClassesToPublish &gt; 0 )</TD></TR><TR><TD CLASS="l">1657</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1658</TD><TD>                if( countPublishedClasses &gt;= numberOfClassesToPublish )</TD></TR><TR><TD CLASS="l">1659</TD><TD>                {</TD></TR><TR><TD CLASS="l">1660</TD><TD>                    try</TD></TR><TR><TD CLASS="l">1661</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">1662</TD><TD>                        if( Log.isDebugOn() )</TD></TR><TR><TD CLASS="l">1663</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">1664</TD><TD>                            Log.debug(subName + sessionName + &#34; will sleep &#34; + publishInterval + &#34;ms after publishing &#34; + countPublishedClasses + &#34; classes&#34;);</TD></TR><TR><TD CLASS="l">1665</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1666</TD><TD>                        Thread.sleep(publishInterval);</TD></TR><TR CLASS="z"><TD CLASS="l">1667</TD><TD>                        countPublishedClasses = 0;</TD></TR><TR><TD CLASS="l">1668</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">1669</TD><TD>                    catch( InterruptedException e )</TD></TR><TR><TD CLASS="l">1670</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">1671</TD><TD>                        countPublishedClasses = 0;</TD></TR><TR><TD CLASS="l">1672</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1673</TD><TD>                }  // end if ( countPublishedClasses &gt;= numberOfClassesToPublish )</TD></TR><TR><TD CLASS="l">1674</TD><TD>            } // end if ( numberOfClassesToPublish &gt; 0 )</TD></TR><TR><TD CLASS="l">1675</TD><TD>        } // end for</TD></TR><TR><TD CLASS="l">1676</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1677</TD><TD>    } // end publishProductStatesForClasses</TD></TR><TR><TD CLASS="l">1678</TD><TD> </TD></TR><TR><TD CLASS="l">1679</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1680</TD><TD>     * Publish product state when session name is given</TD></TR><TR><TD CLASS="l">1681</TD><TD>     *</TD></TR><TR><TD CLASS="l">1682</TD><TD>     * @param sessionName</TD></TR><TR><TD CLASS="l">1683</TD><TD>     * @param publishTo code for channel to publish TradingSession, CurentMarket, or both</TD></TR><TR><TD CLASS="l">1684</TD><TD>     * @exception   CommunicationException</TD></TR><TR><TD CLASS="l">1685</TD><TD>     * @exception   AuthorizationException</TD></TR><TR><TD CLASS="l">1686</TD><TD>     * @exception   SystemException</TD></TR><TR><TD CLASS="l">1687</TD><TD>     * @exception   DataValidationException</TD></TR><TR><TD CLASS="l"><A NAME="63">1688</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1689</TD><TD>    public void publishProductStatesForSession(String sessionName, short publishTo)</TD></TR><TR><TD CLASS="l">1690</TD><TD>            throws CommunicationException, AuthorizationException, SystemException, DataValidationException</TD></TR><TR><TD CLASS="l">1691</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1692</TD><TD>        final String subName = &#34;ProductStateServiceLocalImpl.publishProductStatesForSession: &#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1693</TD><TD>        final String methodName = &#34;publishProductStatesForSession: &#34;;</TD></TR><TR><TD CLASS="l">1694</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1695</TD><TD>        if( Log.isDebugOn() )</TD></TR><TR><TD CLASS="l">1696</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1697</TD><TD>            Log.debug(subName + &#34;received arguments &#34; + sessionName + &#34;, publishTo=&#34; + publishTo);</TD></TR><TR><TD CLASS="l">1698</TD><TD>        }</TD></TR><TR><TD CLASS="l">1699</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1700</TD><TD>        TradingClass[] tradingClassList = cachedTradingClassHome.findAllConfiguredForSession(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">1701</TD><TD>        int[] classKeys = new int[tradingClassList.length];</TD></TR><TR><TD CLASS="l">1702</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1703</TD><TD>        for( int i = 0; i &lt; tradingClassList.length; i++ )</TD></TR><TR><TD CLASS="l">1704</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1705</TD><TD>            classKeys[i] = tradingClassList[i].getProductClassKey();</TD></TR><TR><TD CLASS="l">1706</TD><TD>        }</TD></TR><TR><TD CLASS="l">1707</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1708</TD><TD>        Log.information(this, methodName + &#34;calling publishProductStatesForClasses(&#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">1709</TD><TD>                        writeNumericKeysToString(classKeys) + &#34;, &#34; + sessionName +</TD></TR><TR CLASS="z"><TD CLASS="l">1710</TD><TD>                        &#34; publishTo=&#34; + publishTo + &#34;)&#34;);</TD></TR><TR><TD CLASS="l">1711</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1712</TD><TD>        publishProductStatesForClasses(classKeys, sessionName, publishTo);</TD></TR><TR><TD CLASS="l">1713</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1714</TD><TD>    } // end publishProductStatesForSession</TD></TR><TR><TD CLASS="l">1715</TD><TD> </TD></TR><TR><TD CLASS="l">1716</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1717</TD><TD>     * Publish product state when group name and session are given</TD></TR><TR><TD CLASS="l">1718</TD><TD>     *</TD></TR><TR><TD CLASS="l">1719</TD><TD>     * @param groupName ex. test9BC01HybridTradeServer1</TD></TR><TR><TD CLASS="l">1720</TD><TD>     * @param sessionName</TD></TR><TR><TD CLASS="l">1721</TD><TD>     * @param publishTo code for the channel to publish {TradingSession, CurentMarket, or both}</TD></TR><TR><TD CLASS="l">1722</TD><TD>     * @exception   CommunicationException</TD></TR><TR><TD CLASS="l">1723</TD><TD>     * @exception   AuthorizationException</TD></TR><TR><TD CLASS="l">1724</TD><TD>     * @exception   SystemException</TD></TR><TR><TD CLASS="l">1725</TD><TD>     * @exception   DataValidationException</TD></TR><TR><TD CLASS="l"><A NAME="61">1726</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1727</TD><TD>    public void publishProductStatesForGroupForSession(String groupName, String sessionName, short publishTo)</TD></TR><TR><TD CLASS="l">1728</TD><TD>            throws CommunicationException, AuthorizationException, SystemException, DataValidationException</TD></TR><TR><TD CLASS="l">1729</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1730</TD><TD>        final String subName = &#34;ProductStateServiceLocalImpl.publishProductStatesForGroupForSession: &#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1731</TD><TD>        final String methodName = &#34;publishProductStatesForGroupForSession: &#34;;</TD></TR><TR><TD CLASS="l">1732</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1733</TD><TD>        if( Log.isDebugOn() )</TD></TR><TR><TD CLASS="l">1734</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1735</TD><TD>            Log.debug(subName + &#34;received arguments groupName=&#34; + groupName + &#34;, &#34; + sessionName + &#34;, publishTo=&#34; + publishTo);</TD></TR><TR><TD CLASS="l">1736</TD><TD>        }</TD></TR><TR><TD CLASS="l">1737</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1738</TD><TD>        String assignedGroupName = RouteNameHelper.getRouteName();</TD></TR><TR><TD CLASS="l">1739</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1740</TD><TD>        if( groupName.equalsIgnoreCase(assignedGroupName) )</TD></TR><TR><TD CLASS="l">1741</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1742</TD><TD>            Log.information(this, methodName + &#34;validated group &#34; + groupName + &#34; calling publishProductStatesForSession(&#34; + sessionName + &#34;, &#34; + publishTo + &#34;)&#34;);</TD></TR><TR><TD CLASS="l">1743</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1744</TD><TD>            publishProductStatesForSession(sessionName, publishTo);</TD></TR><TR><TD CLASS="l">1745</TD><TD>        }</TD></TR><TR><TD CLASS="l">1746</TD><TD>        else</TD></TR><TR><TD CLASS="l">1747</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1748</TD><TD>            String errorDescription = &#34;Can't republish for &#34; + sessionName + &#34; received invalid groupName &#34; + groupName + &#34;; valid groupName is &#34; + assignedGroupName;</TD></TR><TR CLASS="z"><TD CLASS="l">1749</TD><TD>            Log.information(this, methodName + errorDescription);</TD></TR><TR CLASS="z"><TD CLASS="l">1750</TD><TD>            throw ExceptionBuilder.dataValidationException(errorDescription, DataValidationCodes.INVALID_GROUP);</TD></TR><TR><TD CLASS="l">1751</TD><TD>        }</TD></TR><TR><TD CLASS="l">1752</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1753</TD><TD>    } // end publishProductStatesForGroupForSession</TD></TR><TR><TD CLASS="l">1754</TD><TD> </TD></TR><TR><TD CLASS="l">1755</TD><TD>/**</TD></TR><TR><TD CLASS="l">1756</TD><TD> * Removes a &lt;code&gt;StateChangeListener&lt;/code&gt; from this service.</TD></TR><TR><TD CLASS="l">1757</TD><TD> *</TD></TR><TR><TD CLASS="l"><A NAME="65">1758</A></TD><TD> * @see ProductStateServiceLocal#removeStateChangeListener</TD></TR><TR><TD CLASS="l">1759</TD><TD> * @since Increment 5</TD></TR><TR><TD CLASS="l">1760</TD><TD> */</TD></TR><TR><TD CLASS="l">1761</TD><TD>public void removeStateChangeListener(StateChangeListener listener) {</TD></TR><TR CLASS="z"><TD CLASS="l">1762</TD><TD>    productStateCollector.removeProductStateListener(listener);</TD></TR><TR CLASS="z"><TD CLASS="l">1763</TD><TD>}</TD></TR><TR><TD CLASS="l">1764</TD><TD>/**</TD></TR><TR><TD CLASS="l">1765</TD><TD> * Removes a &lt;code&gt;VetoableStateChangeListener&lt;/code&gt; from this service.</TD></TR><TR><TD CLASS="l">1766</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="67">1767</A></TD><TD> * @see ProductStateServiceLocal#removeVetoableStateChangeListener</TD></TR><TR><TD CLASS="l">1768</TD><TD> * @since Increment 3</TD></TR><TR><TD CLASS="l">1769</TD><TD> */</TD></TR><TR><TD CLASS="l">1770</TD><TD>public void removeVetoableStateChangeListener(VetoableStateChangeListener listener) {</TD></TR><TR CLASS="z"><TD CLASS="l">1771</TD><TD>    vetoableListenerList.remove(VetoableStateChangeListener.class, listener);</TD></TR><TR CLASS="z"><TD CLASS="l">1772</TD><TD>}</TD></TR><TR><TD CLASS="l">1773</TD><TD>/**</TD></TR><TR><TD CLASS="l">1774</TD><TD> * Sets the product state for all products to the specified state.</TD></TR><TR><TD CLASS="l">1775</TD><TD> *</TD></TR><TR><TD CLASS="l">1776</TD><TD> * @param productState  state to set the products to.  This should be one of</TD></TR><TR><TD CLASS="l">1777</TD><TD> *                      the states defined in the &lt;code&gt;ProductStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l"><A NAME="6a">1778</A></TD><TD> * @exception           TransactionFailedException when the state change is not valid.</TD></TR><TR><TD CLASS="l">1779</TD><TD> * @exception           DataValidationException when a product cannot be found.</TD></TR><TR><TD CLASS="l">1780</TD><TD> */</TD></TR><TR><TD CLASS="l">1781</TD><TD>public void setAllProductStates(String sessionName, short productState) throws TransactionFailedException, DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">1782</TD><TD>    setAllProductStates(sessionName, productState, false /* use queue for state changes */ );</TD></TR><TR CLASS="z"><TD CLASS="l">1783</TD><TD>}</TD></TR><TR><TD CLASS="l">1784</TD><TD>/**</TD></TR><TR><TD CLASS="l">1785</TD><TD> * Sets the product state for all products to the specified state.</TD></TR><TR><TD CLASS="l">1786</TD><TD> *</TD></TR><TR><TD CLASS="l">1787</TD><TD> * @param productState  state to set the products to.  This should be one of</TD></TR><TR><TD CLASS="l">1788</TD><TD> *                      the states defined in the &lt;code&gt;ProductStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l">1789</TD><TD> * @param immediate     if true, state change will be done immediately</TD></TR><TR><TD CLASS="l">1790</TD><TD> * @exception           TransactionFailedException when the state change is not valid.</TD></TR><TR><TD CLASS="l"><A NAME="6b">1791</A></TD><TD> * @exception           DataValidationException when a product cannot be found.</TD></TR><TR><TD CLASS="l">1792</TD><TD> */</TD></TR><TR><TD CLASS="l">1793</TD><TD>public void setAllProductStates(String sessionName, short productState, boolean immediate) throws TransactionFailedException </TD></TR><TR><TD CLASS="l">1794</TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">1795</TD><TD>    TradingClass[] configuredClasses = cachedTradingClassHome.findAllConfiguredForSession(sessionName);</TD></TR><TR><TD CLASS="l">1796</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1797</TD><TD>    ArrayList&lt;String&gt; regularFailedClasses = new ArrayList&lt;String&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1798</TD><TD>    ArrayList&lt;String&gt; strategyFailedClasses = new ArrayList&lt;String&gt;();</TD></TR><TR><TD CLASS="l">1799</TD><TD>    // Need to do two passes - first pass for non-strategy classes</TD></TR><TR CLASS="z"><TD CLASS="l">1800</TD><TD>    regularFailedClasses = setProductStatesForSelectedClasses( configuredClasses, productState, immediate, false);</TD></TR><TR><TD CLASS="l">1801</TD><TD>    // do second pass of configured classes for strategies</TD></TR><TR CLASS="z"><TD CLASS="l">1802</TD><TD>    strategyFailedClasses = setProductStatesForSelectedClasses( configuredClasses, productState, immediate, true);</TD></TR><TR><TD CLASS="l">1803</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1804</TD><TD>    if (regularFailedClasses.size() &gt; 0 ||strategyFailedClasses.size() &gt;0 )</TD></TR><TR><TD CLASS="l">1805</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1806</TD><TD>        int failedSize = regularFailedClasses.size() + strategyFailedClasses.size();</TD></TR><TR CLASS="z"><TD CLASS="l">1807</TD><TD>        String failedClasses = getFailedClassesName(regularFailedClasses, strategyFailedClasses );</TD></TR><TR CLASS="z"><TD CLASS="l">1808</TD><TD>        String description = &#34;At least one Product State Service failed or refused to change the product state: (#failedCount: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1809</TD><TD>                + failedSize + &#34;), Failed classes: &#34; +failedClasses ;</TD></TR><TR CLASS="z"><TD CLASS="l">1810</TD><TD>        throw ExceptionBuilder.transactionFailedException(description, com.cboe.idl.cmiErrorCodes.TransactionFailedCodes.INCOMPLETE_STATE_CHANGE);</TD></TR><TR><TD CLASS="l">1811</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3d">1812</A></TD><TD>}</TD></TR><TR><TD CLASS="l">1813</TD><TD> </TD></TR><TR><TD CLASS="l">1814</TD><TD>protected String getFailedClassesName(ArrayList&lt;String&gt; regularClass, ArrayList&lt;String&gt; strategyClass)</TD></TR><TR><TD CLASS="l">1815</TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">1816</TD><TD>    if(regularClass == null &amp;&amp; strategyClass == null)</TD></TR><TR><TD CLASS="l">1817</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1818</TD><TD>        return &#34;&#34;;</TD></TR><TR><TD CLASS="l">1819</TD><TD>    }</TD></TR><TR><TD CLASS="l">1820</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1821</TD><TD>    StringBuffer str = new StringBuffer();</TD></TR><TR><TD CLASS="l">1822</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1823</TD><TD>    if( regularClass != null)</TD></TR><TR><TD CLASS="l">1824</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1825</TD><TD>        for (int i = 0; i &lt; regularClass.size(); i++)</TD></TR><TR><TD CLASS="l">1826</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1827</TD><TD>            str.append(regularClass.get(i).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">1828</TD><TD>            str.append(&#34; &#34;);</TD></TR><TR><TD CLASS="l">1829</TD><TD>        }</TD></TR><TR><TD CLASS="l">1830</TD><TD>    }</TD></TR><TR><TD CLASS="l">1831</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1832</TD><TD>    if(strategyClass != null)</TD></TR><TR><TD CLASS="l">1833</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1834</TD><TD>        for (int j = 0; j &lt; strategyClass.size(); j++)</TD></TR><TR><TD CLASS="l">1835</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1836</TD><TD>            str.append(strategyClass.get(j).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">1837</TD><TD>            str.append(&#34; &#34;);</TD></TR><TR><TD CLASS="l">1838</TD><TD>        }</TD></TR><TR><TD CLASS="l">1839</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1840</TD><TD>    return str.toString();</TD></TR><TR><TD CLASS="l">1841</TD><TD>}</TD></TR><TR><TD CLASS="l">1842</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="7e">1843</A></TD><TD>     * Sets products states for either strategy or non-strategy classes</TD></TR><TR><TD CLASS="l">1844</TD><TD>     * @return ArrayList contains the classSymbol and Key that failed</TD></TR><TR><TD CLASS="l">1845</TD><TD>     */</TD></TR><TR><TD CLASS="l">1846</TD><TD>    protected ArrayList&lt;String&gt; setProductStatesForSelectedClasses( TradingClass[] configuredClasses, short productState, boolean immediate, boolean strategiesOnly) {</TD></TR><TR CLASS="z"><TD CLASS="l">1847</TD><TD>        ArrayList&lt;String&gt; classFailed = new ArrayList&lt;String&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1848</TD><TD>        ErrorCodeResultStruct error = StructBuilder.buildErrorCodeResultStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1849</TD><TD>        for (int i = 0; i &lt; configuredClasses.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1850</TD><TD>            boolean selected = strategiesOnly ? configuredClasses[i].getProductType() == ProductTypes.STRATEGY :</TD></TR><TR CLASS="z"><TD CLASS="l">1851</TD><TD>                                                configuredClasses[i].getProductType() != ProductTypes.STRATEGY;</TD></TR><TR CLASS="z"><TD CLASS="l">1852</TD><TD>            if (selected) {</TD></TR><TR CLASS="z"><TD CLASS="l">1853</TD><TD>                error = setProductStateByClass(configuredClasses[i], productState, immediate);</TD></TR><TR><TD CLASS="l">1854</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1855</TD><TD>            if (error.classKey &gt; 0)</TD></TR><TR><TD CLASS="l">1856</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1857</TD><TD>                classFailed.add( configuredClasses[i].getClassSymbol() + &#34;/&#34; + configuredClasses[i].getProductType());</TD></TR><TR CLASS="z"><TD CLASS="l">1858</TD><TD>                Log.alarm(this,&#34;Invalid state change for &#34; + configuredClasses[i].getClassSymbol() + &#34;/&#34; + configuredClasses[i].getProductType() + &#34;, not set to &#34; + productState);</TD></TR><TR><TD CLASS="l">1859</TD><TD>            }</TD></TR><TR><TD CLASS="l">1860</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1861</TD><TD>        return classFailed;</TD></TR><TR><TD CLASS="l">1862</TD><TD>    }</TD></TR><TR><TD CLASS="l">1863</TD><TD> </TD></TR><TR><TD CLASS="l">1864</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1865</TD><TD> * Performs admin request to set all product states.</TD></TR><TR><TD CLASS="l">1866</TD><TD> *</TD></TR><TR><TD CLASS="l">1867</TD><TD> * @param strState the state to set all products</TD></TR><TR><TD CLASS="l"><A NAME="25">1868</A></TD><TD> * @return description of result</TD></TR><TR><TD CLASS="l">1869</TD><TD> */</TD></TR><TR><TD CLASS="l">1870</TD><TD>@FFCommand(description=&#34;Set the state for all products&#34;, paramDescriptions = {&#34;Session name&#34;, &#34;State to set all products to&#34;})</TD></TR><TR><TD CLASS="l">1871</TD><TD>public String adminSetAllProductStates(String sessionName, String strState) {</TD></TR><TR CLASS="z"><TD CLASS="l">1872</TD><TD>    if (sessionName == null || strState == null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">1873</TD><TD>        Log.information(&#34;Could not set product states; no session or state specified&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1874</TD><TD>        return &#34;Could not set product states; no session or state specified&#34;;</TD></TR><TR><TD CLASS="l">1875</TD><TD>    }</TD></TR><TR><TD CLASS="l">1876</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">1877</TD><TD>        short state = Short.parseShort(strState);</TD></TR><TR CLASS="z"><TD CLASS="l">1878</TD><TD>        getMyInterceptor().setAllProductStates(sessionName, state);</TD></TR><TR CLASS="z"><TD CLASS="l">1879</TD><TD>        return &#34;All Product States set to &#34; + state;</TD></TR><TR><TD CLASS="l">1880</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">1881</TD><TD>    catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1882</TD><TD>        Log.information(&#34;Exception while setting all product states &#34; + e );</TD></TR><TR CLASS="z"><TD CLASS="l">1883</TD><TD>        return &#34;Exception while setting all product states &#34; + e;</TD></TR><TR><TD CLASS="l"><A NAME="48">1884</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1885</TD><TD>}</TD></TR><TR><TD CLASS="l">1886</TD><TD>protected String getStateAsString(short stateCode)</TD></TR><TR><TD CLASS="l">1887</TD><TD>{ </TD></TR><TR CLASS="z"><TD CLASS="l">1888</TD><TD>    switch(stateCode){ </TD></TR><TR><TD CLASS="l">1889</TD><TD>        case ProductStates.CLOSED : </TD></TR><TR CLASS="z"><TD CLASS="l">1890</TD><TD>            return &#34;CLOSED&#34;; </TD></TR><TR><TD CLASS="l">1891</TD><TD>        case ProductStates.PRE_OPEN : </TD></TR><TR CLASS="z"><TD CLASS="l">1892</TD><TD>            return &#34;PRE_OPEN&#34;; </TD></TR><TR><TD CLASS="l">1893</TD><TD>        case ProductStates.OPENING_ROTATION : </TD></TR><TR CLASS="z"><TD CLASS="l">1894</TD><TD>            return &#34;OPENING_ROTATION&#34;; </TD></TR><TR><TD CLASS="l">1895</TD><TD>        case ProductStates.OPEN : </TD></TR><TR CLASS="z"><TD CLASS="l">1896</TD><TD>            return &#34;OPEN&#34;; </TD></TR><TR><TD CLASS="l">1897</TD><TD>        case ProductStates.HALTED : </TD></TR><TR CLASS="z"><TD CLASS="l">1898</TD><TD>            return &#34;HALTED&#34;; </TD></TR><TR><TD CLASS="l">1899</TD><TD>        case ProductStates.FAST_MARKET : </TD></TR><TR CLASS="z"><TD CLASS="l">1900</TD><TD>            return &#34;FAST_MARKET&#34;; </TD></TR><TR><TD CLASS="l">1901</TD><TD>        case ProductStates.NO_SESSION : </TD></TR><TR CLASS="z"><TD CLASS="l">1902</TD><TD>            return &#34;NO_SESSION&#34;; </TD></TR><TR><TD CLASS="l">1903</TD><TD>        case ProductStates.ON_HOLD : </TD></TR><TR CLASS="z"><TD CLASS="l">1904</TD><TD>            return &#34;ON_HOLD&#34;; </TD></TR><TR><TD CLASS="l">1905</TD><TD>        case ProductStates.ENDING_HOLD : </TD></TR><TR CLASS="z"><TD CLASS="l">1906</TD><TD>            return &#34;ENDING_HOLD&#34;; </TD></TR><TR><TD CLASS="l">1907</TD><TD>        case ProductStates.SUSPENDED : </TD></TR><TR CLASS="z"><TD CLASS="l">1908</TD><TD>            return &#34;SUSPENDED&#34;; </TD></TR><TR><TD CLASS="l">1909</TD><TD>        default : </TD></TR><TR CLASS="z"><TD CLASS="l">1910</TD><TD>            return &#34;UNKNOWN&#34;; </TD></TR><TR><TD CLASS="l">1911</TD><TD>    } </TD></TR><TR><TD CLASS="l">1912</TD><TD>} </TD></TR><TR><TD CLASS="l">1913</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="81">1914</A></TD><TD> </TD></TR><TR><TD CLASS="l">1915</TD><TD> </TD></TR><TR><TD CLASS="l">1916</TD><TD>    public String showAllProductStatesIncludingProxiesCallback()</TD></TR><TR><TD CLASS="l">1917</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1918</TD><TD>        StringBuffer result = new StringBuffer(&#34;&#34;); </TD></TR><TR><TD CLASS="l">1919</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">1920</TD><TD>        TradingClass[] configuredClasses = getTradingClassHome().findAllConfiguredIncludingBuddyClasses();</TD></TR><TR CLASS="z"><TD CLASS="l">1921</TD><TD>        TradingProduct[] products = null; </TD></TR><TR><TD CLASS="l">1922</TD><TD>              </TD></TR><TR CLASS="z"><TD CLASS="l">1923</TD><TD>        for (int j = 0; j &lt; configuredClasses.length; j++) </TD></TR><TR><TD CLASS="l">1924</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1925</TD><TD>            result.append(&#34;TradingClass: &#34;).append(configuredClasses[j]).append(&#34;\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1926</TD><TD>            products = configuredClasses[j].getProducts(false); </TD></TR><TR CLASS="z"><TD CLASS="l">1927</TD><TD>            for (int k=0;k &lt; products.length; k++) </TD></TR><TR><TD CLASS="l">1928</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1929</TD><TD>               result.append(&#34;TradingProduct: &#34;).append(products[k]).append(&#34;\n&#34;);</TD></TR><TR><TD CLASS="l">1930</TD><TD>            }</TD></TR><TR><TD CLASS="l">1931</TD><TD>        }</TD></TR><TR><TD CLASS="l">1932</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1933</TD><TD>        return result.toString();</TD></TR><TR><TD CLASS="l">1934</TD><TD>    }</TD></TR><TR><TD CLASS="l">1935</TD><TD> </TD></TR><TR><TD CLASS="l">1936</TD><TD>/** </TD></TR><TR><TD CLASS="l">1937</TD><TD> * Performs admin request to show all product states. </TD></TR><TR><TD CLASS="l">1938</TD><TD> * </TD></TR><TR><TD CLASS="l">1939</TD><TD> * @param sessionName the name of the session to show products states </TD></TR><TR><TD CLASS="l"><A NAME="28">1940</A></TD><TD> * @return description of result </TD></TR><TR><TD CLASS="l">1941</TD><TD> */</TD></TR><TR><TD CLASS="l">1942</TD><TD>@FFCommand(description=&#34;Show the state for all products&#34;)</TD></TR><TR><TD CLASS="l">1943</TD><TD>public String adminShowAllProductStatesGroupBy() {</TD></TR><TR CLASS="z"><TD CLASS="l">1944</TD><TD>    String[] sessionNameList = TradingSessionNameHelper.getConfiguredSessionNames();</TD></TR><TR CLASS="z"><TD CLASS="l">1945</TD><TD>    int [] statesCount = new int [MAX_NO_OF_STATES]; </TD></TR><TR CLASS="z"><TD CLASS="l">1946</TD><TD>    short stateCode=0; </TD></TR><TR CLASS="z"><TD CLASS="l">1947</TD><TD>    StringBuffer result = new StringBuffer(&#34;&#34;); </TD></TR><TR><TD CLASS="l">1948</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">1949</TD><TD>    for (int i = 0; (sessionNameList != null) &amp;&amp; (i &lt; sessionNameList.length); i++)</TD></TR><TR><TD CLASS="l">1950</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1951</TD><TD>        String sessionName = sessionNameList[i];</TD></TR><TR CLASS="z"><TD CLASS="l">1952</TD><TD>        if (TradingSessionNameHelper.isUnderlyingSession(sessionName) == false) </TD></TR><TR><TD CLASS="l">1953</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1954</TD><TD>              TradingClass[] configuredClasses = cachedTradingClassHome.findAllConfiguredForSession(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">1955</TD><TD>              TradingProduct[] products = null; </TD></TR><TR><TD CLASS="l">1956</TD><TD>              </TD></TR><TR CLASS="z"><TD CLASS="l">1957</TD><TD>              for (int j = 0; j &lt; configuredClasses.length; j++) </TD></TR><TR><TD CLASS="l">1958</TD><TD>              { </TD></TR><TR CLASS="z"><TD CLASS="l">1959</TD><TD>                  products = configuredClasses[j].getProducts(true); </TD></TR><TR CLASS="z"><TD CLASS="l">1960</TD><TD>                  for (int k=0;k &lt; products.length; k++) </TD></TR><TR><TD CLASS="l">1961</TD><TD>                  { </TD></TR><TR CLASS="z"><TD CLASS="l">1962</TD><TD>                      stateCode = products[k].getCurrentStateCode(); </TD></TR><TR CLASS="z"><TD CLASS="l">1963</TD><TD>                      if( stateCode &lt; 1 || stateCode &gt; (MAX_NO_OF_STATES -1) ) //Unknown state code </TD></TR><TR><TD CLASS="l">1964</TD><TD>                      { </TD></TR><TR CLASS="z"><TD CLASS="l">1965</TD><TD>                          statesCount[0]++; </TD></TR><TR><TD CLASS="l">1966</TD><TD>                      } </TD></TR><TR><TD CLASS="l">1967</TD><TD>                      else //known state code </TD></TR><TR><TD CLASS="l">1968</TD><TD>                      { </TD></TR><TR CLASS="z"><TD CLASS="l">1969</TD><TD>                          statesCount[stateCode]++; </TD></TR><TR><TD CLASS="l">1970</TD><TD>                      } </TD></TR><TR><TD CLASS="l">1971</TD><TD>                  } </TD></TR><TR><TD CLASS="l">1972</TD><TD>              }</TD></TR><TR><TD CLASS="l">1973</TD><TD>        }</TD></TR><TR><TD CLASS="l">1974</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">1975</TD><TD>            result.append(&#34;No sessions assigned on this server&#34;);</TD></TR><TR><TD CLASS="l">1976</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1977</TD><TD>        result.append(&#34;For session &#34;).append(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">1978</TD><TD>        for(short m=0; m &lt; MAX_NO_OF_STATES; m++) </TD></TR><TR><TD CLASS="l">1979</TD><TD>        { </TD></TR><TR CLASS="z"><TD CLASS="l">1980</TD><TD>           if( statesCount[m] != 0) </TD></TR><TR><TD CLASS="l">1981</TD><TD>           { </TD></TR><TR CLASS="z"><TD CLASS="l">1982</TD><TD>               result.append(&#34;\n&#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">1983</TD><TD>               result.append(&#34;        &#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">1984</TD><TD>               result.append(&#34; State = &#34;).append(getStateAsString(m)).append(&#34; Count = &#34;).append(statesCount[m]); </TD></TR><TR><TD CLASS="l">1985</TD><TD>               </TD></TR><TR><TD CLASS="l">1986</TD><TD>            } </TD></TR><TR><TD CLASS="l">1987</TD><TD>        } </TD></TR><TR><TD CLASS="l">1988</TD><TD>    }       </TD></TR><TR><TD CLASS="l">1989</TD><TD>   </TD></TR><TR CLASS="z"><TD CLASS="l">1990</TD><TD>    return result.toString();</TD></TR><TR><TD CLASS="l">1991</TD><TD>    </TD></TR><TR><TD CLASS="l">1992</TD><TD>}</TD></TR><TR><TD CLASS="l">1993</TD><TD> </TD></TR><TR><TD CLASS="l">1994</TD><TD>/** </TD></TR><TR><TD CLASS="l">1995</TD><TD> * Performs admin request to show all product type and states. </TD></TR><TR><TD CLASS="l">1996</TD><TD> * </TD></TR><TR><TD CLASS="l">1997</TD><TD> * @return description of result </TD></TR><TR><TD CLASS="l"><A NAME="29">1998</A></TD><TD> */ </TD></TR><TR><TD CLASS="l">1999</TD><TD>@FFCommand(description=&#34;Show the product type and state for all products&#34;)</TD></TR><TR><TD CLASS="l">2000</TD><TD>public String adminShowProductTypeStateGroupBy() {</TD></TR><TR><TD CLASS="l">2001</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">2002</TD><TD>    String[] sessionNameList = TradingSessionNameHelper.getConfiguredSessionNames();</TD></TR><TR CLASS="z"><TD CLASS="l">2003</TD><TD>    TradingProduct[] products = null; </TD></TR><TR CLASS="z"><TD CLASS="l">2004</TD><TD>    int [][] statesCount = new int [MAX_NO_OF_PROD_TYPES] [MAX_NO_OF_STATES]; </TD></TR><TR CLASS="z"><TD CLASS="l">2005</TD><TD>    short stateCode=0; </TD></TR><TR CLASS="z"><TD CLASS="l">2006</TD><TD>    StringBuffer result = new StringBuffer(&#34;&#34;); </TD></TR><TR><TD CLASS="l">2007</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">2008</TD><TD>    for (int i = 0; (sessionNameList != null) &amp;&amp; (i &lt; sessionNameList.length); i++)</TD></TR><TR><TD CLASS="l">2009</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2010</TD><TD>        String sessionName = sessionNameList[i];</TD></TR><TR CLASS="z"><TD CLASS="l">2011</TD><TD>        if (TradingSessionNameHelper.isUnderlyingSession(sessionName) == false) </TD></TR><TR><TD CLASS="l">2012</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2013</TD><TD>            TradingClass[] configuredClasses = cachedTradingClassHome.findAllConfiguredForSession(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2014</TD><TD>            for (int j = 0; j &lt; configuredClasses.length; j++) </TD></TR><TR><TD CLASS="l">2015</TD><TD>            { </TD></TR><TR CLASS="z"><TD CLASS="l">2016</TD><TD>                short prodType = configuredClasses[j].getProductType(); </TD></TR><TR CLASS="z"><TD CLASS="l">2017</TD><TD>                products = configuredClasses[j].getProducts(true); </TD></TR><TR CLASS="z"><TD CLASS="l">2018</TD><TD>                for (int k=0;k &lt; products.length; k++) </TD></TR><TR><TD CLASS="l">2019</TD><TD>                { </TD></TR><TR CLASS="z"><TD CLASS="l">2020</TD><TD>                    stateCode = products[k].getCurrentStateCode(); </TD></TR><TR CLASS="z"><TD CLASS="l">2021</TD><TD>                    if( stateCode &lt; 1 || stateCode &gt; (MAX_NO_OF_STATES -1) ) //Unknown state code </TD></TR><TR><TD CLASS="l">2022</TD><TD>                    { </TD></TR><TR CLASS="z"><TD CLASS="l">2023</TD><TD>                        statesCount[0][0]++; </TD></TR><TR><TD CLASS="l">2024</TD><TD>                    } </TD></TR><TR><TD CLASS="l">2025</TD><TD>                    else //known state code </TD></TR><TR><TD CLASS="l">2026</TD><TD>                    { </TD></TR><TR CLASS="z"><TD CLASS="l">2027</TD><TD>                        statesCount[prodType][stateCode]++; </TD></TR><TR><TD CLASS="l">2028</TD><TD>                    } </TD></TR><TR><TD CLASS="l">2029</TD><TD>                } </TD></TR><TR><TD CLASS="l">2030</TD><TD>            } </TD></TR><TR CLASS="z"><TD CLASS="l">2031</TD><TD>            result.append(&#34;For session &#34;).append(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2032</TD><TD>            for (short m=0; m &lt; MAX_NO_OF_PROD_TYPES; m++) </TD></TR><TR><TD CLASS="l">2033</TD><TD>            { </TD></TR><TR CLASS="z"><TD CLASS="l">2034</TD><TD>                for(short n=0; n &lt; MAX_NO_OF_STATES; n++) </TD></TR><TR><TD CLASS="l">2035</TD><TD>                { </TD></TR><TR CLASS="z"><TD CLASS="l">2036</TD><TD>                    if( statesCount[m][n] != 0) </TD></TR><TR><TD CLASS="l">2037</TD><TD>                    { </TD></TR><TR CLASS="z"><TD CLASS="l">2038</TD><TD>                        result.append( &#34;\n&#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2039</TD><TD>                        result.append( &#34;        &#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2040</TD><TD>                        result.append(&#34; Type = &#34;).append(m).append( &#34;  State &#34;).append(getStateAsString(n)).append(&#34; Count = &#34;).append(statesCount[m][n]); </TD></TR><TR><TD CLASS="l">2041</TD><TD>                    } </TD></TR><TR><TD CLASS="l">2042</TD><TD>                } </TD></TR><TR><TD CLASS="l">2043</TD><TD>            }          </TD></TR><TR><TD CLASS="l">2044</TD><TD>        }</TD></TR><TR><TD CLASS="l">2045</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">2046</TD><TD>            result.append(&#34;No sessions assigned on this server&#34;);</TD></TR><TR><TD CLASS="l">2047</TD><TD>        }</TD></TR><TR><TD CLASS="l">2048</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2049</TD><TD>    return result.toString(); </TD></TR><TR><TD CLASS="l">2050</TD><TD>     </TD></TR><TR><TD CLASS="l"><A NAME="41">2051</A></TD><TD> } </TD></TR><TR><TD CLASS="l">2052</TD><TD> </TD></TR><TR><TD CLASS="l">2053</TD><TD>protected String getProductName(TradingProduct product)</TD></TR><TR><TD CLASS="l">2054</TD><TD>{ </TD></TR><TR CLASS="z"><TD CLASS="l">2055</TD><TD>    StringBuffer result = new StringBuffer(&#34; product (&#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2056</TD><TD>    ProductNameStruct nameStruct = product.getProductNameStruct(); </TD></TR><TR CLASS="z"><TD CLASS="l">2057</TD><TD>    result.append(product.toString()); </TD></TR><TR CLASS="z"><TD CLASS="l">2058</TD><TD>    result.append(&#34;) &#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2059</TD><TD>    result.append(&#34; &#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2060</TD><TD>    result.append(nameStruct.reportingClass); </TD></TR><TR CLASS="z"><TD CLASS="l">2061</TD><TD>    result.append(&#34; &#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2062</TD><TD>    result.append(nameStruct.productSymbol); </TD></TR><TR CLASS="z"><TD CLASS="l">2063</TD><TD>    result.append(&#34; &#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2064</TD><TD>    result.append(nameStruct.expirationDate.month + &#34;/&#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2065</TD><TD>    result.append(nameStruct.expirationDate.year + &#34; &#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2066</TD><TD>    result.append(nameStruct.exercisePrice.whole + &#34;.&#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2067</TD><TD>    result.append(nameStruct.exercisePrice.fraction); </TD></TR><TR CLASS="z"><TD CLASS="l">2068</TD><TD>    result.append(&#34; &#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2069</TD><TD>    result.append(nameStruct.optionType); </TD></TR><TR><TD CLASS="l">2070</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2071</TD><TD>    return result.toString(); </TD></TR><TR><TD CLASS="l"><A NAME="2a">2072</A></TD><TD>} </TD></TR><TR><TD CLASS="l">2073</TD><TD> </TD></TR><TR><TD CLASS="l">2074</TD><TD>@FFCommand(description=&#34;Show the state for all series&#34;)</TD></TR><TR><TD CLASS="l">2075</TD><TD>public String adminShowSeriesStateGroupBy() {</TD></TR><TR CLASS="z"><TD CLASS="l">2076</TD><TD>    String[] sessionNameList = TradingSessionNameHelper.getConfiguredSessionNames();</TD></TR><TR CLASS="z"><TD CLASS="l">2077</TD><TD>    TradingProduct[] products = null; </TD></TR><TR CLASS="z"><TD CLASS="l">2078</TD><TD>    StringBuffer result = new StringBuffer(&#34;&#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2079</TD><TD>    for (int i = 0; (sessionNameList != null) &amp;&amp; (i &lt; sessionNameList.length); i++)</TD></TR><TR><TD CLASS="l">2080</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2081</TD><TD>        String sessionName = sessionNameList[i];</TD></TR><TR CLASS="z"><TD CLASS="l">2082</TD><TD>        if (TradingSessionNameHelper.isUnderlyingSession(sessionName) == false) </TD></TR><TR><TD CLASS="l">2083</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2084</TD><TD>             TradingClass[] configuredClasses = cachedTradingClassHome.findAllConfiguredForSession(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2085</TD><TD>             if (configuredClasses.length == 0) </TD></TR><TR><TD CLASS="l">2086</TD><TD>             { </TD></TR><TR CLASS="z"><TD CLASS="l">2087</TD><TD>                 result.append(&#34;No data found&#34;); </TD></TR><TR><TD CLASS="l">2088</TD><TD>             } </TD></TR><TR CLASS="z"><TD CLASS="l">2089</TD><TD>             result.append(&#34;For session &#34;).append(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2090</TD><TD>             for (int j = 0; j &lt; configuredClasses.length; j++) </TD></TR><TR><TD CLASS="l">2091</TD><TD>             { </TD></TR><TR CLASS="z"><TD CLASS="l">2092</TD><TD>                 products = configuredClasses[j].getProducts(true); </TD></TR><TR CLASS="z"><TD CLASS="l">2093</TD><TD>                 for (int k=0;k &lt; products.length; k++) </TD></TR><TR><TD CLASS="l">2094</TD><TD>                 {  </TD></TR><TR CLASS="z"><TD CLASS="l">2095</TD><TD>                     result.append( &#34;\n&#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2096</TD><TD>                     result.append( &#34;        &#34;); </TD></TR><TR CLASS="z"><TD CLASS="l">2097</TD><TD>                     result.append(&#34; Type = &#34;).append(configuredClasses[j].getProductType()); </TD></TR><TR CLASS="z"><TD CLASS="l">2098</TD><TD>                     result.append(&#34;  State = &#34;).append(getStateAsString(products[k].getCurrentStateCode())); </TD></TR><TR CLASS="z"><TD CLASS="l">2099</TD><TD>                     result.append(&#34; ,&#34;).append(getProductName(products[k])); </TD></TR><TR><TD CLASS="l">2100</TD><TD>                 } </TD></TR><TR><TD CLASS="l">2101</TD><TD>             }</TD></TR><TR><TD CLASS="l">2102</TD><TD>        }</TD></TR><TR><TD CLASS="l">2103</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">2104</TD><TD>            result.append(&#34;No sessions assigned on this server&#34;);</TD></TR><TR><TD CLASS="l">2105</TD><TD>        }</TD></TR><TR><TD CLASS="l">2106</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2107</TD><TD>    return result.toString(); </TD></TR><TR><TD CLASS="l">2108</TD><TD>       </TD></TR><TR><TD CLASS="l">2109</TD><TD>   } </TD></TR><TR><TD CLASS="l">2110</TD><TD> </TD></TR><TR><TD CLASS="l">2111</TD><TD>/**</TD></TR><TR><TD CLASS="l">2112</TD><TD> * Sets the listing state for all products for the specified class to the specified state.</TD></TR><TR><TD CLASS="l">2113</TD><TD> *</TD></TR><TR><TD CLASS="l">2114</TD><TD> * @param productState  state to set the products to.  This should be one of</TD></TR><TR><TD CLASS="l">2115</TD><TD> *                      the states defined in the &lt;code&gt;ListingStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l">2116</TD><TD> * @exception           TransactionFailedException when the state change is not valid.</TD></TR><TR><TD CLASS="l"><A NAME="6e">2117</A></TD><TD> * @exception           DataValidationException when a product class cannot be found.</TD></TR><TR><TD CLASS="l">2118</TD><TD> */</TD></TR><TR><TD CLASS="l">2119</TD><TD>public void setListingStateByClass(int classKey, short productState) throws TransactionFailedException, DataValidationException {</TD></TR><TR><TD CLASS="l">2120</TD><TD>    // method should be removed from IDL - can't change listing state</TD></TR><TR CLASS="z"><TD CLASS="l">2121</TD><TD>}</TD></TR><TR><TD CLASS="l">2122</TD><TD>/**</TD></TR><TR><TD CLASS="l">2123</TD><TD> * Sets the listing state for the product to the specified state.</TD></TR><TR><TD CLASS="l">2124</TD><TD> *</TD></TR><TR><TD CLASS="l">2125</TD><TD> * @param productState  state to set the product to.  This should be one of</TD></TR><TR><TD CLASS="l">2126</TD><TD> *                      the states defined in the &lt;code&gt;ListingStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l">2127</TD><TD> * @exception           TransactionFailedException when the state change is not valid.</TD></TR><TR><TD CLASS="l"><A NAME="6f">2128</A></TD><TD> * @exception           DataValidationException when a product cannot be found.</TD></TR><TR><TD CLASS="l">2129</TD><TD> */</TD></TR><TR><TD CLASS="l">2130</TD><TD>public void setListingStateByProduct(int productKey, short productState) throws TransactionFailedException, DataValidationException {</TD></TR><TR><TD CLASS="l">2131</TD><TD>    // method should be removed from IDL - can't change listing state</TD></TR><TR CLASS="z"><TD CLASS="l">2132</TD><TD>}</TD></TR><TR><TD CLASS="l">2133</TD><TD>/**</TD></TR><TR><TD CLASS="l">2134</TD><TD> * Sets the product state for all products for the specified class to the specified state.</TD></TR><TR><TD CLASS="l">2135</TD><TD> *</TD></TR><TR><TD CLASS="l">2136</TD><TD> * @param classKey      key of class being changed</TD></TR><TR><TD CLASS="l">2137</TD><TD> * @param productState  state to set the products to.  This should be one of</TD></TR><TR><TD CLASS="l">2138</TD><TD> *                      the states defined in the &lt;code&gt;ProductStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l">2139</TD><TD> * @exception           TransactionFailedException when the state change is not valid.</TD></TR><TR><TD CLASS="l"><A NAME="76">2140</A></TD><TD> * @exception           DataValidationException when a product class cannot be found.</TD></TR><TR><TD CLASS="l">2141</TD><TD> */</TD></TR><TR><TD CLASS="l">2142</TD><TD>public void setProductStateByClass(String sessionName, int classKey, short productState) throws TransactionFailedException, DataValidationException {</TD></TR><TR><TD CLASS="l">2143</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2144</TD><TD>    Log.information(this, &#34;setting product state change at interface level (corba call)&#34;  + sessionName + &#34;:&#34; + classKey + &#34;:&#34; + productState);</TD></TR><TR CLASS="z"><TD CLASS="l">2145</TD><TD>    setProductStateByClassLocal(sessionName, classKey, productState);</TD></TR><TR CLASS="z"><TD CLASS="l">2146</TD><TD>}</TD></TR><TR><TD CLASS="l">2147</TD><TD> </TD></TR><TR><TD CLASS="l">2148</TD><TD>/**</TD></TR><TR><TD CLASS="l">2149</TD><TD> * This method was created for rollout only. Because product state could be set by both</TD></TR><TR><TD CLASS="l">2150</TD><TD> * global call and Market data buffer from XTP we wanted to ensure who was changing product</TD></TR><TR><TD CLASS="l">2151</TD><TD> * state first.  After rollout is completed, this code can be returned to the interface level.</TD></TR><TR><TD CLASS="l"><A NAME="79">2152</A></TD><TD> *</TD></TR><TR><TD CLASS="l">2153</TD><TD> * This method was only made protected for unit testing purposes.</TD></TR><TR><TD CLASS="l">2154</TD><TD> */</TD></TR><TR><TD CLASS="l">2155</TD><TD>protected void setProductStateByClassLocal(String sessionName, int classKey, short productState) throws TransactionFailedException, DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">2156</TD><TD>    if(Log.isDebugOn())</TD></TR><TR CLASS="z"><TD CLASS="l">2157</TD><TD>        Log.debug(this, &#34;setting product state - session:class:state::&#34; + sessionName + &#34;:&#34; + classKey + &#34;:&#34; + productState);</TD></TR><TR><TD CLASS="l">2158</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2159</TD><TD>    ErrorCodeResultStruct error = StructBuilder.buildErrorCodeResultStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2160</TD><TD>    error = setProductStateByClass(sessionName, classKey, productState, false /* not immediately */);</TD></TR><TR CLASS="z"><TD CLASS="l">2161</TD><TD>    if (error.classKey &gt; 0)</TD></TR><TR><TD CLASS="l">2162</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2163</TD><TD>        if (error.failedProducts[0].key &lt; 0)</TD></TR><TR CLASS="z"><TD CLASS="l">2164</TD><TD>            throw ExceptionBuilder.dataValidationException(error.exceptionDescription, error.errorCode);</TD></TR><TR CLASS="z"><TD CLASS="l">2165</TD><TD>        else if (error.failedProducts[0].key &gt; 0)</TD></TR><TR CLASS="z"><TD CLASS="l">2166</TD><TD>            throw ExceptionBuilder.transactionFailedException(error.exceptionDescription, error.errorCode);</TD></TR><TR><TD CLASS="l">2167</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="7a">2168</A></TD><TD>}</TD></TR><TR><TD CLASS="l">2169</TD><TD> </TD></TR><TR><TD CLASS="l">2170</TD><TD> </TD></TR><TR><TD CLASS="l">2171</TD><TD>public ErrorCodeResultStruct setProductStateByClassV2(String sessionName, int classKey, short productState){</TD></TR><TR CLASS="z"><TD CLASS="l">2172</TD><TD>    if(Log.isDebugOn())</TD></TR><TR CLASS="z"><TD CLASS="l">2173</TD><TD>        Log.debug(this, &#34;setting product state - session:class:state::&#34; + sessionName + &#34;:&#34; + classKey + &#34;:&#34; + productState);</TD></TR><TR><TD CLASS="l">2174</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2175</TD><TD>    return setProductStateByClass(sessionName, classKey, productState, false /* not immediately */);</TD></TR><TR><TD CLASS="l">2176</TD><TD>}</TD></TR><TR><TD CLASS="l">2177</TD><TD> </TD></TR><TR><TD CLASS="l">2178</TD><TD>/**</TD></TR><TR><TD CLASS="l">2179</TD><TD> * Sets the product state for all products for the specified class to the specified state.</TD></TR><TR><TD CLASS="l">2180</TD><TD> *</TD></TR><TR><TD CLASS="l">2181</TD><TD> * @param classKey      key of class being changed</TD></TR><TR><TD CLASS="l">2182</TD><TD> * @param productState  state to set the products to.  This should be one of</TD></TR><TR><TD CLASS="l">2183</TD><TD> *                      the states defined in the &lt;code&gt;ProductStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l"><A NAME="77">2184</A></TD><TD> * @param immediate     if true, state change will be done immediately</TD></TR><TR><TD CLASS="l">2185</TD><TD> */</TD></TR><TR><TD CLASS="l">2186</TD><TD>public ErrorCodeResultStruct setProductStateByClass(String sessionName, int classKey, short productState, boolean immediate)</TD></TR><TR><TD CLASS="l">2187</TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">2188</TD><TD>    ErrorCodeResultStruct error = StructBuilder.buildErrorCodeResultStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2189</TD><TD>    KeyDescriptionStruct[] failedProducts = StructBuilder.buildKeyDescriptionStructSequence();</TD></TR><TR><TD CLASS="l">2190</TD><TD> </TD></TR><TR><TD CLASS="l">2191</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">2192</TD><TD>        TradingClass tradingClass = cachedTradingClassHome.findByKey(classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2193</TD><TD>        Log.information(&#34;Waiting for the class lock:&#34;+tradingClass.getClassSymbol()+&#34; Thread ID:&#34;+Thread.currentThread().getId());</TD></TR><TR CLASS="z"><TD CLASS="l">2194</TD><TD>        synchronized(tradingClass)</TD></TR><TR><TD CLASS="l">2195</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2196</TD><TD>                if (tradingClass.getSessionName().equals(sessionName)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2197</TD><TD>                    Log.information(&#34;Class lock acquired:&#34;+tradingClass.getClassSymbol()+&#34; Thread ID:&#34;+Thread.currentThread().getId());</TD></TR><TR CLASS="z"><TD CLASS="l">2198</TD><TD>                    error = setProductStateByClass(tradingClass, productState, immediate);</TD></TR><TR><TD CLASS="l">2199</TD><TD>                }</TD></TR><TR><TD CLASS="l">2200</TD><TD>                else {</TD></TR><TR><TD CLASS="l">2201</TD><TD>                    //build DataValidation Error</TD></TR><TR CLASS="z"><TD CLASS="l">2202</TD><TD>                    error.classKey = classKey;</TD></TR><TR CLASS="z"><TD CLASS="l">2203</TD><TD>                    error.exceptionDescription = &#34;Class (&#34; + classKey + &#34;) is not in session (&#34; + sessionName + &#34;)&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2204</TD><TD>                    error.errorCode = DataValidationCodes.INVALID_SESSION;</TD></TR><TR CLASS="z"><TD CLASS="l">2205</TD><TD>                    failedProducts[0] = new KeyDescriptionStruct(-1, &#34;DataValidationException&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2206</TD><TD>                    error.failedProducts = failedProducts;</TD></TR><TR><TD CLASS="l">2207</TD><TD>                }</TD></TR><TR><TD CLASS="l">2208</TD><TD>        }</TD></TR><TR><TD CLASS="l">2209</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2210</TD><TD>    catch (NotFoundException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2211</TD><TD>        error.classKey = classKey;</TD></TR><TR CLASS="z"><TD CLASS="l">2212</TD><TD>        error.exceptionDescription = e.details.message;</TD></TR><TR CLASS="z"><TD CLASS="l">2213</TD><TD>        error.errorCode = e.details.error;</TD></TR><TR CLASS="z"><TD CLASS="l">2214</TD><TD>        failedProducts[0] = new KeyDescriptionStruct(-1, &#34;DataValidationException&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2215</TD><TD>        error.failedProducts = failedProducts;</TD></TR><TR><TD CLASS="l">2216</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2217</TD><TD>    return error;</TD></TR><TR><TD CLASS="l">2218</TD><TD>}</TD></TR><TR><TD CLASS="l">2219</TD><TD>/**</TD></TR><TR><TD CLASS="l">2220</TD><TD> * Sets the product state for all products for the specified class to the specified state.</TD></TR><TR><TD CLASS="l">2221</TD><TD> *</TD></TR><TR><TD CLASS="l">2222</TD><TD> * @param tradingClass  class having state changed</TD></TR><TR><TD CLASS="l">2223</TD><TD> * @param productState  state to set the products to.  This should be one of</TD></TR><TR><TD CLASS="l">2224</TD><TD> *                      the states defined in the &lt;code&gt;ProductStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l"><A NAME="78">2225</A></TD><TD> * @param immediate     flag indicating if state change should be done immediately</TD></TR><TR><TD CLASS="l">2226</TD><TD> */</TD></TR><TR><TD CLASS="l">2227</TD><TD>protected ErrorCodeResultStruct setProductStateByClass(TradingClass tradingClass, short productState, boolean immediate)</TD></TR><TR><TD CLASS="l">2228</TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">2229</TD><TD>    Log.information(this,&#34;Setting ProductState for class &#34; + tradingClass.getProductClassKey() + &#34; product state:&#34;+productState+&#34; immediate:&#34;+immediate+&#34; ThreadId:&#34;+Thread.currentThread().getId());</TD></TR><TR CLASS="z"><TD CLASS="l">2230</TD><TD>    boolean success = false;</TD></TR><TR CLASS="z"><TD CLASS="l">2231</TD><TD>    int productKey = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2232</TD><TD>    ErrorCodeResultStruct error = StructBuilder.buildErrorCodeResultStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2233</TD><TD>    KeyDescriptionStruct[] failedProducts = StructBuilder.buildKeyDescriptionStructSequence();</TD></TR><TR CLASS="z"><TD CLASS="l">2234</TD><TD>    Transaction.startTransaction();</TD></TR><TR><TD CLASS="l">2235</TD><TD>    try{</TD></TR><TR><TD CLASS="l">2236</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2237</TD><TD>        TradingProduct[] products = tradingClass.getProducts(true);</TD></TR><TR><TD CLASS="l">2238</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2239</TD><TD>        if (immediate) {</TD></TR><TR><TD CLASS="l">2240</TD><TD>            // We want to publish the class level state change event before the product level events</TD></TR><TR CLASS="z"><TD CLASS="l">2241</TD><TD>            publishClassStateChange(tradingClass,</TD></TR><TR CLASS="z"><TD CLASS="l">2242</TD><TD>                    convertProductStateToClassState(productState),</TD></TR><TR CLASS="z"><TD CLASS="l">2243</TD><TD>                    getProductStatePublisher());</TD></TR><TR CLASS="z"><TD CLASS="l">2244</TD><TD>            for (int i = 0; i &lt; products.length; i ++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2245</TD><TD>                productKey = products[i].getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">2246</TD><TD>                setProductState(products[i], productState, immediate);</TD></TR><TR><TD CLASS="l">2247</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2248</TD><TD>            tradingClass.setInternalState(convertProductStateToClassState(productState));</TD></TR><TR CLASS="z"><TD CLASS="l">2249</TD><TD>            tradingClass.setGlobalState(convertProductStateToClassState(productState));</TD></TR><TR><TD CLASS="l">2250</TD><TD>        }</TD></TR><TR><TD CLASS="l">2251</TD><TD>        // can skip over a class if it doesn't have any products - like a strategy class with no defined strategies</TD></TR><TR CLASS="z"><TD CLASS="l">2252</TD><TD>        else if (products.length &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">2253</TD><TD>            ProductStateChangeCommand[] productCommands = new ProductStateChangeCommand[products.length];</TD></TR><TR CLASS="z"><TD CLASS="l">2254</TD><TD>            for (int i = 0; i &lt; products.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2255</TD><TD>                productKey = products[i].getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">2256</TD><TD>                productCommands[i] = doProductStateChange(products[i], productState, immediate);</TD></TR><TR><TD CLASS="l">2257</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2258</TD><TD>            ProductStateChangeByClassCommand classCommand = new ProductStateChangeByClassCommand(productCommands, tradingClass);</TD></TR><TR><TD CLASS="l">2259</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2260</TD><TD>                tradingClass.acceptCommand(classCommand, true);</TD></TR><TR><TD CLASS="l">2261</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2262</TD><TD>            catch (NotAcceptedException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2263</TD><TD>                Log.alarm(this, &#34;Cannot use state command - setting state immediately&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2264</TD><TD>                classCommand.execute();</TD></TR><TR><TD CLASS="l">2265</TD><TD>            }</TD></TR><TR><TD CLASS="l">2266</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2267</TD><TD>        success = Transaction.commit();</TD></TR><TR CLASS="z"><TD CLASS="l">2268</TD><TD>    }catch (TransactionFailedException ex)</TD></TR><TR><TD CLASS="l">2269</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2270</TD><TD>        error.classKey = tradingClass.getProductClassKey();</TD></TR><TR CLASS="z"><TD CLASS="l">2271</TD><TD>        error.exceptionDescription = ex.details.message;</TD></TR><TR CLASS="z"><TD CLASS="l">2272</TD><TD>        error.errorCode = ex.details.error;</TD></TR><TR CLASS="z"><TD CLASS="l">2273</TD><TD>        failedProducts[0] = new KeyDescriptionStruct(productKey, &#34;TransactionFailedException&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2274</TD><TD>        error.failedProducts = failedProducts;</TD></TR><TR><TD CLASS="l">2275</TD><TD> }</TD></TR><TR CLASS="z"><TD CLASS="l">2276</TD><TD>    finally {</TD></TR><TR CLASS="z"><TD CLASS="l">2277</TD><TD>        if (!success) {</TD></TR><TR CLASS="z"><TD CLASS="l">2278</TD><TD>            Transaction.rollback();</TD></TR><TR><TD CLASS="l">2279</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2280</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2281</TD><TD>    return error;</TD></TR><TR><TD CLASS="l">2282</TD><TD> }</TD></TR><TR><TD CLASS="l">2283</TD><TD>/**</TD></TR><TR><TD CLASS="l">2284</TD><TD> * Performs admin request to set states for all products of a class.</TD></TR><TR><TD CLASS="l">2285</TD><TD> *</TD></TR><TR><TD CLASS="l">2286</TD><TD> * @param strClassKey the product class key or class symbol</TD></TR><TR><TD CLASS="l">2287</TD><TD> * @param strState the state to set all products</TD></TR><TR><TD CLASS="l">2288</TD><TD> * @return description of result</TD></TR><TR><TD CLASS="l"><A NAME="26">2289</A></TD><TD> */</TD></TR><TR><TD CLASS="l">2290</TD><TD>@FFCommand(description=&#34;Set the state for all products in a class&#34;,</TD></TR><TR><TD CLASS="l">2291</TD><TD>        paramDescriptions = {&#34;Session name&#34;, &#34;ProductClass key or symbol&#34;, &#34;State to set all products in the class to&#34;})</TD></TR><TR><TD CLASS="l">2292</TD><TD>public String adminSetProductStateByClass(String sessionName, String strClassKey, String strState) {</TD></TR><TR CLASS="z"><TD CLASS="l">2293</TD><TD>    if (sessionName == null || strClassKey == null || strState == null ){</TD></TR><TR CLASS="z"><TD CLASS="l">2294</TD><TD>        Log.information(&#34;Could not set product states; no state specified&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2295</TD><TD>        return &#34;Usage: setProductStateByClass sessionName classKey state&#34;;</TD></TR><TR><TD CLASS="l">2296</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2297</TD><TD>    if (isClassKey(strClassKey)) {</TD></TR><TR><TD CLASS="l">2298</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2299</TD><TD>            int classKey = Integer.parseInt(strClassKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2300</TD><TD>            short state = Short.parseShort(strState);</TD></TR><TR CLASS="z"><TD CLASS="l">2301</TD><TD>            ErrorCodeResultStruct error = getMyInterceptor().setProductStateByClassV2(sessionName, classKey, state);</TD></TR><TR CLASS="z"><TD CLASS="l">2302</TD><TD>            if (error.classKey &gt; 0)</TD></TR><TR CLASS="z"><TD CLASS="l">2303</TD><TD>                return  &#34;\n &#34; + &#34;Quitting.. Product state change Failed for classKey:&#34;+ classKey  + &#34;\n&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2304</TD><TD>                       + &#34;\t&#34; + &#34;errorMsg:&#34; + error.exceptionDescription + &#34; errorCode:&#34; + error.errorCode + &#34; failed product:&#34; + error.failedProducts[0].key;</TD></TR><TR><TD CLASS="l">2305</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2306</TD><TD>            return &#34;All products for class &#34; + classKey + &#34; set to &#34; + state;</TD></TR><TR><TD CLASS="l">2307</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2308</TD><TD>        catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2309</TD><TD>            Log.information(&#34;Exception while setting product states for class (&#34; + strClassKey + &#34;): &#34; + e);</TD></TR><TR CLASS="z"><TD CLASS="l">2310</TD><TD>            return &#34;Exception while setting product states for class: &#34; + e;</TD></TR><TR><TD CLASS="l">2311</TD><TD>        }</TD></TR><TR><TD CLASS="l">2312</TD><TD>    }</TD></TR><TR><TD CLASS="l">2313</TD><TD>    else {</TD></TR><TR><TD CLASS="l">2314</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2315</TD><TD>            short state = Short.parseShort(strState);</TD></TR><TR CLASS="z"><TD CLASS="l">2316</TD><TD>            return setProductStateBySymbol(strClassKey, state, false /* don't do change immediately */);</TD></TR><TR><TD CLASS="l">2317</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2318</TD><TD>        catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2319</TD><TD>            Log.information(&#34;Exception while setting product states for class symbol (&#34; + strClassKey + &#34;): &#34; + e);</TD></TR><TR CLASS="z"><TD CLASS="l">2320</TD><TD>            return &#34;Exception while setting product states for class: &#34; + e;</TD></TR><TR><TD CLASS="l">2321</TD><TD>        }</TD></TR><TR><TD CLASS="l">2322</TD><TD>    }</TD></TR><TR><TD CLASS="l">2323</TD><TD>}</TD></TR><TR><TD CLASS="l">2324</TD><TD>/**</TD></TR><TR><TD CLASS="l">2325</TD><TD> * Sets the product state for the product to the specified state.</TD></TR><TR><TD CLASS="l">2326</TD><TD> *</TD></TR><TR><TD CLASS="l">2327</TD><TD> * @param productState  state to set the product to.  This should be one of</TD></TR><TR><TD CLASS="l">2328</TD><TD> *                      the states defined in the &lt;code&gt;ProductStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l"><A NAME="7b">2329</A></TD><TD> * @exception           TransactionFailedException when the state change is not valid.</TD></TR><TR><TD CLASS="l">2330</TD><TD> * @exception           DataValidationException when a product cannot be found.</TD></TR><TR><TD CLASS="l">2331</TD><TD> */</TD></TR><TR><TD CLASS="l">2332</TD><TD>public void setProductStateByProduct(String sessionName, int productKey, short productState) throws TransactionFailedException, DataValidationException{</TD></TR><TR CLASS="z"><TD CLASS="l">2333</TD><TD>    boolean success = false;</TD></TR><TR CLASS="z"><TD CLASS="l">2334</TD><TD>    Transaction.startTransaction();</TD></TR><TR><TD CLASS="l">2335</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">2336</TD><TD>        TradingProduct tradingProduct = cachedTradingProductHome.findByKey(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2337</TD><TD>        setProductState(tradingProduct, productState, false);</TD></TR><TR CLASS="z"><TD CLASS="l">2338</TD><TD>        success = Transaction.commit();</TD></TR><TR><TD CLASS="l">2339</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2340</TD><TD>    catch (NotFoundException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2341</TD><TD>        throw new DataValidationException(e.details);</TD></TR><TR><TD CLASS="l">2342</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2343</TD><TD>    finally {</TD></TR><TR CLASS="z"><TD CLASS="l">2344</TD><TD>        if (!success) {</TD></TR><TR CLASS="z"><TD CLASS="l">2345</TD><TD>            Transaction.rollback();</TD></TR><TR><TD CLASS="l">2346</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2347</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2348</TD><TD>}</TD></TR><TR><TD CLASS="l">2349</TD><TD>/**</TD></TR><TR><TD CLASS="l">2350</TD><TD> * Sets the product state for the product to the specified state.</TD></TR><TR><TD CLASS="l">2351</TD><TD> *</TD></TR><TR><TD CLASS="l">2352</TD><TD> * @param tradingProduct product having state changed</TD></TR><TR><TD CLASS="l">2353</TD><TD> * @param productState   state to set the product to.  This should be one of</TD></TR><TR><TD CLASS="l">2354</TD><TD> *                       the states defined in the &lt;code&gt;ProductStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l">2355</TD><TD> * @param immediate      flag indicating whether or not the state change shoud be done</TD></TR><TR><TD CLASS="l"><A NAME="75">2356</A></TD><TD> *                       immediately.  Normally, the state change is completed via a queue.</TD></TR><TR><TD CLASS="l">2357</TD><TD> * @exception            TransactionFailedException when a state change cannot be completed.</TD></TR><TR><TD CLASS="l">2358</TD><TD> */</TD></TR><TR><TD CLASS="l">2359</TD><TD>public void setProductState(TradingProduct tradingProduct, short productState, boolean immediate) throws TransactionFailedException {</TD></TR><TR CLASS="z"><TD CLASS="l">2360</TD><TD>    ProductStateChangeCommand command = doProductStateChange(tradingProduct, productState, immediate);</TD></TR><TR CLASS="z"><TD CLASS="l">2361</TD><TD>    if (command != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2362</TD><TD>        handleCommand(tradingProduct, command);</TD></TR><TR><TD CLASS="l">2363</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2364</TD><TD>}</TD></TR><TR><TD CLASS="l">2365</TD><TD> </TD></TR><TR><TD CLASS="l">2366</TD><TD>/**</TD></TR><TR><TD CLASS="l">2367</TD><TD> * Sets the product state for the product to the specified state only after</TD></TR><TR><TD CLASS="l">2368</TD><TD> * current transaction commited successfully. If there is no transaction started,</TD></TR><TR><TD CLASS="l">2369</TD><TD> * the command is added to command processor queue immediately.</TD></TR><TR><TD CLASS="l">2370</TD><TD> *</TD></TR><TR><TD CLASS="l">2371</TD><TD> * @param tradingProduct product having state changed</TD></TR><TR><TD CLASS="l">2372</TD><TD> * @param productState  state to set the product to.This should be one of</TD></TR><TR><TD CLASS="l">2373</TD><TD> *                      the states defined in the &lt;code&gt;ProductStates&lt;/code&gt; interface.</TD></TR><TR><TD CLASS="l">2374</TD><TD> * @param immediate     flag indicating whether or not the state change shoud be done</TD></TR><TR><TD CLASS="l"><A NAME="7d">2375</A></TD><TD> *                      immediately.  Normally, the state change is completed via a queue.</TD></TR><TR><TD CLASS="l">2376</TD><TD> * @exception           TransactionFailedException when a state change cannot be completed.</TD></TR><TR><TD CLASS="l">2377</TD><TD> */</TD></TR><TR><TD CLASS="l">2378</TD><TD>public void setProductStateWhenCurrentTransactionSuccessful(TradingProduct tradingProduct, short productState, boolean immediate) throws TransactionFailedException {</TD></TR><TR CLASS="z"><TD CLASS="l">2379</TD><TD>        ProductStateChangeCommand command = doProductStateChange(tradingProduct, productState, immediate);</TD></TR><TR CLASS="z"><TD CLASS="l">2380</TD><TD>        if (command != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2381</TD><TD>                TradingClassCommandTransactionListener transactionListener =</TD></TR><TR CLASS="z"><TD CLASS="l">2382</TD><TD>                        new TradingClassCommandTransactionListener(tradingProduct, command);</TD></TR><TR CLASS="z"><TD CLASS="l">2383</TD><TD>                transactionListener.registerWithTransaction();</TD></TR><TR><TD CLASS="l">2384</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2385</TD><TD>}</TD></TR><TR><TD CLASS="l">2386</TD><TD> </TD></TR><TR><TD CLASS="l">2387</TD><TD>/**</TD></TR><TR><TD CLASS="l">2388</TD><TD> * Performs admin request to set state on a product.</TD></TR><TR><TD CLASS="l">2389</TD><TD> *</TD></TR><TR><TD CLASS="l">2390</TD><TD> * @param strProductKey the product key of the product on which to set the state</TD></TR><TR><TD CLASS="l">2391</TD><TD> * @param strState  the state to sell the products</TD></TR><TR><TD CLASS="l">2392</TD><TD> * @return description of result</TD></TR><TR><TD CLASS="l"><A NAME="27">2393</A></TD><TD> */</TD></TR><TR><TD CLASS="l">2394</TD><TD>@FFCommand(description=&#34;Set the state for a product&#34;,</TD></TR><TR><TD CLASS="l">2395</TD><TD>        paramDescriptions = {&#34;Session name&#34;, &#34;Product key&#34;, &#34;State to set the product to&#34;})</TD></TR><TR><TD CLASS="l">2396</TD><TD>public String adminSetProductStateByProduct(String sessionName, String strProductKey, String strState ) {</TD></TR><TR CLASS="z"><TD CLASS="l">2397</TD><TD>    if (sessionName == null || strProductKey == null || strState == null ){</TD></TR><TR CLASS="z"><TD CLASS="l">2398</TD><TD>        Log.information(&#34;Could not set product states; no state specified&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2399</TD><TD>        return &#34;Usage: setProductStateByProduct sessionName productKey state&#34;;</TD></TR><TR><TD CLASS="l">2400</TD><TD>    }</TD></TR><TR><TD CLASS="l">2401</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">2402</TD><TD>        int productKey = Integer.parseInt(strProductKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2403</TD><TD>        short state = Short.parseShort(strState);</TD></TR><TR CLASS="z"><TD CLASS="l">2404</TD><TD>        getMyInterceptor().setProductStateByProduct(sessionName, productKey, state);</TD></TR><TR CLASS="z"><TD CLASS="l">2405</TD><TD>        return &#34;State for product &#34; + productKey + &#34; set to &#34; + state;</TD></TR><TR><TD CLASS="l">2406</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2407</TD><TD>    catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2408</TD><TD>        Log.information(&#34;Exception while setting all product states &#34; + e );</TD></TR><TR CLASS="z"><TD CLASS="l">2409</TD><TD>        return &#34;Exception while setting all product states &#34; + e;</TD></TR><TR><TD CLASS="l">2410</TD><TD>    }</TD></TR><TR><TD CLASS="l">2411</TD><TD>}</TD></TR><TR><TD CLASS="l">2412</TD><TD>/**</TD></TR><TR><TD CLASS="l">2413</TD><TD> * Sets product state for all classes with a given symbol.</TD></TR><TR><TD CLASS="l">2414</TD><TD> *</TD></TR><TR><TD CLASS="l">2415</TD><TD> * @param classSymbol symbol for classes to be changed</TD></TR><TR><TD CLASS="l"><A NAME="7c">2416</A></TD><TD> * @param state new state code</TD></TR><TR><TD CLASS="l">2417</TD><TD> * @param immediate if true, change will be done immediately</TD></TR><TR><TD CLASS="l">2418</TD><TD> */</TD></TR><TR><TD CLASS="l">2419</TD><TD>protected String setProductStateBySymbol(String classSymbol, short state, boolean immediate) throws TransactionFailedException {</TD></TR><TR CLASS="z"><TD CLASS="l">2420</TD><TD>    TradingClass[] classes = cachedTradingClassHome.findBySymbol(classSymbol);</TD></TR><TR CLASS="z"><TD CLASS="l">2421</TD><TD>    String result = &#34;Request processed for following class keys: &#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2422</TD><TD>    String failedmsg = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2423</TD><TD>    for (int i = 0; i &lt; classes.length; i++){</TD></TR><TR CLASS="z"><TD CLASS="l">2424</TD><TD>        result = result + classes[i].getProductClassKey() + &#34; &#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2425</TD><TD>        if (classes[i].inTradingSession()){</TD></TR><TR CLASS="z"><TD CLASS="l">2426</TD><TD>            ErrorCodeResultStruct error = setProductStateByClass(classes[i], state, immediate);</TD></TR><TR CLASS="z"><TD CLASS="l">2427</TD><TD>            if (error.classKey &gt; 0)</TD></TR><TR CLASS="z"><TD CLASS="l">2428</TD><TD>                failedmsg = failedmsg + &#34;\n &#34; + &#34;Quitting.. Product state change Failed for class(key):&#34; + classSymbol + &#34;(&#34; + classes[i].getProductClassKey() + &#34;)&#34; + &#34;\n&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2429</TD><TD>                       + &#34;\t&#34; + &#34;errorMsg:&#34; + error.exceptionDescription + &#34; errorCode:&#34; + error.errorCode + &#34; failed product:&#34; + error.failedProducts[0].key;</TD></TR><TR><TD CLASS="l">2430</TD><TD>        }</TD></TR><TR><TD CLASS="l">2431</TD><TD>         else</TD></TR><TR CLASS="z"><TD CLASS="l">2432</TD><TD>             result = result + &#34;(skipped, not in session) &#34;;</TD></TR><TR><TD CLASS="l">2433</TD><TD>     }</TD></TR><TR CLASS="z"><TD CLASS="l">2434</TD><TD>    if(!failedmsg.equals(&#34;&#34;))</TD></TR><TR CLASS="z"><TD CLASS="l">2435</TD><TD>        return failedmsg;</TD></TR><TR><TD CLASS="l">2436</TD><TD>    else</TD></TR><TR CLASS="z"><TD CLASS="l">2437</TD><TD>        return result;</TD></TR><TR><TD CLASS="l">2438</TD><TD>}</TD></TR><TR><TD CLASS="l">2439</TD><TD>/**</TD></TR><TR><TD CLASS="l">2440</TD><TD> *   Receiver of trading session events:  this method will be invoked by the trading session service</TD></TR><TR><TD CLASS="l">2441</TD><TD> *   when an event that this listener is registered for occurs.</TD></TR><TR><TD CLASS="l">2442</TD><TD> *</TD></TR><TR><TD CLASS="l">2443</TD><TD> *   @param eventType - the TradingSessionEventType that caused this method invocation.</TD></TR><TR><TD CLASS="l">2444</TD><TD> *   @param session - details of the session for whom the event is being called.</TD></TR><TR><TD CLASS="l">2445</TD><TD> *   @param context - any extra contextual information (probably null).</TD></TR><TR><TD CLASS="l">2446</TD><TD> *   @return boolean - some events (eg, PREPARE_END_OF_SESSION) require feedback from the listeners</TD></TR><TR><TD CLASS="l"><A NAME="84">2447</A></TD><TD> *      to determine which execution path should be followed.  This value is used in these cases to</TD></TR><TR><TD CLASS="l">2448</TD><TD> *      supply that feedback.  It should be treated as an &#34;everything looks good to me&#34; qualifier.</TD></TR><TR><TD CLASS="l">2449</TD><TD> */</TD></TR><TR><TD CLASS="l">2450</TD><TD>public boolean tradingSessionEvent(TradingSessionEventType eventType, TradingSessionStruct session, Object context){</TD></TR><TR CLASS="z"><TD CLASS="l">2451</TD><TD>    boolean resultStatus = true;</TD></TR><TR><TD CLASS="l">2452</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2453</TD><TD>    if (eventType == TradingSessionEventType.PREPARE_START_OF_SESSION) {</TD></TR><TR CLASS="z"><TD CLASS="l">2454</TD><TD>        changeSessionStatus(session.sessionName, ProductStates.CLOSED);</TD></TR><TR><TD CLASS="l">2455</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2456</TD><TD>    else if (eventType == TradingSessionEventType.START_SESSION) {</TD></TR><TR><TD CLASS="l">2457</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2458</TD><TD>            setAllProductStates(session.sessionName, ProductStates.CLOSED);</TD></TR><TR><TD CLASS="l">2459</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2460</TD><TD>        catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2461</TD><TD>            Log.exception(this, &#34;Unable to set all products to CLOSED for session: &#34; + session.sessionName, e);</TD></TR><TR CLASS="z"><TD CLASS="l">2462</TD><TD>            resultStatus = false;</TD></TR><TR><TD CLASS="l">2463</TD><TD>        }</TD></TR><TR><TD CLASS="l">2464</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2465</TD><TD>    else if (eventType == TradingSessionEventType.PREPARE_END_OF_SESSION) {</TD></TR><TR><TD CLASS="l">2466</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2467</TD><TD>            setAllProductStates(session.sessionName, ProductStates.NO_SESSION);</TD></TR><TR><TD CLASS="l">2468</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2469</TD><TD>        catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2470</TD><TD>            Log.exception(this, &#34;Unable to set all products to NO_SESSION for session: &#34; + session.sessionName, e);</TD></TR><TR CLASS="z"><TD CLASS="l">2471</TD><TD>            resultStatus = false;</TD></TR><TR><TD CLASS="l">2472</TD><TD>        }</TD></TR><TR><TD CLASS="l">2473</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2474</TD><TD>    else if (eventType == TradingSessionEventType.COMPLETED_END_OF_SESSION) {</TD></TR><TR CLASS="z"><TD CLASS="l">2475</TD><TD>        changeSessionStatus(session.sessionName, ProductStates.NO_SESSION);</TD></TR><TR><TD CLASS="l">2476</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">2477</TD><TD>    return resultStatus;</TD></TR><TR><TD CLASS="l">2478</TD><TD>}</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="3c">2479</A></TD><TD>static ArrayList&lt;String&gt; routeNames= new ArrayList&lt;String&gt;();</TD></TR><TR><TD CLASS="l">2480</TD><TD> </TD></TR><TR><TD CLASS="l">2481</TD><TD>    protected TradingSessionElementClassesDetailStruct[] getElementClassesForSession(String sessionName)</TD></TR><TR><TD CLASS="l">2482</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2483</TD><TD>        TradingSessionElementClassesDetailStruct[] classes = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2484</TD><TD>        String myRouteName = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2485</TD><TD>        synchronized (routeNames)</TD></TR><TR><TD CLASS="l">2486</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2487</TD><TD>            if (routeNames.size() == 0)</TD></TR><TR><TD CLASS="l">2488</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2489</TD><TD>                myRouteName = RouteNameHelper.getRouteName();</TD></TR><TR CLASS="z"><TD CLASS="l">2490</TD><TD>                routeNames.add(myRouteName);</TD></TR><TR CLASS="z"><TD CLASS="l">2491</TD><TD>                routeNames.addAll(ConfigurationGroupHelper.getBuddyTradeServerList());</TD></TR><TR><TD CLASS="l">2492</TD><TD>            }</TD></TR><TR><TD CLASS="l">2493</TD><TD>        }</TD></TR><TR><TD CLASS="l">2494</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2495</TD><TD>        ArrayList&lt;TradingSessionElementClassesDetailStruct&gt; array = new ArrayList&lt;TradingSessionElementClassesDetailStruct&gt;();</TD></TR><TR><TD CLASS="l">2496</TD><TD>        </TD></TR><TR><TD CLASS="l">2497</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2498</TD><TD>            for ( int k=0;k&lt;routeNames.size();k++){</TD></TR><TR CLASS="z"><TD CLASS="l">2499</TD><TD>                Log.information(this,&#34;About to get classes for session &#34; + sessionName + &#34; and group &#34; + routeNames.get(k) );</TD></TR><TR CLASS="z"><TD CLASS="l">2500</TD><TD>                classes = theTradingSessionService.getElementClassesForSessionByGroup(sessionName, routeNames.get(k));</TD></TR><TR><TD CLASS="l">2501</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">2502</TD><TD>                for (int i=0; i&lt;classes.length; i++)</TD></TR><TR><TD CLASS="l">2503</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2504</TD><TD>                    array.add(classes[i]);</TD></TR><TR><TD CLASS="l">2505</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2506</TD><TD>                    if (null != classes[i].sessionClassesDetail &amp;&amp; null != classes[i].tradingSessionElementInfo)</TD></TR><TR><TD CLASS="l">2507</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2508</TD><TD>                        Log.information(this,&#34;Received &#34; + classes[i].sessionClassesDetail.length + &#34; classes for element &#34; + classes[i].tradingSessionElementInfo.elementName + &#34; and group &#34; + myRouteName);</TD></TR><TR><TD CLASS="l">2509</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2510</TD><TD>                    else</TD></TR><TR><TD CLASS="l">2511</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2512</TD><TD>                        Log.alarm(this, &#34;Recieved NULL tradingSessionElementClassDetailStruct &#34; + classes[i]);                    </TD></TR><TR><TD CLASS="l">2513</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2514</TD><TD>                }</TD></TR><TR><TD CLASS="l">2515</TD><TD>            }</TD></TR><TR><TD CLASS="l">2516</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2517</TD><TD>        catch (Exception e){</TD></TR><TR CLASS="z"><TD CLASS="l">2518</TD><TD>            Log.alarm(this, &#34;Cannot get classes for session named &#34; + sessionName);</TD></TR><TR><TD CLASS="l">2519</TD><TD>        }</TD></TR><TR><TD CLASS="l">2520</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">2521</TD><TD>        classes = new TradingSessionElementClassesDetailStruct[array.size()];</TD></TR><TR><TD CLASS="l">2522</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">2523</TD><TD>        array.toArray(classes);</TD></TR><TR><TD CLASS="l">2524</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">2525</TD><TD>        return classes;</TD></TR><TR><TD CLASS="l">2526</TD><TD>    }</TD></TR><TR><TD CLASS="l">2527</TD><TD> </TD></TR><TR><TD CLASS="l">2528</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2529</TD><TD>     * This method returns (and lazily initializes) the Home for TradeSessionAdminService.</TD></TR><TR><TD CLASS="l">2530</TD><TD>     *</TD></TR><TR><TD CLASS="l">2531</TD><TD>     * @return TradingSessionAdminService</TD></TR><TR><TD CLASS="l"><A NAME="95">2532</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">2533</TD><TD>    @FFServiceDependency (homeName=TradingSessionServiceHome.HOME_NAME)</TD></TR><TR><TD CLASS="l">2534</TD><TD>    public final void setTradingSessionService(TradingSessionService p_tradingSessionService)</TD></TR><TR><TD CLASS="l">2535</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">2536</TD><TD>        theTradingSessionService = p_tradingSessionService;</TD></TR><TR CLASS="c"><TD CLASS="l">2537</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="45">2538</A></TD><TD> </TD></TR><TR><TD CLASS="l">2539</TD><TD>    private synchronized PropertyConsumerHome getPropertyConsumerHome()</TD></TR><TR><TD CLASS="l">2540</TD><TD>        throws NotFoundException</TD></TR><TR><TD CLASS="l">2541</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2542</TD><TD>    if (propertyConsumerHome == null){</TD></TR><TR><TD CLASS="l">2543</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2544</TD><TD>                HomeFactory theHomeFactory = HomeFactory.getInstance();</TD></TR><TR CLASS="z"><TD CLASS="l">2545</TD><TD>            propertyConsumerHome = (PropertyConsumerHome) theHomeFactory.findHome(PropertyConsumerHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">2546</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2547</TD><TD>            catch (com.cboe.infrastructureServices.foundationFramework.exceptionHandling.CBOELoggableException e)</TD></TR><TR><TD CLASS="l">2548</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2549</TD><TD>            Log.alarm(this, &#34;Couldn't get propertyConsumerHome&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2550</TD><TD>                Log.exception(this, e);</TD></TR><TR CLASS="z"><TD CLASS="l">2551</TD><TD>            throw ExceptionBuilder.notFoundException(&#34;unable to initialize propertyConsumerHome&#34;, 0);</TD></TR><TR><TD CLASS="l">2552</TD><TD>            }</TD></TR><TR><TD CLASS="l">2553</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2554</TD><TD>    return propertyConsumerHome;</TD></TR><TR><TD CLASS="l">2555</TD><TD>    }</TD></TR><TR><TD CLASS="l">2556</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="68">2557</A></TD><TD> </TD></TR><TR><TD CLASS="l">2558</TD><TD>    public void resetTimer() throws SystemException, CommunicationException, AuthorizationException, DataValidationException, NotFoundException</TD></TR><TR><TD CLASS="l">2559</TD><TD>    {</TD></TR><TR><TD CLASS="l">2560</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2561</TD><TD>            Iterator&lt;String&gt; iter = tradingSessionElementMap.keySet().iterator();</TD></TR><TR><TD CLASS="l">2562</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2563</TD><TD>            while(iter.hasNext())</TD></TR><TR><TD CLASS="l">2564</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2565</TD><TD>                    String session = iter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">2566</TD><TD>                    if(TradingSessionNameHelper.isConfiguredSession(session))</TD></TR><TR><TD CLASS="l">2567</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2568</TD><TD>                            createProductStateTimer(session);</TD></TR><TR><TD CLASS="l">2569</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2570</TD><TD>                        else</TD></TR><TR><TD CLASS="l">2571</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2572</TD><TD>                            Log.information(&#34;Trading property:&#34;+TradingPropertyTypeImpl.ROLLOUT_FLAG_BY_BC.getName() +&#34; is set to false, hence product state timer is set on GLOBAL for:&#34;+session);</TD></TR><TR><TD CLASS="l"><A NAME="17">2573</A></TD><TD>                        }</TD></TR><TR><TD CLASS="l">2574</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2575</TD><TD>    }</TD></TR><TR><TD CLASS="l">2576</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2577</TD><TD>    private boolean isProductStateTimerOnBC(String sessionName)</TD></TR><TR><TD CLASS="l"><A NAME="52">2578</A></TD><TD>    {</TD></TR><TR><TD CLASS="l">2579</TD><TD> </TD></TR><TR><TD CLASS="l">2580</TD><TD>                    RolloutFlagByBCGroup timerOnBC;</TD></TR><TR><TD CLASS="l">2581</TD><TD>                    try {</TD></TR><TR CLASS="z"><TD CLASS="l">2582</TD><TD>                            timerOnBC = (RolloutFlagByBCGroup)TradingPropertyFactoryHome.find().getTradingPropertyGroup(sessionName, 0, TradingPropertyTypeImpl.ROLLOUT_FLAG_BY_BC.getName(), true);</TD></TR><TR CLASS="z"><TD CLASS="l">2583</TD><TD>                            if(timerOnBC !=null)</TD></TR><TR><TD CLASS="l">2584</TD><TD>                            {</TD></TR><TR CLASS="z"><TD CLASS="l">2585</TD><TD>                                    RolloutFlagByBC[] props=timerOnBC.getRolloutBCTradingProperties();</TD></TR><TR CLASS="z"><TD CLASS="l">2586</TD><TD>                                    for (RolloutFlagByBC bcProp:props)</TD></TR><TR><TD CLASS="l">2587</TD><TD>                                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2588</TD><TD>                                            Log.information(&#34;ROLLOUT FLAG BY BC &#34;+bcProp.getBC()+&#34;:&#34;+bcProp.isRollout());</TD></TR><TR CLASS="z"><TD CLASS="l">2589</TD><TD>                                            if (bcProp.isAllBC() &amp;&amp; bcProp.isRollout())</TD></TR><TR><TD CLASS="l">2590</TD><TD>                                            {</TD></TR><TR CLASS="z"><TD CLASS="l">2591</TD><TD>                                                    return true;</TD></TR><TR><TD CLASS="l">2592</TD><TD>                                            }</TD></TR><TR CLASS="z"><TD CLASS="l">2593</TD><TD>                                            else if (bcProp.isRollout())</TD></TR><TR><TD CLASS="l">2594</TD><TD>                                            {</TD></TR><TR CLASS="z"><TD CLASS="l">2595</TD><TD>                                                    if (clusterID.equals(bcProp.getGroupName()))</TD></TR><TR><TD CLASS="l">2596</TD><TD>                                                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2597</TD><TD>                                                            return true;</TD></TR><TR><TD CLASS="l">2598</TD><TD>                                                    }</TD></TR><TR><TD CLASS="l">2599</TD><TD>                                            }</TD></TR><TR><TD CLASS="l">2600</TD><TD>                                    }</TD></TR><TR CLASS="z"><TD CLASS="l">2601</TD><TD>                                    return false;</TD></TR><TR><TD CLASS="l">2602</TD><TD>                            }</TD></TR><TR><TD CLASS="l">2603</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">2604</TD><TD>                    catch (Exception e)</TD></TR><TR><TD CLASS="l">2605</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2606</TD><TD>                            Log.exception(&#34;Unable to get trading property:&#34;+TradingPropertyTypeImpl.ROLLOUT_FLAG_BY_BC.getName() +&#34; for session:&#34;+sessionName, e);</TD></TR><TR CLASS="z"><TD CLASS="l">2607</TD><TD>                            return false;</TD></TR><TR><TD CLASS="l">2608</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">2609</TD><TD>            return false;</TD></TR><TR><TD CLASS="l"><A NAME="57">2610</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2611</TD><TD> </TD></TR><TR><TD CLASS="l">2612</TD><TD>    public void populateTradingSessionElement()</TD></TR><TR><TD CLASS="l">2613</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2614</TD><TD>            Log.information(&#34;Query Trading session begin&#34;);</TD></TR><TR><TD CLASS="l">2615</TD><TD>            TradingSessionService tss;</TD></TR><TR><TD CLASS="l">2616</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">2617</TD><TD>                        tss = theTradingSessionService;</TD></TR><TR CLASS="z"><TD CLASS="l">2618</TD><TD>                    TradingSessionStruct[] tradingSessions = tss.getTradingSessions();</TD></TR><TR><TD CLASS="l">2619</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2620</TD><TD>                    for (TradingSessionStruct session:tradingSessions)</TD></TR><TR><TD CLASS="l">2621</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2622</TD><TD>                            populateTradingSessionElement(session.sessionName);</TD></TR><TR><TD CLASS="l">2623</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">2624</TD><TD>                } catch (CommunicationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2625</TD><TD>                        Log.exception(e);</TD></TR><TR CLASS="z"><TD CLASS="l">2626</TD><TD>                } catch (SystemException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2627</TD><TD>                        Log.exception(e);</TD></TR><TR CLASS="z"><TD CLASS="l">2628</TD><TD>                } catch (AuthorizationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2629</TD><TD>                        Log.exception(e);</TD></TR><TR><TD CLASS="l">2630</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2631</TD><TD>            Log.information(&#34;Query Trading session finished&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2632</TD><TD>    }</TD></TR><TR><TD CLASS="l">2633</TD><TD> </TD></TR><TR><TD CLASS="l">2634</TD><TD>    class ProdStateTimerPropertyConusmer  implements EventChannelListener</TD></TR><TR><TD CLASS="l">2635</TD><TD>    {</TD></TR><TR><TD CLASS="l"><A NAME="0">2636</A></TD><TD>            String sessionName;</TD></TR><TR CLASS="z"><TD CLASS="l">2637</TD><TD>            ProdStateTimerPropertyConusmer(String sessionName)</TD></TR><TR><TD CLASS="l"><A NAME="2">2638</A></TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2639</TD><TD>                    this.sessionName = sessionName;</TD></TR><TR CLASS="z"><TD CLASS="l">2640</TD><TD>            }</TD></TR><TR><TD CLASS="l">2641</TD><TD>                public void channelUpdate(ChannelEvent event) {</TD></TR><TR CLASS="z"><TD CLASS="l">2642</TD><TD>                        ChannelKey channelKey = (ChannelKey) event.getChannel();</TD></TR><TR CLASS="z"><TD CLASS="l">2643</TD><TD>                        String tradingPropertyKey = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2644</TD><TD>                        if(channelKey.channelType == ChannelType.REMOVE_PROPERTY)</TD></TR><TR><TD CLASS="l">2645</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2646</TD><TD>                                tradingPropertyKey = (String) event.getEventData();</TD></TR><TR CLASS="z"><TD CLASS="l">2647</TD><TD>                                Log.information(&#34;Property Listener acceptPropertyRemove:&#34;+tradingPropertyKey);</TD></TR><TR><TD CLASS="l">2648</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2649</TD><TD>                        else if(channelKey.channelType == ChannelType.UPDATE_PROPERTY)</TD></TR><TR><TD CLASS="l">2650</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2651</TD><TD>                                PropertyGroupStruct struct = (PropertyGroupStruct) event.getEventData();</TD></TR><TR CLASS="z"><TD CLASS="l">2652</TD><TD>                                tradingPropertyKey = struct.propertyKey;</TD></TR><TR CLASS="z"><TD CLASS="l">2653</TD><TD>                                Log.information(&#34;Property Listener acceptPropertyUpdate:&#34;+tradingPropertyKey);</TD></TR><TR><TD CLASS="l">2654</TD><TD> </TD></TR><TR><TD CLASS="l">2655</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2656</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">2657</TD><TD>                        TradingSessionElementStruct[] tradingSessionElements = tradingSessionElementMap.get(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2658</TD><TD>            boolean startProductStateTimer = isProductStateTimerOnBC(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2659</TD><TD>            productStateTimerBySession.put(sessionName,startProductStateTimer );</TD></TR><TR><TD CLASS="l">2660</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2661</TD><TD>                        if (tradingSessionElements == null)</TD></TR><TR><TD CLASS="l">2662</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2663</TD><TD>                                Log.alarm(&#34;ProductStateServiceLocalImpla:No trading session element found&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2664</TD><TD>                                return;</TD></TR><TR><TD CLASS="l">2665</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2666</TD><TD>                    if (!FoundationFramework.getInstance().isMaster())</TD></TR><TR><TD CLASS="l">2667</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2668</TD><TD>                            Log.information(TradingPropertyTypeImpl.ROLLOUT_FLAG_BY_BC.getName()+&#34;updated, BC is not Master, will not reset the timer&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2669</TD><TD>                            return;</TD></TR><TR><TD CLASS="l">2670</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2671</TD><TD> </TD></TR><TR><TD CLASS="l">2672</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2673</TD><TD>                        for(TradingSessionElementStruct sessionElement:tradingSessionElements)</TD></TR><TR><TD CLASS="l">2674</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2675</TD><TD>                                resetTimer(sessionElement);</TD></TR><TR><TD CLASS="l">2676</TD><TD> </TD></TR><TR><TD CLASS="l">2677</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2678</TD><TD>                }</TD></TR><TR><TD CLASS="l"><A NAME="36">2679</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2680</TD><TD> </TD></TR><TR><TD CLASS="l">2681</TD><TD>    private void createTradingPropertyConsumer(String sessionName)</TD></TR><TR><TD CLASS="l">2682</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2683</TD><TD>        if (propertyUpdateListeners.get(sessionName) !=null)</TD></TR><TR><TD CLASS="l">2684</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2685</TD><TD>                return;</TD></TR><TR><TD CLASS="l">2686</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2687</TD><TD>        EventChannelListener propertyUpdateListener = new ProdStateTimerPropertyConusmer(sessionName);</TD></TR><TR><TD CLASS="l">2688</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2689</TD><TD>                        String propertyName = TradingPropertyTypeImpl.ROLLOUT_FLAG_BY_BC.getName();</TD></TR><TR CLASS="z"><TD CLASS="l">2690</TD><TD>                String propertyCategory = TradingPropertyTypeImpl.ROLLOUT_FLAG_BY_BC.getPropertyCategory();</TD></TR><TR CLASS="z"><TD CLASS="l">2691</TD><TD>            String compoundKey = TradingPropertyFactoryHome.find().buildTradingPropertyKey( sessionName, ProductClass.DEFAULT_CLASS_KEY,</TD></TR><TR CLASS="z"><TD CLASS="l">2692</TD><TD>                            propertyName );</TD></TR><TR CLASS="z"><TD CLASS="l">2693</TD><TD>            PropertyServiceFacadeHome.find().subscribe( propertyCategory, compoundKey, propertyUpdateListener );</TD></TR><TR CLASS="z"><TD CLASS="l">2694</TD><TD>                    propertyUpdateListeners.put(sessionName, propertyUpdateListener);</TD></TR><TR CLASS="z"><TD CLASS="l">2695</TD><TD>                Log.information(this,&#34;Listening to property update:&#34;+compoundKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2696</TD><TD>            } catch (SystemException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2697</TD><TD>                    Log.exception(this,e);</TD></TR><TR CLASS="z"><TD CLASS="l">2698</TD><TD>            } catch (CommunicationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2699</TD><TD>                    Log.exception(this,e);</TD></TR><TR CLASS="z"><TD CLASS="l">2700</TD><TD>            } catch (AuthorizationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2701</TD><TD>                    Log.exception(this,e);</TD></TR><TR CLASS="z"><TD CLASS="l">2702</TD><TD>            } catch (DataValidationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2703</TD><TD>                    Log.exception(this,e);</TD></TR><TR><TD CLASS="l">2704</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2705</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="58">2706</A></TD><TD> </TD></TR><TR><TD CLASS="l">2707</TD><TD> </TD></TR><TR><TD CLASS="l">2708</TD><TD>    private void populateTradingSessionElement(String sessionName)</TD></TR><TR><TD CLASS="l">2709</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2710</TD><TD>            if(TradingSessionNameHelper.isConfiguredSession(sessionName))</TD></TR><TR><TD CLASS="l">2711</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2712</TD><TD>                    createTradingPropertyConsumer(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2713</TD><TD>                    TradingSessionElementStruct[] tse = tradingSessionElementMap.get(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2714</TD><TD>                    if (tse == null)</TD></TR><TR><TD CLASS="l">2715</TD><TD>                    {</TD></TR><TR><TD CLASS="l">2716</TD><TD>                            try {</TD></TR><TR><TD CLASS="l">2717</TD><TD>                                    </TD></TR><TR CLASS="z"><TD CLASS="l">2718</TD><TD>                        if (TradingSessionNameHelper.isUnderlyingSession(sessionName) == false) {</TD></TR><TR CLASS="z"><TD CLASS="l">2719</TD><TD>                        boolean startProductStateTimer = isProductStateTimerOnBC(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2720</TD><TD>                        productStateTimerBySession.put(sessionName,startProductStateTimer );</TD></TR><TR CLASS="z"><TD CLASS="l">2721</TD><TD>                        Log.information(this.getName()+&#34; Product state timer on BC for session: &#34; + sessionName+&#34;=&#34;+startProductStateTimer);</TD></TR><TR><TD CLASS="l">2722</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2723</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2724</TD><TD>                                    tse = theTradingSessionService.getCurrentElementsForSession(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2725</TD><TD>                                    tradingSessionElementMap.put(sessionName, tse);</TD></TR><TR CLASS="z"><TD CLASS="l">2726</TD><TD>                                    populateTradingClassSessionElementMap(tse);</TD></TR><TR CLASS="z"><TD CLASS="l">2727</TD><TD>                            } catch (SystemException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2728</TD><TD>                                    Log.exception(e);</TD></TR><TR CLASS="z"><TD CLASS="l">2729</TD><TD>                            } catch (CommunicationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2730</TD><TD>                                    Log.exception(e);</TD></TR><TR CLASS="z"><TD CLASS="l">2731</TD><TD>                            } catch (AuthorizationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2732</TD><TD>                                    Log.exception(e);</TD></TR><TR CLASS="z"><TD CLASS="l">2733</TD><TD>                            } catch (DataValidationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2734</TD><TD>                                    Log.exception(e);</TD></TR><TR><TD CLASS="l">2735</TD><TD>                            </TD></TR><TR><TD CLASS="l">2736</TD><TD>                            }</TD></TR><TR><TD CLASS="l">2737</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2738</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="35">2739</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2740</TD><TD> </TD></TR><TR><TD CLASS="l">2741</TD><TD>    private void createProductStateTimer(String sessionName) throws SystemException, CommunicationException, AuthorizationException, DataValidationException, NotFoundException</TD></TR><TR><TD CLASS="l">2742</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2743</TD><TD>            TradingSessionElementStruct[] tse = tradingSessionElementMap.get(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2744</TD><TD>            if (tse == null)</TD></TR><TR><TD CLASS="l">2745</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2746</TD><TD>                    tse = theTradingSessionService.getCurrentElementsForSession(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2747</TD><TD>                    tradingSessionElementMap.put(sessionName, tse);</TD></TR><TR><TD CLASS="l">2748</TD><TD>            }</TD></TR><TR><TD CLASS="l">2749</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2750</TD><TD>            for (TradingSessionElementStruct element:tse)</TD></TR><TR><TD CLASS="l">2751</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2752</TD><TD>                    resetTimer(element);</TD></TR><TR><TD CLASS="l">2753</TD><TD>            }</TD></TR><TR><TD CLASS="l">2754</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="85">2755</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2756</TD><TD> </TD></TR><TR><TD CLASS="l">2757</TD><TD>    public void updateTradingSessionElement(TradingSessionElementStruct sessionElement)</TD></TR><TR><TD CLASS="l">2758</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2759</TD><TD>            TradingSessionElementStruct[] tse = tradingSessionElementMap.get(sessionElement.sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2760</TD><TD>            if (tse !=null)</TD></TR><TR><TD CLASS="l">2761</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2762</TD><TD>                    for (int i=0;i&lt;tse.length;i++)</TD></TR><TR><TD CLASS="l">2763</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2764</TD><TD>                            if (tse[i].elementKey == sessionElement.elementKey)</TD></TR><TR><TD CLASS="l">2765</TD><TD>                            {</TD></TR><TR CLASS="z"><TD CLASS="l">2766</TD><TD>                                    tse[i] = sessionElement;</TD></TR><TR CLASS="z"><TD CLASS="l">2767</TD><TD>                                    break;</TD></TR><TR><TD CLASS="l">2768</TD><TD>                            }</TD></TR><TR><TD CLASS="l">2769</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2770</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="19">2771</A></TD><TD>            populateTradingClassSessionElementMap(tse);</TD></TR><TR CLASS="z"><TD CLASS="l">2772</TD><TD>            resetTimer(sessionElement);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="69">2773</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2774</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2775</TD><TD>    private void resetTimer(TradingSessionElementStruct sessionElement)</TD></TR><TR><TD CLASS="l">2776</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2777</TD><TD>            if (!FoundationFramework.getInstance().isMaster() &amp;&amp; !FFStatusQuery.getInstance().isGoingMaster())</TD></TR><TR><TD CLASS="l">2778</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2779</TD><TD>                    Log.information(&#34;resetTimer, BC is not Master and not started as Master, will not reset the timer&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2780</TD><TD>                    return;</TD></TR><TR><TD CLASS="l">2781</TD><TD>            }</TD></TR><TR><TD CLASS="l">2782</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2783</TD><TD>                ProductStateChangeTimer timer = tradingSessionTimerMap.remove(sessionElement.elementKey+&#34;&#34;+BusinessDayListener.PRODUCT_PRE_OPEN_TIMER_TYPE);</TD></TR><TR CLASS="z"><TD CLASS="l">2784</TD><TD>                if (timer != null)</TD></TR><TR><TD CLASS="l">2785</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2786</TD><TD>                        removeTimer(timer);</TD></TR><TR><TD CLASS="l">2787</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2788</TD><TD>                if (sessionElement.autoPreOpenProducts)</TD></TR><TR><TD CLASS="l">2789</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2790</TD><TD>                        DateTimeImpl dateTime = new DateTimeImpl(sessionElement.productPreOpenTime);</TD></TR><TR CLASS="z"><TD CLASS="l">2791</TD><TD>                        timer = new ProductStateChangeTimer(this,sessionElement,BusinessDayListener.PRODUCT_PRE_OPEN_TIMER_TYPE,dateTime,numberOfClassStateChangePerThread,maximumClassStateChangeThread);</TD></TR><TR CLASS="z"><TD CLASS="l">2792</TD><TD>                        long time = dateTime.getTimeInMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">2793</TD><TD>                        registerTimer(timer,BusinessDayListener.PRODUCT_PRE_OPEN_TIMER_TYPE,sessionElement,time);</TD></TR><TR><TD CLASS="l">2794</TD><TD>                }</TD></TR><TR><TD CLASS="l">2795</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2796</TD><TD>                timer = tradingSessionTimerMap.remove(sessionElement.elementKey+&#34;&#34;+BusinessDayListener.PRODUCT_OPEN_TIMER_TYPE);</TD></TR><TR CLASS="z"><TD CLASS="l">2797</TD><TD>                if (timer != null)</TD></TR><TR><TD CLASS="l">2798</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2799</TD><TD>                        removeTimer(timer);</TD></TR><TR><TD CLASS="l">2800</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2801</TD><TD>                if (sessionElement.autoOpenProducts)</TD></TR><TR><TD CLASS="l">2802</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2803</TD><TD>                        DateTimeImpl dateTime = new DateTimeImpl(sessionElement.productOpenTime);</TD></TR><TR CLASS="z"><TD CLASS="l">2804</TD><TD>                        long time = dateTime.getTimeInMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">2805</TD><TD>                        timer = new ProductStateChangeTimer(this,sessionElement,BusinessDayListener.PRODUCT_OPEN_TIMER_TYPE,dateTime,numberOfClassStateChangePerThread,maximumClassStateChangeThread);</TD></TR><TR CLASS="z"><TD CLASS="l">2806</TD><TD>                        registerTimer(timer,BusinessDayListener.PRODUCT_OPEN_TIMER_TYPE,sessionElement,time);</TD></TR><TR><TD CLASS="l">2807</TD><TD>                }</TD></TR><TR><TD CLASS="l">2808</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2809</TD><TD>                timer = tradingSessionTimerMap.remove(sessionElement.elementKey+&#34;&#34;+BusinessDayListener.PRODUCT_CLOSE_TIMER_TYPE);</TD></TR><TR CLASS="z"><TD CLASS="l">2810</TD><TD>                if (timer != null)</TD></TR><TR><TD CLASS="l">2811</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2812</TD><TD>                        removeTimer(timer);</TD></TR><TR><TD CLASS="l">2813</TD><TD>                }</TD></TR><TR><TD CLASS="l">2814</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2815</TD><TD>                if (sessionElement.autoCloseProducts)</TD></TR><TR><TD CLASS="l">2816</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2817</TD><TD>                        DateTimeImpl dateTime = new DateTimeImpl(sessionElement.productCloseTime);</TD></TR><TR CLASS="z"><TD CLASS="l">2818</TD><TD>                        long time = dateTime.getTimeInMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">2819</TD><TD>                        timer = new ProductStateChangeTimer(this,sessionElement,BusinessDayListener.PRODUCT_CLOSE_TIMER_TYPE,dateTime,numberOfClassStateChangePerThread,maximumClassStateChangeThread);</TD></TR><TR CLASS="z"><TD CLASS="l">2820</TD><TD>                        registerTimer(timer,BusinessDayListener.PRODUCT_CLOSE_TIMER_TYPE,sessionElement,time);</TD></TR><TR><TD CLASS="l">2821</TD><TD>                }</TD></TR><TR><TD CLASS="l">2822</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="66">2823</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2824</TD><TD> </TD></TR><TR><TD CLASS="l">2825</TD><TD>    private void removeTimer(ProductStateChangeTimer timer)</TD></TR><TR><TD CLASS="l">2826</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2827</TD><TD>                   Log.information(&#34;Deleting product state timer:&#34;+timer);</TD></TR><TR CLASS="z"><TD CLASS="l">2828</TD><TD>                   boolean deleted = FoundationFramework.getInstance().getTimeService().delete(timer.getId());</TD></TR><TR CLASS="z"><TD CLASS="l">2829</TD><TD>                   if (deleted)</TD></TR><TR><TD CLASS="l">2830</TD><TD>                   {</TD></TR><TR CLASS="z"><TD CLASS="l">2831</TD><TD>                           Log.information(&#34;Timer &#34;+timer +&#34; successfully deleted&#34;);</TD></TR><TR><TD CLASS="l">2832</TD><TD>                   }</TD></TR><TR><TD CLASS="l">2833</TD><TD>                   else</TD></TR><TR><TD CLASS="l">2834</TD><TD>                   {</TD></TR><TR CLASS="z"><TD CLASS="l">2835</TD><TD>                           Log.information(&#34;unable to delete timer for:&#34;+timer);</TD></TR><TR><TD CLASS="l"><A NAME="64">2836</A></TD><TD>                   }</TD></TR><TR CLASS="z"><TD CLASS="l">2837</TD><TD>    }</TD></TR><TR><TD CLASS="l">2838</TD><TD>    private void registerTimer(ProductStateChangeTimer timer,int timerType, TradingSessionElementStruct element,long anAbsoluteTime)</TD></TR><TR><TD CLASS="l">2839</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2840</TD><TD>            Boolean startTimer = productStateTimerBySession.get(element.sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">2841</TD><TD>            if (startTimer == null ||!startTimer.booleanValue())</TD></TR><TR><TD CLASS="l">2842</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2843</TD><TD>                    return;</TD></TR><TR><TD CLASS="l">2844</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2845</TD><TD>            long now   = FoundationFramework.getInstance().getTimeService().getCurrentDateTime();</TD></TR><TR><TD CLASS="l">2846</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2847</TD><TD>        int time = (int)(anAbsoluteTime - now);</TD></TR><TR CLASS="z"><TD CLASS="l">2848</TD><TD>        if (time &gt; 0)</TD></TR><TR><TD CLASS="l">2849</TD><TD>        {</TD></TR><TR><TD CLASS="l">2850</TD><TD>            // Queues a timer for a Listener</TD></TR><TR CLASS="z"><TD CLASS="l">2851</TD><TD>            timer.setId(FoundationFramework.getInstance().getTimeService().enqueue(timerType, time, element, timer));</TD></TR><TR CLASS="z"><TD CLASS="l">2852</TD><TD>            tradingSessionTimerMap.put(element.elementKey+&#34;&#34;+timerType,timer);</TD></TR><TR CLASS="z"><TD CLASS="l">2853</TD><TD>            Log.information(&#34;Timer ADDED for listener (&#34; + timer + &#34;)&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2854</TD><TD>            return;</TD></TR><TR><TD CLASS="l">2855</TD><TD>        }</TD></TR><TR><TD CLASS="l">2856</TD><TD>        else</TD></TR><TR><TD CLASS="l">2857</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2858</TD><TD>            Log.information(&#34;Timer NOT ADDED for listener (&#34; + timer + &#34;) has already expired&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2859</TD><TD>            return;</TD></TR><TR><TD CLASS="l">2860</TD><TD>        }</TD></TR><TR><TD CLASS="l">2861</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="43">2862</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2863</TD><TD> </TD></TR><TR><TD CLASS="l">2864</TD><TD>    public HashMap&lt;String, ProductStateChangeTimer&gt; getProductStateTimer()</TD></TR><TR><TD CLASS="l">2865</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2866</TD><TD>            return tradingSessionTimerMap;</TD></TR><TR><TD CLASS="l"><A NAME="4e">2867</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2868</TD><TD> </TD></TR><TR><TD CLASS="l">2869</TD><TD>    public TradingSessionElementStruct[] getTradingSessionElements(String sessionName)</TD></TR><TR><TD CLASS="l">2870</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="83">2871</A></TD><TD>            return tradingSessionElementMap.get(sessionName);</TD></TR><TR><TD CLASS="l">2872</TD><TD>    }</TD></TR><TR><TD CLASS="l">2873</TD><TD> </TD></TR><TR><TD CLASS="l">2874</TD><TD>    public String toTimerTypeString(int timerType) {</TD></TR><TR CLASS="z"><TD CLASS="l">2875</TD><TD>        switch (timerType) {</TD></TR><TR><TD CLASS="l">2876</TD><TD>        case BusinessDayListener.BUSINESS_DAY_TIMER_TYPE:</TD></TR><TR CLASS="z"><TD CLASS="l">2877</TD><TD>            return &#34;&#34;;</TD></TR><TR><TD CLASS="l">2878</TD><TD>        case BusinessDayListener.PRODUCT_PRE_OPEN_TIMER_TYPE:</TD></TR><TR CLASS="z"><TD CLASS="l">2879</TD><TD>            return &#34;ProductPreOpenTimer&#34;;</TD></TR><TR><TD CLASS="l">2880</TD><TD>        case BusinessDayListener.PRODUCT_OPEN_TIMER_TYPE:</TD></TR><TR CLASS="z"><TD CLASS="l">2881</TD><TD>            return &#34;ProductOpenTimer&#34;;</TD></TR><TR><TD CLASS="l">2882</TD><TD>        case BusinessDayListener.PRODUCT_CLOSE_TIMER_TYPE:</TD></TR><TR CLASS="z"><TD CLASS="l">2883</TD><TD>            return &#34;ProductCloseTimer&#34;;</TD></TR><TR><TD CLASS="l">2884</TD><TD>        case BusinessDayListener.START_SESSION_TIMER_TYPE:</TD></TR><TR CLASS="z"><TD CLASS="l">2885</TD><TD>            return &#34;StartSessionTimer&#34;;</TD></TR><TR><TD CLASS="l">2886</TD><TD>        case BusinessDayListener.END_SESSION_TIMER_TYPE:</TD></TR><TR CLASS="z"><TD CLASS="l">2887</TD><TD>            return &#34;EndSessionTimer&#34;;</TD></TR><TR><TD CLASS="l">2888</TD><TD>        default:</TD></TR><TR CLASS="z"><TD CLASS="l">2889</TD><TD>            return &#34;UnknownTimer(&#34; + timerType + &#34;)&#34;;</TD></TR><TR><TD CLASS="l"><A NAME="5f">2890</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">2891</TD><TD>    }</TD></TR><TR><TD CLASS="l">2892</TD><TD>    public void publishProductStateChangeToCurrentMarket(TradingProduct[] products, CurrentMarketStateChangeConsumer currentMarketStateChangePublisher, boolean flagRepublish)</TD></TR><TR><TD CLASS="l">2893</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2894</TD><TD>        final String methodName = &#34;publishProductStateChangeToCurrentMarket: &#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2895</TD><TD>        final String subName = &#34;ProductStateServiceLocalImpl.publishProductStateChangeToCurrentMarket: &#34;;</TD></TR><TR><TD CLASS="l">2896</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2897</TD><TD>        if( products.length == 0 )</TD></TR><TR><TD CLASS="l">2898</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2899</TD><TD>            if( Log.isDebugOn() )</TD></TR><TR><TD CLASS="l">2900</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2901</TD><TD>                Log.debug(subName + &#34;received argument TradingProduct[] with 0 elements&#34;);</TD></TR><TR><TD CLASS="l">2902</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2903</TD><TD>            return;</TD></TR><TR><TD CLASS="l">2904</TD><TD>        }</TD></TR><TR><TD CLASS="l">2905</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2906</TD><TD>        if( currentMarketStateChangePublisher  == null )</TD></TR><TR><TD CLASS="l">2907</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2908</TD><TD>            Log.alarm(this, methodName + &#34; cannot publish since CurrentMarketStateChangeConsumer is null!&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2909</TD><TD>            return;</TD></TR><TR><TD CLASS="l">2910</TD><TD>        }</TD></TR><TR><TD CLASS="l">2911</TD><TD> </TD></TR><TR><TD CLASS="l">2912</TD><TD>        //This collector is created with maxCountCurMktStates set: so messages in the block will not be too big</TD></TR><TR><TD CLASS="l">2913</TD><TD>        // if more than the maxCountCurMktStates, another message will be sent.</TD></TR><TR CLASS="z"><TD CLASS="l">2914</TD><TD>        CurrentMarketStateChangeObjectCollector collector = new CurrentMarketStateChangeObjectCollector(currentMarketStateChangePublisher, CurrentMarketStateChangesHolder.TYPE, new CurrentMarketStateChangesClassKeyComparator(), this.maxCountCurMktStates);</TD></TR><TR><TD CLASS="l">2915</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2916</TD><TD>        CurrentMarketStateChangeStruct[] tempStruct = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2917</TD><TD>        RoutingParameterStruct routing = null;</TD></TR><TR><TD CLASS="l">2918</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2919</TD><TD>        for( int i = 0; i &lt; products.length; i++ )</TD></TR><TR><TD CLASS="l">2920</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2921</TD><TD>            OrderBook orderBook = products[i].getOrderBook();</TD></TR><TR CLASS="z"><TD CLASS="l">2922</TD><TD>            routing = orderBook.getRoutingParameter();</TD></TR><TR><TD CLASS="l">2923</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2924</TD><TD>            short oldState = products[i].getCurrentStateCode();</TD></TR><TR CLASS="z"><TD CLASS="l">2925</TD><TD>            tempStruct = orderBook.toCurrentMarketStateChangeStructs(oldState, oldState, flagRepublish);  // at this time both state are the same</TD></TR><TR><TD CLASS="l">2926</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2927</TD><TD>            if(tempStruct != null &amp;&amp; tempStruct.length &gt;0)</TD></TR><TR><TD CLASS="l">2928</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2929</TD><TD>                collector.add(new CurrentMarketStateChangesHolder(routing, tempStruct));</TD></TR><TR><TD CLASS="l">2930</TD><TD>            }</TD></TR><TR><TD CLASS="l">2931</TD><TD>            else</TD></TR><TR><TD CLASS="l">2932</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2933</TD><TD>                Log.information(this, methodName +&#34;skipping publishing for &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">2934</TD><TD>                                      &#34; class &#34; + products[i].getProductKeys().classKey +</TD></TR><TR CLASS="z"><TD CLASS="l">2935</TD><TD>                                      &#34; product &#34; + products[i].getProductKey() +</TD></TR><TR CLASS="z"><TD CLASS="l">2936</TD><TD>                                      &#34; since the CurrentMarketStateChangeStruct[] for it is null or empty.&#34;);</TD></TR><TR><TD CLASS="l">2937</TD><TD>            }</TD></TR><TR><TD CLASS="l">2938</TD><TD>        } // end for</TD></TR><TR><TD CLASS="l">2939</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2940</TD><TD>        Log.information(this, methodName + &#34;publishing acceptCurrentMarketStateChangeForClass for &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">2941</TD><TD>                            &#34; class &#34; + products[0].getProductKeys().classKey  );</TD></TR><TR CLASS="z"><TD CLASS="l">2942</TD><TD>        collector.release();     // this will publish using the publisher the has been passed to the collector during contruction.</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3b">2943</A></TD><TD>    } // end publishProductStateChangeToCurrentMarket</TD></TR><TR><TD CLASS="l">2944</TD><TD> </TD></TR><TR><TD CLASS="l">2945</TD><TD>    public CurrentMarketStateChangeConsumer getCurrentMarketStateChangePublisher()</TD></TR><TR><TD CLASS="l">2946</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2947</TD><TD>        if ( currentMarketStateChangePublisher == null )</TD></TR><TR><TD CLASS="l">2948</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2949</TD><TD>            CurrentMarketStateChangeConsumerHome cmpsHome = InternalEventHomes.getCurrentMarketStateChangeConsumerHome();</TD></TR><TR CLASS="z"><TD CLASS="l">2950</TD><TD>            if(cmpsHome instanceof CurrentMarketStateChangeConsumerHomeNoPubImpl)</TD></TR><TR><TD CLASS="l">2951</TD><TD>            {</TD></TR><TR><TD CLASS="l">2952</TD><TD>                CurrentMarketStateChangeConsumerHomeNoPubImpl cmpcHomeNoPubImpl;</TD></TR><TR CLASS="z"><TD CLASS="l">2953</TD><TD>                cmpcHomeNoPubImpl = (CurrentMarketStateChangeConsumerHomeNoPubImpl) cmpsHome;</TD></TR><TR CLASS="z"><TD CLASS="l">2954</TD><TD>                currentMarketStateChangePublisher = cmpcHomeNoPubImpl.getExternalPublisher();</TD></TR><TR><TD CLASS="l">2955</TD><TD>                // we want to use the external publisher if so configured in Current makrket state hoem</TD></TR><TR><TD CLASS="l">2956</TD><TD>                // to send it directly to event channel</TD></TR><TR><TD CLASS="l">2957</TD><TD>            }</TD></TR><TR><TD CLASS="l">2958</TD><TD>            else</TD></TR><TR><TD CLASS="l">2959</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2960</TD><TD>                currentMarketStateChangePublisher = InternalEventHomes.getCurrentMarketStateChangeConsumerHome().find();</TD></TR><TR><TD CLASS="l">2961</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2962</TD><TD>            if(Log.isDebugOn())</TD></TR><TR><TD CLASS="l">2963</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2964</TD><TD>                Log.debug(this, &#34;Setting acutal current market state change publisher in ProductStateServiceLocalImpl as :&#34; + currentMarketStateChangePublisher );</TD></TR><TR><TD CLASS="l">2965</TD><TD>            }</TD></TR><TR><TD CLASS="l">2966</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2967</TD><TD>        return currentMarketStateChangePublisher;</TD></TR><TR><TD CLASS="l"><A NAME="86">2968</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2969</TD><TD> </TD></TR><TR><TD CLASS="l">2970</TD><TD>    public String writeNumericKeysToString(int[] numericKeys)</TD></TR><TR><TD CLASS="l">2971</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2972</TD><TD>        StringBuffer numericKeysStr = new StringBuffer(&#34;{&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2973</TD><TD>        if( numericKeys.length == 0 )</TD></TR><TR><TD CLASS="l">2974</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2975</TD><TD>            numericKeysStr = numericKeysStr.append(&#34;}&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2976</TD><TD>            return numericKeysStr.toString();</TD></TR><TR><TD CLASS="l">2977</TD><TD>        }</TD></TR><TR><TD CLASS="l">2978</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2979</TD><TD>        numericKeysStr = numericKeysStr.append(numericKeys[0]);</TD></TR><TR CLASS="z"><TD CLASS="l">2980</TD><TD>        for( int i = 1; i &lt; numericKeys.length; i++ )</TD></TR><TR><TD CLASS="l">2981</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2982</TD><TD>            numericKeysStr = numericKeysStr.append(&#34;, &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2983</TD><TD>            numericKeysStr = numericKeysStr.append(numericKeys[i]);</TD></TR><TR><TD CLASS="l">2984</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2985</TD><TD>        numericKeysStr = numericKeysStr.append(&#34;}&#34;);</TD></TR><TR><TD CLASS="l">2986</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2987</TD><TD>        return numericKeysStr.toString();</TD></TR><TR><TD CLASS="l">2988</TD><TD> </TD></TR><TR><TD CLASS="l">2989</TD><TD>    } // end writeNumericKeysToString</TD></TR><TR><TD CLASS="l">2990</TD><TD> </TD></TR><TR><TD CLASS="l">2991</TD><TD> </TD></TR><TR><TD CLASS="l">2992</TD><TD>    /***************** Properties from XML File *****************/</TD></TR><TR><TD CLASS="l"><A NAME="74">2993</A></TD><TD> </TD></TR><TR><TD CLASS="l">2994</TD><TD>    @FFProperty (value = &#34;numberOfClassesToPublish&#34;)</TD></TR><TR><TD CLASS="l">2995</TD><TD>    public void setNumberOfClassesToPublish (int p_numberOfClassesToPublish)</TD></TR><TR><TD CLASS="l">2996</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2997</TD><TD>        numberOfClassesToPublish = p_numberOfClassesToPublish;</TD></TR><TR CLASS="z"><TD CLASS="l">2998</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="7f">2999</A></TD><TD> </TD></TR><TR><TD CLASS="l">3000</TD><TD>    @FFProperty (value = &#34;publishInterval&#34;)</TD></TR><TR><TD CLASS="l">3001</TD><TD>    public void setPublishInterval (int p_publishInterval)</TD></TR><TR><TD CLASS="l">3002</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3003</TD><TD>        publishInterval = p_publishInterval;</TD></TR><TR CLASS="z"><TD CLASS="l">3004</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="73">3005</A></TD><TD> </TD></TR><TR><TD CLASS="l">3006</TD><TD>    @FFProperty (value = &#34;numberBuildThreads&#34;)</TD></TR><TR><TD CLASS="l">3007</TD><TD>    public void setNumberBuildThreads (int p_numberBuildThreads)</TD></TR><TR><TD CLASS="l">3008</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3009</TD><TD>        numberOfBuildThreads = p_numberBuildThreads;</TD></TR><TR CLASS="z"><TD CLASS="l">3010</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="70">3011</A></TD><TD> </TD></TR><TR><TD CLASS="l">3012</TD><TD>    @FFProperty (value = &#34;maxCountCurMktStatsForClassPerMessage&#34;)</TD></TR><TR><TD CLASS="l">3013</TD><TD>    public void setMaxCountCurMktStatsForClassPerMessage (int p_maxCountCurMktStatsForClassPerMessage)</TD></TR><TR><TD CLASS="l">3014</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3015</TD><TD>        maxCountCurMktStates = p_maxCountCurMktStatsForClassPerMessage;</TD></TR><TR CLASS="z"><TD CLASS="l">3016</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="96">3017</A></TD><TD> </TD></TR><TR><TD CLASS="l">3018</TD><TD>    @FFProperty (value = &#34;underlyingMapSize&#34;)</TD></TR><TR><TD CLASS="l">3019</TD><TD>    public void setUnderlyingMapSize (int p_underlyingMapSize)</TD></TR><TR><TD CLASS="l">3020</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">3021</TD><TD>        underlyingMapSize = p_underlyingMapSize;</TD></TR><TR CLASS="c"><TD CLASS="l">3022</TD><TD>    }</TD></TR><TR><TD CLASS="l">3023</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="72">3024</A></TD><TD> </TD></TR><TR><TD CLASS="l">3025</TD><TD>    @FFProperty (value = &#34;minimumClassStateChangePerThread&#34;)</TD></TR><TR><TD CLASS="l">3026</TD><TD>    public void setMinimumClassStateChangePerThread (int numberOfThread)</TD></TR><TR><TD CLASS="l">3027</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3028</TD><TD>        numberOfClassStateChangePerThread = numberOfThread;</TD></TR><TR CLASS="z"><TD CLASS="l">3029</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="71">3030</A></TD><TD> </TD></TR><TR><TD CLASS="l">3031</TD><TD>    @FFProperty (value = &#34;maximumClassStateChangeThread&#34;)</TD></TR><TR><TD CLASS="l">3032</TD><TD>    public void setMaximumClassStateChangeThread (int numberOfThread)</TD></TR><TR><TD CLASS="l">3033</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3034</TD><TD>        maximumClassStateChangeThread = numberOfThread;</TD></TR><TR CLASS="z"><TD CLASS="l">3035</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="6c">3036</A></TD><TD>    </TD></TR><TR><TD CLASS="l">3037</TD><TD>    @FFProperty (value = &#34;enableProductStateChangeByUnderlying&#34;)</TD></TR><TR><TD CLASS="l">3038</TD><TD>    public void setEnableProductStateChangeByUnderlying (boolean enabled)</TD></TR><TR><TD CLASS="l">3039</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3040</TD><TD>            enableProductStateChangeByUnderlying = enabled;</TD></TR><TR CLASS="z"><TD CLASS="l">3041</TD><TD>    }</TD></TR><TR><TD CLASS="l">3042</TD><TD> </TD></TR><TR><TD CLASS="l">3043</TD><TD> </TD></TR><TR><TD CLASS="l">3044</TD><TD>    /***************** End of Properties *****************/</TD></TR><TR><TD CLASS="l">3045</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="24">3046</A></TD><TD>    @FFCommand(description=&#34;get if a user is a Edpm for a class&#34;, paramDescriptions = {&#34;userId&#34;, &#34;classKey&#34;})</TD></TR><TR><TD CLASS="l">3047</TD><TD>    public String adminIsEDpmForClass(String userId, String classKeyStr)</TD></TR><TR><TD CLASS="l">3048</TD><TD>    {</TD></TR><TR><TD CLASS="l">3049</TD><TD>        String msg;</TD></TR><TR CLASS="z"><TD CLASS="l">3050</TD><TD>        int classKey = Integer.parseInt(classKeyStr);</TD></TR><TR CLASS="z"><TD CLASS="l">3051</TD><TD>        TradingClass tClass = getTradingClass(classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3052</TD><TD>        if (tClass == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3053</TD><TD>            msg = &#34;Class: &#34; + classKeyStr + &#34; is not a configured class for this route&#34;;</TD></TR><TR><TD CLASS="l">3054</TD><TD>        }</TD></TR><TR><TD CLASS="l">3055</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">3056</TD><TD>            boolean result = tClass.isEDPM(userId);</TD></TR><TR CLASS="z"><TD CLASS="l">3057</TD><TD>            msg = &#34;User &#34; + userId + &#34; is an EDpm for class &#34; + classKeyStr + &#34;:&#34; + result;</TD></TR><TR><TD CLASS="l">3058</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3059</TD><TD>        return msg;</TD></TR><TR><TD CLASS="l">3060</TD><TD>    }</TD></TR><TR><TD CLASS="l">3061</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="23">3062</A></TD><TD>    @FFCommand(description=&#34;Check if a user is a dpm for a class&#34;, paramDescriptions = {&#34;userId&#34;, &#34;classKey&#34;})</TD></TR><TR><TD CLASS="l">3063</TD><TD>    public String adminIsDpmForClass(String userId, String classKeyStr)</TD></TR><TR><TD CLASS="l">3064</TD><TD>    {</TD></TR><TR><TD CLASS="l">3065</TD><TD>        String msg;</TD></TR><TR CLASS="z"><TD CLASS="l">3066</TD><TD>        int classKey = Integer.parseInt(classKeyStr);</TD></TR><TR CLASS="z"><TD CLASS="l">3067</TD><TD>        TradingClass tClass = getTradingClass(classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3068</TD><TD>        if (tClass == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3069</TD><TD>            msg = &#34;Class: &#34; + classKeyStr + &#34; is not a configured class for this route&#34;;</TD></TR><TR><TD CLASS="l">3070</TD><TD>        }</TD></TR><TR><TD CLASS="l">3071</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">3072</TD><TD>            boolean result = getTradingClass(classKey).isDPM(userId);</TD></TR><TR CLASS="z"><TD CLASS="l">3073</TD><TD>            msg = &#34;User &#34; + userId + &#34; is a Dpm for class &#34; + classKeyStr + &#34;:&#34; + result;</TD></TR><TR><TD CLASS="l">3074</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3075</TD><TD>        return msg;</TD></TR><TR><TD CLASS="l">3076</TD><TD>    }</TD></TR><TR><TD CLASS="l">3077</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="22">3078</A></TD><TD>    @FFCommand(description=&#34;get the trading property cached by trading class&#34;, paramDescriptions = {&#34;classKey&#34;, &#34;tradingPropertyType&#34;})</TD></TR><TR><TD CLASS="l">3079</TD><TD>    public String adminGetTradingPropertyCachedByClass(String classKeyStr, String tradingPropertyTypeStr)</TD></TR><TR><TD CLASS="l">3080</TD><TD>    {</TD></TR><TR><TD CLASS="l">3081</TD><TD>        String result;</TD></TR><TR CLASS="z"><TD CLASS="l">3082</TD><TD>        int classKey = Integer.parseInt(classKeyStr);</TD></TR><TR CLASS="z"><TD CLASS="l">3083</TD><TD>        int propertyType = Integer.parseInt(tradingPropertyTypeStr);</TD></TR><TR CLASS="z"><TD CLASS="l">3084</TD><TD>        TradingClass tClass = getTradingClass(classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3085</TD><TD>        if (tClass == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3086</TD><TD>            return &#34;Class: &#34; + classKeyStr + &#34; is not a configured class for this route&#34;;</TD></TR><TR><TD CLASS="l">3087</TD><TD>        }</TD></TR><TR><TD CLASS="l">3088</TD><TD>        int anInt;</TD></TR><TR><TD CLASS="l">3089</TD><TD>        double aDouble;</TD></TR><TR><TD CLASS="l">3090</TD><TD>        boolean aBoolean;</TD></TR><TR><TD CLASS="l">3091</TD><TD>        TimeRangeStruct timeRange;</TD></TR><TR><TD CLASS="l">3092</TD><TD>        AuctionLongStruct[] auctionLong;</TD></TR><TR><TD CLASS="l">3093</TD><TD>        AuctionOrderSizeTicksStruct[] sizeTicks;</TD></TR><TR CLASS="z"><TD CLASS="l">3094</TD><TD>        switch (propertyType) {</TD></TR><TR><TD CLASS="l">3095</TD><TD>            case GlobalTradingPropertyTypes.EPW_STRUCT :</TD></TR><TR CLASS="z"><TD CLASS="l">3096</TD><TD>                EPWStruct[] epw = tClass.getTradingPropertyEPW();</TD></TR><TR CLASS="z"><TD CLASS="l">3097</TD><TD>                result = stringifyStruct(epw, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3098</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3099</TD><TD>            case GlobalTradingPropertyTypes.MIN_QUOTE_CREDIT_DEFAULT_SIZE :</TD></TR><TR CLASS="z"><TD CLASS="l">3100</TD><TD>                anInt = tClass.getTradingPropertyMinQuoteCreditDefaultSize();</TD></TR><TR CLASS="z"><TD CLASS="l">3101</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3102</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3103</TD><TD>            case GlobalTradingPropertyTypes.RFQ_RESPONSE_RATIO :</TD></TR><TR CLASS="z"><TD CLASS="l">3104</TD><TD>                aDouble = tClass.getTradingPropertyRFQResponseRatio();</TD></TR><TR CLASS="z"><TD CLASS="l">3105</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aDouble;</TD></TR><TR CLASS="z"><TD CLASS="l">3106</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3107</TD><TD>            case GlobalTradingPropertyTypes.ALLOCATION_STRATEGY :</TD></TR><TR CLASS="z"><TD CLASS="l">3108</TD><TD>                AllocationStrategyStructV2[] allocation = tClass.getTradingPropertyAllocationStrategy();</TD></TR><TR CLASS="z"><TD CLASS="l">3109</TD><TD>                result = stringifyStruct(allocation, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3110</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3111</TD><TD>            case GlobalTradingPropertyTypes.CONTINGENCY_TIME_TO_LIVE :</TD></TR><TR CLASS="z"><TD CLASS="l">3112</TD><TD>                anInt = tClass.getTradingPropertyContingencyTimeToLive();</TD></TR><TR CLASS="z"><TD CLASS="l">3113</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3114</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3115</TD><TD>            case GlobalTradingPropertyTypes.CONTINUOUS_QUOTE_PERIOD_FOR_CREDIT :</TD></TR><TR CLASS="z"><TD CLASS="l">3116</TD><TD>                anInt = tClass.getTradingPropertyContinuousQuotePeriodForCredit();</TD></TR><TR CLASS="z"><TD CLASS="l">3117</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3118</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3119</TD><TD>            case GlobalTradingPropertyTypes.FAST_MARKET_SPREAD_MULTIPLIER :</TD></TR><TR CLASS="z"><TD CLASS="l">3120</TD><TD>                aDouble = tClass.getTradingPropertyFastMarketSpreadMultiplier();</TD></TR><TR CLASS="z"><TD CLASS="l">3121</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aDouble;</TD></TR><TR CLASS="z"><TD CLASS="l">3122</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3123</TD><TD>            case GlobalTradingPropertyTypes.OPENING_TIME_PERIOD_RANGE :</TD></TR><TR CLASS="z"><TD CLASS="l">3124</TD><TD>                timeRange = tClass.getTradingPropertyOpeningTimePeriodRange();</TD></TR><TR CLASS="z"><TD CLASS="l">3125</TD><TD>                result = stringifyStruct(timeRange, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3126</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3127</TD><TD>            case GlobalTradingPropertyTypes.OPENING_PRICE_DELAY :</TD></TR><TR CLASS="z"><TD CLASS="l">3128</TD><TD>                anInt = tClass.getTradingPropertyOpeningPriceDelay();</TD></TR><TR CLASS="z"><TD CLASS="l">3129</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3130</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3131</TD><TD>            case GlobalTradingPropertyTypes.OPENING_PRICE_RATE :</TD></TR><TR CLASS="z"><TD CLASS="l">3132</TD><TD>                anInt = tClass.getTradingPropertyOpeningPriceRate();</TD></TR><TR CLASS="z"><TD CLASS="l">3133</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3134</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3135</TD><TD>            case GlobalTradingPropertyTypes.PRECLOSING_TIME_PERIOD :</TD></TR><TR CLASS="z"><TD CLASS="l">3136</TD><TD>                timeRange = tClass.getTradingPropertyOpeningTimePeriodRange();</TD></TR><TR CLASS="z"><TD CLASS="l">3137</TD><TD>                result = stringifyStruct(timeRange, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3138</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3139</TD><TD>            case GlobalTradingPropertyTypes.PRESCRIBED_WIDTH_RATIO :</TD></TR><TR CLASS="z"><TD CLASS="l">3140</TD><TD>                aDouble = tClass.getTradingPropertyPrescribedWidthRatio();</TD></TR><TR CLASS="z"><TD CLASS="l">3141</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aDouble;</TD></TR><TR CLASS="z"><TD CLASS="l">3142</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3143</TD><TD>            case GlobalTradingPropertyTypes.RFQ_TIMEOUT :</TD></TR><TR CLASS="z"><TD CLASS="l">3144</TD><TD>                anInt = tClass.getTradingPropertyRFQTimeOut();</TD></TR><TR CLASS="z"><TD CLASS="l">3145</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3146</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3147</TD><TD>            case GlobalTradingPropertyTypes.DPM_PARTICIPATION_PERCENTAGE :</TD></TR><TR CLASS="z"><TD CLASS="l">3148</TD><TD>                aDouble = tClass.getTradingPropertyDPMParticipationPercentage();</TD></TR><TR CLASS="z"><TD CLASS="l">3149</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aDouble;</TD></TR><TR CLASS="z"><TD CLASS="l">3150</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3151</TD><TD>            case GlobalTradingPropertyTypes.BOOK_DEPTH_SIZE :</TD></TR><TR CLASS="z"><TD CLASS="l">3152</TD><TD>                anInt = tClass.getTradingPropertyBookDepthSize();</TD></TR><TR CLASS="z"><TD CLASS="l">3153</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3154</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3155</TD><TD>            case GlobalTradingPropertyTypes.MIN_SIZE_FOR_BLOCK_TRADE :</TD></TR><TR CLASS="z"><TD CLASS="l">3156</TD><TD>                anInt = tClass.getTradingPropertyMinSizeForBlockTrade();</TD></TR><TR CLASS="z"><TD CLASS="l">3157</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3158</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3159</TD><TD>            case GlobalTradingPropertyTypes.IPP_MIN_SIZE :</TD></TR><TR CLASS="z"><TD CLASS="l">3160</TD><TD>                anInt = tClass.getTradingPropertyIPPMinSize();</TD></TR><TR CLASS="z"><TD CLASS="l">3161</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3162</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3163</TD><TD>            case GlobalTradingPropertyTypes.IPP_TRADE_THROUGH_FLAG :</TD></TR><TR CLASS="z"><TD CLASS="l">3164</TD><TD>                aBoolean = tClass.getTradingPropertyIPPTradeThroughFlag();</TD></TR><TR CLASS="z"><TD CLASS="l">3165</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aBoolean;</TD></TR><TR CLASS="z"><TD CLASS="l">3166</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3167</TD><TD>            case GlobalTradingPropertyTypes.QUOTE_LOCK_TIMER :</TD></TR><TR CLASS="z"><TD CLASS="l">3168</TD><TD>                anInt = tClass.getTradingPropertyQuoteLockTimer();</TD></TR><TR CLASS="z"><TD CLASS="l">3169</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3170</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3171</TD><TD>            case GlobalTradingPropertyTypes.QUOTE_LOCK_NOTIFICATION_TIMER :</TD></TR><TR CLASS="z"><TD CLASS="l">3172</TD><TD>                anInt = tClass.getTradingPropertyQuoteLockNotificationTimer();</TD></TR><TR CLASS="z"><TD CLASS="l">3173</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3174</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3175</TD><TD>            case GlobalTradingPropertyTypes.QUOTE_TRIGGER_TIMER :</TD></TR><TR CLASS="z"><TD CLASS="l">3176</TD><TD>                anInt = tClass.getTradingPropertyQuoteTriggerTimer();</TD></TR><TR CLASS="z"><TD CLASS="l">3177</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3178</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3179</TD><TD>            case GlobalTradingPropertyTypes.DPM_RIGHTS_SCALES :</TD></TR><TR CLASS="z"><TD CLASS="l">3180</TD><TD>                DpmRightsScaleStruct[] scale= tClass.getTradingPropertyDPMRightsScale();</TD></TR><TR CLASS="z"><TD CLASS="l">3181</TD><TD>                result = stringifyStruct(scale, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3182</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3183</TD><TD>            case GlobalTradingPropertyTypes.DMP_RIGHTS_SPLIT_RATE :</TD></TR><TR CLASS="z"><TD CLASS="l">3184</TD><TD>                aDouble = tClass.getTradingPropertyDPMRightsSplitRate();</TD></TR><TR CLASS="z"><TD CLASS="l">3185</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aDouble;</TD></TR><TR CLASS="z"><TD CLASS="l">3186</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3187</TD><TD>            case GlobalTradingPropertyTypes.UMA_SPLIT_RATE :</TD></TR><TR CLASS="z"><TD CLASS="l">3188</TD><TD>                aDouble = tClass.getTradingPropertyUMASplitRate();</TD></TR><TR CLASS="z"><TD CLASS="l">3189</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aDouble;</TD></TR><TR CLASS="z"><TD CLASS="l">3190</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3191</TD><TD>            case GlobalTradingPropertyTypes.UMA_EQUAL_DISTRIBUTION_WEIGHT_FOR_DPM :</TD></TR><TR CLASS="z"><TD CLASS="l">3192</TD><TD>                anInt = tClass.getTradingPropertyUMAEqualDistributionWeightForDPM();</TD></TR><TR CLASS="z"><TD CLASS="l">3193</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3194</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3195</TD><TD>            case GlobalTradingPropertyTypes.LOT_SIZE :</TD></TR><TR CLASS="z"><TD CLASS="l">3196</TD><TD>                anInt = tClass.getTradingPropertyLotSize();</TD></TR><TR CLASS="z"><TD CLASS="l">3197</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3198</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3199</TD><TD>            case GlobalTradingPropertyTypes.ETF_FLAG :</TD></TR><TR CLASS="z"><TD CLASS="l">3200</TD><TD>                aBoolean = tClass.getTradingPropertyETFFlag();</TD></TR><TR CLASS="z"><TD CLASS="l">3201</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aBoolean;</TD></TR><TR CLASS="z"><TD CLASS="l">3202</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3203</TD><TD>            case GlobalTradingPropertyTypes.IPP_TOLERANCE_AMOUNT :</TD></TR><TR CLASS="z"><TD CLASS="l">3204</TD><TD>                aDouble = tClass.getTradingPropertyIPPToleranceAmount();</TD></TR><TR CLASS="z"><TD CLASS="l">3205</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aDouble;</TD></TR><TR CLASS="z"><TD CLASS="l">3206</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3207</TD><TD>            case GlobalTradingPropertyTypes.NEEDS_DPM_QUOTE_TO_OPEN :</TD></TR><TR CLASS="z"><TD CLASS="l">3208</TD><TD>                aBoolean = tClass.getTradingPropertyNeedsDPMQuoteToOpen();</TD></TR><TR CLASS="z"><TD CLASS="l">3209</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aBoolean;</TD></TR><TR CLASS="z"><TD CLASS="l">3210</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3211</TD><TD>            case GlobalTradingPropertyTypes.S_ORDER_TIME_TO_LIVE :</TD></TR><TR CLASS="z"><TD CLASS="l">3212</TD><TD>                anInt = tClass.getTradingPropertySOrderTimeToLive();</TD></TR><TR CLASS="z"><TD CLASS="l">3213</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3214</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3215</TD><TD>            case GlobalTradingPropertyTypes.S_ORDER_TIME_TO_CREATE :</TD></TR><TR CLASS="z"><TD CLASS="l">3216</TD><TD>                anInt = tClass.getTradingPropertySOrderTimeToCreate();</TD></TR><TR CLASS="z"><TD CLASS="l">3217</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3218</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3219</TD><TD>            case GlobalTradingPropertyTypes.S_ORDER_TIME_TO_CREATE_BEFORE_CLOSE :</TD></TR><TR CLASS="z"><TD CLASS="l">3220</TD><TD>                anInt = tClass.getTradingPropertySOrderTimeToCreateBeforeClose();</TD></TR><TR CLASS="z"><TD CLASS="l">3221</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3222</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3223</TD><TD>            case GlobalTradingPropertyTypes.S_ORDER_TIME_TO_REJECT_FILL :</TD></TR><TR CLASS="z"><TD CLASS="l">3224</TD><TD>                anInt = tClass.getTradingPropertySOrderTimeToRejectFill();</TD></TR><TR CLASS="z"><TD CLASS="l">3225</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3226</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3227</TD><TD>            case GlobalTradingPropertyTypes.P_ORDER_TIME_TO_LIVE :</TD></TR><TR CLASS="z"><TD CLASS="l">3228</TD><TD>                anInt = tClass.getTradingPropertyPOrderTimeToLive();</TD></TR><TR CLASS="z"><TD CLASS="l">3229</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3230</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3231</TD><TD>            case GlobalTradingPropertyTypes.PA_ORDER_TIME_TO_LIVE :</TD></TR><TR CLASS="z"><TD CLASS="l">3232</TD><TD>                anInt = tClass.getTradingPropertyPAOrderTimeToLive();</TD></TR><TR CLASS="z"><TD CLASS="l">3233</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3234</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3235</TD><TD>            case GlobalTradingPropertyTypes.TRADE_TYPE :</TD></TR><TR CLASS="z"><TD CLASS="l">3236</TD><TD>                anInt = tClass.getTradingPropertyTradeType();</TD></TR><TR CLASS="z"><TD CLASS="l">3237</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3238</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3239</TD><TD>            case GlobalTradingPropertyTypes.PRODUCT_OPEN_PROCEDURE_TYPE :</TD></TR><TR CLASS="z"><TD CLASS="l">3240</TD><TD>                anInt = tClass.getTradingPropertyProductOpenProcedureType();</TD></TR><TR CLASS="z"><TD CLASS="l">3241</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3242</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3243</TD><TD>            case GlobalTradingPropertyTypes.SATISFACTION_ALERT_FLAG :</TD></TR><TR CLASS="z"><TD CLASS="l">3244</TD><TD>                aBoolean = tClass.getTradingPropertySatisfactionAlertFlag();</TD></TR><TR CLASS="z"><TD CLASS="l">3245</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aBoolean;</TD></TR><TR CLASS="z"><TD CLASS="l">3246</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3247</TD><TD>            case GlobalTradingPropertyTypes.FIRM_PRINCIPAL_QUOTE_SIZE :</TD></TR><TR CLASS="z"><TD CLASS="l">3248</TD><TD>                anInt = tClass.getTradingPropertyFirmPrincipalQuoteSize();</TD></TR><TR CLASS="z"><TD CLASS="l">3249</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3250</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3251</TD><TD>            case GlobalTradingPropertyTypes.FIRM_CUSTOMER_QUOTE_SIZE :</TD></TR><TR CLASS="z"><TD CLASS="l">3252</TD><TD>                anInt = tClass.getTradingPropertyFirmCustomerQuoteSize();</TD></TR><TR CLASS="z"><TD CLASS="l">3253</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3254</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3255</TD><TD>            case GlobalTradingPropertyTypes.LINKAGE_ENABLED_FLAG :</TD></TR><TR CLASS="z"><TD CLASS="l">3256</TD><TD>                aBoolean = tClass.getTradingPropertyLinkageEnabledFlag();</TD></TR><TR CLASS="z"><TD CLASS="l">3257</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + aBoolean;</TD></TR><TR CLASS="z"><TD CLASS="l">3258</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3259</TD><TD>            case GlobalTradingPropertyTypes.QUOTE_LOCK_MIN_TRADE_QTY :</TD></TR><TR CLASS="z"><TD CLASS="l">3260</TD><TD>                anInt = tClass.getTradingPropertyQuoteLockMinTradeQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">3261</TD><TD>                result = &#34;class/type/value:&#34; + classKeyStr + &#34;/&#34; + tradingPropertyTypeStr + &#34;/&#34; + anInt;</TD></TR><TR CLASS="z"><TD CLASS="l">3262</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3263</TD><TD>            case GlobalTradingPropertyTypes.AUCTION_TIME_TO_LIVE :</TD></TR><TR CLASS="z"><TD CLASS="l">3264</TD><TD>                AuctionRangeStruct[] auctionRange = tClass.getTradingPropertyAuctionTimeToLive();</TD></TR><TR CLASS="z"><TD CLASS="l">3265</TD><TD>                result = stringifyStruct(auctionRange, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3266</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3267</TD><TD>            case GlobalTradingPropertyTypes.AUCTION_MIN_PRICE_INCREMENT :</TD></TR><TR CLASS="z"><TD CLASS="l">3268</TD><TD>                auctionLong = tClass.getTradingPropertyAuctionMinPriceIncrement();</TD></TR><TR CLASS="z"><TD CLASS="l">3269</TD><TD>                result = stringifyStruct(auctionLong, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3270</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3271</TD><TD>            case GlobalTradingPropertyTypes.AUCTION_MIN_QUOTERS :</TD></TR><TR CLASS="z"><TD CLASS="l">3272</TD><TD>                auctionLong = tClass.getTradingPropertyAuctionMinQuoters();</TD></TR><TR CLASS="z"><TD CLASS="l">3273</TD><TD>                result = stringifyStruct(auctionLong, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3274</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3275</TD><TD>            case GlobalTradingPropertyTypes.AUCTION_RECEIVER_TYPES :</TD></TR><TR CLASS="z"><TD CLASS="l">3276</TD><TD>                auctionLong = tClass.getTradingPropertyAuctionReceiverTypes();</TD></TR><TR CLASS="z"><TD CLASS="l">3277</TD><TD>                result = stringifyStruct(auctionLong, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3278</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3279</TD><TD>            case GlobalTradingPropertyTypes.INTERNALIZATION_GUARANTEED_PERCENTAGE :</TD></TR><TR CLASS="z"><TD CLASS="l">3280</TD><TD>                InternalizationPercentageStruct[] percentage = tClass.getTradingPropertyInternalizationGuaranteedPercentage();</TD></TR><TR CLASS="z"><TD CLASS="l">3281</TD><TD>                result = stringifyStruct(percentage, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3282</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3283</TD><TD>            case GlobalTradingPropertyTypes.AUCTION_ORDER_TICKS_AWAY_FROM_NBBO :</TD></TR><TR CLASS="z"><TD CLASS="l">3284</TD><TD>                auctionLong = tClass.getTradingPropertyAuctionOrderTicksAwayFromNBBO();</TD></TR><TR CLASS="z"><TD CLASS="l">3285</TD><TD>                result = stringifyStruct(auctionLong, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3286</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3287</TD><TD>            case GlobalTradingPropertyTypes.AUTO_EX_ELIGIBLE_STRATEGY_TYPES :</TD></TR><TR CLASS="z"><TD CLASS="l">3288</TD><TD>                int[] types = tClass.getTradingPropertyAutoExEligibleStrategyTypes();</TD></TR><TR CLASS="z"><TD CLASS="l">3289</TD><TD>                result = stringifyStruct(types, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3290</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3291</TD><TD>            case GlobalTradingPropertyTypes.AUCTION_ENABLED :</TD></TR><TR CLASS="z"><TD CLASS="l">3292</TD><TD>                AuctionBooleanStruct[] auctionBoolean = tClass.getTradingPropertyAuctionEnabled();</TD></TR><TR CLASS="z"><TD CLASS="l">3293</TD><TD>                result = stringifyStruct(auctionBoolean, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3294</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3295</TD><TD>            case GlobalTradingPropertyTypes.AUCTION_MIN_ORDER_SIZE_FOR_TICKS_ABOVE_NBBO :</TD></TR><TR CLASS="z"><TD CLASS="l">3296</TD><TD>                sizeTicks = tClass.getTradingPropertyAuctionMinOrderSizeForTicksAboveNBBO();</TD></TR><TR CLASS="z"><TD CLASS="l">3297</TD><TD>                result = stringifyStruct(sizeTicks, &#34;TradingProperty&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3298</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3299</TD><TD>                </TD></TR><TR><TD CLASS="l">3300</TD><TD>            default :</TD></TR><TR CLASS="z"><TD CLASS="l">3301</TD><TD>                result = tClass.printTradingProperty(propertyType);</TD></TR><TR CLASS="z"><TD CLASS="l">3302</TD><TD>                if (result.equals(&#34;&#34;)){</TD></TR><TR CLASS="z"><TD CLASS="l">3303</TD><TD>                    result = &#34;TradingProperety type : &#34; +  tradingPropertyTypeStr + &#34; is not defined yet!!!&#34;;</TD></TR><TR><TD CLASS="l">3304</TD><TD>                }</TD></TR><TR><TD CLASS="l">3305</TD><TD>                break;</TD></TR><TR><TD CLASS="l">3306</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3307</TD><TD>        return result;</TD></TR><TR><TD CLASS="l">3308</TD><TD>    }</TD></TR><TR><TD CLASS="l">3309</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="82">3310</A></TD><TD>    protected String stringifyStruct(Object struct, String prefix)</TD></TR><TR><TD CLASS="l">3311</TD><TD>    {</TD></TR><TR><TD CLASS="l">3312</TD><TD>        try</TD></TR><TR><TD CLASS="l">3313</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3314</TD><TD>            java.io.StringWriter stringWriter = new java.io.StringWriter();</TD></TR><TR CLASS="z"><TD CLASS="l">3315</TD><TD>            com.cboe.domain.util.ReflectiveStructBuilder.printStruct(struct, prefix, stringWriter);</TD></TR><TR CLASS="z"><TD CLASS="l">3316</TD><TD>            stringWriter.flush();</TD></TR><TR CLASS="z"><TD CLASS="l">3317</TD><TD>            return stringWriter.toString();</TD></TR><TR><TD CLASS="l">3318</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3319</TD><TD>        catch (java.io.IOException ex)</TD></TR><TR><TD CLASS="l">3320</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3321</TD><TD>            Log.exception(this, &#34;IOException writing struct to string.  Unexpected. &#34; + ex, ex );</TD></TR><TR CLASS="z"><TD CLASS="l">3322</TD><TD>            return &#34;IOException writing struct to string.  Unexpected. &#34; + ex;</TD></TR><TR><TD CLASS="l">3323</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="54">3324</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3325</TD><TD> </TD></TR><TR><TD CLASS="l">3326</TD><TD>    protected void notifyListenersForProductStateChange(TradingProduct[] tradingProducts, int productCount)</TD></TR><TR><TD CLASS="l">3327</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3328</TD><TD>        ProductStateStruct[] productStateStruct = getProductStatesStruct(tradingProducts, productCount);</TD></TR><TR><TD CLASS="l">3329</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3330</TD><TD>        if(productStateStruct.length &lt;= 0)</TD></TR><TR><TD CLASS="l">3331</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3332</TD><TD>            return;</TD></TR><TR><TD CLASS="l">3333</TD><TD>        }</TD></TR><TR><TD CLASS="l">3334</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3335</TD><TD>        int classKey = tradingProducts[0].getTradingClass().getProductClassKey();</TD></TR><TR CLASS="z"><TD CLASS="l">3336</TD><TD>        String sessionName = tradingProducts[0].getTradingClass().getSessionName();</TD></TR><TR><TD CLASS="l">3337</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3338</TD><TD>        TradingProductStateListener[] listners = cachedTradingClassHome.getListnersForProductStateChange();</TD></TR><TR><TD CLASS="l">3339</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3340</TD><TD>        for(int i=0; i &lt; listners.length; i++)</TD></TR><TR><TD CLASS="l">3341</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3342</TD><TD>            listners[i].setProductStates(classKey, sessionName, productStateStruct, false);</TD></TR><TR><TD CLASS="l">3343</TD><TD>        }</TD></TR><TR><TD CLASS="l">3344</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3345</TD><TD>        return;</TD></TR><TR><TD CLASS="l"><A NAME="44">3346</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3347</TD><TD> </TD></TR><TR><TD CLASS="l">3348</TD><TD>    protected ProductStateStruct[] getProductStatesStruct(TradingProduct[] changedProducts, int productsSize)</TD></TR><TR><TD CLASS="l">3349</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3350</TD><TD>        if(productsSize == 0)</TD></TR><TR><TD CLASS="l">3351</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3352</TD><TD>            return new ProductStateStruct[0];</TD></TR><TR><TD CLASS="l">3353</TD><TD>        }</TD></TR><TR><TD CLASS="l">3354</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3355</TD><TD>        ProductStateStruct[] productStates = new ProductStateStruct[productsSize];</TD></TR><TR><TD CLASS="l">3356</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3357</TD><TD>        String sessionName = changedProducts[0].getTradingClass().getSessionName();</TD></TR><TR><TD CLASS="l">3358</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3359</TD><TD>        for(int i=0; i &lt; productsSize; i++)</TD></TR><TR><TD CLASS="l">3360</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3361</TD><TD>            ProductStateStruct stateStruct = new ProductStateStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">3362</TD><TD>            TradingProduct product = changedProducts[i];</TD></TR><TR><TD CLASS="l">3363</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3364</TD><TD>            stateStruct.productKeys = product.getProductKeys();</TD></TR><TR CLASS="z"><TD CLASS="l">3365</TD><TD>            stateStruct.productState = product.getCurrentStateCode();</TD></TR><TR CLASS="z"><TD CLASS="l">3366</TD><TD>            stateStruct.sessionName = sessionName;</TD></TR><TR CLASS="z"><TD CLASS="l">3367</TD><TD>            stateStruct.productStateTransactionSequenceNumber = -1;</TD></TR><TR><TD CLASS="l">3368</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3369</TD><TD>            productStates[i] = stateStruct;</TD></TR><TR><TD CLASS="l">3370</TD><TD>        }</TD></TR><TR><TD CLASS="l">3371</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3372</TD><TD>        return productStates;</TD></TR><TR><TD CLASS="l"><A NAME="47">3373</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3374</TD><TD> </TD></TR><TR><TD CLASS="l">3375</TD><TD>    public long getSleepInterval()</TD></TR><TR><TD CLASS="l">3376</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3377</TD><TD>        return sleepInterval;</TD></TR><TR><TD CLASS="l"><A NAME="80">3378</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3379</TD><TD> </TD></TR><TR><TD CLASS="l">3380</TD><TD>    public void setSleepInterval(long p_sleepInterval)</TD></TR><TR><TD CLASS="l">3381</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3382</TD><TD>        sleepInterval = p_sleepInterval;</TD></TR><TR CLASS="z"><TD CLASS="l">3383</TD><TD>    }</TD></TR><TR><TD CLASS="l">3384</TD><TD> </TD></TR><TR><TD CLASS="l">3385</TD><TD>//    protected void updateTradingClassHome(TradingSessionElementClassesDetailStruct[] classes)</TD></TR><TR><TD CLASS="l">3386</TD><TD>//    {</TD></TR><TR><TD CLASS="l">3387</TD><TD>//        //cache the tradingSessionElementInfo into tradingClassHome by elementKey. This map will be used by classes</TD></TR><TR><TD CLASS="l">3388</TD><TD>//        //to retrieve any element info</TD></TR><TR><TD CLASS="l"><A NAME="3a">3389</A></TD><TD>//    }</TD></TR><TR><TD CLASS="l">3390</TD><TD>    </TD></TR><TR><TD CLASS="l">3391</TD><TD>    private int[] getClassKeysForBuddyClasses()</TD></TR><TR><TD CLASS="l">3392</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3393</TD><TD>        Enumeration&lt;Integer&gt; rval = ConfigurationGroupHelper.getClassesAssignedToBuddyServer();</TD></TR><TR><TD CLASS="l">3394</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3395</TD><TD>        ArrayList&lt;Integer&gt; array = new ArrayList&lt;Integer&gt; ();</TD></TR><TR><TD CLASS="l">3396</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3397</TD><TD>        while (rval.hasMoreElements())</TD></TR><TR><TD CLASS="l">3398</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3399</TD><TD>            array.add(rval.nextElement());</TD></TR><TR><TD CLASS="l">3400</TD><TD>        }</TD></TR><TR><TD CLASS="l">3401</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3402</TD><TD>        int[] list = new int[array.size()];</TD></TR><TR><TD CLASS="l">3403</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3404</TD><TD>        for (int i = 0; i &lt; array.size(); i++)</TD></TR><TR><TD CLASS="l">3405</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3406</TD><TD>            list[i] = array.get(i);</TD></TR><TR><TD CLASS="l">3407</TD><TD>        }</TD></TR><TR><TD CLASS="l">3408</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3409</TD><TD>        return list;</TD></TR><TR><TD CLASS="l">3410</TD><TD>    }</TD></TR><TR><TD CLASS="l">3411</TD><TD> </TD></TR><TR><TD CLASS="l">3412</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3413</TD><TD>     * This method is only used for the STS enabled classes to override the FAST product state </TD></TR><TR><TD CLASS="l">3414</TD><TD>     * when the any of the leg moves to FAST the strategy should move to FAST. There is no other</TD></TR><TR><TD CLASS="l">3415</TD><TD>     * way but this to override this behavior because the bestBookLeg change method will evaluate</TD></TR><TR><TD CLASS="l">3416</TD><TD>     * status and prevent this behavior(since the evalMarketStatus may return the incomplete</TD></TR><TR><TD CLASS="l"><A NAME="6d">3417</A></TD><TD>     * market status when there is no market for the leg, but this product state overrides the</TD></TR><TR><TD CLASS="l">3418</TD><TD>     * current market status and moves the strategy product to FAST).</TD></TR><TR><TD CLASS="l">3419</TD><TD>     */</TD></TR><TR><TD CLASS="l">3420</TD><TD>    public void setFastProductStateForSTSEnabledClass(TradingProduct tradingProduct, short productState, boolean immediate) throws TransactionFailedException {</TD></TR><TR CLASS="z"><TD CLASS="l">3421</TD><TD>        ProductStateChangeCommand command = doProductStateChange(tradingProduct, productState, immediate);</TD></TR><TR CLASS="z"><TD CLASS="l">3422</TD><TD>        if (command != null) {</TD></TR><TR><TD CLASS="l">3423</TD><TD>            try {</TD></TR><TR><TD CLASS="l">3424</TD><TD>                // (execute within product-level lock if such a lock exists, otherwise this call</TD></TR><TR><TD CLASS="l">3425</TD><TD>                // will delegate to the class-level command processor)</TD></TR><TR CLASS="z"><TD CLASS="l">3426</TD><TD>                tradingProduct.acceptCommand(command, false);</TD></TR><TR><TD CLASS="l">3427</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3428</TD><TD>            catch (NotAcceptedException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">3429</TD><TD>                Log.alarm(this, &#34;Cannot use state command - setting state immediately&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3430</TD><TD>                command.execute();</TD></TR><TR><TD CLASS="l">3431</TD><TD>            }</TD></TR><TR><TD CLASS="l">3432</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3433</TD><TD>    }</TD></TR><TR><TD CLASS="l">3434</TD><TD> </TD></TR><TR><TD CLASS="l">3435</TD><TD> </TD></TR><TR><TD CLASS="l">3436</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="89">3437</A></TD><TD>     * Initializes a map for quicker lookups.</TD></TR><TR><TD CLASS="l">3438</TD><TD>     */</TD></TR><TR><TD CLASS="l">3439</TD><TD>    public void initializeCacheForOpening() throws Exception</TD></TR><TR><TD CLASS="l">3440</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">3441</TD><TD>        TradingClass [] tradingClasses = cachedTradingClassHome.findAllConfigured();</TD></TR><TR CLASS="c"><TD CLASS="l">3442</TD><TD>        for (TradingClass tradingClass : tradingClasses)</TD></TR><TR><TD CLASS="l">3443</TD><TD>        {</TD></TR><TR CLASS="c"><TD CLASS="l">3444</TD><TD>            int underlyingProductKey = tradingClass.getUnderlyingProductKeys().productKey;</TD></TR><TR CLASS="c"><TD CLASS="l">3445</TD><TD>            if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">3446</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3447</TD><TD>                Log.information(this, &#34;processing key [&#34; + tradingClass.getProductClassKey() + &#34;], &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">3448</TD><TD>                        &#34;underlyingProductKey of &#34; + underlyingProductKey);</TD></TR><TR><TD CLASS="l">3449</TD><TD>            }</TD></TR><TR><TD CLASS="l">3450</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3451</TD><TD>            List &lt;TradingClass&gt; derivativeClasses = (List) derivativesByUnderlying.get(underlyingProductKey);</TD></TR><TR CLASS="c"><TD CLASS="l">3452</TD><TD>            if (derivativeClasses == null)</TD></TR><TR><TD CLASS="l">3453</TD><TD>            {</TD></TR><TR CLASS="c"><TD CLASS="l">3454</TD><TD>                derivativeClasses = new ArrayList &lt;TradingClass&gt; ();</TD></TR><TR CLASS="c"><TD CLASS="l">3455</TD><TD>                derivativesByUnderlying.put(underlyingProductKey, derivativeClasses);</TD></TR><TR><TD CLASS="l">3456</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">3457</TD><TD>            derivativeClasses.add(tradingClass);</TD></TR><TR><TD CLASS="l">3458</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">3459</TD><TD>        Log.information(this, &#34;Cached &#34; + tradingClasses.length + &#34; trading classes to underyling&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">3460</TD><TD>        Log.information(this, &#34;Done initializing the derivativesByUnderlying cache maps.&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">3461</TD><TD>    }</TD></TR><TR><TD CLASS="l">3462</TD><TD> </TD></TR><TR><TD CLASS="l">3463</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3464</TD><TD>     * This method should only be called after the Home has gone Master.</TD></TR><TR><TD CLASS="l">3465</TD><TD>     * The derivativeByUnderlying map cannot currently be initialized prior to</TD></TR><TR><TD CLASS="l">3466</TD><TD>     * going master due to the limitations in TradingClassHome.</TD></TR><TR><TD CLASS="l"><A NAME="8a">3467</A></TD><TD>     * @return Returns all the UnderlyingProductKeys in no particular order</TD></TR><TR><TD CLASS="l">3468</TD><TD>     */</TD></TR><TR><TD CLASS="l">3469</TD><TD>    public int [] getUnderlyingProductKeys()</TD></TR><TR><TD CLASS="l">3470</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">3471</TD><TD>        Set &lt;Integer&gt; keySet = derivativesByUnderlying.keySet();</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="86% line coverage (18 out of 21 instructions)">3472</TD><TD TITLE="86% line coverage (18 out of 21 instructions)">        synchronized(keySet)</TD></TR><TR><TD CLASS="l">3473</TD><TD>        {</TD></TR><TR CLASS="c"><TD CLASS="l">3474</TD><TD>            int [] keys = new int [keySet.size()];</TD></TR><TR CLASS="c"><TD CLASS="l">3475</TD><TD>            Iterator &lt;Integer&gt; iter = keySet.iterator();</TD></TR><TR CLASS="c"><TD CLASS="l">3476</TD><TD>            for (int i = 0; iter.hasNext(); i++)</TD></TR><TR><TD CLASS="l">3477</TD><TD>            {</TD></TR><TR CLASS="c"><TD CLASS="l">3478</TD><TD>                keys[i] = iter.next();</TD></TR><TR><TD CLASS="l">3479</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">3480</TD><TD>            return keys;</TD></TR><TR><TD CLASS="l">3481</TD><TD>        }</TD></TR><TR><TD CLASS="l">3482</TD><TD>    }</TD></TR><TR><TD CLASS="l">3483</TD><TD> </TD></TR><TR><TD CLASS="l">3484</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3485</TD><TD>     * Dumps the contents of the derivativesByUnderlying Map</TD></TR><TR><TD CLASS="l"><A NAME="8b">3486</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">3487</TD><TD>     */</TD></TR><TR><TD CLASS="l">3488</TD><TD>    public void dumpDerivativeByUnderlyingMap()</TD></TR><TR><TD CLASS="l">3489</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">3490</TD><TD>        StringBuffer sb = new StringBuffer();</TD></TR><TR CLASS="c"><TD CLASS="l">3491</TD><TD>        sb.append(&#34;dumping derivativesByUnderlying...\n&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">3492</TD><TD>        Set keySet = derivativesByUnderlying.keySet();</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="88% line coverage (23 out of 26 instructions)">3493</TD><TD TITLE="88% line coverage (23 out of 26 instructions)">        synchronized(keySet)</TD></TR><TR><TD CLASS="l">3494</TD><TD>        {</TD></TR><TR CLASS="c"><TD CLASS="l">3495</TD><TD>            Iterator &lt;Integer&gt; iter = keySet.iterator();</TD></TR><TR CLASS="c"><TD CLASS="l">3496</TD><TD>            while (iter.hasNext())</TD></TR><TR><TD CLASS="l">3497</TD><TD>            {</TD></TR><TR CLASS="c"><TD CLASS="l">3498</TD><TD>                int key = iter.next();</TD></TR><TR CLASS="c"><TD CLASS="l">3499</TD><TD>                List &lt;TradingClass&gt; tradingClassList = derivativesByUnderlying.get(key);</TD></TR><TR CLASS="c"><TD CLASS="l">3500</TD><TD>                for (TradingClass tradingClass : tradingClassList)</TD></TR><TR><TD CLASS="l">3501</TD><TD>                {</TD></TR><TR CLASS="c"><TD CLASS="l">3502</TD><TD>                    sb.append(&#34;underlyingProductKey = &#34; + key + &#34;, derivativeClass = &#34; + tradingClass.getProductClassKey() +</TD></TR><TR CLASS="c"><TD CLASS="l">3503</TD><TD>                            &#34; - &#34; + tradingClass.getClassSymbol() + &#34; - &#34; + tradingClass.getProductType() + &#34; - &#34; + tradingClass.getSessionName() + &#34;\n&#34;);</TD></TR><TR><TD CLASS="l">3504</TD><TD>                }</TD></TR><TR><TD CLASS="l">3505</TD><TD>            }</TD></TR><TR><TD CLASS="l">3506</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">3507</TD><TD>        Log.information(this, sb.toString());</TD></TR><TR CLASS="c"><TD CLASS="l">3508</TD><TD>    }</TD></TR><TR><TD CLASS="l">3509</TD><TD> </TD></TR><TR><TD CLASS="l">3510</TD><TD> </TD></TR><TR><TD CLASS="l">3511</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3512</TD><TD>     * accepts the underling product state originally from XTP-BC and decides</TD></TR><TR><TD CLASS="l"><A NAME="87">3513</A></TD><TD>     * if we need to open the derivative products or just ignore the message.</TD></TR><TR><TD CLASS="l">3514</TD><TD>     */</TD></TR><TR><TD CLASS="l">3515</TD><TD>    public void acceptUnderlyingProductState(int underlyingProductKey, short underlyingProductState)</TD></TR><TR><TD CLASS="l">3516</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">3517</TD><TD>        if (!FoundationFramework.getInstance().isMaster())</TD></TR><TR><TD CLASS="l">3518</TD><TD>        {</TD></TR><TR><TD CLASS="l">3519</TD><TD>            // no processing is needed as of yet</TD></TR><TR CLASS="c"><TD CLASS="l">3520</TD><TD>            return;</TD></TR><TR><TD CLASS="l">3521</TD><TD>        }</TD></TR><TR><TD CLASS="l">3522</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3523</TD><TD>        if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">3524</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3525</TD><TD>            Log.debug(this,&#34;Underlying state change received for underlyingProductKey/state: &#34; + underlyingProductKey + &#34;/&#34; + underlyingProductState);</TD></TR><TR><TD CLASS="l">3526</TD><TD>        }</TD></TR><TR><TD CLASS="l">3527</TD><TD> </TD></TR><TR><TD CLASS="l">3528</TD><TD>        // Ignore product state change requests that are not open or halt states.</TD></TR><TR CLASS="z"><TD CLASS="l">3529</TD><TD>        if (underlyingProductState != ProductStates.OPEN &amp;&amp; underlyingProductState != ProductStates.HALTED)</TD></TR><TR><TD CLASS="l">3530</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3531</TD><TD>            if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">3532</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3533</TD><TD>                Log.debug(this,&#34;Process Underlying state change : Derivative products will not change state as underlying is not &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">3534</TD><TD>                        &#34;halted or in open state for underlyingProductKey/state: &#34; + underlyingProductKey + &#34;/&#34; + underlyingProductState);</TD></TR><TR><TD CLASS="l">3535</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3536</TD><TD>            return;</TD></TR><TR><TD CLASS="l">3537</TD><TD>        }</TD></TR><TR><TD CLASS="l">3538</TD><TD> </TD></TR><TR><TD CLASS="l">3539</TD><TD>        // Get all derivative products affected by this underlying update</TD></TR><TR CLASS="z"><TD CLASS="l">3540</TD><TD>        List &lt;TradingClass&gt; derivativeClasses = derivativesByUnderlying.get(underlyingProductKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3541</TD><TD>        if (derivativeClasses == null)   // (This does happen in real life, hopefully.)</TD></TR><TR><TD CLASS="l">3542</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3543</TD><TD>            Log.information(this, &#34;Received state change for product that has no derivatives &#34; + underlyingProductKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3544</TD><TD>            return;</TD></TR><TR><TD CLASS="l">3545</TD><TD>        }</TD></TR><TR><TD CLASS="l">3546</TD><TD> </TD></TR><TR><TD CLASS="l">3547</TD><TD>        // Go through the list of derivatives for this underlying product.</TD></TR><TR><TD CLASS="l">3548</TD><TD>        // we want to do options opening first then strategy</TD></TR><TR CLASS="z"><TD CLASS="l">3549</TD><TD>        for (TradingClass tradingClass : derivativeClasses)</TD></TR><TR><TD CLASS="l">3550</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3551</TD><TD>            if (tradingClass.getProductType() != ProductTypes.STRATEGY &amp;&amp; !tradingClass.isProxy())</TD></TR><TR><TD CLASS="l">3552</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3553</TD><TD>                processStateChangeForDerivative(tradingClass, underlyingProductKey, underlyingProductState);</TD></TR><TR><TD CLASS="l">3554</TD><TD>            }</TD></TR><TR><TD CLASS="l">3555</TD><TD>        }</TD></TR><TR><TD CLASS="l">3556</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3557</TD><TD>        for (TradingClass tradingClass : derivativeClasses)</TD></TR><TR><TD CLASS="l">3558</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3559</TD><TD>            if (tradingClass.getProductType() == ProductTypes.STRATEGY &amp;&amp; !tradingClass.isProxy())</TD></TR><TR><TD CLASS="l">3560</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3561</TD><TD>                processStateChangeForDerivative(tradingClass, underlyingProductKey, underlyingProductState);</TD></TR><TR><TD CLASS="l">3562</TD><TD>            }</TD></TR><TR><TD CLASS="l">3563</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3564</TD><TD>    }</TD></TR><TR><TD CLASS="l">3565</TD><TD> </TD></TR><TR><TD CLASS="l">3566</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3567</TD><TD>     * Process a state change for each derivative</TD></TR><TR><TD CLASS="l">3568</TD><TD>     * @param p_tradingClass - Class that might require state change</TD></TR><TR><TD CLASS="l">3569</TD><TD>     * @param p_underlyingProductKey - the key of the underlying product</TD></TR><TR><TD CLASS="l">3570</TD><TD>     * @param p_underlyingProductState - state of the underlying product</TD></TR><TR><TD CLASS="l">3571</TD><TD>     */</TD></TR><TR><TD CLASS="l">3572</TD><TD>    private void processStateChangeForDerivative(TradingClass p_tradingClass, int p_underlyingProductKey, short p_underlyingProductState)</TD></TR><TR><TD CLASS="l"><A NAME="5a">3573</A></TD><TD>    {</TD></TR><TR><TD CLASS="l">3574</TD><TD>        // Before a class can be open, at least one of the products</TD></TR><TR><TD CLASS="l">3575</TD><TD>        // must be in the preopen state.  If they are not then ignore</TD></TR><TR><TD CLASS="l">3576</TD><TD>        // the request</TD></TR><TR CLASS="z"><TD CLASS="l">3577</TD><TD>        short checkProductState = -1;  // -1 means no check is needed</TD></TR><TR CLASS="z"><TD CLASS="l">3578</TD><TD>        short newState = -1;</TD></TR><TR><TD CLASS="l">3579</TD><TD>        //Changes for CFLEX</TD></TR><TR><TD CLASS="l">3580</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3581</TD><TD>        if (p_underlyingProductState == ProductStates.OPEN &amp;&amp; enableProductStateChangeByUnderlying)</TD></TR><TR><TD CLASS="l">3582</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3583</TD><TD>            checkProductState = ProductStates.PRE_OPEN;</TD></TR><TR CLASS="z"><TD CLASS="l">3584</TD><TD>            newState = ProductStates.OPENING_ROTATION;</TD></TR><TR><TD CLASS="l">3585</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3586</TD><TD>        else if (p_underlyingProductState == ProductStates.HALTED)</TD></TR><TR><TD CLASS="l">3587</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3588</TD><TD>            newState = ProductStates.HALTED;</TD></TR><TR><TD CLASS="l">3589</TD><TD>        }</TD></TR><TR><TD CLASS="l">3590</TD><TD> </TD></TR><TR><TD CLASS="l">3591</TD><TD>        // Do not automatically open products if we are in a SUSPENDED state.</TD></TR><TR CLASS="z"><TD CLASS="l">3592</TD><TD>        if (p_tradingClass.getInternalState() == ClassStates.SUSPENDED)</TD></TR><TR><TD CLASS="l">3593</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3594</TD><TD>            Log.information(this, &#34;Prevented state change on underlying tick for underlyingProductKey/derivativeClassKey [&#34; + + p_underlyingProductKey + &#34;/&#34; + p_tradingClass.getProductClassKey() + &#34;] (&#34; + p_tradingClass.getClassSymbol()</TD></TR><TR CLASS="z"><TD CLASS="l">3595</TD><TD>                        + &#34;-&#34; + p_tradingClass.getProductType() + &#34;) since this class is currently in a SUSPENDED state.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3596</TD><TD>            return;</TD></TR><TR><TD CLASS="l">3597</TD><TD>        }</TD></TR><TR><TD CLASS="l">3598</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3599</TD><TD>        if (!areProductsInStateForOpeningRequest(p_tradingClass, newState, checkProductState))</TD></TR><TR><TD CLASS="l">3600</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3601</TD><TD>            Log.information(this, &#34;Prevented state change to &#34; + productStatesMapper.getName(newState) + &#34; on derivatives for underlyingProductKey/derivativeClassKey [&#34; + p_underlyingProductKey + &#34;/&#34; + p_tradingClass.getProductClassKey() + &#34;] (&#34; + p_tradingClass.getClassSymbol()</TD></TR><TR CLASS="z"><TD CLASS="l">3602</TD><TD>                    + &#34;-&#34; + p_tradingClass.getProductType() + &#34;) because derivative products are not in the state = &#34; + productStatesMapper.getName(checkProductState));</TD></TR><TR CLASS="z"><TD CLASS="l">3603</TD><TD>            return;</TD></TR><TR><TD CLASS="l">3604</TD><TD>        }</TD></TR><TR><TD CLASS="l">3605</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3606</TD><TD>        if (isHaltRequestWhileDerivativeIsInPreOpenState(p_tradingClass, newState))</TD></TR><TR><TD CLASS="l">3607</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3608</TD><TD>            Log.information(this, &#34;Prevented HALT state change for underlyingProductKey/derivativeClassKey [&#34; + p_underlyingProductKey + &#34;/&#34; + p_tradingClass.getProductClassKey() + &#34;] (&#34; + p_tradingClass.getClassSymbol()</TD></TR><TR CLASS="z"><TD CLASS="l">3609</TD><TD>                    + &#34;-&#34; + p_tradingClass.getProductType() + &#34;) because derivative is in Pre-Open State&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3610</TD><TD>            return;</TD></TR><TR><TD CLASS="l">3611</TD><TD>        }</TD></TR><TR><TD CLASS="l">3612</TD><TD> </TD></TR><TR><TD CLASS="l">3613</TD><TD>        // Notify local service of state change</TD></TR><TR><TD CLASS="l">3614</TD><TD>        try</TD></TR><TR><TD CLASS="l">3615</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3616</TD><TD>            Log.information(this,&#34;:processStateChangeForDerivative: changing product state to &#34; + productStatesMapper.getName(newState) + &#34; based on underlyingProductKey [&#34; + p_underlyingProductKey + &#34;] for session/class/productType: &#34; + p_tradingClass.getSessionName() + &#34;/&#34;+ p_tradingClass.getProductClassKey() + &#34;(&#34; + p_tradingClass.getClassSymbol() + &#34;)&#34; + &#34;/&#34; + p_tradingClass.getProductType());</TD></TR><TR CLASS="z"><TD CLASS="l">3617</TD><TD>            setProductStateByClassLocal(p_tradingClass.getSessionName(), p_tradingClass.getProductClassKey(), newState);</TD></TR><TR CLASS="z"><TD CLASS="l">3618</TD><TD>        } catch (Exception ex)</TD></TR><TR><TD CLASS="l">3619</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3620</TD><TD>            Log.exception(this, &#34;ERROR processingStateChangeForDerivative to &#34; + productStatesMapper.getName(newState) + &#34; for derivativeClassKey &#34; + p_tradingClass.getProductClassKey()</TD></TR><TR CLASS="z"><TD CLASS="l">3621</TD><TD>                    + &#34;, derivativeClassSymbol &#34; + p_tradingClass.getClassSymbol() + &#34;, sessionName &#34; + p_tradingClass.getSessionName(), ex);</TD></TR><TR><TD CLASS="l">3622</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3623</TD><TD>    }</TD></TR><TR><TD CLASS="l">3624</TD><TD> </TD></TR><TR><TD CLASS="l">3625</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3626</TD><TD>     * Checks to see if all the given request requires a specific product state.</TD></TR><TR><TD CLASS="l">3627</TD><TD>     * All the products need to be in that state before proceeding.</TD></TR><TR><TD CLASS="l">3628</TD><TD>     * @param p_tradingClass</TD></TR><TR><TD CLASS="l">3629</TD><TD>     * @param p_newState</TD></TR><TR><TD CLASS="l">3630</TD><TD>     * @param p_checkState</TD></TR><TR><TD CLASS="l"><A NAME="2b">3631</A></TD><TD>     * @return</TD></TR><TR><TD CLASS="l">3632</TD><TD>     */</TD></TR><TR><TD CLASS="l">3633</TD><TD>    private boolean areProductsInStateForOpeningRequest(TradingClass p_tradingClass, short p_newState, short p_checkState)</TD></TR><TR><TD CLASS="l">3634</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3635</TD><TD>        if (p_checkState != -1)</TD></TR><TR><TD CLASS="l">3636</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3637</TD><TD>            TradingProduct [] tradingProducts = p_tradingClass.getProducts(true);</TD></TR><TR CLASS="z"><TD CLASS="l">3638</TD><TD>            for (TradingProduct tradingProduct : tradingProducts)</TD></TR><TR><TD CLASS="l">3639</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3640</TD><TD>                if(tradingProduct.isBuyWrite())</TD></TR><TR><TD CLASS="l">3641</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3642</TD><TD>                    if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">3643</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">3644</TD><TD>                        Log.debug(this, &#34;Ignoring product state of BUY-WRITE for opening.&#34;);</TD></TR><TR><TD CLASS="l">3645</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3646</TD><TD>                }</TD></TR><TR><TD CLASS="l">3647</TD><TD>                else</TD></TR><TR><TD CLASS="l">3648</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3649</TD><TD>                    short currentState = tradingProduct.getCurrentStateCode();</TD></TR><TR CLASS="z"><TD CLASS="l">3650</TD><TD>                    if (p_checkState != currentState)</TD></TR><TR><TD CLASS="l">3651</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">3652</TD><TD>                        if ( tradingProduct.isStrategy() &amp;&amp;</TD></TR><TR CLASS="z"><TD CLASS="l">3653</TD><TD>                             ((currentState == ProductStates.ON_HOLD) ||</TD></TR><TR CLASS="z"><TD CLASS="l">3654</TD><TD>                              (currentState == ProductStates.PRE_OPEN) ||</TD></TR><TR CLASS="z"><TD CLASS="l">3655</TD><TD>                              (currentState == ProductStates.OPENING_ROTATION) ||</TD></TR><TR CLASS="z"><TD CLASS="l">3656</TD><TD>                              (currentState == ProductStates.NO_SESSION)))</TD></TR><TR><TD CLASS="l">3657</TD><TD>                        {</TD></TR><TR><TD CLASS="l">3658</TD><TD>                            // We should be able to open the strategies.</TD></TR><TR CLASS="z"><TD CLASS="l">3659</TD><TD>                            if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">3660</TD><TD>                            {</TD></TR><TR CLASS="z"><TD CLASS="l">3661</TD><TD>                                Log.debug(this,&#34;Strategy product currently in state &#34; + productStatesMapper.getName(currentState) + &#34; for productKey =  &#34; + tradingProduct.getProductKey());</TD></TR><TR><TD CLASS="l">3662</TD><TD>                            }</TD></TR><TR><TD CLASS="l">3663</TD><TD>                        }</TD></TR><TR><TD CLASS="l">3664</TD><TD>                        else</TD></TR><TR><TD CLASS="l">3665</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">3666</TD><TD>                            Log.information(this, &#34;Derivative product [&#34; + tradingProduct.getProductKey() + &#34;] in state: &#34; + productStatesMapper.getName(currentState)</TD></TR><TR CLASS="z"><TD CLASS="l">3667</TD><TD>                                    + &#34;. Expecting: &#34; + productStatesMapper.getName(p_checkState) + &#34;.&#34; );</TD></TR><TR CLASS="z"><TD CLASS="l">3668</TD><TD>                            return false;</TD></TR><TR><TD CLASS="l">3669</TD><TD>                        }</TD></TR><TR><TD CLASS="l">3670</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3671</TD><TD>                }</TD></TR><TR><TD CLASS="l">3672</TD><TD>            }</TD></TR><TR><TD CLASS="l">3673</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3674</TD><TD>        return true;</TD></TR><TR><TD CLASS="l">3675</TD><TD>    }</TD></TR><TR><TD CLASS="l">3676</TD><TD> </TD></TR><TR><TD CLASS="l">3677</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3678</TD><TD>     * Checks to see if the trading class is in preopen state when</TD></TR><TR><TD CLASS="l">3679</TD><TD>     * a HALTED state comes in from the underlying.</TD></TR><TR><TD CLASS="l">3680</TD><TD>     * @param p_tradingClass</TD></TR><TR><TD CLASS="l">3681</TD><TD>     * @param p_newState</TD></TR><TR><TD CLASS="l"><A NAME="51">3682</A></TD><TD>     * @return</TD></TR><TR><TD CLASS="l">3683</TD><TD>     */</TD></TR><TR><TD CLASS="l">3684</TD><TD>    private boolean isHaltRequestWhileDerivativeIsInPreOpenState(TradingClass p_tradingClass, short p_newState)</TD></TR><TR><TD CLASS="l">3685</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3686</TD><TD>        if (p_newState != ProductStates.HALTED)</TD></TR><TR><TD CLASS="l">3687</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3688</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">3689</TD><TD>        }</TD></TR><TR><TD CLASS="l">3690</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3691</TD><TD>        if (p_tradingClass.getGlobalState() == ClassStates.PRE_OPEN)</TD></TR><TR><TD CLASS="l">3692</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3693</TD><TD>            Log.information(this, &#34;Derivative classKey/symbol: &#34; + p_tradingClass.getProductClassKey() + &#34;/&#34; + p_tradingClass.getClassSymbol() + &#34;&#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">3694</TD><TD>                    &#34; cannot change to HALTED state since this class is currently in &#34; + classStatesMapper.getName(p_tradingClass.getGlobalState()) + &#34;.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3695</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">3696</TD><TD>        }</TD></TR><TR><TD CLASS="l">3697</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3698</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">3699</TD><TD>    }</TD></TR><TR><TD CLASS="l">3700</TD><TD> </TD></TR><TR><TD CLASS="l">3701</TD><TD>    @Override</TD></TR><TR><TD CLASS="l"><A NAME="59">3702</A></TD><TD>    public void postInitialize() throws FatalFoundationFrameworkException</TD></TR><TR><TD CLASS="l">3703</TD><TD>    {</TD></TR><TR><TD CLASS="l">3704</TD><TD>        // TODO Auto-generated method stub</TD></TR><TR><TD CLASS="l">3705</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="8e">3706</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3707</TD><TD> </TD></TR><TR><TD CLASS="l">3708</TD><TD>    public void postStart() throws FatalFoundationFrameworkException</TD></TR><TR><TD CLASS="l">3709</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">3710</TD><TD>        assertNotNull(cachedOrderBookHome, &#34;OrderBookHome&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">3711</TD><TD>        assertNotNull(productDataCacheHome, &#34;ProductDataCacheHome&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">3712</TD><TD>        assertNotNull(brokerHome, &#34;BrokerHome&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">3713</TD><TD>        assertNotNull(cachedTradingClassHome, &#34;TradingClassHome&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">3714</TD><TD>        assertNotNull(cachedTradingProductHome, &#34;TradingProductHome&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">3715</TD><TD>        assertNotNull(cachedMarketDataHome, &#34;MarketDataHome&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">3716</TD><TD>        assertNotNull(theTradingSessionService, &#34;TradingSessionService&#34;);</TD></TR><TR><TD CLASS="l">3717</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">3718</TD><TD>        derivativesByUnderlying = new ConcurrentIntHashMap &lt;List&gt; (underlyingMapSize);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="88">3719</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3720</TD><TD> </TD></TR><TR><TD CLASS="l">3721</TD><TD>    private void assertNotNull(final Object p_ref, final String p_name)</TD></TR><TR><TD CLASS="l">3722</TD><TD>    throws FatalFoundationFrameworkException {</TD></TR><TR CLASS="c"><TD CLASS="l">3723</TD><TD>        if (p_ref == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3724</TD><TD>            throw new FatalFoundationFrameworkException(msg().add(p_name).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3725</TD><TD>            &#34; reference is null!&#34;).end());</TD></TR><TR><TD CLASS="l">3726</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="56">3727</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3728</TD><TD>    </TD></TR><TR><TD CLASS="l">3729</TD><TD>    private void populateTradingClassSessionElementMap(TradingSessionElementStruct[] tse)</TD></TR><TR><TD CLASS="l">3730</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3731</TD><TD>            for(TradingSessionElementStruct tradingSessionElementStruct : tse){</TD></TR><TR CLASS="z"><TD CLASS="l">3732</TD><TD>                    for(SessionClassStruct sessionClassStruct : tradingSessionElementStruct.elementClasses ){</TD></TR><TR CLASS="z"><TD CLASS="l">3733</TD><TD>                            tradingClassSessionElementMap.put(sessionClassStruct.classStruct.classKey, tradingSessionElementStruct);</TD></TR><TR><TD CLASS="l">3734</TD><TD>                    }</TD></TR><TR><TD CLASS="l"><A NAME="4b">3735</A></TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3736</TD><TD>    }</TD></TR><TR><TD CLASS="l">3737</TD><TD> </TD></TR><TR><TD CLASS="l">3738</TD><TD>        public HashMap&lt;Integer, TradingSessionElementStruct&gt; getTradingClassSessionElementMap() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="4d">3739</A></TD><TD>                return tradingClassSessionElementMap;</TD></TR><TR><TD CLASS="l">3740</TD><TD>        }</TD></TR><TR><TD CLASS="l">3741</TD><TD> </TD></TR><TR><TD CLASS="l">3742</TD><TD>        public TradingSessionElementStruct getTradingSessionElementStructForClass(int classKey) {</TD></TR><TR CLASS="z"><TD CLASS="l">3743</TD><TD>                TradingSessionElementStruct tse = null;</TD></TR><TR CLASS="z"><TD CLASS="l">3744</TD><TD>                HashMap&lt;Integer, TradingSessionElementStruct&gt; tseMap = getTradingClassSessionElementMap();</TD></TR><TR><TD CLASS="l">3745</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">3746</TD><TD>                if(tseMap != null &amp;&amp; tseMap.size() &gt; 0)</TD></TR><TR><TD CLASS="l">3747</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3748</TD><TD>                        tse = tseMap.get(classKey);</TD></TR><TR><TD CLASS="l">3749</TD><TD>                }</TD></TR><TR><TD CLASS="l">3750</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">3751</TD><TD>                return tse;</TD></TR><TR><TD CLASS="l">3752</TD><TD>                </TD></TR><TR><TD CLASS="l">3753</TD><TD>        }</TD></TR><TR><TD CLASS="l">3754</TD><TD> </TD></TR><TR><TD CLASS="l">3755</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="nv">[<A HREF="../Coverage.html">all classes</A>][<A HREF="72.html">com.cboe.internalBusinessServices.productStateService</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://www.eclemma.org/support.html">EMMA 2.0.5312 EclEmma Fix 2</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>