<HTML><HEAD><META CONTENT="text/html; charset=UTF-8" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="tl"><A HREF="http://www.eclemma.org/">EMMA</A> Coverage Report (generated Mon Aug 01 06:28:17 CDT 2011)</TH></TR><TR><TD CLASS="nv">[<A HREF="../Coverage.html">all classes</A>][<A HREF="74.html">com.cboe.businessServices.orderRoutingDestination</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">OrderHomeImpl.java</SPAN>]</H2><TABLE CELLSPACING="0" WIDTH="100%"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>OrderHomeImpl.java</TD><TD CLASS="h">25%  (1/4)</TD><TD CLASS="h">1%   (2/203)</TD><TD CLASS="h">0%   (13/8200)</TD><TD CLASS="h">0%   (8/2061)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">OrderHomeImpl$1</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#0">OrderHomeImpl$1 (OrderHomeImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">compare (Order, Order): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">OrderHomeImpl$2</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#0">OrderHomeImpl$2 (OrderHomeImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5">compare (Order, Order): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">OrderHomeImpl$3</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/38)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#0">OrderHomeImpl$3 (OrderHomeImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">compare (Order, Order): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#9">OrderHomeImpl</A></TD><TD>100% (1/1)</TD><TD CLASS="h">1%   (2/197)</TD><TD CLASS="h">0%   (13/8102)</TD><TD CLASS="h">0%   (8/2039)</TD></TR><TR><TD CLASS="f"><A HREF="#a">OrderHomeImpl (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/42)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#b">addOrderToCache (OrderImpl): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/162)</TD><TD CLASS="h">0%   (0/32)</TD></TR><TR><TD CLASS="f"><A HREF="#c">addPOrPAOrderToList (OrderIdStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#d">addSatisfactionOrderToList (OrderIdStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#e">adminPrintOrder (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/109)</TD><TD CLASS="h">0%   (0/27)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#f">adminPrintOrderStatistics (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/50)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR><TD CLASS="f"><A HREF="#10">allowUseClearingAcronymConfigured (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#11">blankAccountIfSameAsAcr (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#12">buildMSGOrderStruct (Order, String, String, int, PriceStruct, boolean): Order...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/178)</TD><TD CLASS="h">0%   (0/51)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#13">buildMSGOrderStruct (Order, String, int, boolean): OrderStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#14">buildManualQuoteFromExtensions (OrderHandlingStruct, String): ManualQuote</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/52)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#15">buildMarketDetailStructFromCurrentMarketStruct (CurrentMarketStruct [], NBBOS...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/162)</TD><TD CLASS="h">0%   (0/35)</TD></TR><TR><TD CLASS="f"><A HREF="#16">buildMarketDetailStructFromMarketData (MarketData, DerivedQuote, short): Mark...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/250)</TD><TD CLASS="h">0%   (0/50)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#17">buildMarketDetailStructs (String, CancelReportStruct []): MarketDetailStruct []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#18">buildMarketDetailStructs (String, FilledReportStruct []): MarketDetailStruct []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#19">buildMarketDetailStructs (String, int []): MarketDetailStruct []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/163)</TD><TD CLASS="h">0%   (0/40)</TD></TR><TR><TD CLASS="f"><A HREF="#1a">buildOrderStructForSatisfaction (Order, String, int): OrderStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1b">buildThreadName (int): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1c">cancelOrdersOnOHS (OrderIdStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/58)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1d">cancelQuoteLikeOrders (String, boolean, short): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/89)</TD><TD CLASS="h">0%   (0/20)</TD></TR><TR><TD CLASS="f"><A HREF="#1e">checkAndSetValuesForTpfRentrantOrder (Order, Long, Order): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/29)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1f">checkForNoMatch (StringBuffer): StringBuffer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#20">checkIfValidCriteria (String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#21">cleanupForSlowFailover (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#22">clearOrderCollections (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#23">create (OrderHandlingStruct): Order</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#24">create (OrderHandlingStruct, OrderHandlingStruct): Cross</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#25">createBaseOrder (OrderHandlingStruct): OrderImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/71)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR><TD CLASS="f"><A HREF="#26">createCrossForExistingOrder (Order, Order, boolean, boolean): Cross</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#27">createCrossForExistingOrder (Order, OrderStruct, boolean, boolean): Cross</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#28">createCrossOnExistingOrders (Order, Order, boolean): Cross</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/36)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#29">createForBust (OrderHandlingStruct): Order</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#2a">createHeldOrderCross (Order, String, boolean, String, FilledReportStruct): Cross</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/68)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2b">createLegDetailsForOrder (OrderImpl, OrderHandlingStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/19)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#2c">createLegDetailsForOrderBust (OrderImpl, OrderHandlingStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/19)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2d">createLinkageOrder (Order, String, int, Price, String): Order</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/250)</TD><TD CLASS="h">0%   (0/83)</TD></TR><TR><TD CLASS="f"><A HREF="#2e">createLongPrice (Price): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/8)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2f">createLongPrice (PriceStruct): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#30">createNBBOMinSizeCross (Order, String, int): Cross</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/18)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#31">createOrders (OrderHandlingStructV2 []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#32">createOrdersForV2 (OrderHandlingStructV2 []): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/125)</TD><TD CLASS="h">0%   (0/32)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#33">deleteFromCache (List): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/21)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#34">deleteOrderFromCache (Order): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/88)</TD><TD CLASS="h">0%   (0/22)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#35">fetchOrdersFromOHS (OrderRoutingParameterStruct, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/14)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#36">findActiveMarketOrders (): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/35)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#37">findActivePAOrders (): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/132)</TD><TD CLASS="h">0%   (0/33)</TD></TR><TR><TD CLASS="f"><A HREF="#38">findActiveSatisfactionOrders (): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/129)</TD><TD CLASS="h">0%   (0/33)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#39">findClassesWithQuoteLikeOrderFromUser (String): IntMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/86)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR><TD CLASS="f"><A HREF="#3a">findLegDetailsForOrder (OrderImpl): LegOrderDetailImpl []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3b">findOrder (OrderIdStruct): Order</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#3c">findOrder (String, int, CboeIdStruct): Order</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/38)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3d">findOrder (long): Order</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/18)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#3e">findOrdersCountForARCommand (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/86)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3f">findOrdersForProduct (int): OrderCommon []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#40">findOrdersForProduct (int, boolean): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/57)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#41">findOrdersForProduct (int, boolean, ArrayList, ArrayList): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/122)</TD><TD CLASS="h">0%   (0/27)</TD></TR><TR><TD CLASS="f"><A HREF="#42">findPendingContingentOrders (short): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#43">findPendingOrders (short [], boolean): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/54)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR><TD CLASS="f"><A HREF="#44">findPendingStopOrders (): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#45">findQuoteLikeOrdersForProduct (int): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#46">findQuoteLikeOrdersForUser (String): Order []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/63)</TD><TD CLASS="h">0%   (0/20)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#47">getAllOrderCount (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#48">getAllOrderCountForSync (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#49">getAnonymousIfNotClearsLikeQuoteBroker (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#4a">getBQStructExchangeDetailsAsString (BestQuote, char): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4b">getBQStructExchangeDetailsAsString (NBBOStruct, char): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#4c">getBrokerService (): BrokerService</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4d">getCancelReportChannelSelectorHome (): CancelReportChannelSelectorHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#4e">getClearingFirmNumForLinkageFill (FilledReportStruct): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4f">getClearsLikeQuoteOriginCodes (String): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#50">getConfiguredSessions (): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/21)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#51">getCustomerTypeOriginCodesForBobClasses (): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#52">getExchangeVolume (ExchangeVolumeStruct []): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/43)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#53">getExecutingBroker (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#54">getExtOrderStatusPublisher (): OrderStatusConsumer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#55">getIPPMinSizeProcessingIndicator (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#56">getIntermarketOrderStatusPublisher (): IntermarketOrderStatusConsumer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#57">getInternalOrderStatusPublisher (): InternalOrderStatusConsumer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#58">getInternalOrderStatusPublisher (Order, short): InternalOrderStatusConsumer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/8)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#59">getInternalizationAuctionTradeBroker (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#5a">getIppProcessingStrategy (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5b">getLegOrderDetailHome (): LegOrderDetailHomeImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#5c">getLocationId (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/72)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5d">getManualQuoteContraOrderBroker (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#5e">getMarketAlertPublisher (): MarketAlertConsumer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5f">getMarketDataHome (): MarketDataHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#60">getMarketDataService (): MarketDataService</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#61">getMarketSizeOnSide (MarketVolumeStruct [], boolean): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/29)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#62">getMaxProductsToSendPerCallToOHS (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#63">getMaxRetriesOfNBBOProtectionRouting (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#64">getMaxSleepTimeBeforeOHSCall (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#65">getNBBOMSGOrderBranch (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#66">getNextSeqNumForNBBOMSGOrder (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#67">getNextSeqNumForSatisfySatisfactionOrder (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/28)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#68">getORParamsStruct (): OrderRoutingParameterStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#69">getOrderBook (int): OrderBook</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#6a">getOrderBookHome (): OrderBookHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6b">getOrderBookServiceHome (): OrderBookServiceLocalHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#6c">getOrderFromCache (long): OrderImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6d">getOrderFromOHS (String, int, CboeIdStruct): OrderImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/55)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR><TD CLASS="f"><A HREF="#6e">getOrderFromOHSForBust (String, int, CboeIdStruct): Order</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/55)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6f">getOrderHistoryHome (): OrderHistoryHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/31)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#70">getOrderIdGeneratorHome (): OrderIdGeneratorHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/31)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#71">getOrderMaintenanceServiceHome (): OHSOrderMaintenanceServiceHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/31)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR><TD CLASS="f"><A HREF="#72">getOrderMarketMonitoringService (): OrderMarketMonitoringService</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#73">getOrderQueryService (): OrderQueryService</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#74">getOrderSortTime (Order): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/18)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#75">getOrderStatusPublisher (): OrderStatusConsumer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#76">getOrderSync (): OrderSync</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#77">getOrderSyncHome (): OrderSyncHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#78">getOutboundVendorForLinkageFill (FilledReportStruct): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#79">getPreferedRouterVendor (OrderStruct): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#7a">getPrintingString (String, String []): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7b">getProductDataCacheHome (): ProductDataCacheHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/38)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#7c">getProductsForClasses (): int []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/8)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7d">getProfile (SessionProfileUserStruct, int, String): SessionProfileStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/75)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR><TD CLASS="f"><A HREF="#7e">getPropertyServiceFacade (): PropertyServiceFacade</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7f">getReserveOrderRefreshSize (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#80">getSalableCodes (): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#81">getSatisfySatisfactionOrderBranch (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#82">getShortSaleTriggeredMode (String, int): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/28)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#83">getSide (OrderStruct): char</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#84">getTotalNumberOfOrderLoadingThreads (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#85">getTotalOrderRemainingQuantity (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#86">getTradeAndShipCodes (): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#87">getTradingClassHome (): TradingClassHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#88">getTradingProductHome (): TradingProductHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#89">getTradingSessionService (): TradingSessionServiceLocal</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/48)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR><TD CLASS="f"><A HREF="#8a">getTransientInternalOrderStatusPublisher (): InternalOrderStatusConsumer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8b">getTreatedLikeQuoteOriginCodes (String): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#8c">getTrimmedFilledReports (FilledReportStruct []): FilledReportStruct []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/214)</TD><TD CLASS="h">0%   (0/29)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8d">getTrimmedOrder (Order): OrderStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/35)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#8e">getUserService (): UserService</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8f">goMaster (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/80)</TD><TD CLASS="h">0%   (0/21)</TD></TR><TR><TD CLASS="f"><A HREF="#90">goSlave (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/40)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#91">initialize (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/559)</TD><TD CLASS="h">0%   (0/168)</TD></TR><TR><TD CLASS="f"><A HREF="#92">initializeBrokerService (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#93">initializeCancelOnFailoverCloseHaltLogOutCodes (Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#94">initializeClearsLikeQuoteConfiguration (Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/56)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#95">initializeClearsLikeQuoteDetailConfiguration (String, Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/45)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR><TD CLASS="f"><A HREF="#96">initializeCustomerCodesConfiguration (Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#97">initializeCustomerTypeOriginCodesForBobClasses (Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#98">initializeEmitPoints (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#99">initializeIppProcessingConfiguration (String, Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/63)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR><TD CLASS="f"><A HREF="#9a">initializeLightOrderProperties (Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/65)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#9b">initializeMarketAlertOnOriginCodesConfiguration (Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR><TD CLASS="f"><A HREF="#9c">initializeNBBOMinSizeGuaranteeOrderSeqNum (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/45)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#9d">initializeNbboFlashCodesConfiguration (Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#9e">initializeQuoteLockProcessingConfiguration (String, Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/45)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#9f">initializeReserveOrderRefreshSizeConfiguration (Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#a0">initializeSalableCodesConfiguration (Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/44)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a1">initializeSatisfySatisfactionOrderSeqNum (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/52)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR><TD CLASS="f"><A HREF="#a2">initializeTradeAndShipCodesConfiguration (Configuration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/44)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a3">initpublishCxlReasonCodesForLightOrders (String []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/42)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#a4">isAllowedVolumeType (boolean, short): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a5">isAnonymousTradingIfNotClearsLikeQuote (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#a6">isContingencyInTheList (short, short []): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a7">isGOrder (Order): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#a8">isGOrder (OrderHandlingStruct): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a9">isOrderOriginQuoteLike (char, String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/37)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#aa">isSessionConfigured (String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#ab">loadOrderCache (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/53)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR><TD CLASS="f"><A HREF="#ac">loadOrdersConcurrently (OrderRoutingParameterStruct, int [][], String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/89)</TD><TD CLASS="h">0%   (0/26)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#ad">logCancelOrders (OrderIdStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#ae">persistOrder (OrderStruct): Order</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/72)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#af">persistOrderV2 (OrderRoutingParameterStruct, OrderHandlingStruct, ExchangeAcr...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/49)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR><TD CLASS="f"><A HREF="#b0">populateCurrentMarketStruct (CurrentMarketStruct, CurrentMarketStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/45)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#b1">populateNbboStruct (NBBOStruct, NBBOStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#b2">populateQuoteQueryV2StructFromBook (QuoteQueryV2Struct [], String, int []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/145)</TD><TD CLASS="h">0%   (0/28)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#b3">postSlave (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#b4">printOrderContents (Order, StringBuffer): StringBuffer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/524)</TD><TD CLASS="h">0%   (0/41)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#b5">publishIntermarketCancelReports (Order, CancelReportStruct [], long): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/52)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR><TD CLASS="f"><A HREF="#b6">publishIntermarketFilledReports (Order, FilledReportStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/46)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#b7">queryByBranch (String, OrderImpl, String, StringBuffer): StringBuffer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#b8">queryByClass (String, OrderImpl, String, StringBuffer): StringBuffer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#b9">queryByOrderId (long, OrderImpl, Long, StringBuffer): StringBuffer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#ba">queryByUserId (String, OrderImpl, String, StringBuffer): StringBuffer</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#bb">queryOrder (String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/149)</TD><TD CLASS="h">0%   (0/38)</TD></TR><TR><TD CLASS="f"><A HREF="#bc">rejectLightOrderOrigin (char): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/46)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#bd">setMaxProductsToSendPerCallToOHS (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#be">setMaxSleepTimeBeforeOHSCall (long): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#bf">setSessionDataFromOrderHandlingExtension (Order, NameValueStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/31)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#c0">setTotalNumberOfOrderLoadingThreads (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c1">shouldEchoReports (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#c2">shouldGenerateNBBOFlash (Order): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/38)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c3">shouldOrderClearsLikeQuote (Order): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/40)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR><TD CLASS="f"><A HREF="#c4">shouldOrderClearsLikeQuote (OrderHandlingStruct): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/31)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c5">shouldOrderTreatedLikeQuote (Order): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/39)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR><TD CLASS="f"><A HREF="#c6">shouldOrderTreatedLikeQuote (OrderHandlingStruct): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c7">shouldPublishCxlReportForLightOrder (short): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#c8">shouldPublishMarketAlertOnOriginType (char): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/48)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c9">shouldQOrdersBeCanceledOnHaltCloseLogout (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#ca">shouldTreatedLikeCustomerOrder (Order): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/38)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#cb">testClearCache (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#cc">updateToSync (Order): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#cd">initTradeServerId (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">21%  (7/34)</TD><TD CLASS="h">33%  (4/12)</TD></TR><TR><TD CLASS="f"><A HREF="#9">&lt;static initializer&gt;</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (4/4)</TD></TR></TABLE><P></P><TABLE CLASS="s" CELLSPACING="0" WIDTH="100%"><TR CLASS="z"><TD CLASS="l"><A NAME="0">1</A></TD><TD>package com.cboe.businessServices.orderRoutingDestination;</TD></TR><TR><TD CLASS="l">2</TD><TD> </TD></TR><TR><TD CLASS="l">3</TD><TD>import java.text.ParseException;</TD></TR><TR><TD CLASS="l">4</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">5</TD><TD>import java.util.Arrays;</TD></TR><TR><TD CLASS="l">6</TD><TD>import java.util.Calendar;</TD></TR><TR><TD CLASS="l">7</TD><TD>import java.util.Collection;</TD></TR><TR><TD CLASS="l">8</TD><TD>import java.util.Comparator;</TD></TR><TR><TD CLASS="l">9</TD><TD>import java.util.HashMap;</TD></TR><TR><TD CLASS="l">10</TD><TD>import java.util.Iterator;</TD></TR><TR><TD CLASS="l">11</TD><TD>import java.util.List;</TD></TR><TR><TD CLASS="l">12</TD><TD>import java.util.Map;</TD></TR><TR><TD CLASS="l">13</TD><TD>import java.util.Set;</TD></TR><TR><TD CLASS="l">14</TD><TD>import java.util.concurrent.ConcurrentHashMap;</TD></TR><TR><TD CLASS="l">15</TD><TD> </TD></TR><TR><TD CLASS="l">16</TD><TD>import com.cboe.businessServices.marketMakerQuoteService.ManualQuoteImpl;</TD></TR><TR><TD CLASS="l">17</TD><TD>import com.cboe.businessServices.orderBookService.OrderBookEditor;</TD></TR><TR><TD CLASS="l">18</TD><TD>import com.cboe.businessServices.orderBookService.OrderBookImpl;</TD></TR><TR><TD CLASS="l">19</TD><TD>import com.cboe.businessServices.tradeService.StrategyTradeServiceHelper;</TD></TR><TR><TD CLASS="l">20</TD><TD>import com.cboe.businessServices.util.SimpleDistributor;</TD></TR><TR><TD CLASS="l">21</TD><TD>import com.cboe.domain.marketData.ExchangeIndicatorHolder;</TD></TR><TR><TD CLASS="l">22</TD><TD>import com.cboe.domain.property.PropertyServiceFacadeHome;</TD></TR><TR><TD CLASS="l">23</TD><TD>import com.cboe.domain.util.CboeId;</TD></TR><TR><TD CLASS="l">24</TD><TD>import com.cboe.domain.util.ExtensionsFieldParser;</TD></TR><TR><TD CLASS="l">25</TD><TD>import com.cboe.domain.util.ExtensionsHelper;</TD></TR><TR><TD CLASS="l">26</TD><TD>import com.cboe.domain.util.InternalOrderOriginTypes;</TD></TR><TR><TD CLASS="l">27</TD><TD>import com.cboe.domain.util.InternalOrderStates;</TD></TR><TR><TD CLASS="l">28</TD><TD>import com.cboe.domain.util.MarketDetailStructBuilder;</TD></TR><TR><TD CLASS="l">29</TD><TD>import com.cboe.domain.util.OrderStructBuilder;</TD></TR><TR><TD CLASS="l">30</TD><TD>import com.cboe.domain.util.PriceFactory;</TD></TR><TR><TD CLASS="l">31</TD><TD>import com.cboe.domain.util.PriceSqlType;</TD></TR><TR><TD CLASS="l">32</TD><TD>import com.cboe.domain.util.TradingSessionNameHelper;</TD></TR><TR><TD CLASS="l">33</TD><TD>import com.cboe.domain.util.intMaps.ConcurrentIntHashMap;</TD></TR><TR><TD CLASS="l">34</TD><TD>import com.cboe.domain.util.intMaps.IntHashMap;</TD></TR><TR><TD CLASS="l">35</TD><TD>import com.cboe.domain.util.intMaps.IntMap;</TD></TR><TR><TD CLASS="l">36</TD><TD>import com.cboe.domain.util.intMaps.IntMapEntry;</TD></TR><TR><TD CLASS="l">37</TD><TD>import com.cboe.exceptions.AuthorizationException;</TD></TR><TR><TD CLASS="l">38</TD><TD>import com.cboe.exceptions.CommunicationException;</TD></TR><TR><TD CLASS="l">39</TD><TD>import com.cboe.exceptions.DataValidationException;</TD></TR><TR><TD CLASS="l">40</TD><TD>import com.cboe.exceptions.NotAcceptedException;</TD></TR><TR><TD CLASS="l">41</TD><TD>import com.cboe.exceptions.NotFoundException;</TD></TR><TR><TD CLASS="l">42</TD><TD>import com.cboe.exceptions.SystemException;</TD></TR><TR><TD CLASS="l">43</TD><TD>import com.cboe.exceptions.TransactionFailedException;</TD></TR><TR><TD CLASS="l">44</TD><TD>import com.cboe.idl.cmiConstants.ContingencyTypes;</TD></TR><TR><TD CLASS="l">45</TD><TD>import com.cboe.idl.cmiConstants.ExtensionFields;</TD></TR><TR><TD CLASS="l">46</TD><TD>import com.cboe.idl.cmiConstants.OrderCancelTypes;</TD></TR><TR><TD CLASS="l">47</TD><TD>import com.cboe.idl.cmiConstants.OrderOrigins;</TD></TR><TR><TD CLASS="l">48</TD><TD>import com.cboe.idl.cmiConstants.OrderStates;</TD></TR><TR><TD CLASS="l">49</TD><TD>import com.cboe.idl.cmiConstants.PositionEffects;</TD></TR><TR><TD CLASS="l">50</TD><TD>import com.cboe.idl.cmiConstants.PriceTypes;</TD></TR><TR><TD CLASS="l">51</TD><TD>import com.cboe.idl.cmiConstants.ProductTypes;</TD></TR><TR><TD CLASS="l">52</TD><TD>import com.cboe.idl.cmiConstants.SessionNameValues;</TD></TR><TR><TD CLASS="l">53</TD><TD>import com.cboe.idl.cmiConstants.Sides;</TD></TR><TR><TD CLASS="l">54</TD><TD>import com.cboe.idl.cmiConstants.Sources;</TD></TR><TR><TD CLASS="l">55</TD><TD>import com.cboe.idl.cmiConstants.TimesInForce;</TD></TR><TR><TD CLASS="l">56</TD><TD>import com.cboe.idl.cmiConstants.VolumeTypes;</TD></TR><TR><TD CLASS="l">57</TD><TD>import com.cboe.idl.cmiErrorCodes.DataValidationCodes;</TD></TR><TR><TD CLASS="l">58</TD><TD>import com.cboe.idl.cmiErrorCodes.NotFoundCodes;</TD></TR><TR><TD CLASS="l">59</TD><TD>import com.cboe.idl.cmiIntermarketMessages.ExchangeMarketStruct;</TD></TR><TR><TD CLASS="l">60</TD><TD>import com.cboe.idl.cmiIntermarketMessages.HeldOrderStruct;</TD></TR><TR><TD CLASS="l">61</TD><TD>import com.cboe.idl.cmiMarketData.CurrentMarketStruct;</TD></TR><TR><TD CLASS="l">62</TD><TD>import com.cboe.idl.cmiMarketData.ExchangeVolumeStruct;</TD></TR><TR><TD CLASS="l">63</TD><TD>import com.cboe.idl.cmiMarketData.MarketVolumeStruct;</TD></TR><TR><TD CLASS="l">64</TD><TD>import com.cboe.idl.cmiMarketData.NBBOStruct;</TD></TR><TR><TD CLASS="l">65</TD><TD>import com.cboe.idl.cmiOrder.CancelReportStruct;</TD></TR><TR><TD CLASS="l">66</TD><TD>import com.cboe.idl.cmiOrder.FilledReportStruct;</TD></TR><TR><TD CLASS="l">67</TD><TD>import com.cboe.idl.cmiOrder.LegOrderDetailStruct;</TD></TR><TR><TD CLASS="l">68</TD><TD>import com.cboe.idl.cmiOrder.OrderIdStruct;</TD></TR><TR><TD CLASS="l">69</TD><TD>import com.cboe.idl.cmiOrder.OrderStruct;</TD></TR><TR><TD CLASS="l">70</TD><TD>import com.cboe.idl.cmiUser.ExchangeAcronymStruct;</TD></TR><TR><TD CLASS="l">71</TD><TD>import com.cboe.idl.cmiUser.ExchangeFirmStruct;</TD></TR><TR><TD CLASS="l">72</TD><TD>import com.cboe.idl.cmiUser.SessionProfileStruct;</TD></TR><TR><TD CLASS="l">73</TD><TD>import com.cboe.idl.cmiUser.SessionProfileUserStruct;</TD></TR><TR><TD CLASS="l">74</TD><TD>import com.cboe.idl.cmiUtil.CboeIdStruct;</TD></TR><TR><TD CLASS="l">75</TD><TD>import com.cboe.idl.cmiUtil.PriceStruct;</TD></TR><TR><TD CLASS="l">76</TD><TD>import com.cboe.idl.constants.OrderLocations;</TD></TR><TR><TD CLASS="l">77</TD><TD>import com.cboe.idl.marketData.QuoteQueryV2Struct;</TD></TR><TR><TD CLASS="l">78</TD><TD>import com.cboe.idl.order.MarketDetailStruct;</TD></TR><TR><TD CLASS="l">79</TD><TD>import com.cboe.idl.order.OrderHandlingStruct;</TD></TR><TR><TD CLASS="l">80</TD><TD>import com.cboe.idl.order.OrderHandlingStructV2;</TD></TR><TR><TD CLASS="l">81</TD><TD>import com.cboe.idl.order.OrderRoutingParameterStruct;</TD></TR><TR><TD CLASS="l">82</TD><TD>import com.cboe.idl.property.PropertyGroupStruct;</TD></TR><TR><TD CLASS="l">83</TD><TD>import com.cboe.idl.session.TradingSessionStruct;</TD></TR><TR><TD CLASS="l">84</TD><TD>import com.cboe.idl.util.NameValueStruct;</TD></TR><TR><TD CLASS="l">85</TD><TD>import com.cboe.infrastructureServices.foundationFramework.BOHome;</TD></TR><TR><TD CLASS="l">86</TD><TD>import com.cboe.infrastructureServices.foundationFramework.HomeFactory;</TD></TR><TR><TD CLASS="l">87</TD><TD>import com.cboe.infrastructureServices.foundationFramework.exceptionHandling.CBOELoggableException;</TD></TR><TR><TD CLASS="l">88</TD><TD>import com.cboe.infrastructureServices.foundationFramework.exceptionHandling.FatalFoundationFrameworkException;</TD></TR><TR><TD CLASS="l">89</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.Configuration;</TD></TR><TR><TD CLASS="l">90</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.Log;</TD></TR><TR><TD CLASS="l">91</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.RouteNameHelper;</TD></TR><TR><TD CLASS="l">92</TD><TD>import com.cboe.infrastructureServices.systemsManagementService.ApplicationPropertyHelper;</TD></TR><TR><TD CLASS="l">93</TD><TD>import com.cboe.infrastructureServices.systemsManagementService.NoSuchPropertyException;</TD></TR><TR><TD CLASS="l">94</TD><TD>import com.cboe.infrastructureServices.systemsManagementService.PropertyQuery;</TD></TR><TR><TD CLASS="l">95</TD><TD>import com.cboe.interfaces.businessServices.BrokerService;</TD></TR><TR><TD CLASS="l">96</TD><TD>import com.cboe.interfaces.businessServices.BrokerServiceHome;</TD></TR><TR><TD CLASS="l">97</TD><TD>import com.cboe.interfaces.businessServices.MarketDataService;</TD></TR><TR><TD CLASS="l">98</TD><TD>import com.cboe.interfaces.businessServices.OrderBookServiceLocalHome;</TD></TR><TR><TD CLASS="l">99</TD><TD>import com.cboe.interfaces.businessServices.OrderQueryService;</TD></TR><TR><TD CLASS="l">100</TD><TD>import com.cboe.interfaces.businessServices.OrderQueryServiceHome;</TD></TR><TR><TD CLASS="l">101</TD><TD>import com.cboe.interfaces.businessServices.UserService;</TD></TR><TR><TD CLASS="l">102</TD><TD>import com.cboe.interfaces.businessServices.UserServiceHome;</TD></TR><TR><TD CLASS="l">103</TD><TD>import com.cboe.interfaces.domain.Cross;</TD></TR><TR><TD CLASS="l">104</TD><TD>import com.cboe.interfaces.domain.DerivedQuote;</TD></TR><TR><TD CLASS="l">105</TD><TD>import com.cboe.interfaces.domain.LegOrderDetailHome;</TD></TR><TR><TD CLASS="l">106</TD><TD>import com.cboe.interfaces.domain.ManualQuote;</TD></TR><TR><TD CLASS="l">107</TD><TD>import com.cboe.interfaces.domain.ManualQuoteBook;</TD></TR><TR><TD CLASS="l">108</TD><TD>import com.cboe.interfaces.domain.Order;</TD></TR><TR><TD CLASS="l">109</TD><TD>import com.cboe.interfaces.domain.OrderBook;</TD></TR><TR><TD CLASS="l">110</TD><TD>import com.cboe.interfaces.domain.OrderBookHome;</TD></TR><TR><TD CLASS="l">111</TD><TD>import com.cboe.interfaces.domain.OrderCommon;</TD></TR><TR><TD CLASS="l">112</TD><TD>import com.cboe.interfaces.domain.OrderHistoryHome;</TD></TR><TR><TD CLASS="l">113</TD><TD>import com.cboe.interfaces.domain.OrderHome;</TD></TR><TR><TD CLASS="l">114</TD><TD>import com.cboe.interfaces.domain.OrderIdGeneratorHome;</TD></TR><TR><TD CLASS="l">115</TD><TD>import com.cboe.interfaces.domain.OrderSync;</TD></TR><TR><TD CLASS="l">116</TD><TD>import com.cboe.interfaces.domain.OrderSyncHome;</TD></TR><TR><TD CLASS="l">117</TD><TD>import com.cboe.interfaces.domain.Price;</TD></TR><TR><TD CLASS="l">118</TD><TD>import com.cboe.interfaces.domain.TradingClassHome;</TD></TR><TR><TD CLASS="l">119</TD><TD>import com.cboe.interfaces.domain.TradingProduct;</TD></TR><TR><TD CLASS="l">120</TD><TD>import com.cboe.interfaces.domain.TradingProductHome;</TD></TR><TR><TD CLASS="l">121</TD><TD>import com.cboe.interfaces.domain.bestQuote.BestQuote;</TD></TR><TR><TD CLASS="l">122</TD><TD>import com.cboe.interfaces.domain.marketData.MarketData;</TD></TR><TR><TD CLASS="l">123</TD><TD>import com.cboe.interfaces.domain.marketData.MarketDataHome;</TD></TR><TR><TD CLASS="l">124</TD><TD>import com.cboe.interfaces.domain.property.PropertyCategoryTypes;</TD></TR><TR><TD CLASS="l">125</TD><TD>import com.cboe.interfaces.domain.property.PropertyServiceFacade;</TD></TR><TR><TD CLASS="l">126</TD><TD>import com.cboe.interfaces.domain.property.PropertyServicePropertyGroup;</TD></TR><TR><TD CLASS="l">127</TD><TD>import com.cboe.interfaces.events.IntermarketOrderStatusConsumer;</TD></TR><TR><TD CLASS="l">128</TD><TD>import com.cboe.interfaces.events.MarketAlertConsumer;</TD></TR><TR><TD CLASS="l">129</TD><TD>import com.cboe.interfaces.events.OrderStatusConsumer;</TD></TR><TR><TD CLASS="l">130</TD><TD>import com.cboe.interfaces.internalBusinessServices.OrderMarketMonitoringService;</TD></TR><TR><TD CLASS="l">131</TD><TD>import com.cboe.interfaces.internalBusinessServices.OrderMarketMonitoringServiceHome;</TD></TR><TR><TD CLASS="l">132</TD><TD>import com.cboe.interfaces.internalBusinessServices.TradingSessionServiceHomeLocal;</TD></TR><TR><TD CLASS="l">133</TD><TD>import com.cboe.interfaces.internalBusinessServices.TradingSessionServiceLocal;</TD></TR><TR><TD CLASS="l">134</TD><TD>import com.cboe.interfaces.ohsEvents.InternalOrderStatusConsumer;</TD></TR><TR><TD CLASS="l">135</TD><TD>import com.cboe.interfaces.orderHandlingServices.OHSOrderMaintenanceServiceHome;</TD></TR><TR><TD CLASS="l">136</TD><TD>import com.cboe.interfaces.productData.CurrentMarketCache;</TD></TR><TR><TD CLASS="l">137</TD><TD>import com.cboe.interfaces.productData.ProductDataCacheHome;</TD></TR><TR><TD CLASS="l">138</TD><TD>import com.cboe.server.events.EventHomes;</TD></TR><TR><TD CLASS="l">139</TD><TD>import com.cboe.server.transactionTiming.EmitPoint;</TD></TR><TR><TD CLASS="l">140</TD><TD>import com.cboe.server.util.BusinessServicesHelper;</TD></TR><TR><TD CLASS="l">141</TD><TD>import com.cboe.server.util.CancelReportChannelSelectorHome;</TD></TR><TR><TD CLASS="l">142</TD><TD>import com.cboe.server.util.ConfigurationGroupHelper;</TD></TR><TR><TD CLASS="l">143</TD><TD>import com.cboe.server.util.DomainObjectHelper;</TD></TR><TR><TD CLASS="l">144</TD><TD>import com.cboe.server.util.FFStatusQuery;</TD></TR><TR><TD CLASS="l">145</TD><TD>import com.cboe.server.util.FirmTradingPropertyHelper;</TD></TR><TR><TD CLASS="l">146</TD><TD>import com.cboe.server.util.OrderHandlingExtensions;</TD></TR><TR><TD CLASS="l">147</TD><TD>import com.cboe.server.util.StructToString;</TD></TR><TR><TD CLASS="l">148</TD><TD>import com.cboe.server.util.TradeServerIdPropertyHelper;</TD></TR><TR><TD CLASS="l">149</TD><TD>import com.cboe.util.ExceptionBuilder;</TD></TR><TR><TD CLASS="l">150</TD><TD> </TD></TR><TR><TD CLASS="l">151</TD><TD> </TD></TR><TR><TD CLASS="l">152</TD><TD>/**</TD></TR><TR><TD CLASS="l">153</TD><TD> * This is the home for the orders. It provides persistence and local caching for the orders to</TD></TR><TR><TD CLASS="l">154</TD><TD> * ensure order identity.</TD></TR><TR><TD CLASS="l">155</TD><TD> *</TD></TR><TR><TD CLASS="l">156</TD><TD> * @author Craig Murphy</TD></TR><TR><TD CLASS="l">157</TD><TD> * @author Werner Kubitsch</TD></TR><TR><TD CLASS="l">158</TD><TD> */</TD></TR><TR CLASS="c"><TD CLASS="l">159</TD><TD>public class OrderHomeImpl extends BOHome  implements OrderHome</TD></TR><TR><TD CLASS="l">160</TD><TD>{</TD></TR><TR><TD CLASS="l">161</TD><TD>    public final static String INITIAL_CACHE_SIZE = &#34;initialTableSize&#34;;</TD></TR><TR><TD CLASS="l">162</TD><TD>    public static final String ECHO_REPORTS = &#34;echoReports&#34;;</TD></TR><TR><TD CLASS="l">163</TD><TD>    public final static String RETENTION_PERIOD = &#34;retentionPeriod&#34;;</TD></TR><TR><TD CLASS="l">164</TD><TD>    public final static String EXECUTING_BROKER = &#34;executingBroker&#34;;</TD></TR><TR><TD CLASS="l">165</TD><TD>    public static final String CANCEL_ORDER_BELOW_IPP = &#34;CancelAll&#34;;</TD></TR><TR><TD CLASS="l">166</TD><TD>    public static final String CANCEL_NONE_BELOW_IPP = &#34;CancelNone&#34;;</TD></TR><TR><TD CLASS="l">167</TD><TD>    public static final String IPP_MIN_SIZE_PROCESSING_INDICATOR = &#34;ippMinSizeProcessingIndicator&#34;;</TD></TR><TR><TD CLASS="l">168</TD><TD>    public static final String NBBO_MIN_SIZE_GUARANTEE_ORDER_BRANCH = &#34;nbboMinSizeGuaranteeOrderBranch&#34;;</TD></TR><TR><TD CLASS="l">169</TD><TD>    public static final String MAX_RETRIES_OF_NBBO_PROTECTION_ROUTING = &#34;maxRetriesOfNBBOProtectionRouting&#34;;</TD></TR><TR><TD CLASS="l">170</TD><TD>    public static final String SATISFY_SATISFACTION_ORDER_BRANCH = &#34;satisfySatisfactionOrderBranch&#34;;</TD></TR><TR><TD CLASS="l">171</TD><TD> </TD></TR><TR><TD CLASS="l">172</TD><TD>    public final static String ANYONYMOUS_TRADING_IF_NOT_QUOTE = &#34;anonymousTradingIfNotClearsLikeQuote&#34;;</TD></TR><TR><TD CLASS="l">173</TD><TD>    public final static String ANYONYMOUS_TRADING_IF_NOT_QUOTE_BROKER = &#34;anonymousIfNotClearsLikeQuoteBroker&#34;;</TD></TR><TR><TD CLASS="l">174</TD><TD>    public final static String MANUL_QUOTE_CONTRA_ORDER_BROKER = &#34;manualQuoteContraOrderBroker&#34;;</TD></TR><TR><TD CLASS="l">175</TD><TD>    public final static String BLANK_ACCOUNT_ENABLED = &#34;blankAccountIfSameAsAcr&#34;;</TD></TR><TR><TD CLASS="l">176</TD><TD>    public final static String CANCEL_Q_ORDERS = &#34;cancelQOrdersOnCloseHaltLogOut&#34;;</TD></TR><TR><TD CLASS="l">177</TD><TD>    public final static String MARKET_ALERT_ON_ORIGIN_CODES = &#34;marketAlertOnOriginCodes&#34;;</TD></TR><TR><TD CLASS="l">178</TD><TD>    private static final String DEFAULT_NBBO_MSGORDER_BRANCH = &#34;***&#34;;</TD></TR><TR><TD CLASS="l">179</TD><TD>    private static final int DEFAULT_MAX_RETRIES_OF_NBBO_PROTECTION_ROUTING = 1;</TD></TR><TR><TD CLASS="l">180</TD><TD>    private static final String DEFAULT_SATISFY_SATISFACTION_ORDER_BRANCH = &#34;***&#34;;</TD></TR><TR><TD CLASS="l">181</TD><TD> </TD></TR><TR><TD CLASS="l">182</TD><TD>    public static final String DEFAULT_IPP_PROCESSING = &#34;None&#34;;</TD></TR><TR><TD CLASS="l">183</TD><TD>    public static final String IPP_PROCESSING_NONE = &#34;None&#34;;</TD></TR><TR><TD CLASS="l">184</TD><TD>    public static final String IPP_PROCESSING_IF_CUSTOMER_REQUIRES = &#34;IfCustomerRequires&#34;;</TD></TR><TR><TD CLASS="l">185</TD><TD>    public static final String IPP_PROCESSING_IPP_REQUIRED = &#34;IPPRequired&#34;;</TD></TR><TR><TD CLASS="l">186</TD><TD>    public static final String ALLOW_CLEARING_ACR_CONFIGURED = &#34;allowUseClearingAcrConfigured&#34;;</TD></TR><TR><TD CLASS="l">187</TD><TD>    public static final String NO_MARKET_ALERT = &#34;0&#34;;</TD></TR><TR><TD CLASS="l">188</TD><TD>    public static final String INTERNALIZATION_AUCTION_TRADE_BROKER = &#34;internalizationAuctionTradeBroker&#34;;</TD></TR><TR><TD CLASS="l">189</TD><TD>    public static final String TRADE_AND_SHIP_CODES = &#34;tradeAndShipCodes&#34;;</TD></TR><TR><TD CLASS="l">190</TD><TD>    public static final String SALABLE_CODES = &#34;salableCodes&#34;;</TD></TR><TR><TD CLASS="l">191</TD><TD>    public static final String RESERVE_ORDER_REFRESH_SIZE = &#34;reserveOrderRefreshSize&#34;;</TD></TR><TR><TD CLASS="l">192</TD><TD>    public static final String  REJECT_LIGHT_ORDER_ORIGIN_CODES = &#34;rejectLightOrderOriginCodes&#34;;</TD></TR><TR><TD CLASS="l">193</TD><TD>    public static final String NO_ORIGIN_CODES = &#34;0&#34;;</TD></TR><TR><TD CLASS="l">194</TD><TD>    public static final String  PUBLISH_CXL_REASONS_FOR_LIGHT_ORDERS = &#34;publishCxlReasonsForLightOrders&#34;;</TD></TR><TR><TD CLASS="l">195</TD><TD>    </TD></TR><TR><TD CLASS="l">196</TD><TD>    </TD></TR><TR><TD CLASS="l">197</TD><TD>    protected int initialCacheSize;                   // size of order DB when initially created</TD></TR><TR><TD CLASS="l">198</TD><TD>    private long retentionPeriod;                   // number of days to retain purged orders, before deletion</TD></TR><TR><TD CLASS="l">199</TD><TD>    private boolean echoReports;                    // if set to true, reports are echoed to the log</TD></TR><TR><TD CLASS="l">200</TD><TD>    private OrderStatusConsumer orderStatusPublisher;</TD></TR><TR><TD CLASS="l">201</TD><TD>    private InternalOrderStatusConsumer internalOrderStatusPublisher;</TD></TR><TR><TD CLASS="l">202</TD><TD>    private InternalOrderStatusConsumer transientInternalOrderStatusPublisher;</TD></TR><TR><TD CLASS="l">203</TD><TD>    private MarketAlertConsumer marketAlertPublisher;</TD></TR><TR><TD CLASS="l">204</TD><TD>    private IntermarketOrderStatusConsumer intermarketOrderStatusPublisher;</TD></TR><TR><TD CLASS="l">205</TD><TD>    private final static byte NO_PRICE = (byte)PriceTypes.NO_PRICE;</TD></TR><TR><TD CLASS="l">206</TD><TD>   </TD></TR><TR><TD CLASS="l">207</TD><TD> </TD></TR><TR><TD CLASS="l">208</TD><TD>    private String executingBroker;</TD></TR><TR><TD CLASS="l">209</TD><TD>    private String ippMinSizeProcessingIndicator;</TD></TR><TR><TD CLASS="l">210</TD><TD>    private int nbboMinSizeGuaranteeOrderSeqNum;</TD></TR><TR><TD CLASS="l">211</TD><TD>    private String nbboMinSizeGuaranteeOrderBranch;</TD></TR><TR><TD CLASS="l">212</TD><TD>    private int maxRetriesOfNBBOProtectionRouting;</TD></TR><TR><TD CLASS="l">213</TD><TD>    private HashMap ippProcessingStrategies;</TD></TR><TR><TD CLASS="l">214</TD><TD>    private static HashMap quoteLockConfiguredForSessions;</TD></TR><TR><TD CLASS="l">215</TD><TD>    private static HashMap clearsLikeQuoteConfiguredForSessions;</TD></TR><TR><TD CLASS="l">216</TD><TD>    private static MarketDataService marketDataService;</TD></TR><TR><TD CLASS="l">217</TD><TD>    private String satisfySatisfactionOrderBranch;</TD></TR><TR><TD CLASS="l">218</TD><TD>    private int satisfySatisfactionOrderSeqNum;</TD></TR><TR><TD CLASS="l"><A NAME="9">219</A></TD><TD> </TD></TR><TR><TD CLASS="l">220</TD><TD>  </TD></TR><TR CLASS="z"><TD CLASS="l">221</TD><TD>    private EmitPoint emitPointOrderSync = null; </TD></TR><TR><TD CLASS="l">222</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">223</TD><TD>    private static boolean allowUseClearingAcrConfigured = true;</TD></TR><TR><TD CLASS="l">224</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">225</TD><TD>    private boolean anonymousTradingIfNotClearsLikeQuote = false;</TD></TR><TR><TD CLASS="l">226</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">227</TD><TD>    private String anonymousIfNotClearsLikeQuoteBroker = null;</TD></TR><TR><TD CLASS="l">228</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">229</TD><TD>    private String manualQuoteContraOrderBroker = null;</TD></TR><TR><TD CLASS="l">230</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">231</TD><TD>    private String internalizationAuctionTradeBroker = null;</TD></TR><TR><TD CLASS="l">232</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">233</TD><TD>    private boolean ifBlankAccountIfSameAsAcr = false;</TD></TR><TR><TD CLASS="l">234</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">235</TD><TD>    private boolean cancelQOrdersOnCloseHaltLogOut = false;</TD></TR><TR><TD CLASS="l">236</TD><TD>    private String[] customerCodes;</TD></TR><TR><TD CLASS="l">237</TD><TD>    private String[] nbboFlashCodes;</TD></TR><TR><TD CLASS="l">238</TD><TD> </TD></TR><TR><TD CLASS="l">239</TD><TD>    private String[] marketAlertOnOriginCodes;</TD></TR><TR><TD CLASS="l">240</TD><TD> </TD></TR><TR><TD CLASS="l">241</TD><TD>    private String[] tradeAndShipCodes;</TD></TR><TR><TD CLASS="l">242</TD><TD>    private String[] salableCodes;</TD></TR><TR><TD CLASS="l">243</TD><TD>    private int reserveOrderRefreshSize;</TD></TR><TR><TD CLASS="l">244</TD><TD>    private OrderHistoryHome theOrderHistoryHome;</TD></TR><TR><TD CLASS="l">245</TD><TD>    private OrderIdGeneratorHome theOrderIdGeneratorHome;</TD></TR><TR><TD CLASS="l">246</TD><TD>    private OHSOrderMaintenanceServiceHome orderMaintenanceServiceHome;</TD></TR><TR><TD CLASS="l">247</TD><TD>    private static TradingSessionServiceLocal theTradingSessionService;</TD></TR><TR><TD CLASS="l">248</TD><TD>    private LegOrderDetailHomeImpl legDetailHome;</TD></TR><TR><TD CLASS="l">249</TD><TD>    private ProductDataCacheHome productDataCacheHome;</TD></TR><TR><TD CLASS="l">250</TD><TD>    private OrderMarketMonitoringService omms;</TD></TR><TR><TD CLASS="l">251</TD><TD>    private transient UserService userService;</TD></TR><TR><TD CLASS="l">252</TD><TD>    private OrderQueryService orderQueryService;</TD></TR><TR><TD CLASS="l">253</TD><TD>    private MarketDataHome mktDataHome;</TD></TR><TR><TD CLASS="l">254</TD><TD> </TD></TR><TR><TD CLASS="l">255</TD><TD>        // this is the local order cache, to ensure object identity across services</TD></TR><TR><TD CLASS="l">256</TD><TD>        // might be a candidate for weak references in the future</TD></TR><TR><TD CLASS="l">257</TD><TD>        //</TD></TR><TR><TD CLASS="l">258</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">259</TD><TD>    private ArrayList&lt;OrderIdStruct&gt; pAndPAOrders = null;</TD></TR><TR CLASS="z"><TD CLASS="l">260</TD><TD>    private ArrayList&lt;OrderIdStruct&gt; satisfactionOrders = null;</TD></TR><TR><TD CLASS="l">261</TD><TD>    //wjg   Change to ConcurrentHashMap for performance</TD></TR><TR><TD CLASS="l">262</TD><TD>    </TD></TR><TR><TD CLASS="l">263</TD><TD>    private Map&lt;Long, OrderImpl&gt; orderCache;</TD></TR><TR><TD CLASS="l">264</TD><TD>    // Cache of all the quote like orders.</TD></TR><TR><TD CLASS="l">265</TD><TD>    // key=productKey, value=Hashtable with key=orderId and value=order</TD></TR><TR><TD CLASS="l">266</TD><TD>    </TD></TR><TR><TD CLASS="l">267</TD><TD>    private ConcurrentIntHashMap&lt;Map&lt;Long, Order&gt;&gt; quoteLikeOrdersCache;</TD></TR><TR><TD CLASS="l">268</TD><TD> </TD></TR><TR><TD CLASS="l">269</TD><TD>    // Following Hashtable stores Orders by sessions and class.</TD></TR><TR><TD CLASS="l">270</TD><TD>    private Map&lt;String, ConcurrentIntHashMap&lt;Map&lt;Long, Order&gt;&gt;&gt; productKeyOrderCacheForSessions;</TD></TR><TR><TD CLASS="l">271</TD><TD>    </TD></TR><TR><TD CLASS="l">272</TD><TD>    // Maintain a reference to the various SqlScalar types referenced</TD></TR><TR><TD CLASS="l">273</TD><TD>    // by this class and it's OrderImpl objects. This is</TD></TR><TR><TD CLASS="l">274</TD><TD>    // required at some point in the program to ensure that the</TD></TR><TR><TD CLASS="l">275</TD><TD>    // classes are loaded so that their static initializers will register</TD></TR><TR><TD CLASS="l">276</TD><TD>    // with the persistence layer's factory for SqlScalar types.</TD></TR><TR><TD CLASS="l">277</TD><TD>    //</TD></TR><TR CLASS="c"><TD CLASS="l">278</TD><TD>    private static final Class __c3 = PriceSqlType.class;</TD></TR><TR><TD CLASS="l">279</TD><TD> </TD></TR><TR><TD CLASS="l">280</TD><TD>    private String[] configuredSessions;</TD></TR><TR><TD CLASS="l">281</TD><TD>    // constants for admin command</TD></TR><TR><TD CLASS="l">282</TD><TD>    public static final String NO_MATCH_FOUND = &#34;NO_MATCH_FOUND&#34;;</TD></TR><TR><TD CLASS="l">283</TD><TD>    public static final String QUERY_CRITERIA_BRANCH = &#34;BRANCH&#34;;</TD></TR><TR><TD CLASS="l">284</TD><TD>    public static final String QUERY_CRITERIA_BRANCH_SEQ_NO = &#34;BRANCH_SEQ&#34;;</TD></TR><TR><TD CLASS="l">285</TD><TD>    public static final String QUERY_CRITERIA_PRODUCT_KEY = &#34;PRODUCT_KEY&#34;;</TD></TR><TR><TD CLASS="l">286</TD><TD>    public static final String QUERY_CRITERIA_HIGHLOW_ID = &#34;ORDER_ID&#34;;</TD></TR><TR><TD CLASS="l">287</TD><TD>    public static final String QUERY_COUNT = &#34;COUNT&#34;;</TD></TR><TR><TD CLASS="l">288</TD><TD>    public static final String QUERY_USER = &#34;USER&#34;;</TD></TR><TR><TD CLASS="l">289</TD><TD>    public static final String QUERY_CLASSKEY = &#34;CLASS&#34;;</TD></TR><TR><TD CLASS="l">290</TD><TD>    public static final String SEPARATOR = &#34;|&#34;;</TD></TR><TR><TD CLASS="l">291</TD><TD>    public static final String QUERY_CRITERIA_UNSUPPORTED = &#34;UNSUPPORTED_CRITERIA&#34;;</TD></TR><TR><TD CLASS="l">292</TD><TD>    private static final int SEQ_NUM_FAILOVER_INCR = 10000;</TD></TR><TR><TD CLASS="l">293</TD><TD> </TD></TR><TR><TD CLASS="l">294</TD><TD>    private final static String DEFAULT_LOCATION_ID = &#34;%&#34;;</TD></TR><TR><TD CLASS="l">295</TD><TD> </TD></TR><TR><TD CLASS="l">296</TD><TD>    /**</TD></TR><TR><TD CLASS="l">297</TD><TD>     * Trading classhome to obtain the configured classes and products</TD></TR><TR><TD CLASS="l">298</TD><TD>     */</TD></TR><TR><TD CLASS="l">299</TD><TD>    private TradingProductHome myTradingProductHome;</TD></TR><TR><TD CLASS="l">300</TD><TD> </TD></TR><TR><TD CLASS="l">301</TD><TD>    /**</TD></TR><TR><TD CLASS="l">302</TD><TD>     * Trading classhome to obtain the translation of classKey and Symbol</TD></TR><TR><TD CLASS="l">303</TD><TD>     */</TD></TR><TR><TD CLASS="l">304</TD><TD>    private TradingClassHome myTradingClassHome;</TD></TR><TR><TD CLASS="l">305</TD><TD> </TD></TR><TR><TD CLASS="l">306</TD><TD>    /**</TD></TR><TR><TD CLASS="l">307</TD><TD>     * Total number of order loading threads. Will be created as per the defintion in the</TD></TR><TR><TD CLASS="l">308</TD><TD>     * configuration file.</TD></TR><TR><TD CLASS="l">309</TD><TD>     */</TD></TR><TR><TD CLASS="l">310</TD><TD>    public static final String TOTAL_NUMBER_OF_ORDER_LOADING_THREADS = &#34;totalNumberOfOrderLoadingThreads&#34;;</TD></TR><TR><TD CLASS="l">311</TD><TD>    private int totalNumberOfOrderLoadingThreads;</TD></TR><TR><TD CLASS="l">312</TD><TD> </TD></TR><TR><TD CLASS="l">313</TD><TD>    /**</TD></TR><TR><TD CLASS="l">314</TD><TD>     * Max Products to send to OHS at order creation time</TD></TR><TR><TD CLASS="l">315</TD><TD>     */</TD></TR><TR><TD CLASS="l">316</TD><TD>    public static final String MAX_PRODUCTS_TO_SEND_PER_CALL_TO_OHS = &#34;maxProductsToSendPerCallToOHS&#34;;</TD></TR><TR><TD CLASS="l">317</TD><TD>    private int maxProductsToSendPerCallToOHS;</TD></TR><TR><TD CLASS="l">318</TD><TD>    </TD></TR><TR><TD CLASS="l">319</TD><TD>    /**</TD></TR><TR><TD CLASS="l">320</TD><TD>     * Max Products to send to OHS at order creation time</TD></TR><TR><TD CLASS="l">321</TD><TD>     */</TD></TR><TR><TD CLASS="l">322</TD><TD>    public static final String MAX_SLEEP_TIME_BEFORE_OHS_CALL = &#34;maxSleepTimeBeforeOHSCall&#34;;</TD></TR><TR><TD CLASS="l">323</TD><TD>    private long maxSleepTimeBeforeOHSCall;</TD></TR><TR><TD CLASS="l">324</TD><TD> </TD></TR><TR><TD CLASS="l">325</TD><TD>    private static String[] cancelOnFailoverCloseHaltLogOutCodes;</TD></TR><TR><TD CLASS="l">326</TD><TD> </TD></TR><TR><TD CLASS="l">327</TD><TD>    private OrderSync orderSync;</TD></TR><TR><TD CLASS="l">328</TD><TD>    </TD></TR><TR><TD CLASS="l">329</TD><TD>    private long orderLoadStartTime;</TD></TR><TR><TD CLASS="l">330</TD><TD>    private long orderLoadEndTime;</TD></TR><TR><TD CLASS="l">331</TD><TD>    private static BrokerService theBrokerService;</TD></TR><TR><TD CLASS="l">332</TD><TD>    private static int serverInstanceNumber;</TD></TR><TR CLASS="z"><TD CLASS="l">333</TD><TD>    private OrderStatusConsumer extOrderStatusPublisher = null;</TD></TR><TR CLASS="z"><TD CLASS="l">334</TD><TD>    private CancelReportChannelSelectorHome cancelReportChannelSelectorHome = null;</TD></TR><TR CLASS="z"><TD CLASS="l">335</TD><TD>    private String[] customerTypeOriginCodesForBobClasses = null;</TD></TR><TR><TD CLASS="l">336</TD><TD>    private OrderBookServiceLocalHome orderBookServiceHome;</TD></TR><TR><TD CLASS="l">337</TD><TD>    private OrderSyncHome orderSyncHome;</TD></TR><TR><TD CLASS="l">338</TD><TD>    private static String[] rejectLightOrderOrigins;</TD></TR><TR><TD CLASS="l">339</TD><TD>    private static short[] publishCxlReasonsForLightOrders;</TD></TR><TR><TD CLASS="l">340</TD><TD> </TD></TR><TR><TD CLASS="l">341</TD><TD>    public static final String CUSTOMER_TYPE_ORIGIN_CODES_BOB_CLASS = &#34;customerTypeOriginCodesForBobClasses&#34;;</TD></TR><TR><TD CLASS="l">342</TD><TD>    static</TD></TR><TR><TD CLASS="l">343</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">344</TD><TD>        initTradeServerId();</TD></TR><TR><TD CLASS="l">345</TD><TD>    }</TD></TR><TR><TD CLASS="l">346</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="cd">347</A></TD><TD>    private static void initTradeServerId()</TD></TR><TR><TD CLASS="l">348</TD><TD>    {</TD></TR><TR><TD CLASS="l">349</TD><TD>        try</TD></TR><TR><TD CLASS="l">350</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">351</TD><TD>            String serverInstanceNumberStr = ApplicationPropertyHelper.getProperty(&#34;serverInstanceNumber&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">352</TD><TD>            String sessionList = ApplicationPropertyHelper.getProperty(&#34;sessionNames&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">353</TD><TD>            String tradeServerIdStr = TradeServerIdPropertyHelper.getTradeServerId(serverInstanceNumberStr, sessionList);</TD></TR><TR CLASS="z"><TD CLASS="l">354</TD><TD>            serverInstanceNumber = Integer.parseInt(tradeServerIdStr);</TD></TR><TR CLASS="z"><TD CLASS="l">355</TD><TD>            Log.information(&#34;OrderHomeImpl: trade server id set to &#34; + serverInstanceNumber);</TD></TR><TR><TD CLASS="l">356</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">357</TD><TD>        catch (NoSuchPropertyException e)</TD></TR><TR><TD CLASS="l">358</TD><TD>        {</TD></TR><TR CLASS="c"><TD CLASS="l">359</TD><TD>            Log.information(&#34;OrderHomeImpl:  Unable to determine trade server id value from defined properties. Using 1 as default value&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">360</TD><TD>            serverInstanceNumber = 1;</TD></TR><TR><TD CLASS="l">361</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">362</TD><TD>        catch (NumberFormatException nfe)</TD></TR><TR><TD CLASS="l">363</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">364</TD><TD>            Log.alarm(&#34;OrderHomeImpl: Unable to determine trade server id value. Invalid value defined for serverInstanceNumber. Using 1 as default value&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">365</TD><TD>            serverInstanceNumber = 1;</TD></TR><TR><TD CLASS="l">366</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">367</TD><TD>    }</TD></TR><TR><TD CLASS="l">368</TD><TD> </TD></TR><TR><TD CLASS="l">369</TD><TD>    private static OrderBookHome cachedOrderBookHome;</TD></TR><TR><TD CLASS="l">370</TD><TD>        /**</TD></TR><TR><TD CLASS="l"><A NAME="e">371</A></TD><TD>         *  Add admin request to print orders</TD></TR><TR><TD CLASS="l">372</TD><TD>         */</TD></TR><TR><TD CLASS="l">373</TD><TD>        public String adminPrintOrder(String objectIdStr)</TD></TR><TR><TD CLASS="l">374</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">375</TD><TD>                java.io.StringWriter stringWriter = new java.io.StringWriter();</TD></TR><TR CLASS="z"><TD CLASS="l">376</TD><TD>                long orderId = 0;</TD></TR><TR><TD CLASS="l">377</TD><TD>                try</TD></TR><TR><TD CLASS="l">378</TD><TD>                {</TD></TR><TR><TD CLASS="l">379</TD><TD>                        // see if the high and low order ID's were entered. &lt;HIGH_ID&gt;:&lt;LOW_ID&gt;</TD></TR><TR><TD CLASS="l">380</TD><TD>                        int i;</TD></TR><TR CLASS="z"><TD CLASS="l">381</TD><TD>                        i = objectIdStr.indexOf(&#34;:&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">382</TD><TD>                        if (i &gt; -1) {</TD></TR><TR CLASS="z"><TD CLASS="l">383</TD><TD>                            String highID = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">384</TD><TD>                            String lowID = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">385</TD><TD>                            highID = objectIdStr.substring(0,i);</TD></TR><TR CLASS="z"><TD CLASS="l">386</TD><TD>                            lowID = objectIdStr.substring(i+1); </TD></TR><TR CLASS="z"><TD CLASS="l">387</TD><TD>                            if (i+1 &gt;= objectIdStr.length()) {</TD></TR><TR CLASS="z"><TD CLASS="l">388</TD><TD>                                stringWriter.write(&#34;missing the LOW_ID. Format = &lt;HIGH_ID&gt;:&lt;LOW_ID&gt;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">389</TD><TD>                                return stringWriter.toString();</TD></TR><TR><TD CLASS="l">390</TD><TD>                            }</TD></TR><TR CLASS="z"><TD CLASS="l">391</TD><TD>                            CboeIdStruct newId = new CboeIdStruct(Integer.valueOf(highID), Integer.valueOf(lowID));</TD></TR><TR CLASS="z"><TD CLASS="l">392</TD><TD>                            orderId = CboeId.longValue(newId);                            </TD></TR><TR><TD CLASS="l">393</TD><TD>                        }</TD></TR><TR><TD CLASS="l">394</TD><TD>                        else {</TD></TR><TR CLASS="z"><TD CLASS="l">395</TD><TD>                            orderId = Long.parseLong(objectIdStr);                    </TD></TR><TR><TD CLASS="l">396</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">397</TD><TD>                        Order order = findOrder(orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">398</TD><TD>                        stringWriter.write(&#34;Order for id &#34; + orderId + &#34;: \n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">399</TD><TD>            com.cboe.domain.util.ReflectiveStructBuilder.printStruct(order.getStruct(), &#34;order&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">400</TD><TD>                    stringWriter);</TD></TR><TR CLASS="z"><TD CLASS="l">401</TD><TD>                        stringWriter.flush();</TD></TR><TR CLASS="z"><TD CLASS="l">402</TD><TD>                        return stringWriter.toString();</TD></TR><TR><TD CLASS="l">403</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">404</TD><TD>                catch (Throwable ex)</TD></TR><TR><TD CLASS="l">405</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">406</TD><TD>                        java.io.PrintWriter printWriter = new java.io.PrintWriter(stringWriter);</TD></TR><TR CLASS="z"><TD CLASS="l">407</TD><TD>                        stringWriter.write(&#34;Error finding order: &#34; + ex + &#34;\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">408</TD><TD>                        ex.printStackTrace(printWriter);</TD></TR><TR CLASS="z"><TD CLASS="l">409</TD><TD>                        printWriter.flush();</TD></TR><TR CLASS="z"><TD CLASS="l">410</TD><TD>                        stringWriter.flush();</TD></TR><TR CLASS="z"><TD CLASS="l">411</TD><TD>                        return stringWriter.toString();</TD></TR><TR><TD CLASS="l">412</TD><TD>                }</TD></TR><TR><TD CLASS="l">413</TD><TD>        }</TD></TR><TR><TD CLASS="l">414</TD><TD> </TD></TR><TR><TD CLASS="l">415</TD><TD>/**</TD></TR><TR><TD CLASS="l">416</TD><TD>     * This admin command will print key details from the ordercache The criteria is what element of</TD></TR><TR><TD CLASS="l">417</TD><TD>     * the order that is queried upon The queryParam is the value of that corresponding criteria The</TD></TR><TR><TD CLASS="l">418</TD><TD>     * Criteria now supported is either by branch or by product.</TD></TR><TR><TD CLASS="l">419</TD><TD>     * </TD></TR><TR><TD CLASS="l">420</TD><TD>     * @return String</TD></TR><TR><TD CLASS="l"><A NAME="bb">421</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">422</TD><TD>    public String queryOrder(String criteria, String queryParam)</TD></TR><TR><TD CLASS="l">423</TD><TD>    {</TD></TR><TR><TD CLASS="l">424</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">425</TD><TD>        Iterator orderKeys = orderCache.keySet().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">426</TD><TD>        StringBuffer queryResult = new StringBuffer();</TD></TR><TR CLASS="z"><TD CLASS="l">427</TD><TD>           if (checkIfValidCriteria(criteria))</TD></TR><TR><TD CLASS="l">428</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">429</TD><TD>            while (orderKeys.hasNext())</TD></TR><TR><TD CLASS="l">430</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">431</TD><TD>                Long orderIdInCache = (Long) orderKeys.next();</TD></TR><TR CLASS="z"><TD CLASS="l">432</TD><TD>                OrderImpl order = (OrderImpl) orderCache.get(orderIdInCache);</TD></TR><TR><TD CLASS="l">433</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">434</TD><TD>                if (QUERY_CRITERIA_HIGHLOW_ID.equalsIgnoreCase(criteria))</TD></TR><TR><TD CLASS="l">435</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">436</TD><TD>                    String[] highLowId = queryParam.split(&#34;\\:&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">437</TD><TD>                    if (highLowId.length != 2)</TD></TR><TR><TD CLASS="l">438</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">439</TD><TD>                        String warn_msg = &#34;ENTER_HIGH_LOW_ID_SEPARATED_BY_:&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">440</TD><TD>                        return warn_msg;</TD></TR><TR><TD CLASS="l">441</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">442</TD><TD>                    int highOrderId = Integer.parseInt(highLowId[0]);</TD></TR><TR CLASS="z"><TD CLASS="l">443</TD><TD>                    int lowOrderId = Integer.parseInt(highLowId[1]);</TD></TR><TR CLASS="z"><TD CLASS="l">444</TD><TD>                    CboeIdStruct cboeId = new CboeIdStruct(highOrderId, lowOrderId);</TD></TR><TR CLASS="z"><TD CLASS="l">445</TD><TD>                    long orderKeyFromInput = CboeId.longValue(cboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">446</TD><TD>                    queryResult = queryByOrderId(orderKeyFromInput, order, orderIdInCache,</TD></TR><TR CLASS="z"><TD CLASS="l">447</TD><TD>                            queryResult);</TD></TR><TR><TD CLASS="l">448</TD><TD> </TD></TR><TR><TD CLASS="l">449</TD><TD>                }</TD></TR><TR><TD CLASS="l">450</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">451</TD><TD>                    if (QUERY_CRITERIA_BRANCH.equalsIgnoreCase(criteria))</TD></TR><TR><TD CLASS="l">452</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">453</TD><TD>                    String branchInCache = order.getBranch();</TD></TR><TR CLASS="z"><TD CLASS="l">454</TD><TD>                    queryResult = queryByBranch(queryParam, order, branchInCache, queryResult);</TD></TR><TR><TD CLASS="l">455</TD><TD>                }</TD></TR><TR><TD CLASS="l">456</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">457</TD><TD>                    if (QUERY_USER.equalsIgnoreCase(criteria))</TD></TR><TR><TD CLASS="l">458</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">459</TD><TD>                        String userId = order.getUserId();</TD></TR><TR CLASS="z"><TD CLASS="l">460</TD><TD>                        queryResult = queryByUserId(queryParam, order, userId, queryResult);</TD></TR><TR><TD CLASS="l">461</TD><TD>                    }</TD></TR><TR><TD CLASS="l">462</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">463</TD><TD>                    if (QUERY_CLASSKEY.equalsIgnoreCase(criteria))</TD></TR><TR><TD CLASS="l">464</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">465</TD><TD>                        int classKey = order.getClassKey();</TD></TR><TR CLASS="z"><TD CLASS="l">466</TD><TD>                        String classSymbol = null;</TD></TR><TR CLASS="z"><TD CLASS="l">467</TD><TD>                        boolean notFound = false;</TD></TR><TR><TD CLASS="l">468</TD><TD>                        try</TD></TR><TR><TD CLASS="l">469</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">470</TD><TD>                             classSymbol = getTradingClassHome().findByKey(classKey).getClassSymbol();</TD></TR><TR><TD CLASS="l">471</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">472</TD><TD>                        catch (NotFoundException e)</TD></TR><TR><TD CLASS="l">473</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">474</TD><TD>                            notFound = true;</TD></TR><TR><TD CLASS="l">475</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">476</TD><TD>                        if (notFound == false) {</TD></TR><TR CLASS="z"><TD CLASS="l">477</TD><TD>                            queryResult = queryByClass(queryParam, order, classSymbol, queryResult);</TD></TR><TR><TD CLASS="l">478</TD><TD>                        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">479</TD><TD>                            return NO_MATCH_FOUND;</TD></TR><TR><TD CLASS="l">480</TD><TD>                        }</TD></TR><TR><TD CLASS="l">481</TD><TD>                       </TD></TR><TR><TD CLASS="l">482</TD><TD>                }</TD></TR><TR><TD CLASS="l">483</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">484</TD><TD>                if (QUERY_COUNT.equals(criteria))</TD></TR><TR><TD CLASS="l">485</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">486</TD><TD>                    return  String.valueOf(orderCache.size());</TD></TR><TR><TD CLASS="l">487</TD><TD>                }</TD></TR><TR><TD CLASS="l">488</TD><TD> </TD></TR><TR><TD CLASS="l">489</TD><TD>            }</TD></TR><TR><TD CLASS="l">490</TD><TD>        }</TD></TR><TR><TD CLASS="l">491</TD><TD>        else</TD></TR><TR><TD CLASS="l">492</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">493</TD><TD>            return QUERY_CRITERIA_UNSUPPORTED;</TD></TR><TR><TD CLASS="l">494</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">495</TD><TD>        queryResult = checkForNoMatch(queryResult);</TD></TR><TR CLASS="z"><TD CLASS="l">496</TD><TD>        return queryResult.toString();</TD></TR><TR><TD CLASS="l"><A NAME="20">497</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">498</TD><TD> </TD></TR><TR><TD CLASS="l">499</TD><TD>    private boolean checkIfValidCriteria(String criteria)</TD></TR><TR><TD CLASS="l">500</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">501</TD><TD>            return (QUERY_CRITERIA_BRANCH.equalsIgnoreCase(criteria) || QUERY_CRITERIA_HIGHLOW_ID.equalsIgnoreCase(criteria)|| QUERY_CLASSKEY.equalsIgnoreCase(criteria) || QUERY_COUNT.equalsIgnoreCase(criteria) ||QUERY_USER.equalsIgnoreCase(criteria) );</TD></TR><TR><TD CLASS="l">502</TD><TD>    }</TD></TR><TR><TD CLASS="l">503</TD><TD> </TD></TR><TR><TD CLASS="l">504</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="b7">505</A></TD><TD> </TD></TR><TR><TD CLASS="l">506</TD><TD>    private StringBuffer queryByBranch(String branchId, OrderImpl order,</TD></TR><TR><TD CLASS="l">507</TD><TD>            String stringifiedBranchId, StringBuffer theResult)</TD></TR><TR><TD CLASS="l">508</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">509</TD><TD>        if (branchId.equals(&#34;*&#34;) ||branchId.equalsIgnoreCase(stringifiedBranchId))</TD></TR><TR><TD CLASS="l">510</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">511</TD><TD>            printOrderContents(order, theResult);</TD></TR><TR><TD CLASS="l">512</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">513</TD><TD>        return theResult;</TD></TR><TR><TD CLASS="l">514</TD><TD>    }</TD></TR><TR><TD CLASS="l">515</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="ba">516</A></TD><TD>    </TD></TR><TR><TD CLASS="l">517</TD><TD>    private StringBuffer queryByUserId(String p_userIdPassedIn, OrderImpl p_order,</TD></TR><TR><TD CLASS="l">518</TD><TD>            String p_userIdInCache, StringBuffer p_queryResult)</TD></TR><TR><TD CLASS="l">519</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">520</TD><TD>        if (p_userIdInCache.equalsIgnoreCase(p_userIdPassedIn))</TD></TR><TR><TD CLASS="l">521</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">522</TD><TD>            printOrderContents(p_order, p_queryResult);</TD></TR><TR><TD CLASS="l">523</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">524</TD><TD>        return p_queryResult;</TD></TR><TR><TD CLASS="l">525</TD><TD> </TD></TR><TR><TD CLASS="l">526</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="b8">527</A></TD><TD>    </TD></TR><TR><TD CLASS="l">528</TD><TD>    private StringBuffer queryByClass(String p_classKeyPassedIn, OrderImpl p_order,</TD></TR><TR><TD CLASS="l">529</TD><TD>            String p_classKeyInCache, StringBuffer p_queryResult)</TD></TR><TR><TD CLASS="l">530</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">531</TD><TD>        if (p_classKeyPassedIn.equalsIgnoreCase(p_classKeyInCache))</TD></TR><TR><TD CLASS="l">532</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">533</TD><TD>            printOrderContents(p_order, p_queryResult);</TD></TR><TR><TD CLASS="l">534</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">535</TD><TD>        return p_queryResult;</TD></TR><TR><TD CLASS="l">536</TD><TD> </TD></TR><TR><TD CLASS="l">537</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="b9">538</A></TD><TD> </TD></TR><TR><TD CLASS="l">539</TD><TD>    private StringBuffer queryByOrderId(long p_orderKeyFromInput, OrderImpl p_order,</TD></TR><TR><TD CLASS="l">540</TD><TD>            Long p_orderIdInCache, StringBuffer p_queryResult)</TD></TR><TR><TD CLASS="l">541</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">542</TD><TD>        if (p_orderKeyFromInput == p_orderIdInCache.longValue())</TD></TR><TR><TD CLASS="l">543</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">544</TD><TD>            printOrderContents(p_order, p_queryResult);</TD></TR><TR><TD CLASS="l">545</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">546</TD><TD>        return p_queryResult;</TD></TR><TR><TD CLASS="l"><A NAME="f">547</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">548</TD><TD> </TD></TR><TR><TD CLASS="l">549</TD><TD>    public String adminPrintOrderStatistics(String queryType)</TD></TR><TR><TD CLASS="l">550</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">551</TD><TD>        java.io.StringWriter stringWriter = new java.io.StringWriter();</TD></TR><TR><TD CLASS="l">552</TD><TD>        try</TD></TR><TR><TD CLASS="l">553</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">554</TD><TD>            String resultSet = findOrdersCountForARCommand(queryType);</TD></TR><TR CLASS="z"><TD CLASS="l">555</TD><TD>            stringWriter.write(&#34;Order Count Information by  &#34; + queryType + &#34;\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">556</TD><TD>            stringWriter.write(resultSet);</TD></TR><TR><TD CLASS="l">557</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">558</TD><TD>        catch (Throwable ex)</TD></TR><TR><TD CLASS="l">559</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">560</TD><TD>            java.io.PrintWriter printWriter = new java.io.PrintWriter(stringWriter);</TD></TR><TR CLASS="z"><TD CLASS="l">561</TD><TD>            stringWriter.write(&#34;Error printing order count information: &#34; + ex + &#34;\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">562</TD><TD>            ex.printStackTrace(printWriter);</TD></TR><TR CLASS="z"><TD CLASS="l">563</TD><TD>            printWriter.flush();</TD></TR><TR><TD CLASS="l">564</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">565</TD><TD>        stringWriter.flush();</TD></TR><TR CLASS="z"><TD CLASS="l">566</TD><TD>        return stringWriter.toString();</TD></TR><TR><TD CLASS="l">567</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="3e">568</A></TD><TD>   </TD></TR><TR><TD CLASS="l">569</TD><TD>    public String findOrdersCountForARCommand(String requestType)</TD></TR><TR><TD CLASS="l">570</TD><TD>    throws TransactionFailedException</TD></TR><TR><TD CLASS="l">571</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">572</TD><TD>        StringBuffer returnResult = new StringBuffer();</TD></TR><TR CLASS="z"><TD CLASS="l">573</TD><TD>        if (requestType.equalsIgnoreCase(&#34;Users&#34;))</TD></TR><TR><TD CLASS="l">574</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">575</TD><TD>            Iterator&lt;OrderImpl&gt; ordersIter = orderCache.values().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">576</TD><TD>            Map&lt;String, Integer&gt; usersOrderCountMap = new ConcurrentHashMap&lt;String, Integer&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">577</TD><TD>            while (ordersIter.hasNext())</TD></TR><TR><TD CLASS="l">578</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">579</TD><TD>                OrderImpl order = ordersIter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">580</TD><TD>                String userId = order.getUserId();</TD></TR><TR CLASS="z"><TD CLASS="l">581</TD><TD>                Integer userOrderCount = usersOrderCountMap.get(userId);</TD></TR><TR CLASS="z"><TD CLASS="l">582</TD><TD>                if (userOrderCount == null)</TD></TR><TR><TD CLASS="l">583</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">584</TD><TD>                    userOrderCount = new Integer(1);</TD></TR><TR CLASS="z"><TD CLASS="l">585</TD><TD>                    usersOrderCountMap.put(userId, userOrderCount);</TD></TR><TR><TD CLASS="l">586</TD><TD>                }</TD></TR><TR><TD CLASS="l">587</TD><TD>                else</TD></TR><TR><TD CLASS="l">588</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">589</TD><TD>                    userOrderCount = userOrderCount + 1;</TD></TR><TR CLASS="z"><TD CLASS="l">590</TD><TD>                    usersOrderCountMap.put(userId, userOrderCount);</TD></TR><TR><TD CLASS="l">591</TD><TD>                }</TD></TR><TR><TD CLASS="l">592</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">593</TD><TD>            Iterator&lt;String&gt; usersOrderCountIter = usersOrderCountMap.keySet().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">594</TD><TD>            while (usersOrderCountIter.hasNext())</TD></TR><TR><TD CLASS="l">595</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">596</TD><TD>                String userId = usersOrderCountIter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">597</TD><TD>                returnResult.append(&#34;User Id: &#34;).append(userId).append(&#34; Order Count: &#34;).append(</TD></TR><TR CLASS="z"><TD CLASS="l">598</TD><TD>                        usersOrderCountMap.get(userId)).append(&#34;\n&#34;);</TD></TR><TR><TD CLASS="l">599</TD><TD>            }</TD></TR><TR><TD CLASS="l">600</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">601</TD><TD>        return returnResult.toString();</TD></TR><TR><TD CLASS="l"><A NAME="b4">602</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">603</TD><TD>    </TD></TR><TR><TD CLASS="l">604</TD><TD>    private StringBuffer printOrderContents(Order order, StringBuffer theResult)</TD></TR><TR><TD CLASS="l">605</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">606</TD><TD>        theResult.append(&#34;ORDERID_STRING: &#34; + order.getOrderIdString() + &#34; |&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">607</TD><TD>        theResult.append(&#34;ACCOUNT:&#34; + order.getStruct().account + &#34;| &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">608</TD><TD>        theResult.append(&#34;USER ID:&#34; + order.getUserId() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">609</TD><TD>        theResult.append(&#34;STATE:&#34; + order.getState() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">610</TD><TD>        theResult.append(&#34;CORRESPONDING_FIRM #:&#34; + order.getOrderId().correspondentFirm + &#34;| &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">611</TD><TD>        theResult.append(&#34;PRICE:&#34; + order.getPrice() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">612</TD><TD>        theResult.append(&#34;BRANCH:&#34; + order.getOrderId().branch + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">613</TD><TD>        theResult.append(&#34;BRANCH SEQ:&#34; + order.getOrderId().branchSequenceNumber + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">614</TD><TD>        theResult.append(&#34;HIGH_ID:&#34; + order.getOrderId().highCboeId + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">615</TD><TD>        theResult.append(&#34;LOW_ID:&#34; + order.getOrderId().lowCboeId + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">616</TD><TD>        theResult.append(&#34;CLASS KEY:&#34; + order.getClassKey() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">617</TD><TD>        theResult.append(&#34;PRODUCT TYPE:&#34; + order.getStruct().productType + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">618</TD><TD>        theResult.append(&#34;CONTIGENCY TYPE:&#34; + order.getContingencyType() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">619</TD><TD>        theResult.append(&#34;PRODUCT KEY:&#34; + order.getProductKey() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">620</TD><TD>        theResult.append(&#34;OHS_RECEIVE_TIME:&#34; + order.getOHSReceivedTime() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">621</TD><TD>        theResult.append(&#34;ORIGINAL QUANTITY:&#34; + order.getOriginalQuantity() + &#34;| &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">622</TD><TD>        theResult.append(&#34;CANCEL QUANTITY:&#34; + order.getCancelledQuantity() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">623</TD><TD>        theResult.append(&#34;TRADED QUANTITY:&#34; + order.getTradedQuantity() + &#34;| &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">624</TD><TD>        theResult.append(&#34;REMAINING QUANTITY:&#34; + order.getRemainingQuantity() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">625</TD><TD>        theResult.append(&#34;BUSTED QUANTITY:&#34; + order.getBustedQuantity() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">626</TD><TD>        theResult.append(&#34;USER ID:&#34; + order.getUserId() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">627</TD><TD>        theResult.append(&#34;EXTENSIONS:&#34; + order.getExtensions() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">628</TD><TD>        theResult.append(&#34;HANDLING INSTRUCTION:&#34; + order.getOrderHandlingInstruction() + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">629</TD><TD>        if(order.getStruct().productType == ProductTypes.STRATEGY) {</TD></TR><TR CLASS="z"><TD CLASS="l">630</TD><TD>            LegOrderDetailStruct[] legDetails = order.getStruct().legOrderDetails;</TD></TR><TR CLASS="z"><TD CLASS="l">631</TD><TD>            if(legDetails == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">632</TD><TD>                theResult.append(&#34;NO LEGS FOR STRATEGY PRODUCT&#34;);</TD></TR><TR><TD CLASS="l">633</TD><TD>            } else {</TD></TR><TR><TD CLASS="l">634</TD><TD>               </TD></TR><TR CLASS="z"><TD CLASS="l">635</TD><TD>                theResult.append(&#34;LEG:TOTAL LENGTH: &#34; + legDetails.length + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">636</TD><TD>                for (int i=0; i &lt; legDetails.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">637</TD><TD>                    theResult.append(&#34;LEG &#34; +i +&#34; :PRODUCT KEY: &#34; + legDetails[i].productKey + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">638</TD><TD>                    theResult.append(&#34;LEG &#34; +i +&#34; CANCEL QUANTITY: &#34; + legDetails[i].cancelledQuantity + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">639</TD><TD>                    theResult.append(&#34;LEG &#34; +i +&#34; ORIGINAL QUANTITY: &#34; + legDetails[i].originalQuantity + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">640</TD><TD>                    theResult.append(&#34;LEG &#34; +i +&#34; LEAVES QUANTITY: &#34; + legDetails[i].leavesQuantity + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">641</TD><TD>                    theResult.append(&#34;LEG &#34; +i +&#34; TRADED QUANTITY: &#34; + legDetails[i].tradedQuantity + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">642</TD><TD>                    theResult.append(&#34;LEG &#34; +i +&#34; POSITTION EFFECT: &#34; + legDetails[i].positionEffect + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">643</TD><TD>                    theResult.append(&#34;LEG &#34; +i +&#34; MUST USE PRICE: &#34; + legDetails[i].mustUsePrice + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">644</TD><TD>                    theResult.append(&#34;LEG &#34; +i +&#34; COVERAGE: &#34; + legDetails[i].coverage + &#34; | &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">645</TD><TD>                    theResult.append(&#34;LEG &#34; +i +&#34; SIDE: &#34; + legDetails[i].side + &#34; | &#34;);</TD></TR><TR><TD CLASS="l">646</TD><TD>                }</TD></TR><TR><TD CLASS="l">647</TD><TD>            }</TD></TR><TR><TD CLASS="l">648</TD><TD>           </TD></TR><TR><TD CLASS="l">649</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">650</TD><TD>        theResult.append(&#34; &#34; + &#34;\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">651</TD><TD>        theResult.append(&#34; &#34; + &#34;\n&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">652</TD><TD>        return theResult;</TD></TR><TR><TD CLASS="l"><A NAME="1f">653</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">654</TD><TD> </TD></TR><TR><TD CLASS="l">655</TD><TD>    private StringBuffer checkForNoMatch(StringBuffer queryResult)</TD></TR><TR><TD CLASS="l">656</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">657</TD><TD>        if (queryResult.length() == 0)</TD></TR><TR CLASS="z"><TD CLASS="l">658</TD><TD>            queryResult = queryResult.append(NO_MATCH_FOUND);</TD></TR><TR CLASS="z"><TD CLASS="l">659</TD><TD>        return queryResult;</TD></TR><TR><TD CLASS="l">660</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="a">661</A></TD><TD> </TD></TR><TR><TD CLASS="l">662</TD><TD>    /**</TD></TR><TR><TD CLASS="l">663</TD><TD> * default constructor</TD></TR><TR><TD CLASS="l">664</TD><TD> */</TD></TR><TR CLASS="z"><TD CLASS="l">665</TD><TD>public OrderHomeImpl()</TD></TR><TR><TD CLASS="l">666</TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">667</TD><TD>        setSmaType(&#34;GlobalOrder.OrderHomeImpl&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">668</TD><TD>}</TD></TR><TR><TD CLASS="l">669</TD><TD> </TD></TR><TR><TD CLASS="l">670</TD><TD>    /**</TD></TR><TR><TD CLASS="l">671</TD><TD>     * Adds an order to the local cache and to the container if necessary.</TD></TR><TR><TD CLASS="l">672</TD><TD>     * </TD></TR><TR><TD CLASS="l">673</TD><TD>     * @param anOrderStruct OrderStruct</TD></TR><TR><TD CLASS="l"><A NAME="b">674</A></TD><TD>     * @return Order</TD></TR><TR><TD CLASS="l">675</TD><TD>     */</TD></TR><TR><TD CLASS="l">676</TD><TD>    protected void addOrderToCache(OrderImpl order)</TD></TR><TR><TD CLASS="l">677</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">678</TD><TD>        final Long orderIdString = new Long(order.getUniqueId());</TD></TR><TR CLASS="z"><TD CLASS="l">679</TD><TD>        if (order.getRemainingQuantity() &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">680</TD><TD>            OrderImpl mappedOrder = orderCache.put(orderIdString, order);</TD></TR><TR><TD CLASS="l">681</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">682</TD><TD>            int productKey = order.getProductKey().intValue();</TD></TR><TR CLASS="z"><TD CLASS="l">683</TD><TD>            String activeSession = order.getActiveSession();</TD></TR><TR><TD CLASS="l">684</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">685</TD><TD>            ConcurrentIntHashMap&lt;Map&lt;Long, Order&gt;&gt; productKeyOrderCache = null;</TD></TR><TR><TD CLASS="l">686</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">687</TD><TD>                    synchronized(productKeyOrderCacheForSessions)</TD></TR><TR><TD CLASS="l">688</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">689</TD><TD>                        productKeyOrderCache = productKeyOrderCacheForSessions.get(order.getActiveSession());</TD></TR><TR CLASS="z"><TD CLASS="l">690</TD><TD>            if(productKeyOrderCache == null)</TD></TR><TR><TD CLASS="l">691</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">692</TD><TD>                productKeyOrderCache = new ConcurrentIntHashMap&lt;Map&lt;Long, Order&gt;&gt;(23);</TD></TR><TR CLASS="z"><TD CLASS="l">693</TD><TD>                productKeyOrderCacheForSessions.put(activeSession, productKeyOrderCache);</TD></TR><TR><TD CLASS="l">694</TD><TD>            }</TD></TR><TR><TD CLASS="l">695</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">696</TD><TD>                    Map&lt;Long, Order&gt; ordersByProduct = null;</TD></TR><TR><TD CLASS="l">697</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">698</TD><TD>                    synchronized(productKeyOrderCache)</TD></TR><TR><TD CLASS="l">699</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">700</TD><TD>                        ordersByProduct = productKeyOrderCache.get(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">701</TD><TD>            if (ordersByProduct == null)</TD></TR><TR><TD CLASS="l">702</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">703</TD><TD>                ordersByProduct = new ConcurrentHashMap&lt;Long, Order&gt;(23);</TD></TR><TR CLASS="z"><TD CLASS="l">704</TD><TD>                productKeyOrderCache.put(productKey, ordersByProduct);</TD></TR><TR><TD CLASS="l">705</TD><TD>            }</TD></TR><TR><TD CLASS="l">706</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">707</TD><TD>            mappedOrder = (OrderImpl) ordersByProduct.put(orderIdString, order);</TD></TR><TR><TD CLASS="l">708</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">709</TD><TD>            if( (mappedOrder != null) &amp;&amp; (mappedOrder != order) )</TD></TR><TR><TD CLASS="l">710</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">711</TD><TD>                checkAndSetValuesForTpfRentrantOrder(mappedOrder, orderIdString, order);</TD></TR><TR><TD CLASS="l">712</TD><TD>            }</TD></TR><TR><TD CLASS="l">713</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">714</TD><TD>            if (order.treatedLikeQuote() || isGOrder(order) || order.isManualQuote()) </TD></TR><TR><TD CLASS="l">715</TD><TD>            {</TD></TR><TR><TD CLASS="l">716</TD><TD>                //TODO: potential place to register quote like order activities for UIM</TD></TR><TR CLASS="z"><TD CLASS="l">717</TD><TD>                        Map&lt;Long, Order&gt; quoteLikeOrdersByProduct = null;</TD></TR><TR CLASS="z"><TD CLASS="l">718</TD><TD>                        synchronized (quoteLikeOrdersCache)</TD></TR><TR><TD CLASS="l">719</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">720</TD><TD>                                quoteLikeOrdersByProduct =  quoteLikeOrdersCache.get(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">721</TD><TD>                    if (quoteLikeOrdersByProduct == null) </TD></TR><TR><TD CLASS="l">722</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">723</TD><TD>                    quoteLikeOrdersByProduct = new ConcurrentHashMap&lt;Long, Order&gt;(23); </TD></TR><TR CLASS="z"><TD CLASS="l">724</TD><TD>                    quoteLikeOrdersCache.put(productKey, quoteLikeOrdersByProduct);</TD></TR><TR><TD CLASS="l">725</TD><TD>                }</TD></TR><TR><TD CLASS="l">726</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">727</TD><TD>                quoteLikeOrdersByProduct.put(orderIdString, order);</TD></TR><TR><TD CLASS="l">728</TD><TD>            }</TD></TR><TR><TD CLASS="l">729</TD><TD> </TD></TR><TR><TD CLASS="l">730</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">731</TD><TD>            if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">732</TD><TD>                Log.debug(this, &#34;added order with id: &#34; + orderIdString</TD></TR><TR CLASS="z"><TD CLASS="l">733</TD><TD>                        + &#34; to local cache&#34;);</TD></TR><TR><TD CLASS="l">734</TD><TD>            }</TD></TR><TR><TD CLASS="l">735</TD><TD>            </TD></TR><TR><TD CLASS="l">736</TD><TD>            // Temporary invocation to OrderSync until the JGridner callback on</TD></TR><TR><TD CLASS="l">737</TD><TD>            // successful completion of transaction is operational</TD></TR><TR><TD CLASS="l">738</TD><TD>            </TD></TR><TR><TD CLASS="l">739</TD><TD>            // getOrderSync().updateToSync(order);</TD></TR><TR><TD CLASS="l"><A NAME="1e">740</A></TD><TD>}</TD></TR><TR CLASS="z"><TD CLASS="l">741</TD><TD>    }</TD></TR><TR><TD CLASS="l">742</TD><TD> </TD></TR><TR><TD CLASS="l">743</TD><TD>    private void checkAndSetValuesForTpfRentrantOrder(Order old_order, Long p_orderIdString, Order new_order) {</TD></TR><TR CLASS="z"><TD CLASS="l">744</TD><TD>        if ( old_order.getState() != InternalOrderStates.ROUTED_AWAY) {</TD></TR><TR CLASS="z"><TD CLASS="l">745</TD><TD>            Log.alarm(&#34;Order Object already exists in the Product cache but is replaced by the incoming Order: &#34; +p_orderIdString );</TD></TR><TR><TD CLASS="l">746</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">747</TD><TD>            //Incoming order</TD></TR><TR><TD CLASS="l">748</TD><TD>            // Incoming orders, created from TPF, usually should not have already existed in SBT</TD></TR><TR><TD CLASS="l">749</TD><TD>            // Just in case TPF re-route an order back to SBT more than once</TD></TR><TR CLASS="z"><TD CLASS="l">750</TD><TD>            if (new_order.getOrderHandlingInstruction() != null)</TD></TR><TR><TD CLASS="l">751</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">752</TD><TD>                Log.information(&#34;Order: Rerouted back, for orderId &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">753</TD><TD>                        + OrderImpl.orderIdToString(new_order.getOrderId()));</TD></TR><TR><TD CLASS="l">754</TD><TD>                // This flag is used for processing orders which are routed back to CBOE</TD></TR><TR><TD CLASS="l">755</TD><TD>                // used to cancel manual quotes</TD></TR><TR CLASS="z"><TD CLASS="l">756</TD><TD>                new_order.receivedSecondOrMoreTimesFromTPF();</TD></TR><TR><TD CLASS="l">757</TD><TD>            }</TD></TR><TR><TD CLASS="l">758</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">759</TD><TD>    }</TD></TR><TR><TD CLASS="l">760</TD><TD> </TD></TR><TR><TD CLASS="l">761</TD><TD>    /**</TD></TR><TR><TD CLASS="l">762</TD><TD>     * WARNING: assuming within class level lock</TD></TR><TR><TD CLASS="l">763</TD><TD>     * @return list of classKeys that has already cancelled I-orders</TD></TR><TR><TD CLASS="l">764</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="1d">765</A></TD><TD>    public void cancelQuoteLikeOrders(String p_userName,</TD></TR><TR><TD CLASS="l">766</TD><TD>            boolean p_systemCancel, short cancelReason)</TD></TR><TR><TD CLASS="l">767</TD><TD>            throws TransactionFailedException, SystemException,</TD></TR><TR><TD CLASS="l">768</TD><TD>            NotAcceptedException, DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">769</TD><TD>        int count = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">770</TD><TD>        IntMap&lt;List&lt;Order&gt;&gt; ordersByClass = findClassesWithQuoteLikeOrderFromUser(p_userName);</TD></TR><TR CLASS="z"><TD CLASS="l">771</TD><TD>        List&lt;Order&gt; orders = null;</TD></TR><TR CLASS="z"><TD CLASS="l">772</TD><TD>        Order order = null;</TD></TR><TR CLASS="z"><TD CLASS="l">773</TD><TD>        for (int classKey : ordersByClass.keySet())</TD></TR><TR><TD CLASS="l">774</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">775</TD><TD>            orders = ordersByClass.get(classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">776</TD><TD>            if (orders != null &amp;&amp; orders.size() &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">777</TD><TD>                for (int j = 0; j &lt; orders.size(); j++) {</TD></TR><TR CLASS="z"><TD CLASS="l">778</TD><TD>                    order = orders.get(j);</TD></TR><TR CLASS="z"><TD CLASS="l">779</TD><TD>                    if (order.isActive() &amp;&amp; (order.treatedLikeQuote() || isGOrder(order))) {</TD></TR><TR CLASS="z"><TD CLASS="l">780</TD><TD>                        order.markCancelReason(cancelReason);</TD></TR><TR CLASS="z"><TD CLASS="l">781</TD><TD>                        getBrokerService().acceptCancel(order, 0,</TD></TR><TR CLASS="z"><TD CLASS="l">782</TD><TD>                            OrderCancelTypes.CANCEL_ALL_QUANTITY,</TD></TR><TR CLASS="z"><TD CLASS="l">783</TD><TD>                            p_systemCancel ? OrderLocal.SYSTEM_CANCEL_ID : &#34;&#34;,true);</TD></TR><TR CLASS="z"><TD CLASS="l">784</TD><TD>                    count++;</TD></TR><TR><TD CLASS="l">785</TD><TD>                }</TD></TR><TR><TD CLASS="l">786</TD><TD>            }</TD></TR><TR><TD CLASS="l">787</TD><TD>        }</TD></TR><TR><TD CLASS="l">788</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">789</TD><TD>        if (count &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">790</TD><TD>            Log.information(this, &#34;Cancelling I-orders for user &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">791</TD><TD>                    + p_userName + &#34;. Total scheduled to cancel count: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">792</TD><TD>                    + count);</TD></TR><TR><TD CLASS="l">793</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">794</TD><TD>    }</TD></TR><TR><TD CLASS="l">795</TD><TD> </TD></TR><TR><TD CLASS="l">796</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="92">797</A></TD><TD>     * This method initializes the BrokerService</TD></TR><TR><TD CLASS="l">798</TD><TD>     */</TD></TR><TR><TD CLASS="l">799</TD><TD>    private synchronized void initializeBrokerService() throws SystemException {</TD></TR><TR><TD CLASS="l">800</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">801</TD><TD>            HomeFactory theHomeFactory = HomeFactory.getInstance();</TD></TR><TR CLASS="z"><TD CLASS="l">802</TD><TD>            BrokerServiceHome theHome = (BrokerServiceHome) theHomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">803</TD><TD>                    .findHome(BrokerServiceHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">804</TD><TD>            theBrokerService = theHome.find();</TD></TR><TR CLASS="z"><TD CLASS="l">805</TD><TD>            if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">806</TD><TD>                Log.debug(this, &#34;got the BrokerService &#34; + theBrokerService);</TD></TR><TR><TD CLASS="l">807</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">808</TD><TD>        } catch (CBOELoggableException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">809</TD><TD>            Log.alarm(&#34;Couldn't get BrokerService&#34;);</TD></TR><TR><TD CLASS="l">810</TD><TD>            // Remapping to SystemException</TD></TR><TR CLASS="z"><TD CLASS="l">811</TD><TD>            throw ExceptionBuilder.systemException(</TD></TR><TR CLASS="z"><TD CLASS="l">812</TD><TD>                    &#34;Unable to initialize BrokerService&#34;, 0);</TD></TR><TR><TD CLASS="l">813</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">814</TD><TD>    }</TD></TR><TR><TD CLASS="l">815</TD><TD> </TD></TR><TR><TD CLASS="l">816</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="4c">817</A></TD><TD>     * This method returns a reference to the BrokerService.</TD></TR><TR><TD CLASS="l">818</TD><TD>     * @return BrokerService</TD></TR><TR><TD CLASS="l">819</TD><TD>     */</TD></TR><TR><TD CLASS="l">820</TD><TD>    final protected BrokerService getBrokerService() throws SystemException {</TD></TR><TR CLASS="z"><TD CLASS="l">821</TD><TD>        if (theBrokerService == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">822</TD><TD>            initializeBrokerService();</TD></TR><TR><TD CLASS="l">823</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5a">824</A></TD><TD>        return theBrokerService;</TD></TR><TR><TD CLASS="l">825</TD><TD>    }</TD></TR><TR><TD CLASS="l">826</TD><TD> </TD></TR><TR><TD CLASS="l">827</TD><TD>    public String getIppProcessingStrategy(String sessionName) {</TD></TR><TR CLASS="z"><TD CLASS="l">828</TD><TD>        String strategy = (String) ippProcessingStrategies.get(sessionName);</TD></TR><TR><TD CLASS="l">829</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">830</TD><TD>        if (strategy == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">831</TD><TD>            strategy = this.DEFAULT_IPP_PROCESSING;</TD></TR><TR><TD CLASS="l">832</TD><TD>        }</TD></TR><TR><TD CLASS="l">833</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">834</TD><TD>        return strategy;</TD></TR><TR><TD CLASS="l">835</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="23">836</A></TD><TD> </TD></TR><TR><TD CLASS="l">837</TD><TD>        public Order create(OrderHandlingStruct anOrderStruct)</TD></TR><TR><TD CLASS="l">838</TD><TD>            throws TransactionFailedException, SystemException,</TD></TR><TR><TD CLASS="l">839</TD><TD>            DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">840</TD><TD>        OrderImpl order = createBaseOrder(anOrderStruct);</TD></TR><TR><TD CLASS="l">841</TD><TD>        try</TD></TR><TR><TD CLASS="l">842</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">843</TD><TD>            createLegDetailsForOrder(order, anOrderStruct);</TD></TR><TR><TD CLASS="l">844</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">845</TD><TD>        catch (DataValidationException e)</TD></TR><TR><TD CLASS="l">846</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">847</TD><TD>            deleteOrderFromCache(order);</TD></TR><TR CLASS="z"><TD CLASS="l">848</TD><TD>            throw e;</TD></TR><TR><TD CLASS="l">849</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">850</TD><TD>        catch (SystemException e)</TD></TR><TR><TD CLASS="l">851</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">852</TD><TD>            deleteOrderFromCache(order);</TD></TR><TR CLASS="z"><TD CLASS="l">853</TD><TD>            throw e;</TD></TR><TR><TD CLASS="l">854</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">855</TD><TD>        return order;</TD></TR><TR><TD CLASS="l">856</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="29">857</A></TD><TD> </TD></TR><TR><TD CLASS="l">858</TD><TD>    private Order createForBust(OrderHandlingStruct anOrderStruct)</TD></TR><TR><TD CLASS="l">859</TD><TD>            throws TransactionFailedException, SystemException,</TD></TR><TR><TD CLASS="l">860</TD><TD>            DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">861</TD><TD>        OrderImpl order = createBaseOrder(anOrderStruct);</TD></TR><TR><TD CLASS="l">862</TD><TD>        try</TD></TR><TR><TD CLASS="l">863</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">864</TD><TD>            createLegDetailsForOrderBust(order, anOrderStruct);</TD></TR><TR><TD CLASS="l">865</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">866</TD><TD>        catch (DataValidationException e)</TD></TR><TR><TD CLASS="l">867</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">868</TD><TD>            deleteOrderFromCache(order);</TD></TR><TR CLASS="z"><TD CLASS="l">869</TD><TD>            throw e;</TD></TR><TR><TD CLASS="l">870</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">871</TD><TD>        catch (SystemException e)</TD></TR><TR><TD CLASS="l">872</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">873</TD><TD>            deleteOrderFromCache(order);</TD></TR><TR CLASS="z"><TD CLASS="l">874</TD><TD>            throw e;</TD></TR><TR><TD CLASS="l">875</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">876</TD><TD>        return order;</TD></TR><TR><TD CLASS="l"><A NAME="25">877</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">878</TD><TD> </TD></TR><TR><TD CLASS="l">879</TD><TD>    private OrderImpl createBaseOrder(OrderHandlingStruct anOrderStruct)</TD></TR><TR><TD CLASS="l">880</TD><TD>            throws SystemException, DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">881</TD><TD>        OrderImpl order = new OrderImpl();</TD></TR><TR><TD CLASS="l">882</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">883</TD><TD>        order.setBypassReflection(true); // bypass reflection on initial build</TD></TR><TR CLASS="z"><TD CLASS="l">884</TD><TD>        order.setOrder(anOrderStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">885</TD><TD>        order.setBypassReflection(false); // reflection called after initial build</TD></TR><TR CLASS="z"><TD CLASS="l">886</TD><TD>        order.initializeOrderFillList();</TD></TR><TR CLASS="z"><TD CLASS="l">887</TD><TD>        order.initializeDAIMedUserList();</TD></TR><TR CLASS="z"><TD CLASS="l">888</TD><TD>        boolean theBOBClass = false;</TD></TR><TR><TD CLASS="l">889</TD><TD>        try</TD></TR><TR><TD CLASS="l">890</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">891</TD><TD>            theBOBClass = getTradingClassHome().findByKey(anOrderStruct.classKey).getIndexHybridIndicator();</TD></TR><TR><TD CLASS="l">892</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">893</TD><TD>        catch (NotFoundException e)</TD></TR><TR><TD CLASS="l">894</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">895</TD><TD>            Log.information(&#34;Unable to get Trading Class while try to get IndexHybridIndicator, will consider this as non-BOB class: &#34; + e);</TD></TR><TR><TD CLASS="l">896</TD><TD>        }</TD></TR><TR><TD CLASS="l">897</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">898</TD><TD>        if (theBOBClass &amp;&amp; anOrderStruct.productType != ProductTypes.STRATEGY &amp;&amp;</TD></TR><TR CLASS="z"><TD CLASS="l">899</TD><TD>                FirmTradingPropertyHelper.isNewBOBLinkage(anOrderStruct.sessionNames[0], anOrderStruct.classKey, anOrderStruct.productKey) &amp;&amp; </TD></TR><TR CLASS="z"><TD CLASS="l">900</TD><TD>            ExtensionsFieldParser.isManualQuoteEnabled(anOrderStruct.extensions)) {</TD></TR><TR CLASS="z"><TD CLASS="l">901</TD><TD>            order.setManulQuote(buildManualQuoteFromExtensions(anOrderStruct, anOrderStruct.extensions));</TD></TR><TR><TD CLASS="l">902</TD><TD>        }</TD></TR><TR><TD CLASS="l">903</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">904</TD><TD>        addToContainer(order);</TD></TR><TR CLASS="z"><TD CLASS="l">905</TD><TD>        addOrderToCache(order);</TD></TR><TR><TD CLASS="l">906</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">907</TD><TD>        return order;</TD></TR><TR><TD CLASS="l">908</TD><TD>    }</TD></TR><TR><TD CLASS="l">909</TD><TD> </TD></TR><TR><TD CLASS="l">910</TD><TD>    /**</TD></TR><TR><TD CLASS="l">911</TD><TD>     * creates leg details and sets the order to have the correct values. &lt;p/&gt; This method MUST</TD></TR><TR><TD CLASS="l">912</TD><TD>     * ALWAYS be called after the order has been made persistent. It's best to use createBaseOrder</TD></TR><TR><TD CLASS="l">913</TD><TD>     * before this method to ensure this occurs. EJF 8/28/2001</TD></TR><TR><TD CLASS="l">914</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="2b">915</A></TD><TD>    private void createLegDetailsForOrder(OrderImpl p_order,</TD></TR><TR><TD CLASS="l">916</TD><TD>            OrderHandlingStruct p_anOrderStruct) throws SystemException,</TD></TR><TR><TD CLASS="l">917</TD><TD>            DataValidationException {</TD></TR><TR><TD CLASS="l">918</TD><TD>        LegOrderDetailImpl[] legDetails;</TD></TR><TR CLASS="z"><TD CLASS="l">919</TD><TD>        if (p_order.getProductType() == ProductTypes.STRATEGY) {</TD></TR><TR><TD CLASS="l">920</TD><TD>            // Create the leg details for a strategy</TD></TR><TR CLASS="z"><TD CLASS="l">921</TD><TD>            legDetails = getLegOrderDetailHome().createLegDetails(p_order,</TD></TR><TR CLASS="z"><TD CLASS="l">922</TD><TD>                    p_anOrderStruct.legOrderDetails);</TD></TR><TR><TD CLASS="l">923</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">924</TD><TD>            // Or, just set leg details to be a zero-length array</TD></TR><TR CLASS="z"><TD CLASS="l">925</TD><TD>            legDetails = new LegOrderDetailImpl[0];</TD></TR><TR><TD CLASS="l">926</TD><TD>        }</TD></TR><TR><TD CLASS="l">927</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">928</TD><TD>        p_order.setLegDetails(legDetails);</TD></TR><TR><TD CLASS="l">929</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">930</TD><TD>    }</TD></TR><TR><TD CLASS="l">931</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2c">932</A></TD><TD>    private void createLegDetailsForOrderBust(OrderImpl p_order,</TD></TR><TR><TD CLASS="l">933</TD><TD>            OrderHandlingStruct p_anOrderStruct) throws SystemException,</TD></TR><TR><TD CLASS="l">934</TD><TD>            DataValidationException {</TD></TR><TR><TD CLASS="l">935</TD><TD>        LegOrderDetailImpl[] legDetails;</TD></TR><TR CLASS="z"><TD CLASS="l">936</TD><TD>        if (p_order.getProductType() == ProductTypes.STRATEGY) {</TD></TR><TR><TD CLASS="l">937</TD><TD>            // Create the leg details for a strategy</TD></TR><TR CLASS="z"><TD CLASS="l">938</TD><TD>            legDetails = getLegOrderDetailHome().createLegDetailsForBust(p_order,</TD></TR><TR CLASS="z"><TD CLASS="l">939</TD><TD>                    p_anOrderStruct.legOrderDetails);</TD></TR><TR><TD CLASS="l">940</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">941</TD><TD>            // Or, just set leg details to be a zero-length array</TD></TR><TR CLASS="z"><TD CLASS="l">942</TD><TD>            legDetails = new LegOrderDetailImpl[0];</TD></TR><TR><TD CLASS="l">943</TD><TD>        }</TD></TR><TR><TD CLASS="l">944</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">945</TD><TD>        p_order.setLegDetails(legDetails);</TD></TR><TR><TD CLASS="l">946</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3a">947</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">948</TD><TD>    </TD></TR><TR><TD CLASS="l">949</TD><TD>    LegOrderDetailImpl[] findLegDetailsForOrder(OrderImpl order) {</TD></TR><TR><TD CLASS="l">950</TD><TD>        LegOrderDetailImpl[] legDetails;</TD></TR><TR CLASS="z"><TD CLASS="l">951</TD><TD>        if (order.getProductType() == ProductTypes.STRATEGY) {</TD></TR><TR><TD CLASS="l">952</TD><TD>            // Find the leg details for a strategy.</TD></TR><TR CLASS="z"><TD CLASS="l">953</TD><TD>            legDetails = getLegOrderDetailHome().findLegDetailsForOrder(order);</TD></TR><TR><TD CLASS="l">954</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">955</TD><TD>            // Or, just set leg details to be a zero-length array</TD></TR><TR CLASS="z"><TD CLASS="l">956</TD><TD>            legDetails = new LegOrderDetailImpl[0];</TD></TR><TR><TD CLASS="l">957</TD><TD>        }</TD></TR><TR><TD CLASS="l">958</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">959</TD><TD>        return legDetails;</TD></TR><TR><TD CLASS="l">960</TD><TD>    }</TD></TR><TR><TD CLASS="l">961</TD><TD> </TD></TR><TR><TD CLASS="l">962</TD><TD>    /**</TD></TR><TR><TD CLASS="l">963</TD><TD>     * Creats a cross for an existing order with a new order</TD></TR><TR><TD CLASS="l">964</TD><TD>     * </TD></TR><TR><TD CLASS="l">965</TD><TD>     * @param existingOrder the existing order to be one side of the cross</TD></TR><TR><TD CLASS="l">966</TD><TD>     * @param newOrder the oppsite side new order to cross with the existing order</TD></TR><TR><TD CLASS="l">967</TD><TD>     * @return Cross a specific type of cross using the orders.</TD></TR><TR><TD CLASS="l">968</TD><TD>     */</TD></TR><TR><TD CLASS="l">969</TD><TD>    public Cross createCrossForExistingOrder(Order existingOrder,</TD></TR><TR><TD CLASS="l">970</TD><TD>            OrderStruct newOrderStruct, boolean processingOutOfSequence,</TD></TR><TR><TD CLASS="l"><A NAME="27">971</A></TD><TD>            boolean processingCrossWithAutoLinkedPAOrder)</TD></TR><TR><TD CLASS="l">972</TD><TD>            throws TransactionFailedException, SystemException,</TD></TR><TR><TD CLASS="l">973</TD><TD>            DataValidationException {</TD></TR><TR><TD CLASS="l">974</TD><TD>        OrderImpl order2;</TD></TR><TR CLASS="z"><TD CLASS="l">975</TD><TD>        order2 = (OrderImpl) persistOrder(newOrderStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">976</TD><TD>        return createCrossForExistingOrder(existingOrder, order2,</TD></TR><TR CLASS="z"><TD CLASS="l">977</TD><TD>                processingOutOfSequence, processingCrossWithAutoLinkedPAOrder);</TD></TR><TR><TD CLASS="l">978</TD><TD>    }</TD></TR><TR><TD CLASS="l">979</TD><TD> </TD></TR><TR><TD CLASS="l">980</TD><TD>    public Cross createCrossForExistingOrder(Order existingOrder, Order order2,</TD></TR><TR><TD CLASS="l">981</TD><TD>            boolean processingOutOfSequence,</TD></TR><TR><TD CLASS="l"><A NAME="26">982</A></TD><TD>            boolean processingCrossWithAutoLinkedPAOrder)</TD></TR><TR><TD CLASS="l">983</TD><TD>            throws TransactionFailedException, SystemException,</TD></TR><TR><TD CLASS="l">984</TD><TD>            DataValidationException {</TD></TR><TR><TD CLASS="l">985</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">986</TD><TD>        order2.inactivate();</TD></TR><TR><TD CLASS="l">987</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">988</TD><TD>        ((OrderImpl) order2).setCrossedOrder(existingOrder);</TD></TR><TR><TD CLASS="l">989</TD><TD> </TD></TR><TR><TD CLASS="l">990</TD><TD>        // create the cross</TD></TR><TR CLASS="z"><TD CLASS="l">991</TD><TD>        ExistingOrderCrossImpl cross = new ExistingOrderCrossImpl(</TD></TR><TR CLASS="z"><TD CLASS="l">992</TD><TD>                processingOutOfSequence, processingCrossWithAutoLinkedPAOrder, existingOrder.isBuySide());</TD></TR><TR><TD CLASS="l">993</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">994</TD><TD>        if (existingOrder.getSide().isBuySide()</TD></TR><TR CLASS="z"><TD CLASS="l">995</TD><TD>                || existingOrder.getSide().isAsDefinedSide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">996</TD><TD>            cross.setOrders(existingOrder, order2);</TD></TR><TR><TD CLASS="l">997</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">998</TD><TD>            cross.setOrders(order2, existingOrder);</TD></TR><TR><TD CLASS="l">999</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1000</TD><TD>        return cross;</TD></TR><TR><TD CLASS="l">1001</TD><TD>    }</TD></TR><TR><TD CLASS="l">1002</TD><TD>    </TD></TR><TR><TD CLASS="l">1003</TD><TD>    public Cross createCrossOnExistingOrders(Order existingOrder, Order order2,</TD></TR><TR><TD CLASS="l"><A NAME="28">1004</A></TD><TD>            boolean processingOutOfSequence) throws TransactionFailedException, SystemException,</TD></TR><TR><TD CLASS="l">1005</TD><TD>            DataValidationException</TD></TR><TR><TD CLASS="l">1006</TD><TD>    {</TD></TR><TR><TD CLASS="l">1007</TD><TD>        // not set to inactive for QCT match order</TD></TR><TR CLASS="z"><TD CLASS="l">1008</TD><TD>        if (!existingOrder.isQCTPrimaryOrder())</TD></TR><TR CLASS="z"><TD CLASS="l">1009</TD><TD>            order2.inactivate();</TD></TR><TR><TD CLASS="l">1010</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1011</TD><TD>        ((OrderImpl) order2).setCrossedOrder(existingOrder);</TD></TR><TR><TD CLASS="l">1012</TD><TD> </TD></TR><TR><TD CLASS="l">1013</TD><TD>        // create the cross</TD></TR><TR CLASS="z"><TD CLASS="l">1014</TD><TD>        ExistingOrderCrossImpl cross = new ExistingOrderCrossImpl(</TD></TR><TR CLASS="z"><TD CLASS="l">1015</TD><TD>                processingOutOfSequence, false, existingOrder.isBuySide());</TD></TR><TR><TD CLASS="l">1016</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1017</TD><TD>        if (existingOrder.getSide().isBuySide()</TD></TR><TR CLASS="z"><TD CLASS="l">1018</TD><TD>                || existingOrder.getSide().isAsDefinedSide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1019</TD><TD>            cross.setOrders(existingOrder, order2);</TD></TR><TR><TD CLASS="l">1020</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1021</TD><TD>            cross.setOrders(order2, existingOrder);</TD></TR><TR><TD CLASS="l">1022</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1023</TD><TD>        return cross;</TD></TR><TR><TD CLASS="l">1024</TD><TD>    }</TD></TR><TR><TD CLASS="l">1025</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="2d">1026</A></TD><TD>    public Order createLinkageOrder(Order heldOrder, String userId,</TD></TR><TR><TD CLASS="l">1027</TD><TD>            int quantity, Price price, String exchange)</TD></TR><TR><TD CLASS="l">1028</TD><TD>            throws TransactionFailedException, DataValidationException,</TD></TR><TR><TD CLASS="l">1029</TD><TD>            SystemException {</TD></TR><TR CLASS="z"><TD CLASS="l">1030</TD><TD>        Order order = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1031</TD><TD>        OrderStruct heldOrderStruct = heldOrder.getOrderStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1032</TD><TD>        OrderStruct orderStruct = OrderStructBuilder.buildOrderStruct();</TD></TR><TR><TD CLASS="l">1033</TD><TD> </TD></TR><TR><TD CLASS="l">1034</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1035</TD><TD>            OrderHome orderHome = DomainObjectHelper.getOrderHome();</TD></TR><TR><TD CLASS="l">1036</TD><TD> </TD></TR><TR><TD CLASS="l">1037</TD><TD>            String subAccount;</TD></TR><TR><TD CLASS="l">1038</TD><TD>            String account;</TD></TR><TR><TD CLASS="l">1039</TD><TD>            ExchangeFirmStruct clearingFirm;</TD></TR><TR><TD CLASS="l">1040</TD><TD>            SessionProfileUserStruct user;</TD></TR><TR><TD CLASS="l">1041</TD><TD>            SessionProfileStruct profile;</TD></TR><TR><TD CLASS="l">1042</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1043</TD><TD>            user = BusinessServicesHelper.getUserService()</TD></TR><TR CLASS="z"><TD CLASS="l">1044</TD><TD>                    .getSessionProfileUserInformation(userId);</TD></TR><TR CLASS="z"><TD CLASS="l">1045</TD><TD>            profile = getProfile(user, heldOrder.getClassKey(), heldOrder</TD></TR><TR CLASS="z"><TD CLASS="l">1046</TD><TD>                    .getActiveSession());</TD></TR><TR><TD CLASS="l">1047</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1048</TD><TD>            if (profile != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1049</TD><TD>                account = profile.account;</TD></TR><TR CLASS="z"><TD CLASS="l">1050</TD><TD>                subAccount = profile.subAccount;</TD></TR><TR CLASS="z"><TD CLASS="l">1051</TD><TD>                clearingFirm = profile.executingGiveupFirm;</TD></TR><TR><TD CLASS="l">1052</TD><TD>            } else { // this should not happen, because user will always has a default profile</TD></TR><TR CLASS="z"><TD CLASS="l">1053</TD><TD>                account = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1054</TD><TD>                subAccount = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1055</TD><TD>                clearingFirm = user.firm;</TD></TR><TR><TD CLASS="l">1056</TD><TD>            }</TD></TR><TR><TD CLASS="l">1057</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1058</TD><TD>            orderStruct.orderId = OrderStructBuilder.buildOrderIdStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1059</TD><TD>            orderStruct.orderId.executingOrGiveUpFirm = clearingFirm;</TD></TR><TR><TD CLASS="l">1060</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1061</TD><TD>            orderStruct.orderId = getOrderIdGeneratorHome().generateOrderId(</TD></TR><TR CLASS="z"><TD CLASS="l">1062</TD><TD>                    orderStruct);</TD></TR><TR><TD CLASS="l">1063</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1064</TD><TD>            orderStruct.originator = user.userAcronym;</TD></TR><TR CLASS="z"><TD CLASS="l">1065</TD><TD>            orderStruct.originalQuantity = quantity;</TD></TR><TR CLASS="z"><TD CLASS="l">1066</TD><TD>            orderStruct.productKey = heldOrderStruct.productKey;</TD></TR><TR CLASS="z"><TD CLASS="l">1067</TD><TD>            orderStruct.side = getSide( heldOrderStruct );            </TD></TR><TR CLASS="z"><TD CLASS="l">1068</TD><TD>            orderStruct.price = price.toStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1069</TD><TD>            orderStruct.timeInForce = TimesInForce.DAY;</TD></TR><TR CLASS="z"><TD CLASS="l">1070</TD><TD>            orderStruct.contingency = OrderStructBuilder</TD></TR><TR CLASS="z"><TD CLASS="l">1071</TD><TD>                    .buildOrderContingencyStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1072</TD><TD>            orderStruct.contingency.type = ContingencyTypes.IOC;</TD></TR><TR><TD CLASS="l">1073</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1074</TD><TD>            ExtensionsHelper extensionsHelper = new ExtensionsHelper();</TD></TR><TR CLASS="z"><TD CLASS="l">1075</TD><TD>            extensionsHelper.setValue(ExtensionFields.EXCHANGE_DESTINATION, exchange);</TD></TR><TR><TD CLASS="l">1076</TD><TD>            // Extra information to select linkage router in OHS: Prefered router(optional)</TD></TR><TR><TD CLASS="l">1077</TD><TD>            // and the original executing firm</TD></TR><TR><TD CLASS="l">1078</TD><TD>            //TODO: Change to the correct extension field</TD></TR><TR CLASS="z"><TD CLASS="l">1079</TD><TD>            extensionsHelper.setValue( ExtensionFields.ORIGINAL_ORDER_ACRONYM, heldOrderStruct.orderId.executingOrGiveUpFirm.firmNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">1080</TD><TD>            String preferedRouter = getPreferedRouterVendor( heldOrderStruct );</TD></TR><TR CLASS="z"><TD CLASS="l">1081</TD><TD>            if ( preferedRouter != null )</TD></TR><TR CLASS="z"><TD CLASS="l">1082</TD><TD>            {   extensionsHelper.setValue( ExtensionFields.BROKER_ROUTING_ID, preferedRouter);</TD></TR><TR><TD CLASS="l">1083</TD><TD>            }</TD></TR><TR><TD CLASS="l">1084</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1085</TD><TD>            orderStruct.extensions = extensionsHelper.toString();</TD></TR><TR CLASS="z"><TD CLASS="l">1086</TD><TD>            orderStruct.account = account;</TD></TR><TR CLASS="z"><TD CLASS="l">1087</TD><TD>            orderStruct.subaccount = subAccount;</TD></TR><TR CLASS="z"><TD CLASS="l">1088</TD><TD>            orderStruct.orderOriginType = OrderOrigins.PRINCIPAL_ACTING_AS_AGENT;</TD></TR><TR CLASS="z"><TD CLASS="l">1089</TD><TD>            orderStruct.userId = userId;</TD></TR><TR CLASS="z"><TD CLASS="l">1090</TD><TD>            orderStruct.userAcronym = user.userAcronym;</TD></TR><TR CLASS="z"><TD CLASS="l">1091</TD><TD>            orderStruct.productType = heldOrderStruct.productType;</TD></TR><TR CLASS="z"><TD CLASS="l">1092</TD><TD>            orderStruct.classKey = heldOrderStruct.classKey;</TD></TR><TR CLASS="z"><TD CLASS="l">1093</TD><TD>            orderStruct.state = OrderStates.ACTIVE;</TD></TR><TR CLASS="z"><TD CLASS="l">1094</TD><TD>            orderStruct.source = Sources.SBT;</TD></TR><TR CLASS="z"><TD CLASS="l">1095</TD><TD>            orderStruct.activeSession = heldOrder.getActiveSession();</TD></TR><TR CLASS="z"><TD CLASS="l">1096</TD><TD>            orderStruct.sessionNames = heldOrderStruct.sessionNames;</TD></TR><TR CLASS="z"><TD CLASS="l">1097</TD><TD>            orderStruct.legOrderDetails = new LegOrderDetailStruct[0];</TD></TR><TR CLASS="z"><TD CLASS="l">1098</TD><TD>            orderStruct.positionEffect = PositionEffects.NOTAPPLICABLE;</TD></TR><TR CLASS="z"><TD CLASS="l">1099</TD><TD>            orderStruct.userAssignedId = Order.SYSTEM_LINK_ORDER_USER_ASSIGNED_ID;            </TD></TR><TR><TD CLASS="l">1100</TD><TD> </TD></TR><TR><TD CLASS="l">1101</TD><TD>            //Try a few times to create the order if we get a duplicate.  We really should not get a </TD></TR><TR><TD CLASS="l">1102</TD><TD>            //duplicate so there is some sort of problem if we do, but if we retry with a different </TD></TR><TR><TD CLASS="l">1103</TD><TD>            //sequence we might succeed.</TD></TR><TR CLASS="z"><TD CLASS="l">1104</TD><TD>            int cnt = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1105</TD><TD>            while (order == null) {</TD></TR><TR><TD CLASS="l">1106</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">1107</TD><TD>                    order = orderHome.persistOrder(orderStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">1108</TD><TD>                } catch (DataValidationException e) {</TD></TR><TR><TD CLASS="l">1109</TD><TD>                    Log</TD></TR><TR CLASS="z"><TD CLASS="l">1110</TD><TD>                            .alarm(</TD></TR><TR CLASS="z"><TD CLASS="l">1111</TD><TD>                                    this,</TD></TR><TR CLASS="z"><TD CLASS="l">1112</TD><TD>                                    &#34;DuplicateOrderIdException on createLinkageOrder error on order(heldOrder//linkageOrder): &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1113</TD><TD>                                            + heldOrder</TD></TR><TR CLASS="z"><TD CLASS="l">1114</TD><TD>                                            + &#34;//&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1115</TD><TD>                                            + StructToString</TD></TR><TR CLASS="z"><TD CLASS="l">1116</TD><TD>                                                    .toString(orderStruct.orderId));</TD></TR><TR CLASS="z"><TD CLASS="l">1117</TD><TD>                    orderStruct.orderId = getOrderIdGeneratorHome()</TD></TR><TR CLASS="z"><TD CLASS="l">1118</TD><TD>                            .generateOrderId(orderStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">1119</TD><TD>                    cnt++;</TD></TR><TR CLASS="z"><TD CLASS="l">1120</TD><TD>                    if (cnt == 3) {</TD></TR><TR CLASS="z"><TD CLASS="l">1121</TD><TD>                        throw ExceptionBuilder</TD></TR><TR CLASS="z"><TD CLASS="l">1122</TD><TD>                                .systemException(</TD></TR><TR CLASS="z"><TD CLASS="l">1123</TD><TD>                                        &#34;Cannot generate PA order due to duplicate order ids&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1124</TD><TD>                                        0);</TD></TR><TR><TD CLASS="l">1125</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1126</TD><TD>                }</TD></TR><TR><TD CLASS="l">1127</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1128</TD><TD>        } catch (ParseException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1129</TD><TD>            Log.exception(</TD></TR><TR CLASS="z"><TD CLASS="l">1130</TD><TD>                    &#34;Could not set the destination exchange on the PA order: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1131</TD><TD>                            + heldOrder, e);</TD></TR><TR CLASS="z"><TD CLASS="l">1132</TD><TD>            throw ExceptionBuilder.systemException(e.getMessage(), 0);</TD></TR><TR CLASS="z"><TD CLASS="l">1133</TD><TD>        } catch (NotFoundException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1134</TD><TD>            Log.alarm(&#34;Agent not found for held order: &#34; + heldOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">1135</TD><TD>            throw ExceptionBuilder.systemException(e.getMessage(), 0);</TD></TR><TR CLASS="z"><TD CLASS="l">1136</TD><TD>        } catch (AuthorizationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1137</TD><TD>            Log.exception(this, e);</TD></TR><TR CLASS="z"><TD CLASS="l">1138</TD><TD>            throw ExceptionBuilder.systemException(e.getMessage(), 0);</TD></TR><TR CLASS="z"><TD CLASS="l">1139</TD><TD>        } catch (CommunicationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1140</TD><TD>            Log.exception(this, e);</TD></TR><TR CLASS="z"><TD CLASS="l">1141</TD><TD>            throw ExceptionBuilder.systemException(e.getMessage(), 0);</TD></TR><TR><TD CLASS="l">1142</TD><TD>        }</TD></TR><TR><TD CLASS="l">1143</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1144</TD><TD>        return order;</TD></TR><TR><TD CLASS="l">1145</TD><TD>    }</TD></TR><TR><TD CLASS="l">1146</TD><TD> </TD></TR><TR><TD CLASS="l">1147</TD><TD> </TD></TR><TR><TD CLASS="l">1148</TD><TD> </TD></TR><TR><TD CLASS="l">1149</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1150</TD><TD>     * Creates a new cross order.</TD></TR><TR><TD CLASS="l">1151</TD><TD>     *</TD></TR><TR><TD CLASS="l">1152</TD><TD>     * @param anOrderStruct OrderStruct1</TD></TR><TR><TD CLASS="l">1153</TD><TD>     * @param anOrderStruct OrderStruct2</TD></TR><TR><TD CLASS="l">1154</TD><TD>     * @return Cross</TD></TR><TR><TD CLASS="l">1155</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="24">1156</A></TD><TD>    public Cross create(OrderHandlingStruct anOrderStruct1,</TD></TR><TR><TD CLASS="l">1157</TD><TD>            OrderHandlingStruct anOrderStruct2)</TD></TR><TR><TD CLASS="l">1158</TD><TD>            throws TransactionFailedException, SystemException,</TD></TR><TR><TD CLASS="l">1159</TD><TD>            DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">1160</TD><TD>        OrderImpl order1 = (OrderImpl) create(anOrderStruct1);</TD></TR><TR CLASS="z"><TD CLASS="l">1161</TD><TD>        order1.activate();</TD></TR><TR CLASS="z"><TD CLASS="l">1162</TD><TD>        OrderImpl order2 = (OrderImpl) create(anOrderStruct2);</TD></TR><TR CLASS="z"><TD CLASS="l">1163</TD><TD>        order2.activate();</TD></TR><TR><TD CLASS="l">1164</TD><TD> </TD></TR><TR><TD CLASS="l">1165</TD><TD>        // Establish the releationship between the two orders</TD></TR><TR CLASS="z"><TD CLASS="l">1166</TD><TD>        order1.setCrossedOrder(order2);</TD></TR><TR CLASS="z"><TD CLASS="l">1167</TD><TD>        order2.setCrossedOrder(order1);</TD></TR><TR><TD CLASS="l">1168</TD><TD> </TD></TR><TR><TD CLASS="l">1169</TD><TD>        // create the cross</TD></TR><TR CLASS="z"><TD CLASS="l">1170</TD><TD>        CrossImpl cross = new CrossImpl();</TD></TR><TR CLASS="z"><TD CLASS="l">1171</TD><TD>        cross.setOrders(order1, order2);</TD></TR><TR CLASS="z"><TD CLASS="l">1172</TD><TD>        return cross;</TD></TR><TR><TD CLASS="l">1173</TD><TD>    }</TD></TR><TR><TD CLASS="l">1174</TD><TD> </TD></TR><TR><TD CLASS="l">1175</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1176</TD><TD>     * Retrieve the order with the specified order id.</TD></TR><TR><TD CLASS="l">1177</TD><TD>     *</TD></TR><TR><TD CLASS="l">1178</TD><TD>     * @param orderId OrderIdStruct</TD></TR><TR><TD CLASS="l"><A NAME="3b">1179</A></TD><TD>     * @return Order</TD></TR><TR><TD CLASS="l">1180</TD><TD>     */</TD></TR><TR><TD CLASS="l">1181</TD><TD>    public  Order findOrder(OrderIdStruct orderId)</TD></TR><TR><TD CLASS="l">1182</TD><TD>            throws TransactionFailedException, NotFoundException {</TD></TR><TR CLASS="z"><TD CLASS="l">1183</TD><TD>        OrderImpl retOrder = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1184</TD><TD>        if (orderId.highCboeId != 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1185</TD><TD>            CboeIdStruct cboeId = new CboeIdStruct(orderId.highCboeId,</TD></TR><TR CLASS="z"><TD CLASS="l">1186</TD><TD>                    orderId.lowCboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">1187</TD><TD>            long orderKey = CboeId.longValue(cboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">1188</TD><TD>            retOrder = (OrderImpl) findOrder(orderKey);</TD></TR><TR><TD CLASS="l">1189</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1190</TD><TD>        return retOrder;</TD></TR><TR><TD CLASS="l">1191</TD><TD>    }</TD></TR><TR><TD CLASS="l">1192</TD><TD> </TD></TR><TR><TD CLASS="l">1193</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1194</TD><TD>     * Retrieve the order with the specified CboeId, this method is used to Qry OHS if orde is not</TD></TR><TR><TD CLASS="l">1195</TD><TD>     * found in TE and update TE's Cache</TD></TR><TR><TD CLASS="l">1196</TD><TD>     * </TD></TR><TR><TD CLASS="l">1197</TD><TD>     * @param sessionName String</TD></TR><TR><TD CLASS="l">1198</TD><TD>     * @param productKey int</TD></TR><TR><TD CLASS="l">1199</TD><TD>     * @param orderId OrderIdStruct</TD></TR><TR><TD CLASS="l">1200</TD><TD>     * @return Order</TD></TR><TR><TD CLASS="l"><A NAME="3c">1201</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1202</TD><TD>    public  Order findOrder(String sessionName, int productKey,</TD></TR><TR><TD CLASS="l">1203</TD><TD>            CboeIdStruct cboeOrderId) throws TransactionFailedException,</TD></TR><TR><TD CLASS="l">1204</TD><TD>            NotFoundException {</TD></TR><TR CLASS="z"><TD CLASS="l">1205</TD><TD>        OrderImpl retOrder = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1206</TD><TD>        if (cboeOrderId.highCboeId != 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1207</TD><TD>            long orderKey = CboeId.longValue(cboeOrderId);</TD></TR><TR><TD CLASS="l">1208</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1209</TD><TD>                retOrder = (OrderImpl) findOrder(orderKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1210</TD><TD>            } catch (NotFoundException nfe) {</TD></TR><TR><TD CLASS="l">1211</TD><TD>                Log</TD></TR><TR CLASS="z"><TD CLASS="l">1212</TD><TD>                        .information(&#34;Order Not available in TE for Order(highCboeId+lowCboeid): &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1213</TD><TD>                                + orderKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1214</TD><TD>                retOrder = getOrderFromOHS(sessionName, productKey, cboeOrderId);</TD></TR><TR><TD CLASS="l">1215</TD><TD>            }</TD></TR><TR><TD CLASS="l">1216</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1217</TD><TD>            retOrder = getOrderFromOHS(sessionName, productKey, cboeOrderId);</TD></TR><TR><TD CLASS="l">1218</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1219</TD><TD>        return retOrder;</TD></TR><TR><TD CLASS="l">1220</TD><TD>    }</TD></TR><TR><TD CLASS="l">1221</TD><TD> </TD></TR><TR><TD CLASS="l">1222</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1223</TD><TD>     * Returns Order matching key</TD></TR><TR><TD CLASS="l">1224</TD><TD>     * </TD></TR><TR><TD CLASS="l">1225</TD><TD>     * @param    long uniqueId</TD></TR><TR><TD CLASS="l">1226</TD><TD>     * @return com.cboe.interfaces.domain.Order</TD></TR><TR><TD CLASS="l"><A NAME="3d">1227</A></TD><TD>     * @throws DataValidationException when the order is not found</TD></TR><TR><TD CLASS="l">1228</TD><TD>     */</TD></TR><TR><TD CLASS="l">1229</TD><TD>    public  Order findOrder(long uniqueId)</TD></TR><TR><TD CLASS="l">1230</TD><TD>            throws TransactionFailedException, NotFoundException {</TD></TR><TR CLASS="z"><TD CLASS="l">1231</TD><TD>        Order order = getOrderFromCache(uniqueId);</TD></TR><TR CLASS="z"><TD CLASS="l">1232</TD><TD>        if (order == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1233</TD><TD>            throw ExceptionBuilder.notFoundException(</TD></TR><TR CLASS="z"><TD CLASS="l">1234</TD><TD>                    &#34;Order not found in TE for id = &#34; + uniqueId,</TD></TR><TR CLASS="z"><TD CLASS="l">1235</TD><TD>                    NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">1236</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1237</TD><TD>        return order;</TD></TR><TR><TD CLASS="l">1238</TD><TD>    }</TD></TR><TR><TD CLASS="l">1239</TD><TD> </TD></TR><TR><TD CLASS="l">1240</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1241</TD><TD>     * Gets an order from the local cache by the uniqueId</TD></TR><TR><TD CLASS="l">1242</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="6c">1243</A></TD><TD>     * @param anOrderStruct OrderStruct</TD></TR><TR><TD CLASS="l">1244</TD><TD>     * @return OrderImpl</TD></TR><TR><TD CLASS="l">1245</TD><TD>     */</TD></TR><TR><TD CLASS="l">1246</TD><TD>    private OrderImpl getOrderFromCache(long uniqueId) {</TD></TR><TR CLASS="z"><TD CLASS="l">1247</TD><TD>        return (OrderImpl) orderCache.get(new Long(uniqueId));</TD></TR><TR><TD CLASS="l">1248</TD><TD>    }</TD></TR><TR><TD CLASS="l">1249</TD><TD> </TD></TR><TR><TD CLASS="l">1250</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1251</TD><TD>     * This method returns (initializes if necessary) the OrderHistoryHome.</TD></TR><TR><TD CLASS="l">1252</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="6f">1253</A></TD><TD>     * @return com.cboe.interfaces.domain.OrderHistoryHome</TD></TR><TR><TD CLASS="l">1254</TD><TD>     * @author Werner Kubitsch</TD></TR><TR><TD CLASS="l">1255</TD><TD>     */</TD></TR><TR><TD CLASS="l">1256</TD><TD>    protected OrderHistoryHome getOrderHistoryHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">1257</TD><TD>        if (theOrderHistoryHome == null) {</TD></TR><TR><TD CLASS="l">1258</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1259</TD><TD>                HomeFactory theHomeFactory = HomeFactory.getInstance();</TD></TR><TR CLASS="z"><TD CLASS="l">1260</TD><TD>                theOrderHistoryHome = (OrderHistoryHome) theHomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">1261</TD><TD>                        .findHome(OrderHistoryHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">1262</TD><TD>                if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1263</TD><TD>                    Log.debug(this, &#34;got the OrderHistoryHome &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1264</TD><TD>                            + theOrderHistoryHome);</TD></TR><TR><TD CLASS="l">1265</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1266</TD><TD>            } catch (com.cboe.infrastructureServices.foundationFramework.exceptionHandling.CBOELoggableException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1267</TD><TD>                Log.alarm(this, &#34;couldn't initialize Order History Home&#34;);</TD></TR><TR><TD CLASS="l">1268</TD><TD>            }</TD></TR><TR><TD CLASS="l">1269</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1270</TD><TD>        return theOrderHistoryHome;</TD></TR><TR><TD CLASS="l">1271</TD><TD>    }</TD></TR><TR><TD CLASS="l">1272</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="71">1273</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">1274</TD><TD>     * This method returns (initializes if necessary) the OrderMaintenanceServiceHome.</TD></TR><TR><TD CLASS="l">1275</TD><TD>     */</TD></TR><TR><TD CLASS="l">1276</TD><TD>    protected OHSOrderMaintenanceServiceHome getOrderMaintenanceServiceHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">1277</TD><TD>        if (orderMaintenanceServiceHome == null) {</TD></TR><TR><TD CLASS="l">1278</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1279</TD><TD>                HomeFactory theHomeFactory = HomeFactory.getInstance();</TD></TR><TR CLASS="z"><TD CLASS="l">1280</TD><TD>                orderMaintenanceServiceHome = (OHSOrderMaintenanceServiceHome) theHomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">1281</TD><TD>                        .findHome(OHSOrderMaintenanceServiceHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">1282</TD><TD>                if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1283</TD><TD>                    Log.debug(this, &#34;got the OrderMaintenanceServiceHome &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1284</TD><TD>                            + orderMaintenanceServiceHome);</TD></TR><TR><TD CLASS="l">1285</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1286</TD><TD>            } catch (com.cboe.infrastructureServices.foundationFramework.exceptionHandling.CBOELoggableException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1287</TD><TD>                Log.alarm(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1288</TD><TD>                        &#34;couldn't initialize OrderMaintenanceServiceHome&#34;);</TD></TR><TR><TD CLASS="l">1289</TD><TD>            }</TD></TR><TR><TD CLASS="l">1290</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1291</TD><TD>        return orderMaintenanceServiceHome;</TD></TR><TR><TD CLASS="l">1292</TD><TD>    }</TD></TR><TR><TD CLASS="l">1293</TD><TD> </TD></TR><TR><TD CLASS="l">1294</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1295</TD><TD>     * This method will return the event channel, initializing it if necessary</TD></TR><TR><TD CLASS="l"><A NAME="75">1296</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">1297</TD><TD>     * @return com.cboe.events.interfaces.OrderStatusConsumer</TD></TR><TR><TD CLASS="l">1298</TD><TD>     */</TD></TR><TR><TD CLASS="l">1299</TD><TD>    protected OrderStatusConsumer getOrderStatusPublisher() {</TD></TR><TR CLASS="z"><TD CLASS="l">1300</TD><TD>        if (null == orderStatusPublisher) {</TD></TR><TR CLASS="z"><TD CLASS="l">1301</TD><TD>            orderStatusPublisher = EventHomes.getOrderStatusConsumerHome()</TD></TR><TR CLASS="z"><TD CLASS="l">1302</TD><TD>                    .find();</TD></TR><TR><TD CLASS="l">1303</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1304</TD><TD>        return orderStatusPublisher;</TD></TR><TR><TD CLASS="l">1305</TD><TD>    }</TD></TR><TR><TD CLASS="l">1306</TD><TD> </TD></TR><TR><TD CLASS="l">1307</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1308</TD><TD>     * This method will return the event channel, initializing it if necessary</TD></TR><TR><TD CLASS="l"><A NAME="57">1309</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">1310</TD><TD>     * @return com.cboe.events.interfaces.InternalOrderStatusConsumer</TD></TR><TR><TD CLASS="l">1311</TD><TD>     */</TD></TR><TR><TD CLASS="l">1312</TD><TD>    private InternalOrderStatusConsumer getInternalOrderStatusPublisher() {</TD></TR><TR CLASS="z"><TD CLASS="l">1313</TD><TD>        if (null == internalOrderStatusPublisher) {</TD></TR><TR CLASS="z"><TD CLASS="l">1314</TD><TD>            internalOrderStatusPublisher = EventHomes</TD></TR><TR CLASS="z"><TD CLASS="l">1315</TD><TD>                    .getInternalOrderStatusConsumerHome().find();</TD></TR><TR><TD CLASS="l">1316</TD><TD> </TD></TR><TR><TD CLASS="l">1317</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1318</TD><TD>        return internalOrderStatusPublisher;</TD></TR><TR><TD CLASS="l">1319</TD><TD>    }</TD></TR><TR><TD CLASS="l">1320</TD><TD> </TD></TR><TR><TD CLASS="l">1321</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1322</TD><TD>     * This method will return the event channel, initializing it if necessary</TD></TR><TR><TD CLASS="l"><A NAME="8a">1323</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">1324</TD><TD>     * @return com.cboe.events.interfaces.InternalOrderStatusConsumer</TD></TR><TR><TD CLASS="l">1325</TD><TD>     */</TD></TR><TR><TD CLASS="l">1326</TD><TD>    private InternalOrderStatusConsumer getTransientInternalOrderStatusPublisher() {</TD></TR><TR CLASS="z"><TD CLASS="l">1327</TD><TD>        if (null == transientInternalOrderStatusPublisher) {</TD></TR><TR CLASS="z"><TD CLASS="l">1328</TD><TD>            transientInternalOrderStatusPublisher = EventHomes</TD></TR><TR CLASS="z"><TD CLASS="l">1329</TD><TD>                    .getTransientInternalOrderStatusConsumerHome().find();</TD></TR><TR><TD CLASS="l">1330</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1331</TD><TD>        return transientInternalOrderStatusPublisher;</TD></TR><TR><TD CLASS="l">1332</TD><TD>    }</TD></TR><TR><TD CLASS="l">1333</TD><TD> </TD></TR><TR><TD CLASS="l">1334</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1335</TD><TD>     * This method will return the event channel, initializing it if necessary</TD></TR><TR><TD CLASS="l">1336</TD><TD>     * This will return the Non-GMD (transient) channel publisher connected to that channel </TD></TR><TR><TD CLASS="l">1337</TD><TD>     * or will return the regualar (Reliable) channel publisher.</TD></TR><TR><TD CLASS="l">1338</TD><TD>     * @return com.cboe.events.interfaces.InternalOrderStatusConsumer</TD></TR><TR><TD CLASS="l"><A NAME="58">1339</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1340</TD><TD>    public InternalOrderStatusConsumer getInternalOrderStatusPublisher(</TD></TR><TR><TD CLASS="l">1341</TD><TD>            Order order, short eventType) {</TD></TR><TR><TD CLASS="l">1342</TD><TD>        //may be we could configure this?</TD></TR><TR CLASS="z"><TD CLASS="l">1343</TD><TD>        if (order == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1344</TD><TD>            return internalOrderStatusPublisher;</TD></TR><TR><TD CLASS="l">1345</TD><TD>        }</TD></TR><TR><TD CLASS="l">1346</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1347</TD><TD>        return transientInternalOrderStatusPublisher;</TD></TR><TR><TD CLASS="l">1348</TD><TD> </TD></TR><TR><TD CLASS="l">1349</TD><TD>    }</TD></TR><TR><TD CLASS="l">1350</TD><TD> </TD></TR><TR><TD CLASS="l">1351</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1352</TD><TD>     * This method will return the event channel, initializing it if necessary</TD></TR><TR><TD CLASS="l"><A NAME="5e">1353</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">1354</TD><TD>     * @return com.cboe.events.interfaces.OrderUpdateEventConsumer</TD></TR><TR><TD CLASS="l">1355</TD><TD>     */</TD></TR><TR><TD CLASS="l">1356</TD><TD>    protected MarketAlertConsumer getMarketAlertPublisher() {</TD></TR><TR CLASS="z"><TD CLASS="l">1357</TD><TD>        if (null == marketAlertPublisher) {</TD></TR><TR CLASS="z"><TD CLASS="l">1358</TD><TD>            marketAlertPublisher = EventHomes.getMarketAlertConsumerHome()</TD></TR><TR CLASS="z"><TD CLASS="l">1359</TD><TD>                    .find();</TD></TR><TR><TD CLASS="l">1360</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1361</TD><TD>        return marketAlertPublisher;</TD></TR><TR><TD CLASS="l">1362</TD><TD>    }</TD></TR><TR><TD CLASS="l">1363</TD><TD> </TD></TR><TR><TD CLASS="l">1364</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1365</TD><TD>     * This method will return the event channel, initializing it if necessary</TD></TR><TR><TD CLASS="l"><A NAME="56">1366</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">1367</TD><TD>     * @return com.cboe.events.interfaces.IntermarketOrderStatusConsumer</TD></TR><TR><TD CLASS="l">1368</TD><TD>     */</TD></TR><TR><TD CLASS="l">1369</TD><TD>    protected IntermarketOrderStatusConsumer getIntermarketOrderStatusPublisher() {</TD></TR><TR CLASS="z"><TD CLASS="l">1370</TD><TD>        if (null == intermarketOrderStatusPublisher) {</TD></TR><TR CLASS="z"><TD CLASS="l">1371</TD><TD>            intermarketOrderStatusPublisher = EventHomes</TD></TR><TR CLASS="z"><TD CLASS="l">1372</TD><TD>                    .getIntermarketOrderStatusConsumerHome().find();</TD></TR><TR><TD CLASS="l">1373</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1374</TD><TD>        return intermarketOrderStatusPublisher;</TD></TR><TR><TD CLASS="l">1375</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="55">1376</A></TD><TD> </TD></TR><TR><TD CLASS="l">1377</TD><TD>   </TD></TR><TR><TD CLASS="l">1378</TD><TD> </TD></TR><TR><TD CLASS="l">1379</TD><TD>    protected String getIPPMinSizeProcessingIndicator() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="63">1380</A></TD><TD>        return ippMinSizeProcessingIndicator;</TD></TR><TR><TD CLASS="l">1381</TD><TD>    }</TD></TR><TR><TD CLASS="l">1382</TD><TD> </TD></TR><TR><TD CLASS="l">1383</TD><TD>    public int getMaxRetriesOfNBBOProtectionRouting() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="a5">1384</A></TD><TD>        return maxRetriesOfNBBOProtectionRouting;</TD></TR><TR><TD CLASS="l">1385</TD><TD>    }</TD></TR><TR><TD CLASS="l">1386</TD><TD> </TD></TR><TR><TD CLASS="l">1387</TD><TD>    protected boolean isAnonymousTradingIfNotClearsLikeQuote() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="11">1388</A></TD><TD>        return anonymousTradingIfNotClearsLikeQuote;</TD></TR><TR><TD CLASS="l">1389</TD><TD>    }</TD></TR><TR><TD CLASS="l">1390</TD><TD> </TD></TR><TR><TD CLASS="l">1391</TD><TD>    protected boolean blankAccountIfSameAsAcr() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="49">1392</A></TD><TD>        return ifBlankAccountIfSameAsAcr;</TD></TR><TR><TD CLASS="l">1393</TD><TD>    }</TD></TR><TR><TD CLASS="l">1394</TD><TD> </TD></TR><TR><TD CLASS="l">1395</TD><TD>    protected String getAnonymousIfNotClearsLikeQuoteBroker() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5d">1396</A></TD><TD>        return anonymousIfNotClearsLikeQuoteBroker;</TD></TR><TR><TD CLASS="l">1397</TD><TD>    }</TD></TR><TR><TD CLASS="l">1398</TD><TD> </TD></TR><TR><TD CLASS="l">1399</TD><TD>    protected String getManualQuoteContraOrderBroker() {</TD></TR><TR CLASS="z"><TD CLASS="l">1400</TD><TD>        return manualQuoteContraOrderBroker;</TD></TR><TR><TD CLASS="l"><A NAME="59">1401</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1402</TD><TD>    </TD></TR><TR><TD CLASS="l">1403</TD><TD> </TD></TR><TR><TD CLASS="l">1404</TD><TD>    protected String getInternalizationAuctionTradeBroker() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="86">1405</A></TD><TD>        return internalizationAuctionTradeBroker;</TD></TR><TR><TD CLASS="l">1406</TD><TD>    }</TD></TR><TR><TD CLASS="l">1407</TD><TD> </TD></TR><TR><TD CLASS="l">1408</TD><TD>    protected String[] getTradeAndShipCodes() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="80">1409</A></TD><TD>        return tradeAndShipCodes;</TD></TR><TR><TD CLASS="l">1410</TD><TD>    }</TD></TR><TR><TD CLASS="l">1411</TD><TD> </TD></TR><TR><TD CLASS="l">1412</TD><TD>    protected String[] getSalableCodes() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="7f">1413</A></TD><TD>        return salableCodes;</TD></TR><TR><TD CLASS="l">1414</TD><TD>    }</TD></TR><TR><TD CLASS="l">1415</TD><TD> </TD></TR><TR><TD CLASS="l">1416</TD><TD>    protected int getReserveOrderRefreshSize() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="10">1417</A></TD><TD>        return reserveOrderRefreshSize;</TD></TR><TR><TD CLASS="l">1418</TD><TD>    }</TD></TR><TR><TD CLASS="l">1419</TD><TD> </TD></TR><TR><TD CLASS="l">1420</TD><TD>    public boolean allowUseClearingAcronymConfigured() {</TD></TR><TR CLASS="z"><TD CLASS="l">1421</TD><TD>        return allowUseClearingAcrConfigured;</TD></TR><TR><TD CLASS="l"><A NAME="bc">1422</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1423</TD><TD> </TD></TR><TR><TD CLASS="l">1424</TD><TD>    public static boolean rejectLightOrderOrigin(char originCode)</TD></TR><TR><TD CLASS="l">1425</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1426</TD><TD>        boolean should = false;</TD></TR><TR><TD CLASS="l">1427</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1428</TD><TD>            if (rejectLightOrderOrigins != null &amp;&amp; rejectLightOrderOrigins.length &gt; 0</TD></TR><TR CLASS="z"><TD CLASS="l">1429</TD><TD>                    &amp;&amp; rejectLightOrderOrigins[0].charAt(0) != NO_ORIGIN_CODES.charAt(0)) </TD></TR><TR><TD CLASS="l">1430</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1431</TD><TD>                for (int i = 0; i &lt; rejectLightOrderOrigins.length; i++) </TD></TR><TR><TD CLASS="l">1432</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1433</TD><TD>                    if (originCode == rejectLightOrderOrigins[i].charAt(0)) </TD></TR><TR><TD CLASS="l">1434</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">1435</TD><TD>                        should = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1436</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">1437</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1438</TD><TD>                }</TD></TR><TR><TD CLASS="l">1439</TD><TD>            }</TD></TR><TR><TD CLASS="l">1440</TD><TD>        } </TD></TR><TR CLASS="z"><TD CLASS="l">1441</TD><TD>        catch (Exception e) </TD></TR><TR><TD CLASS="l">1442</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1443</TD><TD>            Log.alarm(&#34;OrderHomeImpl &gt;&gt;&gt;&gt;rejectLightOrderOrigins Codes defined incorrectly: &#34; + e);</TD></TR><TR><TD CLASS="l">1444</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1445</TD><TD>        return should;</TD></TR><TR><TD CLASS="l">1446</TD><TD>    }</TD></TR><TR><TD CLASS="l">1447</TD><TD>    </TD></TR><TR><TD CLASS="l">1448</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1449</TD><TD>     * Initialize any configuration items.</TD></TR><TR><TD CLASS="l"><A NAME="91">1450</A></TD><TD>     *</TD></TR><TR><TD CLASS="l">1451</TD><TD>     * @author Werner Kubitsch</TD></TR><TR><TD CLASS="l">1452</TD><TD>     */</TD></TR><TR><TD CLASS="l">1453</TD><TD>    public void initialize() {</TD></TR><TR CLASS="z"><TD CLASS="l">1454</TD><TD>        if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1455</TD><TD>            Log.debug(&#34;OrderHome initializing&#34;);</TD></TR><TR><TD CLASS="l">1456</TD><TD>        }</TD></TR><TR><TD CLASS="l">1457</TD><TD>        long days;</TD></TR><TR><TD CLASS="l">1458</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1459</TD><TD>        allowUseClearingAcrConfigured = true; // by default</TD></TR><TR CLASS="z"><TD CLASS="l">1460</TD><TD>        String allowConfiguredAcr = System</TD></TR><TR CLASS="z"><TD CLASS="l">1461</TD><TD>                .getProperty(ALLOW_CLEARING_ACR_CONFIGURED);</TD></TR><TR CLASS="z"><TD CLASS="l">1462</TD><TD>        if ((allowConfiguredAcr != null)</TD></TR><TR CLASS="z"><TD CLASS="l">1463</TD><TD>                &amp;&amp; allowConfiguredAcr.equalsIgnoreCase(&#34;false&#34;)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1464</TD><TD>            allowUseClearingAcrConfigured = false;</TD></TR><TR><TD CLASS="l">1465</TD><TD>        }</TD></TR><TR><TD CLASS="l">1466</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1467</TD><TD>        Log.information(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1468</TD><TD>                &#34;The value for allowUseClearingAcrConfigured is: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1469</TD><TD>                        + allowUseClearingAcrConfigured);</TD></TR><TR><TD CLASS="l">1470</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1471</TD><TD>            initialCacheSize = Integer</TD></TR><TR CLASS="z"><TD CLASS="l">1472</TD><TD>                    .parseInt(getProperty(INITIAL_CACHE_SIZE));</TD></TR><TR CLASS="z"><TD CLASS="l">1473</TD><TD>            echoReports = Boolean.valueOf(getProperty(ECHO_REPORTS))</TD></TR><TR CLASS="z"><TD CLASS="l">1474</TD><TD>                    .booleanValue();</TD></TR><TR CLASS="z"><TD CLASS="l">1475</TD><TD>            executingBroker = getProperty(EXECUTING_BROKER);</TD></TR><TR CLASS="z"><TD CLASS="l">1476</TD><TD>            days = Long.parseLong(getProperty(RETENTION_PERIOD));</TD></TR><TR><TD CLASS="l">1477</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1478</TD><TD>            totalNumberOfOrderLoadingThreads = Integer</TD></TR><TR CLASS="z"><TD CLASS="l">1479</TD><TD>                    .parseInt(getProperty(TOTAL_NUMBER_OF_ORDER_LOADING_THREADS));</TD></TR><TR CLASS="z"><TD CLASS="l">1480</TD><TD>            maxProductsToSendPerCallToOHS = Integer</TD></TR><TR CLASS="z"><TD CLASS="l">1481</TD><TD>                    .parseInt(getProperty(MAX_PRODUCTS_TO_SEND_PER_CALL_TO_OHS));</TD></TR><TR CLASS="z"><TD CLASS="l">1482</TD><TD>            maxSleepTimeBeforeOHSCall = Integer</TD></TR><TR CLASS="z"><TD CLASS="l">1483</TD><TD>                    .parseInt(getProperty(MAX_SLEEP_TIME_BEFORE_OHS_CALL));</TD></TR><TR CLASS="z"><TD CLASS="l">1484</TD><TD>        } catch (NoSuchPropertyException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1485</TD><TD>            throw new IllegalArgumentException(</TD></TR><TR CLASS="z"><TD CLASS="l">1486</TD><TD>                    &#34;Required properties of home have not been defined&#34;);</TD></TR><TR><TD CLASS="l">1487</TD><TD>        }</TD></TR><TR><TD CLASS="l">1488</TD><TD> </TD></TR><TR><TD CLASS="l">1489</TD><TD>        try</TD></TR><TR><TD CLASS="l">1490</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1491</TD><TD>            initializeEmitPoints();</TD></TR><TR><TD CLASS="l">1492</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1493</TD><TD>        catch (Exception e)</TD></TR><TR><TD CLASS="l">1494</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1495</TD><TD>            Log.exception(allowConfiguredAcr, e);</TD></TR><TR><TD CLASS="l">1496</TD><TD>        }</TD></TR><TR><TD CLASS="l">1497</TD><TD> </TD></TR><TR><TD CLASS="l">1498</TD><TD>        // getting configuration for Blank Account Field</TD></TR><TR><TD CLASS="l">1499</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1500</TD><TD>            ifBlankAccountIfSameAsAcr = Boolean.valueOf(</TD></TR><TR CLASS="z"><TD CLASS="l">1501</TD><TD>                    getProperty(BLANK_ACCOUNT_ENABLED)).booleanValue();</TD></TR><TR CLASS="z"><TD CLASS="l">1502</TD><TD>        } catch (NoSuchPropertyException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1503</TD><TD>            ifBlankAccountIfSameAsAcr = false;</TD></TR><TR><TD CLASS="l">1504</TD><TD>        }</TD></TR><TR><TD CLASS="l">1505</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1506</TD><TD>        Log.information(this, &#34;ifBlankAccountIfSameAsAcr is set to &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1507</TD><TD>                + ifBlankAccountIfSameAsAcr);</TD></TR><TR><TD CLASS="l">1508</TD><TD> </TD></TR><TR><TD CLASS="l">1509</TD><TD>        // getting configuration for IPP processing</TD></TR><TR><TD CLASS="l">1510</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1511</TD><TD>            anonymousTradingIfNotClearsLikeQuote = Boolean.valueOf(</TD></TR><TR CLASS="z"><TD CLASS="l">1512</TD><TD>                    getProperty(ANYONYMOUS_TRADING_IF_NOT_QUOTE))</TD></TR><TR CLASS="z"><TD CLASS="l">1513</TD><TD>                    .booleanValue();</TD></TR><TR CLASS="z"><TD CLASS="l">1514</TD><TD>            anonymousIfNotClearsLikeQuoteBroker = getProperty(ANYONYMOUS_TRADING_IF_NOT_QUOTE_BROKER);</TD></TR><TR CLASS="z"><TD CLASS="l">1515</TD><TD>        } catch (NoSuchPropertyException e) {</TD></TR><TR><TD CLASS="l">1516</TD><TD>            // TODO for now default to cancel</TD></TR><TR><TD CLASS="l">1517</TD><TD>            // throw new IllegalArgumentException(&#34;Required properties of home have not been defined</TD></TR><TR><TD CLASS="l">1518</TD><TD>            // on ippMinSizeProcessingIndicator&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1519</TD><TD>            anonymousTradingIfNotClearsLikeQuote = false;</TD></TR><TR CLASS="z"><TD CLASS="l">1520</TD><TD>            anonymousIfNotClearsLikeQuoteBroker = null;</TD></TR><TR><TD CLASS="l">1521</TD><TD>        }</TD></TR><TR><TD CLASS="l">1522</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1523</TD><TD>        Log.information(this, &#34;anonymousTradingIfNotClearsLikeQuote: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1524</TD><TD>                + anonymousTradingIfNotClearsLikeQuote);</TD></TR><TR CLASS="z"><TD CLASS="l">1525</TD><TD>        Log.information(this, &#34;anonymousIfNotClearsLikeQuoteBroker: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1526</TD><TD>                + anonymousIfNotClearsLikeQuoteBroker);</TD></TR><TR><TD CLASS="l">1527</TD><TD> </TD></TR><TR><TD CLASS="l">1528</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1529</TD><TD>            manualQuoteContraOrderBroker = getProperty(MANUL_QUOTE_CONTRA_ORDER_BROKER);</TD></TR><TR CLASS="z"><TD CLASS="l">1530</TD><TD>        } catch (NoSuchPropertyException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1531</TD><TD>            Log.alarm(this,&#34;Cannot find the manualQuoteContraOrderBroker property.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1532</TD><TD>            throw new IllegalArgumentException(&#34;Required properties of (manualQuoteContraOrderBroker) have not been defined&#34;);</TD></TR><TR><TD CLASS="l">1533</TD><TD>        }</TD></TR><TR><TD CLASS="l">1534</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1535</TD><TD>        Log.information(this, &#34;manualQuoteContraOrderBroker: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1536</TD><TD>                + manualQuoteContraOrderBroker);</TD></TR><TR><TD CLASS="l">1537</TD><TD>        </TD></TR><TR><TD CLASS="l">1538</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1539</TD><TD>            internalizationAuctionTradeBroker = getProperty(INTERNALIZATION_AUCTION_TRADE_BROKER);</TD></TR><TR CLASS="z"><TD CLASS="l">1540</TD><TD>        } catch (NoSuchPropertyException e) {</TD></TR><TR><TD CLASS="l">1541</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">1542</TD><TD>                    .alarm(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1543</TD><TD>                            &#34;Cannot find the internalizationAuctionTradeBroker&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1544</TD><TD>            throw new IllegalArgumentException(</TD></TR><TR CLASS="z"><TD CLASS="l">1545</TD><TD>                    &#34;Required properties of home(internalizationAuctionTradeBroker) have not been defined&#34;);</TD></TR><TR><TD CLASS="l">1546</TD><TD>        }</TD></TR><TR><TD CLASS="l">1547</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1548</TD><TD>        Log.information(this, &#34;internalizationAuctionTradeBroker :&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1549</TD><TD>                + internalizationAuctionTradeBroker);</TD></TR><TR><TD CLASS="l">1550</TD><TD> </TD></TR><TR><TD CLASS="l">1551</TD><TD>        // getting configuration for IPP processing</TD></TR><TR><TD CLASS="l">1552</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1553</TD><TD>            ippMinSizeProcessingIndicator = getProperty(IPP_MIN_SIZE_PROCESSING_INDICATOR);</TD></TR><TR CLASS="z"><TD CLASS="l">1554</TD><TD>        } catch (NoSuchPropertyException e) {</TD></TR><TR><TD CLASS="l">1555</TD><TD>            // TODO for now default to cancel</TD></TR><TR><TD CLASS="l">1556</TD><TD>            // throw new IllegalArgumentException(&#34;Required properties of home have not been defined</TD></TR><TR><TD CLASS="l">1557</TD><TD>            // on ippMinSizeProcessingIndicator&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1558</TD><TD>            ippMinSizeProcessingIndicator = this.CANCEL_NONE_BELOW_IPP;</TD></TR><TR><TD CLASS="l">1559</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">1560</TD><TD>                    .alarm(</TD></TR><TR CLASS="z"><TD CLASS="l">1561</TD><TD>                            this,</TD></TR><TR CLASS="z"><TD CLASS="l">1562</TD><TD>                            &#34;Cannot find cancel order strategy property for IPPMinSize processing.  Will use default: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1563</TD><TD>                                    + ippMinSizeProcessingIndicator);</TD></TR><TR><TD CLASS="l">1564</TD><TD>        }</TD></TR><TR><TD CLASS="l">1565</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1566</TD><TD>            nbboMinSizeGuaranteeOrderBranch = getProperty(NBBO_MIN_SIZE_GUARANTEE_ORDER_BRANCH);</TD></TR><TR CLASS="z"><TD CLASS="l">1567</TD><TD>        } catch (NoSuchPropertyException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1568</TD><TD>            Log.information(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1569</TD><TD>                    &#34;nbboMinSizeGuaranteeOrderBranch properties is not defined. Set to default &#34;</TD></TR><TR><TD CLASS="l">1570</TD><TD>                            + DEFAULT_NBBO_MSGORDER_BRANCH);</TD></TR><TR CLASS="z"><TD CLASS="l">1571</TD><TD>            nbboMinSizeGuaranteeOrderBranch = DEFAULT_NBBO_MSGORDER_BRANCH;</TD></TR><TR><TD CLASS="l">1572</TD><TD>        }</TD></TR><TR><TD CLASS="l">1573</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1574</TD><TD>            maxRetriesOfNBBOProtectionRouting = Integer</TD></TR><TR CLASS="z"><TD CLASS="l">1575</TD><TD>                    .parseInt(getProperty(MAX_RETRIES_OF_NBBO_PROTECTION_ROUTING));</TD></TR><TR CLASS="z"><TD CLASS="l">1576</TD><TD>        } catch (NoSuchPropertyException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1577</TD><TD>            Log.information(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1578</TD><TD>                    &#34;maxRetriesOfNBBOProtectionRouting properties is not defined. Set to default &#34;</TD></TR><TR><TD CLASS="l">1579</TD><TD>                            + DEFAULT_MAX_RETRIES_OF_NBBO_PROTECTION_ROUTING);</TD></TR><TR CLASS="z"><TD CLASS="l">1580</TD><TD>            maxRetriesOfNBBOProtectionRouting = DEFAULT_MAX_RETRIES_OF_NBBO_PROTECTION_ROUTING;</TD></TR><TR><TD CLASS="l">1581</TD><TD>        }</TD></TR><TR><TD CLASS="l">1582</TD><TD> </TD></TR><TR><TD CLASS="l">1583</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1584</TD><TD>            satisfySatisfactionOrderBranch = getProperty(SATISFY_SATISFACTION_ORDER_BRANCH);</TD></TR><TR CLASS="z"><TD CLASS="l">1585</TD><TD>        } catch (NoSuchPropertyException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1586</TD><TD>            Log.information(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1587</TD><TD>                    &#34;satisfySatisfactionOrderBranch properties is not defined. Set to default &#34;</TD></TR><TR><TD CLASS="l">1588</TD><TD>                            + DEFAULT_SATISFY_SATISFACTION_ORDER_BRANCH);</TD></TR><TR CLASS="z"><TD CLASS="l">1589</TD><TD>            satisfySatisfactionOrderBranch = DEFAULT_SATISFY_SATISFACTION_ORDER_BRANCH;</TD></TR><TR><TD CLASS="l">1590</TD><TD>        }</TD></TR><TR><TD CLASS="l">1591</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1592</TD><TD>        Log.information(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1593</TD><TD>                &#34;Cancel order strategy for IPPMinSize processing: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1594</TD><TD>                        + ippMinSizeProcessingIndicator);</TD></TR><TR><TD CLASS="l">1595</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1596</TD><TD>        Configuration config = new Configuration(this);</TD></TR><TR CLASS="z"><TD CLASS="l">1597</TD><TD>        ippProcessingStrategies = new HashMap();</TD></TR><TR><TD CLASS="l">1598</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1599</TD><TD>            String[] strategyConfigurationNames = config.getPropertyList(</TD></TR><TR CLASS="z"><TD CLASS="l">1600</TD><TD>                    &#34;ippProcessingStrategyForSessions&#34;, &#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1601</TD><TD>            for (int i = 0; i &lt; strategyConfigurationNames.length; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">1602</TD><TD>                initializeIppProcessingConfiguration(</TD></TR><TR CLASS="z"><TD CLASS="l">1603</TD><TD>                        strategyConfigurationNames[i], config);</TD></TR><TR><TD CLASS="l">1604</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1605</TD><TD>        } catch (NoSuchPropertyException nspe) {</TD></TR><TR CLASS="z"><TD CLASS="l">1606</TD><TD>            Log.information(this, &#34;OrderHomeImpl Failed to find property : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1607</TD><TD>                    + nspe);</TD></TR><TR CLASS="z"><TD CLASS="l">1608</TD><TD>            Log.exception(this, nspe);</TD></TR><TR><TD CLASS="l">1609</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">1610</TD><TD>                    .information(&#34;OrderHomeImpl initialization on ippProcessingStrategy not specified correctly, will use default: None.  &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1611</TD><TD>                            + nspe);</TD></TR><TR><TD CLASS="l">1612</TD><TD>           </TD></TR><TR><TD CLASS="l">1613</TD><TD>        }</TD></TR><TR><TD CLASS="l">1614</TD><TD> </TD></TR><TR><TD CLASS="l">1615</TD><TD>        // get the configured Q-like order origin code list</TD></TR><TR CLASS="z"><TD CLASS="l">1616</TD><TD>        if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1617</TD><TD>            Log.debug(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1618</TD><TD>                    &#34;Getting the configuration for quote lock processing&#34;);</TD></TR><TR><TD CLASS="l">1619</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1620</TD><TD>        quoteLockConfiguredForSessions = new HashMap();</TD></TR><TR><TD CLASS="l">1621</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1622</TD><TD>            String[] quoteConfigurationNames = config.getPropertyList(</TD></TR><TR CLASS="z"><TD CLASS="l">1623</TD><TD>                    &#34;quoteLockProcessingForSessions&#34;, &#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1624</TD><TD>            for (int i = 0; i &lt; quoteConfigurationNames.length; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">1625</TD><TD>                initializeQuoteLockProcessingConfiguration(</TD></TR><TR CLASS="z"><TD CLASS="l">1626</TD><TD>                        quoteConfigurationNames[i], config);</TD></TR><TR><TD CLASS="l">1627</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1628</TD><TD>        } catch (NoSuchPropertyException nspe) {</TD></TR><TR CLASS="z"><TD CLASS="l">1629</TD><TD>            Log.information(this, &#34;OrderHomeImpl Failed to find property : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1630</TD><TD>                    + nspe);</TD></TR><TR CLASS="z"><TD CLASS="l">1631</TD><TD>            Log.exception(this, nspe);</TD></TR><TR><TD CLASS="l">1632</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">1633</TD><TD>                    .information(&#34;OrderHomeImpl initialization on quoteLockProcessingForSessions not specified correctly:  &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1634</TD><TD>                            + nspe);</TD></TR><TR><TD CLASS="l">1635</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1636</TD><TD>        if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1637</TD><TD>            Log.debug(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1638</TD><TD>                    &#34;Done getting the configuration for quote lock processing&#34;);</TD></TR><TR><TD CLASS="l">1639</TD><TD>        }</TD></TR><TR><TD CLASS="l">1640</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1641</TD><TD>        initializeClearsLikeQuoteConfiguration(config);</TD></TR><TR CLASS="z"><TD CLASS="l">1642</TD><TD>        initializeCustomerCodesConfiguration(config);</TD></TR><TR CLASS="z"><TD CLASS="l">1643</TD><TD>        initializeNbboFlashCodesConfiguration(config);</TD></TR><TR CLASS="z"><TD CLASS="l">1644</TD><TD>        initializeMarketAlertOnOriginCodesConfiguration(config);</TD></TR><TR CLASS="z"><TD CLASS="l">1645</TD><TD>        initializeTradeAndShipCodesConfiguration(config);</TD></TR><TR CLASS="z"><TD CLASS="l">1646</TD><TD>        initializeSalableCodesConfiguration(config);</TD></TR><TR CLASS="z"><TD CLASS="l">1647</TD><TD>        initializeCustomerTypeOriginCodesForBobClasses(config);</TD></TR><TR CLASS="z"><TD CLASS="l">1648</TD><TD>        initializeReserveOrderRefreshSizeConfiguration(config);</TD></TR><TR CLASS="z"><TD CLASS="l">1649</TD><TD>        initializeCancelOnFailoverCloseHaltLogOutCodes(config);</TD></TR><TR CLASS="z"><TD CLASS="l">1650</TD><TD>        initializeLightOrderProperties(config);</TD></TR><TR><TD CLASS="l">1651</TD><TD> </TD></TR><TR><TD CLASS="l">1652</TD><TD>        // gettting Q order cancel indicator</TD></TR><TR><TD CLASS="l">1653</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1654</TD><TD>            cancelQOrdersOnCloseHaltLogOut = Boolean.valueOf(</TD></TR><TR CLASS="z"><TD CLASS="l">1655</TD><TD>                    getProperty(CANCEL_Q_ORDERS)).booleanValue();</TD></TR><TR CLASS="z"><TD CLASS="l">1656</TD><TD>        } catch (NoSuchPropertyException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1657</TD><TD>            cancelQOrdersOnCloseHaltLogOut = false;</TD></TR><TR><TD CLASS="l">1658</TD><TD>        }</TD></TR><TR><TD CLASS="l">1659</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1660</TD><TD>        Log.information(this, &#34;CancelQOrdersOnCloseHaltLogOut: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1661</TD><TD>                + cancelQOrdersOnCloseHaltLogOut);</TD></TR><TR><TD CLASS="l">1662</TD><TD> </TD></TR><TR><TD CLASS="l">1663</TD><TD>        // get and calculate retention period in millis</TD></TR><TR CLASS="z"><TD CLASS="l">1664</TD><TD>        retentionPeriod = days * 24 * 60 * 60 * 1000;</TD></TR><TR><TD CLASS="l">1665</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1666</TD><TD>        if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1667</TD><TD>            Log.debug(this, &#34;initial cache size = &#34; + initialCacheSize);</TD></TR><TR><TD CLASS="l">1668</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1669</TD><TD>        if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1670</TD><TD>            Log.debug(this, &#34;echo reports = &#34; + echoReports);</TD></TR><TR><TD CLASS="l">1671</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1672</TD><TD>        if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1673</TD><TD>            Log.debug(this, &#34;retentionPeriod = &#34; + days + &#34; days = &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1674</TD><TD>                    + retentionPeriod + &#34; millis&#34;);</TD></TR><TR><TD CLASS="l">1675</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1676</TD><TD>        if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1677</TD><TD>            Log.debug(this, &#34;executingBroker = &#34; + executingBroker);</TD></TR><TR><TD CLASS="l">1678</TD><TD>        }</TD></TR><TR><TD CLASS="l">1679</TD><TD>        </TD></TR><TR><TD CLASS="l">1680</TD><TD>        // Register callback for order printing.</TD></TR><TR><TD CLASS="l">1681</TD><TD>        //</TD></TR><TR><TD CLASS="l">1682</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1683</TD><TD>            registerCommand(this, &#34;printOrder&#34;, &#34;adminPrintOrder&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1684</TD><TD>                    &#34;Print an order, given it's unique id#&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1685</TD><TD>                    new String[] { &#34;java.lang.String&#34; },</TD></TR><TR CLASS="z"><TD CLASS="l">1686</TD><TD>                                        new String[] { &#34;&lt;the unique int id for order&gt; or &lt;HIGH_ID&gt;:&lt;LOW_ID&gt;&#34; });</TD></TR><TR><TD CLASS="l">1687</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1688</TD><TD>            registerCommand(</TD></TR><TR CLASS="z"><TD CLASS="l">1689</TD><TD>                    this,</TD></TR><TR CLASS="z"><TD CLASS="l">1690</TD><TD>                    &#34;queryOrder&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1691</TD><TD>                    &#34;queryOrder&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1692</TD><TD>                    &#34;Print the order details either by Branch, branchid, orderid or product id&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1693</TD><TD>                    new String[] { &#34;java.lang.String&#34;, &#34;java.lang.String&#34; },</TD></TR><TR CLASS="z"><TD CLASS="l">1694</TD><TD>                    new String[] {</TD></TR><TR CLASS="z"><TD CLASS="l">1695</TD><TD>                            &#34;Print the order details either by Branch, branchid, orderid or product id&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1696</TD><TD>                            &#34;Branch id or Product Id to query by&#34; });</TD></TR><TR CLASS="z"><TD CLASS="l">1697</TD><TD>            registerCommand(</TD></TR><TR CLASS="z"><TD CLASS="l">1698</TD><TD>                    this,</TD></TR><TR CLASS="z"><TD CLASS="l">1699</TD><TD>                    &#34;printOrderStatistics&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1700</TD><TD>                    &#34;adminPrintOrderStatistics&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1701</TD><TD>                    &#34;Print the order count by users&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1702</TD><TD>                    new String[]{&#34;java.lang.String&#34;},</TD></TR><TR CLASS="z"><TD CLASS="l">1703</TD><TD>                    new String[] {</TD></TR><TR CLASS="z"><TD CLASS="l">1704</TD><TD>                            &#34;Print the count by users&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1705</TD><TD>                            &#34;Print the count by users&#34; });</TD></TR><TR CLASS="z"><TD CLASS="l">1706</TD><TD>        } catch (Exception ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">1707</TD><TD>            Log.exception(&#34;Exception registering for command callback.&#34;, ex);</TD></TR><TR><TD CLASS="l">1708</TD><TD>        }</TD></TR><TR><TD CLASS="l">1709</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1710</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="98">1711</A></TD><TD> </TD></TR><TR><TD CLASS="l">1712</TD><TD>    private void initializeEmitPoints()</TD></TR><TR><TD CLASS="l">1713</TD><TD>    {</TD></TR><TR><TD CLASS="l">1714</TD><TD>      </TD></TR><TR CLASS="z"><TD CLASS="l">1715</TD><TD>        emitPointOrderSync = new EmitPoint(&#34;OrderSyncEmitPoint&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1716</TD><TD>        Log.information(this, &#34;created OrderSyncEmitPoint&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1717</TD><TD>    }</TD></TR><TR><TD CLASS="l">1718</TD><TD> </TD></TR><TR><TD CLASS="l">1719</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1720</TD><TD>     * Create the strategy for a quote lock configuration</TD></TR><TR><TD CLASS="l"><A NAME="9e">1721</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1722</TD><TD>    private void initializeQuoteLockProcessingConfiguration(</TD></TR><TR><TD CLASS="l">1723</TD><TD>            String strategyConfigurationName, Configuration config)</TD></TR><TR><TD CLASS="l">1724</TD><TD>            throws NoSuchPropertyException {</TD></TR><TR CLASS="z"><TD CLASS="l">1725</TD><TD>        PropertyQuery sessionNameQuery = PropertyQuery.queryFor(&#34;sessionName&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1726</TD><TD>                .from(&#34;quoteLockProcessingConfiguration&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1727</TD><TD>                        strategyConfigurationName);</TD></TR><TR><TD CLASS="l">1728</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1729</TD><TD>        String sessionName = config.getProperty(sessionNameQuery.queryString());</TD></TR><TR CLASS="z"><TD CLASS="l">1730</TD><TD>        PropertyQuery implQuery = PropertyQuery.queryFor(&#34;QCodes&#34;).from(</TD></TR><TR CLASS="z"><TD CLASS="l">1731</TD><TD>                &#34;quoteLockProcessingConfiguration&#34;, strategyConfigurationName);</TD></TR><TR CLASS="z"><TD CLASS="l">1732</TD><TD>        String[] qCodes = config.getPropertyList(implQuery.queryString(), &#34;,&#34;);</TD></TR><TR><TD CLASS="l">1733</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1734</TD><TD>        quoteLockConfiguredForSessions.put(sessionName, qCodes);</TD></TR><TR CLASS="z"><TD CLASS="l">1735</TD><TD>        Log.information(this, &#34;quoteLockProcessingConfiguration for session &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1736</TD><TD>                + sessionName + &#34; having qCodes : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1737</TD><TD>                + getPrintingString(&#34;QCodes&#34;, qCodes));</TD></TR><TR CLASS="z"><TD CLASS="l">1738</TD><TD>    }</TD></TR><TR><TD CLASS="l">1739</TD><TD> </TD></TR><TR><TD CLASS="l">1740</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1741</TD><TD>     * Create the strategy for a clear like Quote configuration</TD></TR><TR><TD CLASS="l">1742</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="95">1743</A></TD><TD>    private void initializeClearsLikeQuoteDetailConfiguration(</TD></TR><TR><TD CLASS="l">1744</TD><TD>            String strategyConfigurationName, Configuration config)</TD></TR><TR><TD CLASS="l">1745</TD><TD>            throws NoSuchPropertyException {</TD></TR><TR CLASS="z"><TD CLASS="l">1746</TD><TD>        PropertyQuery sessionNameQuery = PropertyQuery</TD></TR><TR CLASS="z"><TD CLASS="l">1747</TD><TD>                .queryFor(&#34;sessionName&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1748</TD><TD>                .from(&#34;clearsLikeQuoteConfiguration&#34;, strategyConfigurationName);</TD></TR><TR><TD CLASS="l">1749</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1750</TD><TD>        String sessionName = config.getProperty(sessionNameQuery.queryString());</TD></TR><TR CLASS="z"><TD CLASS="l">1751</TD><TD>        PropertyQuery implQuery = PropertyQuery.queryFor(&#34;QCodes&#34;).from(</TD></TR><TR CLASS="z"><TD CLASS="l">1752</TD><TD>                &#34;clearsLikeQuoteConfiguration&#34;, strategyConfigurationName);</TD></TR><TR CLASS="z"><TD CLASS="l">1753</TD><TD>        String[] qCodes = config.getPropertyList(implQuery.queryString(), &#34;,&#34;);</TD></TR><TR><TD CLASS="l">1754</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1755</TD><TD>        clearsLikeQuoteConfiguredForSessions.put(sessionName, qCodes);</TD></TR><TR CLASS="z"><TD CLASS="l">1756</TD><TD>        Log.information(this, &#34;clearsLikeQuoteConfiguration for session &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1757</TD><TD>                + sessionName + &#34; having qCodes : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1758</TD><TD>                + getPrintingString(&#34;QCodes&#34;, qCodes));</TD></TR><TR CLASS="z"><TD CLASS="l">1759</TD><TD>    }</TD></TR><TR><TD CLASS="l">1760</TD><TD> </TD></TR><TR><TD CLASS="l">1761</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="96">1762</A></TD><TD>     * initialize the customer codes configuration</TD></TR><TR><TD CLASS="l">1763</TD><TD>     */</TD></TR><TR><TD CLASS="l">1764</TD><TD>    private void initializeCustomerCodesConfiguration(Configuration config) {</TD></TR><TR><TD CLASS="l">1765</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1766</TD><TD>            customerCodes = config.getPropertyList(&#34;customerCodes&#34;, &#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1767</TD><TD>            Log.information(this, &#34;Customer Codes are defined as: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1768</TD><TD>                    + getPrintingString(&#34;CustomerCodes&#34;, customerCodes));</TD></TR><TR CLASS="z"><TD CLASS="l">1769</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1770</TD><TD>            customerCodes = new String[1];</TD></TR><TR CLASS="z"><TD CLASS="l">1771</TD><TD>            customerCodes[0] = &#34;C&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1772</TD><TD>            Log.alarm(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1773</TD><TD>                    &#34;Can not get customer codes properties. Default C is used&#34;);</TD></TR><TR><TD CLASS="l">1774</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1775</TD><TD>    }</TD></TR><TR><TD CLASS="l">1776</TD><TD>    </TD></TR><TR><TD CLASS="l">1777</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="9d">1778</A></TD><TD>     * initialize the customer codes configuration</TD></TR><TR><TD CLASS="l">1779</TD><TD>     */</TD></TR><TR><TD CLASS="l">1780</TD><TD>    private void initializeNbboFlashCodesConfiguration(Configuration config) {</TD></TR><TR><TD CLASS="l">1781</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1782</TD><TD>            nbboFlashCodes = config.getPropertyList(&#34;nbboFlashCodes&#34;, &#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1783</TD><TD>            Log.information(this, &#34;NBBO Flash Codes are defined as: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1784</TD><TD>                    + getPrintingString(&#34;nbboFlashCodes&#34;, nbboFlashCodes));</TD></TR><TR CLASS="z"><TD CLASS="l">1785</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1786</TD><TD>            nbboFlashCodes = new String[1];</TD></TR><TR CLASS="z"><TD CLASS="l">1787</TD><TD>            nbboFlashCodes[0] = &#34;C&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1788</TD><TD>            Log.alarm(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1789</TD><TD>                    &#34;Can not get nbbo Flash codes properties. Default C is used&#34;);</TD></TR><TR><TD CLASS="l">1790</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1791</TD><TD>    }</TD></TR><TR><TD CLASS="l">1792</TD><TD> </TD></TR><TR><TD CLASS="l">1793</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1794</TD><TD>     * initialize the marketAlert origin codes configuration</TD></TR><TR><TD CLASS="l"><A NAME="9b">1795</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1796</TD><TD>    private void initializeMarketAlertOnOriginCodesConfiguration(</TD></TR><TR><TD CLASS="l">1797</TD><TD>            Configuration config) {</TD></TR><TR><TD CLASS="l">1798</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1799</TD><TD>            marketAlertOnOriginCodes = config.getPropertyList(</TD></TR><TR CLASS="z"><TD CLASS="l">1800</TD><TD>                    MARKET_ALERT_ON_ORIGIN_CODES, &#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1801</TD><TD>            Log.information(this, &#34;marketAlertOnOriginCodes are defined as: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1802</TD><TD>                    + getPrintingString(&#34;marketAlertOnOriginCodes&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1803</TD><TD>                            marketAlertOnOriginCodes));</TD></TR><TR CLASS="z"><TD CLASS="l">1804</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1805</TD><TD>            marketAlertOnOriginCodes = new String[1];</TD></TR><TR CLASS="z"><TD CLASS="l">1806</TD><TD>            marketAlertOnOriginCodes[0] = NO_MARKET_ALERT;</TD></TR><TR><TD CLASS="l">1807</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">1808</TD><TD>                    .alarm(</TD></TR><TR CLASS="z"><TD CLASS="l">1809</TD><TD>                            this,</TD></TR><TR CLASS="z"><TD CLASS="l">1810</TD><TD>                            &#34;Can not get marketAlertOnOriginCodes properties. Default 0(NO_MARKET_ALERT) is used&#34;);</TD></TR><TR><TD CLASS="l">1811</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1812</TD><TD>    }</TD></TR><TR><TD CLASS="l">1813</TD><TD> </TD></TR><TR><TD CLASS="l">1814</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1815</TD><TD>     * initialize the Clear Like Quote configuration</TD></TR><TR><TD CLASS="l">1816</TD><TD>     * </TD></TR><TR><TD CLASS="l">1817</TD><TD>     * @param config</TD></TR><TR><TD CLASS="l"><A NAME="94">1818</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1819</TD><TD>    private void initializeClearsLikeQuoteConfiguration(Configuration config) {</TD></TR><TR><TD CLASS="l">1820</TD><TD>        // get the configured Q-like order origin code list for Clear like Quote seperately</TD></TR><TR><TD CLASS="l">1821</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1822</TD><TD>        if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1823</TD><TD>            Log.debug(this, &#34;Getting the configuration for clear Like Quote&#34;);</TD></TR><TR><TD CLASS="l">1824</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1825</TD><TD>        clearsLikeQuoteConfiguredForSessions = new HashMap();</TD></TR><TR><TD CLASS="l">1826</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1827</TD><TD>            String[] quoteConfigurationNames = config.getPropertyList(</TD></TR><TR CLASS="z"><TD CLASS="l">1828</TD><TD>                    &#34;clearsLikeQuoteForSessions&#34;, &#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1829</TD><TD>            for (int i = 0; i &lt; quoteConfigurationNames.length; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">1830</TD><TD>                initializeClearsLikeQuoteDetailConfiguration(</TD></TR><TR CLASS="z"><TD CLASS="l">1831</TD><TD>                        quoteConfigurationNames[i], config);</TD></TR><TR><TD CLASS="l">1832</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1833</TD><TD>        } catch (NoSuchPropertyException nspe) {</TD></TR><TR CLASS="z"><TD CLASS="l">1834</TD><TD>            Log.information(this, &#34;OrderHomeImpl Failed to find property : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1835</TD><TD>                    + nspe);</TD></TR><TR CLASS="z"><TD CLASS="l">1836</TD><TD>            Log.exception(this, nspe);</TD></TR><TR><TD CLASS="l">1837</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">1838</TD><TD>                    .information(&#34;OrderHomeImpl initialization on clearsLikeQuoteForSessions not specified correctly:  &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1839</TD><TD>                            + nspe);</TD></TR><TR><TD CLASS="l">1840</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1841</TD><TD>        if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1842</TD><TD>            Log.debug(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1843</TD><TD>                    &#34;Done getting the configuration for clear like Quote&#34;);</TD></TR><TR><TD CLASS="l">1844</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1845</TD><TD>    }</TD></TR><TR><TD CLASS="l">1846</TD><TD> </TD></TR><TR><TD CLASS="l">1847</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1848</TD><TD>     * Create the strategy for a strategy configuration</TD></TR><TR><TD CLASS="l"><A NAME="99">1849</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1850</TD><TD>    private void initializeIppProcessingConfiguration(</TD></TR><TR><TD CLASS="l">1851</TD><TD>            String strategyConfigurationName, Configuration config)</TD></TR><TR><TD CLASS="l">1852</TD><TD>            throws NoSuchPropertyException {</TD></TR><TR CLASS="z"><TD CLASS="l">1853</TD><TD>        PropertyQuery sessionNameQuery = PropertyQuery.queryFor(&#34;sessionName&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1854</TD><TD>                .from(&#34;ippProcessingStrategyConfiguration&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1855</TD><TD>                        strategyConfigurationName);</TD></TR><TR><TD CLASS="l">1856</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1857</TD><TD>        String sessionName = config.getProperty(sessionNameQuery.queryString());</TD></TR><TR CLASS="z"><TD CLASS="l">1858</TD><TD>        PropertyQuery implQuery = PropertyQuery.queryFor(</TD></TR><TR CLASS="z"><TD CLASS="l">1859</TD><TD>                &#34;ippProcessingStrategy&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1860</TD><TD>                .from(&#34;ippProcessingStrategyConfiguration&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1861</TD><TD>                        strategyConfigurationName);</TD></TR><TR CLASS="z"><TD CLASS="l">1862</TD><TD>        String strategy = config.getProperty(implQuery.queryString());</TD></TR><TR CLASS="z"><TD CLASS="l">1863</TD><TD>        if (strategy == null || strategy.trim().equals(&#34;&#34;)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1864</TD><TD>            strategy = this.DEFAULT_IPP_PROCESSING;</TD></TR><TR CLASS="z"><TD CLASS="l">1865</TD><TD>            Log.information(&#34;ippProcessingStrategyConfiguration for session &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1866</TD><TD>                    + sessionName + &#34; not created.  Will use default: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1867</TD><TD>                    + this.DEFAULT_IPP_PROCESSING);</TD></TR><TR><TD CLASS="l">1868</TD><TD>        }</TD></TR><TR><TD CLASS="l">1869</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1870</TD><TD>        ippProcessingStrategies.put(sessionName, strategy);</TD></TR><TR CLASS="z"><TD CLASS="l">1871</TD><TD>        Log.information(this, &#34;ippProcessingStrategy for session &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1872</TD><TD>                + sessionName + &#34; is : &#34; + strategy);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="a2">1873</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1874</TD><TD> </TD></TR><TR><TD CLASS="l">1875</TD><TD>    private void initializeTradeAndShipCodesConfiguration(Configuration config) {</TD></TR><TR><TD CLASS="l">1876</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1877</TD><TD>            tradeAndShipCodes = config.getPropertyList(TRADE_AND_SHIP_CODES,</TD></TR><TR CLASS="z"><TD CLASS="l">1878</TD><TD>                    &#34;,&#34;);</TD></TR><TR><TD CLASS="l">1879</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">1880</TD><TD>                    .information(this, &#34;tradeAndShipCodes are defined as: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1881</TD><TD>                            + getPrintingString(&#34;tradeAndShipCodes&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1882</TD><TD>                                    tradeAndShipCodes));</TD></TR><TR CLASS="z"><TD CLASS="l">1883</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1884</TD><TD>            tradeAndShipCodes = new String[3];</TD></TR><TR CLASS="z"><TD CLASS="l">1885</TD><TD>            tradeAndShipCodes[0] = &#34;C&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1886</TD><TD>            tradeAndShipCodes[1] = &#34;F&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1887</TD><TD>            tradeAndShipCodes[2] = &#34;B&#34;;</TD></TR><TR><TD CLASS="l">1888</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">1889</TD><TD>                    .alarm(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1890</TD><TD>                            &#34;Can not get tradeAndShipCodes properties. Default C,F,B are used.&#34;);</TD></TR><TR><TD CLASS="l">1891</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="a0">1892</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1893</TD><TD> </TD></TR><TR><TD CLASS="l">1894</TD><TD>    private void initializeSalableCodesConfiguration(Configuration config) {</TD></TR><TR><TD CLASS="l">1895</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1896</TD><TD>            salableCodes = config.getPropertyList(SALABLE_CODES, &#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1897</TD><TD>            Log.information(this, &#34;salableCodes are defined as: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1898</TD><TD>                    + getPrintingString(&#34;salableCodes&#34;, salableCodes));</TD></TR><TR CLASS="z"><TD CLASS="l">1899</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1900</TD><TD>            salableCodes = new String[3];</TD></TR><TR CLASS="z"><TD CLASS="l">1901</TD><TD>            salableCodes[0] = &#34;C&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1902</TD><TD>            salableCodes[1] = &#34;F&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1903</TD><TD>            salableCodes[2] = &#34;B&#34;;</TD></TR><TR><TD CLASS="l">1904</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">1905</TD><TD>                    .alarm(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1906</TD><TD>                            &#34;Can not get salableCodes properties. Default C,F,B are used.&#34;);</TD></TR><TR><TD CLASS="l"><A NAME="97">1907</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1908</TD><TD>    }</TD></TR><TR><TD CLASS="l">1909</TD><TD>    </TD></TR><TR><TD CLASS="l">1910</TD><TD>    private void initializeCustomerTypeOriginCodesForBobClasses(Configuration config) {</TD></TR><TR CLASS="z"><TD CLASS="l">1911</TD><TD>        String[] codeList = config.getPropertyList(this.CUSTOMER_TYPE_ORIGIN_CODES_BOB_CLASS, null, &#34;,&#34;);</TD></TR><TR><TD CLASS="l">1912</TD><TD>       </TD></TR><TR CLASS="z"><TD CLASS="l">1913</TD><TD>        if(codeList!=null)</TD></TR><TR><TD CLASS="l">1914</TD><TD>        {</TD></TR><TR><TD CLASS="l">1915</TD><TD>            try</TD></TR><TR><TD CLASS="l">1916</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1917</TD><TD>                customerTypeOriginCodesForBobClasses = config.getPropertyList(CUSTOMER_TYPE_ORIGIN_CODES_BOB_CLASS, &#34;,&#34;);</TD></TR><TR><TD CLASS="l">1918</TD><TD>            }</TD></TR><TR><TD CLASS="l">1919</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1920</TD><TD>            catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1921</TD><TD>               throw new FatalFoundationFrameworkException(e, &#34;Unable to initializeCustomerTypeOriginCodesForBobClasses in OrderHomeImpl &#34;);</TD></TR><TR><TD CLASS="l">1922</TD><TD>            }</TD></TR><TR><TD CLASS="l">1923</TD><TD>          </TD></TR><TR><TD CLASS="l">1924</TD><TD>        }</TD></TR><TR><TD CLASS="l">1925</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1926</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="9f">1927</A></TD><TD> </TD></TR><TR><TD CLASS="l">1928</TD><TD>    private void initializeReserveOrderRefreshSizeConfiguration(</TD></TR><TR><TD CLASS="l">1929</TD><TD>            Configuration config) {</TD></TR><TR><TD CLASS="l">1930</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1931</TD><TD>            reserveOrderRefreshSize = Integer.parseInt(config</TD></TR><TR CLASS="z"><TD CLASS="l">1932</TD><TD>                    .getProperty(RESERVE_ORDER_REFRESH_SIZE));</TD></TR><TR CLASS="z"><TD CLASS="l">1933</TD><TD>            Log.information(this, &#34;reserveOrderRefreshSize is defined as: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1934</TD><TD>                    + reserveOrderRefreshSize);</TD></TR><TR CLASS="z"><TD CLASS="l">1935</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1936</TD><TD>            reserveOrderRefreshSize = 0;</TD></TR><TR><TD CLASS="l">1937</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">1938</TD><TD>                    .alarm(this,</TD></TR><TR CLASS="z"><TD CLASS="l">1939</TD><TD>                            &#34;Can not get reserveOrderRefreshSize property. Default 0 is used.&#34;);</TD></TR><TR><TD CLASS="l">1940</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="93">1941</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1942</TD><TD> </TD></TR><TR><TD CLASS="l">1943</TD><TD>    private void initializeCancelOnFailoverCloseHaltLogOutCodes(Configuration config) {</TD></TR><TR><TD CLASS="l">1944</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1945</TD><TD>            cancelOnFailoverCloseHaltLogOutCodes = config.getPropertyList(&#34;cancelOnFailoverCloseHaltLogOutCodes&#34;, &#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1946</TD><TD>            Log.information(this, &#34;Cancel on failover/close/halt/Logout Codes are defined as: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1947</TD><TD>                    + getPrintingString(&#34;cancelOnFailoverCloseHaltLogOutCodes&#34;, cancelOnFailoverCloseHaltLogOutCodes));</TD></TR><TR CLASS="z"><TD CLASS="l">1948</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1949</TD><TD>            cancelOnFailoverCloseHaltLogOutCodes = new String[1];</TD></TR><TR CLASS="z"><TD CLASS="l">1950</TD><TD>            cancelOnFailoverCloseHaltLogOutCodes[0] = &#34;0&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">1951</TD><TD>            Log.alarm(this, &#34;Can not get cancelOnFailoverCloseHaltLogOutCodes properties. Default 0 is used&#34;);</TD></TR><TR><TD CLASS="l">1952</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1953</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="9a">1954</A></TD><TD> </TD></TR><TR><TD CLASS="l">1955</TD><TD>    private void initializeLightOrderProperties(Configuration config)</TD></TR><TR><TD CLASS="l">1956</TD><TD>    {</TD></TR><TR><TD CLASS="l">1957</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1958</TD><TD>                rejectLightOrderOrigins = config.getPropertyList(REJECT_LIGHT_ORDER_ORIGIN_CODES, &#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1959</TD><TD>            Log.information(this, getPrintingString(REJECT_LIGHT_ORDER_ORIGIN_CODES, rejectLightOrderOrigins));</TD></TR><TR CLASS="z"><TD CLASS="l">1960</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1961</TD><TD>                rejectLightOrderOrigins = new String[1];</TD></TR><TR CLASS="z"><TD CLASS="l">1962</TD><TD>                rejectLightOrderOrigins[0] = NO_ORIGIN_CODES;</TD></TR><TR CLASS="z"><TD CLASS="l">1963</TD><TD>            Log.alarm(this, &#34;Exception while getting property (&#34; + REJECT_LIGHT_ORDER_ORIGIN_CODES + &#34;) Default (0) is used. &#34; + e.getMessage());</TD></TR><TR><TD CLASS="l">1964</TD><TD>        }</TD></TR><TR><TD CLASS="l">1965</TD><TD>        String cxlReasons[];</TD></TR><TR><TD CLASS="l">1966</TD><TD>        try</TD></TR><TR><TD CLASS="l">1967</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1968</TD><TD>                cxlReasons = config.getPropertyList(PUBLISH_CXL_REASONS_FOR_LIGHT_ORDERS, &#34;3&#34;, &#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1969</TD><TD>            Log.information(this, getPrintingString(PUBLISH_CXL_REASONS_FOR_LIGHT_ORDERS, cxlReasons));</TD></TR><TR><TD CLASS="l">1970</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1971</TD><TD>        catch (Exception e)</TD></TR><TR><TD CLASS="l">1972</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1973</TD><TD>                cxlReasons = new String[] { &#34;3&#34; }; // default</TD></TR><TR CLASS="z"><TD CLASS="l">1974</TD><TD>            Log.alarm(this, &#34;Exception while getting property (&#34; + PUBLISH_CXL_REASONS_FOR_LIGHT_ORDERS + &#34;). Default (3) is used. &#34; + e.getMessage());</TD></TR><TR><TD CLASS="l">1975</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="8b">1976</A></TD><TD>        initpublishCxlReasonCodesForLightOrders(cxlReasons);</TD></TR><TR CLASS="z"><TD CLASS="l">1977</TD><TD>    }</TD></TR><TR><TD CLASS="l">1978</TD><TD> </TD></TR><TR><TD CLASS="l">1979</TD><TD>    protected static String[] getTreatedLikeQuoteOriginCodes(String sessionName) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="4f">1980</A></TD><TD>        return (String[]) quoteLockConfiguredForSessions.get(sessionName);</TD></TR><TR><TD CLASS="l">1981</TD><TD>    }</TD></TR><TR><TD CLASS="l">1982</TD><TD> </TD></TR><TR><TD CLASS="l">1983</TD><TD>    protected static String[] getClearsLikeQuoteOriginCodes(String sessionName) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="c6">1984</A></TD><TD>        return (String[]) clearsLikeQuoteConfiguredForSessions.get(sessionName);</TD></TR><TR><TD CLASS="l">1985</TD><TD>    }</TD></TR><TR><TD CLASS="l">1986</TD><TD> </TD></TR><TR><TD CLASS="l">1987</TD><TD>    public static boolean shouldOrderTreatedLikeQuote(OrderHandlingStruct order) {</TD></TR><TR CLASS="z"><TD CLASS="l">1988</TD><TD>        return isOrderOriginQuoteLike(order.orderOriginType, order.activeSession);</TD></TR><TR><TD CLASS="l">1989</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="a9">1990</A></TD><TD> </TD></TR><TR><TD CLASS="l">1991</TD><TD>    </TD></TR><TR><TD CLASS="l">1992</TD><TD>    public static boolean isOrderOriginQuoteLike(char originCode, String session) </TD></TR><TR><TD CLASS="l">1993</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1994</TD><TD>        boolean quoteLike = false;</TD></TR><TR><TD CLASS="l">1995</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1996</TD><TD>            String[] qOriginCodes = getTreatedLikeQuoteOriginCodes(session);</TD></TR><TR CLASS="z"><TD CLASS="l">1997</TD><TD>            if (qOriginCodes != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1998</TD><TD>                for (int i = 0; i &lt; qOriginCodes.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1999</TD><TD>                    if (originCode == qOriginCodes[i].charAt(0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2000</TD><TD>                            quoteLike = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2001</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">2002</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2003</TD><TD>                }</TD></TR><TR><TD CLASS="l">2004</TD><TD>            }</TD></TR><TR><TD CLASS="l">2005</TD><TD>        } </TD></TR><TR CLASS="z"><TD CLASS="l">2006</TD><TD>        catch (Exception e) </TD></TR><TR><TD CLASS="l">2007</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2008</TD><TD>            Log.alarm(&#34;OrderHomeImpl &gt;&gt;&gt;&gt; Q-Order Origin Codes defined incorrectly: &#34; + e);</TD></TR><TR><TD CLASS="l">2009</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2010</TD><TD>        return quoteLike;</TD></TR><TR><TD CLASS="l">2011</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="c5">2012</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2013</TD><TD> </TD></TR><TR><TD CLASS="l">2014</TD><TD> </TD></TR><TR><TD CLASS="l">2015</TD><TD>    public static boolean shouldOrderTreatedLikeQuote(Order theOrder) {</TD></TR><TR CLASS="z"><TD CLASS="l">2016</TD><TD>        boolean should = false;</TD></TR><TR><TD CLASS="l">2017</TD><TD> </TD></TR><TR><TD CLASS="l">2018</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2019</TD><TD>            String[] qOriginCodes = getTreatedLikeQuoteOriginCodes(theOrder</TD></TR><TR CLASS="z"><TD CLASS="l">2020</TD><TD>                    .getActiveSession());</TD></TR><TR CLASS="z"><TD CLASS="l">2021</TD><TD>            if (qOriginCodes != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2022</TD><TD>                for (int i = 0; i &lt; qOriginCodes.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2023</TD><TD>                    if (theOrder.getOrderOriginType() == qOriginCodes[i]</TD></TR><TR CLASS="z"><TD CLASS="l">2024</TD><TD>                            .charAt(0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2025</TD><TD>                        should = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2026</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">2027</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2028</TD><TD>                }</TD></TR><TR><TD CLASS="l">2029</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2030</TD><TD>        } catch (Exception e) {</TD></TR><TR><TD CLASS="l">2031</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">2032</TD><TD>                    .alarm(&#34;OrderHomeImpl &gt;&gt;&gt;&gt; Q-Order Origin Codes defined incorrectly: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2033</TD><TD>                            + e);</TD></TR><TR><TD CLASS="l">2034</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="c3">2035</A></TD><TD>        return should;</TD></TR><TR><TD CLASS="l">2036</TD><TD>    }</TD></TR><TR><TD CLASS="l">2037</TD><TD> </TD></TR><TR><TD CLASS="l">2038</TD><TD>    public boolean shouldOrderClearsLikeQuote(Order theOrder) {</TD></TR><TR CLASS="z"><TD CLASS="l">2039</TD><TD>        boolean should = false;</TD></TR><TR><TD CLASS="l">2040</TD><TD> </TD></TR><TR><TD CLASS="l">2041</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2042</TD><TD>            String[] qOriginCodes = getClearsLikeQuoteOriginCodes(theOrder</TD></TR><TR CLASS="z"><TD CLASS="l">2043</TD><TD>                    .getActiveSession());</TD></TR><TR CLASS="z"><TD CLASS="l">2044</TD><TD>            if (qOriginCodes != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2045</TD><TD>                for (int i = 0; i &lt; qOriginCodes.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2046</TD><TD>                    if (theOrder.getOrderOriginType() == qOriginCodes[i]</TD></TR><TR CLASS="z"><TD CLASS="l">2047</TD><TD>                            .charAt(0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2048</TD><TD>                        should = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2049</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">2050</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2051</TD><TD>                }</TD></TR><TR><TD CLASS="l">2052</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2053</TD><TD>        } catch (Exception e) {</TD></TR><TR><TD CLASS="l">2054</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">2055</TD><TD>                    .exception(</TD></TR><TR CLASS="z"><TD CLASS="l">2056</TD><TD>                            &#34;OrderHomeImpl &gt;&gt;&gt;&gt; Q-Order Origin Codes incorrectly defined for clearsLikeQuote: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2057</TD><TD>                                    + e, e);</TD></TR><TR><TD CLASS="l">2058</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2059</TD><TD>        return should;</TD></TR><TR><TD CLASS="l"><A NAME="c4">2060</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2061</TD><TD> </TD></TR><TR><TD CLASS="l">2062</TD><TD>    public static boolean shouldOrderClearsLikeQuote(OrderHandlingStruct order) {</TD></TR><TR><TD CLASS="l">2063</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2064</TD><TD>            String[] qOriginCodes = getClearsLikeQuoteOriginCodes(order.activeSession);</TD></TR><TR CLASS="z"><TD CLASS="l">2065</TD><TD>            if (qOriginCodes != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2066</TD><TD>                for (int i = 0; i &lt; qOriginCodes.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2067</TD><TD>                    if (order.orderOriginType == qOriginCodes[i].charAt(0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2068</TD><TD>                        return true;</TD></TR><TR><TD CLASS="l">2069</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2070</TD><TD>                }</TD></TR><TR><TD CLASS="l">2071</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2072</TD><TD>        } catch (Exception e) {</TD></TR><TR><TD CLASS="l">2073</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">2074</TD><TD>                    .exception(</TD></TR><TR CLASS="z"><TD CLASS="l">2075</TD><TD>                            &#34;OrderHomeImpl &gt;&gt;&gt;&gt; Q-Order Origin Codes incorrectly defined for clearsLikeQuote: &#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">2076</TD><TD>                            e);</TD></TR><TR><TD CLASS="l">2077</TD><TD>        }</TD></TR><TR><TD CLASS="l">2078</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="c8">2079</A></TD><TD>        return false;</TD></TR><TR><TD CLASS="l">2080</TD><TD>    }</TD></TR><TR><TD CLASS="l">2081</TD><TD> </TD></TR><TR><TD CLASS="l">2082</TD><TD>    public boolean shouldPublishMarketAlertOnOriginType(char originCode) {</TD></TR><TR CLASS="z"><TD CLASS="l">2083</TD><TD>        boolean should = false;</TD></TR><TR><TD CLASS="l">2084</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2085</TD><TD>            if (marketAlertOnOriginCodes != null</TD></TR><TR CLASS="z"><TD CLASS="l">2086</TD><TD>                    &amp;&amp; marketAlertOnOriginCodes.length &gt; 0</TD></TR><TR CLASS="z"><TD CLASS="l">2087</TD><TD>                    &amp;&amp; !marketAlertOnOriginCodes[0].equals(NO_MARKET_ALERT)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2088</TD><TD>                for (int i = 0; i &lt; marketAlertOnOriginCodes.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2089</TD><TD>                    if (originCode == marketAlertOnOriginCodes[i].charAt(0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2090</TD><TD>                        should = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2091</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">2092</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2093</TD><TD>                }</TD></TR><TR><TD CLASS="l">2094</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2095</TD><TD>        } catch (Exception e) {</TD></TR><TR><TD CLASS="l">2096</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">2097</TD><TD>                    .alarm(&#34;OrderHomeImpl &gt;&gt;&gt;&gt;marketAlertOnOriginCodes Codes defined incorrectly: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2098</TD><TD>                            + e);</TD></TR><TR><TD CLASS="l">2099</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2100</TD><TD>        return should;</TD></TR><TR><TD CLASS="l"><A NAME="c7">2101</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2102</TD><TD> </TD></TR><TR><TD CLASS="l">2103</TD><TD>    public boolean shouldPublishCxlReportForLightOrder(short reasonCode)</TD></TR><TR><TD CLASS="l">2104</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2105</TD><TD>            boolean publish = false;</TD></TR><TR CLASS="z"><TD CLASS="l">2106</TD><TD>            for (short rc : publishCxlReasonsForLightOrders)</TD></TR><TR><TD CLASS="l">2107</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2108</TD><TD>                    if (reasonCode==rc)</TD></TR><TR><TD CLASS="l">2109</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2110</TD><TD>                            publish = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2111</TD><TD>                            break;</TD></TR><TR><TD CLASS="l">2112</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2113</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="ca">2114</A></TD><TD>            return publish;</TD></TR><TR><TD CLASS="l">2115</TD><TD>    }</TD></TR><TR><TD CLASS="l">2116</TD><TD>    </TD></TR><TR><TD CLASS="l">2117</TD><TD>    public boolean shouldTreatedLikeCustomerOrder(Order theOrder) {</TD></TR><TR CLASS="z"><TD CLASS="l">2118</TD><TD>        boolean should = false;</TD></TR><TR><TD CLASS="l">2119</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2120</TD><TD>            if (customerCodes != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2121</TD><TD>                for (int i = 0; i &lt; customerCodes.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2122</TD><TD>                    if (theOrder.getOrderOriginType() == customerCodes[i]</TD></TR><TR CLASS="z"><TD CLASS="l">2123</TD><TD>                            .charAt(0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2124</TD><TD>                        should = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2125</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">2126</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2127</TD><TD>                }</TD></TR><TR><TD CLASS="l">2128</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2129</TD><TD>        } catch (Exception e) {</TD></TR><TR><TD CLASS="l">2130</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">2131</TD><TD>                    .alarm(&#34;OrderHomeImpl &gt;&gt;&gt;&gt; Customer Origin Codes defined incorrectly: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2132</TD><TD>                            + e);</TD></TR><TR><TD CLASS="l">2133</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2134</TD><TD>        return should;</TD></TR><TR><TD CLASS="l">2135</TD><TD>    }</TD></TR><TR><TD CLASS="l">2136</TD><TD>    </TD></TR><TR><TD CLASS="l">2137</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2138</TD><TD>     * Check the nbboFlashCodes property (Order.xml) to verify if the order</TD></TR><TR><TD CLASS="l">2139</TD><TD>     * should flash based on the originType </TD></TR><TR><TD CLASS="l"><A NAME="c2">2140</A></TD><TD>     * @param theOrder</TD></TR><TR><TD CLASS="l">2141</TD><TD>     * @return</TD></TR><TR><TD CLASS="l">2142</TD><TD>     */</TD></TR><TR><TD CLASS="l">2143</TD><TD>    public boolean shouldGenerateNBBOFlash(Order theOrder) {</TD></TR><TR CLASS="z"><TD CLASS="l">2144</TD><TD>        boolean should = false;</TD></TR><TR><TD CLASS="l">2145</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2146</TD><TD>            if (nbboFlashCodes != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2147</TD><TD>                for (int i = 0; i &lt; nbboFlashCodes.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2148</TD><TD>                    if (theOrder.getOrderOriginType() == nbboFlashCodes[i]</TD></TR><TR CLASS="z"><TD CLASS="l">2149</TD><TD>                            .charAt(0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2150</TD><TD>                        should = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2151</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">2152</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2153</TD><TD>                }</TD></TR><TR><TD CLASS="l">2154</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2155</TD><TD>        } catch (Exception e) {</TD></TR><TR><TD CLASS="l">2156</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">2157</TD><TD>                    .alarm(&#34;OrderHomeImpl &gt;&gt;&gt;&gt; Customer Origin Codes defined incorrectly: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2158</TD><TD>                            + e);</TD></TR><TR><TD CLASS="l">2159</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2160</TD><TD>        return should;</TD></TR><TR><TD CLASS="l">2161</TD><TD>    }</TD></TR><TR><TD CLASS="l">2162</TD><TD> </TD></TR><TR><TD CLASS="l">2163</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2164</TD><TD>     *  Prepare to process as slave.</TD></TR><TR><TD CLASS="l">2165</TD><TD>     */</TD></TR><TR><TD CLASS="l">2166</TD><TD>    public void goSlave() {</TD></TR><TR><TD CLASS="l"><A NAME="90">2167</A></TD><TD>        // create or recreate orderCache - will drop all existing references to</TD></TR><TR><TD CLASS="l">2168</TD><TD>        // orders.</TD></TR><TR><TD CLASS="l">2169</TD><TD>        // wjg - change to ConcurrentHashMap for performance</TD></TR><TR><TD CLASS="l">2170</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2171</TD><TD>        orderCache = new ConcurrentHashMap(initialCacheSize);</TD></TR><TR CLASS="z"><TD CLASS="l">2172</TD><TD>        quoteLikeOrdersCache = new ConcurrentIntHashMap(initialCacheSize);</TD></TR><TR CLASS="z"><TD CLASS="l">2173</TD><TD>        productKeyOrderCacheForSessions = new ConcurrentHashMap(</TD></TR><TR CLASS="z"><TD CLASS="l">2174</TD><TD>                initialCacheSize);</TD></TR><TR><TD CLASS="l">2175</TD><TD> </TD></TR><TR><TD CLASS="l">2176</TD><TD>        // make sure we can get to the channel and history home</TD></TR><TR CLASS="z"><TD CLASS="l">2177</TD><TD>        getInternalOrderStatusPublisher();</TD></TR><TR CLASS="z"><TD CLASS="l">2178</TD><TD>        getTransientInternalOrderStatusPublisher();</TD></TR><TR CLASS="z"><TD CLASS="l">2179</TD><TD>        getMarketAlertPublisher();</TD></TR><TR CLASS="z"><TD CLASS="l">2180</TD><TD>        getOrderHistoryHome();</TD></TR><TR CLASS="z"><TD CLASS="l">2181</TD><TD>        getProductDataCacheHome();</TD></TR><TR CLASS="z"><TD CLASS="l">2182</TD><TD>        getOrderSync();</TD></TR><TR><TD CLASS="l">2183</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">2184</TD><TD>    }</TD></TR><TR><TD CLASS="l">2185</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="b3">2186</A></TD><TD>    public void postSlave()</TD></TR><TR><TD CLASS="l">2187</TD><TD>    {</TD></TR><TR><TD CLASS="l">2188</TD><TD>        // If this is a slave trade server, get all orders from</TD></TR><TR><TD CLASS="l">2189</TD><TD>        // order sync.</TD></TR><TR CLASS="z"><TD CLASS="l">2190</TD><TD>        if (!FFStatusQuery.getInstance().isStartedInMasterMode()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2191</TD><TD>            getOrderSync().updateAllOrdersFromSync();</TD></TR><TR><TD CLASS="l"><A NAME="c">2192</A></TD><TD>        }   </TD></TR><TR CLASS="z"><TD CLASS="l">2193</TD><TD>    }</TD></TR><TR><TD CLASS="l">2194</TD><TD> </TD></TR><TR><TD CLASS="l">2195</TD><TD>    public void addPOrPAOrderToList(OrderIdStruct orderId) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="d">2196</A></TD><TD>        pAndPAOrders.add(orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">2197</TD><TD>    }</TD></TR><TR><TD CLASS="l">2198</TD><TD> </TD></TR><TR><TD CLASS="l">2199</TD><TD>    public void addSatisfactionOrderToList(OrderIdStruct orderId) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="37">2200</A></TD><TD>        satisfactionOrders.add(orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">2201</TD><TD>    }</TD></TR><TR><TD CLASS="l">2202</TD><TD> </TD></TR><TR><TD CLASS="l">2203</TD><TD>    public Order[] findActivePAOrders() {</TD></TR><TR CLASS="z"><TD CLASS="l">2204</TD><TD>        ArrayList&lt;Order&gt; ordersList = new ArrayList&lt;Order&gt;(pAndPAOrders.size());</TD></TR><TR CLASS="z"><TD CLASS="l">2205</TD><TD>        for (int i = 0; i &lt; pAndPAOrders.size(); i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2206</TD><TD>            Order anOrder = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2207</TD><TD>            OrderIdStruct orderId = null;</TD></TR><TR><TD CLASS="l">2208</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2209</TD><TD>                orderId = pAndPAOrders.get(i);</TD></TR><TR CLASS="z"><TD CLASS="l">2210</TD><TD>                anOrder = findOrder(orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">2211</TD><TD>            } catch (TransactionFailedException tfe) {</TD></TR><TR CLASS="z"><TD CLASS="l">2212</TD><TD>                StringBuffer orderIdStr = new StringBuffer(</TD></TR><TR CLASS="z"><TD CLASS="l">2213</TD><TD>                        orderId.executingOrGiveUpFirm.exchange);</TD></TR><TR CLASS="z"><TD CLASS="l">2214</TD><TD>                orderIdStr.append(&#34;:&#34;).append(</TD></TR><TR CLASS="z"><TD CLASS="l">2215</TD><TD>                        orderId.executingOrGiveUpFirm.firmNumber).append(&#34;:&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2216</TD><TD>                        .append(orderId.branch).append(&#34;:&#34;).append(</TD></TR><TR CLASS="z"><TD CLASS="l">2217</TD><TD>                                orderId.branchSequenceNumber).append(&#34;:&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2218</TD><TD>                        .append(orderId.correspondentFirm);</TD></TR><TR><TD CLASS="l">2219</TD><TD>                Log</TD></TR><TR CLASS="z"><TD CLASS="l">2220</TD><TD>                        .information(</TD></TR><TR CLASS="z"><TD CLASS="l">2221</TD><TD>                                this,</TD></TR><TR CLASS="z"><TD CLASS="l">2222</TD><TD>                                &#34;TransactionFailedException: can not find the Order from Order Cache for the order Id&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2223</TD><TD>                                        + orderIdStr.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2224</TD><TD>            } catch (NotFoundException nfe) {</TD></TR><TR CLASS="z"><TD CLASS="l">2225</TD><TD>                StringBuffer orderIdStr = new StringBuffer(</TD></TR><TR CLASS="z"><TD CLASS="l">2226</TD><TD>                        orderId.executingOrGiveUpFirm.exchange);</TD></TR><TR CLASS="z"><TD CLASS="l">2227</TD><TD>                orderIdStr.append(&#34;:&#34;).append(</TD></TR><TR CLASS="z"><TD CLASS="l">2228</TD><TD>                        orderId.executingOrGiveUpFirm.firmNumber).append(&#34;:&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2229</TD><TD>                        .append(orderId.branch).append(&#34;:&#34;).append(</TD></TR><TR CLASS="z"><TD CLASS="l">2230</TD><TD>                                orderId.branchSequenceNumber).append(&#34;:&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2231</TD><TD>                        .append(orderId.correspondentFirm);</TD></TR><TR CLASS="z"><TD CLASS="l">2232</TD><TD>                Log.information(this,</TD></TR><TR CLASS="z"><TD CLASS="l">2233</TD><TD>                        &#34;NotFoundException: can not find the Order from Order Cache for the order Id&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2234</TD><TD>                                + orderIdStr.toString());</TD></TR><TR><TD CLASS="l">2235</TD><TD> </TD></TR><TR><TD CLASS="l">2236</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2237</TD><TD>            if (anOrder != null &amp;&amp; anOrder.getRemainingQuantity() &gt; 0</TD></TR><TR CLASS="z"><TD CLASS="l">2238</TD><TD>                    &amp;&amp; (anOrder.isActive())) {</TD></TR><TR CLASS="z"><TD CLASS="l">2239</TD><TD>                ordersList.add(anOrder);</TD></TR><TR><TD CLASS="l">2240</TD><TD>            }</TD></TR><TR><TD CLASS="l">2241</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="38">2242</A></TD><TD>        return (Order[]) ordersList.toArray(new Order[0]);</TD></TR><TR><TD CLASS="l">2243</TD><TD>    }</TD></TR><TR><TD CLASS="l">2244</TD><TD> </TD></TR><TR><TD CLASS="l">2245</TD><TD>    public Order[] findActiveSatisfactionOrders() {</TD></TR><TR CLASS="z"><TD CLASS="l">2246</TD><TD>        ArrayList&lt;Order&gt; ordersList = new ArrayList&lt;Order&gt;(satisfactionOrders</TD></TR><TR CLASS="z"><TD CLASS="l">2247</TD><TD>                .size());</TD></TR><TR CLASS="z"><TD CLASS="l">2248</TD><TD>        for (int i = 0; i &lt; satisfactionOrders.size(); i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2249</TD><TD>            Order anOrder = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2250</TD><TD>            OrderIdStruct orderId = null;</TD></TR><TR><TD CLASS="l">2251</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2252</TD><TD>                orderId = satisfactionOrders.get(i);</TD></TR><TR CLASS="z"><TD CLASS="l">2253</TD><TD>                anOrder = findOrder(orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">2254</TD><TD>            } catch (TransactionFailedException tfe) {</TD></TR><TR CLASS="z"><TD CLASS="l">2255</TD><TD>                StringBuffer orderIdStr = new StringBuffer(</TD></TR><TR CLASS="z"><TD CLASS="l">2256</TD><TD>                        orderId.executingOrGiveUpFirm.exchange);</TD></TR><TR CLASS="z"><TD CLASS="l">2257</TD><TD>                orderIdStr.append(&#34;:&#34;).append(</TD></TR><TR CLASS="z"><TD CLASS="l">2258</TD><TD>                        orderId.executingOrGiveUpFirm.firmNumber).append(&#34;:&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2259</TD><TD>                        .append(orderId.branch).append(&#34;:&#34;).append(</TD></TR><TR CLASS="z"><TD CLASS="l">2260</TD><TD>                                orderId.branchSequenceNumber).append(&#34;:&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2261</TD><TD>                        .append(orderId.correspondentFirm);</TD></TR><TR><TD CLASS="l">2262</TD><TD>                Log</TD></TR><TR CLASS="z"><TD CLASS="l">2263</TD><TD>                        .information(</TD></TR><TR CLASS="z"><TD CLASS="l">2264</TD><TD>                                this,</TD></TR><TR CLASS="z"><TD CLASS="l">2265</TD><TD>                                &#34;TransactionFailedException: can not find the Order from Order Cache for the order Id&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2266</TD><TD>                                        + orderIdStr.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2267</TD><TD>            } catch (NotFoundException nfe) {</TD></TR><TR CLASS="z"><TD CLASS="l">2268</TD><TD>                StringBuffer orderIdStr = new StringBuffer(</TD></TR><TR CLASS="z"><TD CLASS="l">2269</TD><TD>                        orderId.executingOrGiveUpFirm.exchange);</TD></TR><TR CLASS="z"><TD CLASS="l">2270</TD><TD>                orderIdStr.append(&#34;:&#34;).append(</TD></TR><TR CLASS="z"><TD CLASS="l">2271</TD><TD>                        orderId.executingOrGiveUpFirm.firmNumber).append(&#34;:&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2272</TD><TD>                        .append(orderId.branch).append(&#34;:&#34;).append(</TD></TR><TR CLASS="z"><TD CLASS="l">2273</TD><TD>                                orderId.branchSequenceNumber).append(&#34;:&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2274</TD><TD>                        .append(orderId.correspondentFirm);</TD></TR><TR CLASS="z"><TD CLASS="l">2275</TD><TD>                Log.information(this,</TD></TR><TR CLASS="z"><TD CLASS="l">2276</TD><TD>                        &#34;NotFoundException: can not find the Order from Order Cache for the order Id&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2277</TD><TD>                                + orderIdStr.toString());</TD></TR><TR><TD CLASS="l">2278</TD><TD> </TD></TR><TR><TD CLASS="l">2279</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2280</TD><TD>            if (anOrder != null &amp;&amp; anOrder.getRemainingQuantity() &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">2281</TD><TD>                ordersList.add(anOrder);</TD></TR><TR><TD CLASS="l">2282</TD><TD>            }</TD></TR><TR><TD CLASS="l">2283</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2284</TD><TD>        return (Order[]) ordersList.toArray(new Order[0]);</TD></TR><TR><TD CLASS="l">2285</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="22">2286</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2287</TD><TD> </TD></TR><TR><TD CLASS="l">2288</TD><TD>    private void clearOrderCollections()</TD></TR><TR><TD CLASS="l">2289</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2290</TD><TD>        orderCache.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">2291</TD><TD>        productKeyOrderCacheForSessions.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">2292</TD><TD>        quoteLikeOrdersCache.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">2293</TD><TD>    }</TD></TR><TR><TD CLASS="l">2294</TD><TD>     </TD></TR><TR><TD CLASS="l">2295</TD><TD>    private void cleanupForSlowFailover()</TD></TR><TR><TD CLASS="l"><A NAME="21">2296</A></TD><TD>    {</TD></TR><TR><TD CLASS="l">2297</TD><TD>        // Must clear the order collections before rebuilding the book</TD></TR><TR><TD CLASS="l">2298</TD><TD>        // otherwise the newly rebuilt book will be undesirably populated</TD></TR><TR><TD CLASS="l">2299</TD><TD>        // with orders from these unwanted order collections.</TD></TR><TR CLASS="z"><TD CLASS="l">2300</TD><TD>        clearOrderCollections();</TD></TR><TR CLASS="z"><TD CLASS="l">2301</TD><TD>        getOrderSync().clearOrderHolders();</TD></TR><TR><TD CLASS="l">2302</TD><TD>        </TD></TR><TR><TD CLASS="l">2303</TD><TD>        // Now rebuild order books.</TD></TR><TR><TD CLASS="l">2304</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2305</TD><TD>            getOrderBookServiceHome().findLocal().buildTransientOrderBook();</TD></TR><TR><TD CLASS="l">2306</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2307</TD><TD>        catch (SystemException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2308</TD><TD>            Log.alarm(this, &#34;Failed to cleanup order books on slow fail-over&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2309</TD><TD>            Log.exception(e);</TD></TR><TR><TD CLASS="l"><A NAME="8f">2310</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2311</TD><TD>    }</TD></TR><TR><TD CLASS="l">2312</TD><TD>    </TD></TR><TR><TD CLASS="l">2313</TD><TD>    public void goMaster(boolean fastFailover) {</TD></TR><TR CLASS="z"><TD CLASS="l">2314</TD><TD>        Log.information(this, &#34;OrderHomeImpl.goMaster start&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2315</TD><TD>        super.goMaster(fastFailover);</TD></TR><TR CLASS="z"><TD CLASS="l">2316</TD><TD>        initializeNBBOMinSizeGuaranteeOrderSeqNum();</TD></TR><TR CLASS="z"><TD CLASS="l">2317</TD><TD>        initializeSatisfySatisfactionOrderSeqNum();</TD></TR><TR CLASS="z"><TD CLASS="l">2318</TD><TD>        pAndPAOrders = new ArrayList&lt;OrderIdStruct&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">2319</TD><TD>        satisfactionOrders = new ArrayList&lt;OrderIdStruct&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">2320</TD><TD>        if (fastFailover) {            </TD></TR><TR><TD CLASS="l">2321</TD><TD>            // The orders should already be in sync.</TD></TR><TR CLASS="z"><TD CLASS="l">2322</TD><TD>            Log.information(this, &#34;Performing fast-failover. Skipping order cache loading&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2323</TD><TD>            getOrderSync().processAllOrders();</TD></TR><TR><TD CLASS="l">2324</TD><TD>        }</TD></TR><TR><TD CLASS="l">2325</TD><TD>        else {</TD></TR><TR><TD CLASS="l">2326</TD><TD>            // This is the case for one of two scenarios</TD></TR><TR><TD CLASS="l">2327</TD><TD>            // - The trade server is starting up in master mode</TD></TR><TR><TD CLASS="l">2328</TD><TD>            // - The trade server had been running in slave mode, but is </TD></TR><TR><TD CLASS="l">2329</TD><TD>            // now transitioning to master mode with a slow fail-over</TD></TR><TR><TD CLASS="l">2330</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">2331</TD><TD>            if (!FFStatusQuery.getInstance().isStartedInMasterMode()) {</TD></TR><TR><TD CLASS="l">2332</TD><TD>                // In slow fail-over mode, purge the order-books. This is done to </TD></TR><TR><TD CLASS="l">2333</TD><TD>                // start with a clean slate in slow fail-over mode because the</TD></TR><TR><TD CLASS="l">2334</TD><TD>                // slow fail-over will reload all order from OHS rather than</TD></TR><TR><TD CLASS="l">2335</TD><TD>                // relying on the current state of the order-book or the order sync.</TD></TR><TR><TD CLASS="l">2336</TD><TD>                // Note that this order book purge must occur before the orders are loaded </TD></TR><TR><TD CLASS="l">2337</TD><TD>                // from OHS.</TD></TR><TR CLASS="z"><TD CLASS="l">2338</TD><TD>                cleanupForSlowFailover();</TD></TR><TR><TD CLASS="l">2339</TD><TD>            }</TD></TR><TR><TD CLASS="l">2340</TD><TD>                </TD></TR><TR><TD CLASS="l">2341</TD><TD>            // The order loaders will retrieve orders from OHS and</TD></TR><TR><TD CLASS="l">2342</TD><TD>            // process those that should be sent back to OHS to cancel</TD></TR><TR><TD CLASS="l">2343</TD><TD>            // and those that should be booked. The bookable orders will get</TD></TR><TR><TD CLASS="l">2344</TD><TD>            // booked.</TD></TR><TR CLASS="z"><TD CLASS="l">2345</TD><TD>        orderLoadStartTime = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">2346</TD><TD>        loadOrderCache();</TD></TR><TR CLASS="z"><TD CLASS="l">2347</TD><TD>        orderLoadEndTime = System.currentTimeMillis();</TD></TR><TR><TD CLASS="l">2348</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2349</TD><TD>        Log.information(orderCache.size() + &#34; Orders Loaded in &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2350</TD><TD>                + String.valueOf(orderLoadEndTime - orderLoadStartTime)</TD></TR><TR CLASS="z"><TD CLASS="l">2351</TD><TD>                + &#34; MiliSeconds &#34; + &#34; in &#34; + totalNumberOfOrderLoadingThreads</TD></TR><TR CLASS="z"><TD CLASS="l">2352</TD><TD>                + &#34; OrderLoading Threads &#34; + &#34; By batching &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2353</TD><TD>                + maxProductsToSendPerCallToOHS + &#34; products per call &#34;);</TD></TR><TR><TD CLASS="l">2354</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2355</TD><TD>        Log.information(this, &#34;OrderHomeImpl.goMaster complete&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="7b">2356</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2357</TD><TD> </TD></TR><TR><TD CLASS="l">2358</TD><TD>    public ProductDataCacheHome  getProductDataCacheHome()</TD></TR><TR><TD CLASS="l">2359</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2360</TD><TD>        if (productDataCacheHome == null)</TD></TR><TR><TD CLASS="l">2361</TD><TD>        {</TD></TR><TR><TD CLASS="l">2362</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2363</TD><TD>                productDataCacheHome = (ProductDataCacheHome) HomeFactory.getInstance().findHome(ProductDataCacheHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">2364</TD><TD>                Log.information(this, this.getName()+ &#34;==&gt;Found productDataCacheHome.&#34;);</TD></TR><TR><TD CLASS="l">2365</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2366</TD><TD>            catch (CBOELoggableException e)</TD></TR><TR><TD CLASS="l">2367</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2368</TD><TD>                Log.exception(this, &#34;Exception occured while&#34; + this.getName() + &#34; was retrieving ProductDataCacheHome&#34;, e);</TD></TR><TR><TD CLASS="l">2369</TD><TD>            }</TD></TR><TR><TD CLASS="l">2370</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2371</TD><TD>        return productDataCacheHome;</TD></TR><TR><TD CLASS="l">2372</TD><TD>    }</TD></TR><TR><TD CLASS="l">2373</TD><TD> </TD></TR><TR><TD CLASS="l">2374</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2375</TD><TD>     * Load Order cache makes a remote call out to the OHS to load the order cache At this time</TD></TR><TR><TD CLASS="l">2376</TD><TD>     * instead of a paging strategy, the batched call will attempt to randomly distribute the</TD></TR><TR><TD CLASS="l">2377</TD><TD>     * products and will fetch the corresponding orders for those. These products will then be</TD></TR><TR><TD CLASS="l"><A NAME="ab">2378</A></TD><TD>     * loaded into the cache. The calls out to the OHS will also be executed concurrently in</TD></TR><TR><TD CLASS="l">2379</TD><TD>     * multiple loader threads and each getting its own share of products</TD></TR><TR><TD CLASS="l">2380</TD><TD>     */</TD></TR><TR><TD CLASS="l">2381</TD><TD>    public void loadOrderCache() {</TD></TR><TR CLASS="z"><TD CLASS="l">2382</TD><TD>        TradingSessionStruct[] currentSessions = null;</TD></TR><TR><TD CLASS="l">2383</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2384</TD><TD>            currentSessions = getTradingSessionService().getTradingSessions();</TD></TR><TR CLASS="z"><TD CLASS="l">2385</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2386</TD><TD>            throw new FatalFoundationFrameworkException(e,</TD></TR><TR CLASS="z"><TD CLASS="l">2387</TD><TD>                    &#34;TradingSessionService not found&#34; + e.getMessage());</TD></TR><TR><TD CLASS="l">2388</TD><TD>        }</TD></TR><TR><TD CLASS="l">2389</TD><TD> </TD></TR><TR><TD CLASS="l">2390</TD><TD>        // check to see if to proceed forward</TD></TR><TR CLASS="z"><TD CLASS="l">2391</TD><TD>        if (currentSessions == null || currentSessions.length == 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">2392</TD><TD>            return;</TD></TR><TR><TD CLASS="l">2393</TD><TD>        }</TD></TR><TR><TD CLASS="l">2394</TD><TD> </TD></TR><TR><TD CLASS="l">2395</TD><TD>        // construct the orderrouting paramters struct which contains routing information</TD></TR><TR CLASS="z"><TD CLASS="l">2396</TD><TD>        OrderRoutingParameterStruct orderRouting = getORParamsStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2397</TD><TD>        for (int i = 0; i &lt; currentSessions.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2398</TD><TD>            String sessionName = currentSessions[i].sessionName;</TD></TR><TR CLASS="z"><TD CLASS="l">2399</TD><TD>            if (isSessionConfigured(sessionName)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2400</TD><TD>                fetchOrdersFromOHS(orderRouting, sessionName);</TD></TR><TR><TD CLASS="l">2401</TD><TD>            }</TD></TR><TR><TD CLASS="l">2402</TD><TD>        }</TD></TR><TR><TD CLASS="l">2403</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2404</TD><TD>    }</TD></TR><TR><TD CLASS="l">2405</TD><TD> </TD></TR><TR><TD CLASS="l">2406</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2407</TD><TD>     * Flatten the products and store them in a List. A strategy to distribute this collection</TD></TR><TR><TD CLASS="l">2408</TD><TD>     * across the cache loader threads is chosen. Right now a cyclic distributor and a simple</TD></TR><TR><TD CLASS="l">2409</TD><TD>     * distributor strategies are available, however only the simplestrategy would be used. This</TD></TR><TR><TD CLASS="l">2410</TD><TD>     * distributed order list is then dispatched to TE via the loader threads.</TD></TR><TR><TD CLASS="l">2411</TD><TD>     * </TD></TR><TR><TD CLASS="l">2412</TD><TD>     * The simple strategy will just divide the product id by the threadnumber and assign the</TD></TR><TR><TD CLASS="l">2413</TD><TD>     * &#34;reminderth&#34; n to that respective thread.</TD></TR><TR><TD CLASS="l">2414</TD><TD>     * </TD></TR><TR><TD CLASS="l">2415</TD><TD>     * @see SimpleDistributor</TD></TR><TR><TD CLASS="l">2416</TD><TD>     * </TD></TR><TR><TD CLASS="l">2417</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="35">2418</A></TD><TD> </TD></TR><TR><TD CLASS="l">2419</TD><TD>    private void fetchOrdersFromOHS(OrderRoutingParameterStruct orderRouting,</TD></TR><TR><TD CLASS="l">2420</TD><TD>            String sessionName) {</TD></TR><TR><TD CLASS="l">2421</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2422</TD><TD>        int[] productsToBeSorted = getProductsForClasses();</TD></TR><TR><TD CLASS="l">2423</TD><TD> </TD></TR><TR><TD CLASS="l">2424</TD><TD>        //The only implementation as of now is the simple distribution based on modulo.</TD></TR><TR CLASS="z"><TD CLASS="l">2425</TD><TD>        int[][] sortedArray = SimpleDistributor.distribute(</TD></TR><TR CLASS="z"><TD CLASS="l">2426</TD><TD>                getTotalNumberOfOrderLoadingThreads(), productsToBeSorted);</TD></TR><TR><TD CLASS="l">2427</TD><TD> </TD></TR><TR><TD CLASS="l">2428</TD><TD>        // pass the new distribution of products to the orderCacheLoader</TD></TR><TR><TD CLASS="l">2429</TD><TD>        // threads</TD></TR><TR CLASS="z"><TD CLASS="l">2430</TD><TD>        loadOrdersConcurrently(orderRouting, sortedArray, sessionName);</TD></TR><TR><TD CLASS="l">2431</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2432</TD><TD>    }</TD></TR><TR><TD CLASS="l">2433</TD><TD> </TD></TR><TR><TD CLASS="l">2434</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2435</TD><TD>     * Start the loader threads which make a call to TE to load valid orders. Note that depending on</TD></TR><TR><TD CLASS="l">2436</TD><TD>     * the strategy chosen, the data assigned to each of the loader thread might vary. These loader</TD></TR><TR><TD CLASS="l">2437</TD><TD>     * threads load the order cache and a join is performed to sink up with the main thrad.</TD></TR><TR><TD CLASS="l"><A NAME="ac">2438</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">2439</TD><TD>    private void loadOrdersConcurrently(</TD></TR><TR><TD CLASS="l">2440</TD><TD>            OrderRoutingParameterStruct orderRouting, int[][] sortedArray,</TD></TR><TR><TD CLASS="l">2441</TD><TD>            String sessionName) {</TD></TR><TR CLASS="z"><TD CLASS="l">2442</TD><TD>        OrderCacheLoaders[] orderCacheLoaderThreads = new OrderCacheLoaders[totalNumberOfOrderLoadingThreads];</TD></TR><TR CLASS="z"><TD CLASS="l">2443</TD><TD>        Log.information(&#34;Total Number of Order Loading Threads: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2444</TD><TD>                + totalNumberOfOrderLoadingThreads);</TD></TR><TR><TD CLASS="l">2445</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2446</TD><TD>        for (int k = 0; k &lt; getTotalNumberOfOrderLoadingThreads(); k++) {</TD></TR><TR><TD CLASS="l">2447</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2448</TD><TD>            orderCacheLoaderThreads[k] = new OrderCacheLoaders(</TD></TR><TR CLASS="z"><TD CLASS="l">2449</TD><TD>                    buildThreadName(k), sessionName, orderRouting,</TD></TR><TR CLASS="z"><TD CLASS="l">2450</TD><TD>                    getOrderMaintenanceServiceHome(), this, sortedArray[k],</TD></TR><TR CLASS="z"><TD CLASS="l">2451</TD><TD>                    getMaxProductsToSendPerCallToOHS(),</TD></TR><TR CLASS="z"><TD CLASS="l">2452</TD><TD>                    getMaxSleepTimeBeforeOHSCall());</TD></TR><TR><TD CLASS="l">2453</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2454</TD><TD>            orderCacheLoaderThreads[k].start();</TD></TR><TR><TD CLASS="l">2455</TD><TD> </TD></TR><TR><TD CLASS="l">2456</TD><TD>        }</TD></TR><TR><TD CLASS="l">2457</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2458</TD><TD>        for (int m = 0; m &lt; totalNumberOfOrderLoadingThreads; m++) {</TD></TR><TR><TD CLASS="l">2459</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2460</TD><TD>                orderCacheLoaderThreads[m].join();</TD></TR><TR CLASS="z"><TD CLASS="l">2461</TD><TD>                Exception orderLoadingException = orderCacheLoaderThreads[m]</TD></TR><TR CLASS="z"><TD CLASS="l">2462</TD><TD>                        .getOrderLoadingException();</TD></TR><TR CLASS="z"><TD CLASS="l">2463</TD><TD>                if (orderLoadingException != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2464</TD><TD>                    throw new FatalFoundationFrameworkException(</TD></TR><TR CLASS="z"><TD CLASS="l">2465</TD><TD>                            orderLoadingException,</TD></TR><TR CLASS="z"><TD CLASS="l">2466</TD><TD>                            &#34;Exception occured while getting orders from OHS &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2467</TD><TD>                                    + orderLoadingException.getMessage()</TD></TR><TR CLASS="z"><TD CLASS="l">2468</TD><TD>                                    + orderCacheLoaderThreads[m].getName());</TD></TR><TR><TD CLASS="l">2469</TD><TD> </TD></TR><TR><TD CLASS="l">2470</TD><TD>                }</TD></TR><TR><TD CLASS="l">2471</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2472</TD><TD>            } catch (InterruptedException e) {</TD></TR><TR><TD CLASS="l">2473</TD><TD>                Log</TD></TR><TR CLASS="z"><TD CLASS="l">2474</TD><TD>                        .alarm(</TD></TR><TR CLASS="z"><TD CLASS="l">2475</TD><TD>                                this,</TD></TR><TR CLASS="z"><TD CLASS="l">2476</TD><TD>                                &#34;Interrupted while waiting for build threads to complete, assuming build is done&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2477</TD><TD>                break;</TD></TR><TR><TD CLASS="l">2478</TD><TD>            }</TD></TR><TR><TD CLASS="l">2479</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="1b">2480</A></TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2481</TD><TD>    }</TD></TR><TR><TD CLASS="l">2482</TD><TD> </TD></TR><TR><TD CLASS="l">2483</TD><TD>    private String buildThreadName(int k) {</TD></TR><TR CLASS="z"><TD CLASS="l">2484</TD><TD>        return &#34;ORDER_LOADER_NO: &#34; + k + &#34;FOR SESSION: &#34;;</TD></TR><TR><TD CLASS="l">2485</TD><TD>    }</TD></TR><TR><TD CLASS="l">2486</TD><TD> </TD></TR><TR><TD CLASS="l">2487</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="31">2488</A></TD><TD>     * Create orders for the each of the accessed order obtained from OHS</TD></TR><TR><TD CLASS="l">2489</TD><TD>     */</TD></TR><TR><TD CLASS="l">2490</TD><TD>    public void createOrders(OrderHandlingStructV2[] orderHandlingStructs) {</TD></TR><TR><TD CLASS="l">2491</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2492</TD><TD>        createOrdersForV2(orderHandlingStructs);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="32">2493</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2494</TD><TD> </TD></TR><TR><TD CLASS="l">2495</TD><TD>    private Order[] createOrdersForV2(OrderHandlingStructV2[] orderHandlingStructs)</TD></TR><TR><TD CLASS="l">2496</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2497</TD><TD>        Order orders[] = new Order[orderHandlingStructs.length];</TD></TR><TR CLASS="z"><TD CLASS="l">2498</TD><TD>        for (int j = 0; j &lt; orderHandlingStructs.length; j++) {</TD></TR><TR><TD CLASS="l">2499</TD><TD>            // On failover, the most recently known sequence number by OHS may not include</TD></TR><TR><TD CLASS="l">2500</TD><TD>            // events that are &#34;in flight&#34; on the IOSC between ORD and OHS. We therefore</TD></TR><TR><TD CLASS="l">2501</TD><TD>            // increment the last known sequence number (as received from OHS) by a reasonably</TD></TR><TR><TD CLASS="l">2502</TD><TD>            // large number to guarantee that the next event published for this order is</TD></TR><TR><TD CLASS="l">2503</TD><TD>            // greater than that of any message languishing on the GMD channel. We are</TD></TR><TR><TD CLASS="l">2504</TD><TD>            // expecting that there are (far, far) fewer than 10000 updates for this specific</TD></TR><TR><TD CLASS="l">2505</TD><TD>            // order on the event channel.</TD></TR><TR><TD CLASS="l">2506</TD><TD>            //</TD></TR><TR CLASS="z"><TD CLASS="l">2507</TD><TD>            orderHandlingStructs[j].orderHandlingStruct.transactionSequenceNumber += SEQ_NUM_FAILOVER_INCR;</TD></TR><TR><TD CLASS="l">2508</TD><TD> </TD></TR><TR><TD CLASS="l">2509</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2510</TD><TD>                Order order = create(orderHandlingStructs[j].orderHandlingStruct); // This will create order and cache it.</TD></TR><TR CLASS="z"><TD CLASS="l">2511</TD><TD>                setSessionDataFromOrderHandlingExtension(order, orderHandlingStructs[j].orderExtensions);</TD></TR><TR CLASS="z"><TD CLASS="l">2512</TD><TD>                orders[j] = order;</TD></TR><TR CLASS="z"><TD CLASS="l">2513</TD><TD>            } catch (DataValidationException e) {</TD></TR><TR><TD CLASS="l">2514</TD><TD>                //here we do not stop the server</TD></TR><TR><TD CLASS="l">2515</TD><TD>                //we let it come up with all these errors and order ids</TD></TR><TR><TD CLASS="l">2516</TD><TD>                Log</TD></TR><TR CLASS="z"><TD CLASS="l">2517</TD><TD>                        .alarm(</TD></TR><TR CLASS="z"><TD CLASS="l">2518</TD><TD>                                this,</TD></TR><TR CLASS="z"><TD CLASS="l">2519</TD><TD>                                &#34;Data Valdiation Exception during during TE loading order cache from OHS orderId BRSEQ=&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2520</TD><TD>                                        + orderHandlingStructs[j].orderHandlingStruct.orderId.branch</TD></TR><TR CLASS="z"><TD CLASS="l">2521</TD><TD>                                        + &#34;:&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2522</TD><TD>                                        + orderHandlingStructs[j].orderHandlingStruct.orderId.branchSequenceNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">2523</TD><TD>                Log.exception(this, e);</TD></TR><TR CLASS="z"><TD CLASS="l">2524</TD><TD>                return orders;</TD></TR><TR CLASS="z"><TD CLASS="l">2525</TD><TD>            } catch (SystemException e) {</TD></TR><TR><TD CLASS="l">2526</TD><TD>                //here we do not stop the server</TD></TR><TR><TD CLASS="l">2527</TD><TD>                //we let it come up with all these errors and order ids</TD></TR><TR><TD CLASS="l">2528</TD><TD>                Log</TD></TR><TR CLASS="z"><TD CLASS="l">2529</TD><TD>                        .alarm(</TD></TR><TR CLASS="z"><TD CLASS="l">2530</TD><TD>                                this,</TD></TR><TR CLASS="z"><TD CLASS="l">2531</TD><TD>                                &#34;SystemException during TE loading order cache from OHS  for orderId =&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2532</TD><TD>                                        + orderHandlingStructs[j].orderHandlingStruct.orderId.branch</TD></TR><TR CLASS="z"><TD CLASS="l">2533</TD><TD>                                        + &#34;:&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2534</TD><TD>                                        + orderHandlingStructs[j].orderHandlingStruct.orderId.branchSequenceNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">2535</TD><TD>                Log.exception(this, e);</TD></TR><TR CLASS="z"><TD CLASS="l">2536</TD><TD>            } catch (TransactionFailedException e) {</TD></TR><TR><TD CLASS="l">2537</TD><TD>                //here we do not stop the server</TD></TR><TR><TD CLASS="l">2538</TD><TD>                //we let it come up with all these errors and order ids</TD></TR><TR><TD CLASS="l">2539</TD><TD>                Log</TD></TR><TR CLASS="z"><TD CLASS="l">2540</TD><TD>                        .alarm(</TD></TR><TR CLASS="z"><TD CLASS="l">2541</TD><TD>                                this,</TD></TR><TR CLASS="z"><TD CLASS="l">2542</TD><TD>                                &#34;TransactionFailedException during TE loading order cache from OHS for orderId =&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2543</TD><TD>                                        + orderHandlingStructs[j].orderHandlingStruct.orderId.branch</TD></TR><TR CLASS="z"><TD CLASS="l">2544</TD><TD>                                        + &#34;:&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2545</TD><TD>                                        + orderHandlingStructs[j].orderHandlingStruct.orderId.branchSequenceNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">2546</TD><TD>                Log.exception(this, e);</TD></TR><TR><TD CLASS="l">2547</TD><TD>            }</TD></TR><TR><TD CLASS="l">2548</TD><TD> </TD></TR><TR><TD CLASS="l">2549</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="68">2550</A></TD><TD>        return orders;</TD></TR><TR><TD CLASS="l">2551</TD><TD>    }</TD></TR><TR><TD CLASS="l">2552</TD><TD> </TD></TR><TR><TD CLASS="l">2553</TD><TD>    private OrderRoutingParameterStruct getORParamsStruct() {</TD></TR><TR CLASS="z"><TD CLASS="l">2554</TD><TD>        OrderRoutingParameterStruct orderRouting = new OrderRoutingParameterStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2555</TD><TD>        orderRouting.sourceType = OrderLocations.TE;</TD></TR><TR CLASS="z"><TD CLASS="l">2556</TD><TD>        orderRouting.source = RouteNameHelper.getRouteName();</TD></TR><TR CLASS="z"><TD CLASS="l">2557</TD><TD>        orderRouting.destination = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2558</TD><TD>        return orderRouting;</TD></TR><TR><TD CLASS="l">2559</TD><TD>    }</TD></TR><TR><TD CLASS="l">2560</TD><TD> </TD></TR><TR><TD CLASS="l">2561</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2562</TD><TD>     * Call the trading product home to return the int[] of product keys Note: We are not using</TD></TR><TR><TD CLASS="l">2563</TD><TD>     * session as a trade server is configured for a session and that the Trading Product Home</TD></TR><TR><TD CLASS="l">2564</TD><TD>     * automatically fetches only those products</TD></TR><TR><TD CLASS="l"><A NAME="7c">2565</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">2566</TD><TD>     * @return int[]</TD></TR><TR><TD CLASS="l">2567</TD><TD>     */</TD></TR><TR><TD CLASS="l">2568</TD><TD>    private int[] getProductsForClasses() {</TD></TR><TR CLASS="z"><TD CLASS="l">2569</TD><TD>        TradingProductHome tradingHome = getTradingProductHome();</TD></TR><TR CLASS="z"><TD CLASS="l">2570</TD><TD>        int[] productsList = tradingHome.getProductKeys();</TD></TR><TR CLASS="z"><TD CLASS="l">2571</TD><TD>        return productsList;</TD></TR><TR><TD CLASS="l">2572</TD><TD> </TD></TR><TR><TD CLASS="l">2573</TD><TD>    }</TD></TR><TR><TD CLASS="l">2574</TD><TD> </TD></TR><TR><TD CLASS="l">2575</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2576</TD><TD>     * Getter for TradingProductHome.</TD></TR><TR><TD CLASS="l"><A NAME="88">2577</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">2578</TD><TD>     * @return TradingProductHome</TD></TR><TR><TD CLASS="l">2579</TD><TD>     */</TD></TR><TR><TD CLASS="l">2580</TD><TD>    private TradingProductHome getTradingProductHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">2581</TD><TD>        if (myTradingProductHome == null) {</TD></TR><TR><TD CLASS="l">2582</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2583</TD><TD>                myTradingProductHome = (TradingProductHome) HomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">2584</TD><TD>                        .getInstance().findHome(TradingProductHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">2585</TD><TD>            } catch (CBOELoggableException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2586</TD><TD>                Log.alarm(this, &#34;Unable to find TradingClassHome&#34;);</TD></TR><TR><TD CLASS="l">2587</TD><TD>            }</TD></TR><TR><TD CLASS="l">2588</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2589</TD><TD>        return myTradingProductHome;</TD></TR><TR><TD CLASS="l">2590</TD><TD>    }</TD></TR><TR><TD CLASS="l">2591</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="c1">2592</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">2593</TD><TD>     * Gets value of echo reports flag.</TD></TR><TR><TD CLASS="l">2594</TD><TD>     */</TD></TR><TR><TD CLASS="l">2595</TD><TD>    protected boolean shouldEchoReports() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5b">2596</A></TD><TD>        return echoReports;</TD></TR><TR><TD CLASS="l">2597</TD><TD>    }</TD></TR><TR><TD CLASS="l">2598</TD><TD> </TD></TR><TR><TD CLASS="l">2599</TD><TD>    LegOrderDetailHomeImpl getLegOrderDetailHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">2600</TD><TD>        if (legDetailHome == null) {</TD></TR><TR><TD CLASS="l">2601</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2602</TD><TD>                HomeFactory theHomeFactory = HomeFactory.getInstance();</TD></TR><TR CLASS="z"><TD CLASS="l">2603</TD><TD>                legDetailHome = (LegOrderDetailHomeImpl) theHomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">2604</TD><TD>                        .findHome(LegOrderDetailHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">2605</TD><TD>                if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2606</TD><TD>                    Log.debug(this, &#34;got the leg order detail home&#34;);</TD></TR><TR><TD CLASS="l">2607</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">2608</TD><TD>            } catch (com.cboe.infrastructureServices.foundationFramework.exceptionHandling.CBOELoggableException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2609</TD><TD>                Log.alarm(this, &#34;couldn't initialize LegDetailHome&#34;);</TD></TR><TR><TD CLASS="l">2610</TD><TD>            }</TD></TR><TR><TD CLASS="l">2611</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="8e">2612</A></TD><TD>        return legDetailHome;</TD></TR><TR><TD CLASS="l">2613</TD><TD>    }</TD></TR><TR><TD CLASS="l">2614</TD><TD> </TD></TR><TR><TD CLASS="l">2615</TD><TD>    protected UserService getUserService() throws SystemException {</TD></TR><TR CLASS="z"><TD CLASS="l">2616</TD><TD>        if (userService == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2617</TD><TD>            String name = UserServiceHome.HOME_NAME;</TD></TR><TR><TD CLASS="l">2618</TD><TD>            UserServiceHome home;</TD></TR><TR><TD CLASS="l">2619</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2620</TD><TD>                home = (UserServiceHome) HomeFactory.getInstance().findHome(</TD></TR><TR CLASS="z"><TD CLASS="l">2621</TD><TD>                        name);</TD></TR><TR CLASS="z"><TD CLASS="l">2622</TD><TD>            } catch (CBOELoggableException ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">2623</TD><TD>                throw ExceptionBuilder.systemException(</TD></TR><TR CLASS="z"><TD CLASS="l">2624</TD><TD>                        &#34;Failed to find user service home: &#34; + ex + &#34;: &#34; + ex,</TD></TR><TR CLASS="z"><TD CLASS="l">2625</TD><TD>                        0);</TD></TR><TR><TD CLASS="l">2626</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2627</TD><TD>            userService = home.find();</TD></TR><TR><TD CLASS="l">2628</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2629</TD><TD>        return userService;</TD></TR><TR><TD CLASS="l">2630</TD><TD>    }</TD></TR><TR><TD CLASS="l">2631</TD><TD> </TD></TR><TR><TD CLASS="l">2632</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2633</TD><TD>     * testClearCache -- this is used SOLELY for test purposes. This method will clear out the</TD></TR><TR><TD CLASS="l"><A NAME="cb">2634</A></TD><TD>     * contents of the cache so that the cache will have to be rebuilt from the DB as queries come</TD></TR><TR><TD CLASS="l">2635</TD><TD>     * in. &lt;p/&gt; Note that since this is only for testing, it has package acces.</TD></TR><TR><TD CLASS="l">2636</TD><TD>     */</TD></TR><TR><TD CLASS="l">2637</TD><TD>    public synchronized void testClearCache() {</TD></TR><TR CLASS="z"><TD CLASS="l">2638</TD><TD>        orderCache.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">2639</TD><TD>    }</TD></TR><TR><TD CLASS="l">2640</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="53">2641</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">2642</TD><TD>     * Return the executing broker when request.</TD></TR><TR><TD CLASS="l">2643</TD><TD>     */</TD></TR><TR><TD CLASS="l">2644</TD><TD>    public String getExecutingBroker() {</TD></TR><TR CLASS="z"><TD CLASS="l">2645</TD><TD>        return executingBroker;</TD></TR><TR><TD CLASS="l">2646</TD><TD>    }</TD></TR><TR><TD CLASS="l">2647</TD><TD> </TD></TR><TR><TD CLASS="l">2648</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2649</TD><TD>     * Creates a cross for a NBBO protected customer order, and a new min size guarantee order for a</TD></TR><TR><TD CLASS="l">2650</TD><TD>     * NBBOAgent</TD></TR><TR><TD CLASS="l">2651</TD><TD>     * </TD></TR><TR><TD CLASS="l">2652</TD><TD>     * @param Order nbboProtectedOrder: the customer order for which the nbbo min size guarantee</TD></TR><TR><TD CLASS="l">2653</TD><TD>     * will be satisfied.</TD></TR><TR><TD CLASS="l">2654</TD><TD>     * @param String nbboAgentId: the userId of the NBBOAgent for the product class of the customer</TD></TR><TR><TD CLASS="l">2655</TD><TD>     * order</TD></TR><TR><TD CLASS="l">2656</TD><TD>     * @param int quantity: the quantity needed for the min size guarantee order</TD></TR><TR><TD CLASS="l">2657</TD><TD>     * @return Cross a cross of nbbo protected customer order and the new min size guarantee order</TD></TR><TR><TD CLASS="l">2658</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="2a">2659</A></TD><TD>    public Cross createHeldOrderCross(Order heldOrder, String nbboAgentId,</TD></TR><TR><TD CLASS="l">2660</TD><TD>            boolean isCrossWithAutoLinkedPAOrder, String awayExchange, FilledReportStruct filledReportStruct)</TD></TR><TR><TD CLASS="l">2661</TD><TD>            throws TransactionFailedException, SystemException,</TD></TR><TR><TD CLASS="l">2662</TD><TD>            DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">2663</TD><TD>        Cross newMSGCross = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2664</TD><TD>        String clearingFirmNum = getClearingFirmNumForLinkageFill(filledReportStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">2665</TD><TD>        OrderStruct newMSGOrder = buildMSGOrderStruct(heldOrder, nbboAgentId,</TD></TR><TR CLASS="z"><TD CLASS="l">2666</TD><TD>                clearingFirmNum, filledReportStruct.tradedQuantity, </TD></TR><TR CLASS="z"><TD CLASS="l">2667</TD><TD>                filledReportStruct.price, false);</TD></TR><TR CLASS="z"><TD CLASS="l">2668</TD><TD>        String routerId = getOutboundVendorForLinkageFill(filledReportStruct);            </TD></TR><TR><TD CLASS="l">2669</TD><TD>        try </TD></TR><TR><TD CLASS="l">2670</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2671</TD><TD>            ExtensionsHelper helper = new ExtensionsHelper(newMSGOrder.extensions);</TD></TR><TR CLASS="z"><TD CLASS="l">2672</TD><TD>            helper.setValue(ExtensionFields.EXCHANGE_DESTINATION, awayExchange);</TD></TR><TR CLASS="z"><TD CLASS="l">2673</TD><TD>            helper.setValue(ExtensionFields.BROKER_ROUTING_ID, routerId);          </TD></TR><TR CLASS="z"><TD CLASS="l">2674</TD><TD>            newMSGOrder.extensions = helper.toString();</TD></TR><TR><TD CLASS="l">2675</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2676</TD><TD>        catch (Exception e)</TD></TR><TR><TD CLASS="l">2677</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2678</TD><TD>            Log.alarm(this,&#34;Error parsing away exchange/outbound vendor. Existing extension=&#34;+newMSGOrder.extensions +&#34; try to add AwayExchange=&#34;+awayExchange + &#34; and OutboundVendor=&#34;+routerId);</TD></TR><TR><TD CLASS="l">2679</TD><TD>        }</TD></TR><TR><TD CLASS="l">2680</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2681</TD><TD>        newMSGCross = createCrossForExistingOrder(heldOrder, newMSGOrder, true,</TD></TR><TR CLASS="z"><TD CLASS="l">2682</TD><TD>                isCrossWithAutoLinkedPAOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">2683</TD><TD>        return newMSGCross;</TD></TR><TR><TD CLASS="l">2684</TD><TD>    }</TD></TR><TR><TD CLASS="l">2685</TD><TD> </TD></TR><TR><TD CLASS="l">2686</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2687</TD><TD>     * Creates a cross for a NBBO protected customer order, and a new min size guarantee order</TD></TR><TR><TD CLASS="l">2688</TD><TD>     * for a NBBOAgent</TD></TR><TR><TD CLASS="l">2689</TD><TD>     *</TD></TR><TR><TD CLASS="l">2690</TD><TD>     * @param Order nbboProtectedOrder: the customer order for which the nbbo min size guarantee will</TD></TR><TR><TD CLASS="l">2691</TD><TD>     *      be satisfied.</TD></TR><TR><TD CLASS="l">2692</TD><TD>     * @param String nbboAgentId: the userId of the NBBOAgent for the product class of the customer order</TD></TR><TR><TD CLASS="l">2693</TD><TD>     * @param int quantity: the quantity needed for the min size guarantee order</TD></TR><TR><TD CLASS="l">2694</TD><TD>     * @return Cross a cross of nbbo protected customer order and the new min size guarantee order</TD></TR><TR><TD CLASS="l">2695</TD><TD>     */</TD></TR><TR><TD CLASS="l">2696</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="30">2697</A></TD><TD>    public Cross createNBBOMinSizeCross(Order nbboProtectedOrder,</TD></TR><TR><TD CLASS="l">2698</TD><TD>            String nbboAgentId, int quantity)</TD></TR><TR><TD CLASS="l">2699</TD><TD>            throws TransactionFailedException, SystemException,</TD></TR><TR><TD CLASS="l">2700</TD><TD>            DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">2701</TD><TD>        Cross newMSGCross = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2702</TD><TD>        OrderStruct newMSGOrder = buildMSGOrderStruct(nbboProtectedOrder,</TD></TR><TR CLASS="z"><TD CLASS="l">2703</TD><TD>                nbboAgentId, quantity, false);</TD></TR><TR CLASS="z"><TD CLASS="l">2704</TD><TD>        newMSGCross = createCrossForExistingOrder(nbboProtectedOrder,</TD></TR><TR CLASS="z"><TD CLASS="l">2705</TD><TD>                newMSGOrder, false, false);</TD></TR><TR CLASS="z"><TD CLASS="l">2706</TD><TD>        return newMSGCross;</TD></TR><TR><TD CLASS="l"><A NAME="1a">2707</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2708</TD><TD> </TD></TR><TR><TD CLASS="l">2709</TD><TD>    public OrderStruct buildOrderStructForSatisfaction(Order satisfactionOrder,</TD></TR><TR><TD CLASS="l">2710</TD><TD>            String marketMaker, int quantity) throws DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">2711</TD><TD>        return buildMSGOrderStruct(satisfactionOrder, marketMaker, quantity,</TD></TR><TR CLASS="z"><TD CLASS="l">2712</TD><TD>                true);</TD></TR><TR><TD CLASS="l">2713</TD><TD>    }</TD></TR><TR><TD CLASS="l">2714</TD><TD> </TD></TR><TR><TD CLASS="l">2715</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2716</TD><TD>     * build a new order struct for the min size guarantee order</TD></TR><TR><TD CLASS="l"><A NAME="13">2717</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">2718</TD><TD>    private OrderStruct buildMSGOrderStruct(Order nbboProtectedOrder,</TD></TR><TR><TD CLASS="l">2719</TD><TD>            String nbboAgentId, int quantity, boolean forSatisfactionOrder)</TD></TR><TR><TD CLASS="l">2720</TD><TD>            throws DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">2721</TD><TD>        return buildMSGOrderStruct(nbboProtectedOrder, nbboAgentId, null,</TD></TR><TR CLASS="z"><TD CLASS="l">2722</TD><TD>                quantity, nbboProtectedOrder.getPrice().toStruct(),</TD></TR><TR CLASS="z"><TD CLASS="l">2723</TD><TD>                forSatisfactionOrder);</TD></TR><TR><TD CLASS="l">2724</TD><TD>    }</TD></TR><TR><TD CLASS="l">2725</TD><TD> </TD></TR><TR><TD CLASS="l">2726</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2727</TD><TD>     * build a new order struct for the min size guarantee order</TD></TR><TR><TD CLASS="l">2728</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="12">2729</A></TD><TD>    private OrderStruct buildMSGOrderStruct(Order nbboProtectedOrder,</TD></TR><TR><TD CLASS="l">2730</TD><TD>            String nbboAgentId, String defaultClearingFirmNumber, int quantity,</TD></TR><TR><TD CLASS="l">2731</TD><TD>            PriceStruct price, boolean forSatisfactionOrder)</TD></TR><TR><TD CLASS="l">2732</TD><TD>            throws DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">2733</TD><TD>        OrderStruct msgOrder = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2734</TD><TD>        msgOrder = OrderStructBuilder.buildOrderStruct();</TD></TR><TR><TD CLASS="l">2735</TD><TD> </TD></TR><TR><TD CLASS="l">2736</TD><TD>        try {</TD></TR><TR><TD CLASS="l">2737</TD><TD>            String subAccount;</TD></TR><TR><TD CLASS="l">2738</TD><TD>            String account;</TD></TR><TR><TD CLASS="l">2739</TD><TD>            ExchangeFirmStruct clearingFirm;</TD></TR><TR><TD CLASS="l">2740</TD><TD>            SessionProfileUserStruct nbboAgent;</TD></TR><TR><TD CLASS="l">2741</TD><TD>            SessionProfileStruct profile;</TD></TR><TR CLASS="z"><TD CLASS="l">2742</TD><TD>            nbboAgent = getUserService().getSessionProfileUserInformation(</TD></TR><TR CLASS="z"><TD CLASS="l">2743</TD><TD>                    nbboAgentId);</TD></TR><TR CLASS="z"><TD CLASS="l">2744</TD><TD>            profile = getProfile(nbboAgent, nbboProtectedOrder.getClassKey(),</TD></TR><TR CLASS="z"><TD CLASS="l">2745</TD><TD>                    nbboProtectedOrder.getActiveSession());</TD></TR><TR CLASS="z"><TD CLASS="l">2746</TD><TD>            if (profile != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2747</TD><TD>                account = profile.account;</TD></TR><TR CLASS="z"><TD CLASS="l">2748</TD><TD>                subAccount = profile.subAccount;</TD></TR><TR CLASS="z"><TD CLASS="l">2749</TD><TD>                clearingFirm = profile.executingGiveupFirm;</TD></TR><TR><TD CLASS="l">2750</TD><TD>            } else { // this should not happen, because user will always has a default profile</TD></TR><TR CLASS="z"><TD CLASS="l">2751</TD><TD>                account = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2752</TD><TD>                subAccount = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2753</TD><TD>                clearingFirm = nbboAgent.firm;</TD></TR><TR><TD CLASS="l">2754</TD><TD>            }</TD></TR><TR><TD CLASS="l">2755</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2756</TD><TD>            if (defaultClearingFirmNumber != null) {</TD></TR><TR><TD CLASS="l">2757</TD><TD>//            have to create new object so will not accidentally updated the profile due to refer to same object</TD></TR><TR CLASS="z"><TD CLASS="l">2758</TD><TD>                clearingFirm = new ExchangeFirmStruct(clearingFirm.exchange, defaultClearingFirmNumber);</TD></TR><TR><TD CLASS="l">2759</TD><TD> </TD></TR><TR><TD CLASS="l">2760</TD><TD>            }</TD></TR><TR><TD CLASS="l">2761</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2762</TD><TD>            OrderIdStruct msgOrderId = OrderStructBuilder.buildOrderIdStruct();</TD></TR><TR><TD CLASS="l">2763</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2764</TD><TD>            if (forSatisfactionOrder) {</TD></TR><TR CLASS="z"><TD CLASS="l">2765</TD><TD>                msgOrderId.branch = getSatisfySatisfactionOrderBranch();</TD></TR><TR CLASS="z"><TD CLASS="l">2766</TD><TD>                msgOrderId.branchSequenceNumber = getNextSeqNumForSatisfySatisfactionOrder();</TD></TR><TR CLASS="z"><TD CLASS="l">2767</TD><TD>                msgOrder.orderOriginType = InternalOrderOriginTypes.SATISFACTION_ORDER_SATISFY;</TD></TR><TR><TD CLASS="l">2768</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2769</TD><TD>                msgOrderId.branch = getNBBOMSGOrderBranch();</TD></TR><TR CLASS="z"><TD CLASS="l">2770</TD><TD>                msgOrderId.branchSequenceNumber = getNextSeqNumForNBBOMSGOrder();</TD></TR><TR CLASS="z"><TD CLASS="l">2771</TD><TD>                msgOrder.orderOriginType = InternalOrderOriginTypes.NBBO_MIN_SIZE_GUARANTEE;</TD></TR><TR><TD CLASS="l">2772</TD><TD>            }</TD></TR><TR><TD CLASS="l">2773</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2774</TD><TD>            msgOrderId.executingOrGiveUpFirm = clearingFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">2775</TD><TD>            msgOrderId.highCboeId = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">2776</TD><TD>            msgOrderId.lowCboeId = 0;</TD></TR><TR><TD CLASS="l">2777</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2778</TD><TD>            msgOrder.account = account;</TD></TR><TR CLASS="z"><TD CLASS="l">2779</TD><TD>            msgOrder.activeSession = nbboProtectedOrder.getActiveSession();</TD></TR><TR CLASS="z"><TD CLASS="l">2780</TD><TD>            msgOrder.classKey = nbboProtectedOrder.getClassKey();</TD></TR><TR CLASS="z"><TD CLASS="l">2781</TD><TD>            msgOrder.orderId = msgOrderId;</TD></TR><TR><TD CLASS="l">2782</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2783</TD><TD>            msgOrder.originalQuantity = quantity;</TD></TR><TR CLASS="z"><TD CLASS="l">2784</TD><TD>            msgOrder.price = price;</TD></TR><TR CLASS="z"><TD CLASS="l">2785</TD><TD>            msgOrder.productKey = nbboProtectedOrder.getProductKey().intValue();</TD></TR><TR CLASS="z"><TD CLASS="l">2786</TD><TD>            msgOrder.sessionNames = new String[1];</TD></TR><TR CLASS="z"><TD CLASS="l">2787</TD><TD>            msgOrder.sessionNames[0] = msgOrder.activeSession;</TD></TR><TR CLASS="z"><TD CLASS="l">2788</TD><TD>            msgOrder.side = nbboProtectedOrder.getSide().getOtherSide()</TD></TR><TR CLASS="z"><TD CLASS="l">2789</TD><TD>                    .toSideValue();</TD></TR><TR CLASS="z"><TD CLASS="l">2790</TD><TD>            msgOrder.subaccount = subAccount;</TD></TR><TR CLASS="z"><TD CLASS="l">2791</TD><TD>            msgOrder.userAcronym = nbboAgent.userAcronym;</TD></TR><TR CLASS="z"><TD CLASS="l">2792</TD><TD>            msgOrder.userId = nbboAgent.userId;</TD></TR><TR CLASS="z"><TD CLASS="l">2793</TD><TD>        } catch (NotFoundException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2794</TD><TD>            Log.alarm(&#34;Invalid NBBO Agent &#34; + nbboAgentId);</TD></TR><TR CLASS="z"><TD CLASS="l">2795</TD><TD>            ExceptionBuilder.dataValidationException(&#34;Invalid NBBO Agent &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2796</TD><TD>                    + nbboAgentId, 1);</TD></TR><TR CLASS="z"><TD CLASS="l">2797</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2798</TD><TD>            Log.exception(&#34;Can not access nbboAgent &#34; + nbboAgentId</TD></TR><TR CLASS="z"><TD CLASS="l">2799</TD><TD>                    + &#34; information&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">2800</TD><TD>            throw ExceptionBuilder.dataValidationException(</TD></TR><TR CLASS="z"><TD CLASS="l">2801</TD><TD>                    &#34;Could not buildMSGOrderStruct for agent :&#34; + nbboAgentId,</TD></TR><TR CLASS="z"><TD CLASS="l">2802</TD><TD>                    0);</TD></TR><TR><TD CLASS="l">2803</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2804</TD><TD>        return msgOrder;</TD></TR><TR><TD CLASS="l">2805</TD><TD> </TD></TR><TR><TD CLASS="l">2806</TD><TD>    }</TD></TR><TR><TD CLASS="l">2807</TD><TD> </TD></TR><TR><TD CLASS="l">2808</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2809</TD><TD>     * get the profile for user and class</TD></TR><TR><TD CLASS="l"><A NAME="7d">2810</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">2811</TD><TD>    private SessionProfileStruct getProfile(</TD></TR><TR><TD CLASS="l">2812</TD><TD>            SessionProfileUserStruct userStruct, int classKey,</TD></TR><TR><TD CLASS="l">2813</TD><TD>            String sessionName) {</TD></TR><TR CLASS="z"><TD CLASS="l">2814</TD><TD>        SessionProfileStruct retValue = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2815</TD><TD>        if (userStruct != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2816</TD><TD>            retValue = userStruct.defaultProfile;</TD></TR><TR><TD CLASS="l">2817</TD><TD> </TD></TR><TR><TD CLASS="l">2818</TD><TD>            // overridden by session default profile if any</TD></TR><TR CLASS="z"><TD CLASS="l">2819</TD><TD>            for (int i = 0; i &lt; userStruct.defaultSessionProfiles.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2820</TD><TD>                if (userStruct.defaultSessionProfiles[i].sessionName</TD></TR><TR CLASS="z"><TD CLASS="l">2821</TD><TD>                        .equals(sessionName)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2822</TD><TD>                    retValue = userStruct.defaultSessionProfiles[i];</TD></TR><TR CLASS="z"><TD CLASS="l">2823</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">2824</TD><TD>                }</TD></TR><TR><TD CLASS="l">2825</TD><TD>            }</TD></TR><TR><TD CLASS="l">2826</TD><TD>            // overridden by class specified profile if any.</TD></TR><TR CLASS="z"><TD CLASS="l">2827</TD><TD>            for (int i = 0; i &lt; userStruct.sessionProfilesByClass.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2828</TD><TD>                if (userStruct.sessionProfilesByClass[i].classKey == classKey) {</TD></TR><TR CLASS="z"><TD CLASS="l">2829</TD><TD>                    if (userStruct.sessionProfilesByClass[i].sessionName</TD></TR><TR CLASS="z"><TD CLASS="l">2830</TD><TD>                            .equals(SessionNameValues.ALL_SESSION_NAME)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2831</TD><TD>                        retValue = userStruct.sessionProfilesByClass[i];</TD></TR><TR><TD CLASS="l">2832</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2833</TD><TD>                    // overtidden by the value defined for the specified class and session</TD></TR><TR CLASS="z"><TD CLASS="l">2834</TD><TD>                    if (userStruct.sessionProfilesByClass[i].sessionName</TD></TR><TR CLASS="z"><TD CLASS="l">2835</TD><TD>                            .equals(sessionName)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2836</TD><TD>                        retValue = userStruct.sessionProfilesByClass[i];</TD></TR><TR CLASS="z"><TD CLASS="l">2837</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">2838</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2839</TD><TD>                }</TD></TR><TR><TD CLASS="l">2840</TD><TD>            }</TD></TR><TR><TD CLASS="l">2841</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2842</TD><TD>        return retValue;</TD></TR><TR><TD CLASS="l">2843</TD><TD>    }</TD></TR><TR><TD CLASS="l">2844</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="65">2845</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">2846</TD><TD>     * get the NBBO min size guarantee order branch</TD></TR><TR><TD CLASS="l">2847</TD><TD>     */</TD></TR><TR><TD CLASS="l">2848</TD><TD>    private String getNBBOMSGOrderBranch() {</TD></TR><TR CLASS="z"><TD CLASS="l">2849</TD><TD>        return nbboMinSizeGuaranteeOrderBranch;</TD></TR><TR><TD CLASS="l">2850</TD><TD>    }</TD></TR><TR><TD CLASS="l">2851</TD><TD> </TD></TR><TR><TD CLASS="l">2852</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2853</TD><TD>     * Get the order branch to satisfy satisfaction order.</TD></TR><TR><TD CLASS="l"><A NAME="81">2854</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">2855</TD><TD>     * @return</TD></TR><TR><TD CLASS="l">2856</TD><TD>     */</TD></TR><TR><TD CLASS="l">2857</TD><TD>    private String getSatisfySatisfactionOrderBranch() {</TD></TR><TR CLASS="z"><TD CLASS="l">2858</TD><TD>        return satisfySatisfactionOrderBranch;</TD></TR><TR><TD CLASS="l">2859</TD><TD>    }</TD></TR><TR><TD CLASS="l">2860</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="66">2861</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">2862</TD><TD>     * get the NBBO min size guarantee order branch sequence number</TD></TR><TR><TD CLASS="l">2863</TD><TD>     */</TD></TR><TR><TD CLASS="l">2864</TD><TD>    private synchronized int getNextSeqNumForNBBOMSGOrder() {</TD></TR><TR CLASS="z"><TD CLASS="l">2865</TD><TD>        nbboMinSizeGuaranteeOrderSeqNum = nbboMinSizeGuaranteeOrderSeqNum + 1;</TD></TR><TR CLASS="z"><TD CLASS="l">2866</TD><TD>        return nbboMinSizeGuaranteeOrderSeqNum;</TD></TR><TR><TD CLASS="l">2867</TD><TD>    }</TD></TR><TR><TD CLASS="l">2868</TD><TD> </TD></TR><TR><TD CLASS="l">2869</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2870</TD><TD>     * Get next seq num to satisfy satisfaction order.</TD></TR><TR><TD CLASS="l"><A NAME="67">2871</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">2872</TD><TD>     * @return</TD></TR><TR><TD CLASS="l">2873</TD><TD>     */</TD></TR><TR><TD CLASS="l">2874</TD><TD>    private int getNextSeqNumForSatisfySatisfactionOrder() {</TD></TR><TR CLASS="z"><TD CLASS="l">2875</TD><TD>        if (getSatisfySatisfactionOrderBranch().equals(getNBBOMSGOrderBranch())) {</TD></TR><TR CLASS="z"><TD CLASS="l">2876</TD><TD>            return getNextSeqNumForNBBOMSGOrder();</TD></TR><TR><TD CLASS="l">2877</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2878</TD><TD>            synchronized (this) {</TD></TR><TR CLASS="z"><TD CLASS="l">2879</TD><TD>                satisfySatisfactionOrderSeqNum += 1;</TD></TR><TR><TD CLASS="l">2880</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2881</TD><TD>            return satisfySatisfactionOrderSeqNum;</TD></TR><TR><TD CLASS="l">2882</TD><TD>        }</TD></TR><TR><TD CLASS="l">2883</TD><TD>    }</TD></TR><TR><TD CLASS="l">2884</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="9c">2885</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">2886</TD><TD>     * initialize the nbboMinSizeGuaranteeOrderSeqNum to the milliseconds from the the midnight</TD></TR><TR><TD CLASS="l">2887</TD><TD>     */</TD></TR><TR><TD CLASS="l">2888</TD><TD>    private void initializeNBBOMinSizeGuaranteeOrderSeqNum() {</TD></TR><TR CLASS="z"><TD CLASS="l">2889</TD><TD>        Calendar cal = Calendar.getInstance();</TD></TR><TR CLASS="z"><TD CLASS="l">2890</TD><TD>        int hour = cal.get(Calendar.HOUR_OF_DAY);</TD></TR><TR CLASS="z"><TD CLASS="l">2891</TD><TD>        int minute = cal.get(Calendar.MINUTE);</TD></TR><TR CLASS="z"><TD CLASS="l">2892</TD><TD>        int second = cal.get(Calendar.SECOND);</TD></TR><TR CLASS="z"><TD CLASS="l">2893</TD><TD>        int millis = cal.get(Calendar.MILLISECOND);</TD></TR><TR CLASS="z"><TD CLASS="l">2894</TD><TD>        nbboMinSizeGuaranteeOrderSeqNum = ((hour + serverInstanceNumber) * 3600000) + minute * 60000</TD></TR><TR CLASS="z"><TD CLASS="l">2895</TD><TD>                + second * 1000 + millis;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="a1">2896</A></TD><TD>        Log.information(&#34;OrderHomeImpl: nbboMinSizeGuaranteeOrderSeqNum initialized to &#34; + nbboMinSizeGuaranteeOrderSeqNum);</TD></TR><TR CLASS="z"><TD CLASS="l">2897</TD><TD>    }</TD></TR><TR><TD CLASS="l">2898</TD><TD> </TD></TR><TR><TD CLASS="l">2899</TD><TD>    private void initializeSatisfySatisfactionOrderSeqNum() {</TD></TR><TR CLASS="z"><TD CLASS="l">2900</TD><TD>        if (getSatisfySatisfactionOrderBranch().equals(getNBBOMSGOrderBranch())) {</TD></TR><TR CLASS="z"><TD CLASS="l">2901</TD><TD>            return; // coz MSGOrderSeqNum should be used instead of SSO seq num.</TD></TR><TR><TD CLASS="l">2902</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2903</TD><TD>            Calendar cal = Calendar.getInstance();</TD></TR><TR CLASS="z"><TD CLASS="l">2904</TD><TD>            int hour = cal.get(Calendar.HOUR_OF_DAY);</TD></TR><TR CLASS="z"><TD CLASS="l">2905</TD><TD>            int minute = cal.get(Calendar.MINUTE);</TD></TR><TR CLASS="z"><TD CLASS="l">2906</TD><TD>            int second = cal.get(Calendar.SECOND);</TD></TR><TR CLASS="z"><TD CLASS="l">2907</TD><TD>            int millis = cal.get(Calendar.MILLISECOND);</TD></TR><TR CLASS="z"><TD CLASS="l">2908</TD><TD>            satisfySatisfactionOrderSeqNum = ((hour + serverInstanceNumber) * 3600000) + minute * 60000</TD></TR><TR CLASS="z"><TD CLASS="l">2909</TD><TD>                    + second * 1000 + millis;</TD></TR><TR CLASS="z"><TD CLASS="l">2910</TD><TD>            Log.information(&#34;OrderHomeImpl: satisfySatisfactionOrderSeqNum initialized to &#34; + satisfySatisfactionOrderSeqNum);</TD></TR><TR><TD CLASS="l">2911</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2912</TD><TD>    }</TD></TR><TR><TD CLASS="l">2913</TD><TD> </TD></TR><TR><TD CLASS="l">2914</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2915</TD><TD>     * publish the filled report to intermarket order status channel</TD></TR><TR><TD CLASS="l">2916</TD><TD>     */</TD></TR><TR><TD CLASS="l">2917</TD><TD>    protected void publishIntermarketFilledReports(Order anOrder,</TD></TR><TR><TD CLASS="l">2918</TD><TD>            FilledReportStruct[] reports) {</TD></TR><TR><TD CLASS="l"><A NAME="b6">2919</A></TD><TD>        try {</TD></TR><TR><TD CLASS="l">2920</TD><TD>            ExchangeMarketStruct[] mktInfo;</TD></TR><TR><TD CLASS="l">2921</TD><TD>            // If order is a satisfaction order, or it is marked for drop copy(i.e. order is</TD></TR><TR><TD CLASS="l">2922</TD><TD>            // involved in trade through), we don't need to record the market</TD></TR><TR CLASS="z"><TD CLASS="l">2923</TD><TD>            if (anOrder.getOrderOriginType() == OrderOrigins.SATISFACTION</TD></TR><TR CLASS="z"><TD CLASS="l">2924</TD><TD>                    || (anOrder.isMarkedForDropCopy())) {</TD></TR><TR CLASS="z"><TD CLASS="l">2925</TD><TD>                mktInfo = new ExchangeMarketStruct[0];</TD></TR><TR><TD CLASS="l">2926</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2927</TD><TD>                mktInfo = getOrderMarketMonitoringService()</TD></TR><TR CLASS="z"><TD CLASS="l">2928</TD><TD>                        .recordOrderExecution(anOrder,</TD></TR><TR CLASS="z"><TD CLASS="l">2929</TD><TD>                                CboeId.longValue(reports[0].tradeId), reports);</TD></TR><TR><TD CLASS="l">2930</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2931</TD><TD>            HeldOrderStruct heldOrder = new HeldOrderStruct(</TD></TR><TR CLASS="z"><TD CLASS="l">2932</TD><TD>                    getTrimmedOrder(anOrder), mktInfo);</TD></TR><TR CLASS="z"><TD CLASS="l">2933</TD><TD>            int[] groups = ConfigurationGroupHelper</TD></TR><TR CLASS="z"><TD CLASS="l">2934</TD><TD>                    .getPublishingGroupsForProcess();</TD></TR><TR CLASS="z"><TD CLASS="l">2935</TD><TD>            getIntermarketOrderStatusPublisher().acceptHeldOrderFilledReport(</TD></TR><TR CLASS="z"><TD CLASS="l">2936</TD><TD>                    groups, heldOrder, getTrimmedFilledReports(reports));</TD></TR><TR CLASS="z"><TD CLASS="l">2937</TD><TD>        } catch (Exception e) {</TD></TR><TR><TD CLASS="l">2938</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">2939</TD><TD>                    .exception(</TD></TR><TR CLASS="z"><TD CLASS="l">2940</TD><TD>                            &#34;OrderHome &gt;&gt;&gt; Error on publishing order filled report on intermarket order status&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">2941</TD><TD>                            e);</TD></TR><TR><TD CLASS="l">2942</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2943</TD><TD>    }</TD></TR><TR><TD CLASS="l">2944</TD><TD> </TD></TR><TR><TD CLASS="l">2945</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2946</TD><TD>     * publish the cancel report to intermarket order status channel</TD></TR><TR><TD CLASS="l">2947</TD><TD>     */</TD></TR><TR><TD CLASS="l">2948</TD><TD>    protected void publishIntermarketCancelReports(Order anOrder,</TD></TR><TR><TD CLASS="l">2949</TD><TD>            CancelReportStruct[] reports, long cancelRequestId) {</TD></TR><TR><TD CLASS="l"><A NAME="b5">2950</A></TD><TD>        try {</TD></TR><TR><TD CLASS="l">2951</TD><TD>            ExchangeMarketStruct[] mktInfo;</TD></TR><TR><TD CLASS="l">2952</TD><TD>            // If order is a satisfaction order, or it is marked for drop copy(i.e. order is</TD></TR><TR><TD CLASS="l">2953</TD><TD>            // involved in trade through), we don't need to record the market</TD></TR><TR CLASS="z"><TD CLASS="l">2954</TD><TD>            if (anOrder.getOrderOriginType() == OrderOrigins.SATISFACTION</TD></TR><TR CLASS="z"><TD CLASS="l">2955</TD><TD>                    || (anOrder.isMarkedForDropCopy())) {</TD></TR><TR CLASS="z"><TD CLASS="l">2956</TD><TD>                mktInfo = new ExchangeMarketStruct[0];</TD></TR><TR><TD CLASS="l">2957</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">2958</TD><TD>                mktInfo = getOrderMarketMonitoringService()</TD></TR><TR CLASS="z"><TD CLASS="l">2959</TD><TD>                        .getExchangeMarketsForOrderAtReceipt(anOrder);</TD></TR><TR><TD CLASS="l">2960</TD><TD>            }</TD></TR><TR><TD CLASS="l">2961</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2962</TD><TD>            HeldOrderStruct heldOrder = new HeldOrderStruct(</TD></TR><TR CLASS="z"><TD CLASS="l">2963</TD><TD>                    getTrimmedOrder(anOrder), mktInfo);</TD></TR><TR CLASS="z"><TD CLASS="l">2964</TD><TD>            int[] groups = ConfigurationGroupHelper</TD></TR><TR CLASS="z"><TD CLASS="l">2965</TD><TD>                    .getPublishingGroupsForProcess();</TD></TR><TR CLASS="z"><TD CLASS="l">2966</TD><TD>            CboeIdStruct cancelReqId = CboeId.toStruct(cancelRequestId);</TD></TR><TR CLASS="z"><TD CLASS="l">2967</TD><TD>            for (int i = 0; i &lt; reports.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">2968</TD><TD>                getIntermarketOrderStatusPublisher()</TD></TR><TR CLASS="z"><TD CLASS="l">2969</TD><TD>                        .acceptHeldOrderCancelReport(groups, heldOrder,</TD></TR><TR CLASS="z"><TD CLASS="l">2970</TD><TD>                                cancelReqId, reports[i]);</TD></TR><TR><TD CLASS="l">2971</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2972</TD><TD>        } catch (Exception e) {</TD></TR><TR><TD CLASS="l">2973</TD><TD>            Log</TD></TR><TR CLASS="z"><TD CLASS="l">2974</TD><TD>                    .exception(</TD></TR><TR CLASS="z"><TD CLASS="l">2975</TD><TD>                            &#34;OrderHomeImpl &gt;&gt;&gt; could not publish the cancel report to intermarket order status channel&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">2976</TD><TD>                            e);</TD></TR><TR><TD CLASS="l">2977</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2978</TD><TD>    }</TD></TR><TR><TD CLASS="l">2979</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="8d">2980</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">2981</TD><TD>     * filter out the user information before publishing to intermarket order status channle</TD></TR><TR><TD CLASS="l">2982</TD><TD>     */</TD></TR><TR><TD CLASS="l">2983</TD><TD>    private OrderStruct getTrimmedOrder(Order anOrder) {</TD></TR><TR CLASS="z"><TD CLASS="l">2984</TD><TD>        OrderStruct trimmedOrder = anOrder.getOrderStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2985</TD><TD>        trimmedOrder.originator = new ExchangeAcronymStruct(&#34;&#34;, &#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2986</TD><TD>        trimmedOrder.account = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2987</TD><TD>        trimmedOrder.subaccount = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2988</TD><TD>        trimmedOrder.userId = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2989</TD><TD>        trimmedOrder.userAcronym = new ExchangeAcronymStruct(&#34;&#34;, &#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2990</TD><TD>        trimmedOrder.cmta = new ExchangeFirmStruct(&#34;&#34;, &#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2991</TD><TD>        return trimmedOrder;</TD></TR><TR><TD CLASS="l">2992</TD><TD>    }</TD></TR><TR><TD CLASS="l">2993</TD><TD> </TD></TR><TR><TD CLASS="l">2994</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="8c">2995</A></TD><TD>     * filter out the user information from the filled reports</TD></TR><TR><TD CLASS="l">2996</TD><TD>     */</TD></TR><TR><TD CLASS="l">2997</TD><TD>    private FilledReportStruct[] getTrimmedFilledReports(</TD></TR><TR><TD CLASS="l">2998</TD><TD>            FilledReportStruct[] filledReports) {</TD></TR><TR CLASS="z"><TD CLASS="l">2999</TD><TD>        FilledReportStruct[] trimmedReports = new FilledReportStruct[filledReports.length];</TD></TR><TR CLASS="z"><TD CLASS="l">3000</TD><TD>        for (int i = 0; i &lt; filledReports.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">3001</TD><TD>            trimmedReports[i] = new FilledReportStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">3002</TD><TD>            trimmedReports[i].tradeId = filledReports[i].tradeId;</TD></TR><TR CLASS="z"><TD CLASS="l">3003</TD><TD>            trimmedReports[i].fillReportType = filledReports[i].fillReportType;</TD></TR><TR CLASS="z"><TD CLASS="l">3004</TD><TD>            trimmedReports[i].executingOrGiveUpFirm = filledReports[i].executingOrGiveUpFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">3005</TD><TD>            trimmedReports[i].productKey = filledReports[i].productKey;</TD></TR><TR CLASS="z"><TD CLASS="l">3006</TD><TD>            trimmedReports[i].sessionName = filledReports[i].sessionName;</TD></TR><TR CLASS="z"><TD CLASS="l">3007</TD><TD>            trimmedReports[i].tradedQuantity = filledReports[i].tradedQuantity;</TD></TR><TR CLASS="z"><TD CLASS="l">3008</TD><TD>            trimmedReports[i].leavesQuantity = filledReports[i].leavesQuantity;</TD></TR><TR CLASS="z"><TD CLASS="l">3009</TD><TD>            trimmedReports[i].price = filledReports[i].price;</TD></TR><TR CLASS="z"><TD CLASS="l">3010</TD><TD>            trimmedReports[i].side = filledReports[i].side;</TD></TR><TR CLASS="z"><TD CLASS="l">3011</TD><TD>            trimmedReports[i].orsId = filledReports[i].orsId;</TD></TR><TR CLASS="z"><TD CLASS="l">3012</TD><TD>            trimmedReports[i].executingBroker = filledReports[i].executingBroker;</TD></TR><TR CLASS="z"><TD CLASS="l">3013</TD><TD>            trimmedReports[i].cmta = filledReports[i].cmta;</TD></TR><TR CLASS="z"><TD CLASS="l">3014</TD><TD>            trimmedReports[i].optionalData = filledReports[i].optionalData;</TD></TR><TR CLASS="z"><TD CLASS="l">3015</TD><TD>            trimmedReports[i].userAssignedId = filledReports[i].userAssignedId;</TD></TR><TR CLASS="z"><TD CLASS="l">3016</TD><TD>            trimmedReports[i].extensions = filledReports[i].extensions;</TD></TR><TR CLASS="z"><TD CLASS="l">3017</TD><TD>            trimmedReports[i].contraParties = filledReports[i].contraParties;</TD></TR><TR CLASS="z"><TD CLASS="l">3018</TD><TD>            trimmedReports[i].timeSent = filledReports[i].timeSent;</TD></TR><TR CLASS="z"><TD CLASS="l">3019</TD><TD>            trimmedReports[i].positionEffect = filledReports[i].positionEffect;</TD></TR><TR CLASS="z"><TD CLASS="l">3020</TD><TD>            trimmedReports[i].transactionSequenceNumber = filledReports[i].transactionSequenceNumber;</TD></TR><TR><TD CLASS="l">3021</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3022</TD><TD>            trimmedReports[i].originator = new ExchangeAcronymStruct(&#34;&#34;, &#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3023</TD><TD>            trimmedReports[i].account = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">3024</TD><TD>            trimmedReports[i].subaccount = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">3025</TD><TD>            trimmedReports[i].userId = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">3026</TD><TD>            trimmedReports[i].userAcronym = new ExchangeAcronymStruct(&#34;&#34;, &#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3027</TD><TD>            trimmedReports[i].cmta = new ExchangeFirmStruct(&#34;&#34;, &#34;&#34;);</TD></TR><TR><TD CLASS="l">3028</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3029</TD><TD>        return trimmedReports;</TD></TR><TR><TD CLASS="l">3030</TD><TD>    }</TD></TR><TR><TD CLASS="l">3031</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="72">3032</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">3033</TD><TD>     * Find the OrderMarketMonitoringService</TD></TR><TR><TD CLASS="l">3034</TD><TD>     */</TD></TR><TR><TD CLASS="l">3035</TD><TD>    protected OrderMarketMonitoringService getOrderMarketMonitoringService() {</TD></TR><TR CLASS="z"><TD CLASS="l">3036</TD><TD>        if (omms == null) {</TD></TR><TR><TD CLASS="l">3037</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">3038</TD><TD>                OrderMarketMonitoringServiceHome ommsHome = (OrderMarketMonitoringServiceHome) HomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">3039</TD><TD>                        .getInstance().findHome(</TD></TR><TR CLASS="z"><TD CLASS="l">3040</TD><TD>                                OrderMarketMonitoringServiceHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">3041</TD><TD>                omms = ommsHome.find();</TD></TR><TR CLASS="z"><TD CLASS="l">3042</TD><TD>            } catch (Exception e) {</TD></TR><TR><TD CLASS="l">3043</TD><TD>                Log</TD></TR><TR CLASS="z"><TD CLASS="l">3044</TD><TD>                        .exception(</TD></TR><TR CLASS="z"><TD CLASS="l">3045</TD><TD>                                &#34;OrderMarketMonitoringService can be not find&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">3046</TD><TD>                                e);</TD></TR><TR><TD CLASS="l">3047</TD><TD>            }</TD></TR><TR><TD CLASS="l">3048</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3049</TD><TD>        return omms;</TD></TR><TR><TD CLASS="l">3050</TD><TD>    }</TD></TR><TR><TD CLASS="l">3051</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="7a">3052</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">3053</TD><TD>     * combined a string array to a string for printing</TD></TR><TR><TD CLASS="l">3054</TD><TD>     */</TD></TR><TR><TD CLASS="l">3055</TD><TD>    private String getPrintingString(String heading, String[] anArray) {</TD></TR><TR CLASS="z"><TD CLASS="l">3056</TD><TD>        String result = heading;</TD></TR><TR CLASS="z"><TD CLASS="l">3057</TD><TD>        for (int i = 0; i &lt; anArray.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">3058</TD><TD>            result = result + &#34;:&#34; + anArray[i];</TD></TR><TR><TD CLASS="l">3059</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="c9">3060</A></TD><TD>        return result;</TD></TR><TR><TD CLASS="l">3061</TD><TD>    }</TD></TR><TR><TD CLASS="l">3062</TD><TD> </TD></TR><TR><TD CLASS="l">3063</TD><TD>    public boolean shouldQOrdersBeCanceledOnHaltCloseLogout() {</TD></TR><TR CLASS="z"><TD CLASS="l">3064</TD><TD>        return this.cancelQOrdersOnCloseHaltLogOut;</TD></TR><TR><TD CLASS="l"><A NAME="36">3065</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3066</TD><TD> </TD></TR><TR><TD CLASS="l">3067</TD><TD>    public Order[] findActiveMarketOrders() {</TD></TR><TR><TD CLASS="l">3068</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3069</TD><TD>        Iterator ordersEnum = orderCache.values().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">3070</TD><TD>        ArrayList activeMOrders = new ArrayList();</TD></TR><TR><TD CLASS="l">3071</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3072</TD><TD>        while (ordersEnum.hasNext()) {</TD></TR><TR CLASS="z"><TD CLASS="l">3073</TD><TD>            OrderImpl order = (OrderImpl) ordersEnum.next();</TD></TR><TR CLASS="z"><TD CLASS="l">3074</TD><TD>            if (order.isActive() &amp;&amp; order.getPrice().isMarketPrice()</TD></TR><TR CLASS="z"><TD CLASS="l">3075</TD><TD>                    &amp;&amp; order.getRemainingQuantity() &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">3076</TD><TD>                activeMOrders.add(order);</TD></TR><TR><TD CLASS="l">3077</TD><TD>            }</TD></TR><TR><TD CLASS="l">3078</TD><TD>        }</TD></TR><TR><TD CLASS="l">3079</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="44">3080</A></TD><TD>        return new Order[activeMOrders.size()];</TD></TR><TR><TD CLASS="l">3081</TD><TD>    }</TD></TR><TR><TD CLASS="l">3082</TD><TD> </TD></TR><TR><TD CLASS="l">3083</TD><TD>    public Order[] findPendingStopOrders() {</TD></TR><TR CLASS="z"><TD CLASS="l">3084</TD><TD>        short[] contingencyArray = new short[3];</TD></TR><TR CLASS="z"><TD CLASS="l">3085</TD><TD>        contingencyArray[0] = ContingencyTypes.STP;</TD></TR><TR CLASS="z"><TD CLASS="l">3086</TD><TD>        contingencyArray[1] = ContingencyTypes.STP_LOSS;</TD></TR><TR CLASS="z"><TD CLASS="l">3087</TD><TD>        contingencyArray[2] = ContingencyTypes.STP_LIMIT;</TD></TR><TR CLASS="z"><TD CLASS="l">3088</TD><TD>        return findPendingOrders(contingencyArray, false);</TD></TR><TR><TD CLASS="l">3089</TD><TD>    }</TD></TR><TR><TD CLASS="l">3090</TD><TD> </TD></TR><TR><TD CLASS="l">3091</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="41">3092</A></TD><TD>    public Order[] findOrdersForProduct(int productKey, boolean sorted, ArrayList nbboBuyFlashedOrders, ArrayList nbboSellFlashedOrders)</TD></TR><TR><TD CLASS="l">3093</TD><TD>    {</TD></TR><TR><TD CLASS="l">3094</TD><TD>        // The result is obtained from cache which is in sorted by time.</TD></TR><TR><TD CLASS="l">3095</TD><TD>        // So results are always returned sorted.</TD></TR><TR CLASS="z"><TD CLASS="l">3096</TD><TD>        ArrayList&lt;Order&gt; orders = new ArrayList&lt;Order&gt;();</TD></TR><TR><TD CLASS="l">3097</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">3098</TD><TD>        for (int i = 0; i &lt; getConfiguredSessions().length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">3099</TD><TD>            ConcurrentIntHashMap&lt;Map&lt;Long, Order&gt;&gt; productKeyOrderCache = productKeyOrderCacheForSessions</TD></TR><TR CLASS="z"><TD CLASS="l">3100</TD><TD>                    .get(configuredSessions[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">3101</TD><TD>            if (productKeyOrderCache != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3102</TD><TD>                Map&lt;Long, Order&gt; ordersByProduct = productKeyOrderCache.get(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3103</TD><TD>                if (ordersByProduct != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3104</TD><TD>                    orders.addAll(ordersByProduct.values());</TD></TR><TR><TD CLASS="l">3105</TD><TD>                }</TD></TR><TR><TD CLASS="l">3106</TD><TD>            }</TD></TR><TR><TD CLASS="l">3107</TD><TD>        }</TD></TR><TR><TD CLASS="l">3108</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3109</TD><TD>        if(nbboBuyFlashedOrders != null &amp;&amp; nbboBuyFlashedOrders.size() &gt; 0)</TD></TR><TR><TD CLASS="l">3110</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3111</TD><TD>            for(int j = 0; j &lt; nbboBuyFlashedOrders.size(); j++)</TD></TR><TR><TD CLASS="l">3112</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3113</TD><TD>                Order currentOrder = (Order) nbboBuyFlashedOrders.get(j);</TD></TR><TR CLASS="z"><TD CLASS="l">3114</TD><TD>                int index = orders.indexOf(currentOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">3115</TD><TD>                if(index &gt;= 0)</TD></TR><TR><TD CLASS="l">3116</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3117</TD><TD>                    orders.set(index, currentOrder);</TD></TR><TR><TD CLASS="l">3118</TD><TD>                }</TD></TR><TR><TD CLASS="l">3119</TD><TD>                else</TD></TR><TR><TD CLASS="l">3120</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3121</TD><TD>                    orders.add(currentOrder);</TD></TR><TR><TD CLASS="l">3122</TD><TD>                }</TD></TR><TR><TD CLASS="l">3123</TD><TD>            }</TD></TR><TR><TD CLASS="l">3124</TD><TD>        }</TD></TR><TR><TD CLASS="l">3125</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3126</TD><TD>        if(nbboSellFlashedOrders != null &amp;&amp; nbboSellFlashedOrders.size() &gt; 0)</TD></TR><TR><TD CLASS="l">3127</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3128</TD><TD>            for(int j = 0; j &lt; nbboSellFlashedOrders.size(); j++)</TD></TR><TR><TD CLASS="l">3129</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3130</TD><TD>                Order currentOrder = (Order) nbboSellFlashedOrders.get(j);</TD></TR><TR CLASS="z"><TD CLASS="l">3131</TD><TD>                int index = orders.indexOf(currentOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">3132</TD><TD>                if(index &gt;= 0)</TD></TR><TR><TD CLASS="l">3133</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3134</TD><TD>                    orders.set(index, currentOrder);</TD></TR><TR><TD CLASS="l">3135</TD><TD>                }</TD></TR><TR><TD CLASS="l">3136</TD><TD>                else</TD></TR><TR><TD CLASS="l">3137</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3138</TD><TD>                    orders.add(currentOrder);</TD></TR><TR><TD CLASS="l">3139</TD><TD>                }</TD></TR><TR><TD CLASS="l">3140</TD><TD>            }</TD></TR><TR><TD CLASS="l">3141</TD><TD>        }       </TD></TR><TR><TD CLASS="l">3142</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3143</TD><TD>        Order[] results = new Order[orders.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">3144</TD><TD>        orders.toArray(results);</TD></TR><TR><TD CLASS="l">3145</TD><TD>        </TD></TR><TR><TD CLASS="l">3146</TD><TD>        //sorting is done primarily for orderbook creation</TD></TR><TR><TD CLASS="l"><A NAME="2">3147</A></TD><TD>        //we need to preserve the ordertime and this sorts in the ascending order</TD></TR><TR CLASS="z"><TD CLASS="l">3148</TD><TD>        if (sorted) {</TD></TR><TR CLASS="z"><TD CLASS="l">3149</TD><TD>            Arrays.sort(results, new Comparator&lt;Order&gt;() {</TD></TR><TR><TD CLASS="l">3150</TD><TD>                public int compare(Order lhs, Order rhs) {</TD></TR><TR CLASS="z"><TD CLASS="l">3151</TD><TD>                    final long lhsReceiveTime = getOrderSortTime(lhs);</TD></TR><TR CLASS="z"><TD CLASS="l">3152</TD><TD>                    final long rhsReceiveTime = getOrderSortTime(rhs);</TD></TR><TR CLASS="z"><TD CLASS="l">3153</TD><TD>                    if (lhsReceiveTime &gt; rhsReceiveTime) {</TD></TR><TR CLASS="z"><TD CLASS="l">3154</TD><TD>                        return 1;</TD></TR><TR><TD CLASS="l">3155</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3156</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3157</TD><TD>                    if (lhsReceiveTime &lt; rhsReceiveTime) {</TD></TR><TR CLASS="z"><TD CLASS="l">3158</TD><TD>                        return -1;</TD></TR><TR><TD CLASS="l">3159</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">3160</TD><TD>                    return 0;</TD></TR><TR><TD CLASS="l">3161</TD><TD> </TD></TR><TR><TD CLASS="l">3162</TD><TD>                }</TD></TR><TR><TD CLASS="l">3163</TD><TD>            });</TD></TR><TR><TD CLASS="l">3164</TD><TD> </TD></TR><TR><TD CLASS="l">3165</TD><TD>        }</TD></TR><TR><TD CLASS="l">3166</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3167</TD><TD>        return results;</TD></TR><TR><TD CLASS="l">3168</TD><TD>    }</TD></TR><TR><TD CLASS="l">3169</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="40">3170</A></TD><TD>    public Order[] findOrdersForProduct(int productKey, boolean sorted)</TD></TR><TR><TD CLASS="l">3171</TD><TD>    {</TD></TR><TR><TD CLASS="l">3172</TD><TD>        // The result is obtained from cache which is in sorted by time.</TD></TR><TR><TD CLASS="l">3173</TD><TD>        // So results are always returned sorted.</TD></TR><TR CLASS="z"><TD CLASS="l">3174</TD><TD>        ArrayList&lt;Order&gt; orders = new ArrayList&lt;Order&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">3175</TD><TD>        Order[] results = new Order[0];</TD></TR><TR CLASS="z"><TD CLASS="l">3176</TD><TD>        for (int i = 0; i &lt; getConfiguredSessions().length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">3177</TD><TD>            ConcurrentIntHashMap&lt;Map&lt;Long, Order&gt;&gt; productKeyOrderCache = productKeyOrderCacheForSessions</TD></TR><TR CLASS="z"><TD CLASS="l">3178</TD><TD>                    .get(configuredSessions[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">3179</TD><TD>            if (productKeyOrderCache != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3180</TD><TD>                Map&lt;Long, Order&gt; ordersByProduct = productKeyOrderCache.get(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3181</TD><TD>                if (ordersByProduct != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3182</TD><TD>                    orders.addAll(ordersByProduct.values());</TD></TR><TR><TD CLASS="l">3183</TD><TD>                }</TD></TR><TR><TD CLASS="l">3184</TD><TD>            }</TD></TR><TR><TD CLASS="l">3185</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3186</TD><TD>            results = new Order[orders.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">3187</TD><TD>            orders.toArray(results);</TD></TR><TR><TD CLASS="l">3188</TD><TD>        }</TD></TR><TR><TD CLASS="l">3189</TD><TD>        //sorting is done primarily for orderbook creation</TD></TR><TR><TD CLASS="l"><A NAME="5">3190</A></TD><TD>        //we need to preserve the ordertime and this sorts in the ascending order</TD></TR><TR CLASS="z"><TD CLASS="l">3191</TD><TD>        if (sorted) {</TD></TR><TR CLASS="z"><TD CLASS="l">3192</TD><TD>            Arrays.sort(results, new Comparator&lt;Order&gt;() {</TD></TR><TR><TD CLASS="l">3193</TD><TD>                public int compare(Order lhs, Order rhs) {</TD></TR><TR CLASS="z"><TD CLASS="l">3194</TD><TD>                    final long lhsReceiveTime = getOrderSortTime(lhs);</TD></TR><TR CLASS="z"><TD CLASS="l">3195</TD><TD>                    final long rhsReceiveTime = getOrderSortTime(rhs);</TD></TR><TR CLASS="z"><TD CLASS="l">3196</TD><TD>                    if (lhsReceiveTime &gt; rhsReceiveTime) {</TD></TR><TR CLASS="z"><TD CLASS="l">3197</TD><TD>                        return 1;</TD></TR><TR><TD CLASS="l">3198</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3199</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3200</TD><TD>                    if (lhsReceiveTime &lt; rhsReceiveTime) {</TD></TR><TR CLASS="z"><TD CLASS="l">3201</TD><TD>                        return -1;</TD></TR><TR><TD CLASS="l">3202</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">3203</TD><TD>                    return 0;</TD></TR><TR><TD CLASS="l">3204</TD><TD> </TD></TR><TR><TD CLASS="l">3205</TD><TD>                }</TD></TR><TR><TD CLASS="l">3206</TD><TD>            });</TD></TR><TR><TD CLASS="l">3207</TD><TD> </TD></TR><TR><TD CLASS="l">3208</TD><TD>        }</TD></TR><TR><TD CLASS="l">3209</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3210</TD><TD>        return results;</TD></TR><TR><TD CLASS="l">3211</TD><TD>    }</TD></TR><TR><TD CLASS="l">3212</TD><TD> </TD></TR><TR><TD CLASS="l">3213</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3214</TD><TD>     * Helper method to get the Order Sorting time based on the</TD></TR><TR><TD CLASS="l">3215</TD><TD>     * Booked or OHS received time.</TD></TR><TR><TD CLASS="l">3216</TD><TD>     * @param order</TD></TR><TR><TD CLASS="l"><A NAME="74">3217</A></TD><TD>     * @return</TD></TR><TR><TD CLASS="l">3218</TD><TD>     */</TD></TR><TR><TD CLASS="l">3219</TD><TD>    long getOrderSortTime(Order order)</TD></TR><TR><TD CLASS="l">3220</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3221</TD><TD>        long orderBookTime = order.getBookedTime();</TD></TR><TR CLASS="z"><TD CLASS="l">3222</TD><TD>        if(orderBookTime &gt; 0)</TD></TR><TR><TD CLASS="l">3223</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3224</TD><TD>            return orderBookTime;</TD></TR><TR><TD CLASS="l">3225</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3226</TD><TD>        return (order.isLightOrder()? order.getSourceReceivedTime() : order.getOHSReceivedTime());</TD></TR><TR><TD CLASS="l"><A NAME="45">3227</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3228</TD><TD>    </TD></TR><TR><TD CLASS="l">3229</TD><TD>    public Order[] findQuoteLikeOrdersForProduct(int productKey)</TD></TR><TR><TD CLASS="l">3230</TD><TD>            throws TransactionFailedException {</TD></TR><TR CLASS="z"><TD CLASS="l">3231</TD><TD>        ArrayList orders = new ArrayList();</TD></TR><TR CLASS="z"><TD CLASS="l">3232</TD><TD>        if (quoteLikeOrdersCache != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3233</TD><TD>            Map ordersByProduct = quoteLikeOrdersCache</TD></TR><TR CLASS="z"><TD CLASS="l">3234</TD><TD>                    .get(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3235</TD><TD>            if (ordersByProduct != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3236</TD><TD>                orders.addAll(ordersByProduct.values());</TD></TR><TR><TD CLASS="l">3237</TD><TD>            }</TD></TR><TR><TD CLASS="l">3238</TD><TD>        }</TD></TR><TR><TD CLASS="l">3239</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3240</TD><TD>        Order[] results = new Order[orders.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">3241</TD><TD>        orders.toArray(results);</TD></TR><TR><TD CLASS="l">3242</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3243</TD><TD>        return results;</TD></TR><TR><TD CLASS="l"><A NAME="46">3244</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3245</TD><TD> </TD></TR><TR><TD CLASS="l">3246</TD><TD>    public Order[] findQuoteLikeOrdersForUser(String user)</TD></TR><TR><TD CLASS="l">3247</TD><TD>            throws TransactionFailedException {</TD></TR><TR CLASS="z"><TD CLASS="l">3248</TD><TD>        ArrayList orders = new ArrayList();</TD></TR><TR CLASS="z"><TD CLASS="l">3249</TD><TD>        if (quoteLikeOrdersCache != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3250</TD><TD>            Set quoteLikeOrdersCacheSet = quoteLikeOrdersCache.entrySet();</TD></TR><TR CLASS="z"><TD CLASS="l">3251</TD><TD>            for (Iterator iter = quoteLikeOrdersCacheSet.iterator(); iter</TD></TR><TR CLASS="z"><TD CLASS="l">3252</TD><TD>                    .hasNext();) {</TD></TR><TR CLASS="z"><TD CLASS="l">3253</TD><TD>                IntMapEntry quoteLikeOrdersCacheElement = (IntMapEntry) iter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">3254</TD><TD>                Map ordersByProduct = (ConcurrentHashMap) quoteLikeOrdersCacheElement</TD></TR><TR CLASS="z"><TD CLASS="l">3255</TD><TD>                        .getValue();</TD></TR><TR CLASS="z"><TD CLASS="l">3256</TD><TD>                Set ordersByProductSet = ordersByProduct.entrySet();</TD></TR><TR CLASS="z"><TD CLASS="l">3257</TD><TD>                for (Iterator iterator = ordersByProductSet.iterator(); iterator</TD></TR><TR CLASS="z"><TD CLASS="l">3258</TD><TD>                        .hasNext();) {</TD></TR><TR CLASS="z"><TD CLASS="l">3259</TD><TD>                    Map.Entry ordersByProductElement = (Map.Entry) iterator</TD></TR><TR CLASS="z"><TD CLASS="l">3260</TD><TD>                            .next();</TD></TR><TR CLASS="z"><TD CLASS="l">3261</TD><TD>                    OrderImpl order = (OrderImpl) ordersByProductElement</TD></TR><TR CLASS="z"><TD CLASS="l">3262</TD><TD>                            .getValue();</TD></TR><TR CLASS="z"><TD CLASS="l">3263</TD><TD>                    if (user.equalsIgnoreCase(order.getUserId())) {</TD></TR><TR CLASS="z"><TD CLASS="l">3264</TD><TD>                        orders.add(order);</TD></TR><TR><TD CLASS="l">3265</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3266</TD><TD>                }</TD></TR><TR><TD CLASS="l">3267</TD><TD> </TD></TR><TR><TD CLASS="l">3268</TD><TD>            }</TD></TR><TR><TD CLASS="l">3269</TD><TD>        }</TD></TR><TR><TD CLASS="l">3270</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3271</TD><TD>        Order[] results = new Order[orders.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">3272</TD><TD>        orders.toArray(results);</TD></TR><TR><TD CLASS="l">3273</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3274</TD><TD>        return results;</TD></TR><TR><TD CLASS="l">3275</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="73">3276</A></TD><TD> </TD></TR><TR><TD CLASS="l">3277</TD><TD>    // Get handle to OHS.oqs</TD></TR><TR><TD CLASS="l">3278</TD><TD>    private OrderQueryService getOrderQueryService() {</TD></TR><TR><TD CLASS="l">3279</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3280</TD><TD>        if (orderQueryService == null) {</TD></TR><TR><TD CLASS="l">3281</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">3282</TD><TD>                OrderQueryServiceHome orderQueryServiceHome = (OrderQueryServiceHome) HomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">3283</TD><TD>                        .getInstance()</TD></TR><TR CLASS="z"><TD CLASS="l">3284</TD><TD>                        .findHome(OrderQueryServiceHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">3285</TD><TD>                orderQueryService = orderQueryServiceHome.find();</TD></TR><TR CLASS="z"><TD CLASS="l">3286</TD><TD>            } catch (com.cboe.infrastructureServices.foundationFramework.exceptionHandling.CBOELoggableException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">3287</TD><TD>                Log.alarm(this,</TD></TR><TR CLASS="z"><TD CLASS="l">3288</TD><TD>                        &#34;Unable to find OrderQueryServiceHome, giving up&#34;);</TD></TR><TR><TD CLASS="l">3289</TD><TD>            }</TD></TR><TR><TD CLASS="l">3290</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3291</TD><TD>        return orderQueryService;</TD></TR><TR><TD CLASS="l">3292</TD><TD> </TD></TR><TR><TD CLASS="l">3293</TD><TD>    }</TD></TR><TR><TD CLASS="l">3294</TD><TD> </TD></TR><TR><TD CLASS="l">3295</TD><TD>    /*</TD></TR><TR><TD CLASS="l">3296</TD><TD>     * Query OHS to get order if not found in TE and add to TE cache... If not found at OHS, need to</TD></TR><TR><TD CLASS="l"><A NAME="6d">3297</A></TD><TD>     * log an alarm...</TD></TR><TR><TD CLASS="l">3298</TD><TD>     */</TD></TR><TR><TD CLASS="l">3299</TD><TD>    public OrderImpl getOrderFromOHS(String sessionName, int productKey,</TD></TR><TR><TD CLASS="l">3300</TD><TD>            CboeIdStruct cboeOrderId) throws NotFoundException {</TD></TR><TR CLASS="z"><TD CLASS="l">3301</TD><TD>        OrderImpl retOrder = null;</TD></TR><TR><TD CLASS="l">3302</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">3303</TD><TD>            OrderRoutingParameterStruct orderRouting = getORParamsStruct();</TD></TR><TR><TD CLASS="l">3304</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3305</TD><TD>            OrderHandlingStructV2 orderHandlingStruct = getOrderQueryService()</TD></TR><TR CLASS="z"><TD CLASS="l">3306</TD><TD>                    .getOrderForProductByCboeId(orderRouting, sessionName,</TD></TR><TR CLASS="z"><TD CLASS="l">3307</TD><TD>                            productKey, cboeOrderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3308</TD><TD>            retOrder = (OrderImpl) create(orderHandlingStruct.orderHandlingStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">3309</TD><TD>            setSessionDataFromOrderHandlingExtension(retOrder,orderHandlingStruct.orderExtensions);</TD></TR><TR CLASS="z"><TD CLASS="l">3310</TD><TD>            addOrderToCache(retOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">3311</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">3312</TD><TD>            Log.debug(this, &#34;OHS could not find order = &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">3313</TD><TD>                    + cboeOrderId.toString() + &#34; , cannot add to TE CACHE&#34; + e);</TD></TR><TR CLASS="z"><TD CLASS="l">3314</TD><TD>            throw ExceptionBuilder.notFoundException(</TD></TR><TR CLASS="z"><TD CLASS="l">3315</TD><TD>                    &#34;OHS could not find order = &#34; + cboeOrderId.toString(),</TD></TR><TR CLASS="z"><TD CLASS="l">3316</TD><TD>                    NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">3317</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3318</TD><TD>        return retOrder;</TD></TR><TR><TD CLASS="l"><A NAME="6e">3319</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3320</TD><TD> </TD></TR><TR><TD CLASS="l">3321</TD><TD>    public Order getOrderFromOHSForBust(String sessionName, int productKey,</TD></TR><TR><TD CLASS="l">3322</TD><TD>            CboeIdStruct cboeOrderId) throws NotFoundException {</TD></TR><TR CLASS="z"><TD CLASS="l">3323</TD><TD>        OrderImpl retOrder = null;</TD></TR><TR><TD CLASS="l">3324</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">3325</TD><TD>            OrderRoutingParameterStruct orderRouting = getORParamsStruct();</TD></TR><TR><TD CLASS="l">3326</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3327</TD><TD>            OrderHandlingStructV2 orderHandlingStruct = getOrderQueryService()</TD></TR><TR CLASS="z"><TD CLASS="l">3328</TD><TD>                    .getOrderForProductByCboeId(orderRouting, sessionName,</TD></TR><TR CLASS="z"><TD CLASS="l">3329</TD><TD>                            productKey, cboeOrderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3330</TD><TD>            retOrder = (OrderImpl) createForBust(orderHandlingStruct.orderHandlingStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">3331</TD><TD>            setSessionDataFromOrderHandlingExtension(retOrder,orderHandlingStruct.orderExtensions);</TD></TR><TR CLASS="z"><TD CLASS="l">3332</TD><TD>            addOrderToCache(retOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">3333</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">3334</TD><TD>            Log.debug(this, &#34;OHS could not find order = &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">3335</TD><TD>                    + cboeOrderId.toString() + &#34; , cannot add to TE CACHE&#34; + e);</TD></TR><TR CLASS="z"><TD CLASS="l">3336</TD><TD>            throw ExceptionBuilder.notFoundException(</TD></TR><TR CLASS="z"><TD CLASS="l">3337</TD><TD>                    &#34;OHS could not find order = &#34; + cboeOrderId.toString(),</TD></TR><TR CLASS="z"><TD CLASS="l">3338</TD><TD>                    NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">3339</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3340</TD><TD>        return retOrder;</TD></TR><TR><TD CLASS="l">3341</TD><TD>    }</TD></TR><TR><TD CLASS="l">3342</TD><TD>    </TD></TR><TR><TD CLASS="l">3343</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3344</TD><TD>     * This method returns (and lazily initializes) the Home for TradeSessionAdminService.</TD></TR><TR><TD CLASS="l">3345</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="89">3346</A></TD><TD>     * @return TradingSessionAdminService</TD></TR><TR><TD CLASS="l">3347</TD><TD>     */</TD></TR><TR><TD CLASS="l">3348</TD><TD>    private synchronized TradingSessionServiceLocal getTradingSessionService()</TD></TR><TR><TD CLASS="l">3349</TD><TD>            throws NotFoundException {</TD></TR><TR CLASS="z"><TD CLASS="l">3350</TD><TD>        if (theTradingSessionService == null) {</TD></TR><TR><TD CLASS="l">3351</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">3352</TD><TD>                HomeFactory theHomeFactory = HomeFactory.getInstance();</TD></TR><TR CLASS="z"><TD CLASS="l">3353</TD><TD>                TradingSessionServiceHomeLocal theHome = (TradingSessionServiceHomeLocal) theHomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">3354</TD><TD>                        .findHome(TradingSessionServiceHomeLocal.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">3355</TD><TD>                if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">3356</TD><TD>                    Log.debug(this, &#34;got the TradingSessionServiceHome &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">3357</TD><TD>                            + theHome);</TD></TR><TR><TD CLASS="l">3358</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">3359</TD><TD>                theTradingSessionService = theHome.findLocal();</TD></TR><TR CLASS="z"><TD CLASS="l">3360</TD><TD>                if (Log.isDebugOn()) {</TD></TR><TR CLASS="z"><TD CLASS="l">3361</TD><TD>                    Log.debug(this, &#34;got the TradingSessionService &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">3362</TD><TD>                            + theTradingSessionService);</TD></TR><TR><TD CLASS="l">3363</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">3364</TD><TD>            } catch (com.cboe.infrastructureServices.foundationFramework.exceptionHandling.CBOELoggableException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">3365</TD><TD>                Log.alarm(this, &#34;Couldn't get TradingSessionService&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3366</TD><TD>                Log.exception(this, e);</TD></TR><TR CLASS="z"><TD CLASS="l">3367</TD><TD>                throw ExceptionBuilder.notFoundException(</TD></TR><TR CLASS="z"><TD CLASS="l">3368</TD><TD>                        &#34;unable to initialize TradingSessionService&#34;, 0);</TD></TR><TR><TD CLASS="l">3369</TD><TD>            }</TD></TR><TR><TD CLASS="l">3370</TD><TD>        }</TD></TR><TR><TD CLASS="l">3371</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="aa">3372</A></TD><TD>        return theTradingSessionService;</TD></TR><TR><TD CLASS="l">3373</TD><TD>    }</TD></TR><TR><TD CLASS="l">3374</TD><TD> </TD></TR><TR><TD CLASS="l">3375</TD><TD>    private boolean isSessionConfigured(String sessionName) {</TD></TR><TR CLASS="z"><TD CLASS="l">3376</TD><TD>        for (int i = 0; i &lt; getConfiguredSessions().length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">3377</TD><TD>            if (getConfiguredSessions()[i].equals(sessionName))</TD></TR><TR CLASS="z"><TD CLASS="l">3378</TD><TD>                return true;</TD></TR><TR><TD CLASS="l">3379</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="50">3380</A></TD><TD>        return false;</TD></TR><TR><TD CLASS="l">3381</TD><TD>    }</TD></TR><TR><TD CLASS="l">3382</TD><TD> </TD></TR><TR><TD CLASS="l">3383</TD><TD>    private String[] getConfiguredSessions() {</TD></TR><TR CLASS="z"><TD CLASS="l">3384</TD><TD>        if (configuredSessions == null) {</TD></TR><TR><TD CLASS="l">3385</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">3386</TD><TD>                configuredSessions = ApplicationPropertyHelper.getProperty(</TD></TR><TR CLASS="z"><TD CLASS="l">3387</TD><TD>                        &#34;sessionNames&#34;).split(&#34;,&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3388</TD><TD>            } catch (NoSuchPropertyException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">3389</TD><TD>                Log.alarm(&#34;No value defined for sessionNames &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3390</TD><TD>                throw new FatalFoundationFrameworkException(</TD></TR><TR CLASS="z"><TD CLASS="l">3391</TD><TD>                        &#34;No value defined for sessionNames in xml for the trade server&#34;);</TD></TR><TR><TD CLASS="l">3392</TD><TD>            }</TD></TR><TR><TD CLASS="l">3393</TD><TD>        }</TD></TR><TR><TD CLASS="l">3394</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="84">3395</A></TD><TD>        return configuredSessions;</TD></TR><TR><TD CLASS="l">3396</TD><TD>    }</TD></TR><TR><TD CLASS="l">3397</TD><TD> </TD></TR><TR><TD CLASS="l">3398</TD><TD>    public int getTotalNumberOfOrderLoadingThreads() {</TD></TR><TR CLASS="z"><TD CLASS="l">3399</TD><TD>        return totalNumberOfOrderLoadingThreads;</TD></TR><TR><TD CLASS="l"><A NAME="c0">3400</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3401</TD><TD> </TD></TR><TR><TD CLASS="l">3402</TD><TD>    public void setTotalNumberOfOrderLoadingThreads(</TD></TR><TR><TD CLASS="l">3403</TD><TD>            int p_totalNumberOfOrderLoadingThreads) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="62">3404</A></TD><TD>        totalNumberOfOrderLoadingThreads = p_totalNumberOfOrderLoadingThreads;</TD></TR><TR CLASS="z"><TD CLASS="l">3405</TD><TD>    }</TD></TR><TR><TD CLASS="l">3406</TD><TD> </TD></TR><TR><TD CLASS="l">3407</TD><TD>    public int getMaxProductsToSendPerCallToOHS() {</TD></TR><TR CLASS="z"><TD CLASS="l">3408</TD><TD>        return maxProductsToSendPerCallToOHS;</TD></TR><TR><TD CLASS="l"><A NAME="bd">3409</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3410</TD><TD> </TD></TR><TR><TD CLASS="l">3411</TD><TD>    public void setMaxProductsToSendPerCallToOHS(</TD></TR><TR><TD CLASS="l">3412</TD><TD>            int p_maxProductsToSendPerCallToOHS) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="64">3413</A></TD><TD>        maxProductsToSendPerCallToOHS = p_maxProductsToSendPerCallToOHS;</TD></TR><TR CLASS="z"><TD CLASS="l">3414</TD><TD>    }</TD></TR><TR><TD CLASS="l">3415</TD><TD> </TD></TR><TR><TD CLASS="l">3416</TD><TD>    public long getMaxSleepTimeBeforeOHSCall() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="be">3417</A></TD><TD>        return maxSleepTimeBeforeOHSCall;</TD></TR><TR><TD CLASS="l">3418</TD><TD>    }</TD></TR><TR><TD CLASS="l">3419</TD><TD> </TD></TR><TR><TD CLASS="l">3420</TD><TD>    public void setMaxSleepTimeBeforeOHSCall(long p_maxSleepTimeBeforeOHSCall) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="42">3421</A></TD><TD>        maxSleepTimeBeforeOHSCall = p_maxSleepTimeBeforeOHSCall;</TD></TR><TR CLASS="z"><TD CLASS="l">3422</TD><TD>    }</TD></TR><TR><TD CLASS="l">3423</TD><TD> </TD></TR><TR><TD CLASS="l">3424</TD><TD>    public Order[] findPendingContingentOrders(short contingencyType) {</TD></TR><TR CLASS="z"><TD CLASS="l">3425</TD><TD>        short[] contingencyArray = new short[1];</TD></TR><TR CLASS="z"><TD CLASS="l">3426</TD><TD>        contingencyArray[0] = contingencyType;</TD></TR><TR CLASS="z"><TD CLASS="l">3427</TD><TD>        return findPendingOrders(contingencyArray, true);</TD></TR><TR><TD CLASS="l">3428</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="43">3429</A></TD><TD> </TD></TR><TR><TD CLASS="l">3430</TD><TD>    </TD></TR><TR><TD CLASS="l">3431</TD><TD>    private Order[] findPendingOrders(short contingencyTypes[], boolean sorted) {</TD></TR><TR><TD CLASS="l">3432</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3433</TD><TD>        Iterator ordersEnum = orderCache.values().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">3434</TD><TD>        ArrayList&lt;Order&gt; pendingOrders = new ArrayList&lt;Order&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">3435</TD><TD>        Order[] result = new Order[0];</TD></TR><TR><TD CLASS="l">3436</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3437</TD><TD>        while (ordersEnum.hasNext()) {</TD></TR><TR CLASS="z"><TD CLASS="l">3438</TD><TD>            OrderImpl order = (OrderImpl) ordersEnum.next();</TD></TR><TR CLASS="z"><TD CLASS="l">3439</TD><TD>            if (order.getState() == OrderStates.WAITING</TD></TR><TR CLASS="z"><TD CLASS="l">3440</TD><TD>                    &amp;&amp; order.getRemainingQuantity() &gt; 0</TD></TR><TR CLASS="z"><TD CLASS="l">3441</TD><TD>                    &amp;&amp; (isContingencyInTheList(order.getContingencyType(),</TD></TR><TR CLASS="z"><TD CLASS="l">3442</TD><TD>                            contingencyTypes))) {</TD></TR><TR CLASS="z"><TD CLASS="l">3443</TD><TD>                pendingOrders.add(order);</TD></TR><TR><TD CLASS="l">3444</TD><TD>            }</TD></TR><TR><TD CLASS="l">3445</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="8">3446</A></TD><TD>        result = pendingOrders.toArray(new Order[pendingOrders.size()]);</TD></TR><TR CLASS="z"><TD CLASS="l">3447</TD><TD>        if (sorted) {</TD></TR><TR CLASS="z"><TD CLASS="l">3448</TD><TD>            Arrays.sort(result, new Comparator&lt;Order&gt;() {</TD></TR><TR><TD CLASS="l">3449</TD><TD>                public int compare(Order lhs, Order rhs) {</TD></TR><TR CLASS="z"><TD CLASS="l">3450</TD><TD>                    final long lhsReceiveTime = lhs.isLightOrder()? lhs.getSourceReceivedTime() : lhs.getOHSReceivedTime();</TD></TR><TR CLASS="z"><TD CLASS="l">3451</TD><TD>                    final long rhsReceiveTime = rhs.isLightOrder()? rhs.getSourceReceivedTime() : rhs.getOHSReceivedTime();</TD></TR><TR CLASS="z"><TD CLASS="l">3452</TD><TD>                    if (lhsReceiveTime &gt; rhsReceiveTime) {</TD></TR><TR CLASS="z"><TD CLASS="l">3453</TD><TD>                        return 1;</TD></TR><TR><TD CLASS="l">3454</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3455</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3456</TD><TD>                    if (lhsReceiveTime &lt; rhsReceiveTime) {</TD></TR><TR CLASS="z"><TD CLASS="l">3457</TD><TD>                        return -1;</TD></TR><TR><TD CLASS="l">3458</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">3459</TD><TD>                    return 0;</TD></TR><TR><TD CLASS="l">3460</TD><TD>                }</TD></TR><TR><TD CLASS="l">3461</TD><TD>            });</TD></TR><TR><TD CLASS="l">3462</TD><TD>        }</TD></TR><TR><TD CLASS="l">3463</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3464</TD><TD>        return result;</TD></TR><TR><TD CLASS="l">3465</TD><TD>    }</TD></TR><TR><TD CLASS="l">3466</TD><TD> </TD></TR><TR><TD CLASS="l">3467</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3468</TD><TD>     * </TD></TR><TR><TD CLASS="l">3469</TD><TD>     * @param contingencyType</TD></TR><TR><TD CLASS="l">3470</TD><TD>     * @param listOfContingencies</TD></TR><TR><TD CLASS="l"><A NAME="a6">3471</A></TD><TD>     * @return</TD></TR><TR><TD CLASS="l">3472</TD><TD>     */</TD></TR><TR><TD CLASS="l">3473</TD><TD>    private boolean isContingencyInTheList(short contingencyType,</TD></TR><TR><TD CLASS="l">3474</TD><TD>            short[] listOfContingencies) {</TD></TR><TR CLASS="z"><TD CLASS="l">3475</TD><TD>        for (int i = 0; i &lt; listOfContingencies.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">3476</TD><TD>            if (listOfContingencies[i] == contingencyType) {</TD></TR><TR CLASS="z"><TD CLASS="l">3477</TD><TD>                return true;</TD></TR><TR><TD CLASS="l">3478</TD><TD>            }</TD></TR><TR><TD CLASS="l">3479</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3480</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">3481</TD><TD>    }</TD></TR><TR><TD CLASS="l">3482</TD><TD> </TD></TR><TR><TD CLASS="l">3483</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3484</TD><TD>     * This is to accommodate removal of fully filled or canceled orders NOTE:</TD></TR><TR><TD CLASS="l">3485</TD><TD>     * Though the list is created in the TradingClassImpl, it is important to</TD></TR><TR><TD CLASS="l">3486</TD><TD>     * check the quantity again before deleting, as some other process might</TD></TR><TR><TD CLASS="l">3487</TD><TD>     * have readjusted the quantity in the meantime in the same transaction</TD></TR><TR><TD CLASS="l">3488</TD><TD>     * </TD></TR><TR><TD CLASS="l">3489</TD><TD>     * @param orderIds</TD></TR><TR><TD CLASS="l"><A NAME="33">3490</A></TD><TD>     * @return</TD></TR><TR><TD CLASS="l">3491</TD><TD>     */</TD></TR><TR><TD CLASS="l">3492</TD><TD>    public void deleteFromCache(List orderIds)</TD></TR><TR><TD CLASS="l">3493</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3494</TD><TD>        Iterator orderIdIterator = orderIds.iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">3495</TD><TD>        while (orderIdIterator.hasNext())</TD></TR><TR><TD CLASS="l">3496</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3497</TD><TD>            Order orderToBeDeleted = (Order) orderIdIterator.next();</TD></TR><TR><TD CLASS="l">3498</TD><TD>            // the quantity check is to ensure that in the same transaction</TD></TR><TR><TD CLASS="l">3499</TD><TD>            // some other process has not modified the quantity - Reinstate bug</TD></TR><TR><TD CLASS="l">3500</TD><TD>            // fix</TD></TR><TR CLASS="z"><TD CLASS="l">3501</TD><TD>            if (orderToBeDeleted.getRemainingQuantity() &lt;= 0</TD></TR><TR CLASS="z"><TD CLASS="l">3502</TD><TD>                    &amp;&amp; orderToBeDeleted.getTradedQuantity() &lt;= 0)</TD></TR><TR><TD CLASS="l">3503</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3504</TD><TD>                deleteOrderFromCache(orderToBeDeleted);</TD></TR><TR><TD CLASS="l">3505</TD><TD>            }</TD></TR><TR><TD CLASS="l">3506</TD><TD>        }</TD></TR><TR><TD CLASS="l">3507</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="34">3508</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3509</TD><TD>    public void deleteOrderFromCache(Order orderToBeDeleted)</TD></TR><TR><TD CLASS="l">3510</TD><TD>    {</TD></TR><TR><TD CLASS="l">3511</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3512</TD><TD>        final Long orderIdLong = new Long(orderToBeDeleted.getUniqueId());</TD></TR><TR><TD CLASS="l">3513</TD><TD> </TD></TR><TR><TD CLASS="l">3514</TD><TD>        // delete from the main cache</TD></TR><TR CLASS="z"><TD CLASS="l">3515</TD><TD>        this.orderCache.remove(orderIdLong);</TD></TR><TR><TD CLASS="l">3516</TD><TD> </TD></TR><TR><TD CLASS="l">3517</TD><TD>        try</TD></TR><TR><TD CLASS="l">3518</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3519</TD><TD>            getOrderMarketMonitoringService().deleteOrderMarketMonitoringFromCache(orderToBeDeleted);</TD></TR><TR><TD CLASS="l">3520</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3521</TD><TD>        catch(Exception excp)</TD></TR><TR><TD CLASS="l">3522</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3523</TD><TD>            Log.information(&#34;Unable to delete the OrderMarketMonitor Cache for Order: &#34; + orderToBeDeleted.getOrderIdString() + &#34;Exception: &#34; + excp.getMessage());</TD></TR><TR><TD CLASS="l">3524</TD><TD>        }</TD></TR><TR><TD CLASS="l">3525</TD><TD> </TD></TR><TR><TD CLASS="l">3526</TD><TD>        // get the productKey and active Session</TD></TR><TR CLASS="z"><TD CLASS="l">3527</TD><TD>        int productKey = orderToBeDeleted.getProductKey().intValue();</TD></TR><TR CLASS="z"><TD CLASS="l">3528</TD><TD>        String activeSession = orderToBeDeleted.getActiveSession();</TD></TR><TR CLASS="z"><TD CLASS="l">3529</TD><TD>        if (activeSession == null)</TD></TR><TR><TD CLASS="l">3530</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3531</TD><TD>            Log.alarm(&#34;Active Session is Null while deleting an order&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3532</TD><TD>            return;</TD></TR><TR><TD CLASS="l">3533</TD><TD>        }</TD></TR><TR><TD CLASS="l">3534</TD><TD> </TD></TR><TR><TD CLASS="l">3535</TD><TD>        // get the productKeyOrdercache</TD></TR><TR CLASS="z"><TD CLASS="l">3536</TD><TD>        ConcurrentIntHashMap&lt;Map&lt;Long, Order&gt;&gt; productKeyOrderCache = productKeyOrderCacheForSessions</TD></TR><TR CLASS="z"><TD CLASS="l">3537</TD><TD>                .get(activeSession);</TD></TR><TR><TD CLASS="l">3538</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3539</TD><TD>        if (productKeyOrderCache != null)</TD></TR><TR><TD CLASS="l">3540</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3541</TD><TD>            Map&lt;Long, Order&gt; ordersByProduct = productKeyOrderCache.get(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3542</TD><TD>            if (ordersByProduct != null)</TD></TR><TR><TD CLASS="l">3543</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3544</TD><TD>                ordersByProduct.remove(orderIdLong);</TD></TR><TR><TD CLASS="l">3545</TD><TD>            }</TD></TR><TR><TD CLASS="l">3546</TD><TD>        }</TD></TR><TR><TD CLASS="l">3547</TD><TD> </TD></TR><TR><TD CLASS="l">3548</TD><TD>        // now delete from quoteLikeOrderCache</TD></TR><TR CLASS="z"><TD CLASS="l">3549</TD><TD>        if (orderToBeDeleted.treatedLikeQuote() || isGOrder(orderToBeDeleted) || orderToBeDeleted.isManualQuote() )</TD></TR><TR><TD CLASS="l">3550</TD><TD>        {</TD></TR><TR><TD CLASS="l">3551</TD><TD>            // get the map of orders by product for IOrders</TD></TR><TR CLASS="z"><TD CLASS="l">3552</TD><TD>            if (quoteLikeOrdersCache != null)</TD></TR><TR><TD CLASS="l">3553</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3554</TD><TD>                Map quoteLikeOrdersByProduct = quoteLikeOrdersCache.get(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3555</TD><TD>                if (quoteLikeOrdersByProduct != null)</TD></TR><TR><TD CLASS="l">3556</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3557</TD><TD>                    quoteLikeOrdersByProduct.remove(orderIdLong);</TD></TR><TR><TD CLASS="l">3558</TD><TD>                }</TD></TR><TR><TD CLASS="l">3559</TD><TD>            }</TD></TR><TR><TD CLASS="l">3560</TD><TD> </TD></TR><TR><TD CLASS="l">3561</TD><TD>        }</TD></TR><TR><TD CLASS="l">3562</TD><TD>        </TD></TR><TR><TD CLASS="l"><A NAME="70">3563</A></TD><TD>        // Delete from distributed cache</TD></TR><TR CLASS="z"><TD CLASS="l">3564</TD><TD>    }</TD></TR><TR><TD CLASS="l">3565</TD><TD> </TD></TR><TR><TD CLASS="l">3566</TD><TD>    protected OrderIdGeneratorHome getOrderIdGeneratorHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">3567</TD><TD>        if (theOrderIdGeneratorHome == null) {</TD></TR><TR><TD CLASS="l">3568</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">3569</TD><TD>                HomeFactory theHomeFactory = HomeFactory.getInstance();</TD></TR><TR CLASS="z"><TD CLASS="l">3570</TD><TD>                theOrderIdGeneratorHome = (OrderIdGeneratorHome) theHomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">3571</TD><TD>                        .findHome(OrderIdGeneratorHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">3572</TD><TD>                if (Log.isDebugOn())</TD></TR><TR CLASS="z"><TD CLASS="l">3573</TD><TD>                    Log.debug(this, &#34;got the OrderIdGeneratorHome &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">3574</TD><TD>                            + theOrderIdGeneratorHome);</TD></TR><TR CLASS="z"><TD CLASS="l">3575</TD><TD>            } catch (com.cboe.infrastructureServices.foundationFramework.exceptionHandling.CBOELoggableException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">3576</TD><TD>                Log.alarm(this, &#34;couldn't initialize OrderIdGeneratorHome&#34;);</TD></TR><TR><TD CLASS="l">3577</TD><TD>            }</TD></TR><TR><TD CLASS="l">3578</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3579</TD><TD>        return theOrderIdGeneratorHome;</TD></TR><TR><TD CLASS="l">3580</TD><TD>    }</TD></TR><TR><TD CLASS="l">3581</TD><TD> </TD></TR><TR><TD CLASS="l">3582</TD><TD>    public Order persistOrder(OrderStruct orderStruct)</TD></TR><TR><TD CLASS="l"><A NAME="ae">3583</A></TD><TD>            throws DataValidationException, SystemException,</TD></TR><TR><TD CLASS="l">3584</TD><TD>            TransactionFailedException</TD></TR><TR><TD CLASS="l">3585</TD><TD> </TD></TR><TR><TD CLASS="l">3586</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3587</TD><TD>        OrderRoutingParameterStruct orderRouting = new OrderRoutingParameterStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">3588</TD><TD>        orderRouting.source = RouteNameHelper.getRouteName();</TD></TR><TR CLASS="z"><TD CLASS="l">3589</TD><TD>        orderRouting.sourceType = OrderLocations.TE;</TD></TR><TR CLASS="z"><TD CLASS="l">3590</TD><TD>        orderRouting.destinationType = OrderLocations.UNSPECIFIED;</TD></TR><TR CLASS="z"><TD CLASS="l">3591</TD><TD>        orderRouting.destination = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">3592</TD><TD>        LegOrderDetailStruct[] legs = orderStruct.legOrderDetails;</TD></TR><TR><TD CLASS="l">3593</TD><TD>        //create the new order in OHS</TD></TR><TR><TD CLASS="l">3594</TD><TD>        OrderHandlingStruct anOrder;</TD></TR><TR><TD CLASS="l">3595</TD><TD>    try</TD></TR><TR><TD CLASS="l">3596</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3597</TD><TD>        anOrder = getOrderMaintenanceServiceHome().find().createOrder(orderRouting, orderStruct,</TD></TR><TR CLASS="z"><TD CLASS="l">3598</TD><TD>                        MarketDetailStructBuilder.buildMarketDetailStruct(legs.length + 1));</TD></TR><TR><TD CLASS="l">3599</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">3600</TD><TD>    catch (CommunicationException e)</TD></TR><TR><TD CLASS="l">3601</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3602</TD><TD>            String msg = &#34;Caught CommunicationException while trying to persist order : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">3603</TD><TD>                    + OrderImpl.orderIdToString(orderStruct.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3604</TD><TD>            Log.exception(msg, e);</TD></TR><TR CLASS="z"><TD CLASS="l">3605</TD><TD>            throw ExceptionBuilder.systemException(msg, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">3606</TD><TD>        } catch (AuthorizationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">3607</TD><TD>            String msg = &#34;Caught TransactionFailedException while trying to persist order : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">3608</TD><TD>                    + OrderImpl.orderIdToString(orderStruct.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3609</TD><TD>            Log.exception(msg, e);</TD></TR><TR CLASS="z"><TD CLASS="l">3610</TD><TD>            throw ExceptionBuilder.systemException(msg, 0);</TD></TR><TR><TD CLASS="l">3611</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3612</TD><TD>        return create(anOrder);</TD></TR><TR><TD CLASS="l">3613</TD><TD>    }</TD></TR><TR><TD CLASS="l">3614</TD><TD>    public Order persistOrderV2(OrderRoutingParameterStruct orderRouting, OrderHandlingStruct orderStruct, ExchangeAcronymStruct acronym)</TD></TR><TR><TD CLASS="l">3615</TD><TD>        throws DataValidationException, SystemException, TransactionFailedException</TD></TR><TR><TD CLASS="l"><A NAME="af">3616</A></TD><TD>    {</TD></TR><TR><TD CLASS="l">3617</TD><TD>    //create the new order in OHS</TD></TR><TR><TD CLASS="l">3618</TD><TD>    OrderHandlingStruct anOrder;</TD></TR><TR><TD CLASS="l">3619</TD><TD>    try {</TD></TR><TR CLASS="z"><TD CLASS="l">3620</TD><TD>        anOrder = getOrderMaintenanceServiceHome().find().createOrderV2(</TD></TR><TR CLASS="z"><TD CLASS="l">3621</TD><TD>                orderRouting, orderStruct, acronym);</TD></TR><TR CLASS="z"><TD CLASS="l">3622</TD><TD>    } catch (CommunicationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">3623</TD><TD>        String msg = &#34;Caught CommunicationException while trying to persist order : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">3624</TD><TD>                + OrderImpl.orderIdToString(orderStruct.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3625</TD><TD>        Log.exception(msg, e);</TD></TR><TR CLASS="z"><TD CLASS="l">3626</TD><TD>        throw ExceptionBuilder.systemException(msg, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">3627</TD><TD>    } catch (AuthorizationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">3628</TD><TD>        String msg = &#34;Caught TransactionFailedException while trying to persist order : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">3629</TD><TD>                + OrderImpl.orderIdToString(orderStruct.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3630</TD><TD>        Log.exception(msg, e);</TD></TR><TR CLASS="z"><TD CLASS="l">3631</TD><TD>        throw ExceptionBuilder.systemException(msg, 0);</TD></TR><TR><TD CLASS="l">3632</TD><TD>    }</TD></TR><TR CLASS="z"><TD CLASS="l">3633</TD><TD>    return create(anOrder);</TD></TR><TR><TD CLASS="l">3634</TD><TD>}</TD></TR><TR><TD CLASS="l">3635</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="18">3636</A></TD><TD>   </TD></TR><TR><TD CLASS="l">3637</TD><TD>    </TD></TR><TR><TD CLASS="l">3638</TD><TD>    public MarketDetailStruct[] buildMarketDetailStructs(String sessionName, FilledReportStruct[] reports)</TD></TR><TR><TD CLASS="l">3639</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3640</TD><TD>        int[] filledReportsProductKeys = new int[reports.length];</TD></TR><TR CLASS="z"><TD CLASS="l">3641</TD><TD>        for (int i = 0; i &lt; reports.length; i++)</TD></TR><TR><TD CLASS="l">3642</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3643</TD><TD>            filledReportsProductKeys[i] = reports[i].productKey;</TD></TR><TR><TD CLASS="l">3644</TD><TD>        }</TD></TR><TR><TD CLASS="l">3645</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3646</TD><TD>        return buildMarketDetailStructs(sessionName, filledReportsProductKeys);</TD></TR><TR><TD CLASS="l"><A NAME="17">3647</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3648</TD><TD>    </TD></TR><TR><TD CLASS="l">3649</TD><TD>    public MarketDetailStruct[] buildMarketDetailStructs(String sessionName, CancelReportStruct[] reports)</TD></TR><TR><TD CLASS="l">3650</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3651</TD><TD>        int[] cancelReportsProductKeys = new int[reports.length];</TD></TR><TR CLASS="z"><TD CLASS="l">3652</TD><TD>        for (int i = 0; i &lt; reports.length; i++)</TD></TR><TR><TD CLASS="l">3653</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3654</TD><TD>            cancelReportsProductKeys[i] = reports[i].productKey;</TD></TR><TR><TD CLASS="l">3655</TD><TD>        }</TD></TR><TR><TD CLASS="l">3656</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3657</TD><TD>        return buildMarketDetailStructs(sessionName, cancelReportsProductKeys);</TD></TR><TR><TD CLASS="l"><A NAME="19">3658</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3659</TD><TD>    </TD></TR><TR><TD CLASS="l">3660</TD><TD>    public MarketDetailStruct[] buildMarketDetailStructs(String sessionName, int[] productKeys)</TD></TR><TR><TD CLASS="l">3661</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3662</TD><TD>            MarketDetailStruct[] mktDetailStruct = new MarketDetailStruct[productKeys.length];</TD></TR><TR CLASS="z"><TD CLASS="l">3663</TD><TD>        MarketDetailStruct ordMarketDataStructInfo = null;</TD></TR><TR CLASS="z"><TD CLASS="l">3664</TD><TD>        CurrentMarketStruct[] currentMarketForProxyProduct = null;</TD></TR><TR CLASS="z"><TD CLASS="l">3665</TD><TD>        MarketData productMarketData = null;</TD></TR><TR CLASS="z"><TD CLASS="l">3666</TD><TD>        TradingProduct tradingProduct = null ;</TD></TR><TR><TD CLASS="l">3667</TD><TD>       </TD></TR><TR CLASS="z"><TD CLASS="l">3668</TD><TD>        if (null == productKeys || productKeys.length == 0)</TD></TR><TR><TD CLASS="l">3669</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3670</TD><TD>            Log.information(this, &#34;Invalid productKeys==&#34; + productKeys);</TD></TR><TR CLASS="z"><TD CLASS="l">3671</TD><TD>            return mktDetailStruct;</TD></TR><TR><TD CLASS="l">3672</TD><TD>        }</TD></TR><TR><TD CLASS="l">3673</TD><TD>  </TD></TR><TR><TD CLASS="l">3674</TD><TD>        try</TD></TR><TR><TD CLASS="l">3675</TD><TD>        { </TD></TR><TR CLASS="z"><TD CLASS="l">3676</TD><TD>                 for (int i=0; i&lt; productKeys.length; i++) { //productKeys iterator start</TD></TR><TR><TD CLASS="l">3677</TD><TD>             </TD></TR><TR><TD CLASS="l">3678</TD><TD>                      try</TD></TR><TR><TD CLASS="l">3679</TD><TD>                      {</TD></TR><TR CLASS="z"><TD CLASS="l">3680</TD><TD>                           tradingProduct = getTradingProductHome().findByKey(productKeys[i]);</TD></TR><TR><TD CLASS="l">3681</TD><TD>                      }</TD></TR><TR CLASS="z"><TD CLASS="l">3682</TD><TD>                      catch(Exception exp)</TD></TR><TR><TD CLASS="l">3683</TD><TD>                      {</TD></TR><TR CLASS="z"><TD CLASS="l">3684</TD><TD>                           MarketDetailStruct[]  tmpMktDetailStruct = MarketDetailStructBuilder.buildMarketDetailStruct(1);</TD></TR><TR CLASS="z"><TD CLASS="l">3685</TD><TD>                           tmpMktDetailStruct[0].productKey = productKeys[i];</TD></TR><TR CLASS="z"><TD CLASS="l">3686</TD><TD>                           mktDetailStruct[i] = tmpMktDetailStruct[0];</TD></TR><TR CLASS="z"><TD CLASS="l">3687</TD><TD>                           continue;</TD></TR><TR><TD CLASS="l">3688</TD><TD>                      }</TD></TR><TR><TD CLASS="l">3689</TD><TD> </TD></TR><TR><TD CLASS="l">3690</TD><TD>                         // We need to check if we are in local process or the proxy.</TD></TR><TR><TD CLASS="l">3691</TD><TD>                         // For hybrid trade server, Spread trade server is proxy and vice versa for spread trade server.</TD></TR><TR CLASS="z"><TD CLASS="l">3692</TD><TD>                         if(tradingProduct.isProxy()){                                 </TD></TR><TR CLASS="z"><TD CLASS="l">3693</TD><TD>                                 if (tradingProduct.isStrategy()) {</TD></TR><TR><TD CLASS="l">3694</TD><TD>                                         </TD></TR><TR><TD CLASS="l">3695</TD><TD>                                         // If we are in proxy and the product is a strategy, it implies we are in hybrid trade server</TD></TR><TR CLASS="z"><TD CLASS="l">3696</TD><TD>                                         ordMarketDataStructInfo = MarketDetailStructBuilder.buildMarketDetailStruct(1)[0];</TD></TR><TR CLASS="z"><TD CLASS="l">3697</TD><TD>                                         ordMarketDataStructInfo.productKey = tradingProduct.getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">3698</TD><TD>                                         ordMarketDataStructInfo.productType = tradingProduct.getTradingClass().getProductType();</TD></TR><TR><TD CLASS="l">3699</TD><TD>                                 }</TD></TR><TR><TD CLASS="l">3700</TD><TD>                                 else {</TD></TR><TR><TD CLASS="l">3701</TD><TD>                                         // Else we are in strategy trade server</TD></TR><TR CLASS="z"><TD CLASS="l">3702</TD><TD>                                         currentMarketForProxyProduct = StrategyTradeServiceHelper.getCurrentMarketCacheHome().find().getCurrentMarketStructs(productKeys[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">3703</TD><TD>                                         NBBOStruct nbbo = getMarketDataService().getNBBOForProduct(sessionName, productKeys[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">3704</TD><TD>                                         ordMarketDataStructInfo = buildMarketDetailStructFromCurrentMarketStruct(currentMarketForProxyProduct,nbbo);</TD></TR><TR><TD CLASS="l">3705</TD><TD>                                 }</TD></TR><TR><TD CLASS="l">3706</TD><TD>                         }</TD></TR><TR><TD CLASS="l">3707</TD><TD>              </TD></TR><TR><TD CLASS="l">3708</TD><TD>                         else</TD></TR><TR><TD CLASS="l">3709</TD><TD>                         {</TD></TR><TR><TD CLASS="l">3710</TD><TD>                                 // We are in local process</TD></TR><TR CLASS="z"><TD CLASS="l">3711</TD><TD>                                 productMarketData = tradingProduct.getMarketData(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">3712</TD><TD>                                 DerivedQuote derivedQuote = null;</TD></TR><TR CLASS="z"><TD CLASS="l">3713</TD><TD>                                 if (tradingProduct.isStrategy()) </TD></TR><TR><TD CLASS="l">3714</TD><TD>                                 {</TD></TR><TR><TD CLASS="l">3715</TD><TD>                                     try</TD></TR><TR><TD CLASS="l">3716</TD><TD>                                     {</TD></TR><TR CLASS="z"><TD CLASS="l">3717</TD><TD>                                         derivedQuote = tradingProduct.getDerivedQuote();</TD></TR><TR><TD CLASS="l">3718</TD><TD>                                     }</TD></TR><TR CLASS="z"><TD CLASS="l">3719</TD><TD>                                     catch(Exception exp)</TD></TR><TR><TD CLASS="l">3720</TD><TD>                                     {</TD></TR><TR CLASS="z"><TD CLASS="l">3721</TD><TD>                                         if(Log.isDebugOn())</TD></TR><TR><TD CLASS="l">3722</TD><TD>                                         {</TD></TR><TR CLASS="z"><TD CLASS="l">3723</TD><TD>                                             Log.debug(this, &#34;Unable to calculate Derived Quote for Strategy product:&#34; + tradingProduct.getProductKey());</TD></TR><TR><TD CLASS="l">3724</TD><TD>                                         }</TD></TR><TR><TD CLASS="l">3725</TD><TD>                                     }</TD></TR><TR><TD CLASS="l">3726</TD><TD>                                  }</TD></TR><TR><TD CLASS="l">3727</TD><TD>                                 </TD></TR><TR CLASS="z"><TD CLASS="l">3728</TD><TD>                                 ordMarketDataStructInfo =  </TD></TR><TR CLASS="z"><TD CLASS="l">3729</TD><TD>                                                 buildMarketDetailStructFromMarketData(productMarketData, derivedQuote,</TD></TR><TR CLASS="z"><TD CLASS="l">3730</TD><TD>                                                                         tradingProduct.getTradingClass().getProductType());</TD></TR><TR><TD CLASS="l">3731</TD><TD>                         }</TD></TR><TR><TD CLASS="l">3732</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">3733</TD><TD>                         mktDetailStruct[i] = ordMarketDataStructInfo; </TD></TR><TR><TD CLASS="l">3734</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">3735</TD><TD>                 return mktDetailStruct;</TD></TR><TR><TD CLASS="l">3736</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3737</TD><TD>        catch (Exception e)</TD></TR><TR><TD CLASS="l">3738</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3739</TD><TD>            mktDetailStruct = MarketDetailStructBuilder.buildMarketDetailStruct(productKeys.length);</TD></TR><TR CLASS="z"><TD CLASS="l">3740</TD><TD>            Log.information(this, &#34;buildMarketDetailStruct() failed to query quote for productKey==&#34; + productKeys);</TD></TR><TR CLASS="z"><TD CLASS="l">3741</TD><TD>                    Log.exception(e);</TD></TR><TR CLASS="z"><TD CLASS="l">3742</TD><TD>            return mktDetailStruct;</TD></TR><TR><TD CLASS="l">3743</TD><TD>        }</TD></TR><TR><TD CLASS="l">3744</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="60">3745</A></TD><TD>   </TD></TR><TR><TD CLASS="l">3746</TD><TD>    private MarketDataService getMarketDataService()</TD></TR><TR><TD CLASS="l">3747</TD><TD>    throws SystemException</TD></TR><TR><TD CLASS="l">3748</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3749</TD><TD>        if (marketDataService == null)</TD></TR><TR><TD CLASS="l">3750</TD><TD>        {</TD></TR><TR><TD CLASS="l">3751</TD><TD>            try</TD></TR><TR><TD CLASS="l">3752</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3753</TD><TD>                com.cboe.interfaces.businessServices.MarketDataServiceHome marketHome = </TD></TR><TR CLASS="z"><TD CLASS="l">3754</TD><TD>                    (com.cboe.interfaces.businessServices.MarketDataServiceHome) HomeFactory.getInstance().findHome(com.cboe.interfaces.businessServices.MarketDataServiceHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">3755</TD><TD>                marketDataService = marketHome.find();  </TD></TR><TR><TD CLASS="l">3756</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3757</TD><TD>            catch (CBOELoggableException ex)</TD></TR><TR><TD CLASS="l">3758</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3759</TD><TD>                throw ExceptionBuilder.systemException(&#34;Failed to find market data service! &#34; + ex, 0);</TD></TR><TR><TD CLASS="l">3760</TD><TD>            }</TD></TR><TR><TD CLASS="l">3761</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3762</TD><TD>        return marketDataService;</TD></TR><TR><TD CLASS="l">3763</TD><TD>    }</TD></TR><TR><TD CLASS="l">3764</TD><TD>    </TD></TR><TR><TD CLASS="l">3765</TD><TD>    </TD></TR><TR><TD CLASS="l">3766</TD><TD> </TD></TR><TR><TD CLASS="l">3767</TD><TD>   </TD></TR><TR><TD CLASS="l">3768</TD><TD>    private MarketDetailStruct buildMarketDetailStructFromMarketData(MarketData p_productMarketData,</TD></TR><TR><TD CLASS="l"><A NAME="16">3769</A></TD><TD>                    DerivedQuote p_derivedQuote,</TD></TR><TR><TD CLASS="l">3770</TD><TD>                    short p_productType)</TD></TR><TR><TD CLASS="l">3771</TD><TD>    {</TD></TR><TR><TD CLASS="l">3772</TD><TD>     </TD></TR><TR CLASS="z"><TD CLASS="l">3773</TD><TD>        MarketDetailStruct ordMarketDataStructInfo = new MarketDetailStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">3774</TD><TD>        CurrentMarketStruct localCMSBestLmtPrice = null, localCMSBestPubMktPrice = null;</TD></TR><TR><TD CLASS="l">3775</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3776</TD><TD>        ordMarketDataStructInfo.productKey = p_productMarketData.getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">3777</TD><TD>        ordMarketDataStructInfo.productType = p_productType;</TD></TR><TR><TD CLASS="l">3778</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3779</TD><TD>        OrderBookImpl orderBook = null;</TD></TR><TR><TD CLASS="l">3780</TD><TD>        </TD></TR><TR><TD CLASS="l">3781</TD><TD>        try</TD></TR><TR><TD CLASS="l">3782</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3783</TD><TD>            orderBook = (OrderBookImpl) getOrderBook(p_productMarketData.getProductKey());</TD></TR><TR><TD CLASS="l">3784</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3785</TD><TD>        catch(Exception e)</TD></TR><TR><TD CLASS="l">3786</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3787</TD><TD>            Log.alarm(&#34;Toget Market information, Order book not found for the product key: &#34; + p_productMarketData.getProductKey() + &#34; going to use Market data for this product instead&#34;);</TD></TR><TR><TD CLASS="l">3788</TD><TD>        }</TD></TR><TR><TD CLASS="l">3789</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3790</TD><TD>        if(orderBook != null)</TD></TR><TR><TD CLASS="l">3791</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3792</TD><TD>            localCMSBestLmtPrice = orderBook.toBestLimitMarket(true);</TD></TR><TR><TD CLASS="l">3793</TD><TD>        }</TD></TR><TR><TD CLASS="l">3794</TD><TD>        else</TD></TR><TR><TD CLASS="l">3795</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3796</TD><TD>            localCMSBestLmtPrice = p_productMarketData.toBestLimitMarket() ;    //for cboe price</TD></TR><TR><TD CLASS="l">3797</TD><TD>        }</TD></TR><TR><TD CLASS="l">3798</TD><TD>       </TD></TR><TR><TD CLASS="l">3799</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3800</TD><TD>        ordMarketDataStructInfo.bboAskPrice = createLongPrice(localCMSBestLmtPrice.askPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">3801</TD><TD>        ordMarketDataStructInfo.bboAskSize = getMarketSizeOnSide(localCMSBestLmtPrice.askSizeSequence, false) ;</TD></TR><TR CLASS="z"><TD CLASS="l">3802</TD><TD>        ordMarketDataStructInfo.bboAskPriceType = (byte)localCMSBestLmtPrice.askPrice.type;       </TD></TR><TR CLASS="z"><TD CLASS="l">3803</TD><TD>        ordMarketDataStructInfo.bboBidPrice = createLongPrice(localCMSBestLmtPrice.bidPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">3804</TD><TD>        ordMarketDataStructInfo.bboBidSize = getMarketSizeOnSide(localCMSBestLmtPrice.bidSizeSequence, false) ;</TD></TR><TR CLASS="z"><TD CLASS="l">3805</TD><TD>        ordMarketDataStructInfo.bboBidPriceType = (byte)localCMSBestLmtPrice.bidPrice.type;</TD></TR><TR><TD CLASS="l">3806</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3807</TD><TD>        localCMSBestPubMktPrice = p_productMarketData.toBestPublicMarket() ;  //for top of book</TD></TR><TR><TD CLASS="l">3808</TD><TD>       </TD></TR><TR CLASS="z"><TD CLASS="l">3809</TD><TD>        ordMarketDataStructInfo.bookAskPrice = createLongPrice(localCMSBestPubMktPrice.askPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">3810</TD><TD>        ordMarketDataStructInfo.bookAskSize = getMarketSizeOnSide(localCMSBestPubMktPrice.askSizeSequence, true) ;</TD></TR><TR CLASS="z"><TD CLASS="l">3811</TD><TD>        ordMarketDataStructInfo.bookAskPriceType = (byte)localCMSBestPubMktPrice.askPrice.type;               </TD></TR><TR CLASS="z"><TD CLASS="l">3812</TD><TD>        ordMarketDataStructInfo.bookBidPrice = createLongPrice(localCMSBestPubMktPrice.bidPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">3813</TD><TD>        ordMarketDataStructInfo.bookBidSize = getMarketSizeOnSide(localCMSBestPubMktPrice.bidSizeSequence, true) ;</TD></TR><TR CLASS="z"><TD CLASS="l">3814</TD><TD>        ordMarketDataStructInfo.bookBidPriceType = (byte)localCMSBestPubMktPrice.bidPrice.type;</TD></TR><TR><TD CLASS="l">3815</TD><TD>        </TD></TR><TR><TD CLASS="l">3816</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3817</TD><TD>        BestQuote botr = p_productMarketData.getBOTR() ;  </TD></TR><TR CLASS="z"><TD CLASS="l">3818</TD><TD>        ordMarketDataStructInfo.botrAskExchanges = getBQStructExchangeDetailsAsString(botr, Sides.ASK);</TD></TR><TR CLASS="z"><TD CLASS="l">3819</TD><TD>        ordMarketDataStructInfo.botrAskPrice = createLongPrice(botr.getAskPrice());</TD></TR><TR CLASS="z"><TD CLASS="l">3820</TD><TD>        ordMarketDataStructInfo.botrBidExchanges = getBQStructExchangeDetailsAsString(botr, Sides.BID);       </TD></TR><TR CLASS="z"><TD CLASS="l">3821</TD><TD>        ordMarketDataStructInfo.botrBidPrice = createLongPrice(botr.getBidPrice()); </TD></TR><TR><TD CLASS="l">3822</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3823</TD><TD>        BestQuote nbbo = p_productMarketData.getNBBO()  ;</TD></TR><TR CLASS="z"><TD CLASS="l">3824</TD><TD>        ordMarketDataStructInfo.nbboAskExchanges = getBQStructExchangeDetailsAsString(nbbo, Sides.ASK);</TD></TR><TR CLASS="z"><TD CLASS="l">3825</TD><TD>        ordMarketDataStructInfo.nbboAskPrice = createLongPrice(nbbo.getAskPrice());</TD></TR><TR CLASS="z"><TD CLASS="l">3826</TD><TD>        ordMarketDataStructInfo.nbboBidExchanges = getBQStructExchangeDetailsAsString(nbbo, Sides.BID);  </TD></TR><TR CLASS="z"><TD CLASS="l">3827</TD><TD>        ordMarketDataStructInfo.nbboBidPrice = createLongPrice(nbbo.getBidPrice());</TD></TR><TR><TD CLASS="l">3828</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3829</TD><TD>        if (p_derivedQuote != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3830</TD><TD>                ordMarketDataStructInfo.dsmAskPrice = createLongPrice(p_derivedQuote.getAsk().getPrice());</TD></TR><TR CLASS="z"><TD CLASS="l">3831</TD><TD>                ordMarketDataStructInfo.dsmAskSize = p_derivedQuote.getAsk().getQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">3832</TD><TD>                ordMarketDataStructInfo.dsmAskPriceType = (byte)p_derivedQuote.getAsk().getPrice().toStruct().type;</TD></TR><TR CLASS="z"><TD CLASS="l">3833</TD><TD>                ordMarketDataStructInfo.dsmBidPrice = createLongPrice(p_derivedQuote.getBid().getPrice());</TD></TR><TR CLASS="z"><TD CLASS="l">3834</TD><TD>                ordMarketDataStructInfo.dsmBidSize = p_derivedQuote.getBid().getQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">3835</TD><TD>                ordMarketDataStructInfo.dsmBidPriceType = (byte)p_derivedQuote.getBid().getPrice().toStruct().type;</TD></TR><TR><TD CLASS="l">3836</TD><TD>        }</TD></TR><TR><TD CLASS="l">3837</TD><TD>        else {</TD></TR><TR><TD CLASS="l">3838</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">3839</TD><TD>                  ordMarketDataStructInfo.dsmAskPrice = 0; </TD></TR><TR CLASS="z"><TD CLASS="l">3840</TD><TD>              ordMarketDataStructInfo.dsmAskSize = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">3841</TD><TD>              ordMarketDataStructInfo.dsmAskPriceType = NO_PRICE;</TD></TR><TR CLASS="z"><TD CLASS="l">3842</TD><TD>              ordMarketDataStructInfo.dsmBidPrice = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3843</TD><TD>              ordMarketDataStructInfo.dsmBidSize = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3844</TD><TD>              ordMarketDataStructInfo.dsmBidPriceType = NO_PRICE;</TD></TR><TR><TD CLASS="l">3845</TD><TD>                </TD></TR><TR><TD CLASS="l">3846</TD><TD>        }</TD></TR><TR><TD CLASS="l">3847</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">3848</TD><TD>        ordMarketDataStructInfo.exchangeIndicators = ExchangeIndicatorHolder.toDatabaseString(p_productMarketData.getExchangeIndicators());</TD></TR><TR><TD CLASS="l">3849</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3850</TD><TD>        ordMarketDataStructInfo.activityTime = System.currentTimeMillis();</TD></TR><TR><TD CLASS="l">3851</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3852</TD><TD>        return ordMarketDataStructInfo ;</TD></TR><TR><TD CLASS="l">3853</TD><TD>    }    </TD></TR><TR><TD CLASS="l">3854</TD><TD>    </TD></TR><TR><TD CLASS="l">3855</TD><TD>    </TD></TR><TR><TD CLASS="l">3856</TD><TD>    private MarketDetailStruct buildMarketDetailStructFromCurrentMarketStruct(CurrentMarketStruct[] p_currentMarketStructs,</TD></TR><TR><TD CLASS="l"><A NAME="15">3857</A></TD><TD>                                                    NBBOStruct p_nbboStruct)</TD></TR><TR><TD CLASS="l">3858</TD><TD>    {</TD></TR><TR><TD CLASS="l">3859</TD><TD>     </TD></TR><TR><TD CLASS="l">3860</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3861</TD><TD>        CurrentMarketStruct localCMS = null;</TD></TR><TR><TD CLASS="l">3862</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3863</TD><TD>        MarketDetailStruct ordMarketDataStructInfo = new MarketDetailStruct();</TD></TR><TR><TD CLASS="l">3864</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3865</TD><TD>        localCMS = p_currentMarketStructs[CurrentMarketCache.CONTINGENT_CACHE];</TD></TR><TR><TD CLASS="l">3866</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3867</TD><TD>        ordMarketDataStructInfo.productKey = localCMS.productKeys.productKey;</TD></TR><TR CLASS="z"><TD CLASS="l">3868</TD><TD>        ordMarketDataStructInfo.productType = localCMS.productKeys.productType;</TD></TR><TR><TD CLASS="l">3869</TD><TD>        </TD></TR><TR><TD CLASS="l">3870</TD><TD>        //localCMS = productMarketData.toBestLimitMarket() ;    //for cboe price</TD></TR><TR><TD CLASS="l">3871</TD><TD>      </TD></TR><TR CLASS="z"><TD CLASS="l">3872</TD><TD>        ordMarketDataStructInfo.bboAskPrice = createLongPrice(localCMS.askPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">3873</TD><TD>        ordMarketDataStructInfo.bboAskSize = getMarketSizeOnSide(localCMS.askSizeSequence, false) ;</TD></TR><TR CLASS="z"><TD CLASS="l">3874</TD><TD>        ordMarketDataStructInfo.bboAskPriceType = (byte)localCMS.askPrice.type;       </TD></TR><TR CLASS="z"><TD CLASS="l">3875</TD><TD>        ordMarketDataStructInfo.bboBidPrice = createLongPrice(localCMS.bidPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">3876</TD><TD>        ordMarketDataStructInfo.bboBidSize = getMarketSizeOnSide(localCMS.bidSizeSequence, false) ;</TD></TR><TR CLASS="z"><TD CLASS="l">3877</TD><TD>        ordMarketDataStructInfo.bboBidPriceType = (byte)localCMS.bidPrice.type;</TD></TR><TR><TD CLASS="l">3878</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3879</TD><TD>        localCMS = p_currentMarketStructs[CurrentMarketCache.NONCONTINGENT_CACHE];</TD></TR><TR><TD CLASS="l">3880</TD><TD>        //localCMS = productMarketData.toBestPublicMarket() ;  //for top of book</TD></TR><TR><TD CLASS="l">3881</TD><TD>       </TD></TR><TR CLASS="z"><TD CLASS="l">3882</TD><TD>        ordMarketDataStructInfo.bookAskPrice = createLongPrice(localCMS.askPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">3883</TD><TD>        ordMarketDataStructInfo.bookAskSize = getMarketSizeOnSide(localCMS.askSizeSequence, true) ;</TD></TR><TR CLASS="z"><TD CLASS="l">3884</TD><TD>        ordMarketDataStructInfo.bookAskPriceType = (byte)localCMS.askPrice.type;       </TD></TR><TR CLASS="z"><TD CLASS="l">3885</TD><TD>        ordMarketDataStructInfo.bookBidPrice = createLongPrice(localCMS.bidPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">3886</TD><TD>        ordMarketDataStructInfo.bookBidSize = getMarketSizeOnSide(localCMS.bidSizeSequence, true) ;</TD></TR><TR CLASS="z"><TD CLASS="l">3887</TD><TD>        ordMarketDataStructInfo.bookBidPriceType = (byte)localCMS.bidPrice.type;</TD></TR><TR><TD CLASS="l">3888</TD><TD> </TD></TR><TR><TD CLASS="l">3889</TD><TD>       </TD></TR><TR><TD CLASS="l">3890</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3891</TD><TD>        ordMarketDataStructInfo.botrAskExchanges = &#34;&#34;;       </TD></TR><TR CLASS="z"><TD CLASS="l">3892</TD><TD>        ordMarketDataStructInfo.botrAskPrice = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3893</TD><TD>        ordMarketDataStructInfo.botrBidExchanges = &#34;&#34;;    </TD></TR><TR CLASS="z"><TD CLASS="l">3894</TD><TD>        ordMarketDataStructInfo.botrBidPrice = 0; </TD></TR><TR><TD CLASS="l">3895</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3896</TD><TD>        ordMarketDataStructInfo.nbboAskExchanges = getBQStructExchangeDetailsAsString(p_nbboStruct, Sides.ASK);</TD></TR><TR CLASS="z"><TD CLASS="l">3897</TD><TD>        ordMarketDataStructInfo.nbboAskPrice = createLongPrice(p_nbboStruct.askPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">3898</TD><TD>        ordMarketDataStructInfo.nbboBidExchanges = getBQStructExchangeDetailsAsString(p_nbboStruct, Sides.BID);</TD></TR><TR CLASS="z"><TD CLASS="l">3899</TD><TD>        ordMarketDataStructInfo.nbboBidPrice = createLongPrice(p_nbboStruct.bidPrice);</TD></TR><TR><TD CLASS="l">3900</TD><TD>        </TD></TR><TR><TD CLASS="l">3901</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3902</TD><TD>        ordMarketDataStructInfo.dsmAskPrice = 0; </TD></TR><TR CLASS="z"><TD CLASS="l">3903</TD><TD>        ordMarketDataStructInfo.dsmAskSize = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">3904</TD><TD>        ordMarketDataStructInfo.dsmAskPriceType = NO_PRICE;</TD></TR><TR CLASS="z"><TD CLASS="l">3905</TD><TD>        ordMarketDataStructInfo.dsmBidPrice = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3906</TD><TD>        ordMarketDataStructInfo.dsmBidSize = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3907</TD><TD>        ordMarketDataStructInfo.dsmBidPriceType = NO_PRICE;</TD></TR><TR><TD CLASS="l">3908</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3909</TD><TD>        ordMarketDataStructInfo.exchangeIndicators = &#34;&#34;;</TD></TR><TR><TD CLASS="l">3910</TD><TD>              </TD></TR><TR><TD CLASS="l">3911</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3912</TD><TD>        ordMarketDataStructInfo.activityTime = System.currentTimeMillis();</TD></TR><TR><TD CLASS="l">3913</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3914</TD><TD>        return ordMarketDataStructInfo ;</TD></TR><TR><TD CLASS="l">3915</TD><TD>    }    </TD></TR><TR><TD CLASS="l">3916</TD><TD>    </TD></TR><TR><TD CLASS="l">3917</TD><TD>    </TD></TR><TR><TD CLASS="l">3918</TD><TD>    /** </TD></TR><TR><TD CLASS="l">3919</TD><TD>     * Routine to convert price to long. Checks to see if it is valued price and if so converts it toLong.</TD></TR><TR><TD CLASS="l">3920</TD><TD>     * Else returns 0L.</TD></TR><TR><TD CLASS="l"><A NAME="2e">3921</A></TD><TD>     * @param p_price</TD></TR><TR><TD CLASS="l">3922</TD><TD>     * @return</TD></TR><TR><TD CLASS="l">3923</TD><TD>     */</TD></TR><TR><TD CLASS="l">3924</TD><TD>    private long createLongPrice(Price p_price) {</TD></TR><TR CLASS="z"><TD CLASS="l">3925</TD><TD>            if (p_price.isValuedPrice()) {</TD></TR><TR CLASS="z"><TD CLASS="l">3926</TD><TD>                    return p_price.toLong();</TD></TR><TR><TD CLASS="l">3927</TD><TD>            }</TD></TR><TR><TD CLASS="l">3928</TD><TD>            else {</TD></TR><TR CLASS="z"><TD CLASS="l">3929</TD><TD>                    return 0L;</TD></TR><TR><TD CLASS="l">3930</TD><TD>            }</TD></TR><TR><TD CLASS="l">3931</TD><TD>    }</TD></TR><TR><TD CLASS="l">3932</TD><TD>    </TD></TR><TR><TD CLASS="l">3933</TD><TD>    </TD></TR><TR><TD CLASS="l">3934</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3935</TD><TD>     * Routine to convert priceStruct to long.</TD></TR><TR><TD CLASS="l"><A NAME="2f">3936</A></TD><TD>     * @param p_priceStruct</TD></TR><TR><TD CLASS="l">3937</TD><TD>     * @return</TD></TR><TR><TD CLASS="l">3938</TD><TD>     */</TD></TR><TR><TD CLASS="l">3939</TD><TD>    private long createLongPrice(PriceStruct p_priceStruct) {</TD></TR><TR CLASS="z"><TD CLASS="l">3940</TD><TD>            Price price = PriceFactory.create(p_priceStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">3941</TD><TD>            return createLongPrice(price);</TD></TR><TR><TD CLASS="l"><A NAME="61">3942</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3943</TD><TD>    </TD></TR><TR><TD CLASS="l">3944</TD><TD>    private int getMarketSizeOnSide(MarketVolumeStruct[] sideSizeSequence, boolean topOfBook)</TD></TR><TR><TD CLASS="l">3945</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3946</TD><TD>        int sideVolume = 0 ;</TD></TR><TR><TD CLASS="l">3947</TD><TD>       </TD></TR><TR><TD CLASS="l">3948</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">3949</TD><TD>        for (int i = 0; i &lt; sideSizeSequence.length; i++)</TD></TR><TR><TD CLASS="l">3950</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3951</TD><TD>            short volumeType = sideSizeSequence[i].volumeType;</TD></TR><TR CLASS="z"><TD CLASS="l">3952</TD><TD>            if (isAllowedVolumeType(topOfBook, volumeType))</TD></TR><TR><TD CLASS="l">3953</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3954</TD><TD>                sideVolume += sideSizeSequence[i].quantity;</TD></TR><TR><TD CLASS="l">3955</TD><TD>            }</TD></TR><TR><TD CLASS="l">3956</TD><TD>        }</TD></TR><TR><TD CLASS="l">3957</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">3958</TD><TD>        return sideVolume;</TD></TR><TR><TD CLASS="l"><A NAME="a4">3959</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3960</TD><TD>    </TD></TR><TR><TD CLASS="l">3961</TD><TD>    private boolean isAllowedVolumeType(boolean topOfBook, short volumeType)</TD></TR><TR><TD CLASS="l">3962</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3963</TD><TD>        if(topOfBook)</TD></TR><TR><TD CLASS="l">3964</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3965</TD><TD>            if (volumeType == VolumeTypes.CUSTOMER_ORDER || volumeType == VolumeTypes.PROFESSIONAL_ORDER)</TD></TR><TR><TD CLASS="l">3966</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3967</TD><TD>                return true;</TD></TR><TR><TD CLASS="l">3968</TD><TD>            }</TD></TR><TR><TD CLASS="l">3969</TD><TD>        }</TD></TR><TR><TD CLASS="l">3970</TD><TD>        else</TD></TR><TR><TD CLASS="l">3971</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3972</TD><TD>            if (volumeType == VolumeTypes.LIMIT)</TD></TR><TR><TD CLASS="l">3973</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3974</TD><TD>                return true;</TD></TR><TR><TD CLASS="l">3975</TD><TD>            }</TD></TR><TR><TD CLASS="l">3976</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3977</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">3978</TD><TD>    }</TD></TR><TR><TD CLASS="l">3979</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="4a">3980</A></TD><TD>  </TD></TR><TR><TD CLASS="l">3981</TD><TD>    private String getBQStructExchangeDetailsAsString(BestQuote p_nbbo, char side)</TD></TR><TR><TD CLASS="l">3982</TD><TD>    {</TD></TR><TR><TD CLASS="l">3983</TD><TD>      </TD></TR><TR CLASS="z"><TD CLASS="l">3984</TD><TD>        if(side == Sides.ASK || side == Sides.SELL)</TD></TR><TR><TD CLASS="l">3985</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3986</TD><TD>                return getExchangeVolume(p_nbbo.getAskExchangeVolumes());</TD></TR><TR><TD CLASS="l">3987</TD><TD>            </TD></TR><TR><TD CLASS="l">3988</TD><TD>        }</TD></TR><TR><TD CLASS="l">3989</TD><TD>        else</TD></TR><TR><TD CLASS="l">3990</TD><TD>        {</TD></TR><TR><TD CLASS="l">3991</TD><TD>        // bid side</TD></TR><TR CLASS="z"><TD CLASS="l">3992</TD><TD>                return getExchangeVolume(p_nbbo.getBidExchangeVolumes());                       </TD></TR><TR><TD CLASS="l">3993</TD><TD>        }</TD></TR><TR><TD CLASS="l">3994</TD><TD>        </TD></TR><TR><TD CLASS="l"><A NAME="4b">3995</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3996</TD><TD>    </TD></TR><TR><TD CLASS="l">3997</TD><TD>    private String getBQStructExchangeDetailsAsString(NBBOStruct p_nbboStruct, char side) {</TD></TR><TR><TD CLASS="l">3998</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">3999</TD><TD>             if(side == Sides.ASK || side == Sides.SELL)</TD></TR><TR><TD CLASS="l">4000</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">4001</TD><TD>                 return getExchangeVolume(p_nbboStruct.askExchangeVolume);</TD></TR><TR><TD CLASS="l">4002</TD><TD>             </TD></TR><TR><TD CLASS="l">4003</TD><TD>         }</TD></TR><TR><TD CLASS="l">4004</TD><TD>         else</TD></TR><TR><TD CLASS="l">4005</TD><TD>         {</TD></TR><TR><TD CLASS="l">4006</TD><TD>         // bid side</TD></TR><TR CLASS="z"><TD CLASS="l">4007</TD><TD>                 return getExchangeVolume(p_nbboStruct.bidExchangeVolume);                       </TD></TR><TR><TD CLASS="l">4008</TD><TD>         }</TD></TR><TR><TD CLASS="l">4009</TD><TD>         </TD></TR><TR><TD CLASS="l">4010</TD><TD>            </TD></TR><TR><TD CLASS="l">4011</TD><TD>    }</TD></TR><TR><TD CLASS="l">4012</TD><TD>    </TD></TR><TR><TD CLASS="l">4013</TD><TD>    </TD></TR><TR><TD CLASS="l">4014</TD><TD>    /**</TD></TR><TR><TD CLASS="l">4015</TD><TD>     * Private function to return a string of exchanges and corresponding volumes.</TD></TR><TR><TD CLASS="l">4016</TD><TD>     * @param p_exchangeVolumeStruct</TD></TR><TR><TD CLASS="l"><A NAME="52">4017</A></TD><TD>     * @return</TD></TR><TR><TD CLASS="l">4018</TD><TD>     */</TD></TR><TR><TD CLASS="l">4019</TD><TD>    private String getExchangeVolume(ExchangeVolumeStruct[] p_exchangeVolumeStruct) {</TD></TR><TR><TD CLASS="l">4020</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">4021</TD><TD>        final String VOLUME_DELIMITER = &#34;/&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">4022</TD><TD>        StringBuffer exchanges = new StringBuffer();</TD></TR><TR CLASS="z"><TD CLASS="l">4023</TD><TD>            for (int i = 0; i &lt; p_exchangeVolumeStruct.length; i++)</TD></TR><TR><TD CLASS="l">4024</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4025</TD><TD>                    if (p_exchangeVolumeStruct != null)</TD></TR><TR><TD CLASS="l">4026</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4027</TD><TD>                    if (i != 0)</TD></TR><TR CLASS="z"><TD CLASS="l">4028</TD><TD>                        exchanges.append(VOLUME_DELIMITER);</TD></TR><TR CLASS="z"><TD CLASS="l">4029</TD><TD>                    exchanges.append(p_exchangeVolumeStruct[i].exchange);</TD></TR><TR CLASS="z"><TD CLASS="l">4030</TD><TD>                    exchanges.append(&#34;:&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">4031</TD><TD>                    exchanges.append(p_exchangeVolumeStruct[i].volume);</TD></TR><TR><TD CLASS="l">4032</TD><TD>            }</TD></TR><TR><TD CLASS="l">4033</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4034</TD><TD>        return exchanges.toString();</TD></TR><TR><TD CLASS="l">4035</TD><TD>            </TD></TR><TR><TD CLASS="l">4036</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="b2">4037</A></TD><TD>    </TD></TR><TR><TD CLASS="l">4038</TD><TD>    public void populateQuoteQueryV2StructFromBook(QuoteQueryV2Struct[] p_quoteQueryV2, String p_sessionName,</TD></TR><TR><TD CLASS="l">4039</TD><TD>                    int[] p_productKeys) throws SystemException, CommunicationException, DataValidationException, AuthorizationException</TD></TR><TR><TD CLASS="l">4040</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4041</TD><TD>        if (null == p_productKeys || p_productKeys.length == 0)</TD></TR><TR><TD CLASS="l">4042</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4043</TD><TD>            Log.information(this, &#34;Invalid productKeys==&#34; + p_productKeys);</TD></TR><TR CLASS="z"><TD CLASS="l">4044</TD><TD>            return;</TD></TR><TR><TD CLASS="l">4045</TD><TD>        }</TD></TR><TR><TD CLASS="l">4046</TD><TD>        </TD></TR><TR><TD CLASS="l">4047</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">4048</TD><TD>        QuoteQueryV2Struct[] quoteQueryV2ForException = new QuoteQueryV2Struct[1];</TD></TR><TR><TD CLASS="l">4049</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4050</TD><TD>        for(int i=0; i &lt; p_quoteQueryV2.length; i++) {    </TD></TR><TR><TD CLASS="l">4051</TD><TD>                try {</TD></TR><TR><TD CLASS="l">4052</TD><TD>                </TD></TR><TR><TD CLASS="l">4053</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4054</TD><TD>                OrderBookImpl book = (OrderBookImpl)getOrderBook(p_productKeys[i]);</TD></TR><TR><TD CLASS="l">4055</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">4056</TD><TD>                boolean indexHybridEnabled = book.getTradingProduct().getTradingClass().getIndexHybridIndicator();</TD></TR><TR><TD CLASS="l">4057</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">4058</TD><TD>                if(book.getTradingProduct().isStrategy() &amp;&amp; book.getTradingProduct().isProxy())</TD></TR><TR><TD CLASS="l">4059</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">4060</TD><TD>                        p_quoteQueryV2[i] = quoteQueryV2ForException[0];</TD></TR><TR><TD CLASS="l">4061</TD><TD>                }</TD></TR><TR><TD CLASS="l">4062</TD><TD>                else </TD></TR><TR><TD CLASS="l">4063</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">4064</TD><TD>                    CurrentMarketStruct currentMarketStruct = book.toBestLimitMarket(true);</TD></TR><TR><TD CLASS="l">4065</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4066</TD><TD>                    if(indexHybridEnabled) </TD></TR><TR><TD CLASS="l">4067</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">4068</TD><TD>                        OrderBookEditor orderBookEditor = book.getOrderBookEditor();</TD></TR><TR CLASS="z"><TD CLASS="l">4069</TD><TD>                        ManualQuoteBook manualQuoteBook = book.getManualQuoteBook();</TD></TR><TR CLASS="z"><TD CLASS="l">4070</TD><TD>                        currentMarketStruct = orderBookEditor.combineManualQuoteMarket(currentMarketStruct, manualQuoteBook,VolumeTypes.LIMIT );</TD></TR><TR><TD CLASS="l">4071</TD><TD>                    }</TD></TR><TR><TD CLASS="l">4072</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">4073</TD><TD>                        populateCurrentMarketStruct(currentMarketStruct, p_quoteQueryV2[i].quoteQueryStruct.bestmarketCurrentMarketStruct);</TD></TR><TR><TD CLASS="l">4074</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">4075</TD><TD>                        currentMarketStruct = book.toBestPublicMarket(true);</TD></TR><TR><TD CLASS="l">4076</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">4077</TD><TD>                    MarketData mktData = getMarketDataHome().findByProduct(p_sessionName, p_productKeys[i] );</TD></TR><TR><TD CLASS="l">4078</TD><TD>                    </TD></TR><TR CLASS="z"><TD CLASS="l">4079</TD><TD>                        if(currentMarketStruct == null)</TD></TR><TR><TD CLASS="l">4080</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">4081</TD><TD>                            currentMarketStruct = mktData.toBestPublicMarket();</TD></TR><TR><TD CLASS="l">4082</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">4083</TD><TD>                        populateCurrentMarketStruct(currentMarketStruct, p_quoteQueryV2[i].quoteQueryStruct.bestmarketPublicCurrentMarketStruct);</TD></TR><TR><TD CLASS="l">4084</TD><TD>                        </TD></TR><TR><TD CLASS="l">4085</TD><TD>                                                                               </TD></TR><TR CLASS="z"><TD CLASS="l">4086</TD><TD>                        NBBOStruct botrStruct = book.getTradingProduct().getBOTR(p_sessionName);                        </TD></TR><TR CLASS="z"><TD CLASS="l">4087</TD><TD>                        populateNbboStruct(botrStruct, p_quoteQueryV2[i].quoteQueryStruct.botrStruct);</TD></TR><TR><TD CLASS="l">4088</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">4089</TD><TD>                        botrStruct = book.getTradingProduct().getNBBO(p_sessionName);    </TD></TR><TR CLASS="z"><TD CLASS="l">4090</TD><TD>                        populateNbboStruct(botrStruct, p_quoteQueryV2[i].nbboStruct);</TD></TR><TR><TD CLASS="l">4091</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">4092</TD><TD>                        p_quoteQueryV2[i].quoteQueryStruct.exchangeIndicators = mktData.getExchangeIndicators();</TD></TR><TR><TD CLASS="l">4093</TD><TD>                        </TD></TR><TR><TD CLASS="l">4094</TD><TD>                        </TD></TR><TR><TD CLASS="l">4095</TD><TD>            }</TD></TR><TR><TD CLASS="l">4096</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4097</TD><TD>            catch (Exception exe) {</TD></TR><TR CLASS="z"><TD CLASS="l">4098</TD><TD>                        p_quoteQueryV2[i] = quoteQueryV2ForException[0];</TD></TR><TR><TD CLASS="l">4099</TD><TD>            }</TD></TR><TR><TD CLASS="l">4100</TD><TD>                </TD></TR><TR><TD CLASS="l">4101</TD><TD>       </TD></TR><TR><TD CLASS="l">4102</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="b0">4103</A></TD><TD>   </TD></TR><TR CLASS="z"><TD CLASS="l">4104</TD><TD>    }</TD></TR><TR><TD CLASS="l">4105</TD><TD>    </TD></TR><TR><TD CLASS="l">4106</TD><TD>    private void populateCurrentMarketStruct(CurrentMarketStruct p_src, CurrentMarketStruct p_dest) {    </TD></TR><TR CLASS="z"><TD CLASS="l">4107</TD><TD>            p_dest.askIsMarketBest = p_src.askIsMarketBest;</TD></TR><TR CLASS="z"><TD CLASS="l">4108</TD><TD>            p_dest.askPrice = p_src.askPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">4109</TD><TD>            p_dest.askSizeSequence = p_src.askSizeSequence;</TD></TR><TR CLASS="z"><TD CLASS="l">4110</TD><TD>            p_dest.bidIsMarketBest = p_src.bidIsMarketBest;</TD></TR><TR CLASS="z"><TD CLASS="l">4111</TD><TD>            p_dest.bidPrice =  p_src.bidPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">4112</TD><TD>            p_dest.bidSizeSequence = p_src.bidSizeSequence;   </TD></TR><TR><TD CLASS="l">4113</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">4114</TD><TD>            p_dest.exchange = p_src.exchange;                </TD></TR><TR CLASS="z"><TD CLASS="l">4115</TD><TD>            p_dest.legalMarket = p_src.legalMarket; </TD></TR><TR CLASS="z"><TD CLASS="l">4116</TD><TD>            p_dest.productKeys = p_src.productKeys;</TD></TR><TR CLASS="z"><TD CLASS="l">4117</TD><TD>            p_dest.sentTime = p_src.sentTime;</TD></TR><TR CLASS="z"><TD CLASS="l">4118</TD><TD>            p_dest.sessionName = p_src.sessionName;</TD></TR><TR><TD CLASS="l"><A NAME="b1">4119</A></TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">4120</TD><TD>     }</TD></TR><TR><TD CLASS="l">4121</TD><TD>    </TD></TR><TR><TD CLASS="l">4122</TD><TD>    private void populateNbboStruct(NBBOStruct p_src, NBBOStruct p_dest) {</TD></TR><TR CLASS="z"><TD CLASS="l">4123</TD><TD>            p_dest.productKeys = p_src.productKeys;</TD></TR><TR CLASS="z"><TD CLASS="l">4124</TD><TD>            p_dest.sentTime = p_src.sentTime;</TD></TR><TR CLASS="z"><TD CLASS="l">4125</TD><TD>            p_dest.bidPrice =  p_src.bidPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">4126</TD><TD>            p_dest.bidExchangeVolume = p_src.bidExchangeVolume;   </TD></TR><TR CLASS="z"><TD CLASS="l">4127</TD><TD>            p_dest.askPrice =  p_src.askPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">4128</TD><TD>            p_dest.askExchangeVolume = p_src.askExchangeVolume;   </TD></TR><TR CLASS="z"><TD CLASS="l">4129</TD><TD>    }</TD></TR><TR><TD CLASS="l">4130</TD><TD>    </TD></TR><TR><TD CLASS="l">4131</TD><TD> </TD></TR><TR><TD CLASS="l">4132</TD><TD>    /**</TD></TR><TR><TD CLASS="l">4133</TD><TD>     * Returns the &lt;code&gt;BrokerHome&lt;/code&gt;.  If the home has not yet been retrieved,</TD></TR><TR><TD CLASS="l">4134</TD><TD>     * it will go and get it.</TD></TR><TR><TD CLASS="l">4135</TD><TD>     *</TD></TR><TR><TD CLASS="l">4136</TD><TD>     * @return      BrokerHome if it is able to be retrieved from the</TD></TR><TR><TD CLASS="l"><A NAME="6a">4137</A></TD><TD>     *              &lt;code&gt;HomeFactory&lt;/code&gt;. or &lt;code&gt;null&lt;/code&gt; if it cannot be retrieved.</TD></TR><TR><TD CLASS="l">4138</TD><TD>     * @since Increment 2</TD></TR><TR><TD CLASS="l">4139</TD><TD>     */</TD></TR><TR><TD CLASS="l">4140</TD><TD>    protected OrderBookHome getOrderBookHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">4141</TD><TD>        if (cachedOrderBookHome == null) {</TD></TR><TR><TD CLASS="l">4142</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">4143</TD><TD>                cachedOrderBookHome = (OrderBookHome) HomeFactory.getInstance().findHome(OrderBookHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">4144</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4145</TD><TD>            catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">4146</TD><TD>                Log.alarm(&#34;BrokerProcessorBase &gt;&gt;&gt; Exception occured while BrokerService was retrieving OrderBookHome&#34;);</TD></TR><TR><TD CLASS="l">4147</TD><TD>            }</TD></TR><TR><TD CLASS="l">4148</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4149</TD><TD>        return cachedOrderBookHome;</TD></TR><TR><TD CLASS="l">4150</TD><TD>    }</TD></TR><TR><TD CLASS="l">4151</TD><TD>    </TD></TR><TR><TD CLASS="l">4152</TD><TD>    /**</TD></TR><TR><TD CLASS="l">4153</TD><TD>     * Retrieves the &lt;code&gt;OrderBook&lt;/code&gt; for the given product from the</TD></TR><TR><TD CLASS="l">4154</TD><TD>     * &lt;code&gt;OrderBookHome&lt;/code&gt;.  If the book cannot be found, an</TD></TR><TR><TD CLASS="l">4155</TD><TD>     * UnknownProductException is thrown.</TD></TR><TR><TD CLASS="l">4156</TD><TD>     *</TD></TR><TR><TD CLASS="l">4157</TD><TD>     * @param productKey        Integer value for the product</TD></TR><TR><TD CLASS="l">4158</TD><TD>     * @return                  OrderBook for the specified product.</TD></TR><TR><TD CLASS="l">4159</TD><TD>     * @exception               DataValidationException if the &lt;code&gt;OrderBook&lt;/code&gt;</TD></TR><TR><TD CLASS="l"><A NAME="69">4160</A></TD><TD>     *                          cannot be found for the product.</TD></TR><TR><TD CLASS="l">4161</TD><TD>     * @since               Increment 2</TD></TR><TR><TD CLASS="l">4162</TD><TD>     */</TD></TR><TR><TD CLASS="l">4163</TD><TD>    protected OrderBook getOrderBook(int productKey) throws DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">4164</TD><TD>        OrderBookHome orderBookHome = getOrderBookHome();</TD></TR><TR CLASS="z"><TD CLASS="l">4165</TD><TD>        if (orderBookHome != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">4166</TD><TD>            OrderBook orderBook = orderBookHome.find(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">4167</TD><TD>            if (orderBook != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">4168</TD><TD>                return orderBook;</TD></TR><TR><TD CLASS="l">4169</TD><TD>            }</TD></TR><TR><TD CLASS="l">4170</TD><TD>        }</TD></TR><TR><TD CLASS="l">4171</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4172</TD><TD>        throw ExceptionBuilder.dataValidationException(&#34;Broker unable to find order book for product: &#34; + productKey,</TD></TR><TR CLASS="z"><TD CLASS="l">4173</TD><TD>                                                       DataValidationCodes.INVALID_PRODUCT);</TD></TR><TR><TD CLASS="l">4174</TD><TD>    }</TD></TR><TR><TD CLASS="l">4175</TD><TD> </TD></TR><TR><TD CLASS="l">4176</TD><TD> </TD></TR><TR><TD CLASS="l">4177</TD><TD> </TD></TR><TR><TD CLASS="l">4178</TD><TD>    </TD></TR><TR><TD CLASS="l">4179</TD><TD>    /**</TD></TR><TR><TD CLASS="l">4180</TD><TD>     * Getter for TradingClassHome.</TD></TR><TR><TD CLASS="l"><A NAME="87">4181</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">4182</TD><TD>     * @return TradingClassHome</TD></TR><TR><TD CLASS="l">4183</TD><TD>     */</TD></TR><TR><TD CLASS="l">4184</TD><TD>    private TradingClassHome getTradingClassHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">4185</TD><TD>        if (myTradingClassHome == null) {</TD></TR><TR><TD CLASS="l">4186</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">4187</TD><TD>                myTradingClassHome = (TradingClassHome) HomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">4188</TD><TD>                        .getInstance().findHome(TradingClassHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">4189</TD><TD>            } catch (CBOELoggableException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">4190</TD><TD>                Log.alarm(this, &#34;Unable to find TradingClassHome&#34;);</TD></TR><TR><TD CLASS="l">4191</TD><TD>            }</TD></TR><TR><TD CLASS="l">4192</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4193</TD><TD>        return myTradingClassHome;</TD></TR><TR><TD CLASS="l"><A NAME="a7">4194</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4195</TD><TD> </TD></TR><TR><TD CLASS="l">4196</TD><TD>    protected boolean isGOrder(Order order) {</TD></TR><TR><TD CLASS="l">4197</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">4198</TD><TD>            if (cancelOnFailoverCloseHaltLogOutCodes != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">4199</TD><TD>                for (int i = 0; i &lt; cancelOnFailoverCloseHaltLogOutCodes.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">4200</TD><TD>                    if (order.getOrderOriginType() == cancelOnFailoverCloseHaltLogOutCodes[i].charAt(0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">4201</TD><TD>                        return true;</TD></TR><TR><TD CLASS="l">4202</TD><TD>                    }</TD></TR><TR><TD CLASS="l">4203</TD><TD>                }</TD></TR><TR><TD CLASS="l">4204</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4205</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">4206</TD><TD>            Log.alarm(&#34;OrderHomeImpl &gt;&gt;&gt;&gt; cancelOnFailoverCloseHaltLogOutCodes defined incorrectly: &#34; + e);</TD></TR><TR><TD CLASS="l">4207</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4208</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">4209</TD><TD>    }</TD></TR><TR><TD CLASS="l">4210</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="a8">4211</A></TD><TD>    </TD></TR><TR><TD CLASS="l">4212</TD><TD> </TD></TR><TR><TD CLASS="l">4213</TD><TD>    protected static boolean isGOrder(OrderHandlingStruct order) {</TD></TR><TR><TD CLASS="l">4214</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">4215</TD><TD>            if (cancelOnFailoverCloseHaltLogOutCodes != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">4216</TD><TD>                for (int i = 0; i &lt; cancelOnFailoverCloseHaltLogOutCodes.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">4217</TD><TD>                    if (order.orderOriginType == cancelOnFailoverCloseHaltLogOutCodes[i].charAt(0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">4218</TD><TD>                        return true;</TD></TR><TR><TD CLASS="l">4219</TD><TD>                    }</TD></TR><TR><TD CLASS="l">4220</TD><TD>                }</TD></TR><TR><TD CLASS="l">4221</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4222</TD><TD>        } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">4223</TD><TD>            Log.alarm(&#34;OrderHomeImpl &gt;&gt;&gt;&gt; cancelOnFailoverCloseHaltLogOutCodes defined incorrectly: &#34; + e);</TD></TR><TR><TD CLASS="l">4224</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4225</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">4226</TD><TD>    }</TD></TR><TR><TD CLASS="l">4227</TD><TD>    </TD></TR><TR><TD CLASS="l">4228</TD><TD>    /**</TD></TR><TR><TD CLASS="l">4229</TD><TD>     * </TD></TR><TR><TD CLASS="l">4230</TD><TD>     * @return the preferred linkage router vendor for the order or null if its not included</TD></TR><TR><TD CLASS="l">4231</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="79">4232</A></TD><TD>    protected String getPreferedRouterVendor( OrderStruct orderStruct )</TD></TR><TR><TD CLASS="l">4233</TD><TD>    {  </TD></TR><TR><TD CLASS="l">4234</TD><TD>        try</TD></TR><TR><TD CLASS="l">4235</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4236</TD><TD>            ExtensionsHelper helper = new ExtensionsHelper();</TD></TR><TR><TD CLASS="l">4237</TD><TD>            // TODO Define a  OptionalDataFields.DEFAULT_SEPARATOR and use it</TD></TR><TR CLASS="z"><TD CLASS="l">4238</TD><TD>            helper.setFieldDelimiter(&#34;;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">4239</TD><TD>            helper.setExtensions(orderStruct.optionalData);</TD></TR><TR CLASS="z"><TD CLASS="l">4240</TD><TD>            String preferedRouter = helper.getValue(ExtensionFields.BROKER_ROUTING_ID);</TD></TR><TR CLASS="z"><TD CLASS="l">4241</TD><TD>            if (preferedRouter != null )</TD></TR><TR CLASS="z"><TD CLASS="l">4242</TD><TD>                return preferedRouter;</TD></TR><TR><TD CLASS="l">4243</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4244</TD><TD>        catch(Exception e)</TD></TR><TR><TD CLASS="l">4245</TD><TD>        {   </TD></TR><TR CLASS="z"><TD CLASS="l">4246</TD><TD>            Log.information(this, &#34;Could not extract prefered linkage router from optional data for Order &#34; + orderStruct.orderId );</TD></TR><TR><TD CLASS="l">4247</TD><TD>        }   </TD></TR><TR CLASS="z"><TD CLASS="l">4248</TD><TD>        return null;</TD></TR><TR><TD CLASS="l">4249</TD><TD>    }</TD></TR><TR><TD CLASS="l">4250</TD><TD>    </TD></TR><TR><TD CLASS="l">4251</TD><TD>    /*</TD></TR><TR><TD CLASS="l">4252</TD><TD>     * Clearing firm number should be defined in the FillReport Extensions field for linkage fill</TD></TR><TR><TD CLASS="l">4253</TD><TD>     * </TD></TR><TR><TD CLASS="l">4254</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="4e">4255</A></TD><TD>    private String getClearingFirmNumForLinkageFill(FilledReportStruct filledReport) </TD></TR><TR><TD CLASS="l">4256</TD><TD>    {</TD></TR><TR><TD CLASS="l">4257</TD><TD>        try</TD></TR><TR><TD CLASS="l">4258</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4259</TD><TD>            return ExtensionsFieldParser.getFirmNumber(filledReport);</TD></TR><TR><TD CLASS="l">4260</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4261</TD><TD>        catch(DataValidationException e)</TD></TR><TR><TD CLASS="l">4262</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4263</TD><TD>            Log.information(this, &#34;Cannot get Clearing Firm number from Fill Report, will use clearing firm from NBBOAgent Profile&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">4264</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">4265</TD><TD>        }</TD></TR><TR><TD CLASS="l">4266</TD><TD>    }</TD></TR><TR><TD CLASS="l">4267</TD><TD>    </TD></TR><TR><TD CLASS="l">4268</TD><TD>    /*</TD></TR><TR><TD CLASS="l">4269</TD><TD>     * Obtain Outbound Vendor from a Fill Report</TD></TR><TR><TD CLASS="l">4270</TD><TD>     * </TD></TR><TR><TD CLASS="l">4271</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="78">4272</A></TD><TD>    private String getOutboundVendorForLinkageFill(FilledReportStruct filledReport) </TD></TR><TR><TD CLASS="l">4273</TD><TD>    {</TD></TR><TR><TD CLASS="l">4274</TD><TD>        try</TD></TR><TR><TD CLASS="l">4275</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4276</TD><TD>            return ExtensionsFieldParser.getOutboundVendor(filledReport);</TD></TR><TR><TD CLASS="l">4277</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4278</TD><TD>        catch(DataValidationException e)</TD></TR><TR><TD CLASS="l">4279</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4280</TD><TD>            Log.information(this, &#34;Cannot get Outbound Vendor from Fill Report&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">4281</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">4282</TD><TD>        }</TD></TR><TR><TD CLASS="l">4283</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="54">4284</A></TD><TD>    </TD></TR><TR><TD CLASS="l">4285</TD><TD>    </TD></TR><TR><TD CLASS="l">4286</TD><TD>    public OrderStatusConsumer getExtOrderStatusPublisher()</TD></TR><TR><TD CLASS="l">4287</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4288</TD><TD>        if (extOrderStatusPublisher == null) </TD></TR><TR><TD CLASS="l">4289</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4290</TD><TD>                extOrderStatusPublisher = EventHomes.getExternalOrderStatusConsumerHome().find();</TD></TR><TR><TD CLASS="l">4291</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4292</TD><TD>        return extOrderStatusPublisher;</TD></TR><TR><TD CLASS="l"><A NAME="4d">4293</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4294</TD><TD>    </TD></TR><TR><TD CLASS="l">4295</TD><TD>    public CancelReportChannelSelectorHome getCancelReportChannelSelectorHome()</TD></TR><TR><TD CLASS="l">4296</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4297</TD><TD>        if (cancelReportChannelSelectorHome == null) </TD></TR><TR><TD CLASS="l">4298</TD><TD>        {</TD></TR><TR><TD CLASS="l">4299</TD><TD>            try</TD></TR><TR><TD CLASS="l">4300</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">4301</TD><TD>                cancelReportChannelSelectorHome = (CancelReportChannelSelectorHome) HomeFactory</TD></TR><TR CLASS="z"><TD CLASS="l">4302</TD><TD>                .getInstance().findHome(CancelReportChannelSelectorHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">4303</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4304</TD><TD>            catch (CBOELoggableException e)</TD></TR><TR><TD CLASS="l">4305</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">4306</TD><TD>                Log.alarm(&#34;OrderHomeImpl &gt;&gt;&gt;&gt; cancelReportChannelSelectorHome is not Found: &#34; + e);</TD></TR><TR><TD CLASS="l">4307</TD><TD>            }</TD></TR><TR><TD CLASS="l">4308</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4309</TD><TD>        return cancelReportChannelSelectorHome;</TD></TR><TR><TD CLASS="l">4310</TD><TD>    }</TD></TR><TR><TD CLASS="l">4311</TD><TD>    </TD></TR><TR><TD CLASS="l">4312</TD><TD>    /**</TD></TR><TR><TD CLASS="l">4313</TD><TD>     * Returns the SALExclusion origina codes for Bob Classes</TD></TR><TR><TD CLASS="l"><A NAME="51">4314</A></TD><TD>     * @return List</TD></TR><TR><TD CLASS="l">4315</TD><TD>     */</TD></TR><TR><TD CLASS="l">4316</TD><TD>    protected String[] getCustomerTypeOriginCodesForBobClasses()</TD></TR><TR><TD CLASS="l">4317</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4318</TD><TD>        return customerTypeOriginCodesForBobClasses;</TD></TR><TR><TD CLASS="l"><A NAME="14">4319</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4320</TD><TD>    </TD></TR><TR><TD CLASS="l">4321</TD><TD>    private ManualQuote buildManualQuoteFromExtensions(OrderHandlingStruct orderStruct, String extensions)</TD></TR><TR><TD CLASS="l">4322</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4323</TD><TD>        String locationId = null;</TD></TR><TR CLASS="z"><TD CLASS="l">4324</TD><TD>        String ipAddress = null;</TD></TR><TR CLASS="z"><TD CLASS="l">4325</TD><TD>        String parId = null;</TD></TR><TR><TD CLASS="l">4326</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">4327</TD><TD>            parId = ExtensionsFieldParser.getParId(extensions);</TD></TR><TR CLASS="z"><TD CLASS="l">4328</TD><TD>            ipAddress = ExtensionsFieldParser.getIpAddress(extensions).trim();</TD></TR><TR CLASS="z"><TD CLASS="l">4329</TD><TD>            if (ipAddress.length() &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">4330</TD><TD>                locationId = ExtensionsFieldParser.getLocationId(extensions).trim();</TD></TR><TR CLASS="z"><TD CLASS="l">4331</TD><TD>                if (locationId.length() == 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">4332</TD><TD>                    locationId = getLocationId(ipAddress);</TD></TR><TR><TD CLASS="l">4333</TD><TD>                }</TD></TR><TR><TD CLASS="l">4334</TD><TD>            }</TD></TR><TR><TD CLASS="l">4335</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">4336</TD><TD>         catch (Exception exe) {</TD></TR><TR CLASS="z"><TD CLASS="l">4337</TD><TD>             Log.information(this, &#34;Invalid Manual Quote on the order extensions:orderId &#34; + extensions + &#34;:&#34; + orderStruct.orderId.toString());</TD></TR><TR><TD CLASS="l">4338</TD><TD>         }</TD></TR><TR><TD CLASS="l">4339</TD><TD>  </TD></TR><TR CLASS="z"><TD CLASS="l">4340</TD><TD>         return new ManualQuoteImpl(orderStruct, locationId, ipAddress, parId);</TD></TR><TR><TD CLASS="l"><A NAME="5c">4341</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4342</TD><TD>      </TD></TR><TR><TD CLASS="l">4343</TD><TD>    public String getLocationId(String ipAddress) throws SystemException, AuthorizationException, CommunicationException</TD></TR><TR><TD CLASS="l">4344</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4345</TD><TD>        String result = DEFAULT_LOCATION_ID;</TD></TR><TR CLASS="z"><TD CLASS="l">4346</TD><TD>        PropertyGroupStruct existingPropertyGroupStruct = null;</TD></TR><TR CLASS="z"><TD CLASS="l">4347</TD><TD>        PropertyServicePropertyGroup propertyServicePropertyGroup = null ;</TD></TR><TR><TD CLASS="l">4348</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">4349</TD><TD>        if (ipAddress != null &amp;&amp; ipAddress.trim().length() &gt; 0)</TD></TR><TR><TD CLASS="l">4350</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4351</TD><TD>            if (getPropertyServiceFacade() == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">4352</TD><TD>                Log.alarm(&#34;ORDImpl :getLocationId could not find PropertyServiceFacade.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">4353</TD><TD>                return result;</TD></TR><TR><TD CLASS="l">4354</TD><TD>            }</TD></TR><TR><TD CLASS="l">4355</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">4356</TD><TD>                propertyServicePropertyGroup = getPropertyServiceFacade().getPropertyGroup(PropertyCategoryTypes.TCLOC, ipAddress) ;</TD></TR><TR CLASS="z"><TD CLASS="l">4357</TD><TD>                existingPropertyGroupStruct = propertyServicePropertyGroup.getStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">4358</TD><TD>                if (existingPropertyGroupStruct != null)</TD></TR><TR><TD CLASS="l">4359</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">4360</TD><TD>                    if (existingPropertyGroupStruct.preferenceSequence != null &amp;&amp; existingPropertyGroupStruct.preferenceSequence.length != 0 )</TD></TR><TR><TD CLASS="l">4361</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">4362</TD><TD>                        if (existingPropertyGroupStruct.preferenceSequence[0] != null)</TD></TR><TR><TD CLASS="l">4363</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">4364</TD><TD>                            result = existingPropertyGroupStruct.preferenceSequence[0].value;</TD></TR><TR><TD CLASS="l">4365</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">4366</TD><TD>                        Log.information(&#34;ORDImpl :getLocationId location Id for ipAddress =&#34; + ipAddress+ &#34; location id = &#34; + result );</TD></TR><TR><TD CLASS="l">4367</TD><TD>                    }</TD></TR><TR><TD CLASS="l">4368</TD><TD>                }</TD></TR><TR><TD CLASS="l">4369</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4370</TD><TD>            catch(NotFoundException e) {</TD></TR><TR><TD CLASS="l">4371</TD><TD>               // no locationId exist for ipAddress</TD></TR><TR CLASS="z"><TD CLASS="l">4372</TD><TD>                Log.information(&#34;ORDImpl :getLocationId creating a default location for ipAddress =&#34; + ipAddress);</TD></TR><TR><TD CLASS="l">4373</TD><TD>            }</TD></TR><TR><TD CLASS="l">4374</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4375</TD><TD>        return result;</TD></TR><TR><TD CLASS="l"><A NAME="7e">4376</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4377</TD><TD>  </TD></TR><TR><TD CLASS="l">4378</TD><TD>    protected PropertyServiceFacade getPropertyServiceFacade()</TD></TR><TR><TD CLASS="l">4379</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4380</TD><TD>        return PropertyServiceFacadeHome.find();</TD></TR><TR><TD CLASS="l"><A NAME="bf">4381</A></TD><TD>    }   </TD></TR><TR><TD CLASS="l">4382</TD><TD>    </TD></TR><TR><TD CLASS="l">4383</TD><TD>    public static void setSessionDataFromOrderHandlingExtension(Order anOrder,NameValueStruct[] orderExtensions)</TD></TR><TR><TD CLASS="l">4384</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4385</TD><TD>        if(orderExtensions != null)</TD></TR><TR><TD CLASS="l">4386</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4387</TD><TD>            ((OrderImpl)anOrder).setBypassReflection(true);</TD></TR><TR CLASS="z"><TD CLASS="l">4388</TD><TD>            anOrder.setTotalPrice(OrderHandlingExtensions.getOrderTotalPrice(orderExtensions));</TD></TR><TR CLASS="z"><TD CLASS="l">4389</TD><TD>            anOrder.setTotalSessionPrice(OrderHandlingExtensions.getOrderTotalSessionPrice(orderExtensions));</TD></TR><TR CLASS="z"><TD CLASS="l">4390</TD><TD>            anOrder.setTotalSessionTradedQuantity(OrderHandlingExtensions.getOrderTotalSessionTradedQty(orderExtensions));</TD></TR><TR CLASS="z"><TD CLASS="l">4391</TD><TD>            anOrder.setTotalSessionCancelledQuantity(OrderHandlingExtensions.getOrderTotalSessionCancelledQty(orderExtensions));</TD></TR><TR CLASS="z"><TD CLASS="l">4392</TD><TD>            anOrder.setUserContingencyType(OrderHandlingExtensions.getOrderContingencyType(orderExtensions));</TD></TR><TR CLASS="z"><TD CLASS="l">4393</TD><TD>            ((OrderImpl)anOrder).setBypassReflection(false);</TD></TR><TR><TD CLASS="l">4394</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="39">4395</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4396</TD><TD> </TD></TR><TR><TD CLASS="l">4397</TD><TD>    public final IntMap&lt;List&lt;Order&gt;&gt; findClassesWithQuoteLikeOrderFromUser(String p_userId)</TD></TR><TR><TD CLASS="l">4398</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4399</TD><TD>        final IntMap&lt;List&lt;Order&gt;&gt; orders = new IntHashMap&lt;List&lt;Order&gt;&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">4400</TD><TD>        List&lt;Order&gt; ordersPerClass = null;</TD></TR><TR CLASS="z"><TD CLASS="l">4401</TD><TD>        if (quoteLikeOrdersCache != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">4402</TD><TD>            for (int prodKey : quoteLikeOrdersCache.keySet()) {</TD></TR><TR><TD CLASS="l">4403</TD><TD>                try</TD></TR><TR><TD CLASS="l">4404</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">4405</TD><TD>                   int classKey = getProductDataCacheHome().find().getProductData(prodKey).getClassKey();</TD></TR><TR CLASS="z"><TD CLASS="l">4406</TD><TD>                   ordersPerClass = orders.get(classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">4407</TD><TD>                   if (ordersPerClass==null)</TD></TR><TR><TD CLASS="l">4408</TD><TD>                   {</TD></TR><TR CLASS="z"><TD CLASS="l">4409</TD><TD>                       ordersPerClass = new ArrayList&lt;Order&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">4410</TD><TD>                       orders.put(classKey, ordersPerClass);</TD></TR><TR><TD CLASS="l">4411</TD><TD>                   }</TD></TR><TR CLASS="z"><TD CLASS="l">4412</TD><TD>                   Iterator quoteLikeOrderIter = quoteLikeOrdersCache.get(prodKey).values().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">4413</TD><TD>                   while(quoteLikeOrderIter.hasNext())  //Iterate through all the Orders to find orders for this userId.</TD></TR><TR><TD CLASS="l">4414</TD><TD>                   {</TD></TR><TR CLASS="z"><TD CLASS="l">4415</TD><TD>                       Order currentOrder = (Order) quoteLikeOrderIter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">4416</TD><TD>                       if(currentOrder.getUserId().equals(p_userId))</TD></TR><TR><TD CLASS="l">4417</TD><TD>                       {</TD></TR><TR CLASS="z"><TD CLASS="l">4418</TD><TD>                           ordersPerClass.add(currentOrder);</TD></TR><TR><TD CLASS="l">4419</TD><TD>                       }</TD></TR><TR><TD CLASS="l">4420</TD><TD>                   }</TD></TR><TR><TD CLASS="l">4421</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">4422</TD><TD>                catch (Exception e)</TD></TR><TR><TD CLASS="l">4423</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">4424</TD><TD>                    Log.exception(&#34;findQuoteLikeOrdersForUser(userId, classKey)::Exception on finding class data on prodKey::&#34;+prodKey+&#34;; move on&#34;, e);</TD></TR><TR><TD CLASS="l">4425</TD><TD>                    continue;</TD></TR><TR><TD CLASS="l">4426</TD><TD>                }</TD></TR><TR><TD CLASS="l">4427</TD><TD>            }</TD></TR><TR><TD CLASS="l">4428</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4429</TD><TD>        return orders;        </TD></TR><TR><TD CLASS="l">4430</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="83">4431</A></TD><TD>    </TD></TR><TR><TD CLASS="l">4432</TD><TD>    // Change the side to sell short based on the Sell Short Sale Test </TD></TR><TR><TD CLASS="l">4433</TD><TD>    protected char getSide(OrderStruct anOrder)</TD></TR><TR><TD CLASS="l">4434</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4435</TD><TD>        if ( Sides.SELL_SHORT_EXEMPT == anOrder.side )</TD></TR><TR><TD CLASS="l">4436</TD><TD>        {         </TD></TR><TR CLASS="z"><TD CLASS="l">4437</TD><TD>            if ( !getShortSaleTriggeredMode(anOrder.activeSession, anOrder.productKey ) )</TD></TR><TR CLASS="z"><TD CLASS="l">4438</TD><TD>            {   return Sides.SELL_SHORT;</TD></TR><TR><TD CLASS="l">4439</TD><TD>            }</TD></TR><TR><TD CLASS="l">4440</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4441</TD><TD>        return anOrder.side;</TD></TR><TR><TD CLASS="l">4442</TD><TD>    }</TD></TR><TR><TD CLASS="l">4443</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="82">4444</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">4445</TD><TD>     * Get ShortSaleTriggeredMode</TD></TR><TR><TD CLASS="l">4446</TD><TD>     */</TD></TR><TR><TD CLASS="l">4447</TD><TD>    protected boolean getShortSaleTriggeredMode(String sessionName, int productKey){</TD></TR><TR CLASS="z"><TD CLASS="l">4448</TD><TD>        boolean shortSaleTriggeredMode = false;</TD></TR><TR><TD CLASS="l">4449</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">4450</TD><TD>            MarketData mktData = getMarketDataHome().findByProduct( sessionName, productKey );</TD></TR><TR CLASS="z"><TD CLASS="l">4451</TD><TD>            shortSaleTriggeredMode = mktData.getShortSaleTriggeredMode();</TD></TR><TR><TD CLASS="l">4452</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4453</TD><TD>        catch (Exception e){</TD></TR><TR CLASS="z"><TD CLASS="l">4454</TD><TD>            Log.exception(&#34;Can not get ShortSaleTriggeredMode data for session:product&#34; + sessionName+ &#34;:&#34; + productKey, e);</TD></TR><TR><TD CLASS="l">4455</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4456</TD><TD>        return shortSaleTriggeredMode;</TD></TR><TR><TD CLASS="l">4457</TD><TD>    }</TD></TR><TR><TD CLASS="l">4458</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="5f">4459</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">4460</TD><TD>     * Gets MarketDataHome.</TD></TR><TR><TD CLASS="l">4461</TD><TD>     */</TD></TR><TR><TD CLASS="l">4462</TD><TD>    private MarketDataHome getMarketDataHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">4463</TD><TD>        if (mktDataHome == null) {</TD></TR><TR><TD CLASS="l">4464</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">4465</TD><TD>                mktDataHome = (MarketDataHome) HomeFactory.getInstance().findHome(MarketDataHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">4466</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4467</TD><TD>            catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">4468</TD><TD>                Log.alarm(&#34;Unable to get Market Data Home&#34;);</TD></TR><TR><TD CLASS="l">4469</TD><TD>            }</TD></TR><TR><TD CLASS="l">4470</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4471</TD><TD>        return mktDataHome;</TD></TR><TR><TD CLASS="l">4472</TD><TD>    }    </TD></TR><TR><TD CLASS="l"><A NAME="3f">4473</A></TD><TD> </TD></TR><TR><TD CLASS="l">4474</TD><TD>        public OrderCommon[] findOrdersForProduct(int productKey)</TD></TR><TR><TD CLASS="l">4475</TD><TD>                        throws TransactionFailedException {</TD></TR><TR><TD CLASS="l">4476</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="47">4477</A></TD><TD>                return findOrdersForProduct(productKey, false);</TD></TR><TR><TD CLASS="l">4478</TD><TD>        }</TD></TR><TR><TD CLASS="l">4479</TD><TD> </TD></TR><TR><TD CLASS="l">4480</TD><TD>        public int getAllOrderCount() throws TransactionFailedException {</TD></TR><TR CLASS="z"><TD CLASS="l">4481</TD><TD>                Iterator&lt;ConcurrentIntHashMap&lt;Map&lt;Long,Order&gt;&gt;&gt; sessionIter = productKeyOrderCacheForSessions.values().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">4482</TD><TD>                int count=0;</TD></TR><TR CLASS="z"><TD CLASS="l">4483</TD><TD>        while(sessionIter.hasNext())</TD></TR><TR><TD CLASS="l">4484</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4485</TD><TD>                Iterator&lt;Map&lt;Long,Order&gt;&gt; orderProductIter = sessionIter.next().values().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">4486</TD><TD>                while (orderProductIter.hasNext())</TD></TR><TR><TD CLASS="l">4487</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">4488</TD><TD>                        Collection&lt;Order&gt; orderCollection = orderProductIter.next().values();</TD></TR><TR CLASS="z"><TD CLASS="l">4489</TD><TD>                        count +=orderCollection.size();</TD></TR><TR><TD CLASS="l">4490</TD><TD>                }</TD></TR><TR><TD CLASS="l">4491</TD><TD>        }</TD></TR><TR><TD CLASS="l">4492</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4493</TD><TD>            return count;</TD></TR><TR><TD CLASS="l"><A NAME="85">4494</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">4495</TD><TD>        </TD></TR><TR><TD CLASS="l">4496</TD><TD>        public  long getTotalOrderRemainingQuantity() throws TransactionFailedException</TD></TR><TR><TD CLASS="l">4497</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4498</TD><TD>                Collection&lt;OrderImpl&gt; orders = orderCache.values();</TD></TR><TR CLASS="z"><TD CLASS="l">4499</TD><TD>                long total=0;</TD></TR><TR CLASS="z"><TD CLASS="l">4500</TD><TD>                for (OrderImpl order:orders)</TD></TR><TR><TD CLASS="l">4501</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4502</TD><TD>                        total+=order.getRemainingQuantity();</TD></TR><TR><TD CLASS="l">4503</TD><TD>        }</TD></TR><TR><TD CLASS="l">4504</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">4505</TD><TD>                return total;</TD></TR><TR><TD CLASS="l"><A NAME="76">4506</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">4507</TD><TD>        </TD></TR><TR><TD CLASS="l">4508</TD><TD>        public OrderSync getOrderSync()</TD></TR><TR><TD CLASS="l">4509</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4510</TD><TD>            if (orderSync == null) {</TD></TR><TR><TD CLASS="l">4511</TD><TD>                OrderSyncHome orderSyncHome;</TD></TR><TR CLASS="z"><TD CLASS="l">4512</TD><TD>                orderSyncHome = getOrderSyncHome();</TD></TR><TR CLASS="z"><TD CLASS="l">4513</TD><TD>                orderSync = orderSyncHome.getOrderSync();</TD></TR><TR><TD CLASS="l">4514</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4515</TD><TD>            return orderSync;</TD></TR><TR><TD CLASS="l">4516</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="77">4517</A></TD><TD>        </TD></TR><TR><TD CLASS="l">4518</TD><TD>        </TD></TR><TR><TD CLASS="l">4519</TD><TD>        public OrderSyncHome getOrderSyncHome()</TD></TR><TR><TD CLASS="l">4520</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4521</TD><TD>        if (orderSyncHome == null) {</TD></TR><TR><TD CLASS="l">4522</TD><TD>            try  {</TD></TR><TR CLASS="z"><TD CLASS="l">4523</TD><TD>                orderSyncHome = (OrderSyncHome) HomeFactory.getInstance().findHome(OrderSyncHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">4524</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4525</TD><TD>            catch (CBOELoggableException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">4526</TD><TD>                Log.alarm(this, &#34;Unable to obtain reference to OrderSyncHome.&#34;);</TD></TR><TR><TD CLASS="l">4527</TD><TD>            }</TD></TR><TR><TD CLASS="l">4528</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4529</TD><TD>        return orderSyncHome;</TD></TR><TR><TD CLASS="l"><A NAME="6b">4530</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4531</TD><TD>        </TD></TR><TR><TD CLASS="l">4532</TD><TD>    protected OrderBookServiceLocalHome getOrderBookServiceHome() </TD></TR><TR><TD CLASS="l">4533</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4534</TD><TD>        if (orderBookServiceHome == null) {</TD></TR><TR><TD CLASS="l">4535</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">4536</TD><TD>                orderBookServiceHome = (OrderBookServiceLocalHome) HomeFactory.getInstance().findHome(OrderBookServiceLocalHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">4537</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4538</TD><TD>            catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">4539</TD><TD>                Log.alarm(this.getClass().getSimpleName() + &#34;: Unable to find Order Book Home &#34;);</TD></TR><TR><TD CLASS="l">4540</TD><TD>            }</TD></TR><TR><TD CLASS="l">4541</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4542</TD><TD>        return orderBookServiceHome;</TD></TR><TR><TD CLASS="l"><A NAME="1c">4543</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4544</TD><TD>    </TD></TR><TR><TD CLASS="l">4545</TD><TD>    public void cancelOrdersOnOHS(OrderIdStruct[] ordersToBeCanceled) throws Exception</TD></TR><TR><TD CLASS="l">4546</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4547</TD><TD>        if(ordersToBeCanceled.length &gt; 0){</TD></TR><TR CLASS="z"><TD CLASS="l">4548</TD><TD>            Log.information(this, &#34;Sending cancel to OHS for &#34; + ordersToBeCanceled.length + &#34; orders.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">4549</TD><TD>            String sessionName = TradingSessionNameHelper.getTradingSessions()[0].sessionName;</TD></TR><TR CLASS="z"><TD CLASS="l">4550</TD><TD>            OrderRoutingParameterStruct orderRouting = getORParamsStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">4551</TD><TD>            logCancelOrders(ordersToBeCanceled);</TD></TR><TR CLASS="z"><TD CLASS="l">4552</TD><TD>            getOrderMaintenanceServiceHome().find().cancelNotBookableOrdersOnTEGoMaster(</TD></TR><TR CLASS="z"><TD CLASS="l">4553</TD><TD>                    orderRouting, sessionName, ordersToBeCanceled);</TD></TR><TR><TD CLASS="l">4554</TD><TD>        }</TD></TR><TR><TD CLASS="l">4555</TD><TD>        // Since these orders are cancelled by OHS, the order-sync remote cache in TE never sees any</TD></TR><TR><TD CLASS="l">4556</TD><TD>        // update. Therefore these orders must be manually removed form TE order sync.</TD></TR><TR CLASS="z"><TD CLASS="l">4557</TD><TD>        for (OrderIdStruct orderIdStruct : ordersToBeCanceled) {</TD></TR><TR CLASS="z"><TD CLASS="l">4558</TD><TD>            Order order = this.findOrder(orderIdStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">4559</TD><TD>            getOrderSync().remove(order);</TD></TR><TR><TD CLASS="l">4560</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="ad">4561</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4562</TD><TD> </TD></TR><TR><TD CLASS="l">4563</TD><TD>    private void logCancelOrders(OrderIdStruct[] p_ordersToBeCanceled)</TD></TR><TR><TD CLASS="l">4564</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4565</TD><TD>        for (int i = 0; i &lt; p_ordersToBeCanceled.length; i++)</TD></TR><TR><TD CLASS="l">4566</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4567</TD><TD>            OrderIdStruct aCancelOrder = (OrderIdStruct) p_ordersToBeCanceled[i];</TD></TR><TR CLASS="z"><TD CLASS="l">4568</TD><TD>            Log.information(&#34;Cancel Order call from TE to OHS for OrderID: &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">4569</TD><TD>                    + StructToString.toString(aCancelOrder));</TD></TR><TR><TD CLASS="l">4570</TD><TD>        }</TD></TR><TR><TD CLASS="l">4571</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4572</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="cc">4573</A></TD><TD> </TD></TR><TR><TD CLASS="l">4574</TD><TD>    </TD></TR><TR><TD CLASS="l">4575</TD><TD>    public void updateToSync(Order order)</TD></TR><TR><TD CLASS="l">4576</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4577</TD><TD>            emitPointOrderSync.enter();</TD></TR><TR CLASS="z"><TD CLASS="l">4578</TD><TD>            getOrderSyncHome().updateToSync(order);</TD></TR><TR CLASS="z"><TD CLASS="l">4579</TD><TD>            emitPointOrderSync.exit(false);</TD></TR><TR><TD CLASS="l">4580</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4581</TD><TD>    }</TD></TR><TR><TD CLASS="l">4582</TD><TD>    </TD></TR><TR><TD CLASS="l">4583</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="48">4584</A></TD><TD>     * This method is used for comparing the order counts between master and slave te. </TD></TR><TR><TD CLASS="l">4585</TD><TD>     * </TD></TR><TR><TD CLASS="l">4586</TD><TD>     */</TD></TR><TR><TD CLASS="l">4587</TD><TD>    public int getAllOrderCountForSync() throws SystemException {</TD></TR><TR CLASS="z"><TD CLASS="l">4588</TD><TD>        int count = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">4589</TD><TD>        return (int)getOrderBookHome().getOrderCount();</TD></TR><TR><TD CLASS="l"><A NAME="a3">4590</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4591</TD><TD> </TD></TR><TR><TD CLASS="l">4592</TD><TD>    private void initpublishCxlReasonCodesForLightOrders(String[] cxlReasons)</TD></TR><TR><TD CLASS="l">4593</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4594</TD><TD>            publishCxlReasonsForLightOrders = new short[cxlReasons.length];</TD></TR><TR CLASS="z"><TD CLASS="l">4595</TD><TD>            for (int i=0; i &lt; cxlReasons.length; i++)</TD></TR><TR><TD CLASS="l">4596</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">4597</TD><TD>                    short xx = 9999;</TD></TR><TR><TD CLASS="l">4598</TD><TD>                    try</TD></TR><TR><TD CLASS="l">4599</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">4600</TD><TD>                            xx = (short)Integer.parseInt(cxlReasons[i]);</TD></TR><TR><TD CLASS="l">4601</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">4602</TD><TD>                    catch (Exception e)</TD></TR><TR><TD CLASS="l">4603</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">4604</TD><TD>                            Log.alarm(this, &#34;cxlReasonCode (&#34; + cxlReasons[i] + &#34;) is invalid for the property &#34; + PUBLISH_CXL_REASONS_FOR_LIGHT_ORDERS);</TD></TR><TR><TD CLASS="l">4605</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">4606</TD><TD>                    publishCxlReasonsForLightOrders[i] = xx;</TD></TR><TR><TD CLASS="l">4607</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4608</TD><TD>    }</TD></TR><TR><TD CLASS="l">4609</TD><TD>    </TD></TR><TR><TD CLASS="l">4610</TD><TD> </TD></TR><TR><TD CLASS="l">4611</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="nv">[<A HREF="../Coverage.html">all classes</A>][<A HREF="74.html">com.cboe.businessServices.orderRoutingDestination</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://www.eclemma.org/support.html">EMMA 2.0.5312 EclEmma Fix 2</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>