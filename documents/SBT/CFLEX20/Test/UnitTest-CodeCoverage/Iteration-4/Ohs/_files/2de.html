<HTML><HEAD><META CONTENT="text/html; charset=UTF-8" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="tl"><A HREF="http://www.eclemma.org/">EMMA</A> Coverage Report (generated Mon Aug 01 06:28:17 CDT 2011)</TH></TR><TR><TD CLASS="nv">[<A HREF="../Coverage.html">all classes</A>][<A HREF="1b.html">com.cboe.ohs.receivers.oms</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">ManualOrderMaintenanceServiceDelegateImpl.java</SPAN>]</H2><TABLE CELLSPACING="0" WIDTH="100%"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>ManualOrderMaintenanceServiceDelegateImpl.java</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/134)</TD><TD CLASS="h">0%   (0/9847)</TD><TD CLASS="h">0%   (0/2134)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">ManualOrderMaintenanceServiceDelegateImpl</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/134)</TD><TD CLASS="h">0%   (0/9847)</TD><TD CLASS="h">0%   (0/2134)</TD></TR><TR><TD CLASS="f"><A HREF="#0">&lt;static initializer&gt;</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">ManualOrderMaintenanceServiceDelegateImpl (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#3">acceptDirectRoute (String, OrderStruct, short, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/259)</TD><TD CLASS="h">0%   (0/56)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4">acceptLinkageOrder (OrderRoutingParameterStruct, OrderStruct, OrderIdStruct, ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#5">acceptManualCancelFromOMT (CancelRequestStruct, long, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/216)</TD><TD CLASS="h">0%   (0/50)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6">acceptManualCancelReplaceFromOMT (CancelRequestStruct, long, OrderStruct, Str...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/319)</TD><TD CLASS="h">0%   (0/69)</TD></TR><TR><TD CLASS="f"><A HREF="#7">acceptManualCancelReport (OrderRoutingParameterStruct, ManualCancelReportStru...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/187)</TD><TD CLASS="h">0%   (0/38)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">acceptManualFillReport (short, OrderRoutingParameterStruct, ManualFillStruct ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/70)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#9">acceptManualFillReportV2 (short, OrderRoutingParameterStruct, ManualFillStruc...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/286)</TD><TD CLASS="h">0%   (0/66)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a">acceptManualFillTimeout (OrderRoutingParameterStruct, ManualFillStruct [], sh...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/108)</TD><TD CLASS="h">0%   (0/20)</TD></TR><TR><TD CLASS="f"><A HREF="#b">acceptManualOrderReturn (ManualMarketBrokerDataStruct, OrderRoutingParameterS...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/202)</TD><TD CLASS="h">0%   (0/46)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">acceptManualOrderReturnTimeout (ManualMarketBrokerDataStruct, OrderRoutingPar...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/84)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR><TD CLASS="f"><A HREF="#d">acceptManualQuote (ManualQuoteStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/105)</TD><TD CLASS="h">0%   (0/22)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#e">acceptMessageRoute (String, String, String, long): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/146)</TD><TD CLASS="h">0%   (0/34)</TD></TR><TR><TD CLASS="f"><A HREF="#f">acceptOMTSessionClose (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#10">acceptPrintCancel (OrderRoutingParameterStruct, ManualCancelRequestStruct, in...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/128)</TD><TD CLASS="h">0%   (0/29)</TD></TR><TR><TD CLASS="f"><A HREF="#11">acceptPrintCancelReplace (OrderRoutingParameterStruct, ManualCancelRequestStr...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/168)</TD><TD CLASS="h">0%   (0/39)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#12">acceptPrintRequest (OrderRoutingParameterStruct, OrderIdStruct, String, int, ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/164)</TD><TD CLASS="h">0%   (0/37)</TD></TR><TR><TD CLASS="f"><A HREF="#13">acceptVolumeChange (OrderRoutingParameterStruct, OrderIdStruct, String, int, ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/141)</TD><TD CLASS="h">0%   (0/30)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">adminForcedLogoffParWorkstation (Order): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/50)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR><TD CLASS="f"><A HREF="#15">approveDirectRerouteFromOHS (Order, String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/55)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#16">areLegQuantitiesOverFilled (Order, int []): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#17">assertNotNull (Object, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/14)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#18">buildFilledReportStruct (ManualFillStructV2, Order, int, int, LegOrderDetail,...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/308)</TD><TD CLASS="h">0%   (0/56)</TD></TR><TR><TD CLASS="f"><A HREF="#19">buildManualMarketBrokerData (ManualFillStruct [], Order): ManualMarketBrokerD...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/72)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1a">calculateMaximumExecutionVolume (int [], LegOrderDetail [], int): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/128)</TD><TD CLASS="h">0%   (0/33)</TD></TR><TR><TD CLASS="f"><A HREF="#1b">cancelManualQuote (ManualQuoteStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1c">checkIfContraExistsInList (ManualContraBrokerStruct, ArrayList, Side): Atomic...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/53)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR><TD CLASS="f"><A HREF="#1d">convertSellSideIndicatorOfNonStockLeg (LegOrderEntryStructV2): LegOrderEntryS...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1e">createLegEntries (OrderStruct): LegOrderEntryStructV2 []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/116)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR><TD CLASS="f"><A HREF="#1f">createNewLegEntries (OrderStruct): LegOrderEntryStructV2 []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/96)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#20">createNewOrder (OrderStruct, LegOrderEntryStructV2 [], OrderHandlingInstructi...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/146)</TD><TD CLASS="h">0%   (0/38)</TD></TR><TR><TD CLASS="f"><A HREF="#21">decrementParPendingCancelQty (BaseOHSContext, Order, ManualCancelReportStruct...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/50)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#22">decrementParPendingCancelQty (BaseOHSContext, Order, ManualCancelRequestStruc...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/46)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#23">executeCxlReOrderWorkflow (CancelReplaceContext): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/109)</TD><TD CLASS="h">0%   (0/30)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#24">executeOrderWithInstructions (OrderRoutingParameterStruct, OrderStruct, Order...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/224)</TD><TD CLASS="h">0%   (0/58)</TD></TR><TR><TD CLASS="f"><A HREF="#25">executeTimeoutWithInstructions (OrderRoutingParameterStruct, Order, int, int ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/146)</TD><TD CLASS="h">0%   (0/37)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#26">findLocationType (String): short</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/41)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR><TD CLASS="f"><A HREF="#27">findOrder (OrderIdStruct): Order</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/80)</TD><TD CLASS="h">0%   (0/23)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#28">getCancelReportMessageText (Order, OrderRoutingParameterStruct, ManualCancelR...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/14)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#29">getCancelReportSubject (OrderRoutingParameterStruct): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2a">getCommonConfig (): DIFCommonConfig</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#2b">getContraParties (ManualContraBrokerStruct [], boolean, int, short, Order): C...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/287)</TD><TD CLASS="h">0%   (0/50)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2c">getFillReports (ManualFillStructV2 [], Order, ProductKeysStruct, boolean): Fi...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/137)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR><TD CLASS="f"><A HREF="#2d">getFirmPropertyService (): FirmPropertyService</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2e">getHelpers (): Collection</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#2f">getLegOrderEntries (Order, OrderStruct): LegOrderEntryStructV2 []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/100)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#30">getLegQuantities (ManualFillStruct [], Order): int []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/35)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#31">getMinimum (Integer []): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#32">getNetworkInstrumentor (): MOMNetworkInstrumentorHelper</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#33">getOrderClassKey (Order): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/67)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#34">getOrderValidationStrategy (String): OrderValidationStrategy</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#35">getPackageTradeReport (ManualFillStructV2 [], Order, Side, int, short, boolea...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/105)</TD><TD CLASS="h">0%   (0/20)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#36">getPackgeTradedQuantity (ManualFillStructV2 []): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/54)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#37">getPackgeTradedQuantityForOMT (ManualFillStructV2 [], Order): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/60)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#38">getPrintRequestMessageText (Order, OrderRoutingParameterStruct, OrderIdStruct...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#39">getPrintRequestSubject (OrderRoutingParameterStruct): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3a">getProductData (int): ProductData</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#3b">getQuantitiesString (Order, int, int []): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/41)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3c">getQuoteQueryDataForProducts (OrderIdStruct, String, int []): QuoteQueryV3Str...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/166)</TD><TD CLASS="h">0%   (0/27)</TD></TR><TR><TD CLASS="f"><A HREF="#3d">getRequestType (short): Enums$RequestTypeEnum</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3e">getRoutingPropertyService (): RoutingPropertyService</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#3f">getSessionProfileStructByClassSession (SessionProfileUserStruct, String, int)...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/53)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#40">getStandardMessageText (Order, OrderRoutingParameterStruct, int, int, String,...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/83)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR><TD CLASS="f"><A HREF="#41">getStandardSubjectText (OrderRoutingParameterStruct, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#42">getStrategyLegs (int): List</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR><TD CLASS="f"><A HREF="#43">getTaTBMessageText (Order, OrderRoutingParameterStruct, OrderIdStruct, String...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#44">getTradeAllTradeBook (OrderRoutingParameterStruct, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#45">getTradeReport (ManualFillStructV2 [], Order, Side, int, short, boolean, bool...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/103)</TD><TD CLASS="h">0%   (0/20)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#46">getTradeReports (ManualFillStructV2 [], Order, ProductKeysStruct, short, bool...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/120)</TD><TD CLASS="h">0%   (0/24)</TD></TR><TR><TD CLASS="f"><A HREF="#47">getVolumeChangeMessageText (Order, OrderRoutingParameterStruct, OrderIdStruct...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#48">getVolumeChangeSubject (OrderRoutingParameterStruct): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#49">initWorkflows (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/299)</TD><TD CLASS="h">0%   (0/75)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4a">isAuctionResponse (OrderStruct): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#4b">isFillTimeout (short): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4c">isNewBOBLinkage (String, int, int): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/29)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#4d">isOrderTimeout (short): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4e">isSetForMMTN (String, String, String, String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/97)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR><TD CLASS="f"><A HREF="#4f">log (): Logger</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#50">maybeThrow (BaseOHSContext): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/40)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR><TD CLASS="f"><A HREF="#51">msg (): MsgBuilder</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#52">orderStateMapping (Order): short</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/14)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#53">populateAtomicTrade (ManualFillStructV2 [], Order, Side, int, boolean, boolea...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/364)</TD><TD CLASS="h">0%   (0/77)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#54">populateAtomicTradeForPackage (ManualFillStructV2 [], Order, Side, int, boole...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/304)</TD><TD CLASS="h">0%   (0/70)</TD></TR><TR><TD CLASS="f"><A HREF="#55">populateContraFirmFromSessionProfileForMMTN (ManualFillStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/137)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#56">populateContraSide (AtomicTradeStruct, ManualContraBrokerStruct, Side, OrderS...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/222)</TD><TD CLASS="h">0%   (0/44)</TD></TR><TR><TD CLASS="f"><A HREF="#57">populateMMSide (ManualFillStructV2 [], OrderStruct, AtomicTradeStruct, Side):...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/194)</TD><TD CLASS="h">0%   (0/33)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#58">postInitialize (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#59">postStart (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5a">processLinkageFillReport (OrderRoutingParameterStruct, ManualFillStructV2 [],...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/93)</TD><TD CLASS="h">0%   (0/23)</TD></TR><TR><TD CLASS="f"><A HREF="#5b">processManualFillReport (OrderRoutingParameterStruct, ManualFillStructV2 [], ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/53)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5c">processOMTManualFillReport (OrderRoutingParameterStruct, ManualFillStructV2 [...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/60)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR><TD CLASS="f"><A HREF="#5d">publishReroutedOrderBackToOMTOnException (RemoveOrderContext): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/189)</TD><TD CLASS="h">0%   (0/40)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5e">retrieveShortSaleMarkingFirmProperty (OrderStruct): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/74)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR><TD CLASS="f"><A HREF="#5f">sendMessageToHelpDesk (String, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#60">sendTSB (OrderIdStruct, Order): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#61">setAdminTextMessageServiceHome (AdminTextMessageServiceHome): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#62">setCOAEligibilityFlag (BaseOHSContext, Order): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/61)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR><TD CLASS="f"><A HREF="#63">setCancelReplaceValidator (CancelReplaceValidator): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#64">setCommonConfig (DIFCommonConfig): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#65">setExceptionType (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#66">setFirmMaintenanceService (FirmMaintenanceService): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#67">setFirmPropertyService (FirmPropertyService): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#68">setHybridClassConfigurationHome (HybridClassConfigurationHome): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#69">setLogger (Logger): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6a">setManualOrderMaintenanceServiceHome (ManualOrderMaintenanceServiceHome): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#6b">setManualReportHandlerHome (ManualReportHandlerHome): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6c">setMarketDataService (MarketDataService): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#6d">setMarketMakerQuoteService (MarketMakerQuoteService): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6e">setOHSLinkageOrderHandlingService (OHSLinkageOrderHandlingService): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#6f">setOrderBranchAR (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#70">setOrderHome (OrderHome): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#71">setOrderRelationshipHome (OrderRelationshipHome): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#72">setOrderRoutingPublisher (OrderRoutingConsumerOperations): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#73">setOrderValidationStrategyHome (OrderValidationStrategyHome): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#74">setProductDataCache (ProductDataCache): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#75">setRoutedMessageHome (RoutedMessageHome): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#76">setTSBQueueImpl (TSBQueue): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#77">setUserDataCache (UserDataCache): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#78">setWorkflowHome (WorkflowHome): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#79">testARException (OrderIdStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/73)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7a">validateCancelOrCancelReplace (Order, String, long): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#7b">validateCancelQty (OrderRoutingParameterStruct, Order, ManualCancelReportStru...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/138)</TD><TD CLASS="h">0%   (0/26)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7c">validateCancelReplace (CancelRequestStruct, OrderStruct, LegOrderEntryStructV...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/279)</TD><TD CLASS="h">0%   (0/56)</TD></TR><TR><TD CLASS="f"><A HREF="#7d">validateCancelReplaceIOrder (Order, OrderStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/18)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7e">validateCancelRequestQuantity (CancelRequestStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/95)</TD><TD CLASS="h">0%   (0/25)</TD></TR><TR><TD CLASS="f"><A HREF="#7f">validateCancellableOrder (Order): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/161)</TD><TD CLASS="h">0%   (0/30)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#80">validateExecutingBroker (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/91)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR><TD CLASS="f"><A HREF="#81">validateManualCancelFromOMT (Order, CancelRequestStruct, long, String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#82">validateOMTCancelAuthority (Order, String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/100)</TD><TD CLASS="h">0%   (0/33)</TD></TR><TR><TD CLASS="f"><A HREF="#83">validateOrderId (OrderIdStruct): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/31)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#84">validateOrderMaintenanceId (Order, CancelRequestStruct, long, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/163)</TD><TD CLASS="h">0%   (0/37)</TD></TR><TR><TD CLASS="f"><A HREF="#85">validateRatio (Order): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/55)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#86">validateRoutedMessage (long): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/7)</TD></TR></TABLE><P></P><TABLE CLASS="s" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="l">1</TD><TD>package com.cboe.ohs.receivers.oms;</TD></TR><TR><TD CLASS="l">2</TD><TD> </TD></TR><TR><TD CLASS="l">3</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">4</TD><TD>import java.util.Arrays;</TD></TR><TR><TD CLASS="l">5</TD><TD>import java.util.Collection;</TD></TR><TR><TD CLASS="l">6</TD><TD>import java.util.List;</TD></TR><TR><TD CLASS="l">7</TD><TD>import java.util.StringTokenizer;</TD></TR><TR><TD CLASS="l">8</TD><TD>import java.util.concurrent.ConcurrentHashMap;</TD></TR><TR><TD CLASS="l">9</TD><TD>import java.util.regex.Pattern;</TD></TR><TR><TD CLASS="l">10</TD><TD> </TD></TR><TR><TD CLASS="l">11</TD><TD>import com.cboe.domain.routingProperty.FirmPropertyTypeImpl;</TD></TR><TR><TD CLASS="l">12</TD><TD>import com.cboe.domain.routingProperty.key.SessionFirmKey;</TD></TR><TR><TD CLASS="l">13</TD><TD>import com.cboe.domain.util.CboeId;</TD></TR><TR><TD CLASS="l">14</TD><TD>import com.cboe.domain.util.DateWrapper;</TD></TR><TR><TD CLASS="l">15</TD><TD>import com.cboe.domain.util.ExtensionsHelper;</TD></TR><TR><TD CLASS="l">16</TD><TD>import com.cboe.domain.util.InternalOrderStates;</TD></TR><TR><TD CLASS="l">17</TD><TD>import com.cboe.domain.util.ManualActivityHelper;</TD></TR><TR><TD CLASS="l">18</TD><TD>import com.cboe.domain.util.OrderStateLocationMapper;</TD></TR><TR><TD CLASS="l">19</TD><TD>import com.cboe.domain.util.PriceFactory;</TD></TR><TR><TD CLASS="l">20</TD><TD>import com.cboe.domain.util.StructBuilder;</TD></TR><TR><TD CLASS="l">21</TD><TD>import com.cboe.domain.util.TradeReportStructBuilder;</TD></TR><TR><TD CLASS="l">22</TD><TD>import com.cboe.domain.util.TradingSessionNameHelper;</TD></TR><TR><TD CLASS="l">23</TD><TD>import com.cboe.exceptions.AuthorizationException;</TD></TR><TR><TD CLASS="l">24</TD><TD>import com.cboe.exceptions.CommunicationException;</TD></TR><TR><TD CLASS="l">25</TD><TD>import com.cboe.exceptions.DataValidationException;</TD></TR><TR><TD CLASS="l">26</TD><TD>import com.cboe.exceptions.DuplicateOrderIDException;</TD></TR><TR><TD CLASS="l">27</TD><TD>import com.cboe.exceptions.NotAcceptedException;</TD></TR><TR><TD CLASS="l">28</TD><TD>import com.cboe.exceptions.NotFoundException;</TD></TR><TR><TD CLASS="l">29</TD><TD>import com.cboe.exceptions.SystemException;</TD></TR><TR><TD CLASS="l">30</TD><TD>import com.cboe.exceptions.TransactionFailedException;</TD></TR><TR><TD CLASS="l">31</TD><TD>import com.cboe.idl.cmiConstants.ActivityTypes;</TD></TR><TR><TD CLASS="l">32</TD><TD>import com.cboe.idl.cmiConstants.ContingencyTypes;</TD></TR><TR><TD CLASS="l">33</TD><TD>import com.cboe.idl.cmiConstants.ExchangeStrings;</TD></TR><TR><TD CLASS="l">34</TD><TD>import com.cboe.idl.cmiConstants.ExtensionFields;</TD></TR><TR><TD CLASS="l">35</TD><TD>import com.cboe.idl.cmiConstants.OrderCancelTypes;</TD></TR><TR><TD CLASS="l">36</TD><TD>import com.cboe.idl.cmiConstants.OrderOrigins;</TD></TR><TR><TD CLASS="l">37</TD><TD>import com.cboe.idl.cmiConstants.OrderOriginsOperations;</TD></TR><TR><TD CLASS="l">38</TD><TD>import com.cboe.idl.cmiConstants.OrderStates;</TD></TR><TR><TD CLASS="l">39</TD><TD>import com.cboe.idl.cmiConstants.PriceTypes;</TD></TR><TR><TD CLASS="l">40</TD><TD>import com.cboe.idl.cmiConstants.ProductTypes;</TD></TR><TR><TD CLASS="l">41</TD><TD>import com.cboe.idl.cmiConstants.ReportTypes;</TD></TR><TR><TD CLASS="l">42</TD><TD>import com.cboe.idl.cmiConstants.Sides;</TD></TR><TR><TD CLASS="l">43</TD><TD>import com.cboe.idl.cmiConstants.Sources;</TD></TR><TR><TD CLASS="l">44</TD><TD>import com.cboe.idl.cmiConstants.UserRoles;</TD></TR><TR><TD CLASS="l">45</TD><TD>import com.cboe.idl.cmiErrorCodes.AuthorizationCodes;</TD></TR><TR><TD CLASS="l">46</TD><TD>import com.cboe.idl.cmiErrorCodes.CommunicationFailureCodes;</TD></TR><TR><TD CLASS="l">47</TD><TD>import com.cboe.idl.cmiErrorCodes.DataValidationCodes;</TD></TR><TR><TD CLASS="l">48</TD><TD>import com.cboe.idl.cmiErrorCodes.NotAcceptedCodes;</TD></TR><TR><TD CLASS="l">49</TD><TD>import com.cboe.idl.cmiErrorCodes.NotFoundCodes;</TD></TR><TR><TD CLASS="l">50</TD><TD>import com.cboe.idl.cmiErrorCodes.TransactionFailedCodes;</TD></TR><TR><TD CLASS="l">51</TD><TD>import com.cboe.idl.cmiOrder.CancelRequestStruct;</TD></TR><TR><TD CLASS="l">52</TD><TD>import com.cboe.idl.cmiOrder.ContraPartyStruct;</TD></TR><TR><TD CLASS="l">53</TD><TD>import com.cboe.idl.cmiOrder.FilledReportStruct;</TD></TR><TR><TD CLASS="l">54</TD><TD>import com.cboe.idl.cmiOrder.LegOrderEntryStruct;</TD></TR><TR><TD CLASS="l">55</TD><TD>import com.cboe.idl.cmiOrder.LegOrderEntryStructV2;</TD></TR><TR><TD CLASS="l">56</TD><TD>import com.cboe.idl.cmiOrder.OrderIdStruct;</TD></TR><TR><TD CLASS="l">57</TD><TD>import com.cboe.idl.cmiOrder.OrderStruct;</TD></TR><TR><TD CLASS="l">58</TD><TD>import com.cboe.idl.cmiProduct.ProductKeysStruct;</TD></TR><TR><TD CLASS="l">59</TD><TD>import com.cboe.idl.cmiUser.ExchangeAcronymStruct;</TD></TR><TR><TD CLASS="l">60</TD><TD>import com.cboe.idl.cmiUser.ExchangeFirmStruct;</TD></TR><TR><TD CLASS="l">61</TD><TD>import com.cboe.idl.cmiUser.SessionProfileStruct;</TD></TR><TR><TD CLASS="l">62</TD><TD>import com.cboe.idl.cmiUser.SessionProfileUserStruct;</TD></TR><TR><TD CLASS="l">63</TD><TD>import com.cboe.idl.cmiUtil.CboeIdStruct;</TD></TR><TR><TD CLASS="l">64</TD><TD>import com.cboe.idl.cmiUtil.DateTimeStruct;</TD></TR><TR><TD CLASS="l">65</TD><TD>import com.cboe.idl.cmiUtil.PriceStruct;</TD></TR><TR><TD CLASS="l">66</TD><TD>import com.cboe.idl.constants.ManualFillReportTypes;</TD></TR><TR><TD CLASS="l">67</TD><TD>import com.cboe.idl.constants.OHSRoutingReasons;</TD></TR><TR><TD CLASS="l">68</TD><TD>import com.cboe.idl.constants.OMTRouteDestinations;</TD></TR><TR><TD CLASS="l">69</TD><TD>import com.cboe.idl.constants.OrderLocations;</TD></TR><TR><TD CLASS="l">70</TD><TD>import com.cboe.idl.constants.TextMessageTypes;</TD></TR><TR><TD CLASS="l">71</TD><TD>import com.cboe.idl.constants.TradeReportEntryTypes;</TD></TR><TR><TD CLASS="l">72</TD><TD>import com.cboe.idl.constants.TradeSources;</TD></TR><TR><TD CLASS="l">73</TD><TD>import com.cboe.idl.constants.TradeTypes;</TD></TR><TR><TD CLASS="l">74</TD><TD>import com.cboe.idl.firm.FirmStruct;</TD></TR><TR><TD CLASS="l">75</TD><TD>import com.cboe.idl.marketData.QuoteQueryV3Struct;</TD></TR><TR><TD CLASS="l">76</TD><TD>import com.cboe.idl.ohsConsumers.OrderRoutingConsumerOperations;</TD></TR><TR><TD CLASS="l">77</TD><TD>import com.cboe.idl.order.LinkageExtensionsStruct;</TD></TR><TR><TD CLASS="l">78</TD><TD>import com.cboe.idl.order.ManualCancelReportStruct;</TD></TR><TR><TD CLASS="l">79</TD><TD>import com.cboe.idl.order.ManualCancelRequestStruct;</TD></TR><TR><TD CLASS="l">80</TD><TD>import com.cboe.idl.order.ManualContraBrokerStruct;</TD></TR><TR><TD CLASS="l">81</TD><TD>import com.cboe.idl.order.ManualFillStruct;</TD></TR><TR><TD CLASS="l">82</TD><TD>import com.cboe.idl.order.ManualFillStructV2;</TD></TR><TR><TD CLASS="l">83</TD><TD>import com.cboe.idl.order.ManualMarketBrokerDataStruct;</TD></TR><TR><TD CLASS="l">84</TD><TD>import com.cboe.idl.order.ManualMarketDataStruct;</TD></TR><TR><TD CLASS="l">85</TD><TD>import com.cboe.idl.order.OrderHandlingInstructionStruct;</TD></TR><TR><TD CLASS="l">86</TD><TD>import com.cboe.idl.order.OrderRoutingParameterStruct;</TD></TR><TR><TD CLASS="l">87</TD><TD>import com.cboe.idl.order.OrderRoutingStruct;</TD></TR><TR><TD CLASS="l">88</TD><TD>import com.cboe.idl.trade.AtomicTradeStruct;</TD></TR><TR><TD CLASS="l">89</TD><TD>import com.cboe.idl.trade.TradeReportStruct;</TD></TR><TR><TD CLASS="l">90</TD><TD>import com.cboe.idl.util.RouteReasonStruct;</TD></TR><TR><TD CLASS="l">91</TD><TD>import com.cboe.idl.util.RoutingParameterV2Struct;</TD></TR><TR><TD CLASS="l">92</TD><TD>import com.cboe.infrastructureServices.foundationFramework.HomeFactory;</TD></TR><TR><TD CLASS="l">93</TD><TD>import com.cboe.infrastructureServices.foundationFramework.exceptionHandling.CBOELoggableException;</TD></TR><TR><TD CLASS="l">94</TD><TD>import com.cboe.infrastructureServices.foundationFramework.exceptionHandling.FatalFoundationFrameworkException;</TD></TR><TR><TD CLASS="l">95</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.Log;</TD></TR><TR><TD CLASS="l">96</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.Transaction;</TD></TR><TR><TD CLASS="l">97</TD><TD>import com.cboe.interfaces.businessServices.MarketDataService;</TD></TR><TR><TD CLASS="l">98</TD><TD>import com.cboe.interfaces.businessServices.MarketMakerQuoteService;</TD></TR><TR><TD CLASS="l">99</TD><TD>import com.cboe.interfaces.domain.OrderRelationshipHome;</TD></TR><TR><TD CLASS="l">100</TD><TD>import com.cboe.interfaces.domain.Side;</TD></TR><TR><TD CLASS="l">101</TD><TD>import com.cboe.interfaces.domain.routingProperty.BasePropertyKey;</TD></TR><TR><TD CLASS="l">102</TD><TD>import com.cboe.interfaces.domain.routingProperty.common.OrderLocation;</TD></TR><TR><TD CLASS="l">103</TD><TD>import com.cboe.interfaces.internalBusinessServices.AdminTextMessageServiceHome;</TD></TR><TR><TD CLASS="l">104</TD><TD>import com.cboe.interfaces.internalBusinessServices.FirmMaintenanceService;</TD></TR><TR><TD CLASS="l">105</TD><TD>import com.cboe.interfaces.internalBusinessServices.TradableValidationContext;</TD></TR><TR><TD CLASS="l">106</TD><TD>import com.cboe.interfaces.orderHandlingServices.ManualOrderMaintenanceService;</TD></TR><TR><TD CLASS="l">107</TD><TD>import com.cboe.interfaces.orderHandlingServices.ManualOrderMaintenanceServiceHome;</TD></TR><TR><TD CLASS="l">108</TD><TD>import com.cboe.interfaces.productData.ProductData;</TD></TR><TR><TD CLASS="l">109</TD><TD>import com.cboe.interfaces.productData.ProductDataCache;</TD></TR><TR><TD CLASS="l">110</TD><TD>import com.cboe.interfaces.productData.ProductLegData;</TD></TR><TR><TD CLASS="l">111</TD><TD>import com.cboe.interfaces.routingProperties.RoutingPropertyService;</TD></TR><TR><TD CLASS="l">112</TD><TD>import com.cboe.interfaces.routingProperties.RoutingPropertyServiceHome;</TD></TR><TR><TD CLASS="l">113</TD><TD>import com.cboe.interfaces.users.UserData;</TD></TR><TR><TD CLASS="l">114</TD><TD>import com.cboe.interfaces.users.UserDataCache;</TD></TR><TR><TD CLASS="l">115</TD><TD>import com.cboe.ohs.domain.interfaces.FirmPropertyService;</TD></TR><TR><TD CLASS="l">116</TD><TD>import com.cboe.ohs.domain.interfaces.FirmPropertyServiceHome;</TD></TR><TR><TD CLASS="l">117</TD><TD>import com.cboe.ohs.domain.interfaces.LegOrderDetail;</TD></TR><TR><TD CLASS="l">118</TD><TD>import com.cboe.ohs.domain.interfaces.ManualReportHandlerHome;</TD></TR><TR><TD CLASS="l">119</TD><TD>import com.cboe.ohs.domain.interfaces.OHSRoutingReason;</TD></TR><TR><TD CLASS="l">120</TD><TD>import com.cboe.ohs.domain.interfaces.Order;</TD></TR><TR><TD CLASS="l">121</TD><TD>import com.cboe.ohs.domain.interfaces.OrderHistoryCommonInfo;</TD></TR><TR><TD CLASS="l">122</TD><TD>import com.cboe.ohs.domain.interfaces.OrderHome;</TD></TR><TR><TD CLASS="l">123</TD><TD>import com.cboe.ohs.domain.interfaces.RoutedMessage;</TD></TR><TR><TD CLASS="l">124</TD><TD>import com.cboe.ohs.domain.interfaces.RoutedMessageHome;</TD></TR><TR><TD CLASS="l">125</TD><TD>import com.cboe.ohs.domain.interfaces.RoutedMessageType;</TD></TR><TR><TD CLASS="l">126</TD><TD>import com.cboe.ohs.domain.interfaces.TSBQueue;</TD></TR><TR><TD CLASS="l">127</TD><TD>import com.cboe.ohs.interfaces.integration.OrderValidationStrategy;</TD></TR><TR><TD CLASS="l">128</TD><TD>import com.cboe.ohs.interfaces.integration.OrderValidationStrategyHome;</TD></TR><TR><TD CLASS="l">129</TD><TD>import com.cboe.ohs.interfaces.integration.receivers.OHSLinkageOrderHandlingService;</TD></TR><TR><TD CLASS="l">130</TD><TD>import com.cboe.ohs.interfaces.workflow.BaseOHSContext;</TD></TR><TR><TD CLASS="l">131</TD><TD>import com.cboe.ohs.interfaces.workflow.CancelContext;</TD></TR><TR><TD CLASS="l">132</TD><TD>import com.cboe.ohs.interfaces.workflow.CancelReplaceContext;</TD></TR><TR><TD CLASS="l">133</TD><TD>import com.cboe.ohs.interfaces.workflow.ManualCancelContext;</TD></TR><TR><TD CLASS="l">134</TD><TD>import com.cboe.ohs.interfaces.workflow.ManualCancelReplaceContext;</TD></TR><TR><TD CLASS="l">135</TD><TD>import com.cboe.ohs.interfaces.workflow.ManualCancelReportContext;</TD></TR><TR><TD CLASS="l">136</TD><TD>import com.cboe.ohs.interfaces.workflow.ManualFillReportContext;</TD></TR><TR><TD CLASS="l">137</TD><TD>import com.cboe.ohs.interfaces.workflow.ManualOrderContext;</TD></TR><TR><TD CLASS="l">138</TD><TD>import com.cboe.ohs.interfaces.workflow.ManualTimeoutContext;</TD></TR><TR><TD CLASS="l">139</TD><TD>import com.cboe.ohs.interfaces.workflow.OrderContext;</TD></TR><TR><TD CLASS="l">140</TD><TD>import com.cboe.ohs.interfaces.workflow.RemoveMessageContext;</TD></TR><TR><TD CLASS="l">141</TD><TD>import com.cboe.ohs.interfaces.workflow.RemoveOrderContext;</TD></TR><TR><TD CLASS="l">142</TD><TD>import com.cboe.ohs.interfaces.workflow.WorkflowConstant;</TD></TR><TR><TD CLASS="l">143</TD><TD>import com.cboe.ohs.providers.CancelReplaceValidator;</TD></TR><TR><TD CLASS="l">144</TD><TD>import com.cboe.ohs.providers.UserAccessHelper;</TD></TR><TR><TD CLASS="l">145</TD><TD>import com.cboe.ohs.util.FirmPropertyKeyHelper;</TD></TR><TR><TD CLASS="l">146</TD><TD>import com.cboe.ohs.util.MOMNetworkInstrumentorHelper;</TD></TR><TR><TD CLASS="l">147</TD><TD>import com.cboe.ohs.util.OrderId;</TD></TR><TR><TD CLASS="l">148</TD><TD>import com.cboe.ohs.util.StrategyLegHelper;</TD></TR><TR><TD CLASS="l">149</TD><TD>import com.cboe.ohs.workflow.RerouteProperties;</TD></TR><TR><TD CLASS="l">150</TD><TD>import com.cboe.server.dependencyFramework.DIFCommonConfig;</TD></TR><TR><TD CLASS="l">151</TD><TD>import com.cboe.server.dependencyFramework.DIFObject;</TD></TR><TR><TD CLASS="l">152</TD><TD>import com.cboe.server.logger.LogLevel;</TD></TR><TR><TD CLASS="l">153</TD><TD>import com.cboe.server.logger.Logger;</TD></TR><TR><TD CLASS="l">154</TD><TD>import com.cboe.server.logger.MsgBuilder;</TD></TR><TR><TD CLASS="l">155</TD><TD>import com.cboe.server.routingProperties.RoutingLocationTypeHelper;</TD></TR><TR><TD CLASS="l">156</TD><TD>import com.cboe.server.routingProperties.RoutingPropertyKeyHelper;</TD></TR><TR><TD CLASS="l">157</TD><TD>import com.cboe.server.util.BusinessServicesHelper;</TD></TR><TR><TD CLASS="l">158</TD><TD>import com.cboe.server.util.FFStatusQuery;</TD></TR><TR><TD CLASS="l">159</TD><TD>import com.cboe.server.util.HybridClassConfigurationHome;</TD></TR><TR><TD CLASS="l">160</TD><TD>import com.cboe.server.util.ProductTypeResolver;</TD></TR><TR><TD CLASS="l">161</TD><TD>import com.cboe.server.workflow.Enums;</TD></TR><TR><TD CLASS="l">162</TD><TD>import com.cboe.server.workflow.IWorkflowEngine;</TD></TR><TR><TD CLASS="l">163</TD><TD>import com.cboe.server.workflow.IWorkflowStatelessExecutor;</TD></TR><TR><TD CLASS="l">164</TD><TD>import com.cboe.server.workflow.WorkflowHome;</TD></TR><TR><TD CLASS="l">165</TD><TD>import com.cboe.server.workflow.Enums.RequestTypeEnum;</TD></TR><TR><TD CLASS="l">166</TD><TD>import com.cboe.util.ExceptionBuilder;</TD></TR><TR><TD CLASS="l">167</TD><TD>import com.cboe.util.ReflectiveObjectWriter;</TD></TR><TR><TD CLASS="l">168</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">169</TD><TD>public class  ManualOrderMaintenanceServiceDelegateImpl implements ManualOrderMaintenanceService</TD></TR><TR><TD CLASS="l">170</TD><TD>{</TD></TR><TR><TD CLASS="l">171</TD><TD>    private static final String ALL_PAR_WS = &#34;ALL&#34;;</TD></TR><TR><TD CLASS="l">172</TD><TD>    private static final String PAR_PATTERN = &#34;^W[0-9]{3,3}&#34;;</TD></TR><TR><TD CLASS="l">173</TD><TD>    private OrderHome orderHome;</TD></TR><TR><TD CLASS="l">174</TD><TD>    private WorkflowHome wfHome;</TD></TR><TR><TD CLASS="l">175</TD><TD>    private ProductDataCache productDataCache;</TD></TR><TR><TD CLASS="l">176</TD><TD>    private IWorkflowEngine&lt;CancelContext&gt; cancelFromOwnerOMTWorkflow;</TD></TR><TR><TD CLASS="l">177</TD><TD>    private IWorkflowEngine&lt;CancelContext&gt; cancelFromNonOwnerOMTWorkflow;</TD></TR><TR><TD CLASS="l">178</TD><TD>    private IWorkflowEngine&lt;CancelReplaceContext&gt; cancelReplaceFromOwnerOMTWorkflow;</TD></TR><TR><TD CLASS="l">179</TD><TD>    private IWorkflowEngine&lt;CancelReplaceContext&gt; cancelReplaceFromNonOwnerOMTWorkflow;</TD></TR><TR><TD CLASS="l">180</TD><TD>    private IWorkflowEngine&lt;ManualCancelReportContext&gt; manualCancelReportWorkflow;</TD></TR><TR><TD CLASS="l">181</TD><TD>    private IWorkflowEngine&lt;ManualFillReportContext&gt; manualFillReportWorkflow;</TD></TR><TR><TD CLASS="l">182</TD><TD>    private IWorkflowEngine&lt;ManualFillReportContext&gt; manualFillOMTReportWorkflow;</TD></TR><TR><TD CLASS="l">183</TD><TD>    private IWorkflowEngine&lt;OrderContext&gt; newOrderWorkflow;</TD></TR><TR><TD CLASS="l">184</TD><TD>    private IWorkflowEngine&lt;OrderContext&gt; orderRerouteHybridWorkflow;</TD></TR><TR><TD CLASS="l">185</TD><TD>    private IWorkflowEngine&lt;OrderContext&gt; volumeChangeWorkflow;</TD></TR><TR><TD CLASS="l">186</TD><TD>    private IWorkflowEngine&lt;ManualCancelContext&gt; printCancelWorkflow;</TD></TR><TR><TD CLASS="l">187</TD><TD>    private IWorkflowEngine&lt;ManualCancelReplaceContext&gt; printCancelReplaceWorkflow;</TD></TR><TR><TD CLASS="l">188</TD><TD>    private IWorkflowEngine&lt;OrderContext&gt; printRequestWorkflow;</TD></TR><TR><TD CLASS="l">189</TD><TD>    private IWorkflowEngine&lt;ManualFillReportContext&gt; linkageInboundOrderFillReportWorkflow;</TD></TR><TR><TD CLASS="l">190</TD><TD>    private IWorkflowEngine&lt;OrderContext&gt; acceptLinkageOrderOutboundWorkflow;</TD></TR><TR><TD CLASS="l">191</TD><TD>    private IWorkflowEngine&lt;RemoveOrderContext&gt; directRouteOMT;</TD></TR><TR><TD CLASS="l">192</TD><TD>    private IWorkflowEngine&lt;ManualTimeoutContext&gt; manualTimeoutWorkflow;</TD></TR><TR><TD CLASS="l">193</TD><TD>    private IWorkflowEngine&lt;RemoveOrderContext&gt; messageRouteOMT;</TD></TR><TR><TD CLASS="l">194</TD><TD>    private IWorkflowEngine&lt;BaseOHSContext&gt; forcedLogoffPARWorkflow;</TD></TR><TR><TD CLASS="l">195</TD><TD> </TD></TR><TR><TD CLASS="l">196</TD><TD>    private Logger log;</TD></TR><TR><TD CLASS="l">197</TD><TD>    private MarketDataService marketDataService;</TD></TR><TR><TD CLASS="l">198</TD><TD>    private UserDataCache userDataCache;</TD></TR><TR><TD CLASS="l">199</TD><TD>    private FirmMaintenanceService firmMaintenanceService;</TD></TR><TR><TD CLASS="l">200</TD><TD>    private OrderValidationStrategyHome orderValidationStrategyHome;</TD></TR><TR><TD CLASS="l">201</TD><TD>    private HybridClassConfigurationHome hybridClassConfigurationHome;</TD></TR><TR><TD CLASS="l">202</TD><TD>    private OrderRelationshipHome orderRelationshipHome;</TD></TR><TR><TD CLASS="l">203</TD><TD>    private OHSLinkageOrderHandlingService linkageOrderHandlingService;</TD></TR><TR><TD CLASS="l">204</TD><TD>    private MarketMakerQuoteService marketMakerQuoteService;</TD></TR><TR><TD CLASS="l">205</TD><TD>    private RoutedMessageHome routedMessageHome;</TD></TR><TR><TD CLASS="l">206</TD><TD>    private OrderRoutingConsumerOperations orderRoutingPublisher;</TD></TR><TR><TD CLASS="l">207</TD><TD>    //private OMTMessagePublisherHome omtMsgPublisherHome;</TD></TR><TR><TD CLASS="l">208</TD><TD>    private ManualOrderMaintenanceServiceHome manualOrderMaintenanceServiceHome;</TD></TR><TR><TD CLASS="l">209</TD><TD>    private static final int MAX_NUMBER_OF_EXCHANGES = 12;</TD></TR><TR><TD CLASS="l">210</TD><TD>    private static final String PAD_SUB_ACCOUNT = &#34;00&#34;;</TD></TR><TR><TD CLASS="l"><A NAME="0">211</A></TD><TD>    public static final int POS_SUB_ACCOUNT = 6;</TD></TR><TR><TD CLASS="l">212</TD><TD>    public static final int CONTRA_POS_SUB_ACCOUNT = 5;</TD></TR><TR><TD CLASS="l">213</TD><TD>    public static final String SOURCE_DELIMITER = &#34;:&#34;;</TD></TR><TR><TD CLASS="l">214</TD><TD>    public static final String TAG_DELIMITER = &#34;/&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">215</TD><TD>    private static final CharSequence PAD_OPT_DATA =&#34;000000&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">216</TD><TD>    private static final CharSequence CONTRA_PAD_OPT_DATA =&#34;00000&#34;;</TD></TR><TR><TD CLASS="l">217</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">218</TD><TD>    private String exceptionTypeAR = null;</TD></TR><TR CLASS="z"><TD CLASS="l">219</TD><TD>    private String orderBranchAR = null;</TD></TR><TR><TD CLASS="l">220</TD><TD>    private ManualReportHandlerHome manualReportHandlerHome;</TD></TR><TR><TD CLASS="l">221</TD><TD>    private AdminTextMessageServiceHome adminTextMessageServiceHome;</TD></TR><TR><TD CLASS="l">222</TD><TD>    private CancelReplaceValidator cxlRepValidator;</TD></TR><TR><TD CLASS="l">223</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">224</TD><TD>    private OrderStateLocationMapper orderStateLocationMapper = new OrderStateLocationMapper();</TD></TR><TR><TD CLASS="l">225</TD><TD>    </TD></TR><TR><TD CLASS="l">226</TD><TD>    private static final String            DEFAULT_TM_USERID    = &#34;&#34; + UserRoles.HELP_DESK;</TD></TR><TR><TD CLASS="l">227</TD><TD>    private static final int               DEFAULT_TM_ROLE      = TextMessageTypes.ROLE;</TD></TR><TR CLASS="z"><TD CLASS="l">228</TD><TD>    private UserAccessHelper accessHelper = new UserAccessHelper();</TD></TR><TR><TD CLASS="l">229</TD><TD>    private DIFCommonConfig commonConfig;</TD></TR><TR><TD CLASS="l">230</TD><TD>    private static final String INVALID_FIRM_MESSAGE = &#34;CTMR And TradereportEntry will contain a firm number of zero for this order: &#34;;</TD></TR><TR><TD CLASS="l">231</TD><TD>    private TSBQueue tsbQueue ;</TD></TR><TR><TD CLASS="l">232</TD><TD>    private transient FirmPropertyService firmPropertyService;</TD></TR><TR><TD CLASS="l">233</TD><TD>    private RoutingPropertyService routingPropertyService;</TD></TR><TR CLASS="z"><TD CLASS="l">234</TD><TD>    ConcurrentHashMap &lt;String, SessionProfileStruct&gt; validContraBrokers = new ConcurrentHashMap &lt;String, SessionProfileStruct&gt; ();</TD></TR><TR><TD CLASS="l">235</TD><TD>    </TD></TR><TR><TD CLASS="l">236</TD><TD>    /**</TD></TR><TR><TD CLASS="l">237</TD><TD>     * A last minute to change to fix the invalid acronym else</TD></TR><TR><TD CLASS="l">238</TD><TD>     * would prefer this in a IDL constant</TD></TR><TR><TD CLASS="l">239</TD><TD>     */</TD></TR><TR><TD CLASS="l">240</TD><TD>    public static final String INVALID_FIRM_ACRONYM = &#34;0&#34;;</TD></TR><TR><TD CLASS="l">241</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="2e">242</A></TD><TD>    private static final String IPADDRESSDELIMITER = &#34;.&#34;;</TD></TR><TR><TD CLASS="l">243</TD><TD> </TD></TR><TR><TD CLASS="l">244</TD><TD>    protected Collection&lt;DIFObject&gt; getHelpers()</TD></TR><TR><TD CLASS="l">245</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2">246</A></TD><TD>        return Arrays.asList((DIFObject)accessHelper, (DIFObject)cxlRepValidator);</TD></TR><TR><TD CLASS="l">247</TD><TD>    }</TD></TR><TR><TD CLASS="l">248</TD><TD> </TD></TR><TR><TD CLASS="l">249</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">250</TD><TD>    public ManualOrderMaintenanceServiceDelegateImpl()</TD></TR><TR><TD CLASS="l">251</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="63">252</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">253</TD><TD>    </TD></TR><TR><TD CLASS="l">254</TD><TD>    public final void setCancelReplaceValidator(CancelReplaceValidator theValidator)</TD></TR><TR><TD CLASS="l">255</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">256</TD><TD>        this.cxlRepValidator = theValidator;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="70">257</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">258</TD><TD> </TD></TR><TR><TD CLASS="l">259</TD><TD>    public final void setOrderHome(final OrderHome p_orderHome)</TD></TR><TR><TD CLASS="l">260</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">261</TD><TD>        orderHome = p_orderHome;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="64">262</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">263</TD><TD> </TD></TR><TR><TD CLASS="l">264</TD><TD>    public void setCommonConfig(DIFCommonConfig p_commonConfig)</TD></TR><TR><TD CLASS="l">265</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="78">266</A></TD><TD>        commonConfig = p_commonConfig;</TD></TR><TR CLASS="z"><TD CLASS="l">267</TD><TD>    }</TD></TR><TR><TD CLASS="l">268</TD><TD>    </TD></TR><TR><TD CLASS="l">269</TD><TD>    public final void setWorkflowHome(final WorkflowHome p_workflowHome) {</TD></TR><TR CLASS="z"><TD CLASS="l">270</TD><TD>        this.wfHome = p_workflowHome;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="74">271</A></TD><TD>        initWorkflows();</TD></TR><TR CLASS="z"><TD CLASS="l">272</TD><TD>    }</TD></TR><TR><TD CLASS="l">273</TD><TD> </TD></TR><TR><TD CLASS="l">274</TD><TD>    public void setProductDataCache(ProductDataCache p_productData) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="71">275</A></TD><TD>        productDataCache = p_productData;</TD></TR><TR CLASS="z"><TD CLASS="l">276</TD><TD>    }</TD></TR><TR><TD CLASS="l">277</TD><TD> </TD></TR><TR><TD CLASS="l">278</TD><TD>    public void setOrderRelationshipHome(OrderRelationshipHome p_orderRelationshipHome) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="75">279</A></TD><TD>        orderRelationshipHome = p_orderRelationshipHome;</TD></TR><TR CLASS="z"><TD CLASS="l">280</TD><TD>    }</TD></TR><TR><TD CLASS="l">281</TD><TD> </TD></TR><TR><TD CLASS="l">282</TD><TD>    public void setRoutedMessageHome(RoutedMessageHome p_routedMessageHome)  {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="72">283</A></TD><TD>        routedMessageHome = p_routedMessageHome;</TD></TR><TR CLASS="z"><TD CLASS="l">284</TD><TD>    }</TD></TR><TR><TD CLASS="l">285</TD><TD> </TD></TR><TR><TD CLASS="l">286</TD><TD>    public void setOrderRoutingPublisher(OrderRoutingConsumerOperations p_orderRoutingPublisher)  {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="6a">287</A></TD><TD>        this.orderRoutingPublisher = p_orderRoutingPublisher;</TD></TR><TR CLASS="z"><TD CLASS="l">288</TD><TD>    }</TD></TR><TR><TD CLASS="l">289</TD><TD> </TD></TR><TR><TD CLASS="l">290</TD><TD>    public void setManualOrderMaintenanceServiceHome(ManualOrderMaintenanceServiceHome p_MOMSH)  {</TD></TR><TR CLASS="z"><TD CLASS="l">291</TD><TD>        this.manualOrderMaintenanceServiceHome = p_MOMSH;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="32">292</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">293</TD><TD> </TD></TR><TR><TD CLASS="l">294</TD><TD>    private MOMNetworkInstrumentorHelper getNetworkInstrumentor()</TD></TR><TR><TD CLASS="l">295</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">296</TD><TD>        return manualOrderMaintenanceServiceHome.getMomNetworkInstrumentor();</TD></TR><TR><TD CLASS="l"><A NAME="2a">297</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">298</TD><TD> </TD></TR><TR><TD CLASS="l">299</TD><TD>    private DIFCommonConfig getCommonConfig()</TD></TR><TR><TD CLASS="l">300</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">301</TD><TD>        return commonConfig;</TD></TR><TR><TD CLASS="l"><A NAME="49">302</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">303</TD><TD>    </TD></TR><TR><TD CLASS="l">304</TD><TD>    private void initWorkflows()</TD></TR><TR><TD CLASS="l">305</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">306</TD><TD>        this.cancelFromNonOwnerOMTWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_CMI_CANCEL_NEW_WF.</TD></TR><TR CLASS="z"><TD CLASS="l">307</TD><TD>                verifyContextType(CancelContext.class),</TD></TR><TR CLASS="z"><TD CLASS="l">308</TD><TD>                WorkflowConstant.ACCEPT_CMI_CANCEL_NEW_WF.getWorkflowName());</TD></TR><TR CLASS="z"><TD CLASS="l">309</TD><TD>        this.cancelFromOwnerOMTWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_MANUAL_CANCEL_FROM_OMT.</TD></TR><TR CLASS="z"><TD CLASS="l">310</TD><TD>                verifyContextType(CancelContext.class),</TD></TR><TR CLASS="z"><TD CLASS="l">311</TD><TD>                WorkflowConstant.ACCEPT_MANUAL_CANCEL_FROM_OMT.getWorkflowName());</TD></TR><TR CLASS="z"><TD CLASS="l">312</TD><TD>        this.cancelReplaceFromOwnerOMTWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_MANUAL_CANCEL_REPLACE_FROM_OMT.</TD></TR><TR CLASS="z"><TD CLASS="l">313</TD><TD>                verifyContextType(CancelReplaceContext.class),</TD></TR><TR CLASS="z"><TD CLASS="l">314</TD><TD>                WorkflowConstant.ACCEPT_MANUAL_CANCEL_REPLACE_FROM_OMT.getWorkflowName());</TD></TR><TR CLASS="z"><TD CLASS="l">315</TD><TD>        this.cancelReplaceFromNonOwnerOMTWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_CMI_CANCEL_REPLACE_NEW_WF.</TD></TR><TR CLASS="z"><TD CLASS="l">316</TD><TD>                verifyContextType(CancelReplaceContext.class), WorkflowConstant.ACCEPT_CMI_CANCEL_REPLACE_NEW_WF.getWorkflowName());</TD></TR><TR CLASS="z"><TD CLASS="l">317</TD><TD>        this.manualCancelReportWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_MANUAL_CANCEL_REPORT</TD></TR><TR CLASS="z"><TD CLASS="l">318</TD><TD>                .verifyContextType(ManualCancelReportContext.class), WorkflowConstant.ACCEPT_MANUAL_CANCEL_REPORT</TD></TR><TR CLASS="z"><TD CLASS="l">319</TD><TD>                .getWorkflowName());</TD></TR><TR CLASS="z"><TD CLASS="l">320</TD><TD>        this.manualFillReportWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_MANUAL_FILL_REPORT</TD></TR><TR CLASS="z"><TD CLASS="l">321</TD><TD>                .verifyContextType(ManualFillReportContext.class), WorkflowConstant.ACCEPT_MANUAL_FILL_REPORT</TD></TR><TR CLASS="z"><TD CLASS="l">322</TD><TD>                .getWorkflowName());</TD></TR><TR CLASS="z"><TD CLASS="l">323</TD><TD>        this.manualFillOMTReportWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_OMT_MANUAL_FILL_REPORT</TD></TR><TR CLASS="z"><TD CLASS="l">324</TD><TD>                .verifyContextType(ManualFillReportContext.class), WorkflowConstant.ACCEPT_OMT_MANUAL_FILL_REPORT</TD></TR><TR CLASS="z"><TD CLASS="l">325</TD><TD>                .getWorkflowName());</TD></TR><TR><TD CLASS="l">326</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">327</TD><TD>        this.newOrderWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_CMI_ORDER</TD></TR><TR CLASS="z"><TD CLASS="l">328</TD><TD>                .verifyContextType(OrderContext.class), WorkflowConstant.ACCEPT_CMI_ORDER</TD></TR><TR CLASS="z"><TD CLASS="l">329</TD><TD>                .getWorkflowName());</TD></TR><TR CLASS="z"><TD CLASS="l">330</TD><TD>        this.orderRerouteHybridWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_REROUTE_ORDER_HYBRID_WF</TD></TR><TR CLASS="z"><TD CLASS="l">331</TD><TD>                .verifyContextType(OrderContext.class), WorkflowConstant.ACCEPT_REROUTE_ORDER_HYBRID_WF</TD></TR><TR CLASS="z"><TD CLASS="l">332</TD><TD>                .getWorkflowName());</TD></TR><TR><TD CLASS="l">333</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">334</TD><TD>        this.volumeChangeWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_VOLUME_CHANGED</TD></TR><TR CLASS="z"><TD CLASS="l">335</TD><TD>                .verifyContextType(OrderContext.class), WorkflowConstant.ACCEPT_VOLUME_CHANGED</TD></TR><TR CLASS="z"><TD CLASS="l">336</TD><TD>                .getWorkflowName());</TD></TR><TR><TD CLASS="l">337</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">338</TD><TD>        this.printCancelWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_PRINT_CANCEL</TD></TR><TR CLASS="z"><TD CLASS="l">339</TD><TD>                .verifyContextType(ManualCancelContext.class),</TD></TR><TR CLASS="z"><TD CLASS="l">340</TD><TD>                WorkflowConstant.ACCEPT_PRINT_CANCEL.getWorkflowName());</TD></TR><TR><TD CLASS="l">341</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">342</TD><TD>        this.printCancelReplaceWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_PRINT_CANCEL_REPLACE</TD></TR><TR CLASS="z"><TD CLASS="l">343</TD><TD>                .verifyContextType(ManualCancelReplaceContext.class),</TD></TR><TR CLASS="z"><TD CLASS="l">344</TD><TD>                WorkflowConstant.ACCEPT_PRINT_CANCEL_REPLACE.getWorkflowName());</TD></TR><TR><TD CLASS="l">345</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">346</TD><TD>        this.printRequestWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_PRINT_REQUEST</TD></TR><TR CLASS="z"><TD CLASS="l">347</TD><TD>                .verifyContextType(OrderContext.class), WorkflowConstant.ACCEPT_PRINT_REQUEST</TD></TR><TR CLASS="z"><TD CLASS="l">348</TD><TD>                .getWorkflowName());</TD></TR><TR><TD CLASS="l">349</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">350</TD><TD>        this.linkageInboundOrderFillReportWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_LINKAGE_INBOUND_ORDER_FILL_REPORT</TD></TR><TR CLASS="z"><TD CLASS="l">351</TD><TD>                .verifyContextType(ManualFillReportContext.class), WorkflowConstant.ACCEPT_LINKAGE_INBOUND_ORDER_FILL_REPORT</TD></TR><TR CLASS="z"><TD CLASS="l">352</TD><TD>                .getWorkflowName());</TD></TR><TR><TD CLASS="l">353</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">354</TD><TD>        this.acceptLinkageOrderOutboundWorkflow= wfHome.getWorkflow(WorkflowConstant.ACCEPT_LINKAGE_ORDER_ROUTING</TD></TR><TR CLASS="z"><TD CLASS="l">355</TD><TD>                .verifyContextType(OrderContext.class), WorkflowConstant.ACCEPT_LINKAGE_ORDER_ROUTING</TD></TR><TR CLASS="z"><TD CLASS="l">356</TD><TD>                .getWorkflowName());</TD></TR><TR><TD CLASS="l">357</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">358</TD><TD>        this.directRouteOMT = wfHome.getWorkflow(WorkflowConstant.ACCEPT_DIRECT_ROUTE_NEW</TD></TR><TR CLASS="z"><TD CLASS="l">359</TD><TD>                .verifyContextType(RemoveOrderContext.class), WorkflowConstant.ACCEPT_DIRECT_ROUTE_NEW</TD></TR><TR CLASS="z"><TD CLASS="l">360</TD><TD>                .getWorkflowName());</TD></TR><TR><TD CLASS="l">361</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">362</TD><TD>        this.manualTimeoutWorkflow = wfHome.getWorkflow(WorkflowConstant.ACCEPT_MANUAL_TIMEOUT</TD></TR><TR CLASS="z"><TD CLASS="l">363</TD><TD>                .verifyContextType(ManualTimeoutContext.class), WorkflowConstant.ACCEPT_MANUAL_TIMEOUT</TD></TR><TR CLASS="z"><TD CLASS="l">364</TD><TD>                .getWorkflowName());</TD></TR><TR><TD CLASS="l">365</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">366</TD><TD>        this.messageRouteOMT = wfHome.getWorkflow(WorkflowConstant.ROUTE_MESSAGE_TO_OMT</TD></TR><TR CLASS="z"><TD CLASS="l">367</TD><TD>                .verifyContextType(RemoveOrderContext.class), WorkflowConstant.ROUTE_MESSAGE_TO_OMT</TD></TR><TR CLASS="z"><TD CLASS="l">368</TD><TD>                .getWorkflowName());</TD></TR><TR><TD CLASS="l">369</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">370</TD><TD>        this.forcedLogoffPARWorkflow = wfHome.getWorkflow(WorkflowConstant.FORCED_LOGOFF_PAR_WORKSTATION</TD></TR><TR CLASS="z"><TD CLASS="l">371</TD><TD>                .verifyContextType(BaseOHSContext.class), WorkflowConstant.FORCED_LOGOFF_PAR_WORKSTATION</TD></TR><TR CLASS="z"><TD CLASS="l">372</TD><TD>                .getWorkflowName());</TD></TR><TR><TD CLASS="l">373</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">374</TD><TD>        assertNotNull(this.volumeChangeWorkflow, WorkflowConstant.ACCEPT_VOLUME_CHANGED.name());</TD></TR><TR CLASS="z"><TD CLASS="l">375</TD><TD>        assertNotNull(this.newOrderWorkflow, WorkflowConstant.ACCEPT_CMI_ORDER.name());</TD></TR><TR CLASS="z"><TD CLASS="l">376</TD><TD>        assertNotNull(this.cancelFromNonOwnerOMTWorkflow, WorkflowConstant.ACCEPT_CMI_CANCEL_NEW_WF.name());</TD></TR><TR CLASS="z"><TD CLASS="l">377</TD><TD>        assertNotNull(this.cancelFromOwnerOMTWorkflow, WorkflowConstant.ACCEPT_MANUAL_CANCEL_FROM_OMT.name());</TD></TR><TR CLASS="z"><TD CLASS="l">378</TD><TD>        assertNotNull(this.cancelReplaceFromOwnerOMTWorkflow, WorkflowConstant.ACCEPT_MANUAL_CANCEL_REPLACE_FROM_OMT.name());</TD></TR><TR CLASS="z"><TD CLASS="l">379</TD><TD>        assertNotNull(this.cancelReplaceFromNonOwnerOMTWorkflow, WorkflowConstant.ACCEPT_CMI_CANCEL_REPLACE_NEW_WF.name());</TD></TR><TR CLASS="z"><TD CLASS="l">380</TD><TD>        assertNotNull(this.manualCancelReportWorkflow, WorkflowConstant.ACCEPT_MANUAL_CANCEL_REPORT.name());</TD></TR><TR CLASS="z"><TD CLASS="l">381</TD><TD>        assertNotNull(this.manualFillReportWorkflow, WorkflowConstant.ACCEPT_MANUAL_FILL_REPORT.name());</TD></TR><TR CLASS="z"><TD CLASS="l">382</TD><TD>        assertNotNull(this.manualFillOMTReportWorkflow, WorkflowConstant.ACCEPT_OMT_MANUAL_FILL_REPORT.name());</TD></TR><TR CLASS="z"><TD CLASS="l">383</TD><TD>        assertNotNull(this.orderRerouteHybridWorkflow, WorkflowConstant.ACCEPT_REROUTE_ORDER.name());</TD></TR><TR CLASS="z"><TD CLASS="l">384</TD><TD>        assertNotNull(this.printCancelWorkflow, WorkflowConstant.ACCEPT_PRINT_CANCEL.name());</TD></TR><TR CLASS="z"><TD CLASS="l">385</TD><TD>        assertNotNull(this.printCancelReplaceWorkflow, WorkflowConstant.ACCEPT_PRINT_CANCEL_REPLACE.name());</TD></TR><TR CLASS="z"><TD CLASS="l">386</TD><TD>        assertNotNull(this.printRequestWorkflow, WorkflowConstant.ACCEPT_PRINT_REQUEST.name());</TD></TR><TR CLASS="z"><TD CLASS="l">387</TD><TD>        assertNotNull(this.linkageInboundOrderFillReportWorkflow, WorkflowConstant.ACCEPT_LINKAGE_INBOUND_ORDER_FILL_REPORT.name());</TD></TR><TR CLASS="z"><TD CLASS="l">388</TD><TD>        assertNotNull(this.acceptLinkageOrderOutboundWorkflow, WorkflowConstant.ACCEPT_LINKAGE_ORDER_ROUTING.name());</TD></TR><TR CLASS="z"><TD CLASS="l">389</TD><TD>        assertNotNull(this.directRouteOMT, WorkflowConstant.ACCEPT_DIRECT_ROUTE_NEW.name());</TD></TR><TR CLASS="z"><TD CLASS="l">390</TD><TD>        assertNotNull(this.manualTimeoutWorkflow, WorkflowConstant.ACCEPT_MANUAL_TIMEOUT.name());</TD></TR><TR CLASS="z"><TD CLASS="l">391</TD><TD>        assertNotNull(this.messageRouteOMT, WorkflowConstant.ROUTE_MESSAGE_TO_OMT.name());</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="17">392</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">393</TD><TD> </TD></TR><TR><TD CLASS="l">394</TD><TD>    private void assertNotNull(final Object p_ref, final String p_name) throws FatalFoundationFrameworkException</TD></TR><TR><TD CLASS="l">395</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">396</TD><TD>        if (p_ref == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">397</TD><TD>            throw new FatalFoundationFrameworkException(msg().add(p_name).add(&#34; reference is null!&#34;).end());</TD></TR><TR><TD CLASS="l"><A NAME="69">398</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">399</TD><TD>    }</TD></TR><TR><TD CLASS="l">400</TD><TD> </TD></TR><TR><TD CLASS="l">401</TD><TD>    public void  setLogger(Logger p_log){</TD></TR><TR CLASS="z"><TD CLASS="l">402</TD><TD>        log = p_log;</TD></TR><TR CLASS="z"><TD CLASS="l">403</TD><TD>    }</TD></TR><TR><TD CLASS="l">404</TD><TD> </TD></TR><TR><TD CLASS="l">405</TD><TD>    public void acceptManualCancelReport(OrderRoutingParameterStruct p_orderRoutingStruct,</TD></TR><TR><TD CLASS="l"><A NAME="7">406</A></TD><TD>                   ManualCancelReportStruct[] p_manualCancelReportStruct, int p_transactionSequenceNumber)</TD></TR><TR><TD CLASS="l">407</TD><TD>            throws DataValidationException, TransactionFailedException, CommunicationException, NotFoundException, SystemException, AuthorizationException, NotAcceptedException</TD></TR><TR><TD CLASS="l">408</TD><TD>    {</TD></TR><TR><TD CLASS="l">409</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">410</TD><TD>        log().info(msg().add(&#34;entering MOMDI.acceptManaulCancelReport &#34;));</TD></TR><TR><TD CLASS="l">411</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">412</TD><TD>        getNetworkInstrumentor().incrementManualCancelReportReceived(1);</TD></TR><TR><TD CLASS="l">413</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">414</TD><TD>        if (p_manualCancelReportStruct.length == 0)</TD></TR><TR><TD CLASS="l">415</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">416</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualCancelReport, received empty ManualCancelReport&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">417</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">418</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), 0);</TD></TR><TR><TD CLASS="l">419</TD><TD>        }</TD></TR><TR><TD CLASS="l">420</TD><TD> </TD></TR><TR><TD CLASS="l">421</TD><TD>        // find the order</TD></TR><TR CLASS="z"><TD CLASS="l">422</TD><TD>        Order order = findOrder(p_manualCancelReportStruct[0].orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">423</TD><TD>        if (order == null)</TD></TR><TR><TD CLASS="l">424</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">425</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualCancelReport, Order not found for &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">426</TD><TD>            .add(&#34;OrderId&#34;, new OrderId(p_manualCancelReportStruct[0].orderId).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">427</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">428</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">429</TD><TD>        }</TD></TR><TR><TD CLASS="l">430</TD><TD> </TD></TR><TR><TD CLASS="l">431</TD><TD>        // check order ownership</TD></TR><TR CLASS="z"><TD CLASS="l">432</TD><TD>        if(p_orderRoutingStruct.sourceType != order.getLocationType()) {</TD></TR><TR CLASS="z"><TD CLASS="l">433</TD><TD>            String msg = getCancelReportMessageText(order,p_orderRoutingStruct,p_manualCancelReportStruct,p_manualCancelReportStruct[0].cancelledQuantity, p_manualCancelReportStruct[0].legCancelVolumes);</TD></TR><TR CLASS="z"><TD CLASS="l">434</TD><TD>            final MsgBuilder msgBuilder = msg().add(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">435</TD><TD>            log().alarm(msgBuilder);</TD></TR><TR CLASS="z"><TD CLASS="l">436</TD><TD>            sendMessageToHelpDesk(getCancelReportSubject(p_orderRoutingStruct) , msg);</TD></TR><TR CLASS="z"><TD CLASS="l">437</TD><TD>            return;</TD></TR><TR><TD CLASS="l">438</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">439</TD><TD>        validateCancelQty(p_orderRoutingStruct, order, p_manualCancelReportStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">440</TD><TD>        ManualCancelReportContext context = new ManualCancelReportContext();</TD></TR><TR CLASS="z"><TD CLASS="l">441</TD><TD>        context.setRoutingParams(p_orderRoutingStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">442</TD><TD>        context.setManualCancelReport(p_manualCancelReportStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">443</TD><TD>        context.setTransactionSequenceNumber(p_transactionSequenceNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">444</TD><TD>        context.setOrder(order);</TD></TR><TR CLASS="z"><TD CLASS="l">445</TD><TD>        context.setManualRequest(true);</TD></TR><TR><TD CLASS="l">446</TD><TD> </TD></TR><TR><TD CLASS="l">447</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">448</TD><TD>            this.manualCancelReportWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">449</TD><TD>            if (context.getException() != null)</TD></TR><TR><TD CLASS="l">450</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">451</TD><TD>                maybeThrow(context);</TD></TR><TR><TD CLASS="l">452</TD><TD>            }</TD></TR><TR><TD CLASS="l">453</TD><TD>            else</TD></TR><TR><TD CLASS="l">454</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">455</TD><TD>                getNetworkInstrumentor().incrementManualCancelReportSent(1);</TD></TR><TR><TD CLASS="l">456</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">457</TD><TD>            decrementParPendingCancelQty(context, order, p_manualCancelReportStruct);</TD></TR><TR><TD CLASS="l">458</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">459</TD><TD>        catch (TransactionFailedException e)</TD></TR><TR><TD CLASS="l">460</TD><TD>        {</TD></TR><TR><TD CLASS="l">461</TD><TD>            // should be handled in the workflow: Defensive check</TD></TR><TR CLASS="z"><TD CLASS="l">462</TD><TD>            log.alarm(msg().add(&#34;TransactionFailedException on acceptManualCancelReport: &#34;).add(e));</TD></TR><TR><TD CLASS="l">463</TD><TD>        }</TD></TR><TR><TD CLASS="l">464</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">465</TD><TD>        finally {</TD></TR><TR><TD CLASS="l">466</TD><TD>            // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">467</TD><TD>            if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">468</TD><TD>                log.alarm(msg().add( &#34;Rolling back transaction in acceptManualCancelReport &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">469</TD><TD>                Transaction.rollback();</TD></TR><TR><TD CLASS="l">470</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">471</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">472</TD><TD>    }</TD></TR><TR><TD CLASS="l">473</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="7b">474</A></TD><TD>    private void validateCancelQty(OrderRoutingParameterStruct p_orderRoutingStruct,</TD></TR><TR><TD CLASS="l">475</TD><TD>            Order theOrder, ManualCancelReportStruct[] p_manualCancelReportStruct)</TD></TR><TR><TD CLASS="l">476</TD><TD>    {</TD></TR><TR><TD CLASS="l">477</TD><TD>        // check order's remaining qty</TD></TR><TR CLASS="z"><TD CLASS="l">478</TD><TD>        int remainingQty = theOrder.getRemainingQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">479</TD><TD>        StringBuffer msg = new StringBuffer(&#34;ManualCancelReport received for Order : &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">480</TD><TD>        msg.append(new OrderId(p_manualCancelReportStruct[0].orderId).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">481</TD><TD>        msg.append(&#34; sent by PAR: &#34; + p_orderRoutingStruct.source);</TD></TR><TR CLASS="z"><TD CLASS="l">482</TD><TD>        msg.append(&#34; has remaining qty &#34; + remainingQty);</TD></TR><TR CLASS="z"><TD CLASS="l">483</TD><TD>        boolean hasMismatchedQty = false;</TD></TR><TR CLASS="z"><TD CLASS="l">484</TD><TD>        if(theOrder.isStrategy()) {</TD></TR><TR CLASS="z"><TD CLASS="l">485</TD><TD>            LegOrderDetail[] legs = theOrder.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">486</TD><TD>            int sizeOfLegs = legs.length;</TD></TR><TR CLASS="z"><TD CLASS="l">487</TD><TD>            int cancelReportLegsLength = p_manualCancelReportStruct[0].legCancelVolumes.length;</TD></TR><TR CLASS="z"><TD CLASS="l">488</TD><TD>            for (int j=0; j &lt; sizeOfLegs &amp;&amp; j &lt; cancelReportLegsLength; j++) {</TD></TR><TR CLASS="z"><TD CLASS="l">489</TD><TD>                int qty = p_manualCancelReportStruct[0].legCancelVolumes[j];</TD></TR><TR CLASS="z"><TD CLASS="l">490</TD><TD>                int legLeavesQty = legs[j].getLeavesQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">491</TD><TD>                if (legLeavesQty - qty &lt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">492</TD><TD>                    msg.append(&#34; via invild leg cancel quantity &#34; + qty);</TD></TR><TR CLASS="z"><TD CLASS="l">493</TD><TD>                    hasMismatchedQty = true;</TD></TR><TR CLASS="z"><TD CLASS="l">494</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">495</TD><TD>                }</TD></TR><TR><TD CLASS="l">496</TD><TD>            }        </TD></TR><TR><TD CLASS="l">497</TD><TD>        }</TD></TR><TR><TD CLASS="l">498</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">499</TD><TD>            if (remainingQty - p_manualCancelReportStruct[0].cancelledQuantity &lt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">500</TD><TD>                msg.append(&#34; via invild cancel quantity &#34; + p_manualCancelReportStruct[0].cancelledQuantity);</TD></TR><TR CLASS="z"><TD CLASS="l">501</TD><TD>                hasMismatchedQty = true;</TD></TR><TR><TD CLASS="l">502</TD><TD>            }</TD></TR><TR><TD CLASS="l">503</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">504</TD><TD>        if (hasMismatchedQty) {</TD></TR><TR CLASS="z"><TD CLASS="l">505</TD><TD>            final MsgBuilder msgBuilder = msg().add(msg.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">506</TD><TD>            log().alarm(msgBuilder);</TD></TR><TR CLASS="z"><TD CLASS="l">507</TD><TD>            sendMessageToHelpDesk(&#34;Invalid Cancel&#34;, msg.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">508</TD><TD>            return;</TD></TR><TR><TD CLASS="l">509</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="21">510</A></TD><TD>    }        </TD></TR><TR><TD CLASS="l">511</TD><TD>    </TD></TR><TR><TD CLASS="l">512</TD><TD>    private void decrementParPendingCancelQty(BaseOHSContext p_context, Order theOrder, ManualCancelReportStruct[] p_manualCancelReportStruct) throws TransactionFailedException</TD></TR><TR><TD CLASS="l">513</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">514</TD><TD>        p_context.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">515</TD><TD>        if(theOrder.isStrategy()) {</TD></TR><TR CLASS="z"><TD CLASS="l">516</TD><TD>            for (int qty : p_manualCancelReportStruct[0].legCancelVolumes) {</TD></TR><TR CLASS="z"><TD CLASS="l">517</TD><TD>                if (qty &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">518</TD><TD>                    theOrder.setParPendingCancelQuantity(0);</TD></TR><TR CLASS="z"><TD CLASS="l">519</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">520</TD><TD>                }</TD></TR><TR><TD CLASS="l">521</TD><TD>            }</TD></TR><TR><TD CLASS="l">522</TD><TD>        }</TD></TR><TR><TD CLASS="l">523</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">524</TD><TD>            int pendingCancelQty = theOrder.getParPendingCancelQuantity() - p_manualCancelReportStruct[0].cancelledQuantity;</TD></TR><TR CLASS="z"><TD CLASS="l">525</TD><TD>            theOrder.setParPendingCancelQuantity(pendingCancelQty &lt; 0 ? 0 : pendingCancelQty);</TD></TR><TR><TD CLASS="l">526</TD><TD>        } </TD></TR><TR CLASS="z"><TD CLASS="l">527</TD><TD>        p_context.commitTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3b">528</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">529</TD><TD> </TD></TR><TR><TD CLASS="l">530</TD><TD>    private String getQuantitiesString(Order order, int quantity, int[] legQuantities)</TD></TR><TR><TD CLASS="l">531</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">532</TD><TD>        String retStr = &#34;quantity = &#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">533</TD><TD>        if(!order.isStrategy()) {</TD></TR><TR CLASS="z"><TD CLASS="l">534</TD><TD>            retStr = retStr + quantity;</TD></TR><TR><TD CLASS="l">535</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">536</TD><TD>        else if(legQuantities != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">537</TD><TD>            for(int i =0 ;i &lt; legQuantities.length ; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">538</TD><TD>                retStr = &#34;leg&#34; + i + retStr + legQuantities[i];</TD></TR><TR><TD CLASS="l">539</TD><TD>            }</TD></TR><TR><TD CLASS="l">540</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">541</TD><TD>        return retStr;</TD></TR><TR><TD CLASS="l">542</TD><TD>    }</TD></TR><TR><TD CLASS="l">543</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="b">544</A></TD><TD>    public void acceptManualOrderReturn(ManualMarketBrokerDataStruct marketData,OrderRoutingParameterStruct p_orderRouting, OrderIdStruct p_orderID,</TD></TR><TR><TD CLASS="l">545</TD><TD>            String p_sessionName, int p_productKey, OrderHandlingInstructionStruct p_orderHandling,</TD></TR><TR><TD CLASS="l">546</TD><TD>            int[] legMaxExecutionVolumes, long p_requestTimet, short activityType) throws SystemException, CommunicationException, DataValidationException, NotFoundException, AuthorizationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">547</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">548</TD><TD>        getNetworkInstrumentor().incrementManualOrderReturnReceived(1);</TD></TR><TR><TD CLASS="l">549</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">550</TD><TD>        log().info(msg().add(&#34;entering MOMDI.acceptManualOrderReturn &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">551</TD><TD>        testARException(p_orderID);</TD></TR><TR CLASS="z"><TD CLASS="l">552</TD><TD>        validateOrderId(p_orderID);</TD></TR><TR><TD CLASS="l">553</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">554</TD><TD>        Order order = findOrder(p_orderID);</TD></TR><TR CLASS="z"><TD CLASS="l">555</TD><TD>        if (order == null)</TD></TR><TR><TD CLASS="l">556</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">557</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualOrderReturn, Order Not Found for &#34;).add(&#34;OrderId&#34;, new OrderId(p_orderID).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">558</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">559</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">560</TD><TD>        }</TD></TR><TR><TD CLASS="l">561</TD><TD> </TD></TR><TR><TD CLASS="l">562</TD><TD>        // check order ownership</TD></TR><TR CLASS="z"><TD CLASS="l">563</TD><TD>        if(p_orderRouting.sourceType != order.getLocationType()) {</TD></TR><TR CLASS="z"><TD CLASS="l">564</TD><TD>            String actString = ManualActivityHelper.getActivityString(activityType);</TD></TR><TR CLASS="z"><TD CLASS="l">565</TD><TD>            String msg =  getTaTBMessageText(order, p_orderRouting,p_orderID,actString, p_orderHandling.maximumExecutionVolume, legMaxExecutionVolumes);</TD></TR><TR CLASS="z"><TD CLASS="l">566</TD><TD>            final MsgBuilder msgBuilder = msg().add(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">567</TD><TD>            log().alarm(msgBuilder);</TD></TR><TR CLASS="z"><TD CLASS="l">568</TD><TD>            sendMessageToHelpDesk(getTradeAllTradeBook(p_orderRouting,actString),msg);</TD></TR><TR CLASS="z"><TD CLASS="l">569</TD><TD>            return;</TD></TR><TR><TD CLASS="l">570</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">571</TD><TD>        OrderStruct orderStruct = order.getStruct();</TD></TR><TR><TD CLASS="l">572</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">573</TD><TD>        LegOrderEntryStructV2[] p_legEntryDetails = getLegOrderEntries(order, orderStruct);</TD></TR><TR><TD CLASS="l">574</TD><TD> </TD></TR><TR><TD CLASS="l">575</TD><TD>        //Use the Manual as the session name to get the Manual strategy other than the CMI</TD></TR><TR CLASS="z"><TD CLASS="l">576</TD><TD>        OrderValidationStrategy strategy = getOrderValidationStrategy(OrderValidationStrategy.HYBRID_MANUAL);</TD></TR><TR><TD CLASS="l">577</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">578</TD><TD>        if (p_legEntryDetails == null)</TD></TR><TR><TD CLASS="l">579</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">580</TD><TD>            switch (activityType)</TD></TR><TR><TD CLASS="l">581</TD><TD>            {</TD></TR><TR><TD CLASS="l">582</TD><TD>                case ActivityTypes.MANUAL_ORDER_TA:</TD></TR><TR><TD CLASS="l">583</TD><TD>                case ActivityTypes.MANUAL_ORDER_TB:</TD></TR><TR><TD CLASS="l">584</TD><TD>                case ActivityTypes.MANUAL_ORDER_SR:    </TD></TR><TR><TD CLASS="l">585</TD><TD>                case ActivityTypes.MANUAL_ORDER_FR:</TD></TR><TR CLASS="z"><TD CLASS="l">586</TD><TD>                    strategy.validateSimpleTrade(order, orderStruct, p_orderHandling, false); // false indicates zero qantity order is not allowed</TD></TR><TR CLASS="z"><TD CLASS="l">587</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">588</TD><TD>                case ActivityTypes.MANUAL_ORDER_BOOK:</TD></TR><TR CLASS="z"><TD CLASS="l">589</TD><TD>                    strategy.validateSimpleBook(order, orderStruct, p_orderHandling, false); // false indicates zero qantity order is not allowed</TD></TR><TR CLASS="z"><TD CLASS="l">590</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">591</TD><TD>                default:</TD></TR><TR CLASS="z"><TD CLASS="l">592</TD><TD>                    throw ExceptionBuilder.dataValidationException((&#34;Invalid Activity Code:&#34; + activityType),</TD></TR><TR CLASS="z"><TD CLASS="l">593</TD><TD>                            DataValidationCodes.INVALID_TRADE_TYPE);</TD></TR><TR><TD CLASS="l">594</TD><TD>            }</TD></TR><TR><TD CLASS="l">595</TD><TD>        }</TD></TR><TR><TD CLASS="l">596</TD><TD>        else</TD></TR><TR><TD CLASS="l">597</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">598</TD><TD>            switch (activityType)</TD></TR><TR><TD CLASS="l">599</TD><TD>            {</TD></TR><TR><TD CLASS="l">600</TD><TD>                case ActivityTypes.MANUAL_ORDER_TA:</TD></TR><TR><TD CLASS="l">601</TD><TD>                case ActivityTypes.MANUAL_ORDER_TB:</TD></TR><TR CLASS="z"><TD CLASS="l">602</TD><TD>                    strategy.validateComplexTrade(order, orderStruct, p_legEntryDetails, p_orderHandling, false); // false indicates zero qantity order is not allowed</TD></TR><TR CLASS="z"><TD CLASS="l">603</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">604</TD><TD>                case ActivityTypes.MANUAL_ORDER_BOOK:</TD></TR><TR CLASS="z"><TD CLASS="l">605</TD><TD>                    strategy.validateComplexBook(order, orderStruct, p_legEntryDetails, p_orderHandling, false); // false indicates zero qantity order is not allowed</TD></TR><TR CLASS="z"><TD CLASS="l">606</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">607</TD><TD>                case ActivityTypes.MANUAL_ORDER_AUCTION:</TD></TR><TR CLASS="z"><TD CLASS="l">608</TD><TD>                    strategy.validateComplexAuction(order, orderStruct, p_legEntryDetails, p_orderHandling, false); // false indicates zero qantity order is not allowed</TD></TR><TR CLASS="z"><TD CLASS="l">609</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">610</TD><TD>                default:</TD></TR><TR CLASS="z"><TD CLASS="l">611</TD><TD>                    throw ExceptionBuilder.dataValidationException((&#34;Invalid Activity Code:&#34; + activityType),</TD></TR><TR CLASS="z"><TD CLASS="l">612</TD><TD>                            DataValidationCodes.INVALID_TRADE_TYPE);</TD></TR><TR><TD CLASS="l">613</TD><TD>            }</TD></TR><TR><TD CLASS="l">614</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">615</TD><TD>            if(order.getProductType() == ProductTypes.STRATEGY) {</TD></TR><TR CLASS="z"><TD CLASS="l">616</TD><TD>                p_orderHandling.maximumExecutionVolume = calculateMaximumExecutionVolume(legMaxExecutionVolumes, order.getLegOrderDetails(), order.getOriginalQuantity());</TD></TR><TR><TD CLASS="l">617</TD><TD>            }</TD></TR><TR><TD CLASS="l">618</TD><TD>            else {</TD></TR><TR CLASS="z"><TD CLASS="l">619</TD><TD>            if (p_orderHandling.maximumExecutionVolume == 0)</TD></TR><TR><TD CLASS="l">620</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">621</TD><TD>                p_orderHandling.maximumExecutionVolume = order.getOriginalQuantity();</TD></TR><TR><TD CLASS="l">622</TD><TD>            }</TD></TR><TR><TD CLASS="l">623</TD><TD>        }</TD></TR><TR><TD CLASS="l">624</TD><TD>        }</TD></TR><TR><TD CLASS="l">625</TD><TD>        /*</TD></TR><TR><TD CLASS="l">626</TD><TD>         * If it is TA/TB and Auction return is expected</TD></TR><TR><TD CLASS="l">627</TD><TD>         * If it is Book, it is not. The NBBO reject should go</TD></TR><TR><TD CLASS="l">628</TD><TD>         * to classLevelPAR. </TD></TR><TR><TD CLASS="l">629</TD><TD>         * SEDL#8104- if the order is Book, it should be returned to</TD></TR><TR><TD CLASS="l">630</TD><TD>         * the sender</TD></TR><TR><TD CLASS="l">631</TD><TD>         */</TD></TR><TR><TD CLASS="l">632</TD><TD>        //if(activityType != ActivityTypes.MANUAL_ORDER_BOOK ) {</TD></TR><TR CLASS="z"><TD CLASS="l">633</TD><TD>        order.setReturnExpected(true);</TD></TR><TR><TD CLASS="l">634</TD><TD> </TD></TR><TR><TD CLASS="l">635</TD><TD>        //}</TD></TR><TR><TD CLASS="l">636</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">637</TD><TD>        order.setPreviousLocation(p_orderRouting.source);</TD></TR><TR CLASS="z"><TD CLASS="l">638</TD><TD>        order.setPreviousLocationType(p_orderRouting.sourceType);</TD></TR><TR><TD CLASS="l">639</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">640</TD><TD>        executeOrderWithInstructions(p_orderRouting, orderStruct, order, p_orderHandling, activityType, marketData);</TD></TR><TR><TD CLASS="l">641</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">642</TD><TD>        getNetworkInstrumentor().incrementManualOrderReturnSent(1);</TD></TR><TR><TD CLASS="l">643</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2f">644</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">645</TD><TD> </TD></TR><TR><TD CLASS="l">646</TD><TD>    private LegOrderEntryStructV2[] getLegOrderEntries(Order p_order, OrderStruct orderStruct)</TD></TR><TR><TD CLASS="l">647</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">648</TD><TD>        if(p_order.getProductType() == ProductTypes.OPTION) {</TD></TR><TR CLASS="z"><TD CLASS="l">649</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">650</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">651</TD><TD>        LegOrderDetail[] legs = p_order.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">652</TD><TD>        LegOrderEntryStructV2[] legOrderEntries = new LegOrderEntryStructV2[legs.length];</TD></TR><TR><TD CLASS="l">653</TD><TD> </TD></TR><TR><TD CLASS="l">654</TD><TD>        // No info from PAR, can we use mustUsePrices from the order for leg prices... ???</TD></TR><TR CLASS="z"><TD CLASS="l">655</TD><TD>        for(int i=0 ; i&lt; legOrderEntries.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">656</TD><TD>            legOrderEntries[i] = new LegOrderEntryStructV2();</TD></TR><TR CLASS="z"><TD CLASS="l">657</TD><TD>            legOrderEntries[i].legOrderEntry = new LegOrderEntryStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">658</TD><TD>            legOrderEntries[i].legOrderEntry.clearingFirm = new ExchangeFirmStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">659</TD><TD>            legOrderEntries[i].legOrderEntry.mustUsePrice = new PriceStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">660</TD><TD>            legOrderEntries[i].legOrderEntry.clearingFirm = p_order.getClearingFirm();</TD></TR><TR CLASS="z"><TD CLASS="l">661</TD><TD>            legOrderEntries[i].legOrderEntry.coverage = orderStruct.coverage;</TD></TR><TR CLASS="z"><TD CLASS="l">662</TD><TD>            legOrderEntries[i].legOrderEntry.mustUsePrice = legs[i].getMustUsePrice().toStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">663</TD><TD>            legOrderEntries[i].legOrderEntry.positionEffect = orderStruct.positionEffect;</TD></TR><TR CLASS="z"><TD CLASS="l">664</TD><TD>            legOrderEntries[i].legOrderEntry.productKey = legs[i].getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">665</TD><TD>            legOrderEntries[i].side = legs[i].getSideValue();</TD></TR><TR><TD CLASS="l">666</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">667</TD><TD>        return legOrderEntries;</TD></TR><TR><TD CLASS="l">668</TD><TD>    }</TD></TR><TR><TD CLASS="l">669</TD><TD> </TD></TR><TR><TD CLASS="l">670</TD><TD>    public void acceptPrintCancel(OrderRoutingParameterStruct p_orderRoutingStruct,</TD></TR><TR><TD CLASS="l"><A NAME="10">671</A></TD><TD>            ManualCancelRequestStruct p_manualCancelRequestStruct, int p_productKey)</TD></TR><TR><TD CLASS="l">672</TD><TD>    throws SystemException, NotFoundException, CommunicationException, DataValidationException,</TD></TR><TR><TD CLASS="l">673</TD><TD>        AuthorizationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">674</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">675</TD><TD>        log().info(msg().add(&#34;entering MOMDI.acceptPrintCancel &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">676</TD><TD>        getNetworkInstrumentor().incrementPrintCancelReceived(1);</TD></TR><TR><TD CLASS="l">677</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">678</TD><TD>        if (p_manualCancelRequestStruct == null)</TD></TR><TR><TD CLASS="l">679</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">680</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptPrintCancel, received empty ManualCancelRequestStruct&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">681</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">682</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), 0);</TD></TR><TR><TD CLASS="l">683</TD><TD>        }</TD></TR><TR><TD CLASS="l">684</TD><TD> </TD></TR><TR><TD CLASS="l">685</TD><TD>        // find the order</TD></TR><TR CLASS="z"><TD CLASS="l">686</TD><TD>        Order order = findOrder(p_manualCancelRequestStruct.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">687</TD><TD>        if (order == null)</TD></TR><TR><TD CLASS="l">688</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">689</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptPrintCancel, Order Not Found For : &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">690</TD><TD>            .add(&#34;OrderId&#34;, new OrderId(p_manualCancelRequestStruct.orderId).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">691</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">692</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">693</TD><TD>        }</TD></TR><TR><TD CLASS="l">694</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">695</TD><TD>        ProductKeysStruct productKeys = getProductData(order.getProductKey()).getProductKeysStruct();</TD></TR><TR><TD CLASS="l">696</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">697</TD><TD>        ManualCancelContext context = new ManualCancelContext(p_manualCancelRequestStruct, productKeys);</TD></TR><TR CLASS="z"><TD CLASS="l">698</TD><TD>        context.setRoutingParams(p_orderRoutingStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">699</TD><TD>        context.setOrder(order);</TD></TR><TR CLASS="z"><TD CLASS="l">700</TD><TD>        context.setRouteReason(OHSRoutingReason.PAR_PRINT_CANCEL.getOHSRoutingReason());</TD></TR><TR CLASS="z"><TD CLASS="l">701</TD><TD>        context.setManualRequest(true);</TD></TR><TR><TD CLASS="l">702</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">703</TD><TD>            this.printCancelWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">704</TD><TD>            if (context.getException() != null)</TD></TR><TR><TD CLASS="l">705</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">706</TD><TD>                maybeThrow(context);</TD></TR><TR><TD CLASS="l">707</TD><TD>            }</TD></TR><TR><TD CLASS="l">708</TD><TD>            else</TD></TR><TR><TD CLASS="l">709</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">710</TD><TD>                getNetworkInstrumentor().incrementPrintCancelSent(1);</TD></TR><TR><TD CLASS="l">711</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">712</TD><TD>            decrementParPendingCancelQty(context, order, p_manualCancelRequestStruct);</TD></TR><TR><TD CLASS="l">713</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">714</TD><TD>        finally {</TD></TR><TR><TD CLASS="l">715</TD><TD>            // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">716</TD><TD>            if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">717</TD><TD>                log.alarm(msg().add( &#34;Rolling back transaction in acceptPrintCancel &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">718</TD><TD>                Transaction.rollback();</TD></TR><TR><TD CLASS="l">719</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">720</TD><TD>        }</TD></TR><TR><TD CLASS="l">721</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="22">722</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">723</TD><TD> </TD></TR><TR><TD CLASS="l">724</TD><TD>    private void decrementParPendingCancelQty(BaseOHSContext p_context, Order theOrder, ManualCancelRequestStruct p_manualCancelRequestStruct) throws TransactionFailedException</TD></TR><TR><TD CLASS="l">725</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">726</TD><TD>        p_context.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">727</TD><TD>        if(theOrder.isStrategy()) {</TD></TR><TR CLASS="z"><TD CLASS="l">728</TD><TD>            for (int qty : p_manualCancelRequestStruct.legCancelVolumes) {</TD></TR><TR CLASS="z"><TD CLASS="l">729</TD><TD>                if (qty &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">730</TD><TD>                    theOrder.setParPendingCancelQuantity(0);</TD></TR><TR CLASS="z"><TD CLASS="l">731</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">732</TD><TD>                }</TD></TR><TR><TD CLASS="l">733</TD><TD>            }</TD></TR><TR><TD CLASS="l">734</TD><TD>        }</TD></TR><TR><TD CLASS="l">735</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">736</TD><TD>            int pendingCancelQty = theOrder.getParPendingCancelQuantity() - p_manualCancelRequestStruct.quantity;</TD></TR><TR CLASS="z"><TD CLASS="l">737</TD><TD>            theOrder.setParPendingCancelQuantity(pendingCancelQty &lt; 0 ? 0 : pendingCancelQty);</TD></TR><TR><TD CLASS="l">738</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">739</TD><TD>        p_context.commitTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="11">740</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">741</TD><TD>    </TD></TR><TR><TD CLASS="l">742</TD><TD>    public void acceptPrintCancelReplace(OrderRoutingParameterStruct p_orderRoutingStruct, ManualCancelRequestStruct p_cancelRequest, OrderIdStruct p_orderID, int p_productKey) throws SystemException, CommunicationException, DataValidationException, NotFoundException, AuthorizationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">743</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">744</TD><TD>        log().info(msg().add(&#34;entering MOMDI.acceptPrintCancelReplace &#34;));</TD></TR><TR><TD CLASS="l">745</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">746</TD><TD>        getNetworkInstrumentor().incrementPrintCancelReplaceReceived(1);</TD></TR><TR><TD CLASS="l">747</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">748</TD><TD>        if (p_cancelRequest == null)</TD></TR><TR><TD CLASS="l">749</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">750</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptPrintCancelReplace, received empty ManualCancelRequestStruct&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">751</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">752</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), 0);</TD></TR><TR><TD CLASS="l">753</TD><TD>        }</TD></TR><TR><TD CLASS="l">754</TD><TD> </TD></TR><TR><TD CLASS="l">755</TD><TD>        // find the order</TD></TR><TR CLASS="z"><TD CLASS="l">756</TD><TD>        Order order = findOrder(p_cancelRequest.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">757</TD><TD>        if (order == null)</TD></TR><TR><TD CLASS="l">758</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">759</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptPrintCancelReplace, Order Not Found for: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">760</TD><TD>            .add(&#34;OrderId&#34;, new OrderId(p_cancelRequest.orderId).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">761</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">762</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">763</TD><TD>        }</TD></TR><TR><TD CLASS="l">764</TD><TD> </TD></TR><TR><TD CLASS="l">765</TD><TD> </TD></TR><TR><TD CLASS="l">766</TD><TD> </TD></TR><TR><TD CLASS="l">767</TD><TD> </TD></TR><TR><TD CLASS="l">768</TD><TD>        //find the replacement order</TD></TR><TR CLASS="z"><TD CLASS="l">769</TD><TD>        Order replOrder = findOrder(p_orderID);</TD></TR><TR CLASS="z"><TD CLASS="l">770</TD><TD>        if (replOrder == null)</TD></TR><TR><TD CLASS="l">771</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">772</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptPrintCancelReplace,Order Not Found for: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">773</TD><TD>            .add(&#34;Replacement OrderId&#34;, new OrderId(p_orderID).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">774</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">775</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">776</TD><TD>        }</TD></TR><TR><TD CLASS="l">777</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">778</TD><TD>        ProductKeysStruct productKeys = new ProductKeysStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">779</TD><TD>        productKeys.classKey = order.getClassKey();</TD></TR><TR CLASS="z"><TD CLASS="l">780</TD><TD>        productKeys.productKey = order.getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">781</TD><TD>        productKeys.productType = order.getProductType();</TD></TR><TR><TD CLASS="l">782</TD><TD>        //TODO</TD></TR><TR><TD CLASS="l">783</TD><TD>//        productKeys.reportingClass = order.get</TD></TR><TR><TD CLASS="l">784</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">785</TD><TD>        ManualCancelReplaceContext context = new ManualCancelReplaceContext(p_cancelRequest, productKeys);</TD></TR><TR CLASS="z"><TD CLASS="l">786</TD><TD>        context.setRoutingParams(p_orderRoutingStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">787</TD><TD>        context.setOrder(order);</TD></TR><TR CLASS="z"><TD CLASS="l">788</TD><TD>        context.setReplacementOrder(replOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">789</TD><TD>        context.setRouteReason(OHSRoutingReason.PAR_PRINT_CANCEL_REPLACE.getOHSRoutingReason());</TD></TR><TR CLASS="z"><TD CLASS="l">790</TD><TD>        context.setManualRequest(true);</TD></TR><TR><TD CLASS="l">791</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">792</TD><TD>            this.printCancelReplaceWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">793</TD><TD>            if (context.getException() != null)</TD></TR><TR><TD CLASS="l">794</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">795</TD><TD>                maybeThrow(context);</TD></TR><TR><TD CLASS="l">796</TD><TD>            }</TD></TR><TR><TD CLASS="l">797</TD><TD>            else</TD></TR><TR><TD CLASS="l">798</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">799</TD><TD>                getNetworkInstrumentor().incrementPrintCancelReplaceSent(1);</TD></TR><TR><TD CLASS="l">800</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">801</TD><TD>            decrementParPendingCancelQty(context, order, p_cancelRequest);</TD></TR><TR><TD CLASS="l">802</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">803</TD><TD>        finally {</TD></TR><TR><TD CLASS="l">804</TD><TD>            // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">805</TD><TD>            if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">806</TD><TD>                log.alarm(msg().add( &#34;Rolling back transaction in acceptPrintCancelReplace &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">807</TD><TD>                Transaction.rollback();</TD></TR><TR><TD CLASS="l">808</TD><TD>            }</TD></TR><TR><TD CLASS="l">809</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">810</TD><TD>        }</TD></TR><TR><TD CLASS="l">811</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">812</TD><TD>    }</TD></TR><TR><TD CLASS="l">813</TD><TD> </TD></TR><TR><TD CLASS="l">814</TD><TD>    private OrderIdStruct executeOrderWithInstructions(OrderRoutingParameterStruct p_orderRoutingStruct,</TD></TR><TR><TD CLASS="l"><A NAME="24">815</A></TD><TD>            OrderStruct p_anOrder, Order foundOrder, OrderHandlingInstructionStruct p_handlingInstruction, short activityType, ManualMarketBrokerDataStruct marketData) throws CommunicationException, SystemException,</TD></TR><TR><TD CLASS="l">816</TD><TD>            AuthorizationException, DataValidationException, TransactionFailedException,NotAcceptedException</TD></TR><TR><TD CLASS="l">817</TD><TD>    {</TD></TR><TR><TD CLASS="l">818</TD><TD>        OrderIdStruct orderId;</TD></TR><TR CLASS="z"><TD CLASS="l">819</TD><TD>        OrderContext context = new OrderContext();</TD></TR><TR><TD CLASS="l">820</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">821</TD><TD>        context.setOrder(foundOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">822</TD><TD>        context.setRoutingParams(p_orderRoutingStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">823</TD><TD>        context.setOrderHandlingInstruction(p_handlingInstruction);</TD></TR><TR CLASS="z"><TD CLASS="l">824</TD><TD>        context.setActivityType(activityType);</TD></TR><TR CLASS="z"><TD CLASS="l">825</TD><TD>        context.setManualRequest(true);</TD></TR><TR><TD CLASS="l">826</TD><TD> </TD></TR><TR><TD CLASS="l">827</TD><TD>        // set mktdat for TA and TB only.</TD></TR><TR CLASS="z"><TD CLASS="l">828</TD><TD>        if(activityType == ActivityTypes.MANUAL_ORDER_TA ||</TD></TR><TR CLASS="z"><TD CLASS="l">829</TD><TD>                activityType == ActivityTypes.MANUAL_ORDER_TB || </TD></TR><TR CLASS="z"><TD CLASS="l">830</TD><TD>                activityType == ActivityTypes.MANUAL_ORDER_SR || </TD></TR><TR CLASS="z"><TD CLASS="l">831</TD><TD>                activityType == ActivityTypes.MANUAL_ORDER_FR)</TD></TR><TR><TD CLASS="l">832</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">833</TD><TD>        context.setManualMarketBrokerData(marketData);</TD></TR><TR><TD CLASS="l">834</TD><TD>        }</TD></TR><TR><TD CLASS="l">835</TD><TD>        /**</TD></TR><TR><TD CLASS="l">836</TD><TD>         * This flag is used when there is a direct routed order to PAR and we need</TD></TR><TR><TD CLASS="l">837</TD><TD>         * to book this order when the HAL or COA is turned off.</TD></TR><TR><TD CLASS="l">838</TD><TD>         */</TD></TR><TR CLASS="z"><TD CLASS="l">839</TD><TD>        if(activityType == ActivityTypes.MANUAL_ORDER_BOOK ||</TD></TR><TR CLASS="z"><TD CLASS="l">840</TD><TD>                activityType == ActivityTypes.MANUAL_ORDER_AUCTION)</TD></TR><TR><TD CLASS="l">841</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">842</TD><TD>            context.getOrder().setBookRequestFromPARorOMT(true);</TD></TR><TR><TD CLASS="l">843</TD><TD>        } else </TD></TR><TR><TD CLASS="l">844</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">845</TD><TD>            context.getOrder().setBookRequestFromPARorOMT(false);</TD></TR><TR><TD CLASS="l">846</TD><TD>        }</TD></TR><TR><TD CLASS="l">847</TD><TD>        </TD></TR><TR><TD CLASS="l">848</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">849</TD><TD>        RequestTypeEnum requestType = getRequestType(activityType);</TD></TR><TR CLASS="z"><TD CLASS="l">850</TD><TD>        context.setRequestType(requestType);</TD></TR><TR CLASS="z"><TD CLASS="l">851</TD><TD>        RerouteProperties reRerouteProperties = context.getReRouteProperties();</TD></TR><TR CLASS="z"><TD CLASS="l">852</TD><TD>        reRerouteProperties.setFunction(requestType.toString());</TD></TR><TR><TD CLASS="l">853</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">854</TD><TD>        if (foundOrder == null)</TD></TR><TR><TD CLASS="l">855</TD><TD>        {</TD></TR><TR><TD CLASS="l">856</TD><TD>            try {</TD></TR><TR><TD CLASS="l">857</TD><TD>                // execute new order WF</TD></TR><TR CLASS="z"><TD CLASS="l">858</TD><TD>                foundOrder = createNewOrder(p_anOrder, null, p_handlingInstruction, true);</TD></TR><TR CLASS="z"><TD CLASS="l">859</TD><TD>                if (log().isDebugOn())</TD></TR><TR><TD CLASS="l">860</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">861</TD><TD>                    log().debug(msg().add(&#34;order&#34;, p_anOrder.orderId).add(&#34;created successfully&#34;));</TD></TR><TR><TD CLASS="l">862</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">863</TD><TD>                context.setOrder(foundOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">864</TD><TD>                context.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">865</TD><TD>                this.newOrderWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">866</TD><TD>                if (context.getException() != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">867</TD><TD>                    maybeThrow(context);</TD></TR><TR><TD CLASS="l">868</TD><TD>                }</TD></TR><TR><TD CLASS="l">869</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">870</TD><TD>            finally {</TD></TR><TR><TD CLASS="l">871</TD><TD>                // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">872</TD><TD>                if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">873</TD><TD>                    log.alarm(msg().add( &#34;Rolling back transaction in acceptManualOrderReturn &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">874</TD><TD>                    Transaction.rollback();</TD></TR><TR><TD CLASS="l">875</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">876</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">877</TD><TD>            orderId = context.getOrder().getOrderId();</TD></TR><TR><TD CLASS="l">878</TD><TD>        }</TD></TR><TR><TD CLASS="l">879</TD><TD>        else</TD></TR><TR><TD CLASS="l">880</TD><TD>        {</TD></TR><TR><TD CLASS="l">881</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">882</TD><TD>                if (p_anOrder.orderId.highCboeId == 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">883</TD><TD>                    p_anOrder.orderId = foundOrder.getOrderId();</TD></TR><TR><TD CLASS="l">884</TD><TD>                }</TD></TR><TR><TD CLASS="l">885</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">886</TD><TD>                if (!foundOrder.hasRoutedAway()) {</TD></TR><TR CLASS="z"><TD CLASS="l">887</TD><TD>                    MsgBuilder msg = msg().add(&#34;Could not accept order which is already in CBOEDirect: &#34;, foundOrder.orderIdToString());</TD></TR><TR CLASS="z"><TD CLASS="l">888</TD><TD>                    log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">889</TD><TD>                    throw ExceptionBuilder.dataValidationException(msg.end(), DataValidationCodes.INVALID_ORDER_STATE);</TD></TR><TR><TD CLASS="l">890</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">891</TD><TD>                context.setOrder(foundOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">892</TD><TD>                context.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">893</TD><TD>                this.orderRerouteHybridWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">894</TD><TD>                if (context.getException() != null)</TD></TR><TR><TD CLASS="l">895</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">896</TD><TD>                    maybeThrow(context);</TD></TR><TR><TD CLASS="l">897</TD><TD>                }</TD></TR><TR><TD CLASS="l">898</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">899</TD><TD>            finally {</TD></TR><TR><TD CLASS="l">900</TD><TD>                // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">901</TD><TD>                if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">902</TD><TD>                    log.alarm(msg().add( &#34;Rolling back transaction in acceptManualOrderReturn &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">903</TD><TD>                    Transaction.rollback();</TD></TR><TR><TD CLASS="l">904</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">905</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">906</TD><TD>            orderId = foundOrder.getOrderId();</TD></TR><TR><TD CLASS="l">907</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">908</TD><TD>        foundOrder.setPreviousLocation(p_orderRoutingStruct.source);</TD></TR><TR CLASS="z"><TD CLASS="l">909</TD><TD>        foundOrder.setPreviousLocationType(p_orderRoutingStruct.sourceType);</TD></TR><TR><TD CLASS="l">910</TD><TD>        /*</TD></TR><TR><TD CLASS="l">911</TD><TD>         * Clear the PAR market data if there is unsuccessful TA/TB attempt</TD></TR><TR><TD CLASS="l">912</TD><TD>         */</TD></TR><TR CLASS="z"><TD CLASS="l">913</TD><TD>        if(foundOrder != null &amp;&amp; reRerouteProperties.getExceptionCode() != null) </TD></TR><TR><TD CLASS="l">914</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">915</TD><TD>            foundOrder.clearCboeBookWhenOrderWasReroutedFromPAR();</TD></TR><TR CLASS="z"><TD CLASS="l">916</TD><TD>            foundOrder.clearCboeQuoteWhenOrderWasReroutedFromPAR();</TD></TR><TR CLASS="z"><TD CLASS="l">917</TD><TD>            foundOrder.setManualMarketData(null);</TD></TR><TR><TD CLASS="l">918</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">919</TD><TD>        return orderId;</TD></TR><TR><TD CLASS="l"><A NAME="3d">920</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">921</TD><TD> </TD></TR><TR><TD CLASS="l">922</TD><TD>    private RequestTypeEnum getRequestType(short p_activityType)</TD></TR><TR><TD CLASS="l">923</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">924</TD><TD>        switch (p_activityType)</TD></TR><TR><TD CLASS="l">925</TD><TD>        {</TD></TR><TR><TD CLASS="l">926</TD><TD>            case ActivityTypes.MANUAL_ORDER_TA:</TD></TR><TR CLASS="z"><TD CLASS="l">927</TD><TD>                return RequestTypeEnum.MANUAL_ORDER_TA;</TD></TR><TR><TD CLASS="l">928</TD><TD>            case ActivityTypes.MANUAL_ORDER_TB:</TD></TR><TR CLASS="z"><TD CLASS="l">929</TD><TD>                return RequestTypeEnum.MANUAL_ORDER_TB;</TD></TR><TR><TD CLASS="l">930</TD><TD>            case ActivityTypes.MANUAL_ORDER_BOOK:</TD></TR><TR CLASS="z"><TD CLASS="l">931</TD><TD>                return RequestTypeEnum.MANUAL_ORDER_BOOK;</TD></TR><TR><TD CLASS="l">932</TD><TD>            case ActivityTypes.MANUAL_ORDER_AUCTION:</TD></TR><TR CLASS="z"><TD CLASS="l">933</TD><TD>                return RequestTypeEnum.MANUAL_ORDER_AUCTION;</TD></TR><TR><TD CLASS="l">934</TD><TD>            case ActivityTypes.MANUAL_ORDER_SR:</TD></TR><TR CLASS="z"><TD CLASS="l">935</TD><TD>                return RequestTypeEnum.MANUAL_ORDER_SR;   </TD></TR><TR><TD CLASS="l">936</TD><TD>            case ActivityTypes.MANUAL_ORDER_FR:</TD></TR><TR CLASS="z"><TD CLASS="l">937</TD><TD>                return RequestTypeEnum.MANUAL_ORDER_FR;</TD></TR><TR><TD CLASS="l">938</TD><TD>            default:</TD></TR><TR><TD CLASS="l">939</TD><TD>                break;</TD></TR><TR><TD CLASS="l">940</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">941</TD><TD>        return RequestTypeEnum.DEFAULT;</TD></TR><TR><TD CLASS="l">942</TD><TD>    }</TD></TR><TR><TD CLASS="l">943</TD><TD> </TD></TR><TR><TD CLASS="l">944</TD><TD>    private Order createNewOrder(final OrderStruct orderStruct, final LegOrderEntryStructV2[] legEntries,</TD></TR><TR><TD CLASS="l">945</TD><TD>            final OrderHandlingInstructionStruct handlingInstruction, final boolean active)</TD></TR><TR><TD CLASS="l"><A NAME="20">946</A></TD><TD>            throws TransactionFailedException, DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">947</TD><TD>    {</TD></TR><TR><TD CLASS="l">948</TD><TD>        Order newOrder;</TD></TR><TR><TD CLASS="l">949</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">950</TD><TD>        if (orderStruct.sessionNames != null &amp;&amp; orderStruct.sessionNames.length &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">951</TD><TD>            orderStruct.activeSession = orderStruct.sessionNames[0];</TD></TR><TR><TD CLASS="l">952</TD><TD>        }</TD></TR><TR><TD CLASS="l">953</TD><TD>        try</TD></TR><TR><TD CLASS="l">954</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">955</TD><TD>            if (legEntries == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">956</TD><TD>                newOrder = orderHome.create(orderStruct);</TD></TR><TR><TD CLASS="l">957</TD><TD>            }</TD></TR><TR><TD CLASS="l">958</TD><TD>            else {</TD></TR><TR CLASS="z"><TD CLASS="l">959</TD><TD>                newOrder = orderHome.create(orderStruct, legEntries);</TD></TR><TR><TD CLASS="l">960</TD><TD>            }</TD></TR><TR><TD CLASS="l">961</TD><TD> </TD></TR><TR><TD CLASS="l">962</TD><TD>            // set the orsid, irrespective of received HI</TD></TR><TR CLASS="z"><TD CLASS="l">963</TD><TD>            newOrder.setOrsId(orderStruct.orsId);</TD></TR><TR><TD CLASS="l">964</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">965</TD><TD>        catch (final SystemException e)</TD></TR><TR><TD CLASS="l">966</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">967</TD><TD>            log().alarm(msg().add(&#34;Creating order failed (orderStruct dump sent to stdout) &#34;).add(e));</TD></TR><TR CLASS="z"><TD CLASS="l">968</TD><TD>            ReflectiveObjectWriter.writeObject(orderStruct, &#34;(failed/SystemException)OrderStruct&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">969</TD><TD>            throw ExceptionBuilder.systemException(&#34;Unable to get OrderHome: &#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">970</TD><TD>                    TransactionFailedCodes.CREATE_FAILED);</TD></TR><TR><TD CLASS="l">971</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">972</TD><TD>        catch (final DataValidationException e)</TD></TR><TR><TD CLASS="l">973</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">974</TD><TD>            log().alarm(msg().add(&#34;Creating order failed (orderStruct dump sent to stdout)&#34;).add(e));</TD></TR><TR CLASS="z"><TD CLASS="l">975</TD><TD>            ReflectiveObjectWriter.writeObject(orderStruct,</TD></TR><TR CLASS="z"><TD CLASS="l">976</TD><TD>                    &#34;(failed/TransactionFailedException)OrderStruct&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">977</TD><TD>            throw e;</TD></TR><TR><TD CLASS="l">978</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">979</TD><TD>        catch (final TransactionFailedException pe)</TD></TR><TR><TD CLASS="l">980</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">981</TD><TD>            log().alarm( msg().add(&#34;Creating order failed (orderStruct dump sent to stdout)&#34;).add(pe));</TD></TR><TR CLASS="z"><TD CLASS="l">982</TD><TD>            ReflectiveObjectWriter.writeObject(orderStruct,</TD></TR><TR CLASS="z"><TD CLASS="l">983</TD><TD>                    &#34;(failed/TransactionFailedException)OrderStruct&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">984</TD><TD>            throw ExceptionBuilder.transactionFailedException(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">985</TD><TD>                    &#34;TransactionFailedException for&#34;).add(&#34;orderId&#34;, orderStruct.orderId).end(),</TD></TR><TR CLASS="z"><TD CLASS="l">986</TD><TD>                    TransactionFailedCodes.CREATE_FAILED);</TD></TR><TR><TD CLASS="l">987</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">988</TD><TD>        catch (final DuplicateOrderIDException de)</TD></TR><TR><TD CLASS="l">989</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">990</TD><TD>            log().alarm( msg().add(&#34;Creating order failed (orderStruct dump sent to stdout)&#34;).add(de));</TD></TR><TR CLASS="z"><TD CLASS="l">991</TD><TD>            ReflectiveObjectWriter.writeObject(orderStruct,</TD></TR><TR CLASS="z"><TD CLASS="l">992</TD><TD>                    &#34;(failed/DuplicateOrderIDException)OrderStruct&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">993</TD><TD>            throw ExceptionBuilder.dataValidationException(msg().add(&#34;DuplicateOrderID.  Unable to create new order: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">994</TD><TD>                    .add(&#34;orderId&#34;, orderStruct.orderId).end(), DataValidationCodes.DUPLICATE_ID);</TD></TR><TR><TD CLASS="l">995</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">996</TD><TD>        catch (final Exception e)</TD></TR><TR><TD CLASS="l">997</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">998</TD><TD>            log()</TD></TR><TR CLASS="z"><TD CLASS="l">999</TD><TD>                    .alarm(</TD></TR><TR CLASS="z"><TD CLASS="l">1000</TD><TD>                            msg().add(&#34;Creating order faided (orderStruct dump sent to stdout)&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1001</TD><TD>                                    .add(e));</TD></TR><TR CLASS="z"><TD CLASS="l">1002</TD><TD>            ReflectiveObjectWriter.writeObject(orderStruct, &#34;(failed/Exception)OrderStruct&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1003</TD><TD>            throw ExceptionBuilder.systemException(msg().add(&#34;Internal error:&#34;).add(e, true).add(</TD></TR><TR CLASS="z"><TD CLASS="l">1004</TD><TD>                    &#34;  Unable to create new order: &#34;).add(&#34;orderId&#34;, orderStruct.orderId).end(), 0);</TD></TR><TR><TD CLASS="l">1005</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1006</TD><TD>        return newOrder;</TD></TR><TR><TD CLASS="l">1007</TD><TD>    }</TD></TR><TR><TD CLASS="l">1008</TD><TD> </TD></TR><TR><TD CLASS="l">1009</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1010</TD><TD>     * Return appropriate order validation strategy</TD></TR><TR><TD CLASS="l">1011</TD><TD>     *</TD></TR><TR><TD CLASS="l">1012</TD><TD>     * @throws DataValidationException</TD></TR><TR><TD CLASS="l"><A NAME="34">1013</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1014</TD><TD>    private OrderValidationStrategy getOrderValidationStrategy(String sessionName)</TD></TR><TR><TD CLASS="l">1015</TD><TD>            throws DataValidationException</TD></TR><TR><TD CLASS="l">1016</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1017</TD><TD>        OrderValidationStrategy strategy = null;</TD></TR><TR><TD CLASS="l">1018</TD><TD>        try</TD></TR><TR><TD CLASS="l">1019</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1020</TD><TD>            strategy = orderValidationStrategyHome.find(sessionName);</TD></TR><TR><TD CLASS="l">1021</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1022</TD><TD>        catch (Exception e)</TD></TR><TR><TD CLASS="l">1023</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1024</TD><TD>            MsgBuilder msg = msg().add(&#34;No strategy was found to validate order &#34;).add(&#34;session&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1025</TD><TD>                    sessionName).add(e);</TD></TR><TR CLASS="z"><TD CLASS="l">1026</TD><TD>            throw ExceptionBuilder.dataValidationException(msg.end(),</TD></TR><TR CLASS="z"><TD CLASS="l">1027</TD><TD>                    DataValidationCodes.INVALID_SESSION);</TD></TR><TR><TD CLASS="l">1028</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1029</TD><TD>        return strategy;</TD></TR><TR><TD CLASS="l">1030</TD><TD>    }</TD></TR><TR><TD CLASS="l">1031</TD><TD> </TD></TR><TR><TD CLASS="l">1032</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1033</TD><TD>     * @throw SystemException if there was any trouble finding the product information.</TD></TR><TR><TD CLASS="l">1034</TD><TD>     * @throw NotAcceptedException if the product is in a suspended state.</TD></TR><TR><TD CLASS="l">1035</TD><TD>     */</TD></TR><TR><TD CLASS="l">1036</TD><TD>//    private void validateProductState(final String sessName, final int productKey)</TD></TR><TR><TD CLASS="l">1037</TD><TD>//            throws SystemException, NotAcceptedException</TD></TR><TR><TD CLASS="l">1038</TD><TD>//    {</TD></TR><TR><TD CLASS="l">1039</TD><TD>//        ProductData prodData;</TD></TR><TR><TD CLASS="l">1040</TD><TD>//        try</TD></TR><TR><TD CLASS="l">1041</TD><TD>//        {</TD></TR><TR><TD CLASS="l">1042</TD><TD>//            prodData = this.productDataCache.getProductData(productKey);</TD></TR><TR><TD CLASS="l">1043</TD><TD>//        }</TD></TR><TR><TD CLASS="l">1044</TD><TD>//        catch (NotFoundException e)</TD></TR><TR><TD CLASS="l">1045</TD><TD>//        {</TD></TR><TR><TD CLASS="l">1046</TD><TD>//            final MsgBuilder msg = msg().add(&#34;Unknown productKey&#34;, productKey).add(&#34; has invalid product key&#34;);</TD></TR><TR><TD CLASS="l">1047</TD><TD>//            throw ExceptionBuilder.systemException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">1048</TD><TD>//        }</TD></TR><TR><TD CLASS="l">1049</TD><TD>//        if (prodData.getState(sessName) == ProductStates.SUSPENDED)</TD></TR><TR><TD CLASS="l">1050</TD><TD>//        {</TD></TR><TR><TD CLASS="l">1051</TD><TD>//            final MsgBuilder msg = msg().add(&#34;Product &#34;, productKey).add(&#34; is SUSPENDED for session &#34;, sessName);</TD></TR><TR><TD CLASS="l">1052</TD><TD>//            throw ExceptionBuilder.systemException(msg.end(), NotAcceptedCodes.INVALID_STATE);</TD></TR><TR><TD CLASS="l">1053</TD><TD>//        }</TD></TR><TR><TD CLASS="l">1054</TD><TD>//    }</TD></TR><TR><TD CLASS="l">1055</TD><TD> </TD></TR><TR><TD CLASS="l">1056</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1057</TD><TD>     * Validates the Executing Broker</TD></TR><TR><TD CLASS="l">1058</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="80">1059</A></TD><TD>    protected void validateExecutingBroker(String broker) throws DataValidationException</TD></TR><TR><TD CLASS="l">1060</TD><TD>    {</TD></TR><TR><TD CLASS="l">1061</TD><TD> </TD></TR><TR><TD CLASS="l">1062</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1063</TD><TD>        ExchangeAcronymStruct execBroker = new ExchangeAcronymStruct(ExchangeStrings.CBOE, broker);</TD></TR><TR><TD CLASS="l">1064</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1065</TD><TD>        UserData userAcr = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1066</TD><TD>        final MsgBuilder msg = msg().add(&#34;Invalid Executing Broker &#34;, broker);</TD></TR><TR><TD CLASS="l">1067</TD><TD>       try {</TD></TR><TR CLASS="z"><TD CLASS="l">1068</TD><TD>                userAcr = userDataCache.getUser(execBroker);</TD></TR><TR CLASS="z"><TD CLASS="l">1069</TD><TD>                if(userAcr == null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">1070</TD><TD>                    log.info(msg().add( &#34; in acceptManualFillReport &#34; + msg.end()) );</TD></TR><TR CLASS="z"><TD CLASS="l">1071</TD><TD>                    throw ExceptionBuilder.dataValidationException(&#34;Invalid Executing Broker &#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1072</TD><TD>                            DataValidationCodes.INVALID_EXECUTING_BROKER);</TD></TR><TR><TD CLASS="l">1073</TD><TD>                }</TD></TR><TR><TD CLASS="l">1074</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1075</TD><TD>        catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1076</TD><TD>                log.info(msg().add( &#34; in acceptManualFillReport &#34; + msg.end()) );</TD></TR><TR CLASS="z"><TD CLASS="l">1077</TD><TD>                throw ExceptionBuilder.dataValidationException(&#34;Invalid Executing Broker &#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1078</TD><TD>                        DataValidationCodes.INVALID_EXECUTING_BROKER);</TD></TR><TR><TD CLASS="l">1079</TD><TD>        }</TD></TR><TR><TD CLASS="l">1080</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1081</TD><TD>                FirmStruct firm = firmMaintenanceService.getFirmByKey(userAcr.getFirmKey());</TD></TR><TR><TD CLASS="l">1082</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1083</TD><TD>        catch (Exception e) {</TD></TR><TR><TD CLASS="l">1084</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1085</TD><TD>                msg().add(e.getMessage());</TD></TR><TR CLASS="z"><TD CLASS="l">1086</TD><TD>                log.info(msg().add( &#34;in acceptManualFillReport &#34; + msg.end()) );</TD></TR><TR CLASS="z"><TD CLASS="l">1087</TD><TD>                throw ExceptionBuilder.dataValidationException(&#34;Invalid Executing Broker &#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1088</TD><TD>                        DataValidationCodes.INVALID_EXECUTING_BROKER);</TD></TR><TR><TD CLASS="l">1089</TD><TD> </TD></TR><TR><TD CLASS="l">1090</TD><TD>        }</TD></TR><TR><TD CLASS="l">1091</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1092</TD><TD>    }</TD></TR><TR><TD CLASS="l">1093</TD><TD> </TD></TR><TR><TD CLASS="l">1094</TD><TD> </TD></TR><TR><TD CLASS="l">1095</TD><TD> </TD></TR><TR><TD CLASS="l">1096</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1097</TD><TD>     * Validates order id struct before it is used to query for order.</TD></TR><TR><TD CLASS="l">1098</TD><TD>     */</TD></TR><TR><TD CLASS="l">1099</TD><TD>    protected void validateOrderId(OrderIdStruct orderId) throws DataValidationException</TD></TR><TR><TD CLASS="l"><A NAME="83">1100</A></TD><TD>    {</TD></TR><TR><TD CLASS="l">1101</TD><TD>        // if databaseid is not given, then zero sequence number is invalid and could end up with</TD></TR><TR><TD CLASS="l">1102</TD><TD>        // multiple orders being</TD></TR><TR><TD CLASS="l">1103</TD><TD>        // found because of way JGrinder does query by example</TD></TR><TR CLASS="z"><TD CLASS="l">1104</TD><TD>        if ((orderId.highCboeId == 0 || orderId.lowCboeId == 0)</TD></TR><TR CLASS="z"><TD CLASS="l">1105</TD><TD>                &amp;&amp; orderId.branchSequenceNumber == 0)</TD></TR><TR><TD CLASS="l">1106</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1107</TD><TD>            final MsgBuilder msg = msg().add(&#34;orderId&#34;, orderId).add(</TD></TR><TR CLASS="z"><TD CLASS="l">1108</TD><TD>                    &#34;has invalid branch sequence number&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1109</TD><TD>            if (log().isDebugOn())</TD></TR><TR><TD CLASS="l">1110</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1111</TD><TD>                log().debug(msg);</TD></TR><TR><TD CLASS="l">1112</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1113</TD><TD>            throw ExceptionBuilder.dataValidationException(msg.end(),</TD></TR><TR CLASS="z"><TD CLASS="l">1114</TD><TD>                    DataValidationCodes.INVALID_BRANCH_SEQUENCE_NUMBER);</TD></TR><TR><TD CLASS="l">1115</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="12">1116</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1117</TD><TD> </TD></TR><TR><TD CLASS="l">1118</TD><TD>    public void acceptPrintRequest(OrderRoutingParameterStruct p_orderRouting, OrderIdStruct p_orderId, String p_sessionName, int p_productKey, long p_requestTime, int[] p_legPrintVolumes, int p_printQuantity, short p_printRequestType) throws SystemException, CommunicationException, DataValidationException, NotFoundException, AuthorizationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">1119</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1120</TD><TD>        log().info(msg().add(&#34;entering MOMDI.acceptPrintRequest: &#34;).add(p_orderId));</TD></TR><TR CLASS="z"><TD CLASS="l">1121</TD><TD>        getNetworkInstrumentor().incrementPrintRequestReceived(1);</TD></TR><TR><TD CLASS="l">1122</TD><TD>        // find the order</TD></TR><TR CLASS="z"><TD CLASS="l">1123</TD><TD>        Order order = findOrder(p_orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">1124</TD><TD>        if (order == null)</TD></TR><TR><TD CLASS="l">1125</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1126</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptPrintRequest, Print Order Request received, Order not found for: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1127</TD><TD>            .add(&#34;OrderId&#34;, new OrderId(p_orderId).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">1128</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1129</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">1130</TD><TD>        }</TD></TR><TR><TD CLASS="l">1131</TD><TD> </TD></TR><TR><TD CLASS="l">1132</TD><TD>        // check order ownership</TD></TR><TR CLASS="z"><TD CLASS="l">1133</TD><TD>        if(p_orderRouting.sourceType != order.getLocationType()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1134</TD><TD>            String msg = getPrintRequestMessageText(order,  p_orderRouting, p_orderId , p_printQuantity, p_legPrintVolumes);</TD></TR><TR CLASS="z"><TD CLASS="l">1135</TD><TD>            final MsgBuilder msgBuilder = msg().add(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1136</TD><TD>            log().alarm(msgBuilder);</TD></TR><TR CLASS="z"><TD CLASS="l">1137</TD><TD>            sendMessageToHelpDesk(getPrintRequestSubject(p_orderRouting), msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1138</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1139</TD><TD>        }</TD></TR><TR><TD CLASS="l">1140</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1141</TD><TD>        ManualOrderContext context = new ManualOrderContext();</TD></TR><TR CLASS="z"><TD CLASS="l">1142</TD><TD>        context.setRoutingParams(p_orderRouting);</TD></TR><TR CLASS="z"><TD CLASS="l">1143</TD><TD>        context.setOrder(order);</TD></TR><TR CLASS="z"><TD CLASS="l">1144</TD><TD>        context.setRequestTime(p_requestTime);</TD></TR><TR CLASS="z"><TD CLASS="l">1145</TD><TD>        context.setLegPrintVolumes(p_legPrintVolumes);</TD></TR><TR CLASS="z"><TD CLASS="l">1146</TD><TD>        context.setPrintQuantity(p_printQuantity);</TD></TR><TR CLASS="z"><TD CLASS="l">1147</TD><TD>        context.setManualRequest(true);</TD></TR><TR CLASS="z"><TD CLASS="l">1148</TD><TD>        switch (p_printRequestType)</TD></TR><TR><TD CLASS="l">1149</TD><TD>        {</TD></TR><TR><TD CLASS="l">1150</TD><TD>            case ActivityTypes.PAR_PRINT_INTRA_DAY:</TD></TR><TR CLASS="z"><TD CLASS="l">1151</TD><TD>                context.setRouteReason(OHSRoutingReason.PAR_PRINT_ORDER_INTRA_DAY.getOHSRoutingReason());</TD></TR><TR CLASS="z"><TD CLASS="l">1152</TD><TD>                break;</TD></TR><TR><TD CLASS="l">1153</TD><TD>            case ActivityTypes.PAR_PRINT_END_OF_DAY:</TD></TR><TR CLASS="z"><TD CLASS="l">1154</TD><TD>                context.setRouteReason(OHSRoutingReason.PAR_PRINT_ORDER_END_OF_DAY.getOHSRoutingReason());</TD></TR><TR><TD CLASS="l">1155</TD><TD>                break;</TD></TR><TR><TD CLASS="l">1156</TD><TD>        }</TD></TR><TR><TD CLASS="l">1157</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1158</TD><TD>            this.printRequestWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">1159</TD><TD>            if (context.getException() != null)</TD></TR><TR><TD CLASS="l">1160</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1161</TD><TD>                maybeThrow(context);</TD></TR><TR><TD CLASS="l">1162</TD><TD>            }</TD></TR><TR><TD CLASS="l">1163</TD><TD>            else</TD></TR><TR><TD CLASS="l">1164</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1165</TD><TD>                getNetworkInstrumentor().incrementPrintRequestSent(1);</TD></TR><TR><TD CLASS="l">1166</TD><TD>            }</TD></TR><TR><TD CLASS="l">1167</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1168</TD><TD>        catch (TransactionFailedException e)</TD></TR><TR><TD CLASS="l">1169</TD><TD>        {</TD></TR><TR><TD CLASS="l">1170</TD><TD>            // should be handled in the workflow: Defensive check</TD></TR><TR CLASS="z"><TD CLASS="l">1171</TD><TD>            log.alarm(msg().add(&#34;TransactionFailedException on acceptPrintRequest: &#34;).add(e));</TD></TR><TR><TD CLASS="l">1172</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1173</TD><TD>        finally {</TD></TR><TR><TD CLASS="l">1174</TD><TD>            // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">1175</TD><TD>            if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1176</TD><TD>                log.alarm(msg().add( &#34;Rolling back transaction in acceptPrintRequest &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1177</TD><TD>                Transaction.rollback();</TD></TR><TR><TD CLASS="l">1178</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1179</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1180</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="8">1181</A></TD><TD> </TD></TR><TR><TD CLASS="l">1182</TD><TD>    public void acceptManualFillReport(short activityType, OrderRoutingParameterStruct p_orderRoutingStruct,</TD></TR><TR><TD CLASS="l">1183</TD><TD>             ManualFillStruct[] p_manualFillStruct, int transactionSequenceNumber) throws SystemException, CommunicationException, DataValidationException, NotFoundException, AuthorizationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">1184</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1185</TD><TD>              ManualFillStructV2[] manualFillStructV2 = new ManualFillStructV2[p_manualFillStruct.length];</TD></TR><TR CLASS="z"><TD CLASS="l">1186</TD><TD>              PriceStruct noPrice = PriceFactory.createPriceStruct(PriceTypes.NO_PRICE, 0, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">1187</TD><TD>              ManualMarketDataStruct[] mMDS = new ManualMarketDataStruct[p_manualFillStruct[0].cboeQuoteInfo.length]; //Array length is number of legs.</TD></TR><TR CLASS="z"><TD CLASS="l">1188</TD><TD>              for(int i=0;i&lt;mMDS.length;i++)</TD></TR><TR><TD CLASS="l">1189</TD><TD>              {</TD></TR><TR CLASS="z"><TD CLASS="l">1190</TD><TD>                     mMDS[i] = new ManualMarketDataStruct(noPrice, &#34;&#34;, noPrice, &#34;&#34;, noPrice, noPrice, 0);</TD></TR><TR><TD CLASS="l">1191</TD><TD>              }</TD></TR><TR CLASS="z"><TD CLASS="l">1192</TD><TD>              for( int i =0;i&lt;p_manualFillStruct.length;i++)</TD></TR><TR><TD CLASS="l">1193</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1194</TD><TD>                     manualFillStructV2[i] = new ManualFillStructV2(p_manualFillStruct[i],noPrice,0,noPrice,0,noPrice,0,&#34;&#34;,mMDS,noPrice);</TD></TR><TR><TD CLASS="l">1195</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1196</TD><TD>             acceptManualFillReportV2(activityType, p_orderRoutingStruct, manualFillStructV2, transactionSequenceNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">1197</TD><TD>     }</TD></TR><TR><TD CLASS="l">1198</TD><TD>     </TD></TR><TR><TD CLASS="l"><A NAME="9">1199</A></TD><TD>    public void acceptManualFillReportV2(short activityType, OrderRoutingParameterStruct p_orderRoutingStruct,</TD></TR><TR><TD CLASS="l">1200</TD><TD>             ManualFillStructV2[] p_manualFillStruct, int transactionSequenceNumber) throws SystemException, CommunicationException, DataValidationException, NotFoundException, AuthorizationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">1201</TD><TD>    {</TD></TR><TR><TD CLASS="l">1202</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1203</TD><TD>        log().info(msg().add(&#34;entering MOMDI.acceptManualFillReport &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1204</TD><TD>        boolean omtFill = ManualFillReportTypes.OMT_MANUAL_FILL_REPORT== activityType?true:false;</TD></TR><TR CLASS="z"><TD CLASS="l">1205</TD><TD>        testARException(p_manualFillStruct[0].manualFill.orderId);</TD></TR><TR><TD CLASS="l">1206</TD><TD> </TD></TR><TR><TD CLASS="l">1207</TD><TD>        // If no reports, return</TD></TR><TR CLASS="z"><TD CLASS="l">1208</TD><TD>        if (p_manualFillStruct.length == 0)</TD></TR><TR><TD CLASS="l">1209</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1210</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualFillReport, Recevied empty ManualFillReports&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1211</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1212</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), 0);</TD></TR><TR><TD CLASS="l">1213</TD><TD>        }</TD></TR><TR><TD CLASS="l">1214</TD><TD> </TD></TR><TR><TD CLASS="l">1215</TD><TD>        // find the order</TD></TR><TR CLASS="z"><TD CLASS="l">1216</TD><TD>        Order order = findOrder(p_manualFillStruct[0].manualFill.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">1217</TD><TD>        if (order == null)</TD></TR><TR><TD CLASS="l">1218</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1219</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualFillReport, Order not found : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">1220</TD><TD>                    + new OrderId(p_manualFillStruct[0].manualFill.orderId).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">1221</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1222</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">1223</TD><TD>        }</TD></TR><TR><TD CLASS="l">1224</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1225</TD><TD>        if (!accessHelper.hasOwnership(order, p_orderRoutingStruct)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1226</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualFillReport, the user does not have permission to fill the order: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1227</TD><TD>            .add(&#34;OrderId&#34;, order.getStruct().toString());</TD></TR><TR CLASS="z"><TD CLASS="l">1228</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1229</TD><TD>            throw ExceptionBuilder.authorizationException(msg.end(), AuthorizationCodes.NOT_PERMITTED);</TD></TR><TR><TD CLASS="l">1230</TD><TD>        }</TD></TR><TR><TD CLASS="l">1231</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1232</TD><TD>        for (int i = 0 ; i &lt; p_manualFillStruct[0].manualFill.contraBrokers.length; i++)</TD></TR><TR><TD CLASS="l">1233</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1234</TD><TD>            if(p_manualFillStruct[0].manualFill.contraBrokers[i].exchange.trim().length() &lt;= 0)</TD></TR><TR><TD CLASS="l">1235</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1236</TD><TD>                p_manualFillStruct[0].manualFill.contraBrokers[i].exchange = ExchangeStrings.CBOE;</TD></TR><TR><TD CLASS="l">1237</TD><TD>            }</TD></TR><TR><TD CLASS="l">1238</TD><TD>        }</TD></TR><TR><TD CLASS="l">1239</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1240</TD><TD>        boolean mmq = p_manualFillStruct[0].manualFill.linkageFillIndicator == 'Y' &amp;&amp; p_manualFillStruct[0].manualFill.mmqAccount.charAt(0) != ' ';</TD></TR><TR CLASS="z"><TD CLASS="l">1241</TD><TD>        boolean underlyingLinkageOrder = (p_manualFillStruct[0].manualFill.linkageFillIndicator == 'Y' &amp;&amp;</TD></TR><TR CLASS="z"><TD CLASS="l">1242</TD><TD>                                            order.getOrderOriginType() != OrderOrigins.SATISFACTION);</TD></TR><TR><TD CLASS="l">1243</TD><TD>        </TD></TR><TR><TD CLASS="l">1244</TD><TD>        // Populates the contra firms from the SessionProfile if the contra acronym is set to rereive MMTNs.</TD></TR><TR CLASS="z"><TD CLASS="l">1245</TD><TD>        populateContraFirmFromSessionProfileForMMTN(p_manualFillStruct[0].manualFill);</TD></TR><TR><TD CLASS="l">1246</TD><TD>        </TD></TR><TR><TD CLASS="l">1247</TD><TD>        // Capture data from ManualFillStruct to FillReport, TradeReport and InternalTickerDetailStruct to context.</TD></TR><TR><TD CLASS="l">1248</TD><TD>        // In single transaction [part of WF context, publish FilReport, TradeReport and TickerDetail...]</TD></TR><TR CLASS="z"><TD CLASS="l">1249</TD><TD>        ProductKeysStruct productKeys = getProductData(order.getProductKey()).getProductKeysStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1250</TD><TD>        FilledReportStruct[] fillReports = getFillReports(p_manualFillStruct, order, productKeys,omtFill);</TD></TR><TR CLASS="z"><TD CLASS="l">1251</TD><TD>        TradeReportStruct[] tradeReports = getTradeReports(p_manualFillStruct, order, productKeys,activityType, mmq, underlyingLinkageOrder);</TD></TR><TR><TD CLASS="l">1252</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1253</TD><TD>        ManualFillReportContext context = new ManualFillReportContext(</TD></TR><TR CLASS="z"><TD CLASS="l">1254</TD><TD>                p_manualFillStruct, tradeReports, fillReports, activityType);</TD></TR><TR CLASS="z"><TD CLASS="l">1255</TD><TD>        context.setRoutingParams(p_orderRoutingStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">1256</TD><TD>        context.setOrder(order);</TD></TR><TR CLASS="z"><TD CLASS="l">1257</TD><TD>        context.setRejectOrTimeoutQuantity(p_manualFillStruct[0].manualFill.tradedQuantity);</TD></TR><TR CLASS="z"><TD CLASS="l">1258</TD><TD>        context.setTransactionSequenceNumber(transactionSequenceNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">1259</TD><TD>        context.setManualRequest(true);</TD></TR><TR CLASS="z"><TD CLASS="l">1260</TD><TD>        context.setCanGenerateComplexFillReject(areLegQuantitiesOverFilled(order, p_manualFillStruct[0].manualFill.legTradedQuantities));</TD></TR><TR CLASS="z"><TD CLASS="l">1261</TD><TD>        context.setParOfficalLinkageIndicator(mmq);</TD></TR><TR CLASS="z"><TD CLASS="l">1262</TD><TD>        context.setUnderlyingLinkageOrder(underlyingLinkageOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">1263</TD><TD>        context.setOMTFill(omtFill);</TD></TR><TR CLASS="z"><TD CLASS="l">1264</TD><TD>        context.setValidContraBrokers(validContraBrokers);</TD></TR><TR CLASS="z"><TD CLASS="l">1265</TD><TD>        if (ManualFillReportTypes.MANUAL_FILL_REPORT == activityType)</TD></TR><TR><TD CLASS="l">1266</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1267</TD><TD>            processManualFillReport(p_orderRoutingStruct,</TD></TR><TR CLASS="z"><TD CLASS="l">1268</TD><TD>                    p_manualFillStruct,</TD></TR><TR CLASS="z"><TD CLASS="l">1269</TD><TD>                    transactionSequenceNumber,</TD></TR><TR CLASS="z"><TD CLASS="l">1270</TD><TD>                    order,</TD></TR><TR CLASS="z"><TD CLASS="l">1271</TD><TD>                    tradeReports,</TD></TR><TR CLASS="z"><TD CLASS="l">1272</TD><TD>                    fillReports,</TD></TR><TR CLASS="z"><TD CLASS="l">1273</TD><TD>                    context);</TD></TR><TR><TD CLASS="l">1274</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1275</TD><TD>        if ((ManualFillReportTypes.LINKAGE_FILL_REPORT == activityType) ||</TD></TR><TR CLASS="z"><TD CLASS="l">1276</TD><TD>                (ManualFillReportTypes.LINKAGE_FILL_ENDORSE_REPORT == activityType) )</TD></TR><TR><TD CLASS="l">1277</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1278</TD><TD>            processLinkageFillReport(p_orderRoutingStruct,</TD></TR><TR CLASS="z"><TD CLASS="l">1279</TD><TD>                    p_manualFillStruct,</TD></TR><TR CLASS="z"><TD CLASS="l">1280</TD><TD>                    transactionSequenceNumber,</TD></TR><TR CLASS="z"><TD CLASS="l">1281</TD><TD>                    order,</TD></TR><TR CLASS="z"><TD CLASS="l">1282</TD><TD>                    tradeReports,</TD></TR><TR CLASS="z"><TD CLASS="l">1283</TD><TD>                    fillReports,</TD></TR><TR CLASS="z"><TD CLASS="l">1284</TD><TD>                    context);</TD></TR><TR><TD CLASS="l">1285</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1286</TD><TD>        if (omtFill)</TD></TR><TR><TD CLASS="l">1287</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1288</TD><TD>            processOMTManualFillReport(p_orderRoutingStruct,</TD></TR><TR CLASS="z"><TD CLASS="l">1289</TD><TD>                    p_manualFillStruct,</TD></TR><TR CLASS="z"><TD CLASS="l">1290</TD><TD>                    transactionSequenceNumber,</TD></TR><TR CLASS="z"><TD CLASS="l">1291</TD><TD>                    order,</TD></TR><TR CLASS="z"><TD CLASS="l">1292</TD><TD>                    tradeReports,</TD></TR><TR CLASS="z"><TD CLASS="l">1293</TD><TD>                    fillReports,</TD></TR><TR CLASS="z"><TD CLASS="l">1294</TD><TD>                    context);</TD></TR><TR><TD CLASS="l">1295</TD><TD>        }</TD></TR><TR><TD CLASS="l">1296</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1297</TD><TD>    }</TD></TR><TR><TD CLASS="l">1298</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="5c">1299</A></TD><TD>    private void processOMTManualFillReport(OrderRoutingParameterStruct orderRoutingStruct, ManualFillStructV2[] manualFillStruct, int transactionSequenceNumber, Order order, TradeReportStruct[] tradeReports,  FilledReportStruct[] fillReports,</TD></TR><TR><TD CLASS="l">1300</TD><TD>            ManualFillReportContext context) throws CommunicationException, SystemException, AuthorizationException, DataValidationException, TransactionFailedException, NotAcceptedException, NotAcceptedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">1301</TD><TD>    {</TD></TR><TR><TD CLASS="l">1302</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1303</TD><TD>        getNetworkInstrumentor().incrementOmtManualFillReportReceived(1);</TD></TR><TR><TD CLASS="l">1304</TD><TD> </TD></TR><TR><TD CLASS="l">1305</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1306</TD><TD>            validateExecutingBroker(manualFillStruct[0].manualFill.parBroker);</TD></TR><TR CLASS="z"><TD CLASS="l">1307</TD><TD>            this.manualFillOMTReportWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">1308</TD><TD>            if (context.getException() != null)</TD></TR><TR><TD CLASS="l">1309</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1310</TD><TD>                maybeThrow(context);</TD></TR><TR><TD CLASS="l">1311</TD><TD>            }</TD></TR><TR><TD CLASS="l">1312</TD><TD>            else</TD></TR><TR><TD CLASS="l">1313</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1314</TD><TD>                getNetworkInstrumentor().incrementOmtManualFillReportSent(1);</TD></TR><TR><TD CLASS="l">1315</TD><TD>            }</TD></TR><TR><TD CLASS="l">1316</TD><TD> </TD></TR><TR><TD CLASS="l">1317</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1318</TD><TD>        finally {</TD></TR><TR><TD CLASS="l">1319</TD><TD>            // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">1320</TD><TD>            if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1321</TD><TD>                log.alarm(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">1322</TD><TD>                        &#34;Rolling back transaction in Process ManualFillReport &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1323</TD><TD>                        .add(&#34;order&#34;, order.getOrderId()));</TD></TR><TR CLASS="z"><TD CLASS="l">1324</TD><TD>                Transaction.rollback();</TD></TR><TR><TD CLASS="l">1325</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1326</TD><TD>        }</TD></TR><TR><TD CLASS="l">1327</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="16">1328</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1329</TD><TD> </TD></TR><TR><TD CLASS="l">1330</TD><TD>    private boolean areLegQuantitiesOverFilled(Order p_order, int[] legQuantities)</TD></TR><TR><TD CLASS="l">1331</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1332</TD><TD>        if(p_order.isStrategy()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1333</TD><TD>            LegOrderDetail[]  legs = p_order.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">1334</TD><TD>            for(int i=0; i &lt; legs.length ; i ++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1335</TD><TD>                if(legQuantities[i] &gt; legs[i].getLeavesQuantity()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1336</TD><TD>                    return true;</TD></TR><TR><TD CLASS="l">1337</TD><TD>                }</TD></TR><TR><TD CLASS="l">1338</TD><TD>            }</TD></TR><TR><TD CLASS="l">1339</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1340</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">1341</TD><TD>    }</TD></TR><TR><TD CLASS="l">1342</TD><TD> </TD></TR><TR><TD CLASS="l">1343</TD><TD>    private void processManualFillReport(OrderRoutingParameterStruct p_orderRoutingStruct,</TD></TR><TR><TD CLASS="l">1344</TD><TD>                                         ManualFillStructV2[] p_manualFillStruct,</TD></TR><TR><TD CLASS="l">1345</TD><TD>                                         int transactionSequenceNumber,</TD></TR><TR><TD CLASS="l">1346</TD><TD>                                         Order order,</TD></TR><TR><TD CLASS="l">1347</TD><TD>                                         TradeReportStruct[] tradeReports,</TD></TR><TR><TD CLASS="l"><A NAME="5b">1348</A></TD><TD>                                         FilledReportStruct[] fillReports,</TD></TR><TR><TD CLASS="l">1349</TD><TD>                                         ManualFillReportContext context) throws CommunicationException, SystemException, AuthorizationException, DataValidationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">1350</TD><TD>    {</TD></TR><TR><TD CLASS="l">1351</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1352</TD><TD>        getNetworkInstrumentor().incrementManualFillReportReceived(1);</TD></TR><TR><TD CLASS="l">1353</TD><TD>        try {</TD></TR><TR><TD CLASS="l">1354</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1355</TD><TD>            this.manualFillReportWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">1356</TD><TD>            if (context.getException() != null)</TD></TR><TR><TD CLASS="l">1357</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1358</TD><TD>                maybeThrow(context);</TD></TR><TR><TD CLASS="l">1359</TD><TD>            }</TD></TR><TR><TD CLASS="l">1360</TD><TD>            else</TD></TR><TR><TD CLASS="l">1361</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1362</TD><TD>                getNetworkInstrumentor().incrementManualFillReportSent(1);</TD></TR><TR><TD CLASS="l">1363</TD><TD>            }</TD></TR><TR><TD CLASS="l">1364</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1365</TD><TD>        finally {</TD></TR><TR><TD CLASS="l">1366</TD><TD>            // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">1367</TD><TD>            if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1368</TD><TD>                log.alarm(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">1369</TD><TD>                        &#34;Rolling back transaction in Process ManualFillReport &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1370</TD><TD>                        .add(&#34;order&#34;, order.getOrderId()));</TD></TR><TR CLASS="z"><TD CLASS="l">1371</TD><TD>                Transaction.rollback();</TD></TR><TR><TD CLASS="l">1372</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1373</TD><TD>        }</TD></TR><TR><TD CLASS="l">1374</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1375</TD><TD>    }</TD></TR><TR><TD CLASS="l">1376</TD><TD> </TD></TR><TR><TD CLASS="l">1377</TD><TD>    private void processLinkageFillReport(OrderRoutingParameterStruct p_orderRoutingStruct,</TD></TR><TR><TD CLASS="l">1378</TD><TD>            ManualFillStructV2[] p_manualFillStruct,</TD></TR><TR><TD CLASS="l">1379</TD><TD>            int transactionSequenceNumber,</TD></TR><TR><TD CLASS="l">1380</TD><TD>            Order order,</TD></TR><TR><TD CLASS="l"><A NAME="5a">1381</A></TD><TD>            TradeReportStruct[] tradeReports,</TD></TR><TR><TD CLASS="l">1382</TD><TD>            FilledReportStruct[] fillReports,</TD></TR><TR><TD CLASS="l">1383</TD><TD>            ManualFillReportContext context) throws CommunicationException, SystemException, AuthorizationException, DataValidationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">1384</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1385</TD><TD>        getNetworkInstrumentor().incrementManualFillReportReceived(1);</TD></TR><TR><TD CLASS="l">1386</TD><TD>        try {</TD></TR><TR><TD CLASS="l">1387</TD><TD>               try</TD></TR><TR><TD CLASS="l">1388</TD><TD>               {</TD></TR><TR CLASS="z"><TD CLASS="l">1389</TD><TD>                    ExtensionsHelper extensionsHelper  = new ExtensionsHelper(order.getExtensions());</TD></TR><TR CLASS="z"><TD CLASS="l">1390</TD><TD>                    String awayExchangeId = extensionsHelper.getValue(ExtensionFields.EXCHANGE_DESTINATION);</TD></TR><TR CLASS="z"><TD CLASS="l">1391</TD><TD>                    order.setPreviousLocation(order.getLocation());</TD></TR><TR CLASS="z"><TD CLASS="l">1392</TD><TD>                    order.setPreviousLocationType(order.getLocationType());</TD></TR><TR CLASS="z"><TD CLASS="l">1393</TD><TD>                    order.setLocationType(OrderLocations.LINKAGE);</TD></TR><TR CLASS="z"><TD CLASS="l">1394</TD><TD>                    order.setLocation(awayExchangeId);</TD></TR><TR CLASS="z"><TD CLASS="l">1395</TD><TD>                    context.setLinkageAwayExchange(awayExchangeId);</TD></TR><TR><TD CLASS="l">1396</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1397</TD><TD>                catch (java.text.ParseException e)</TD></TR><TR><TD CLASS="l">1398</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1399</TD><TD>                    log.alarm(msg().add(&#34;unable to Parse Extensions Field. Cannot set the Location of the Order to Away Exchange Id. &#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">1400</TD><TD>                            &#34;order&#34;, order.getOrderId()));</TD></TR><TR><TD CLASS="l">1401</TD><TD>                }</TD></TR><TR><TD CLASS="l">1402</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1403</TD><TD>            this.linkageInboundOrderFillReportWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">1404</TD><TD>            if (context.getException() != null)</TD></TR><TR><TD CLASS="l">1405</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1406</TD><TD>                maybeThrow(context);</TD></TR><TR><TD CLASS="l">1407</TD><TD>            }</TD></TR><TR><TD CLASS="l">1408</TD><TD>            else</TD></TR><TR><TD CLASS="l">1409</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1410</TD><TD>                getNetworkInstrumentor().incrementManualFillReportSent(1);</TD></TR><TR><TD CLASS="l">1411</TD><TD>            }</TD></TR><TR><TD CLASS="l">1412</TD><TD> </TD></TR><TR><TD CLASS="l">1413</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1414</TD><TD>        finally {</TD></TR><TR><TD CLASS="l">1415</TD><TD>            // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">1416</TD><TD>            if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1417</TD><TD>                log.alarm(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">1418</TD><TD>                        &#34;Rolling back transaction in Process LinkageFillReport &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1419</TD><TD>                        .add(&#34;order&#34;, order.getOrderId()));</TD></TR><TR CLASS="z"><TD CLASS="l">1420</TD><TD>                Transaction.rollback();</TD></TR><TR><TD CLASS="l">1421</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1422</TD><TD>        }</TD></TR><TR><TD CLASS="l"><A NAME="58">1423</A></TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1424</TD><TD>    }</TD></TR><TR><TD CLASS="l">1425</TD><TD> </TD></TR><TR><TD CLASS="l">1426</TD><TD>    public void postInitialize() throws FatalFoundationFrameworkException</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="59">1427</A></TD><TD>    {}</TD></TR><TR><TD CLASS="l">1428</TD><TD>    public void postStart()</TD></TR><TR><TD CLASS="l">1429</TD><TD>    {</TD></TR><TR><TD CLASS="l">1430</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1431</TD><TD>    }</TD></TR><TR><TD CLASS="l">1432</TD><TD> </TD></TR><TR><TD CLASS="l">1433</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1434</TD><TD>     *</TD></TR><TR><TD CLASS="l">1435</TD><TD>     * @param p_context</TD></TR><TR><TD CLASS="l">1436</TD><TD>     * @throws CommunicationException</TD></TR><TR><TD CLASS="l">1437</TD><TD>     * @throws SystemException</TD></TR><TR><TD CLASS="l">1438</TD><TD>     * @throws AuthorizationException</TD></TR><TR><TD CLASS="l">1439</TD><TD>     * @throws DataValidationException</TD></TR><TR><TD CLASS="l">1440</TD><TD>     * @throws TransactionFailedException</TD></TR><TR><TD CLASS="l">1441</TD><TD>     * @throws NotAcceptedException</TD></TR><TR><TD CLASS="l"><A NAME="50">1442</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1443</TD><TD>    private void maybeThrow(BaseOHSContext p_context) throws CommunicationException, SystemException,</TD></TR><TR><TD CLASS="l">1444</TD><TD>        AuthorizationException, DataValidationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">1445</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1446</TD><TD>        final Throwable ex = p_context.getException();</TD></TR><TR><TD CLASS="l">1447</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1448</TD><TD>        if (ex != null &amp;&amp; (ex instanceof NotAcceptedException))</TD></TR><TR><TD CLASS="l">1449</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1450</TD><TD>            NotAcceptedException naException = (NotAcceptedException) ex;</TD></TR><TR CLASS="z"><TD CLASS="l">1451</TD><TD>            if( naException.details.error == NotAcceptedCodes.SERVER_NOT_AVAILABLE)</TD></TR><TR><TD CLASS="l">1452</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1453</TD><TD>                p_context.getOrder().setOrderHistoryEnabled(false);</TD></TR><TR CLASS="z"><TD CLASS="l">1454</TD><TD>                throw ExceptionBuilder.communicationException(naException.details.message, CommunicationFailureCodes.SERVER_NOT_AVAILABLE);</TD></TR><TR><TD CLASS="l">1455</TD><TD>            }</TD></TR><TR><TD CLASS="l">1456</TD><TD>            else</TD></TR><TR><TD CLASS="l">1457</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1458</TD><TD>                p_context.maybeThrowException(NotAcceptedException.class);</TD></TR><TR><TD CLASS="l">1459</TD><TD>            }</TD></TR><TR><TD CLASS="l">1460</TD><TD>        }</TD></TR><TR><TD CLASS="l">1461</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1462</TD><TD>        p_context.maybeThrowCommSysAuth();</TD></TR><TR CLASS="z"><TD CLASS="l">1463</TD><TD>        p_context.maybeThrowException(DataValidationException.class);</TD></TR><TR CLASS="z"><TD CLASS="l">1464</TD><TD>        p_context.maybeThrowException(TransactionFailedException.class);</TD></TR><TR CLASS="z"><TD CLASS="l">1465</TD><TD>        p_context.maybeThrowAsRuntimeOrError();</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="4f">1466</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1467</TD><TD> </TD></TR><TR><TD CLASS="l">1468</TD><TD> </TD></TR><TR><TD CLASS="l">1469</TD><TD>    private Logger log(){</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="51">1470</A></TD><TD>        return log;</TD></TR><TR><TD CLASS="l">1471</TD><TD>    }</TD></TR><TR><TD CLASS="l">1472</TD><TD>    private MsgBuilder msg()</TD></TR><TR><TD CLASS="l">1473</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1474</TD><TD>        return MsgBuilder.getInstance();</TD></TR><TR><TD CLASS="l">1475</TD><TD>    }</TD></TR><TR><TD CLASS="l">1476</TD><TD> </TD></TR><TR><TD CLASS="l">1477</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="3c">1478</A></TD><TD>    public QuoteQueryV3Struct[] getQuoteQueryDataForProducts(OrderIdStruct p_orderID, String p_sessionName, int[] p_productKeys)</TD></TR><TR><TD CLASS="l">1479</TD><TD>        throws SystemException, CommunicationException, DataValidationException, NotFoundException, AuthorizationException, TransactionFailedException</TD></TR><TR><TD CLASS="l">1480</TD><TD>    {</TD></TR><TR><TD CLASS="l">1481</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1482</TD><TD>        getNetworkInstrumentor().incrementQuoteQueryRequestReceived(1);</TD></TR><TR CLASS="z"><TD CLASS="l">1483</TD><TD>        if(log().isLoggable(LogLevel.AUDIT))</TD></TR><TR><TD CLASS="l">1484</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1485</TD><TD>            log().audit(msg().add(&#34;Quote query (TSB) for&#34;).add(&#34;order&#34;,p_orderID).add(&#34;sess&#34;,p_sessionName)</TD></TR><TR CLASS="z"><TD CLASS="l">1486</TD><TD>                .add(&#34;prodKeys&#34;, p_productKeys));</TD></TR><TR><TD CLASS="l">1487</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1488</TD><TD>        QuoteQueryV3Struct[] results = this.marketDataService.getQuoteQueryDataForProductsV3(p_sessionName, p_productKeys);</TD></TR><TR><TD CLASS="l">1489</TD><TD>        //create history entry</TD></TR><TR CLASS="z"><TD CLASS="l">1490</TD><TD>        Order order = findOrder(p_orderID);</TD></TR><TR CLASS="z"><TD CLASS="l">1491</TD><TD>        if (order == null)  {</TD></TR><TR CLASS="z"><TD CLASS="l">1492</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualOrderReturn,  ManualOrderReturn received, Order Not found for: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1493</TD><TD>            .add(&#34;OrderId&#34;, new OrderId(p_orderID).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">1494</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1495</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">1496</TD><TD>        }</TD></TR><TR><TD CLASS="l">1497</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1498</TD><TD>        OrderContext orderContext = new OrderContext(order);</TD></TR><TR CLASS="z"><TD CLASS="l">1499</TD><TD>        orderContext.setQuoteQueryV3(results);</TD></TR><TR CLASS="z"><TD CLASS="l">1500</TD><TD>        for (int i = 0; i &lt; p_productKeys.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1501</TD><TD>            order.getOrderHistoryHome().createHistoryTSBRequest(order, orderContext.getOrderHistoryCommonInfo(OrderLocations.PAR, order.getLocation(), p_productKeys[i]));</TD></TR><TR><TD CLASS="l">1502</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1503</TD><TD>        if(order.isOppositeSide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1504</TD><TD>            for(int i=1; i &lt;results.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1505</TD><TD>                PriceStruct tempAskPriceStruct = results[i].topOfBook.askPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">1506</TD><TD>                PriceStruct tempBidPriceStruct = results[i].topOfBook.bidPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">1507</TD><TD>                results[i].topOfBook.askPrice = tempBidPriceStruct;</TD></TR><TR CLASS="z"><TD CLASS="l">1508</TD><TD>                results[i].topOfBook.bidPrice = tempAskPriceStruct;</TD></TR><TR><TD CLASS="l">1509</TD><TD>            }</TD></TR><TR><TD CLASS="l">1510</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1511</TD><TD>        for(int i=1; i &lt;results.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1512</TD><TD>            log().audit(msg().add(&#34;TSB AskPrice: &#34; ).add(results[i].topOfBook.askPrice));</TD></TR><TR CLASS="z"><TD CLASS="l">1513</TD><TD>            log().audit(msg().add(&#34;TSB BidPrice: &#34; ).add(results[i].topOfBook.bidPrice));</TD></TR><TR><TD CLASS="l">1514</TD><TD>        }</TD></TR><TR><TD CLASS="l">1515</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1516</TD><TD>        sendTSB(order.getOrderId(), order);</TD></TR><TR CLASS="z"><TD CLASS="l">1517</TD><TD>        getNetworkInstrumentor().incrementQuoteQueryRequestSent(1);</TD></TR><TR CLASS="z"><TD CLASS="l">1518</TD><TD>        return results;</TD></TR><TR><TD CLASS="l"><A NAME="6c">1519</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1520</TD><TD> </TD></TR><TR><TD CLASS="l">1521</TD><TD>    public void setMarketDataService(MarketDataService p_svc)</TD></TR><TR><TD CLASS="l">1522</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="27">1523</A></TD><TD>        this.marketDataService = p_svc;</TD></TR><TR CLASS="z"><TD CLASS="l">1524</TD><TD>    }</TD></TR><TR><TD CLASS="l">1525</TD><TD> </TD></TR><TR><TD CLASS="l">1526</TD><TD>    private Order findOrder(OrderIdStruct orderId) {</TD></TR><TR CLASS="z"><TD CLASS="l">1527</TD><TD>        Order order = null;</TD></TR><TR><TD CLASS="l">1528</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1529</TD><TD>            order = orderHome.findOrder(orderId, false);</TD></TR><TR CLASS="z"><TD CLASS="l">1530</TD><TD>        } catch (TransactionFailedException e1) {</TD></TR><TR CLASS="z"><TD CLASS="l">1531</TD><TD>            log.alarm(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">1532</TD><TD>                    &#34;TransactionFailedException  in ManualOrderMaintenanceService &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1533</TD><TD>                    .add(&#34; Firm &#34;, orderId.executingOrGiveUpFirm.firmNumber )</TD></TR><TR CLASS="z"><TD CLASS="l">1534</TD><TD>                    .add(&#34; branch &#34; , orderId.branch )</TD></TR><TR CLASS="z"><TD CLASS="l">1535</TD><TD>                    .add(&#34; sequence&#34;, orderId.branchSequenceNumber));</TD></TR><TR CLASS="z"><TD CLASS="l">1536</TD><TD>            return null;</TD></TR><TR CLASS="z"><TD CLASS="l">1537</TD><TD>        } catch (NotFoundException e1) {</TD></TR><TR CLASS="z"><TD CLASS="l">1538</TD><TD>            log.alarm(msg().add(&#34;NotFoundException  in ManualOrderMaintenanceService &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1539</TD><TD>                    .add(&#34; Firm &#34;, orderId.executingOrGiveUpFirm.firmNumber )</TD></TR><TR CLASS="z"><TD CLASS="l">1540</TD><TD>                    .add(&#34; branch &#34; , orderId.branch )</TD></TR><TR CLASS="z"><TD CLASS="l">1541</TD><TD>                    .add(&#34; sequence&#34;, orderId.branchSequenceNumber));</TD></TR><TR CLASS="z"><TD CLASS="l">1542</TD><TD>            return null;</TD></TR><TR CLASS="z"><TD CLASS="l">1543</TD><TD>        } catch (DuplicateOrderIDException e1) {</TD></TR><TR CLASS="z"><TD CLASS="l">1544</TD><TD>            log.alarm(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">1545</TD><TD>                    &#34;DuplicateOrderIDException  in ManualOrderMaintenanceService &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1546</TD><TD>                    .add(&#34; Firm &#34;, orderId.executingOrGiveUpFirm.firmNumber )</TD></TR><TR CLASS="z"><TD CLASS="l">1547</TD><TD>                    .add(&#34; branch &#34; , orderId.branch )</TD></TR><TR CLASS="z"><TD CLASS="l">1548</TD><TD>                    .add(&#34; sequence&#34;, orderId.branchSequenceNumber));</TD></TR><TR CLASS="z"><TD CLASS="l">1549</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">1550</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1551</TD><TD>        return order;</TD></TR><TR><TD CLASS="l">1552</TD><TD>    }</TD></TR><TR><TD CLASS="l">1553</TD><TD> </TD></TR><TR><TD CLASS="l">1554</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="46">1555</A></TD><TD> </TD></TR><TR><TD CLASS="l">1556</TD><TD>    private TradeReportStruct[] getTradeReports(ManualFillStructV2[] p_manualFillStruct, Order order, ProductKeysStruct productKeys, short p_activityType,</TD></TR><TR><TD CLASS="l">1557</TD><TD>                                                boolean mmq, boolean underlyingOrder)</TD></TR><TR><TD CLASS="l">1558</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1559</TD><TD>        LegOrderDetail[] legOrderDetails = order.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">1560</TD><TD>        ArrayList&lt;TradeReportStruct&gt; tradeReportStructList = new ArrayList &lt;TradeReportStruct&gt; ();</TD></TR><TR CLASS="z"><TD CLASS="l">1561</TD><TD>        int tradeReportsCount = 1 + legOrderDetails.length;</TD></TR><TR CLASS="z"><TD CLASS="l">1562</TD><TD>        TradeReportStruct tradeReport = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1563</TD><TD>        if (order.getProductType() == ProductTypes.STRATEGY) {</TD></TR><TR CLASS="z"><TD CLASS="l">1564</TD><TD>            tradeReport = getPackageTradeReport(p_manualFillStruct, order,</TD></TR><TR CLASS="z"><TD CLASS="l">1565</TD><TD>                    order.getSide(), 0 /* this is used for complex Orders only */,p_activityType,</TD></TR><TR CLASS="z"><TD CLASS="l">1566</TD><TD>                    mmq, underlyingOrder);</TD></TR><TR><TD CLASS="l">1567</TD><TD>        }</TD></TR><TR><TD CLASS="l">1568</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">1569</TD><TD>            tradeReport = getTradeReport(p_manualFillStruct, order,</TD></TR><TR CLASS="z"><TD CLASS="l">1570</TD><TD>                                                       order.getSide(), 0 /* this is used for complex Orders only */,p_activityType,</TD></TR><TR CLASS="z"><TD CLASS="l">1571</TD><TD>                                                       mmq, underlyingOrder);</TD></TR><TR><TD CLASS="l">1572</TD><TD>        }</TD></TR><TR><TD CLASS="l">1573</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1574</TD><TD>        tradeReportStructList.add(tradeReport);</TD></TR><TR CLASS="z"><TD CLASS="l">1575</TD><TD>        if(order.getProductType() == ProductTypes.STRATEGY )</TD></TR><TR><TD CLASS="l">1576</TD><TD>        {</TD></TR><TR><TD CLASS="l">1577</TD><TD>            // create leg TradeReports</TD></TR><TR CLASS="z"><TD CLASS="l">1578</TD><TD>            for (int i = 1; i&lt; tradeReportsCount; i++)</TD></TR><TR><TD CLASS="l">1579</TD><TD>            {   </TD></TR><TR CLASS="z"><TD CLASS="l">1580</TD><TD>                TradeReportStruct currentTradeReport = TradeReportStructBuilder.buildTradeReportStruct();</TD></TR><TR><TD CLASS="l">1581</TD><TD> </TD></TR><TR><TD CLASS="l">1582</TD><TD>                // populate leg tradereport from manualfillstruct.</TD></TR><TR CLASS="z"><TD CLASS="l">1583</TD><TD>                currentTradeReport = getTradeReport(p_manualFillStruct, order,</TD></TR><TR CLASS="z"><TD CLASS="l">1584</TD><TD>                                                 legOrderDetails[i-1].getSide(), i-1 /* current index for the leg */ ,p_activityType,</TD></TR><TR CLASS="z"><TD CLASS="l">1585</TD><TD>                                                 mmq, underlyingOrder);</TD></TR><TR><TD CLASS="l">1586</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">1587</TD><TD>                currentTradeReport.productKey = legOrderDetails[i-1].getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">1588</TD><TD>                currentTradeReport.quantity = p_manualFillStruct[0].manualFill.legTradedQuantities[i-1];</TD></TR><TR CLASS="z"><TD CLASS="l">1589</TD><TD>                currentTradeReport.price = p_manualFillStruct[0].manualFill.legExecutionPrices[i-1];</TD></TR><TR CLASS="z"><TD CLASS="l">1590</TD><TD>                if(currentTradeReport.parties.length &gt; 0)</TD></TR><TR><TD CLASS="l">1591</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1592</TD><TD>                    tradeReportStructList.add(currentTradeReport);</TD></TR><TR><TD CLASS="l">1593</TD><TD>                }</TD></TR><TR><TD CLASS="l">1594</TD><TD> </TD></TR><TR><TD CLASS="l">1595</TD><TD>            }</TD></TR><TR><TD CLASS="l">1596</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1597</TD><TD>        return tradeReportStructList.toArray(new TradeReportStruct[tradeReportStructList.size()]);</TD></TR><TR><TD CLASS="l">1598</TD><TD>    }</TD></TR><TR><TD CLASS="l">1599</TD><TD> </TD></TR><TR><TD CLASS="l">1600</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1601</TD><TD>     * create the Trade Report for the manual fill report to be used later in the workflow.</TD></TR><TR><TD CLASS="l">1602</TD><TD>     * @param p_manualFillStruct</TD></TR><TR><TD CLASS="l">1603</TD><TD>     * @param order</TD></TR><TR><TD CLASS="l">1604</TD><TD>     * @param side</TD></TR><TR><TD CLASS="l">1605</TD><TD>     * @param p_type</TD></TR><TR><TD CLASS="l">1606</TD><TD>     * @return</TD></TR><TR><TD CLASS="l"><A NAME="45">1607</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">1608</TD><TD>    private TradeReportStruct getTradeReport(ManualFillStructV2[] p_manualFillStruct,</TD></TR><TR><TD CLASS="l">1609</TD><TD>            Order order, Side side, int legEntryIndex, short p_type, boolean mmq, boolean underlyingOrder)</TD></TR><TR><TD CLASS="l">1610</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1611</TD><TD>        TradeReportStruct tradeReport = TradeReportStructBuilder.buildTradeReportStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1612</TD><TD>        if(p_type == ManualFillReportTypes.OMT_MANUAL_FILL_REPORT)</TD></TR><TR><TD CLASS="l">1613</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1614</TD><TD>            tradeReport.tradeSource = TradeSources.MANUAL;</TD></TR><TR CLASS="z"><TD CLASS="l">1615</TD><TD>            tradeReport.tradeType = TradeTypes.MANUAL_TRADE;</TD></TR><TR><TD CLASS="l">1616</TD><TD>        }</TD></TR><TR><TD CLASS="l">1617</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">1618</TD><TD>            tradeReport.tradeSource = TradeSources.PAR;</TD></TR><TR CLASS="z"><TD CLASS="l">1619</TD><TD>            tradeReport.tradeType = TradeTypes.PAR_TRADE;</TD></TR><TR><TD CLASS="l">1620</TD><TD>        }</TD></TR><TR><TD CLASS="l">1621</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1622</TD><TD>        tradeReport.sessionName = order.getActiveSession();</TD></TR><TR CLASS="z"><TD CLASS="l">1623</TD><TD>        tradeReport.productKey = order.getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">1624</TD><TD>        tradeReport.quantity = p_manualFillStruct[0].manualFill.tradedQuantity;</TD></TR><TR CLASS="z"><TD CLASS="l">1625</TD><TD>        tradeReport.price = p_manualFillStruct[0].manualFill.executionPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">1626</TD><TD>        tradeReport.businessDate = new DateWrapper(TradingSessionNameHelper.getSession</TD></TR><TR CLASS="z"><TD CLASS="l">1627</TD><TD>                                                 (p_manualFillStruct[0].manualFill.sessionName).businessDay).toDateStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1628</TD><TD>        tradeReport.timeTraded.date = DateWrapper.convertToDate(p_manualFillStruct[0].manualFill.tradeDateTime);</TD></TR><TR CLASS="z"><TD CLASS="l">1629</TD><TD>        tradeReport.timeTraded.time = DateWrapper.convertToTime(p_manualFillStruct[0].manualFill.tradeDateTime);</TD></TR><TR><TD CLASS="l">1630</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1631</TD><TD>        ArrayList&lt;AtomicTradeStruct&gt; atomicTradeStructList = new ArrayList&lt;AtomicTradeStruct&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1632</TD><TD>        atomicTradeStructList = populateAtomicTrade(p_manualFillStruct, order, side, legEntryIndex, mmq, underlyingOrder);</TD></TR><TR><TD CLASS="l">1633</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1634</TD><TD>        if (atomicTradeStructList.size() &gt; 0)</TD></TR><TR><TD CLASS="l">1635</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1636</TD><TD>            tradeReport.parties = new AtomicTradeStruct[atomicTradeStructList.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">1637</TD><TD>            tradeReport.parties =  atomicTradeStructList.toArray(new AtomicTradeStruct[atomicTradeStructList.size()]);</TD></TR><TR><TD CLASS="l">1638</TD><TD>        }</TD></TR><TR><TD CLASS="l">1639</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1640</TD><TD>        return tradeReport;</TD></TR><TR><TD CLASS="l"><A NAME="37">1641</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1642</TD><TD>    </TD></TR><TR><TD CLASS="l">1643</TD><TD>    private int getPackgeTradedQuantityForOMT(ManualFillStructV2[] p_manualFillStruct, Order theOrder)</TD></TR><TR><TD CLASS="l">1644</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1645</TD><TD>        LegOrderDetail[] legs = theOrder.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">1646</TD><TD>        ArrayList&lt;Integer&gt; fillQty = new ArrayList&lt;Integer&gt;();</TD></TR><TR><TD CLASS="l">1647</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1648</TD><TD>        int originalQty = theOrder.getOriginalQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">1649</TD><TD>        int i = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1650</TD><TD>        for (int theLegQty : p_manualFillStruct[0].manualFill.legTradedQuantities) </TD></TR><TR><TD CLASS="l">1651</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1652</TD><TD>            if(i &gt;= legs.length)</TD></TR><TR><TD CLASS="l">1653</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1654</TD><TD>                break;</TD></TR><TR><TD CLASS="l">1655</TD><TD>            }</TD></TR><TR><TD CLASS="l">1656</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">1657</TD><TD>            int legRatio = legs[i].getOriginalQuantity() / originalQty;</TD></TR><TR CLASS="z"><TD CLASS="l">1658</TD><TD>            fillQty.add(theLegQty / legRatio);</TD></TR><TR CLASS="z"><TD CLASS="l">1659</TD><TD>            i++;</TD></TR><TR><TD CLASS="l">1660</TD><TD>        }</TD></TR><TR><TD CLASS="l">1661</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1662</TD><TD>        return getMinimum(fillQty.toArray(new Integer[0]));</TD></TR><TR><TD CLASS="l"><A NAME="31">1663</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1664</TD><TD>    </TD></TR><TR><TD CLASS="l">1665</TD><TD>    private int getMinimum(Integer[] fillQty)</TD></TR><TR><TD CLASS="l">1666</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1667</TD><TD>        int strategyFilledQty = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1668</TD><TD>        if (fillQty.length != 0)</TD></TR><TR><TD CLASS="l">1669</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1670</TD><TD>            strategyFilledQty = fillQty[0];</TD></TR><TR CLASS="z"><TD CLASS="l">1671</TD><TD>            for (int j = (fillQty.length - 1); j &gt;= 0; j--)</TD></TR><TR><TD CLASS="l">1672</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1673</TD><TD>                if (fillQty[j] &lt; strategyFilledQty)</TD></TR><TR><TD CLASS="l">1674</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1675</TD><TD>                    strategyFilledQty = fillQty[j];</TD></TR><TR><TD CLASS="l">1676</TD><TD>                }</TD></TR><TR><TD CLASS="l">1677</TD><TD>            }</TD></TR><TR><TD CLASS="l">1678</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1679</TD><TD>        return strategyFilledQty;</TD></TR><TR><TD CLASS="l"><A NAME="36">1680</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1681</TD><TD>    </TD></TR><TR><TD CLASS="l">1682</TD><TD>    private int getPackgeTradedQuantity(ManualFillStructV2[] p_manualFillStruct)</TD></TR><TR><TD CLASS="l">1683</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1684</TD><TD>        List&lt;Integer&gt; fillQty = new ArrayList&lt;Integer&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1685</TD><TD>        int i = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1686</TD><TD>        for (int theLegRatio : p_manualFillStruct[0].manualFill.legRatios) {</TD></TR><TR CLASS="z"><TD CLASS="l">1687</TD><TD>            if (theLegRatio == 0 ) {</TD></TR><TR CLASS="z"><TD CLASS="l">1688</TD><TD>                break;</TD></TR><TR><TD CLASS="l">1689</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1690</TD><TD>            fillQty.add(p_manualFillStruct[0].manualFill.legTradedQuantities[i] / theLegRatio);</TD></TR><TR CLASS="z"><TD CLASS="l">1691</TD><TD>            i++;</TD></TR><TR><TD CLASS="l">1692</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1693</TD><TD>        Integer[] thePackageQty = new Integer[fillQty.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">1694</TD><TD>        return getMinimum(fillQty.toArray(thePackageQty));</TD></TR><TR><TD CLASS="l">1695</TD><TD>        </TD></TR><TR><TD CLASS="l">1696</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="35">1697</A></TD><TD>    </TD></TR><TR><TD CLASS="l">1698</TD><TD>    private TradeReportStruct getPackageTradeReport(ManualFillStructV2[] p_manualFillStruct, Order anOrder, Side side,</TD></TR><TR><TD CLASS="l">1699</TD><TD>                              int legEntryIndex, short p_type, boolean mmq, boolean underlyingOrder)</TD></TR><TR><TD CLASS="l">1700</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1701</TD><TD>        TradeReportStruct tradeReport = TradeReportStructBuilder.buildTradeReportStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1702</TD><TD>        if(p_type == ManualFillReportTypes.OMT_MANUAL_FILL_REPORT)</TD></TR><TR><TD CLASS="l">1703</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1704</TD><TD>            tradeReport.tradeSource = TradeSources.MANUAL;</TD></TR><TR CLASS="z"><TD CLASS="l">1705</TD><TD>            tradeReport.tradeType = TradeTypes.MANUAL_TRADE;</TD></TR><TR CLASS="z"><TD CLASS="l">1706</TD><TD>            tradeReport.quantity = getPackgeTradedQuantityForOMT(p_manualFillStruct, anOrder);</TD></TR><TR><TD CLASS="l">1707</TD><TD>        }</TD></TR><TR><TD CLASS="l">1708</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">1709</TD><TD>            tradeReport.tradeSource = TradeSources.PAR;</TD></TR><TR CLASS="z"><TD CLASS="l">1710</TD><TD>            tradeReport.tradeType = TradeTypes.PAR_TRADE;</TD></TR><TR CLASS="z"><TD CLASS="l">1711</TD><TD>            tradeReport.quantity = getPackgeTradedQuantity(p_manualFillStruct);</TD></TR><TR><TD CLASS="l">1712</TD><TD>        }</TD></TR><TR><TD CLASS="l">1713</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1714</TD><TD>        tradeReport.sessionName = anOrder.getActiveSession();</TD></TR><TR CLASS="z"><TD CLASS="l">1715</TD><TD>        tradeReport.productKey = anOrder.getProductKey();</TD></TR><TR><TD CLASS="l">1716</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1717</TD><TD>        tradeReport.price = p_manualFillStruct[0].manualFill.executionPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">1718</TD><TD>        tradeReport.businessDate = new DateWrapper(TradingSessionNameHelper.getSession</TD></TR><TR CLASS="z"><TD CLASS="l">1719</TD><TD>                                                 (p_manualFillStruct[0].manualFill.sessionName).businessDay).toDateStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1720</TD><TD>        tradeReport.timeTraded.date = DateWrapper.convertToDate(p_manualFillStruct[0].manualFill.tradeDateTime);</TD></TR><TR CLASS="z"><TD CLASS="l">1721</TD><TD>        tradeReport.timeTraded.time = DateWrapper.convertToTime(p_manualFillStruct[0].manualFill.tradeDateTime);</TD></TR><TR CLASS="z"><TD CLASS="l">1722</TD><TD>        tradeReport.parties = new AtomicTradeStruct[1];</TD></TR><TR CLASS="z"><TD CLASS="l">1723</TD><TD>        AtomicTradeStruct[] atomicTradeStruct = new AtomicTradeStruct[1];</TD></TR><TR CLASS="z"><TD CLASS="l">1724</TD><TD>        atomicTradeStruct[0] = populateAtomicTradeForPackage(p_manualFillStruct, anOrder, anOrder.getSide(), tradeReport.quantity, mmq, underlyingOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">1725</TD><TD>        System.arraycopy(atomicTradeStruct, 0, tradeReport.parties, 0, 1);</TD></TR><TR CLASS="z"><TD CLASS="l">1726</TD><TD>        return tradeReport;</TD></TR><TR><TD CLASS="l">1727</TD><TD>    }</TD></TR><TR><TD CLASS="l">1728</TD><TD>    </TD></TR><TR><TD CLASS="l">1729</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1730</TD><TD>     *</TD></TR><TR><TD CLASS="l">1731</TD><TD>     * @param p_manualFillStruct</TD></TR><TR><TD CLASS="l">1732</TD><TD>     * @param order</TD></TR><TR><TD CLASS="l">1733</TD><TD>     * @param productKeys</TD></TR><TR><TD CLASS="l">1734</TD><TD>     * @return</TD></TR><TR><TD CLASS="l">1735</TD><TD>     * @throws DataValidationException</TD></TR><TR><TD CLASS="l">1736</TD><TD>     * @throws SystemException</TD></TR><TR><TD CLASS="l">1737</TD><TD>     * @throws CommunicationException</TD></TR><TR><TD CLASS="l">1738</TD><TD>     * @throws AuthorizationException</TD></TR><TR><TD CLASS="l"><A NAME="2c">1739</A></TD><TD>     * @throws NotFoundException</TD></TR><TR><TD CLASS="l">1740</TD><TD>     */</TD></TR><TR><TD CLASS="l">1741</TD><TD>    public FilledReportStruct[] getFillReports(ManualFillStructV2[] p_manualFillStruct, Order order, ProductKeysStruct productKeys,boolean omtFill) throws DataValidationException, SystemException, CommunicationException, AuthorizationException, NotFoundException</TD></TR><TR><TD CLASS="l">1742</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1743</TD><TD>        LegOrderDetail[] legOrderDetails = order.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">1744</TD><TD>        FilledReportStruct[] fillReports = new FilledReportStruct[ 1 + legOrderDetails.length];</TD></TR><TR><TD CLASS="l">1745</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1746</TD><TD>        fillReports[0] = buildFilledReportStruct(p_manualFillStruct[0], order,order.getPrimitiveProductKey(),0,null,omtFill);</TD></TR><TR CLASS="z"><TD CLASS="l">1747</TD><TD>        if(order.getProductType() == ProductTypes.STRATEGY )</TD></TR><TR><TD CLASS="l">1748</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1749</TD><TD>            fillReports[0].price = p_manualFillStruct[0].manualFill.executionPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">1750</TD><TD>            fillReports[0].leavesQuantity = order.getRemainingQuantity() - fillReports[0].tradedQuantity;</TD></TR><TR><TD CLASS="l">1751</TD><TD> </TD></TR><TR><TD CLASS="l">1752</TD><TD>            // build filled report for each leg.</TD></TR><TR CLASS="z"><TD CLASS="l">1753</TD><TD>            for (int i = 1; i&lt; fillReports.length; i++)</TD></TR><TR><TD CLASS="l">1754</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1755</TD><TD>                fillReports[i] = buildFilledReportStruct(p_manualFillStruct[0], order,legOrderDetails[i-1].getProductKey(),i-1,legOrderDetails[i-1],omtFill);</TD></TR><TR CLASS="z"><TD CLASS="l">1756</TD><TD>                fillReports[i].price = p_manualFillStruct[0].manualFill.legExecutionPrices[i - 1];</TD></TR><TR CLASS="z"><TD CLASS="l">1757</TD><TD>                fillReports[i].fillReportType = ReportTypes.STRATEGY_LEG_REPORT;</TD></TR><TR CLASS="z"><TD CLASS="l">1758</TD><TD>                fillReports[i].tradedQuantity = p_manualFillStruct[0].manualFill.legTradedQuantities[i -1];</TD></TR><TR CLASS="z"><TD CLASS="l">1759</TD><TD>                fillReports[i].leavesQuantity = legOrderDetails[i-1].getLeavesQuantity() - fillReports[i].tradedQuantity;</TD></TR><TR CLASS="z"><TD CLASS="l">1760</TD><TD>                fillReports[i].productKey = legOrderDetails[i-1].getProductKey();</TD></TR><TR><TD CLASS="l">1761</TD><TD>            }</TD></TR><TR><TD CLASS="l">1762</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1763</TD><TD>        return fillReports;</TD></TR><TR><TD CLASS="l"><A NAME="18">1764</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1765</TD><TD> </TD></TR><TR><TD CLASS="l">1766</TD><TD>    private FilledReportStruct buildFilledReportStruct(ManualFillStructV2 p_manualFillStruct, Order order, int prodKey , int leg,LegOrderDetail legDetails,boolean omtFill) throws DataValidationException, SystemException, CommunicationException, AuthorizationException, NotFoundException</TD></TR><TR><TD CLASS="l">1767</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1768</TD><TD>        OrderStruct orderStruct = order.getStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1769</TD><TD>        FilledReportStruct report = new FilledReportStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1770</TD><TD>        report.fillReportType = order.getProductType() == ProductTypes.STRATEGY ?</TD></TR><TR CLASS="z"><TD CLASS="l">1771</TD><TD>                                ReportTypes.STRATEGY_REPORT : ReportTypes.REGULAR_REPORT;</TD></TR><TR CLASS="z"><TD CLASS="l">1772</TD><TD>        report.tradeId = CboeId.toStruct(0);</TD></TR><TR CLASS="z"><TD CLASS="l">1773</TD><TD>        report.productKey = order.getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">1774</TD><TD>        report.tradedQuantity = p_manualFillStruct.manualFill.tradedQuantity;</TD></TR><TR CLASS="z"><TD CLASS="l">1775</TD><TD>        report.price = p_manualFillStruct.manualFill.executionPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">1776</TD><TD>        ContraPartyStruct[] contraPartyStructs = getContraParties(p_manualFillStruct.manualFill.contraBrokers,omtFill, leg, order.getProductType(),order);</TD></TR><TR CLASS="z"><TD CLASS="l">1777</TD><TD>        if (null != contraPartyStructs &amp;&amp; contraPartyStructs.length &gt; 0 ) {</TD></TR><TR CLASS="z"><TD CLASS="l">1778</TD><TD>            int size = contraPartyStructs.length;</TD></TR><TR CLASS="z"><TD CLASS="l">1779</TD><TD>            report.contraParties = new ContraPartyStruct[size];</TD></TR><TR CLASS="z"><TD CLASS="l">1780</TD><TD>            System.arraycopy(contraPartyStructs, 0, report.contraParties, 0, size);</TD></TR><TR><TD CLASS="l">1781</TD><TD>        }</TD></TR><TR><TD CLASS="l">1782</TD><TD>        //report.contraParties = getContraParties(p_manualFillStruct.contraBrokers,omtFill, leg, order.getProductType(),order);</TD></TR><TR CLASS="z"><TD CLASS="l">1783</TD><TD>        report.side = orderStruct.side;</TD></TR><TR CLASS="z"><TD CLASS="l">1784</TD><TD>        report.userId = orderStruct.userId;</TD></TR><TR CLASS="z"><TD CLASS="l">1785</TD><TD>        report.userAcronym = orderStruct.userAcronym;</TD></TR><TR CLASS="z"><TD CLASS="l">1786</TD><TD>        report.orsId = order.getOrsId();</TD></TR><TR CLASS="z"><TD CLASS="l">1787</TD><TD>        report.cmta = orderStruct.cmta;</TD></TR><TR CLASS="z"><TD CLASS="l">1788</TD><TD>        report.account = orderStruct.account;</TD></TR><TR CLASS="z"><TD CLASS="l">1789</TD><TD>        report.subaccount = orderStruct.subaccount;</TD></TR><TR CLASS="z"><TD CLASS="l">1790</TD><TD>        report.originator = orderStruct.originator;</TD></TR><TR CLASS="z"><TD CLASS="l">1791</TD><TD>        report.optionalData = orderStruct.optionalData;</TD></TR><TR CLASS="z"><TD CLASS="l">1792</TD><TD>        report.userAssignedId = orderStruct.userAssignedId;</TD></TR><TR><TD CLASS="l">1793</TD><TD>//        report.extensions = orderStruct.extensions;</TD></TR><TR CLASS="z"><TD CLASS="l">1794</TD><TD>        report.timeSent = DateWrapper.convertToDateTime(new java.util.Date().getTime());</TD></TR><TR CLASS="z"><TD CLASS="l">1795</TD><TD>        report.executingOrGiveUpFirm = orderStruct.orderId.executingOrGiveUpFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">1796</TD><TD>        report.sessionName = orderStruct.activeSession;</TD></TR><TR CLASS="z"><TD CLASS="l">1797</TD><TD>        report.executingBroker = p_manualFillStruct.manualFill.parBroker;</TD></TR><TR CLASS="z"><TD CLASS="l">1798</TD><TD>        if(order.isStrategy()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1799</TD><TD>            LegOrderDetail[] legs = order.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">1800</TD><TD>            report.positionEffect = legs[leg].getPositionEffect();</TD></TR><TR><TD CLASS="l">1801</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1802</TD><TD>            report.positionEffect = orderStruct.positionEffect;</TD></TR><TR><TD CLASS="l">1803</TD><TD>        }</TD></TR><TR><TD CLASS="l">1804</TD><TD>        try</TD></TR><TR><TD CLASS="l">1805</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1806</TD><TD>            ExtensionsHelper helper = new ExtensionsHelper(&#34;&#34;);</TD></TR><TR><TD CLASS="l">1807</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1808</TD><TD>            ProductData prodData = getProductData(prodKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1809</TD><TD>            short legProdType = prodData.getProductType();</TD></TR><TR CLASS="z"><TD CLASS="l">1810</TD><TD>            if(order.getProductType() == ProductTypes.STRATEGY &amp;&amp;</TD></TR><TR CLASS="z"><TD CLASS="l">1811</TD><TD>                    (legProdType == ProductTypes.EQUITY || legProdType == ProductTypes.INDEX)</TD></TR><TR><TD CLASS="l">1812</TD><TD>               )</TD></TR><TR><TD CLASS="l">1813</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1814</TD><TD>                ExtensionsHelper contras = new ExtensionsHelper(&#34;&#34;,TAG_DELIMITER,SOURCE_DELIMITER);</TD></TR><TR CLASS="z"><TD CLASS="l">1815</TD><TD>               for (int i = 0 ; i&lt; p_manualFillStruct.manualFill.contraBrokers.length;i++)</TD></TR><TR><TD CLASS="l">1816</TD><TD>               {</TD></TR><TR CLASS="z"><TD CLASS="l">1817</TD><TD>                   if(p_manualFillStruct.manualFill.contraBrokers[i].legTradedQuantities[leg] &gt; 0)</TD></TR><TR><TD CLASS="l">1818</TD><TD>                   {</TD></TR><TR CLASS="z"><TD CLASS="l">1819</TD><TD>                       if(p_manualFillStruct.manualFill.contraBrokers[i].exchange.trim().length() &lt;= 0)</TD></TR><TR><TD CLASS="l">1820</TD><TD>                       {</TD></TR><TR CLASS="z"><TD CLASS="l">1821</TD><TD>                           p_manualFillStruct.manualFill.contraBrokers[i].exchange = ExchangeStrings.CBOE;</TD></TR><TR><TD CLASS="l">1822</TD><TD>                       }</TD></TR><TR><TD CLASS="l">1823</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1824</TD><TD>                       helper.setValue(ExtensionFields.MEET_LOCATION_OUT,p_manualFillStruct.manualFill.contraBrokers[i].exchange);</TD></TR><TR CLASS="z"><TD CLASS="l">1825</TD><TD>                       report.extensions = helper.toString();</TD></TR><TR CLASS="z"><TD CLASS="l">1826</TD><TD>                       StringBuffer exchFirm = new StringBuffer(p_manualFillStruct.manualFill.contraBrokers[i].exchange);</TD></TR><TR CLASS="z"><TD CLASS="l">1827</TD><TD>                       exchFirm.append(SOURCE_DELIMITER).append(p_manualFillStruct.manualFill.meetFirm);</TD></TR><TR CLASS="z"><TD CLASS="l">1828</TD><TD>                       contras.setValue(p_manualFillStruct.manualFill.contraBrokers[i].broker,exchFirm.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">1829</TD><TD>                       if(log().isLoggable(LogLevel.AUDIT))</TD></TR><TR><TD CLASS="l">1830</TD><TD>                       {</TD></TR><TR CLASS="z"><TD CLASS="l">1831</TD><TD>                       log().audit(msg().add(&#34;Manual Fill Contra Broker Exchange  Firm &#34;).add(p_manualFillStruct.manualFill.contraBrokers[i].broker)</TD></TR><TR CLASS="z"><TD CLASS="l">1832</TD><TD>                               .add(p_manualFillStruct.manualFill.contraBrokers[i].exchange).add(p_manualFillStruct.manualFill.meetFirm).</TD></TR><TR CLASS="z"><TD CLASS="l">1833</TD><TD>                               add(&#34;Fill Report Extensions  &#34;).add(report.extensions).</TD></TR><TR CLASS="z"><TD CLASS="l">1834</TD><TD>                               add(&#34;Contras:Exch  &#34;).add(contras.toString()));</TD></TR><TR><TD CLASS="l">1835</TD><TD>                       }</TD></TR><TR><TD CLASS="l">1836</TD><TD>                   }</TD></TR><TR><TD CLASS="l">1837</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1838</TD><TD>                   legDetails.setContraBroker(contras.toString());</TD></TR><TR><TD CLASS="l">1839</TD><TD>               }</TD></TR><TR><TD CLASS="l">1840</TD><TD>            }</TD></TR><TR><TD CLASS="l">1841</TD><TD> </TD></TR><TR><TD CLASS="l">1842</TD><TD>        }</TD></TR><TR><TD CLASS="l">1843</TD><TD>       </TD></TR><TR CLASS="z"><TD CLASS="l">1844</TD><TD>        catch (java.text.ParseException e)</TD></TR><TR><TD CLASS="l">1845</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1846</TD><TD>            log.alarm(msg().add(&#34;Parse exception while parsing the reject fill for order ORSID &#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">1847</TD><TD>                    order.getOrsId()).add(e));</TD></TR><TR><TD CLASS="l">1848</TD><TD>        }</TD></TR><TR><TD CLASS="l">1849</TD><TD> </TD></TR><TR><TD CLASS="l">1850</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1851</TD><TD>        return report;</TD></TR><TR><TD CLASS="l">1852</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="53">1853</A></TD><TD> </TD></TR><TR><TD CLASS="l">1854</TD><TD>    private ArrayList&lt;AtomicTradeStruct&gt; populateAtomicTrade(ManualFillStructV2[] p_manualFillStruct, Order order,</TD></TR><TR><TD CLASS="l">1855</TD><TD>            Side side, int legEntryIndex, boolean mmq, boolean underlyingLinkageOrder)</TD></TR><TR><TD CLASS="l">1856</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1857</TD><TD>        ArrayList&lt;AtomicTradeStruct&gt; atomicTradeStructList = new ArrayList&lt;AtomicTradeStruct&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1858</TD><TD>        ManualContraBrokerStruct[] contraBrokers = p_manualFillStruct[0].manualFill.contraBrokers;</TD></TR><TR><TD CLASS="l">1859</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1860</TD><TD>        for(int i = 0; i &lt; contraBrokers.length; i++)</TD></TR><TR><TD CLASS="l">1861</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1862</TD><TD>            int quantity = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1863</TD><TD>            if(order.getProductType() == ProductTypes.STRATEGY )</TD></TR><TR><TD CLASS="l">1864</TD><TD>            {</TD></TR><TR><TD CLASS="l">1865</TD><TD>                // use the quantity for this contra broker for the given leg.</TD></TR><TR CLASS="z"><TD CLASS="l">1866</TD><TD>                quantity = contraBrokers[i].legTradedQuantities[legEntryIndex];</TD></TR><TR><TD CLASS="l">1867</TD><TD>            }</TD></TR><TR><TD CLASS="l">1868</TD><TD>            else</TD></TR><TR><TD CLASS="l">1869</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1870</TD><TD>                quantity = contraBrokers[i].tradedQuantity;</TD></TR><TR><TD CLASS="l">1871</TD><TD>            }</TD></TR><TR><TD CLASS="l">1872</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1873</TD><TD>            if(quantity &lt;= 0)</TD></TR><TR><TD CLASS="l">1874</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1875</TD><TD>                continue;</TD></TR><TR><TD CLASS="l">1876</TD><TD>            }</TD></TR><TR><TD CLASS="l">1877</TD><TD> </TD></TR><TR><TD CLASS="l">1878</TD><TD>            // This checks to see if the contra for the same product exists then add the quantity</TD></TR><TR CLASS="z"><TD CLASS="l">1879</TD><TD>            AtomicTradeStruct atomicTradeForcontra = checkIfContraExistsInList(contraBrokers[i],</TD></TR><TR CLASS="z"><TD CLASS="l">1880</TD><TD>                    atomicTradeStructList, side);</TD></TR><TR><TD CLASS="l">1881</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1882</TD><TD>            if(atomicTradeForcontra != null)</TD></TR><TR><TD CLASS="l">1883</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1884</TD><TD>                atomicTradeForcontra.quantity = atomicTradeForcontra.quantity + quantity;</TD></TR><TR CLASS="z"><TD CLASS="l">1885</TD><TD>                continue;</TD></TR><TR><TD CLASS="l">1886</TD><TD>            }</TD></TR><TR><TD CLASS="l">1887</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1888</TD><TD>            OrderStruct orderStruct = order.getStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1889</TD><TD>            AtomicTradeStruct atomicTrade = TradeReportStructBuilder.buildAtomicTradeStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1890</TD><TD>            atomicTrade.active = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1891</TD><TD>            atomicTrade.sessionName = p_manualFillStruct[0].manualFill.sessionName;</TD></TR><TR CLASS="z"><TD CLASS="l">1892</TD><TD>            long time = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">1893</TD><TD>            atomicTrade.entryTime.date = DateWrapper.convertToDate(time);</TD></TR><TR CLASS="z"><TD CLASS="l">1894</TD><TD>            atomicTrade.entryTime.time = DateWrapper.convertToTime(time);</TD></TR><TR CLASS="z"><TD CLASS="l">1895</TD><TD>            atomicTrade.entryType = TradeReportEntryTypes.ADD;</TD></TR><TR CLASS="z"><TD CLASS="l">1896</TD><TD>            atomicTrade.lastEntryType = TradeReportEntryTypes.ADD;</TD></TR><TR CLASS="z"><TD CLASS="l">1897</TD><TD>            atomicTrade.quantity = quantity;</TD></TR><TR><TD CLASS="l">1898</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1899</TD><TD>            if( side.isBuySide() )</TD></TR><TR><TD CLASS="l">1900</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1901</TD><TD>                atomicTrade.buyerAccount = orderStruct.account;</TD></TR><TR CLASS="z"><TD CLASS="l">1902</TD><TD>                atomicTrade.buyerBroker.acronym = p_manualFillStruct[0].manualFill.parBroker;</TD></TR><TR CLASS="z"><TD CLASS="l">1903</TD><TD>                atomicTrade.buyerBroker.exchange = orderStruct.userAcronym.exchange;</TD></TR><TR><TD CLASS="l">1904</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1905</TD><TD>                if (underlyingLinkageOrder){</TD></TR><TR CLASS="z"><TD CLASS="l">1906</TD><TD>                    atomicTrade.buyerBroker.acronym = order.getOrderProperties().getLinkageBrokerAcronym();</TD></TR><TR><TD CLASS="l">1907</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1908</TD><TD>                atomicTrade.buyerCmta = orderStruct.cmta;</TD></TR><TR CLASS="z"><TD CLASS="l">1909</TD><TD>                atomicTrade.buyerCorrespondentId = orderStruct.orderId.correspondentFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">1910</TD><TD>                atomicTrade.buyerFirm = orderStruct.orderId.executingOrGiveUpFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">1911</TD><TD>                atomicTrade.buyerFirmBranch = orderStruct.orderId.branch;</TD></TR><TR CLASS="z"><TD CLASS="l">1912</TD><TD>                atomicTrade.buyerFirmBranchSequenceNumber = orderStruct.orderId.branchSequenceNumber;</TD></TR><TR CLASS="z"><TD CLASS="l">1913</TD><TD>                atomicTrade.buyerOptionalData = orderStruct.optionalData;</TD></TR><TR CLASS="z"><TD CLASS="l">1914</TD><TD>                atomicTrade.buyerOrderOrQuote = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1915</TD><TD>                atomicTrade.buyerOrderOrQuoteKey = new CboeIdStruct(orderStruct.orderId.highCboeId, orderStruct.orderId.lowCboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">1916</TD><TD>                atomicTrade.buyerOriginator = orderStruct.originator;</TD></TR><TR CLASS="z"><TD CLASS="l">1917</TD><TD>                if(order.isStrategy()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1918</TD><TD>                    LegOrderDetail[] legs = order.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">1919</TD><TD>                    atomicTrade.buyerPositionEffect  = legs[legEntryIndex].getPositionEffect();</TD></TR><TR><TD CLASS="l">1920</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1921</TD><TD>                    atomicTrade.buyerPositionEffect = orderStruct.positionEffect;</TD></TR><TR><TD CLASS="l">1922</TD><TD>                }</TD></TR><TR><TD CLASS="l">1923</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1924</TD><TD>                atomicTrade.buyerOriginType = orderStruct.orderOriginType;</TD></TR><TR CLASS="z"><TD CLASS="l">1925</TD><TD>                atomicTrade.buyerSubaccount = orderStruct.subaccount;</TD></TR><TR><TD CLASS="l">1926</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1927</TD><TD>                atomicTrade.sellerFirm.exchange = contraBrokers[i].exchange;</TD></TR><TR CLASS="z"><TD CLASS="l">1928</TD><TD>                atomicTrade.sellerFirm.firmNumber = contraBrokers[i].firm;</TD></TR><TR CLASS="z"><TD CLASS="l">1929</TD><TD>                atomicTrade.sellerBroker.acronym = contraBrokers[i].broker;</TD></TR><TR CLASS="z"><TD CLASS="l">1930</TD><TD>                atomicTrade.sellerBroker.exchange = contraBrokers[i].exchange;</TD></TR><TR><TD CLASS="l">1931</TD><TD>            }</TD></TR><TR><TD CLASS="l">1932</TD><TD>            else</TD></TR><TR><TD CLASS="l">1933</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">1934</TD><TD>                atomicTrade.sellerAccount = orderStruct.account;</TD></TR><TR><TD CLASS="l">1935</TD><TD>                //atomicTrade.sellerBroker.exchange = orderStruct.userAcronym.exchange;</TD></TR><TR CLASS="z"><TD CLASS="l">1936</TD><TD>                atomicTrade.sellerBroker.acronym = p_manualFillStruct[0].manualFill.parBroker;</TD></TR><TR CLASS="z"><TD CLASS="l">1937</TD><TD>                if (underlyingLinkageOrder){</TD></TR><TR CLASS="z"><TD CLASS="l">1938</TD><TD>                    atomicTrade.sellerBroker.acronym = order.getOrderProperties().getLinkageBrokerAcronym();</TD></TR><TR><TD CLASS="l">1939</TD><TD>                }</TD></TR><TR><TD CLASS="l">1940</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1941</TD><TD>                atomicTrade.sellerCmta = orderStruct.cmta;</TD></TR><TR CLASS="z"><TD CLASS="l">1942</TD><TD>                atomicTrade.sellerCorrespondentId = orderStruct.orderId.correspondentFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">1943</TD><TD>                atomicTrade.sellerFirm = orderStruct.orderId.executingOrGiveUpFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">1944</TD><TD>                atomicTrade.sellerFirmBranch = orderStruct.orderId.branch;</TD></TR><TR CLASS="z"><TD CLASS="l">1945</TD><TD>                atomicTrade.sellerFirmBranchSequenceNumber = orderStruct.orderId.branchSequenceNumber;</TD></TR><TR CLASS="z"><TD CLASS="l">1946</TD><TD>                atomicTrade.sellerOptionalData = orderStruct.optionalData;</TD></TR><TR CLASS="z"><TD CLASS="l">1947</TD><TD>                atomicTrade.sellerOrderOrQuote = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1948</TD><TD>                atomicTrade.sellerOrderOrQuoteKey = new CboeIdStruct(orderStruct.orderId.highCboeId, orderStruct.orderId.lowCboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">1949</TD><TD>                atomicTrade.sellerOriginator = orderStruct.originator;</TD></TR><TR CLASS="z"><TD CLASS="l">1950</TD><TD>                if(order.isStrategy()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1951</TD><TD>                    LegOrderDetail[] legs = order.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">1952</TD><TD>                    atomicTrade.sellerPositionEffect = legs[legEntryIndex].getPositionEffect();</TD></TR><TR><TD CLASS="l">1953</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1954</TD><TD>                    atomicTrade.sellerPositionEffect = orderStruct.positionEffect;</TD></TR><TR><TD CLASS="l">1955</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1956</TD><TD>                atomicTrade.sellerOriginType = orderStruct.orderOriginType;</TD></TR><TR CLASS="z"><TD CLASS="l">1957</TD><TD>                atomicTrade.sellerSubaccount = orderStruct.subaccount;</TD></TR><TR><TD CLASS="l">1958</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1959</TD><TD>                atomicTrade.buyerFirm.exchange = contraBrokers[i].exchange;</TD></TR><TR CLASS="z"><TD CLASS="l">1960</TD><TD>                atomicTrade.buyerFirm.firmNumber = contraBrokers[i].firm;</TD></TR><TR CLASS="z"><TD CLASS="l">1961</TD><TD>                atomicTrade.buyerBroker.acronym = contraBrokers[i].broker;</TD></TR><TR CLASS="z"><TD CLASS="l">1962</TD><TD>                atomicTrade.buyerBroker.exchange = contraBrokers[i].exchange;</TD></TR><TR><TD CLASS="l">1963</TD><TD>            }</TD></TR><TR><TD CLASS="l">1964</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1965</TD><TD>            if(!mmq)</TD></TR><TR><TD CLASS="l">1966</TD><TD>            {</TD></TR><TR><TD CLASS="l">1967</TD><TD>                // populates the Contra side of the Trade</TD></TR><TR CLASS="z"><TD CLASS="l">1968</TD><TD>                populateContraSide(atomicTrade, contraBrokers[i], side, orderStruct);</TD></TR><TR><TD CLASS="l">1969</TD><TD>            }</TD></TR><TR><TD CLASS="l">1970</TD><TD>            else</TD></TR><TR><TD CLASS="l">1971</TD><TD>            {</TD></TR><TR><TD CLASS="l">1972</TD><TD>                // populate MM Side of Trade Report</TD></TR><TR CLASS="z"><TD CLASS="l">1973</TD><TD>                populateMMSide(p_manualFillStruct, orderStruct, atomicTrade,side);</TD></TR><TR><TD CLASS="l">1974</TD><TD>            }</TD></TR><TR><TD CLASS="l">1975</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">1976</TD><TD>            atomicTradeStructList.add(atomicTrade);</TD></TR><TR><TD CLASS="l">1977</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1978</TD><TD>        return atomicTradeStructList;</TD></TR><TR><TD CLASS="l">1979</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="54">1980</A></TD><TD> </TD></TR><TR><TD CLASS="l">1981</TD><TD>    private AtomicTradeStruct populateAtomicTradeForPackage(ManualFillStructV2[] p_manualFillStruct, Order order,</TD></TR><TR><TD CLASS="l">1982</TD><TD>            Side side, int totalTradeQty, boolean mmq, boolean underlyingLinkageOrder)</TD></TR><TR><TD CLASS="l">1983</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1984</TD><TD>        OrderStruct orderStruct = order.getStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1985</TD><TD>        AtomicTradeStruct atomicTrade = TradeReportStructBuilder.buildAtomicTradeStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1986</TD><TD>        atomicTrade.active = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1987</TD><TD>        atomicTrade.sessionName = p_manualFillStruct[0].manualFill.sessionName;</TD></TR><TR CLASS="z"><TD CLASS="l">1988</TD><TD>        long time = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">1989</TD><TD>        atomicTrade.entryTime.date = DateWrapper.convertToDate(time);</TD></TR><TR CLASS="z"><TD CLASS="l">1990</TD><TD>        atomicTrade.entryTime.time = DateWrapper.convertToTime(time);</TD></TR><TR CLASS="z"><TD CLASS="l">1991</TD><TD>        atomicTrade.entryType = TradeReportEntryTypes.ADD;</TD></TR><TR CLASS="z"><TD CLASS="l">1992</TD><TD>        atomicTrade.lastEntryType = TradeReportEntryTypes.ADD;</TD></TR><TR CLASS="z"><TD CLASS="l">1993</TD><TD>        atomicTrade.quantity = totalTradeQty;</TD></TR><TR><TD CLASS="l">1994</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1995</TD><TD>        if( side.isBuySide() )</TD></TR><TR><TD CLASS="l">1996</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1997</TD><TD>            atomicTrade.buyerAccount = orderStruct.account;</TD></TR><TR CLASS="z"><TD CLASS="l">1998</TD><TD>            atomicTrade.buyerBroker.acronym = orderStruct.userAcronym.acronym;</TD></TR><TR CLASS="z"><TD CLASS="l">1999</TD><TD>            atomicTrade.buyerBroker.exchange = orderStruct.userAcronym.exchange;</TD></TR><TR><TD CLASS="l">2000</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2001</TD><TD>            if (underlyingLinkageOrder){</TD></TR><TR CLASS="z"><TD CLASS="l">2002</TD><TD>                atomicTrade.buyerBroker.acronym = order.getOrderProperties().getLinkageBrokerAcronym();</TD></TR><TR><TD CLASS="l">2003</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2004</TD><TD>            atomicTrade.buyerCmta = orderStruct.cmta;</TD></TR><TR CLASS="z"><TD CLASS="l">2005</TD><TD>            atomicTrade.buyerCorrespondentId = orderStruct.orderId.correspondentFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">2006</TD><TD>            atomicTrade.buyerFirm = orderStruct.orderId.executingOrGiveUpFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">2007</TD><TD>            atomicTrade.buyerFirmBranch = orderStruct.orderId.branch;</TD></TR><TR CLASS="z"><TD CLASS="l">2008</TD><TD>            atomicTrade.buyerFirmBranchSequenceNumber = orderStruct.orderId.branchSequenceNumber;</TD></TR><TR CLASS="z"><TD CLASS="l">2009</TD><TD>            atomicTrade.buyerOptionalData = orderStruct.optionalData;</TD></TR><TR CLASS="z"><TD CLASS="l">2010</TD><TD>            atomicTrade.buyerOrderOrQuote = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2011</TD><TD>            atomicTrade.buyerOrderOrQuoteKey = new CboeIdStruct(orderStruct.orderId.highCboeId, orderStruct.orderId.lowCboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">2012</TD><TD>            atomicTrade.buyerOriginator = orderStruct.originator;</TD></TR><TR CLASS="z"><TD CLASS="l">2013</TD><TD>            atomicTrade.buyerPositionEffect = orderStruct.positionEffect;</TD></TR><TR><TD CLASS="l">2014</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2015</TD><TD>            atomicTrade.buyerOriginType = orderStruct.orderOriginType;</TD></TR><TR CLASS="z"><TD CLASS="l">2016</TD><TD>            atomicTrade.buyerSubaccount = orderStruct.subaccount;</TD></TR><TR><TD CLASS="l">2017</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2018</TD><TD>            atomicTrade.sellerBroker.acronym = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2019</TD><TD>            atomicTrade.sellerBroker.exchange = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2020</TD><TD>            atomicTrade.sellerBroker =StructBuilder.buildExchangeAcronymStruct(&#34;&#34;, &#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2021</TD><TD>            atomicTrade.sellerAccount = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2022</TD><TD>            atomicTrade.sellerFirm = StructBuilder.buildExchangeFirmStruct(&#34;&#34;, &#34;&#34;);</TD></TR><TR><TD CLASS="l">2023</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2024</TD><TD>            atomicTrade.sellerCmta = StructBuilder.buildExchangeFirmStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2025</TD><TD>            atomicTrade.sellerCorrespondentId = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2026</TD><TD>            atomicTrade.sellerOrderOrQuote = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2027</TD><TD>            atomicTrade.sellerOrderOrQuoteKey = new CboeIdStruct(0, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">2028</TD><TD>            atomicTrade.sellerOriginator = StructBuilder.buildExchangeAcronymStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2029</TD><TD>            atomicTrade.sellerPositionEffect = ' ';</TD></TR><TR CLASS="z"><TD CLASS="l">2030</TD><TD>            atomicTrade.sellerOptionalData = &#34;&#34;;</TD></TR><TR><TD CLASS="l">2031</TD><TD>            </TD></TR><TR><TD CLASS="l">2032</TD><TD>        }</TD></TR><TR><TD CLASS="l">2033</TD><TD>        else</TD></TR><TR><TD CLASS="l">2034</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2035</TD><TD>            atomicTrade.sellerAccount = orderStruct.account;</TD></TR><TR CLASS="z"><TD CLASS="l">2036</TD><TD>            atomicTrade.sellerBroker.exchange = orderStruct.userAcronym.exchange;</TD></TR><TR CLASS="z"><TD CLASS="l">2037</TD><TD>            atomicTrade.sellerBroker.acronym = orderStruct.userAcronym.acronym;</TD></TR><TR><TD CLASS="l">2038</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2039</TD><TD>            if (underlyingLinkageOrder){</TD></TR><TR CLASS="z"><TD CLASS="l">2040</TD><TD>                atomicTrade.sellerBroker.acronym = order.getOrderProperties().getLinkageBrokerAcronym();</TD></TR><TR><TD CLASS="l">2041</TD><TD>            }</TD></TR><TR><TD CLASS="l">2042</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2043</TD><TD>            atomicTrade.sellerCmta = orderStruct.cmta;</TD></TR><TR CLASS="z"><TD CLASS="l">2044</TD><TD>            atomicTrade.sellerCorrespondentId = orderStruct.orderId.correspondentFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">2045</TD><TD>            atomicTrade.sellerFirm = orderStruct.orderId.executingOrGiveUpFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">2046</TD><TD>            atomicTrade.sellerFirmBranch = orderStruct.orderId.branch;</TD></TR><TR CLASS="z"><TD CLASS="l">2047</TD><TD>            atomicTrade.sellerFirmBranchSequenceNumber = orderStruct.orderId.branchSequenceNumber;</TD></TR><TR CLASS="z"><TD CLASS="l">2048</TD><TD>            atomicTrade.sellerOptionalData = orderStruct.optionalData;</TD></TR><TR CLASS="z"><TD CLASS="l">2049</TD><TD>            atomicTrade.sellerOrderOrQuote = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2050</TD><TD>            atomicTrade.sellerOrderOrQuoteKey = new CboeIdStruct(orderStruct.orderId.highCboeId, orderStruct.orderId.lowCboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">2051</TD><TD>            atomicTrade.sellerOriginator = orderStruct.originator;</TD></TR><TR CLASS="z"><TD CLASS="l">2052</TD><TD>            atomicTrade.sellerPositionEffect = orderStruct.positionEffect;</TD></TR><TR CLASS="z"><TD CLASS="l">2053</TD><TD>            atomicTrade.sellerOriginType = orderStruct.orderOriginType;</TD></TR><TR CLASS="z"><TD CLASS="l">2054</TD><TD>            atomicTrade.sellerSubaccount = orderStruct.subaccount;</TD></TR><TR><TD CLASS="l">2055</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2056</TD><TD>            atomicTrade.buyerBroker =StructBuilder.buildExchangeAcronymStruct(&#34;&#34;, &#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2057</TD><TD>            atomicTrade.buyerAccount = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2058</TD><TD>            atomicTrade.buyerFirm = StructBuilder.buildExchangeFirmStruct(&#34;&#34;, &#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2059</TD><TD>            atomicTrade.buyerOriginType = OrderOrigins.MARKET_MAKER;</TD></TR><TR CLASS="z"><TD CLASS="l">2060</TD><TD>            atomicTrade.buyerSubaccount = &#34;&#34;;</TD></TR><TR><TD CLASS="l">2061</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2062</TD><TD>            atomicTrade.buyerCmta = StructBuilder.buildExchangeFirmStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2063</TD><TD>            atomicTrade.buyerCorrespondentId = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2064</TD><TD>            atomicTrade.buyerOrderOrQuote = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2065</TD><TD>            atomicTrade.buyerOrderOrQuoteKey = new CboeIdStruct(0, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">2066</TD><TD>            atomicTrade.buyerOriginator = StructBuilder.buildExchangeAcronymStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2067</TD><TD>            atomicTrade.buyerPositionEffect = ' ';</TD></TR><TR CLASS="z"><TD CLASS="l">2068</TD><TD>            atomicTrade.buyerOptionalData = &#34;&#34;;</TD></TR><TR><TD CLASS="l">2069</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2070</TD><TD>        return atomicTrade;</TD></TR><TR><TD CLASS="l">2071</TD><TD>    }</TD></TR><TR><TD CLASS="l">2072</TD><TD> </TD></TR><TR><TD CLASS="l">2073</TD><TD> </TD></TR><TR><TD CLASS="l">2074</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2075</TD><TD>     * This return the Atomic trade for the contra if it exists in the list.</TD></TR><TR><TD CLASS="l">2076</TD><TD>     * @param contraBroker</TD></TR><TR><TD CLASS="l">2077</TD><TD>     * @param atomicTradeStructList</TD></TR><TR><TD CLASS="l">2078</TD><TD>     * @param side</TD></TR><TR><TD CLASS="l">2079</TD><TD>     * @return</TD></TR><TR><TD CLASS="l">2080</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="1c">2081</A></TD><TD>    private AtomicTradeStruct checkIfContraExistsInList(ManualContraBrokerStruct contraBroker,</TD></TR><TR><TD CLASS="l">2082</TD><TD>                                         ArrayList&lt;AtomicTradeStruct&gt; atomicTradeStructList,</TD></TR><TR><TD CLASS="l">2083</TD><TD>                                         Side side)</TD></TR><TR><TD CLASS="l">2084</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2085</TD><TD>        AtomicTradeStruct atomicTradeForContra = null;</TD></TR><TR><TD CLASS="l">2086</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2087</TD><TD>        for(int contraIndex = 0; contraIndex &lt; atomicTradeStructList.size(); contraIndex++)</TD></TR><TR><TD CLASS="l">2088</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2089</TD><TD>            AtomicTradeStruct atomicTrade = atomicTradeStructList.get(contraIndex);</TD></TR><TR CLASS="z"><TD CLASS="l">2090</TD><TD>            if(side.isBuySide())</TD></TR><TR><TD CLASS="l">2091</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2092</TD><TD>                if( (atomicTrade.sellerBroker.acronym.equals(contraBroker.broker)) &amp;&amp;</TD></TR><TR CLASS="z"><TD CLASS="l">2093</TD><TD>                     (atomicTrade.sellerFirm.firmNumber.equals(contraBroker.firm)) )</TD></TR><TR><TD CLASS="l">2094</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2095</TD><TD>                    atomicTradeForContra = atomicTrade;</TD></TR><TR><TD CLASS="l">2096</TD><TD>                }</TD></TR><TR><TD CLASS="l">2097</TD><TD>            }</TD></TR><TR><TD CLASS="l">2098</TD><TD>            else</TD></TR><TR><TD CLASS="l">2099</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2100</TD><TD>                if( (atomicTrade.buyerBroker.acronym.equals(contraBroker.broker)) &amp;&amp;</TD></TR><TR CLASS="z"><TD CLASS="l">2101</TD><TD>                        (atomicTrade.buyerFirm.firmNumber.equals(contraBroker.firm)) )</TD></TR><TR><TD CLASS="l">2102</TD><TD>                   {</TD></TR><TR CLASS="z"><TD CLASS="l">2103</TD><TD>                       atomicTradeForContra = atomicTrade;</TD></TR><TR><TD CLASS="l">2104</TD><TD>                   }</TD></TR><TR><TD CLASS="l">2105</TD><TD>            }</TD></TR><TR><TD CLASS="l">2106</TD><TD>        }</TD></TR><TR><TD CLASS="l">2107</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2108</TD><TD>        return atomicTradeForContra;</TD></TR><TR><TD CLASS="l">2109</TD><TD> </TD></TR><TR><TD CLASS="l">2110</TD><TD>    }</TD></TR><TR><TD CLASS="l">2111</TD><TD>    </TD></TR><TR><TD CLASS="l">2112</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2113</TD><TD>     * Method will search for a profile based of the classKey and session.  If no profile is found,</TD></TR><TR><TD CLASS="l">2114</TD><TD>     * the default profile will be returned.</TD></TR><TR><TD CLASS="l">2115</TD><TD>     * @param p_sessionProfile Profile to search through</TD></TR><TR><TD CLASS="l">2116</TD><TD>     * @param p_session Session needed</TD></TR><TR><TD CLASS="l">2117</TD><TD>     * @param p_classKey classKey needed</TD></TR><TR><TD CLASS="l"><A NAME="3f">2118</A></TD><TD>     * @return</TD></TR><TR><TD CLASS="l">2119</TD><TD>     */</TD></TR><TR><TD CLASS="l">2120</TD><TD>    private SessionProfileStruct getSessionProfileStructByClassSession(SessionProfileUserStruct p_sessionProfile, String p_session, int p_classKey)</TD></TR><TR><TD CLASS="l">2121</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2122</TD><TD>        SessionProfileStruct profile = null;</TD></TR><TR><TD CLASS="l">2123</TD><TD>        </TD></TR><TR><TD CLASS="l">2124</TD><TD>        // find the correct profile based off of session and classkey on the order...</TD></TR><TR CLASS="z"><TD CLASS="l">2125</TD><TD>        for (int i = 0; i &lt; p_sessionProfile.sessionProfilesByClass.length; i++)</TD></TR><TR><TD CLASS="l">2126</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2127</TD><TD>            SessionProfileStruct profileByClass = p_sessionProfile.sessionProfilesByClass[i];</TD></TR><TR CLASS="z"><TD CLASS="l">2128</TD><TD>            if (p_session.equals(profileByClass.sessionName) &amp;&amp;  p_classKey == profileByClass.classKey)</TD></TR><TR><TD CLASS="l">2129</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2130</TD><TD>                return profileByClass;</TD></TR><TR><TD CLASS="l">2131</TD><TD>            }</TD></TR><TR><TD CLASS="l">2132</TD><TD>        }</TD></TR><TR><TD CLASS="l">2133</TD><TD>        </TD></TR><TR><TD CLASS="l">2134</TD><TD>        // If no profile by class, check the default session profile.</TD></TR><TR CLASS="z"><TD CLASS="l">2135</TD><TD>        if (profile == null)</TD></TR><TR><TD CLASS="l">2136</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2137</TD><TD>            for (int i = 0; i &lt; p_sessionProfile.defaultSessionProfiles.length; i++)</TD></TR><TR><TD CLASS="l">2138</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2139</TD><TD>                SessionProfileStruct profileBySession = p_sessionProfile.defaultSessionProfiles[i];</TD></TR><TR CLASS="z"><TD CLASS="l">2140</TD><TD>                if (p_session.equals(profileBySession.sessionName))</TD></TR><TR><TD CLASS="l">2141</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2142</TD><TD>                    return profileBySession;</TD></TR><TR><TD CLASS="l">2143</TD><TD>                }</TD></TR><TR><TD CLASS="l">2144</TD><TD>            }</TD></TR><TR><TD CLASS="l">2145</TD><TD>            </TD></TR><TR><TD CLASS="l">2146</TD><TD>        }</TD></TR><TR><TD CLASS="l">2147</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">2148</TD><TD>        return p_sessionProfile.defaultProfile;</TD></TR><TR><TD CLASS="l">2149</TD><TD>    }</TD></TR><TR><TD CLASS="l">2150</TD><TD>    </TD></TR><TR><TD CLASS="l">2151</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="55">2152</A></TD><TD>    // For fills corresponding to contra brokers set for MMTNs, this method replaces the manually entered fill struct's contra firm  </TD></TR><TR><TD CLASS="l">2153</TD><TD>    // with the contra firm found in the broker's user profile in UserService.</TD></TR><TR><TD CLASS="l">2154</TD><TD>    private void populateContraFirmFromSessionProfileForMMTN(ManualFillStruct p_manualFillStruct)</TD></TR><TR><TD CLASS="l">2155</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2156</TD><TD>        SessionProfileUserStruct sessionProfile = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2157</TD><TD>        for(int i = 0; i &lt; p_manualFillStruct.contraBrokers.length; i++)</TD></TR><TR><TD CLASS="l">2158</TD><TD>        {</TD></TR><TR><TD CLASS="l">2159</TD><TD>            try</TD></TR><TR><TD CLASS="l">2160</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2161</TD><TD>                sessionProfile = BusinessServicesHelper.getUserService().getSessionProfileUserInformation(p_manualFillStruct.contraBrokers[i].broker);</TD></TR><TR><TD CLASS="l">2162</TD><TD>                 </TD></TR><TR CLASS="z"><TD CLASS="l">2163</TD><TD>                if(sessionProfile != null)</TD></TR><TR><TD CLASS="l">2164</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2165</TD><TD>                    if(isSetForMMTN(p_manualFillStruct.sessionName, sessionProfile.firm.firmNumber, sessionProfile.firm.exchange, sessionProfile.userAcronym.acronym))</TD></TR><TR><TD CLASS="l">2166</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">2167</TD><TD>                        String manualFirm = p_manualFillStruct.contraBrokers[i].firm;</TD></TR><TR CLASS="z"><TD CLASS="l">2168</TD><TD>                        p_manualFillStruct.contraBrokers[i].firm = sessionProfile.firm.firmNumber;</TD></TR><TR><TD CLASS="l">2169</TD><TD>                        </TD></TR><TR CLASS="z"><TD CLASS="l">2170</TD><TD>                        String msg1 = &#34;MOMSDI.populateContraFirmFromSessionProfileForMMTN: setting firm number to: &#34; + sessionProfile.firm.firmNumber +</TD></TR><TR CLASS="z"><TD CLASS="l">2171</TD><TD>                                      &#34; for contra broker &#34; + p_manualFillStruct.contraBrokers[i].broker;</TD></TR><TR CLASS="z"><TD CLASS="l">2172</TD><TD>                        if(manualFirm.compareTo(sessionProfile.firm.firmNumber)!=0)</TD></TR><TR><TD CLASS="l">2173</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">2174</TD><TD>                            msg1 += &#34; (PAR user entered firm: &#34; + manualFirm + &#34; has been replaced by the system).&#34;;</TD></TR><TR><TD CLASS="l">2175</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2176</TD><TD>                        log.info(msg().add(msg1));</TD></TR><TR><TD CLASS="l">2177</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2178</TD><TD>                }</TD></TR><TR><TD CLASS="l">2179</TD><TD>                else</TD></TR><TR><TD CLASS="l">2180</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2181</TD><TD>                    log.alarm(msg().add(&#34;MOMSDI.populateContraFirmFromSessionProfileForMMTN: error cannot retrieve UserInformationV2 for user [&#34; + p_manualFillStruct.contraBrokers[i].broker + &#34;]&#34;));</TD></TR><TR><TD CLASS="l">2182</TD><TD>                }</TD></TR><TR><TD CLASS="l">2183</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2184</TD><TD>            catch (Exception e)</TD></TR><TR><TD CLASS="l">2185</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2186</TD><TD>                log.alarm(msg().add(&#34;MOMSDI.populateContraFirmFromSessionProfileForMMTN: Exception while retrieving UserInformationV2 for user [&#34; + p_manualFillStruct.contraBrokers[i].broker + &#34;]&#34;).add(e));</TD></TR><TR><TD CLASS="l">2187</TD><TD>            }</TD></TR><TR><TD CLASS="l">2188</TD><TD>        }</TD></TR><TR><TD CLASS="l">2189</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">2190</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="4e">2191</A></TD><TD> </TD></TR><TR><TD CLASS="l">2192</TD><TD>    </TD></TR><TR><TD CLASS="l">2193</TD><TD>    private boolean isSetForMMTN(String sessionName, String firmNumber, String exchange, String acronym)</TD></TR><TR><TD CLASS="l">2194</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2195</TD><TD>        Boolean mmtnProcessParameter = false;</TD></TR><TR CLASS="z"><TD CLASS="l">2196</TD><TD>        String msg = &#34;sessionName: &#34; + sessionName + &#34;, &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">2197</TD><TD>                     &#34;firmNumber: &#34; + firmNumber + &#34;, &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">2198</TD><TD>                     &#34;exchange: &#34; + exchange + &#34;, &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">2199</TD><TD>                     &#34;acronym: &#34; + acronym + &#34;.&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2200</TD><TD>        log.info(msg().add(&#34;MOMSDI.isSetForMMTN: Building SessionFirmMarketMakerKey using &#34; + msg));</TD></TR><TR><TD CLASS="l">2201</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2202</TD><TD>        BasePropertyKey key = FirmPropertyKeyHelper.buildSessionFirmMarketMakerKey(sessionName, firmNumber, exchange, acronym);</TD></TR><TR><TD CLASS="l">2203</TD><TD> </TD></TR><TR><TD CLASS="l">2204</TD><TD>        try</TD></TR><TR><TD CLASS="l">2205</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2206</TD><TD>            mmtnProcessParameter = getFirmPropertyService().getMMTNotificationPreference(key);</TD></TR><TR CLASS="z"><TD CLASS="l">2207</TD><TD>            log.info(msg().add(&#34;MOMSDI.isSetForMMTN: for acronym: &#34; + acronym + &#34; MMTNotificationPreference is: &#34; + mmtnProcessParameter));</TD></TR><TR CLASS="z"><TD CLASS="l">2208</TD><TD>            if(mmtnProcessParameter == null)</TD></TR><TR><TD CLASS="l">2209</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2210</TD><TD>                mmtnProcessParameter = false;</TD></TR><TR><TD CLASS="l">2211</TD><TD>            }</TD></TR><TR><TD CLASS="l">2212</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2213</TD><TD>        catch(Exception e)</TD></TR><TR><TD CLASS="l">2214</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2215</TD><TD>            log.alarm(msg().add(&#34;MOMSDI.isSetForMMTN: Exception while retrieving MMTNotificationPreference for key obtained using &#34; + msg).add(e));</TD></TR><TR><TD CLASS="l">2216</TD><TD>        }        </TD></TR><TR><TD CLASS="l">2217</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2218</TD><TD>        return mmtnProcessParameter.booleanValue();</TD></TR><TR><TD CLASS="l">2219</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="2d">2220</A></TD><TD>    </TD></TR><TR><TD CLASS="l">2221</TD><TD>    </TD></TR><TR><TD CLASS="l">2222</TD><TD>    protected FirmPropertyService getFirmPropertyService()</TD></TR><TR><TD CLASS="l">2223</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2224</TD><TD>        if (firmPropertyService != null)</TD></TR><TR CLASS="z"><TD CLASS="l">2225</TD><TD>          return firmPropertyService;</TD></TR><TR><TD CLASS="l">2226</TD><TD> </TD></TR><TR><TD CLASS="l">2227</TD><TD>        try</TD></TR><TR><TD CLASS="l">2228</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2229</TD><TD>            FirmPropertyServiceHome serviceHome = (FirmPropertyServiceHome)HomeFactory.getInstance().findHome(FirmPropertyServiceHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">2230</TD><TD>            firmPropertyService = serviceHome.find();</TD></TR><TR><TD CLASS="l">2231</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2232</TD><TD>        catch( CBOELoggableException e )</TD></TR><TR><TD CLASS="l">2233</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2234</TD><TD>            Log.exception(&#34;Failed to find FirmPropertyService&#34;, e);</TD></TR><TR><TD CLASS="l">2235</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2236</TD><TD>        return firmPropertyService;</TD></TR><TR><TD CLASS="l">2237</TD><TD>    }            </TD></TR><TR><TD CLASS="l"><A NAME="56">2238</A></TD><TD>    </TD></TR><TR><TD CLASS="l">2239</TD><TD>    </TD></TR><TR><TD CLASS="l">2240</TD><TD>    private void populateContraSide(AtomicTradeStruct atomicTrade, ManualContraBrokerStruct contraBroker, Side side,  OrderStruct orderStruct)</TD></TR><TR><TD CLASS="l">2241</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2242</TD><TD>        String account = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2243</TD><TD>        String subAccount = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2244</TD><TD>        StringBuffer optData = new StringBuffer(CONTRA_PAD_OPT_DATA);</TD></TR><TR CLASS="z"><TD CLASS="l">2245</TD><TD>        SessionProfileUserStruct sessionProfile = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2246</TD><TD>        SessionProfileStruct profileByClassSession = null;</TD></TR><TR><TD CLASS="l">2247</TD><TD> </TD></TR><TR><TD CLASS="l">2248</TD><TD>        try</TD></TR><TR><TD CLASS="l">2249</TD><TD>        {</TD></TR><TR><TD CLASS="l">2250</TD><TD>            // Returns first &#34;Active&#34; Profile</TD></TR><TR CLASS="z"><TD CLASS="l">2251</TD><TD>            sessionProfile = BusinessServicesHelper.getUserService().getSessionProfileUserInformation(contraBroker.broker);</TD></TR><TR><TD CLASS="l">2252</TD><TD>            </TD></TR><TR><TD CLASS="l">2253</TD><TD>            // verify that firms house matches the same as we retrieved from the user service.</TD></TR><TR CLASS="z"><TD CLASS="l">2254</TD><TD>            if (!sessionProfile.firm.firmNumber.equals(contraBroker.firm))</TD></TR><TR><TD CLASS="l">2255</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2256</TD><TD>                log.info(msg().add(&#34;par's requested firm [&#34; + contraBroker.firm + &#34;] &#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">2257</TD><TD>                        &#34;does not match the firm in user service [&#34; + sessionProfile.firm.firmNumber + &#34;]&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">2258</TD><TD>                return;</TD></TR><TR><TD CLASS="l">2259</TD><TD>            }            </TD></TR><TR><TD CLASS="l">2260</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2261</TD><TD>        catch (Exception e)</TD></TR><TR><TD CLASS="l">2262</TD><TD>        {</TD></TR><TR><TD CLASS="l">2263</TD><TD>            // Invalid Contra broker, so do not populate this side of the trade</TD></TR><TR CLASS="z"><TD CLASS="l">2264</TD><TD>            log.alarm(msg().add(&#34;MOMSDI.populateContraSide: Exception while retrieving UserInformationV2 for user [&#34; + contraBroker.broker + &#34;]&#34;).add(e.getMessage()));</TD></TR><TR CLASS="z"><TD CLASS="l">2265</TD><TD>            return;</TD></TR><TR><TD CLASS="l">2266</TD><TD>        }</TD></TR><TR><TD CLASS="l">2267</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">2268</TD><TD>        if (sessionProfile != null)</TD></TR><TR><TD CLASS="l">2269</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2270</TD><TD>            profileByClassSession = getSessionProfileStructByClassSession(sessionProfile, orderStruct.activeSession, orderStruct.classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2271</TD><TD>            validContraBrokers.put(contraBroker.broker + &#34;:&#34; + contraBroker.firm, profileByClassSession);</TD></TR><TR><TD CLASS="l">2272</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">2273</TD><TD>            account = profileByClassSession.account;</TD></TR><TR CLASS="z"><TD CLASS="l">2274</TD><TD>            subAccount = profileByClassSession.subAccount;</TD></TR><TR><TD CLASS="l">2275</TD><TD>        }</TD></TR><TR><TD CLASS="l">2276</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2277</TD><TD>        if(side.isBuySide())</TD></TR><TR><TD CLASS="l">2278</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2279</TD><TD>            atomicTrade.sellerBroker =StructBuilder.buildExchangeAcronymStruct(contraBroker.exchange, contraBroker.broker);</TD></TR><TR CLASS="z"><TD CLASS="l">2280</TD><TD>            atomicTrade.sellerAccount = account;</TD></TR><TR CLASS="z"><TD CLASS="l">2281</TD><TD>            atomicTrade.sellerFirm = StructBuilder.buildExchangeFirmStruct(contraBroker.exchange, contraBroker.firm);</TD></TR><TR CLASS="z"><TD CLASS="l">2282</TD><TD>            atomicTrade.sellerOriginType = OrderOrigins.MARKET_MAKER;</TD></TR><TR CLASS="z"><TD CLASS="l">2283</TD><TD>            atomicTrade.sellerSubaccount = subAccount;</TD></TR><TR><TD CLASS="l">2284</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2285</TD><TD>            atomicTrade.sellerCmta = StructBuilder.buildExchangeFirmStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2286</TD><TD>            atomicTrade.sellerCorrespondentId = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2287</TD><TD>            atomicTrade.sellerOrderOrQuote = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2288</TD><TD>            atomicTrade.sellerOrderOrQuoteKey = new CboeIdStruct(0, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">2289</TD><TD>            atomicTrade.sellerOriginator = StructBuilder.buildExchangeAcronymStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2290</TD><TD>            atomicTrade.sellerPositionEffect = ' ';</TD></TR><TR CLASS="z"><TD CLASS="l">2291</TD><TD>            atomicTrade.sellerOptionalData = optData.insert(CONTRA_POS_SUB_ACCOUNT, subAccount).toString();</TD></TR><TR><TD CLASS="l">2292</TD><TD>        }</TD></TR><TR><TD CLASS="l">2293</TD><TD>        else</TD></TR><TR><TD CLASS="l">2294</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2295</TD><TD>            atomicTrade.buyerBroker =StructBuilder.buildExchangeAcronymStruct(contraBroker.exchange, contraBroker.broker);</TD></TR><TR CLASS="z"><TD CLASS="l">2296</TD><TD>            atomicTrade.buyerAccount = account;</TD></TR><TR CLASS="z"><TD CLASS="l">2297</TD><TD>            atomicTrade.buyerFirm = StructBuilder.buildExchangeFirmStruct(contraBroker.exchange, contraBroker.firm);</TD></TR><TR CLASS="z"><TD CLASS="l">2298</TD><TD>            atomicTrade.buyerOriginType = OrderOrigins.MARKET_MAKER;</TD></TR><TR CLASS="z"><TD CLASS="l">2299</TD><TD>            atomicTrade.buyerSubaccount = subAccount.toString();</TD></TR><TR><TD CLASS="l">2300</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2301</TD><TD>            atomicTrade.buyerCmta = StructBuilder.buildExchangeFirmStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2302</TD><TD>            atomicTrade.buyerCorrespondentId = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2303</TD><TD>            atomicTrade.buyerOrderOrQuote = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2304</TD><TD>            atomicTrade.buyerOrderOrQuoteKey = new CboeIdStruct(0, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">2305</TD><TD>            atomicTrade.buyerOriginator = StructBuilder.buildExchangeAcronymStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2306</TD><TD>            atomicTrade.buyerPositionEffect = ' ';</TD></TR><TR CLASS="z"><TD CLASS="l">2307</TD><TD>            atomicTrade.buyerOptionalData = optData.insert(CONTRA_POS_SUB_ACCOUNT, subAccount).toString();</TD></TR><TR><TD CLASS="l">2308</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2309</TD><TD>    }    </TD></TR><TR><TD CLASS="l">2310</TD><TD>    </TD></TR><TR><TD CLASS="l">2311</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2312</TD><TD>     *</TD></TR><TR><TD CLASS="l">2313</TD><TD>     * @param p_manualFillStruct</TD></TR><TR><TD CLASS="l">2314</TD><TD>     * @param orderStruct</TD></TR><TR><TD CLASS="l">2315</TD><TD>     * @param atomicTrade</TD></TR><TR><TD CLASS="l"><A NAME="57">2316</A></TD><TD>     * @param side</TD></TR><TR><TD CLASS="l">2317</TD><TD>     */</TD></TR><TR><TD CLASS="l">2318</TD><TD>    private void populateMMSide(ManualFillStructV2[] p_manualFillStruct, OrderStruct orderStruct, AtomicTradeStruct atomicTrade,Side side)</TD></TR><TR><TD CLASS="l">2319</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2320</TD><TD>        StringBuffer subAccount = new StringBuffer(p_manualFillStruct[0].manualFill.mmqAccount);</TD></TR><TR CLASS="z"><TD CLASS="l">2321</TD><TD>        String subAcct = subAccount.append(PAD_SUB_ACCOUNT).toString();</TD></TR><TR CLASS="z"><TD CLASS="l">2322</TD><TD>        StringBuffer optData = new StringBuffer(PAD_OPT_DATA);</TD></TR><TR><TD CLASS="l">2323</TD><TD>        // populate MM Side Report</TD></TR><TR CLASS="z"><TD CLASS="l">2324</TD><TD>        if(side.isBuySide())</TD></TR><TR><TD CLASS="l">2325</TD><TD>        {</TD></TR><TR><TD CLASS="l">2326</TD><TD> </TD></TR><TR><TD CLASS="l">2327</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2328</TD><TD>            atomicTrade.sellerBroker =StructBuilder.buildExchangeAcronymStruct(p_manualFillStruct[0].manualFill.contraBrokers[0].exchange,p_manualFillStruct[0].manualFill.contraBrokers[0].broker);</TD></TR><TR CLASS="z"><TD CLASS="l">2329</TD><TD>            atomicTrade.sellerAccount = p_manualFillStruct[0].manualFill.mmqAccount;</TD></TR><TR CLASS="z"><TD CLASS="l">2330</TD><TD>            atomicTrade.sellerFirm =</TD></TR><TR CLASS="z"><TD CLASS="l">2331</TD><TD>                StructBuilder.buildExchangeFirmStruct</TD></TR><TR CLASS="z"><TD CLASS="l">2332</TD><TD>                (p_manualFillStruct[0].manualFill.contraBrokers[0].exchange,p_manualFillStruct[0].manualFill.contraBrokers[0].firm);</TD></TR><TR CLASS="z"><TD CLASS="l">2333</TD><TD>            atomicTrade.sellerOriginType = OrderOriginsOperations.MARKET_MAKER;</TD></TR><TR CLASS="z"><TD CLASS="l">2334</TD><TD>            atomicTrade.sellerSubaccount = subAccount.toString();</TD></TR><TR><TD CLASS="l">2335</TD><TD> </TD></TR><TR><TD CLASS="l">2336</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2337</TD><TD>            atomicTrade.sellerCmta = StructBuilder.buildExchangeFirmStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2338</TD><TD>            atomicTrade.sellerCorrespondentId = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2339</TD><TD>            atomicTrade.sellerOrderOrQuote = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2340</TD><TD>            atomicTrade.sellerOrderOrQuoteKey = new CboeIdStruct(0, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">2341</TD><TD>            atomicTrade.sellerOriginator = StructBuilder.buildExchangeAcronymStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2342</TD><TD>            atomicTrade.sellerPositionEffect = ' ';</TD></TR><TR CLASS="z"><TD CLASS="l">2343</TD><TD>            atomicTrade.sellerOptionalData = optData.insert(POS_SUB_ACCOUNT,subAcct).toString();</TD></TR><TR><TD CLASS="l">2344</TD><TD>        }</TD></TR><TR><TD CLASS="l">2345</TD><TD>        else</TD></TR><TR><TD CLASS="l">2346</TD><TD>        {</TD></TR><TR><TD CLASS="l">2347</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2348</TD><TD>            atomicTrade.buyerBroker =StructBuilder.buildExchangeAcronymStruct(p_manualFillStruct[0].manualFill.contraBrokers[0].exchange,p_manualFillStruct[0].manualFill.contraBrokers[0].broker);</TD></TR><TR CLASS="z"><TD CLASS="l">2349</TD><TD>            atomicTrade.buyerAccount = p_manualFillStruct[0].manualFill.mmqAccount;</TD></TR><TR CLASS="z"><TD CLASS="l">2350</TD><TD>            atomicTrade.buyerFirm =</TD></TR><TR CLASS="z"><TD CLASS="l">2351</TD><TD>                StructBuilder.buildExchangeFirmStruct</TD></TR><TR CLASS="z"><TD CLASS="l">2352</TD><TD>                (p_manualFillStruct[0].manualFill.contraBrokers[0].exchange,p_manualFillStruct[0].manualFill.contraBrokers[0].firm);</TD></TR><TR CLASS="z"><TD CLASS="l">2353</TD><TD>            atomicTrade.buyerOriginType = OrderOriginsOperations.MARKET_MAKER;</TD></TR><TR CLASS="z"><TD CLASS="l">2354</TD><TD>            atomicTrade.buyerSubaccount = subAccount.toString();</TD></TR><TR><TD CLASS="l">2355</TD><TD> </TD></TR><TR><TD CLASS="l">2356</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2357</TD><TD>            atomicTrade.buyerCmta = StructBuilder.buildExchangeFirmStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2358</TD><TD>            atomicTrade.buyerCorrespondentId = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">2359</TD><TD>            atomicTrade.buyerOrderOrQuote = true;</TD></TR><TR CLASS="z"><TD CLASS="l">2360</TD><TD>            atomicTrade.buyerOrderOrQuoteKey = new CboeIdStruct(0, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">2361</TD><TD>            atomicTrade.buyerOriginator = StructBuilder.buildExchangeAcronymStruct(&#34;&#34;,&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2362</TD><TD>            atomicTrade.buyerPositionEffect = ' ';</TD></TR><TR CLASS="z"><TD CLASS="l">2363</TD><TD>            atomicTrade.buyerOptionalData = optData.insert(POS_SUB_ACCOUNT,subAcct).toString();</TD></TR><TR><TD CLASS="l">2364</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2365</TD><TD>    }</TD></TR><TR><TD CLASS="l">2366</TD><TD> </TD></TR><TR><TD CLASS="l">2367</TD><TD>    private ProductData getProductData(int productKey) throws SystemException, DataValidationException</TD></TR><TR><TD CLASS="l"><A NAME="3a">2368</A></TD><TD>    {</TD></TR><TR><TD CLASS="l">2369</TD><TD>        ProductData prodData;</TD></TR><TR><TD CLASS="l">2370</TD><TD>        try</TD></TR><TR><TD CLASS="l">2371</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2372</TD><TD>            prodData = this.productDataCache.getProductData(productKey);</TD></TR><TR><TD CLASS="l">2373</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2374</TD><TD>        catch (NotFoundException e)</TD></TR><TR><TD CLASS="l">2375</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2376</TD><TD>            final MsgBuilder msg = msg().add(&#34;Unknown productKey = &#34;, productKey).add(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">2377</TD><TD>            throw ExceptionBuilder.dataValidationException(msg.end(), DataValidationCodes.INVALID_PRODUCT);</TD></TR><TR><TD CLASS="l">2378</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2379</TD><TD>        return prodData;</TD></TR><TR><TD CLASS="l"><A NAME="2b">2380</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2381</TD><TD> </TD></TR><TR><TD CLASS="l">2382</TD><TD>    private ContraPartyStruct[] getContraParties(ManualContraBrokerStruct[] contraBrokers, boolean omtFill, int leg, short productType, Order order) throws DataValidationException, SystemException, CommunicationException, AuthorizationException, NotFoundException</TD></TR><TR><TD CLASS="l">2383</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2384</TD><TD>            ContraPartyStruct[] contraParties = new ContraPartyStruct[contraBrokers.length];</TD></TR><TR CLASS="z"><TD CLASS="l">2385</TD><TD>            for (int i=0; i&lt; contraBrokers.length; i++)</TD></TR><TR><TD CLASS="l">2386</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2387</TD><TD>                contraParties[i] = new ContraPartyStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2388</TD><TD>                if(productType == ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">2389</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2390</TD><TD>                    contraParties[i].quantity = contraBrokers[i].legTradedQuantities[leg];</TD></TR><TR><TD CLASS="l">2391</TD><TD>                }</TD></TR><TR><TD CLASS="l">2392</TD><TD>                else</TD></TR><TR><TD CLASS="l">2393</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2394</TD><TD>                    contraParties[i].quantity = contraBrokers[i].tradedQuantity;</TD></TR><TR><TD CLASS="l">2395</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2396</TD><TD>            contraParties[i].user = new ExchangeAcronymStruct(ExchangeStrings.CBOE, contraBrokers[i].broker);</TD></TR><TR><TD CLASS="l">2397</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2398</TD><TD>            UserData userAcr = null;</TD></TR><TR CLASS="z"><TD CLASS="l">2399</TD><TD>            final MsgBuilder msg = msg().add(&#34;Invalid Contra Broker &#34;, contraBrokers[i].broker);</TD></TR><TR><TD CLASS="l">2400</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2401</TD><TD>                userAcr = userDataCache.getUser(contraParties[i].user);</TD></TR><TR CLASS="z"><TD CLASS="l">2402</TD><TD>                if(userAcr == null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">2403</TD><TD>                    log.info(msg().add( &#34; in acceptManualFillReport &#34; + msg.end()) );</TD></TR><TR CLASS="z"><TD CLASS="l">2404</TD><TD>                    if(omtFill)</TD></TR><TR CLASS="z"><TD CLASS="l">2405</TD><TD>                    throw ExceptionBuilder.dataValidationException(&#34;Invalid Contra Broker &#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">2406</TD><TD>                            DataValidationCodes.INVALID_CONTRA_BROKER);</TD></TR><TR><TD CLASS="l">2407</TD><TD>                }</TD></TR><TR><TD CLASS="l">2408</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2409</TD><TD>            catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2410</TD><TD>                log.info(msg().add( &#34; in acceptManualFillReport &#34; + msg.end()) );</TD></TR><TR CLASS="z"><TD CLASS="l">2411</TD><TD>                if(omtFill)</TD></TR><TR CLASS="z"><TD CLASS="l">2412</TD><TD>                throw ExceptionBuilder.dataValidationException(&#34;Invalid Contra Broker &#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">2413</TD><TD>                        DataValidationCodes.INVALID_CONTRA_BROKER);</TD></TR><TR><TD CLASS="l">2414</TD><TD>            }</TD></TR><TR><TD CLASS="l">2415</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">2416</TD><TD>                    int firmNumber = 0;</TD></TR><TR><TD CLASS="l">2417</TD><TD>                    try{</TD></TR><TR CLASS="z"><TD CLASS="l">2418</TD><TD>                        if(contraBrokers[i].firm.length() &gt; 10) {</TD></TR><TR CLASS="z"><TD CLASS="l">2419</TD><TD>                            throw ExceptionBuilder.dataValidationException(&#34;ContraParty Firm Length cannot be greater than 10 &#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">2420</TD><TD>                                    DataValidationCodes.INVALID_CONTRA_FIRM);</TD></TR><TR><TD CLASS="l">2421</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2422</TD><TD>                        firmNumber = Integer.parseInt(contraBrokers[i].firm);</TD></TR><TR CLASS="z"><TD CLASS="l">2423</TD><TD>                    }catch(NumberFormatException nfe) {</TD></TR><TR><TD CLASS="l">2424</TD><TD>                        //Not a number; Acronym entered</TD></TR><TR><TD CLASS="l">2425</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">2426</TD><TD>                    if(firmNumber == 0) /** Firm number is zero implies, acronym entered **/{</TD></TR><TR><TD CLASS="l">2427</TD><TD>                        try{</TD></TR><TR CLASS="z"><TD CLASS="l">2428</TD><TD>                            FirmStruct firm = firmMaintenanceService.getFirmByAcronym(contraBrokers[i].firm, contraParties[i].user.exchange);</TD></TR><TR CLASS="z"><TD CLASS="l">2429</TD><TD>                            contraParties[i].firm = firm.firmNumber;</TD></TR><TR><TD CLASS="l">2430</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">2431</TD><TD>                        catch(Exception exe) {</TD></TR><TR><TD CLASS="l">2432</TD><TD>                            /** Invalid acronym; will now report as zero**/</TD></TR><TR CLASS="z"><TD CLASS="l">2433</TD><TD>                            StringBuffer messageHeader = new StringBuffer(&#34;Invalid Firm Acronym Entered: &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2434</TD><TD>                            messageHeader.append(contraBrokers[i].firm);</TD></TR><TR CLASS="z"><TD CLASS="l">2435</TD><TD>                            messageHeader.append(&#34;: Exchange: &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2436</TD><TD>                            messageHeader.append(contraParties[i].user.exchange);</TD></TR><TR CLASS="z"><TD CLASS="l">2437</TD><TD>                            messageHeader.append(&#34; For OrderId: &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2438</TD><TD>                            messageHeader.append(order.getOrderIdString());</TD></TR><TR CLASS="z"><TD CLASS="l">2439</TD><TD>                            if(log().isLoggable(LogLevel.AUDIT))</TD></TR><TR><TD CLASS="l">2440</TD><TD>                            {</TD></TR><TR CLASS="z"><TD CLASS="l">2441</TD><TD>                                log.audit(msg().add(messageHeader));</TD></TR><TR><TD CLASS="l">2442</TD><TD>                            }</TD></TR><TR CLASS="z"><TD CLASS="l">2443</TD><TD>                            log.alarm(msg().add(messageHeader));</TD></TR><TR CLASS="z"><TD CLASS="l">2444</TD><TD>                            sendMessageToHelpDesk(messageHeader.toString(), INVALID_FIRM_MESSAGE);</TD></TR><TR CLASS="z"><TD CLASS="l">2445</TD><TD>                            contraParties[i].firm = new ExchangeFirmStruct(contraParties[i].user.exchange,contraBrokers[i].firm);</TD></TR><TR CLASS="z"><TD CLASS="l">2446</TD><TD>                            contraParties[i].firm.firmNumber = INVALID_FIRM_ACRONYM;</TD></TR><TR><TD CLASS="l">2447</TD><TD>                        }</TD></TR><TR><TD CLASS="l">2448</TD><TD>                    } else /** Just for clarity ..Firm number NOT zero implies, Firm # entered **/{</TD></TR><TR CLASS="z"><TD CLASS="l">2449</TD><TD>                        contraParties[i].firm = new ExchangeFirmStruct(contraParties[i].user.exchange,contraBrokers[i].firm);</TD></TR><TR><TD CLASS="l">2450</TD><TD>                    }</TD></TR><TR><TD CLASS="l">2451</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2452</TD><TD>            catch (DataValidationException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">2453</TD><TD>                if(omtFill) {</TD></TR><TR CLASS="z"><TD CLASS="l">2454</TD><TD>                    throw e;</TD></TR><TR><TD CLASS="l">2455</TD><TD>                }</TD></TR><TR><TD CLASS="l">2456</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2457</TD><TD>            catch(Exception e) { </TD></TR><TR CLASS="z"><TD CLASS="l">2458</TD><TD>                msg().add(&#34; Firm &#34;, contraParties[i].firm.firmNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">2459</TD><TD>                log.info(msg().add( &#34;in acceptManualFillReport &#34; + msg.end()) );</TD></TR><TR><TD CLASS="l">2460</TD><TD>            }</TD></TR><TR><TD CLASS="l">2461</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2462</TD><TD>        return contraParties;</TD></TR><TR><TD CLASS="l">2463</TD><TD>    }</TD></TR><TR><TD CLASS="l">2464</TD><TD> </TD></TR><TR><TD CLASS="l">2465</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2466</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="66">2467</A></TD><TD>     * @param p_firmMaintenanceService</TD></TR><TR><TD CLASS="l">2468</TD><TD>     */</TD></TR><TR><TD CLASS="l">2469</TD><TD>    public void setFirmMaintenanceService(final FirmMaintenanceService p_firmMaintenanceService)</TD></TR><TR><TD CLASS="l">2470</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2471</TD><TD>        this.firmMaintenanceService = p_firmMaintenanceService;</TD></TR><TR CLASS="z"><TD CLASS="l">2472</TD><TD>    }</TD></TR><TR><TD CLASS="l">2473</TD><TD>    </TD></TR><TR><TD CLASS="l">2474</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2475</TD><TD>    *</TD></TR><TR><TD CLASS="l"><A NAME="67">2476</A></TD><TD>    * @param p_firmPropertyService</TD></TR><TR><TD CLASS="l">2477</TD><TD>    */</TD></TR><TR><TD CLASS="l">2478</TD><TD>   public void setFirmPropertyService(final FirmPropertyService p_firmPropertyService)</TD></TR><TR><TD CLASS="l">2479</TD><TD>   {</TD></TR><TR CLASS="z"><TD CLASS="l">2480</TD><TD>       this.firmPropertyService = p_firmPropertyService;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="77">2481</A></TD><TD>   }</TD></TR><TR><TD CLASS="l">2482</TD><TD> </TD></TR><TR><TD CLASS="l">2483</TD><TD>    public void setUserDataCache(UserDataCache p_userDataCache)</TD></TR><TR><TD CLASS="l">2484</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2485</TD><TD>        userDataCache = p_userDataCache;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="73">2486</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2487</TD><TD>    </TD></TR><TR><TD CLASS="l">2488</TD><TD>    public void setOrderValidationStrategyHome(final OrderValidationStrategyHome p_orderValidationStrategyHome)</TD></TR><TR><TD CLASS="l">2489</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2490</TD><TD>        orderValidationStrategyHome = p_orderValidationStrategyHome;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="68">2491</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2492</TD><TD> </TD></TR><TR><TD CLASS="l">2493</TD><TD>    public final void setHybridClassConfigurationHome(final HybridClassConfigurationHome p_hybridClassConfigurationHome)</TD></TR><TR><TD CLASS="l">2494</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2495</TD><TD>        this.hybridClassConfigurationHome = p_hybridClassConfigurationHome;</TD></TR><TR CLASS="z"><TD CLASS="l">2496</TD><TD>    }</TD></TR><TR><TD CLASS="l">2497</TD><TD> </TD></TR><TR><TD CLASS="l">2498</TD><TD>    public void acceptVolumeChange(OrderRoutingParameterStruct p_orderRouting,</TD></TR><TR><TD CLASS="l"><A NAME="13">2499</A></TD><TD>            OrderIdStruct p_orderID, String p_sessionName, int p_productKey, int p_changedVolume,</TD></TR><TR><TD CLASS="l">2500</TD><TD>            long p_requestTime) throws DataValidationException, NotFoundException, TransactionFailedException,</TD></TR><TR><TD CLASS="l">2501</TD><TD>            CommunicationException, SystemException, AuthorizationException, NotAcceptedException</TD></TR><TR><TD CLASS="l">2502</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2503</TD><TD>        getNetworkInstrumentor().incrementVolumeChangeReceived(1);</TD></TR><TR CLASS="z"><TD CLASS="l">2504</TD><TD>        Order order = findOrder(p_orderID);</TD></TR><TR CLASS="z"><TD CLASS="l">2505</TD><TD>        if (order == null)</TD></TR><TR><TD CLASS="l">2506</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2507</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptVolumeChange: order not found &#34;).add(&#34;OrderId&#34;, new OrderId(p_orderID).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2508</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2509</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">2510</TD><TD>        }</TD></TR><TR><TD CLASS="l">2511</TD><TD> </TD></TR><TR><TD CLASS="l">2512</TD><TD>        // check order ownership</TD></TR><TR CLASS="z"><TD CLASS="l">2513</TD><TD>        if(p_orderRouting.sourceType != order.getLocationType()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2514</TD><TD>            String msg = getVolumeChangeMessageText(order,p_orderRouting, p_orderID ,p_changedVolume,null);</TD></TR><TR CLASS="z"><TD CLASS="l">2515</TD><TD>            final MsgBuilder msgBuilder = msg().add(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2516</TD><TD>            log().alarm(msgBuilder);</TD></TR><TR CLASS="z"><TD CLASS="l">2517</TD><TD>            sendMessageToHelpDesk(getVolumeChangeSubject(p_orderRouting),msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2518</TD><TD>            return;</TD></TR><TR><TD CLASS="l">2519</TD><TD>        }</TD></TR><TR><TD CLASS="l">2520</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2521</TD><TD>        ManualOrderContext context = new ManualOrderContext();</TD></TR><TR CLASS="z"><TD CLASS="l">2522</TD><TD>        context.setRoutingParams(p_orderRouting);</TD></TR><TR CLASS="z"><TD CLASS="l">2523</TD><TD>        context.setQuantityChange(p_changedVolume);</TD></TR><TR CLASS="z"><TD CLASS="l">2524</TD><TD>        context.setRequestTime(p_requestTime);</TD></TR><TR CLASS="z"><TD CLASS="l">2525</TD><TD>        context.setManualRequest(true);</TD></TR><TR CLASS="z"><TD CLASS="l">2526</TD><TD>        context.setOrder(order);</TD></TR><TR><TD CLASS="l">2527</TD><TD> </TD></TR><TR><TD CLASS="l">2528</TD><TD>        try</TD></TR><TR><TD CLASS="l">2529</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2530</TD><TD>            this.volumeChangeWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">2531</TD><TD>            if (context.getException() != null)</TD></TR><TR><TD CLASS="l">2532</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2533</TD><TD>                maybeThrow(context);</TD></TR><TR><TD CLASS="l">2534</TD><TD>            }</TD></TR><TR><TD CLASS="l">2535</TD><TD>            else</TD></TR><TR><TD CLASS="l">2536</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2537</TD><TD>                getNetworkInstrumentor().incrementVolumeChangeSent(1);</TD></TR><TR><TD CLASS="l">2538</TD><TD>            }</TD></TR><TR><TD CLASS="l">2539</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2540</TD><TD>        catch (TransactionFailedException e)</TD></TR><TR><TD CLASS="l">2541</TD><TD>        {</TD></TR><TR><TD CLASS="l">2542</TD><TD>            // should be handled in the workflow: Defensive check</TD></TR><TR CLASS="z"><TD CLASS="l">2543</TD><TD>            log.alarm(msg().add(&#34;TransactionFailedException on acceptVolumeChange: &#34;).add(e));</TD></TR><TR><TD CLASS="l">2544</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2545</TD><TD>        finally {</TD></TR><TR><TD CLASS="l">2546</TD><TD>            // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">2547</TD><TD>            if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2548</TD><TD>                log.alarm(msg().add( &#34;Rolling back transaction in acceptVolumeChange &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">2549</TD><TD>                Transaction.rollback();</TD></TR><TR><TD CLASS="l">2550</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2551</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2552</TD><TD>    }</TD></TR><TR><TD CLASS="l">2553</TD><TD> </TD></TR><TR><TD CLASS="l">2554</TD><TD> </TD></TR><TR><TD CLASS="l">2555</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2556</TD><TD>     *</TD></TR><TR><TD CLASS="l">2557</TD><TD>     */</TD></TR><TR><TD CLASS="l">2558</TD><TD>    public OrderStruct acceptLinkageOrder(OrderRoutingParameterStruct p_orderRoutingStruct, OrderStruct p_order,</TD></TR><TR><TD CLASS="l"><A NAME="4">2559</A></TD><TD>            OrderIdStruct relatedOrder, LinkageExtensionsStruct p_extensions) throws SystemException,</TD></TR><TR><TD CLASS="l">2560</TD><TD>                CommunicationException, DataValidationException, NotFoundException,</TD></TR><TR><TD CLASS="l">2561</TD><TD>                AuthorizationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">2562</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2563</TD><TD>           getNetworkInstrumentor().incrementLinkageOrderReceived(1);</TD></TR><TR CLASS="z"><TD CLASS="l">2564</TD><TD>           ProductKeysStruct productKeys = getProductData(p_order.productKey).getProductKeysStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2565</TD><TD>           OrderStruct orderStruct = linkageOrderHandlingService.acceptLinkageOrder(p_orderRoutingStruct, p_order, relatedOrder, p_extensions, productKeys);</TD></TR><TR CLASS="z"><TD CLASS="l">2566</TD><TD>           getNetworkInstrumentor().incrementLinkageOrderSent(1);</TD></TR><TR CLASS="z"><TD CLASS="l">2567</TD><TD>           return orderStruct;</TD></TR><TR><TD CLASS="l">2568</TD><TD>    }</TD></TR><TR><TD CLASS="l">2569</TD><TD> </TD></TR><TR><TD CLASS="l">2570</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2571</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="6e">2572</A></TD><TD>     * @param p_linkageOrderHandlingService</TD></TR><TR><TD CLASS="l">2573</TD><TD>     */</TD></TR><TR><TD CLASS="l">2574</TD><TD>    public void setOHSLinkageOrderHandlingService(OHSLinkageOrderHandlingService p_linkageOrderHandlingService)</TD></TR><TR><TD CLASS="l">2575</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2576</TD><TD>        linkageOrderHandlingService = p_linkageOrderHandlingService;</TD></TR><TR CLASS="z"><TD CLASS="l">2577</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="3">2578</A></TD><TD> </TD></TR><TR><TD CLASS="l">2579</TD><TD> </TD></TR><TR><TD CLASS="l">2580</TD><TD>    public void acceptDirectRoute(String p_destination, OrderStruct p_anOrder, short p_rerouteFlag, String p_userIdRequesting) </TD></TR><TR><TD CLASS="l">2581</TD><TD>    throws SystemException, CommunicationException, DataValidationException, TransactionFailedException, NotAcceptedException, AuthorizationException {</TD></TR><TR CLASS="z"><TD CLASS="l">2582</TD><TD>        log().info(msg().add(&#34;entering MOMDI.acceptDirectRoute &#34;));</TD></TR><TR><TD CLASS="l">2583</TD><TD> </TD></TR><TR><TD CLASS="l">2584</TD><TD>        // find the order</TD></TR><TR><TD CLASS="l">2585</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2586</TD><TD>        getNetworkInstrumentor().incrementOmtDirectRouteReceived(1);</TD></TR><TR><TD CLASS="l">2587</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2588</TD><TD>        Order order = findOrder(p_anOrder.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">2589</TD><TD>        if (order == null)</TD></TR><TR><TD CLASS="l">2590</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2591</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptDirectRoute, Order not found : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">2592</TD><TD>                    + new OrderId(p_anOrder.orderId).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2593</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2594</TD><TD>            throw ExceptionBuilder.notAcceptedException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">2595</TD><TD>        }</TD></TR><TR><TD CLASS="l">2596</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2597</TD><TD>        if (!accessHelper.canRerouted(order, p_userIdRequesting, p_destination)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2598</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptDirectRoute, the user does not have permission to route the order: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2599</TD><TD>            .add(&#34;OrderId&#34;, order.getStruct().toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2600</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2601</TD><TD>            throw ExceptionBuilder.authorizationException(msg.end(), AuthorizationCodes.NOT_PERMITTED);</TD></TR><TR><TD CLASS="l">2602</TD><TD>        }</TD></TR><TR><TD CLASS="l">2603</TD><TD> </TD></TR><TR><TD CLASS="l">2604</TD><TD>//      Use the Manual as the session name to get the Manual strategy other than the CMI</TD></TR><TR CLASS="z"><TD CLASS="l">2605</TD><TD>        OrderValidationStrategy strategy = getOrderValidationStrategy(OrderValidationStrategy.HYBRID_MANUAL);</TD></TR><TR><TD CLASS="l">2606</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2607</TD><TD>        strategy.validateDirectRoute(order); </TD></TR><TR CLASS="z"><TD CLASS="l">2608</TD><TD>        if (!approveDirectRerouteFromOHS(order, p_destination)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2609</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptDirectRoute, can not route the order: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2610</TD><TD>            .add(&#34;OrderId&#34;, order.getStruct().toString()).add(&#34; to &#34;).add(p_destination);</TD></TR><TR CLASS="z"><TD CLASS="l">2611</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2612</TD><TD>            throw ExceptionBuilder.notAcceptedException(msg.end(), NotAcceptedCodes.INVALID_REQUEST );</TD></TR><TR><TD CLASS="l">2613</TD><TD>        }</TD></TR><TR><TD CLASS="l">2614</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">2615</TD><TD>        if ( (p_destination.equals(OMTRouteDestinations.TE)) || (p_destination.equals(OMTRouteDestinations.OHS)))</TD></TR><TR><TD CLASS="l">2616</TD><TD>        {</TD></TR><TR><TD CLASS="l">2617</TD><TD>            // Let's not send a strategy order with a ratio mismatch to the TE.</TD></TR><TR CLASS="z"><TD CLASS="l">2618</TD><TD>            this.validateRatio(order);</TD></TR><TR><TD CLASS="l">2619</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2620</TD><TD>        order.setBypassVolumeCheck(true);</TD></TR><TR CLASS="z"><TD CLASS="l">2621</TD><TD>        RemoveOrderContext context = new RemoveOrderContext(p_destination, p_userIdRequesting);</TD></TR><TR CLASS="z"><TD CLASS="l">2622</TD><TD>        short activityType = ActivityTypes.ORDER_ROUTED;</TD></TR><TR CLASS="z"><TD CLASS="l">2623</TD><TD>        if (p_destination.equals(OMTRouteDestinations.CROWD))</TD></TR><TR><TD CLASS="l">2624</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2625</TD><TD>            activityType = ActivityTypes.MANUAL_ORDER_REROUTE_CROWD_REQUEST;</TD></TR><TR><TD CLASS="l">2626</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2627</TD><TD>        else if (p_destination.equals(OMTRouteDestinations.OHS))</TD></TR><TR><TD CLASS="l">2628</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2629</TD><TD>            activityType = ActivityTypes.MANUAL_ORDER_REROUTE_REQUEST;</TD></TR><TR><TD CLASS="l">2630</TD><TD>        }</TD></TR><TR><TD CLASS="l">2631</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">2632</TD><TD>        context.setActionType(activityType);</TD></TR><TR CLASS="z"><TD CLASS="l">2633</TD><TD>        context.setRouteReason(ManualActivityHelper.getManualRouteReason(activityType));</TD></TR><TR CLASS="z"><TD CLASS="l">2634</TD><TD>        context.setRouteDescription(ManualActivityHelper.getManualRouteDescription(activityType));</TD></TR><TR CLASS="z"><TD CLASS="l">2635</TD><TD>        OrderRoutingParameterStruct orpStruct = new OrderRoutingParameterStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2636</TD><TD>        context.setRoutingParams(orpStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">2637</TD><TD>        orpStruct.source = order.getLocation();</TD></TR><TR CLASS="z"><TD CLASS="l">2638</TD><TD>        orpStruct.sourceType = RoutingLocationTypeHelper.getLocationTypeEnum(orpStruct.source).getOrderLocation();</TD></TR><TR><TD CLASS="l">2639</TD><TD> </TD></TR><TR><TD CLASS="l">2640</TD><TD>        // OrderContext  context = new OrderContext();</TD></TR><TR><TD CLASS="l">2641</TD><TD>        // TODO set the Destination here, since IDL signature changed</TD></TR><TR><TD CLASS="l">2642</TD><TD>        //context.setDestination(p_destination);</TD></TR><TR CLASS="z"><TD CLASS="l">2643</TD><TD>        context.setOrder(order);</TD></TR><TR CLASS="z"><TD CLASS="l">2644</TD><TD>        context.setRequestType(RequestTypeEnum.OMT_REROUTE);</TD></TR><TR CLASS="z"><TD CLASS="l">2645</TD><TD>        context.getReRouteProperties().setFunction(RequestTypeEnum.OMT_REROUTE.toString());</TD></TR><TR><TD CLASS="l">2646</TD><TD>       </TD></TR><TR CLASS="z"><TD CLASS="l">2647</TD><TD>        if(p_destination.equals(OMTRouteDestinations.TE)) </TD></TR><TR><TD CLASS="l">2648</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2649</TD><TD>            context.getOrder().setBookRequestFromPARorOMT(true);</TD></TR><TR><TD CLASS="l">2650</TD><TD>        } else </TD></TR><TR><TD CLASS="l">2651</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2652</TD><TD>           context.getOrder().setBookRequestFromPARorOMT(false);</TD></TR><TR><TD CLASS="l">2653</TD><TD>        }</TD></TR><TR><TD CLASS="l">2654</TD><TD> </TD></TR><TR><TD CLASS="l">2655</TD><TD>        try</TD></TR><TR><TD CLASS="l">2656</TD><TD>        {</TD></TR><TR><TD CLASS="l">2657</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2658</TD><TD>            this.directRouteOMT.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">2659</TD><TD>            if (context.getException() != null)</TD></TR><TR><TD CLASS="l">2660</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2661</TD><TD>                if(context.isOrderRemovedFromOMT())</TD></TR><TR><TD CLASS="l">2662</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2663</TD><TD>                    publishReroutedOrderBackToOMTOnException(context);</TD></TR><TR><TD CLASS="l">2664</TD><TD>                }</TD></TR><TR><TD CLASS="l">2665</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">2666</TD><TD>                maybeThrow(context);</TD></TR><TR><TD CLASS="l">2667</TD><TD>            }</TD></TR><TR><TD CLASS="l">2668</TD><TD>            else</TD></TR><TR><TD CLASS="l">2669</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2670</TD><TD>                getNetworkInstrumentor().incrementOmtDirectRouteSent(1);</TD></TR><TR><TD CLASS="l">2671</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2672</TD><TD>        } catch (TransactionFailedException e) {</TD></TR><TR><TD CLASS="l">2673</TD><TD>            // should be handled in the workflow: Defensive check</TD></TR><TR CLASS="z"><TD CLASS="l">2674</TD><TD>            log.alarm(msg().add(&#34;TransactionFailedException on acceptdirectRouteOMT: &#34;).add(e));</TD></TR><TR><TD CLASS="l">2675</TD><TD>        }</TD></TR><TR><TD CLASS="l">2676</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2677</TD><TD>        finally {</TD></TR><TR><TD CLASS="l">2678</TD><TD>            // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">2679</TD><TD>            if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2680</TD><TD>                log.alarm(msg().add( &#34;Rolling back transaction in acceptdirectRouteOMT &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">2681</TD><TD>                Transaction.rollback();</TD></TR><TR><TD CLASS="l">2682</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2683</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2684</TD><TD>    }</TD></TR><TR><TD CLASS="l">2685</TD><TD> </TD></TR><TR><TD CLASS="l">2686</TD><TD>    public void acceptManualOrderReturnTimeout(ManualMarketBrokerDataStruct p_marketData,</TD></TR><TR><TD CLASS="l">2687</TD><TD>            OrderRoutingParameterStruct p_orderRouting, OrderIdStruct p_orderID,</TD></TR><TR><TD CLASS="l"><A NAME="c">2688</A></TD><TD>            String p_sessionName, int p_productKey, long p_requestTime, OrderHandlingInstructionStruct p_orderHandling,</TD></TR><TR><TD CLASS="l">2689</TD><TD>            int p_quantity, int[] p_legQuantitites, short p_activityType)</TD></TR><TR><TD CLASS="l">2690</TD><TD>    throws SystemException, CommunicationException, DataValidationException, NotFoundException, AuthorizationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">2691</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2692</TD><TD>        log().info(msg().add(&#34;entering MOMDI.acceptManualOrderReturnTimeout &#34;));</TD></TR><TR><TD CLASS="l">2693</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2694</TD><TD>        getNetworkInstrumentor().incrementManualOrderReturnTimeOutReceived(1);</TD></TR><TR CLASS="z"><TD CLASS="l">2695</TD><TD>        validateOrderId(p_orderID);</TD></TR><TR CLASS="z"><TD CLASS="l">2696</TD><TD>        Order order = findOrder(p_orderID);</TD></TR><TR CLASS="z"><TD CLASS="l">2697</TD><TD>        if (order == null)</TD></TR><TR><TD CLASS="l">2698</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2699</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualOrderReturnTimeout, ManualOrder timeout received, Order Not found for: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2700</TD><TD>                                        .add(&#34;OrderId&#34;, new OrderId(p_orderID).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2701</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2702</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">2703</TD><TD>        }</TD></TR><TR><TD CLASS="l">2704</TD><TD> </TD></TR><TR><TD CLASS="l">2705</TD><TD>        // check activity type, can ne only a manual order timeout activity types not fill timeout type.</TD></TR><TR CLASS="z"><TD CLASS="l">2706</TD><TD>        if(isOrderTimeout(p_activityType))</TD></TR><TR><TD CLASS="l">2707</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2708</TD><TD>            executeTimeoutWithInstructions(p_orderRouting, order, p_quantity, p_legQuantitites, p_orderHandling,</TD></TR><TR CLASS="z"><TD CLASS="l">2709</TD><TD>                    p_activityType, p_requestTime, p_marketData, null /*manualFills*/,</TD></TR><TR CLASS="z"><TD CLASS="l">2710</TD><TD>                    0 /*txSeqNum*/, &#34;ManualOrderReturnTimeout&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2711</TD><TD>            getNetworkInstrumentor().incrementManualOrderReturnTimeOutSent(1);</TD></TR><TR><TD CLASS="l">2712</TD><TD>        }</TD></TR><TR><TD CLASS="l">2713</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">2714</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualOrderReturnTimeout, received with &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2715</TD><TD>            .add(&#34;an invalid activity type : &#34;).add(p_activityType)</TD></TR><TR CLASS="z"><TD CLASS="l">2716</TD><TD>            .add(&#34;OrderId&#34;, new OrderId(p_orderID).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2717</TD><TD>            log().alarm(msg);</TD></TR><TR><TD CLASS="l">2718</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="a">2719</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2720</TD><TD> </TD></TR><TR><TD CLASS="l">2721</TD><TD>    public void acceptManualFillTimeout (OrderRoutingParameterStruct p_orderRouting, ManualFillStruct[] p_manualFillStruct, short p_activityType, int p_transactionSequenceNumber) throws SystemException, CommunicationException, DataValidationException, NotFoundException, AuthorizationException, TransactionFailedException</TD></TR><TR><TD CLASS="l">2722</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2723</TD><TD>        validateOrderId(p_manualFillStruct[0].orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">2724</TD><TD>        getNetworkInstrumentor().incrementManualFillTimeOutReceived(1);</TD></TR><TR CLASS="z"><TD CLASS="l">2725</TD><TD>        Order order = findOrder(p_manualFillStruct[0].orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">2726</TD><TD>        if (order == null)</TD></TR><TR><TD CLASS="l">2727</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2728</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualFillTimeout, ManualFill timeout received, Order not found for: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2729</TD><TD>                               .add(&#34;OrderId&#34;, new OrderId(p_manualFillStruct[0].orderId).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2730</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">2731</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">2732</TD><TD>        }</TD></TR><TR><TD CLASS="l">2733</TD><TD> </TD></TR><TR><TD CLASS="l">2734</TD><TD> </TD></TR><TR><TD CLASS="l">2735</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2736</TD><TD>        if(order.isStrategy() &amp;&amp; isFillTimeout(p_activityType)</TD></TR><TR CLASS="z"><TD CLASS="l">2737</TD><TD>                || (order.isLinkageOrder() &amp;&amp; isFillTimeout(p_activityType))) {</TD></TR><TR CLASS="z"><TD CLASS="l">2738</TD><TD>            ManualMarketBrokerDataStruct manualMarketData = buildManualMarketBrokerData(p_manualFillStruct, order);</TD></TR><TR CLASS="z"><TD CLASS="l">2739</TD><TD>            executeTimeoutWithInstructions(p_orderRouting, order, p_manualFillStruct[0].tradedQuantity, getLegQuantities(p_manualFillStruct, order),</TD></TR><TR CLASS="z"><TD CLASS="l">2740</TD><TD>                    null /*HandlingInst*/, p_activityType, 0 /*txseq#*/, manualMarketData /*marketData*/,</TD></TR><TR CLASS="z"><TD CLASS="l">2741</TD><TD>                    p_manualFillStruct, p_transactionSequenceNumber, &#34;ManualFillTimeout&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">2742</TD><TD>            getNetworkInstrumentor().incrementManualOrderReturnTimeOutSent(1);</TD></TR><TR><TD CLASS="l">2743</TD><TD>        }</TD></TR><TR><TD CLASS="l">2744</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">2745</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualFillReturnTimeout, received with &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2746</TD><TD>            .add(&#34;an invalid fill activity type : &#34;).add(p_activityType)</TD></TR><TR CLASS="z"><TD CLASS="l">2747</TD><TD>            .add(&#34;OrderId&#34;, new OrderId(order.getOrderId()).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">2748</TD><TD>            log().alarm(msg);</TD></TR><TR><TD CLASS="l">2749</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="19">2750</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2751</TD><TD> </TD></TR><TR><TD CLASS="l">2752</TD><TD>    private ManualMarketBrokerDataStruct buildManualMarketBrokerData(ManualFillStruct[] p_manualFillStruct, Order p_order)</TD></TR><TR><TD CLASS="l">2753</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2754</TD><TD>        ManualMarketBrokerDataStruct manualMarketData = new ManualMarketBrokerDataStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2755</TD><TD>        manualMarketData.marketDataWhenReceived = new ManualMarketDataStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2756</TD><TD>        manualMarketData.marketDataWhenReceived = p_manualFillStruct[0].marketDataWhenReceived;</TD></TR><TR CLASS="z"><TD CLASS="l">2757</TD><TD>        manualMarketData.marketDataWhenTraded = new ManualMarketDataStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2758</TD><TD>        manualMarketData.marketDataWhenTraded = p_manualFillStruct[0].marketDataWhenTraded;</TD></TR><TR CLASS="z"><TD CLASS="l">2759</TD><TD>        manualMarketData.marketDataWhenSelected = new ManualMarketDataStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2760</TD><TD>        manualMarketData.marketDataWhenSelected = p_manualFillStruct[0].marketDataWhenSelected;</TD></TR><TR CLASS="z"><TD CLASS="l">2761</TD><TD>        manualMarketData.highLowNbboBidAskPrice = StructBuilder.buildPriceStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2762</TD><TD>        manualMarketData.highLowNbboBidAskPrice = p_manualFillStruct[0].highLowNbboBidAskPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">2763</TD><TD>        manualMarketData.highLowCboeBidAskPrice = StructBuilder.buildPriceStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2764</TD><TD>        manualMarketData.highLowCboeBidAskPrice = p_manualFillStruct[0].highLowCboeBidAskPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">2765</TD><TD>        manualMarketData.tradeBookPrice = StructBuilder.buildPriceStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">2766</TD><TD>        manualMarketData.tradeBookPrice = p_manualFillStruct[0].tradeBookPrice;</TD></TR><TR CLASS="z"><TD CLASS="l">2767</TD><TD>        manualMarketData.fadeExchange = p_manualFillStruct[0].fadeExchange;</TD></TR><TR CLASS="z"><TD CLASS="l">2768</TD><TD>        return manualMarketData;</TD></TR><TR><TD CLASS="l">2769</TD><TD>    }</TD></TR><TR><TD CLASS="l">2770</TD><TD> </TD></TR><TR><TD CLASS="l">2771</TD><TD>    private void executeTimeoutWithInstructions(OrderRoutingParameterStruct p_orderRouting, Order p_order, int p_quantity,</TD></TR><TR><TD CLASS="l">2772</TD><TD>            int[] p_legQuantitites, OrderHandlingInstructionStruct p_orderHandling,</TD></TR><TR><TD CLASS="l">2773</TD><TD>            short p_activityType, long p_activityTime, ManualMarketBrokerDataStruct p_marketData,</TD></TR><TR><TD CLASS="l"><A NAME="25">2774</A></TD><TD>            ManualFillStruct[] p_manualFillStruct, int p_transactionSequenceNumber, String methodName)</TD></TR><TR><TD CLASS="l">2775</TD><TD>            throws DataValidationException, CommunicationException, SystemException,</TD></TR><TR><TD CLASS="l">2776</TD><TD>            AuthorizationException, TransactionFailedException</TD></TR><TR><TD CLASS="l">2777</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2778</TD><TD>        ManualTimeoutContext context = new ManualTimeoutContext();</TD></TR><TR CLASS="z"><TD CLASS="l">2779</TD><TD>        p_order.setPreviousLocation(p_orderRouting.source);</TD></TR><TR CLASS="z"><TD CLASS="l">2780</TD><TD>        p_order.setPreviousLocationType(p_orderRouting.sourceType);</TD></TR><TR CLASS="z"><TD CLASS="l">2781</TD><TD>        context.setOrder(p_order);</TD></TR><TR CLASS="z"><TD CLASS="l">2782</TD><TD>        context.setRoutingParams(p_orderRouting);</TD></TR><TR CLASS="z"><TD CLASS="l">2783</TD><TD>        context.setOrderHandlingInstruction(p_orderHandling);</TD></TR><TR CLASS="z"><TD CLASS="l">2784</TD><TD>        context.setActivityTime(p_activityTime);</TD></TR><TR CLASS="z"><TD CLASS="l">2785</TD><TD>        context.setActivityType(p_activityType);</TD></TR><TR CLASS="z"><TD CLASS="l">2786</TD><TD>        context.setFailedActivityType(ManualActivityHelper.deduceFailedActivityType(p_activityType));</TD></TR><TR CLASS="z"><TD CLASS="l">2787</TD><TD>        context.setLegTimeoutQuantities(p_legQuantitites);</TD></TR><TR CLASS="z"><TD CLASS="l">2788</TD><TD>        context.setRejectOrTimeoutQuantity(p_quantity);</TD></TR><TR CLASS="z"><TD CLASS="l">2789</TD><TD>        context.setTransactionSequenceNumber(p_transactionSequenceNumber);</TD></TR><TR CLASS="z"><TD CLASS="l">2790</TD><TD>        context.setManualFillStruct(p_manualFillStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">2791</TD><TD>        context.setRouteReason(ManualActivityHelper.getManualRouteReason(p_activityType));</TD></TR><TR CLASS="z"><TD CLASS="l">2792</TD><TD>        context.setRouteDescription(ManualActivityHelper.getManualRouteDescription(p_activityType));</TD></TR><TR><TD CLASS="l">2793</TD><TD>        // set mktdat for TA and TB only timeouts and fill timeouts.</TD></TR><TR CLASS="z"><TD CLASS="l">2794</TD><TD>        if(p_activityType == ActivityTypes.MANUAL_ORDER_TA_TIMEOUT ||</TD></TR><TR CLASS="z"><TD CLASS="l">2795</TD><TD>                p_activityType == ActivityTypes.MANUAL_ORDER_TB_TIMEOUT ||</TD></TR><TR CLASS="z"><TD CLASS="l">2796</TD><TD>                p_activityType == ActivityTypes.MANUAL_FILL_TIMEOUT ||</TD></TR><TR CLASS="z"><TD CLASS="l">2797</TD><TD>                p_activityType == ActivityTypes.MANUAL_FILL_LINKAGE_TIMEOUT ||</TD></TR><TR CLASS="z"><TD CLASS="l">2798</TD><TD>                p_activityType == ActivityTypes.MANUAL_ORDER_SR_TIMEOUT || </TD></TR><TR CLASS="z"><TD CLASS="l">2799</TD><TD>                p_activityType == ActivityTypes.MANUAL_ORDER_FR_TIMEOUT)</TD></TR><TR><TD CLASS="l">2800</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2801</TD><TD>            context.setManualMarketBrokerData(p_marketData);</TD></TR><TR><TD CLASS="l">2802</TD><TD>        }</TD></TR><TR><TD CLASS="l">2803</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">2804</TD><TD>            if (p_order.getStruct().orderId.highCboeId == 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">2805</TD><TD>                p_order.getStruct().orderId = p_order.getOrderId();</TD></TR><TR><TD CLASS="l">2806</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2807</TD><TD>            context.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">2808</TD><TD>            this.manualTimeoutWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">2809</TD><TD>            if (context.getException() != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">2810</TD><TD>                log.alarm(msg().add(&#34;Failed to process ManualTimeoutRequest: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2811</TD><TD>                        .add(context.getActivityType()).add(&#34; for order : &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2812</TD><TD>                        .add(&#34;OrderId&#34;, new OrderId(p_order.getStruct().orderId ).toString())</TD></TR><TR CLASS="z"><TD CLASS="l">2813</TD><TD>                        .add(context.getException().getMessage()));</TD></TR><TR><TD CLASS="l">2814</TD><TD>            }</TD></TR><TR><TD CLASS="l">2815</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2816</TD><TD>        finally {</TD></TR><TR><TD CLASS="l">2817</TD><TD>            // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">2818</TD><TD>            if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">2819</TD><TD>                log.alarm(msg().add( &#34;Rolling back transaction in &#34;).add(methodName));</TD></TR><TR CLASS="z"><TD CLASS="l">2820</TD><TD>                Transaction.rollback();</TD></TR><TR><TD CLASS="l">2821</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2822</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="4d">2823</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2824</TD><TD> </TD></TR><TR><TD CLASS="l">2825</TD><TD>    private boolean isOrderTimeout(short p_activityType)</TD></TR><TR><TD CLASS="l">2826</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2827</TD><TD>        if(p_activityType == ActivityTypes.MANUAL_ORDER_TA_TIMEOUT</TD></TR><TR CLASS="z"><TD CLASS="l">2828</TD><TD>                || p_activityType == ActivityTypes.MANUAL_ORDER_TB_TIMEOUT</TD></TR><TR CLASS="z"><TD CLASS="l">2829</TD><TD>                || p_activityType == ActivityTypes.MANUAL_ORDER_BOOK_TIMEOUT</TD></TR><TR CLASS="z"><TD CLASS="l">2830</TD><TD>                || p_activityType == ActivityTypes.MANUAL_ORDER_AUCTION_TIMEOUT</TD></TR><TR CLASS="z"><TD CLASS="l">2831</TD><TD>                || p_activityType == ActivityTypes.MANUAL_ORDER_SR_TIMEOUT</TD></TR><TR CLASS="z"><TD CLASS="l">2832</TD><TD>                || p_activityType == ActivityTypes.MANUAL_ORDER_FR_TIMEOUT)</TD></TR><TR><TD CLASS="l">2833</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2834</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">2835</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2836</TD><TD>        return false;</TD></TR><TR><TD CLASS="l"><A NAME="4b">2837</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2838</TD><TD> </TD></TR><TR><TD CLASS="l">2839</TD><TD>    private boolean isFillTimeout(short p_activityType)</TD></TR><TR><TD CLASS="l">2840</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2841</TD><TD>        if(p_activityType == ActivityTypes.MANUAL_FILL_TIMEOUT || p_activityType == ActivityTypes.MANUAL_FILL_LINKAGE_TIMEOUT)</TD></TR><TR><TD CLASS="l">2842</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2843</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">2844</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2845</TD><TD>        return false;</TD></TR><TR><TD CLASS="l"><A NAME="30">2846</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2847</TD><TD> </TD></TR><TR><TD CLASS="l">2848</TD><TD>    private int[] getLegQuantities(ManualFillStruct[] p_manualFillStruct, Order order)</TD></TR><TR><TD CLASS="l">2849</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2850</TD><TD>        if(order.getProductType() == ProductTypes.OPTION) {</TD></TR><TR CLASS="z"><TD CLASS="l">2851</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">2852</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2853</TD><TD>        LegOrderEntryStructV2[] p_legEntryDetails = getLegOrderEntries(order, order.getStruct());</TD></TR><TR CLASS="z"><TD CLASS="l">2854</TD><TD>        int[] legQuantities = new int[p_legEntryDetails.length];</TD></TR><TR><TD CLASS="l">2855</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">2856</TD><TD>        for(int j=0; j &lt; p_legEntryDetails.length; j++)</TD></TR><TR><TD CLASS="l">2857</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2858</TD><TD>            legQuantities[j] = p_manualFillStruct[0].legTradedQuantities[j];</TD></TR><TR><TD CLASS="l">2859</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2860</TD><TD>        return legQuantities;</TD></TR><TR><TD CLASS="l"><A NAME="d">2861</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2862</TD><TD> </TD></TR><TR><TD CLASS="l">2863</TD><TD>    public void acceptManualQuote(com.cboe.idl.quote.ManualQuoteStruct manualQuote) throws SystemException, CommunicationException, DataValidationException, TransactionFailedException, NotAcceptedException, AuthorizationException</TD></TR><TR><TD CLASS="l">2864</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2865</TD><TD>        getNetworkInstrumentor().incrementManualQuoteReceived(1);</TD></TR><TR CLASS="z"><TD CLASS="l">2866</TD><TD>        if (isNewBOBLinkage(manualQuote.sessionName, manualQuote.productKeys.classKey, manualQuote.productKeys.productKey)) {</TD></TR><TR CLASS="z"><TD CLASS="l">2867</TD><TD>            throw ExceptionBuilder.dataValidationException(&#34;Invalid Manual Quote For New Bob class:&#34;, </TD></TR><TR CLASS="z"><TD CLASS="l">2868</TD><TD>                    DataValidationCodes.INVALID_OPERATION_TYPE); </TD></TR><TR><TD CLASS="l">2869</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2870</TD><TD>        String incomingIpAddress = manualQuote.details.ipAddress;</TD></TR><TR CLASS="z"><TD CLASS="l">2871</TD><TD>        String parsedIp = incomingIpAddress;</TD></TR><TR CLASS="z"><TD CLASS="l">2872</TD><TD>        if(log.isLoggable(LogLevel.AUDIT))</TD></TR><TR><TD CLASS="l">2873</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2874</TD><TD>            log.audit(msg().add(&#34;Incoming IP address: &#34;).add(incomingIpAddress));</TD></TR><TR><TD CLASS="l">2875</TD><TD>        }</TD></TR><TR><TD CLASS="l">2876</TD><TD>        try{</TD></TR><TR CLASS="z"><TD CLASS="l">2877</TD><TD>            StringTokenizer str = new StringTokenizer(incomingIpAddress, IPADDRESSDELIMITER);</TD></TR><TR CLASS="z"><TD CLASS="l">2878</TD><TD>            if(str.countTokens() == 4) {</TD></TR><TR CLASS="z"><TD CLASS="l">2879</TD><TD>                String firstSegment =  str.nextToken();</TD></TR><TR CLASS="z"><TD CLASS="l">2880</TD><TD>                String secondSegement = str.nextToken();</TD></TR><TR CLASS="z"><TD CLASS="l">2881</TD><TD>                String thirdSegement = str.nextToken();</TD></TR><TR CLASS="z"><TD CLASS="l">2882</TD><TD>                String fourthSegement = str.nextToken();</TD></TR><TR CLASS="z"><TD CLASS="l">2883</TD><TD>                parsedIp = thirdSegement+IPADDRESSDELIMITER+fourthSegement;</TD></TR><TR><TD CLASS="l">2884</TD><TD>            }</TD></TR><TR><TD CLASS="l">2885</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2886</TD><TD>        catch(Exception exe) {</TD></TR><TR CLASS="z"><TD CLASS="l">2887</TD><TD>            log.audit(msg().add(&#34;Unable to Parse Manual Quote, will send the ip address as is: &#34;).add(exe));</TD></TR><TR><TD CLASS="l">2888</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2889</TD><TD>        manualQuote.details.ipAddress = parsedIp;</TD></TR><TR CLASS="z"><TD CLASS="l">2890</TD><TD>        log.audit(msg().add(&#34;Outgoing IP address to TE (Parsed): &#34;).add(parsedIp));</TD></TR><TR CLASS="z"><TD CLASS="l">2891</TD><TD>        marketMakerQuoteService.acceptManualQuote(manualQuote);</TD></TR><TR CLASS="z"><TD CLASS="l">2892</TD><TD>        getNetworkInstrumentor().incrementManualQuoteSent(1);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1b">2893</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2894</TD><TD> </TD></TR><TR><TD CLASS="l">2895</TD><TD>    public void cancelManualQuote(com.cboe.idl.quote.ManualQuoteStruct manualQuote) throws SystemException, CommunicationException, DataValidationException, TransactionFailedException, NotAcceptedException, AuthorizationException, NotFoundException</TD></TR><TR><TD CLASS="l">2896</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2897</TD><TD>        getNetworkInstrumentor().incrementCancelManualQuoteReceived(1);</TD></TR><TR CLASS="z"><TD CLASS="l">2898</TD><TD>        marketMakerQuoteService.cancelManualQuote(manualQuote);</TD></TR><TR CLASS="z"><TD CLASS="l">2899</TD><TD>        getNetworkInstrumentor().incrementCancelManualQuoteSent(1);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="86">2900</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">2901</TD><TD> </TD></TR><TR><TD CLASS="l">2902</TD><TD>    private void validateRoutedMessage(final long p_requestId) throws NotAcceptedException</TD></TR><TR><TD CLASS="l">2903</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2904</TD><TD>        if (p_requestId &gt; 0)</TD></TR><TR><TD CLASS="l">2905</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2906</TD><TD>            RoutedMessage aMsg = routedMessageHome.findByMessageIdentifier(p_requestId);</TD></TR><TR CLASS="z"><TD CLASS="l">2907</TD><TD>            if ((aMsg == null) || (aMsg.isProcessed()))  {</TD></TR><TR CLASS="z"><TD CLASS="l">2908</TD><TD>                throw ExceptionBuilder.notAcceptedException(MsgBuilder.get()</TD></TR><TR CLASS="z"><TD CLASS="l">2909</TD><TD>                        .add(&#34;Specified cancel request message does not exist. &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2910</TD><TD>                        .add(&#34;Cancel request message id&#34;, p_requestId).end(), NotAcceptedCodes.INVALID_REQUEST);</TD></TR><TR><TD CLASS="l">2911</TD><TD>            }</TD></TR><TR><TD CLASS="l">2912</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2913</TD><TD>    }</TD></TR><TR><TD CLASS="l">2914</TD><TD> </TD></TR><TR><TD CLASS="l">2915</TD><TD>    /**</TD></TR><TR><TD CLASS="l">2916</TD><TD>     * Checks to see if a user can access an Order.</TD></TR><TR><TD CLASS="l">2917</TD><TD>     *</TD></TR><TR><TD CLASS="l">2918</TD><TD>     * @param order order to be accessed</TD></TR><TR><TD CLASS="l">2919</TD><TD>     * @param p_userAccessing user trying to access information</TD></TR><TR><TD CLASS="l">2920</TD><TD>     * @return true if accessor has rights to order</TD></TR><TR><TD CLASS="l">2921</TD><TD>     * @throws AuthorizationException</TD></TR><TR><TD CLASS="l">2922</TD><TD>     * @throws SystemException</TD></TR><TR><TD CLASS="l">2923</TD><TD>     * @throws NotAcceptedException</TD></TR><TR><TD CLASS="l"><A NAME="82">2924</A></TD><TD>     * @throws NotAcceptedException</TD></TR><TR><TD CLASS="l">2925</TD><TD>     */</TD></TR><TR><TD CLASS="l">2926</TD><TD>    public boolean validateOMTCancelAuthority(Order p_order, String p_userId) throws AuthorizationException, SystemException, NotAcceptedException</TD></TR><TR><TD CLASS="l">2927</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">2928</TD><TD>        boolean userAuthorized = false;</TD></TR><TR CLASS="z"><TD CLASS="l">2929</TD><TD>        if (p_order.getLocation().equals(p_userId))</TD></TR><TR><TD CLASS="l">2930</TD><TD>        {</TD></TR><TR><TD CLASS="l">2931</TD><TD>            // Can always access your own orders, if there is no pending</TD></TR><TR><TD CLASS="l">2932</TD><TD>            // cancel or cancel-replace request on that order.</TD></TR><TR CLASS="z"><TD CLASS="l">2933</TD><TD>            RoutedMessage[] pendingCxl = routedMessageHome.findCurrentByOrderAndMessageType(RoutedMessageType.CANCEL_REQUEST,</TD></TR><TR CLASS="z"><TD CLASS="l">2934</TD><TD>                    p_order.getUniqueId());</TD></TR><TR CLASS="z"><TD CLASS="l">2935</TD><TD>            if (pendingCxl.length == 0)</TD></TR><TR><TD CLASS="l">2936</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2937</TD><TD>                RoutedMessage[] pendingCxlRe = routedMessageHome.findCurrentByOrderAndMessageType(RoutedMessageType.CANCEL_REPLACE_REQUEST,</TD></TR><TR CLASS="z"><TD CLASS="l">2938</TD><TD>                        p_order.getUniqueId());</TD></TR><TR CLASS="z"><TD CLASS="l">2939</TD><TD>                if (pendingCxlRe.length == 0)</TD></TR><TR><TD CLASS="l">2940</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2941</TD><TD>                    userAuthorized = true;</TD></TR><TR><TD CLASS="l">2942</TD><TD>                }</TD></TR><TR><TD CLASS="l">2943</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2944</TD><TD>            if (!userAuthorized)  {</TD></TR><TR CLASS="z"><TD CLASS="l">2945</TD><TD>                throw ExceptionBuilder.notAcceptedException(MsgBuilder.get()</TD></TR><TR CLASS="z"><TD CLASS="l">2946</TD><TD>                        .add(&#34;Unable to accept cancel while order has pending cancel/cancel-replace.&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2947</TD><TD>                        .end(), NotAcceptedCodes.PENDING_CANCEL);</TD></TR><TR><TD CLASS="l">2948</TD><TD>            }</TD></TR><TR><TD CLASS="l">2949</TD><TD>        }</TD></TR><TR><TD CLASS="l">2950</TD><TD>        else</TD></TR><TR><TD CLASS="l">2951</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2952</TD><TD>            UserData user = null;</TD></TR><TR><TD CLASS="l">2953</TD><TD>            try</TD></TR><TR><TD CLASS="l">2954</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2955</TD><TD>                user = userDataCache.getUser(p_userId);</TD></TR><TR CLASS="z"><TD CLASS="l">2956</TD><TD>                if ((user.getRole() == UserRoles.HELP_DESK_OMT) ||</TD></TR><TR CLASS="z"><TD CLASS="l">2957</TD><TD>                    (user.getRole() == UserRoles.BOOTH_OMT) ||</TD></TR><TR CLASS="z"><TD CLASS="l">2958</TD><TD>                    (user.getRole() == UserRoles.CROWD_OMT))</TD></TR><TR><TD CLASS="l">2959</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2960</TD><TD>                    userAuthorized = true;</TD></TR><TR><TD CLASS="l">2961</TD><TD>                }</TD></TR><TR><TD CLASS="l">2962</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2963</TD><TD>            catch (NotFoundException e)</TD></TR><TR><TD CLASS="l">2964</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2965</TD><TD>                throw ExceptionBuilder.authorizationException(MsgBuilder.get()</TD></TR><TR CLASS="z"><TD CLASS="l">2966</TD><TD>                        .add(&#34;User not found.&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2967</TD><TD>                        .add(&#34;User Id = &#34;, p_userId).end(), AuthorizationCodes.AUTHENTICATION_ERROR);</TD></TR><TR><TD CLASS="l">2968</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2969</TD><TD>            catch (SystemException e)</TD></TR><TR><TD CLASS="l">2970</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2971</TD><TD>                throw ExceptionBuilder.systemException(MsgBuilder.get()</TD></TR><TR CLASS="z"><TD CLASS="l">2972</TD><TD>                        .add(&#34;System error while retrieving user data for authorization. &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2973</TD><TD>                        .add(&#34;User Id = &#34;, p_userId)</TD></TR><TR CLASS="z"><TD CLASS="l">2974</TD><TD>                        .add(&#34;System exception message&#34;, e.getMessage()).end(), 0);</TD></TR><TR><TD CLASS="l">2975</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">2976</TD><TD>            if (!userAuthorized)</TD></TR><TR><TD CLASS="l">2977</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2978</TD><TD>                throw ExceptionBuilder.authorizationException(MsgBuilder.get()</TD></TR><TR CLASS="z"><TD CLASS="l">2979</TD><TD>                        .add(&#34;User is not authorized.&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">2980</TD><TD>                        .add(&#34;User Id = &#34;, p_userId).end(), AuthorizationCodes.AUTHENTICATION_ERROR);</TD></TR><TR><TD CLASS="l">2981</TD><TD>            }</TD></TR><TR><TD CLASS="l">2982</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">2983</TD><TD>        return userAuthorized;</TD></TR><TR><TD CLASS="l">2984</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="85">2985</A></TD><TD> </TD></TR><TR><TD CLASS="l">2986</TD><TD>    public void validateRatio(final Order p_order) throws DataValidationException</TD></TR><TR><TD CLASS="l">2987</TD><TD>    {</TD></TR><TR><TD CLASS="l">2988</TD><TD>        // Confirm that order is in ratio match, if it is a strategy order.</TD></TR><TR CLASS="z"><TD CLASS="l">2989</TD><TD>        boolean ratioMismatch = false;</TD></TR><TR CLASS="z"><TD CLASS="l">2990</TD><TD>        if (p_order.isStrategy())</TD></TR><TR><TD CLASS="l">2991</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">2992</TD><TD>            LegOrderDetail[] legs = p_order.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">2993</TD><TD>            for (int i=0; i &lt;legs.length; i++)</TD></TR><TR><TD CLASS="l">2994</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">2995</TD><TD>                int legRatio = legs[i].getOriginalQuantity() / p_order.getOriginalQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">2996</TD><TD>                int outOfBalanceLegTradedQty = legs[i].getTradedQuantity() - legRatio * p_order.getTradedQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">2997</TD><TD>                if (outOfBalanceLegTradedQty != 0)</TD></TR><TR><TD CLASS="l">2998</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">2999</TD><TD>                    ratioMismatch = true;</TD></TR><TR CLASS="z"><TD CLASS="l">3000</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">3001</TD><TD>                }</TD></TR><TR><TD CLASS="l">3002</TD><TD>            }</TD></TR><TR><TD CLASS="l">3003</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3004</TD><TD>        if (ratioMismatch)</TD></TR><TR><TD CLASS="l">3005</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3006</TD><TD>            throw ExceptionBuilder.dataValidationException(msg().add(&#34;Strategy order &#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3007</TD><TD>                    p_order.getOrderIdString()).add(&#34; has leg ratio mismatch.&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3008</TD><TD>                    .end(), DataValidationCodes.INVALID_QUANTITY);</TD></TR><TR><TD CLASS="l">3009</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3010</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="7f">3011</A></TD><TD> </TD></TR><TR><TD CLASS="l">3012</TD><TD>    private void validateCancellableOrder(final Order p_order) throws NotAcceptedException, DataValidationException</TD></TR><TR><TD CLASS="l">3013</TD><TD>    {</TD></TR><TR><TD CLASS="l">3014</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3015</TD><TD>        if ((p_order.getRemainingQuantity() == 0) || (p_order.getState() == OrderStates.CANCEL))</TD></TR><TR><TD CLASS="l">3016</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3017</TD><TD>            log.client(msg().add(&#34;Order &#34;, p_order.getOrderId()).add(&#34; already filled or canceled&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">3018</TD><TD>            throw ExceptionBuilder.dataValidationException(msg().add(&#34;Order&#34;, p_order.getOrderId())</TD></TR><TR CLASS="z"><TD CLASS="l">3019</TD><TD>                    .add(&#34;already filled or canceled&#34;).end(), DataValidationCodes.INVALID_QUANTITY);</TD></TR><TR><TD CLASS="l">3020</TD><TD>        }</TD></TR><TR><TD CLASS="l">3021</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3022</TD><TD>        if (p_order.isStrategy())</TD></TR><TR><TD CLASS="l">3023</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3024</TD><TD>            LegOrderDetail[] legs = p_order.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">3025</TD><TD>            for (LegOrderDetail aLeg : legs) </TD></TR><TR><TD CLASS="l">3026</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3027</TD><TD>                if (aLeg.getLeavesQuantity() == 0)  </TD></TR><TR><TD CLASS="l">3028</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3029</TD><TD>                    log.client(msg().add(&#34;Strategy order &#34;, p_order.getOrderId())</TD></TR><TR CLASS="z"><TD CLASS="l">3030</TD><TD>                            .add(&#34; has ratio mismatch with no cancellable quantity remaining.&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">3031</TD><TD>                    throw ExceptionBuilder.dataValidationException(msg().add(&#34;Strategy order &#34;, p_order.getOrderId())</TD></TR><TR CLASS="z"><TD CLASS="l">3032</TD><TD>                            .add(&#34; has ratio mismatch with no cancellable quantity remaining.&#34;).end(), DataValidationCodes.INVALID_QUANTITY);</TD></TR><TR><TD CLASS="l">3033</TD><TD>                }</TD></TR><TR><TD CLASS="l">3034</TD><TD>            }</TD></TR><TR><TD CLASS="l">3035</TD><TD>        }</TD></TR><TR><TD CLASS="l">3036</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3037</TD><TD>        if(p_order.getSource() == Sources.SBT &amp;&amp; p_order.isLinkageOrder())</TD></TR><TR><TD CLASS="l">3038</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3039</TD><TD>            MsgBuilder msg = msg().add(&#34;Can not Cancel Linkage outbound Orders&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3040</TD><TD>                                  .add(&#34;orderId&#34;, p_order.getOrderId());</TD></TR><TR CLASS="z"><TD CLASS="l">3041</TD><TD>            log.info(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">3042</TD><TD>            throw ExceptionBuilder.notAcceptedException(msg.end(), NotAcceptedCodes.INVALID_REQUEST);</TD></TR><TR><TD CLASS="l">3043</TD><TD>        }</TD></TR><TR><TD CLASS="l">3044</TD><TD> </TD></TR><TR><TD CLASS="l">3045</TD><TD>        // If Order is Linkage Order, only PA and S orders may be cancelled.</TD></TR><TR><TD CLASS="l">3046</TD><TD>        // Cancel requests for Principal orders are not allowed.</TD></TR><TR CLASS="z"><TD CLASS="l">3047</TD><TD>         if ((p_order.getOrderOriginType() == OrderOrigins.PRINCIPAL) &amp;&amp; (p_order.getSource() != Sources.ITS))</TD></TR><TR><TD CLASS="l">3048</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3049</TD><TD>            log.client(msg().add(&#34;Cancel for P order is not supported.&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3050</TD><TD>                    .add(&#34;orderId&#34;, p_order.getOrderId()));</TD></TR><TR CLASS="z"><TD CLASS="l">3051</TD><TD>            throw ExceptionBuilder.notAcceptedException(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">3052</TD><TD>                    &#34;Cancel for P order is not supported.&#34;).add(&#34;orderId&#34;, p_order.getOrderId())</TD></TR><TR CLASS="z"><TD CLASS="l">3053</TD><TD>                    .end(), NotAcceptedCodes.INVALID_REQUEST);</TD></TR><TR><TD CLASS="l">3054</TD><TD>        }</TD></TR><TR><TD CLASS="l">3055</TD><TD> </TD></TR><TR><TD CLASS="l">3056</TD><TD>         // If Firm Order throw an exception</TD></TR><TR CLASS="z"><TD CLASS="l">3057</TD><TD>         if (p_order.isFirmMatchOrder())</TD></TR><TR><TD CLASS="l">3058</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">3059</TD><TD>             log.client(msg().add(&#34;Cancel Request for Match Side of Internalized Orders are not allowed.&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3060</TD><TD>                     .add(&#34;orderId&#34;, p_order.getOrderId()));</TD></TR><TR CLASS="z"><TD CLASS="l">3061</TD><TD>             throw ExceptionBuilder.notAcceptedException(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">3062</TD><TD>                     &#34;Cancel Request for Match Side of Internalized Orders are not allowed.&#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3063</TD><TD>                     &#34;orderId&#34;, p_order.getOrderId()).end(), NotAcceptedCodes.INVALID_REQUEST);</TD></TR><TR><TD CLASS="l">3064</TD><TD>         }</TD></TR><TR><TD CLASS="l">3065</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="7e">3066</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3067</TD><TD> </TD></TR><TR><TD CLASS="l">3068</TD><TD>    private void validateCancelRequestQuantity(final CancelRequestStruct cancelRequest) throws DataValidationException</TD></TR><TR><TD CLASS="l">3069</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3070</TD><TD>        final int quantity = cancelRequest.quantity;</TD></TR><TR CLASS="z"><TD CLASS="l">3071</TD><TD>        final int cancelType = cancelRequest.cancelType;</TD></TR><TR CLASS="z"><TD CLASS="l">3072</TD><TD>        if (!(cancelType == OrderCancelTypes.CANCEL_ALL_QUANTITY ||</TD></TR><TR CLASS="z"><TD CLASS="l">3073</TD><TD>              cancelType == OrderCancelTypes.DESIRED_CANCEL_QUANTITY ||</TD></TR><TR CLASS="z"><TD CLASS="l">3074</TD><TD>              cancelType == OrderCancelTypes.DESIRED_REMAINING_QUANTITY))</TD></TR><TR><TD CLASS="l">3075</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3076</TD><TD>            log.client(</TD></TR><TR CLASS="z"><TD CLASS="l">3077</TD><TD>                    msg().add(&#34;Order&#34;).add(cancelRequest.orderId).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3078</TD><TD>                            &#34;Invalid Cancel Request Type &#34;).add(cancelType).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3079</TD><TD>                            &#34;CancelType must be one of these &#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3080</TD><TD>                            OrderCancelTypes.CANCEL_ALL_QUANTITY).add(&#34;,&#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3081</TD><TD>                            OrderCancelTypes.DESIRED_CANCEL_QUANTITY).add(&#34;,&#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3082</TD><TD>                            OrderCancelTypes.DESIRED_REMAINING_QUANTITY));</TD></TR><TR><TD CLASS="l">3083</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3084</TD><TD>            throw ExceptionBuilder.dataValidationException(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">3085</TD><TD>                    &#34;Invalid cancel type in request: &#34;).add(&#34;cancelType&#34;, cancelType).end(),</TD></TR><TR CLASS="z"><TD CLASS="l">3086</TD><TD>                    DataValidationCodes.INVALID_CANCEL_REQUEST);</TD></TR><TR><TD CLASS="l">3087</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3088</TD><TD>        if (quantity &lt; 0</TD></TR><TR CLASS="z"><TD CLASS="l">3089</TD><TD>            || (cancelType == OrderCancelTypes.DESIRED_CANCEL_QUANTITY &amp;&amp; quantity == 0))</TD></TR><TR><TD CLASS="l">3090</TD><TD>        {</TD></TR><TR><TD CLASS="l">3091</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3092</TD><TD>            log.client(</TD></TR><TR CLASS="z"><TD CLASS="l">3093</TD><TD>                    msg().add(&#34;Cannot cancel order. Specified&#34;).add(&#34;quantity&#34;, quantity)</TD></TR><TR CLASS="z"><TD CLASS="l">3094</TD><TD>                            .add(&#34;and&#34;).add(&#34;cancelType&#34;, cancelType).add(&#34; are not correct&#34;));</TD></TR><TR><TD CLASS="l">3095</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3096</TD><TD>            throw ExceptionBuilder.dataValidationException(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">3097</TD><TD>                    &#34;Cannot cancel order. Specified&#34;).add(&#34;quantity&#34;, quantity).add(&#34;and&#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3098</TD><TD>                    &#34;cancelType&#34;, cancelType).add(&#34; are not correct&#34;).end(),</TD></TR><TR CLASS="z"><TD CLASS="l">3099</TD><TD>                    DataValidationCodes.INVALID_QUANTITY);</TD></TR><TR><TD CLASS="l">3100</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3101</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="81">3102</A></TD><TD> </TD></TR><TR><TD CLASS="l">3103</TD><TD>   private boolean validateManualCancelFromOMT(final Order p_order, final CancelRequestStruct p_cancelRequest,</TD></TR><TR><TD CLASS="l">3104</TD><TD>           final long p_cancelReqId, final String p_location) throws DataValidationException, NotAcceptedException, SystemException, AuthorizationException, NotFoundException</TD></TR><TR><TD CLASS="l">3105</TD><TD>   {</TD></TR><TR CLASS="z"><TD CLASS="l">3106</TD><TD>       boolean validCancel = true;</TD></TR><TR CLASS="z"><TD CLASS="l">3107</TD><TD>       validateCancellableOrder(p_order);</TD></TR><TR CLASS="z"><TD CLASS="l">3108</TD><TD>       validateCancelRequestQuantity(p_cancelRequest);</TD></TR><TR CLASS="z"><TD CLASS="l">3109</TD><TD>       validateRoutedMessage(p_cancelReqId);</TD></TR><TR CLASS="z"><TD CLASS="l">3110</TD><TD>       cxlRepValidator.validateProductState(p_cancelRequest.sessionName, p_order.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">3111</TD><TD>       cxlRepValidator.validateCancelContingency(p_cancelRequest.quantity, p_order);</TD></TR><TR CLASS="z"><TD CLASS="l">3112</TD><TD>       validateOMTCancelAuthority(p_order, p_location);</TD></TR><TR CLASS="z"><TD CLASS="l">3113</TD><TD>       return validCancel;</TD></TR><TR><TD CLASS="l">3114</TD><TD>   }</TD></TR><TR><TD CLASS="l"><A NAME="84">3115</A></TD><TD> </TD></TR><TR><TD CLASS="l">3116</TD><TD> </TD></TR><TR><TD CLASS="l">3117</TD><TD>   private void validateOrderMaintenanceId(final Order p_cxlOrder, final CancelRequestStruct p_cancelRequest, final long cancelReqId, final String p_location) throws NotFoundException, NotAcceptedException, SystemException</TD></TR><TR><TD CLASS="l">3118</TD><TD>   {</TD></TR><TR CLASS="z"><TD CLASS="l">3119</TD><TD>       if (cancelReqId &gt; 0)</TD></TR><TR><TD CLASS="l">3120</TD><TD>       {</TD></TR><TR CLASS="z"><TD CLASS="l">3121</TD><TD>           RoutedMessage aMsg = routedMessageHome.findByMessageIdentifier(cancelReqId);</TD></TR><TR CLASS="z"><TD CLASS="l">3122</TD><TD>           if (aMsg == null)  {</TD></TR><TR CLASS="z"><TD CLASS="l">3123</TD><TD>               throw ExceptionBuilder.notAcceptedException(MsgBuilder.get()</TD></TR><TR CLASS="z"><TD CLASS="l">3124</TD><TD>                       .add(&#34;Specified cancel request message does not exist. &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3125</TD><TD>                       .add(&#34;Cancel request message id&#34;, cancelReqId).end(), NotAcceptedCodes.INVALID_REQUEST);</TD></TR><TR><TD CLASS="l">3126</TD><TD>           }</TD></TR><TR><TD CLASS="l">3127</TD><TD>       }</TD></TR><TR><TD CLASS="l">3128</TD><TD>       else {</TD></TR><TR CLASS="z"><TD CLASS="l">3129</TD><TD>           boolean pendingReqFound = false;</TD></TR><TR CLASS="z"><TD CLASS="l">3130</TD><TD>           RoutedMessage[] cxlRequests = routedMessageHome.findAllByLocationAndMessageType(RoutedMessageType.CANCEL_REQUEST, p_location);</TD></TR><TR CLASS="z"><TD CLASS="l">3131</TD><TD>           RoutedMessage[] cxlReRequests = routedMessageHome.findAllByLocationAndMessageType(RoutedMessageType.CANCEL_REPLACE_REQUEST, p_location);</TD></TR><TR><TD CLASS="l">3132</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3133</TD><TD>           if (cxlRequests.length &gt; 0)  {</TD></TR><TR CLASS="z"><TD CLASS="l">3134</TD><TD>               for (RoutedMessage routedMessage : cxlRequests)  {</TD></TR><TR><TD CLASS="l">3135</TD><TD>                   try</TD></TR><TR><TD CLASS="l">3136</TD><TD>                   {</TD></TR><TR><TD CLASS="l">3137</TD><TD>                       OrderIdStruct cxlOrderId;</TD></TR><TR CLASS="z"><TD CLASS="l">3138</TD><TD>                       cxlOrderId = routedMessage.getCancelRequestData().orderId;</TD></TR><TR CLASS="z"><TD CLASS="l">3139</TD><TD>                       CboeIdStruct cboeLongIdValue = new CboeIdStruct(cxlOrderId.highCboeId, cxlOrderId.lowCboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">3140</TD><TD>                       long cxlOrderDbId = CboeId.longValue(cboeLongIdValue);</TD></TR><TR CLASS="z"><TD CLASS="l">3141</TD><TD>                       if (cxlOrderDbId == p_cxlOrder.getUniqueId())  {</TD></TR><TR CLASS="z"><TD CLASS="l">3142</TD><TD>                           pendingReqFound = true;</TD></TR><TR CLASS="z"><TD CLASS="l">3143</TD><TD>                           break;</TD></TR><TR><TD CLASS="l">3144</TD><TD>                       }</TD></TR><TR><TD CLASS="l">3145</TD><TD>                   }</TD></TR><TR CLASS="z"><TD CLASS="l">3146</TD><TD>                   catch (TransactionFailedException e)</TD></TR><TR><TD CLASS="l">3147</TD><TD>                   {</TD></TR><TR CLASS="z"><TD CLASS="l">3148</TD><TD>                       log().alarm(MsgBuilder.get().add(&#34;Transaction exception while reading routed cancel request message. &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3149</TD><TD>                               .add(&#34;Routed message id = &#34;).add(routedMessage.getIdentifier()).add(e));</TD></TR><TR><TD CLASS="l">3150</TD><TD>                   }</TD></TR><TR><TD CLASS="l">3151</TD><TD>               }</TD></TR><TR><TD CLASS="l">3152</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">3153</TD><TD>           if (!pendingReqFound)  {</TD></TR><TR CLASS="z"><TD CLASS="l">3154</TD><TD>               if (cxlReRequests.length &gt; 0)  {</TD></TR><TR CLASS="z"><TD CLASS="l">3155</TD><TD>                   for (RoutedMessage routedMessage : cxlReRequests)  {</TD></TR><TR><TD CLASS="l">3156</TD><TD>                       try</TD></TR><TR><TD CLASS="l">3157</TD><TD>                       {</TD></TR><TR><TD CLASS="l">3158</TD><TD>                           OrderIdStruct cxlOrderId;</TD></TR><TR CLASS="z"><TD CLASS="l">3159</TD><TD>                           cxlOrderId = routedMessage.getCancelRequestData().orderId;</TD></TR><TR CLASS="z"><TD CLASS="l">3160</TD><TD>                           CboeIdStruct cboeLongIdValue = new CboeIdStruct(cxlOrderId.highCboeId, cxlOrderId.lowCboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">3161</TD><TD>                           long cxlOrderDbId = CboeId.longValue(cboeLongIdValue);</TD></TR><TR CLASS="z"><TD CLASS="l">3162</TD><TD>                           if (cxlOrderDbId == p_cxlOrder.getUniqueId())  {</TD></TR><TR CLASS="z"><TD CLASS="l">3163</TD><TD>                               pendingReqFound = true;</TD></TR><TR CLASS="z"><TD CLASS="l">3164</TD><TD>                               break;</TD></TR><TR><TD CLASS="l">3165</TD><TD>                           }</TD></TR><TR><TD CLASS="l">3166</TD><TD>                       }</TD></TR><TR CLASS="z"><TD CLASS="l">3167</TD><TD>                       catch (TransactionFailedException e)</TD></TR><TR><TD CLASS="l">3168</TD><TD>                       {</TD></TR><TR CLASS="z"><TD CLASS="l">3169</TD><TD>                           log().alarm(MsgBuilder.get().add(&#34;Transaction exception while reading routed cancel-replace request message. &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3170</TD><TD>                                   .add(&#34;Routed message id = &#34;).add(routedMessage.getIdentifier()).add(e));</TD></TR><TR><TD CLASS="l">3171</TD><TD>                       }</TD></TR><TR><TD CLASS="l">3172</TD><TD>                   }</TD></TR><TR><TD CLASS="l">3173</TD><TD>               }</TD></TR><TR><TD CLASS="l">3174</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">3175</TD><TD>           if (pendingReqFound)  {</TD></TR><TR CLASS="z"><TD CLASS="l">3176</TD><TD>               throw ExceptionBuilder.notAcceptedException(MsgBuilder.get()</TD></TR><TR CLASS="z"><TD CLASS="l">3177</TD><TD>                       .add(&#34;A pending cancel or cancel-replace operation exists on this order.&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3178</TD><TD>                       .add(&#34;Order ID: &#34;, p_cxlOrder.getOrderIdString()).end(), NotAcceptedCodes.INVALID_REQUEST);</TD></TR><TR><TD CLASS="l">3179</TD><TD>           }</TD></TR><TR><TD CLASS="l">3180</TD><TD>       }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="26">3181</A></TD><TD>   }</TD></TR><TR><TD CLASS="l">3182</TD><TD> </TD></TR><TR><TD CLASS="l">3183</TD><TD>   private short findLocationType(String p_location)</TD></TR><TR><TD CLASS="l">3184</TD><TD>   {</TD></TR><TR CLASS="z"><TD CLASS="l">3185</TD><TD>       UserData user = null;</TD></TR><TR CLASS="z"><TD CLASS="l">3186</TD><TD>       OrderLocation locType = OrderLocation.UNSPECIFIED;</TD></TR><TR><TD CLASS="l">3187</TD><TD>       try</TD></TR><TR><TD CLASS="l">3188</TD><TD>       {</TD></TR><TR CLASS="z"><TD CLASS="l">3189</TD><TD>           user = userDataCache.getUser(p_location);</TD></TR><TR CLASS="z"><TD CLASS="l">3190</TD><TD>           if (user.getRole() == UserRoles.BOOTH_OMT)  {</TD></TR><TR CLASS="z"><TD CLASS="l">3191</TD><TD>               locType = OrderLocation.BOOTH;</TD></TR><TR><TD CLASS="l">3192</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">3193</TD><TD>           else if (user.getRole() == UserRoles.HELP_DESK_OMT)  {</TD></TR><TR CLASS="z"><TD CLASS="l">3194</TD><TD>               locType = OrderLocation.HELP_DESK;</TD></TR><TR><TD CLASS="l">3195</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">3196</TD><TD>           else if (user.getRole() == UserRoles.CROWD_OMT)  {</TD></TR><TR CLASS="z"><TD CLASS="l">3197</TD><TD>               locType = OrderLocation.CROWD;</TD></TR><TR><TD CLASS="l">3198</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">3199</TD><TD>           else if (user.getRole() == UserRoles.DISPLAY_OMT)  {</TD></TR><TR CLASS="z"><TD CLASS="l">3200</TD><TD>               locType = OrderLocation.DISPLAY;</TD></TR><TR><TD CLASS="l">3201</TD><TD>           }</TD></TR><TR><TD CLASS="l">3202</TD><TD>       }</TD></TR><TR CLASS="z"><TD CLASS="l">3203</TD><TD>       catch (Exception e)</TD></TR><TR><TD CLASS="l">3204</TD><TD>       {</TD></TR><TR><TD CLASS="l">3205</TD><TD>           // Do nothing</TD></TR><TR><TD CLASS="l">3206</TD><TD>       }</TD></TR><TR CLASS="z"><TD CLASS="l">3207</TD><TD>       return locType.getOrderLocation();</TD></TR><TR><TD CLASS="l"><A NAME="5">3208</A></TD><TD>   }</TD></TR><TR><TD CLASS="l">3209</TD><TD> </TD></TR><TR><TD CLASS="l">3210</TD><TD>   public void acceptManualCancelFromOMT(CancelRequestStruct p_manualCancelRequestFromOMT, long p_cancelReqId, String p_userId) throws SystemException, CommunicationException, DataValidationException, NotFoundException, AuthorizationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">3211</TD><TD>   {</TD></TR><TR CLASS="z"><TD CLASS="l">3212</TD><TD>       log().info(msg().add(&#34;entering MOMDI.acceptManualCancelFromOMT &#34;));</TD></TR><TR><TD CLASS="l">3213</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3214</TD><TD>       getNetworkInstrumentor().incrementOmtManualCancelReceived(1);</TD></TR><TR><TD CLASS="l">3215</TD><TD> </TD></TR><TR><TD CLASS="l">3216</TD><TD>       // find the order</TD></TR><TR CLASS="z"><TD CLASS="l">3217</TD><TD>       final Order cxlOrder = findOrder(p_manualCancelRequestFromOMT.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3218</TD><TD>       if (cxlOrder == null)</TD></TR><TR><TD CLASS="l">3219</TD><TD>       {</TD></TR><TR CLASS="z"><TD CLASS="l">3220</TD><TD>           if (p_cancelReqId &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">3221</TD><TD>               routedMessageHome.markAsProcessedByMessageIdentifier(p_cancelReqId);</TD></TR><TR><TD CLASS="l">3222</TD><TD>           }</TD></TR><TR><TD CLASS="l">3223</TD><TD>           else {</TD></TR><TR CLASS="z"><TD CLASS="l">3224</TD><TD>               final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualCancelFromOMT, CancelReportStruct received Order not found for: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3225</TD><TD>               .add(&#34;OrderId&#34;, new OrderId(p_manualCancelRequestFromOMT.orderId).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">3226</TD><TD>               log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">3227</TD><TD>               throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">3228</TD><TD>           }</TD></TR><TR><TD CLASS="l">3229</TD><TD>       }</TD></TR><TR><TD CLASS="l">3230</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3231</TD><TD>       validateCancelOrCancelReplace(cxlOrder, p_userId, p_cancelReqId);</TD></TR><TR CLASS="z"><TD CLASS="l">3232</TD><TD>       if (cxlOrder.getLocation().equals(p_userId))</TD></TR><TR><TD CLASS="l">3233</TD><TD>       {</TD></TR><TR CLASS="z"><TD CLASS="l">3234</TD><TD>           validateRatio(cxlOrder);</TD></TR><TR><TD CLASS="l">3235</TD><TD>       }</TD></TR><TR CLASS="z"><TD CLASS="l">3236</TD><TD>       if (p_cancelReqId == 0)  {</TD></TR><TR><TD CLASS="l">3237</TD><TD>           // An OMT (owner or non-owner) is originating a cancel operation on the order.</TD></TR><TR><TD CLASS="l">3238</TD><TD>           // At the cancel operation origination, we must perform certain validatin</TD></TR><TR><TD CLASS="l">3239</TD><TD>           // to ensure the order is cancellable, and possibly generate a TLTC.</TD></TR><TR CLASS="z"><TD CLASS="l">3240</TD><TD>           if (!validateManualCancelFromOMT(cxlOrder, p_manualCancelRequestFromOMT, p_cancelReqId, p_userId))</TD></TR><TR><TD CLASS="l">3241</TD><TD>           {</TD></TR><TR CLASS="z"><TD CLASS="l">3242</TD><TD>               return;</TD></TR><TR><TD CLASS="l">3243</TD><TD>           }</TD></TR><TR><TD CLASS="l">3244</TD><TD>       }</TD></TR><TR><TD CLASS="l">3245</TD><TD>       else {</TD></TR><TR><TD CLASS="l">3246</TD><TD>           // An owner OMT is acknowledging a previously routed cancel request</TD></TR><TR><TD CLASS="l">3247</TD><TD>           // or a non-owner OMT is re-routing the cancel request to order owner.</TD></TR><TR CLASS="z"><TD CLASS="l">3248</TD><TD>           validateRoutedMessage(p_cancelReqId);</TD></TR><TR><TD CLASS="l">3249</TD><TD>       }</TD></TR><TR><TD CLASS="l">3250</TD><TD> </TD></TR><TR><TD CLASS="l">3251</TD><TD>       // Set the routing parameter struct. The source of this invocations is always</TD></TR><TR><TD CLASS="l">3252</TD><TD>       // an OMT where userId arguemtn accepted in the invocation is the name of the OMT.</TD></TR><TR><TD CLASS="l">3253</TD><TD>       // This cancel report is not routed anywhere after processing. So the detination</TD></TR><TR><TD CLASS="l">3254</TD><TD>       // attributes are empty.</TD></TR><TR CLASS="z"><TD CLASS="l">3255</TD><TD>       ProductKeysStruct productKeys = getProductData(cxlOrder.getProductKey()).getProductKeysStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">3256</TD><TD>       CancelContext context = new CancelContext(p_userId, p_manualCancelRequestFromOMT, productKeys);</TD></TR><TR CLASS="z"><TD CLASS="l">3257</TD><TD>       context.setOrder(cxlOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">3258</TD><TD>       context.setRoutedMessageId(p_cancelReqId);</TD></TR><TR CLASS="z"><TD CLASS="l">3259</TD><TD>       OrderRoutingParameterStruct routingParam = new OrderRoutingParameterStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">3260</TD><TD>       routingParam.source = p_userId;</TD></TR><TR CLASS="z"><TD CLASS="l">3261</TD><TD>       routingParam.sourceType = findLocationType(p_userId);</TD></TR><TR CLASS="z"><TD CLASS="l">3262</TD><TD>       routingParam.destinationType = OrderLocations.UNSPECIFIED;</TD></TR><TR CLASS="z"><TD CLASS="l">3263</TD><TD>       context.setRoutingParams(routingParam);</TD></TR><TR CLASS="z"><TD CLASS="l">3264</TD><TD>       context.setRouteDescription(&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">3265</TD><TD>       context.setRouteReason((short) 0);</TD></TR><TR CLASS="z"><TD CLASS="l">3266</TD><TD>       context.setTtIndicator(false);</TD></TR><TR CLASS="z"><TD CLASS="l">3267</TD><TD>       context.setRequestType(Enums.RequestTypeEnum.OMT_CANCEL);</TD></TR><TR CLASS="z"><TD CLASS="l">3268</TD><TD>       RerouteProperties reRerouteProperties = context.getReRouteProperties();</TD></TR><TR CLASS="z"><TD CLASS="l">3269</TD><TD>       reRerouteProperties.setFunction(Enums.RequestTypeEnum.CMI_CANCEL.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">3270</TD><TD>       IWorkflowStatelessExecutor&lt;CancelContext&gt; workflowExcecutor = null;</TD></TR><TR CLASS="z"><TD CLASS="l">3271</TD><TD>       if (cxlOrder.getLocation().equals(p_userId))  {</TD></TR><TR><TD CLASS="l">3272</TD><TD>           // An owner OMT is either originating a cancel operation</TD></TR><TR><TD CLASS="l">3273</TD><TD>           // or acknowledging a previously routed cancel request. In</TD></TR><TR><TD CLASS="l">3274</TD><TD>           // either case we proceed to perform the cancel operation.</TD></TR><TR CLASS="z"><TD CLASS="l">3275</TD><TD>           workflowExcecutor = this.cancelFromOwnerOMTWorkflow.getStatelessExecutor();</TD></TR><TR><TD CLASS="l">3276</TD><TD>       }</TD></TR><TR><TD CLASS="l">3277</TD><TD>       else {</TD></TR><TR><TD CLASS="l">3278</TD><TD>           // A non-owner OMT is originating the cancel operation.</TD></TR><TR><TD CLASS="l">3279</TD><TD>           // Chase the order and route the cancel request to the order owner.</TD></TR><TR CLASS="z"><TD CLASS="l">3280</TD><TD>           workflowExcecutor = this.cancelFromNonOwnerOMTWorkflow.getStatelessExecutor();</TD></TR><TR><TD CLASS="l">3281</TD><TD>       }</TD></TR><TR><TD CLASS="l">3282</TD><TD>       try</TD></TR><TR><TD CLASS="l">3283</TD><TD>       {</TD></TR><TR><TD CLASS="l">3284</TD><TD>           //context.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">3285</TD><TD>           workflowExcecutor.autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">3286</TD><TD>           if (context.getException() != null)</TD></TR><TR><TD CLASS="l">3287</TD><TD>           {</TD></TR><TR CLASS="z"><TD CLASS="l">3288</TD><TD>               maybeThrow(context);</TD></TR><TR CLASS="z"><TD CLASS="l">3289</TD><TD>               context.maybeThrowException(NotFoundException.class);</TD></TR><TR CLASS="z"><TD CLASS="l">3290</TD><TD>               context.maybeThrowException(NotAcceptedException.class);</TD></TR><TR><TD CLASS="l">3291</TD><TD>           }</TD></TR><TR><TD CLASS="l">3292</TD><TD>           else</TD></TR><TR><TD CLASS="l">3293</TD><TD>           {</TD></TR><TR CLASS="z"><TD CLASS="l">3294</TD><TD>               getNetworkInstrumentor().incrementOmtManualCancelSent(1);</TD></TR><TR><TD CLASS="l">3295</TD><TD>           }</TD></TR><TR><TD CLASS="l">3296</TD><TD> </TD></TR><TR><TD CLASS="l">3297</TD><TD>       }</TD></TR><TR CLASS="z"><TD CLASS="l">3298</TD><TD>       catch (TransactionFailedException e) {</TD></TR><TR><TD CLASS="l">3299</TD><TD>           // should be handled in the workflow: Defensive check</TD></TR><TR CLASS="z"><TD CLASS="l">3300</TD><TD>           log.alarm(msg().add(&#34;TransactionFailedException on acceptManualCancelReportFromOMT: &#34;).add(e));</TD></TR><TR><TD CLASS="l">3301</TD><TD>       }</TD></TR><TR CLASS="z"><TD CLASS="l">3302</TD><TD>       finally {</TD></TR><TR><TD CLASS="l">3303</TD><TD>           // if the context is corrupted, roll back the transaction using the Transaction</TD></TR><TR CLASS="z"><TD CLASS="l">3304</TD><TD>           if (Transaction.inTransaction()) {</TD></TR><TR CLASS="z"><TD CLASS="l">3305</TD><TD>               log.alarm(msg().add( &#34;Rolling back transaction in acceptManualCancelReportFromOMT &#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">3306</TD><TD>               Transaction.rollback();</TD></TR><TR><TD CLASS="l">3307</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">3308</TD><TD>       }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="7a">3309</A></TD><TD>   }</TD></TR><TR><TD CLASS="l">3310</TD><TD> </TD></TR><TR><TD CLASS="l">3311</TD><TD>    private void validateCancelOrCancelReplace(Order theOrder, String userId, long requestId) throws AuthorizationException</TD></TR><TR><TD CLASS="l">3312</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3313</TD><TD>        if (!accessHelper.hasPermissionToOrder(theOrder, userId) &amp;&amp; requestId == 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">3314</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualCancelFromOMT, the user does not have permission to cance or cancel/replace the order: &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3315</TD><TD>            .add(&#34;OrderId&#34;, theOrder.getStruct().toString());</TD></TR><TR CLASS="z"><TD CLASS="l">3316</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">3317</TD><TD>            throw ExceptionBuilder.authorizationException(msg.end(), AuthorizationCodes.NOT_PERMITTED);</TD></TR><TR><TD CLASS="l">3318</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3319</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="6">3320</A></TD><TD>    </TD></TR><TR><TD CLASS="l">3321</TD><TD>    public OrderIdStruct acceptManualCancelReplaceFromOMT(CancelRequestStruct cancelRequest, long cancelReqId, OrderStruct p_order, String userId) throws SystemException, CommunicationException, DataValidationException, NotFoundException, AuthorizationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">3322</TD><TD>    {</TD></TR><TR><TD CLASS="l">3323</TD><TD>        Order replacedOrder;</TD></TR><TR CLASS="z"><TD CLASS="l">3324</TD><TD>        getNetworkInstrumentor().incrementOmtManualCancelReplaceReceived(1);</TD></TR><TR><TD CLASS="l">3325</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3326</TD><TD>        LegOrderEntryStructV2[] legEntries = null;</TD></TR><TR CLASS="z"><TD CLASS="l">3327</TD><TD>        if (p_order.productType == ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">3328</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3329</TD><TD>            boolean shortSaleMarking = retrieveShortSaleMarkingFirmProperty(p_order);</TD></TR><TR CLASS="z"><TD CLASS="l">3330</TD><TD>            if (shortSaleMarking) </TD></TR><TR><TD CLASS="l">3331</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3332</TD><TD>                legEntries = createNewLegEntries(p_order);</TD></TR><TR><TD CLASS="l">3333</TD><TD>            } </TD></TR><TR><TD CLASS="l">3334</TD><TD>            else </TD></TR><TR><TD CLASS="l">3335</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3336</TD><TD>                legEntries = createLegEntries(p_order);</TD></TR><TR><TD CLASS="l">3337</TD><TD>            }    </TD></TR><TR><TD CLASS="l">3338</TD><TD>        }</TD></TR><TR><TD CLASS="l">3339</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3340</TD><TD>        final Order originalOrder = findOrder(cancelRequest.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3341</TD><TD>        if (originalOrder == null)</TD></TR><TR><TD CLASS="l">3342</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3343</TD><TD>            final MsgBuilder msg = msg().add(&#34;MOMDI.acceptManualCancelReplaceFromOMT, Original order not found. &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3344</TD><TD>            .add(&#34;OrderId&#34;, new OrderId(cancelRequest.orderId).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">3345</TD><TD>            log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">3346</TD><TD>            throw ExceptionBuilder.notFoundException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">3347</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3348</TD><TD>        if (originalOrder.getLocation().equals(userId))</TD></TR><TR><TD CLASS="l">3349</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3350</TD><TD>            validateRatio(originalOrder);</TD></TR><TR><TD CLASS="l">3351</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3352</TD><TD>        validateCancelOrCancelReplace(originalOrder, userId, cancelReqId);</TD></TR><TR CLASS="z"><TD CLASS="l">3353</TD><TD>        if (cancelReqId == 0)  </TD></TR><TR><TD CLASS="l">3354</TD><TD>        {</TD></TR><TR><TD CLASS="l">3355</TD><TD>            // An OMT (owner or non-owner) is originating a cancel-replace operation on the order.</TD></TR><TR><TD CLASS="l">3356</TD><TD>            // At the cancel-replace operation origination, we must perform certain validatin</TD></TR><TR><TD CLASS="l">3357</TD><TD>            // to ensure the order is replaceable.</TD></TR><TR CLASS="z"><TD CLASS="l">3358</TD><TD>            validateCancelReplace(cancelRequest,  p_order, legEntries, cancelRequest.orderId, userId);        </TD></TR><TR><TD CLASS="l">3359</TD><TD>        }     </TD></TR><TR><TD CLASS="l">3360</TD><TD>        else </TD></TR><TR><TD CLASS="l">3361</TD><TD>        {</TD></TR><TR><TD CLASS="l">3362</TD><TD>            // An owner OMT is acknowledging a previously routed cancel-replace request</TD></TR><TR><TD CLASS="l">3363</TD><TD>            // or a non-owner OMT is re-routing the cancel-replace request to order owner.</TD></TR><TR CLASS="z"><TD CLASS="l">3364</TD><TD>            validateRoutedMessage(cancelReqId);</TD></TR><TR><TD CLASS="l">3365</TD><TD>        }</TD></TR><TR><TD CLASS="l">3366</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3367</TD><TD>        final CancelReplaceContext repOrderContext = new CancelReplaceContext();</TD></TR><TR CLASS="z"><TD CLASS="l">3368</TD><TD>        OrderRoutingParameterStruct routingParam = new OrderRoutingParameterStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">3369</TD><TD>        routingParam.source = userId;</TD></TR><TR CLASS="z"><TD CLASS="l">3370</TD><TD>        routingParam.sourceType = findLocationType(userId);</TD></TR><TR CLASS="z"><TD CLASS="l">3371</TD><TD>        routingParam.destinationType = OrderLocations.UNSPECIFIED;</TD></TR><TR CLASS="z"><TD CLASS="l">3372</TD><TD>        repOrderContext.setRoutingParams(routingParam);</TD></TR><TR CLASS="z"><TD CLASS="l">3373</TD><TD>        repOrderContext.setCancelRequest(cancelRequest);</TD></TR><TR CLASS="z"><TD CLASS="l">3374</TD><TD>        repOrderContext.setOrder(originalOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">3375</TD><TD>        repOrderContext.setUserId(userId);</TD></TR><TR CLASS="z"><TD CLASS="l">3376</TD><TD>        repOrderContext.setRoutedMessageId(cancelReqId);</TD></TR><TR CLASS="z"><TD CLASS="l">3377</TD><TD>        repOrderContext.setProductKeys(getProductData(originalOrder.getProductKey()).getProductKeysStruct());</TD></TR><TR CLASS="z"><TD CLASS="l">3378</TD><TD>        repOrderContext.setRequestType(Enums.RequestTypeEnum.OMT_CANCEL_RE);</TD></TR><TR CLASS="z"><TD CLASS="l">3379</TD><TD>        RerouteProperties reRerouteProperties = repOrderContext.getReRouteProperties();</TD></TR><TR CLASS="z"><TD CLASS="l">3380</TD><TD>        reRerouteProperties.setFunction(Enums.RequestTypeEnum.CMI_CANCEL_REPLACE.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">3381</TD><TD>        OrderHistoryCommonInfo orderHistoryCommonInfo=repOrderContext.getOrderHistoryCommonInfo</TD></TR><TR CLASS="z"><TD CLASS="l">3382</TD><TD>        (findLocationType(userId),p_order.userId,originalOrder.getProductKey());</TD></TR><TR><TD CLASS="l">3383</TD><TD>        try</TD></TR><TR><TD CLASS="l">3384</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3385</TD><TD>            repOrderContext.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">3386</TD><TD>            if(cancelReqId &gt; 0)</TD></TR><TR><TD CLASS="l">3387</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3388</TD><TD>               replacedOrder = findOrder(p_order.orderId);</TD></TR><TR><TD CLASS="l">3389</TD><TD>            }</TD></TR><TR><TD CLASS="l">3390</TD><TD>            else</TD></TR><TR><TD CLASS="l">3391</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3392</TD><TD>                replacedOrder = createNewOrder(p_order, legEntries, null, false);</TD></TR><TR><TD CLASS="l">3393</TD><TD>                // set the cancelledOrderId and ReplaceOrderIds</TD></TR><TR CLASS="z"><TD CLASS="l">3394</TD><TD>                CboeIdStruct oldId = new CboeIdStruct(originalOrder.getOrderId().highCboeId, originalOrder.getOrderId().lowCboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">3395</TD><TD>                CboeIdStruct newId = new CboeIdStruct(replacedOrder.getOrderId().highCboeId, replacedOrder.getOrderId().lowCboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">3396</TD><TD>                originalOrder.setReplacedOrderId(CboeId.longValue(newId)); // link to replaced order in the cancelled order.</TD></TR><TR CLASS="z"><TD CLASS="l">3397</TD><TD>                replacedOrder.setCancelledOrderId(CboeId.longValue(oldId)); // link to cancelled order in the replaced order.</TD></TR><TR CLASS="z"><TD CLASS="l">3398</TD><TD>                replacedOrder.setLocation(originalOrder.getLocation());</TD></TR><TR CLASS="z"><TD CLASS="l">3399</TD><TD>                replacedOrder.setLocationType(originalOrder.getLocationType());</TD></TR><TR><TD CLASS="l">3400</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">3401</TD><TD>            if (replacedOrder != null)</TD></TR><TR><TD CLASS="l">3402</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3403</TD><TD>                replacedOrder.setRelatedOrder(originalOrder);  //To store the original Order reference.</TD></TR><TR CLASS="z"><TD CLASS="l">3404</TD><TD>                originalOrder.setRelatedOrder(replacedOrder); // to store replcement order reference in original order.</TD></TR><TR CLASS="z"><TD CLASS="l">3405</TD><TD>                repOrderContext.setReplacementOrder(replacedOrder);</TD></TR><TR><TD CLASS="l">3406</TD><TD>                //PITS #57553 : Need to set the COA flag on the replaced order from OMT.</TD></TR><TR CLASS="z"><TD CLASS="l">3407</TD><TD>                setCOAEligibilityFlag(repOrderContext, replacedOrder);</TD></TR><TR><TD CLASS="l">3408</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3409</TD><TD>            orderHistoryCommonInfo.setRouteDescription(&#34;Order replaced by &#34; + originalOrder.getOrderIdString());</TD></TR><TR CLASS="z"><TD CLASS="l">3410</TD><TD>            orderHistoryCommonInfo.setRouteReason(OHSRoutingReasons.CANCEL_FOLLOW_ORDER);</TD></TR><TR><TD CLASS="l">3411</TD><TD>            // Set the order state to active, so that a order NEW is published with BOOKED state.</TD></TR><TR CLASS="z"><TD CLASS="l">3412</TD><TD>            if (replacedOrder != null)</TD></TR><TR><TD CLASS="l">3413</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3414</TD><TD>                repOrderContext.setReplacementOrder(replacedOrder);</TD></TR><TR><TD CLASS="l">3415</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3416</TD><TD>            if (log.isDebugOn())</TD></TR><TR><TD CLASS="l">3417</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3418</TD><TD>                log.debug(msg().add(&#34;replace order created, w/&#34;).add(&#34;orderId&#34;, p_order.orderId));</TD></TR><TR><TD CLASS="l">3419</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3420</TD><TD>            if (log.isDebugOn())</TD></TR><TR><TD CLASS="l">3421</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3422</TD><TD>                log.debug(msg().add(&#34;forward cx/re&#34;).add(&#34;orderId&#34;, cancelRequest.orderId)</TD></TR><TR CLASS="z"><TD CLASS="l">3423</TD><TD>                        .add(&#34; replace with&#34;).add(&#34;orderId&#34;, p_order.orderId).add(&#34;to the BrokerService&#34;));</TD></TR><TR><TD CLASS="l">3424</TD><TD>            }</TD></TR><TR><TD CLASS="l">3425</TD><TD>            // Execute the cancel/replace workflow:</TD></TR><TR CLASS="z"><TD CLASS="l">3426</TD><TD>            repOrderContext.setCancelRequest(cancelRequest);</TD></TR><TR CLASS="z"><TD CLASS="l">3427</TD><TD>            executeCxlReOrderWorkflow(repOrderContext);</TD></TR><TR CLASS="z"><TD CLASS="l">3428</TD><TD>            getNetworkInstrumentor().incrementOmtManualCancelReplaceSent(1);</TD></TR><TR><TD CLASS="l">3429</TD><TD>        }</TD></TR><TR><TD CLASS="l">3430</TD><TD>        finally</TD></TR><TR CLASS="z"><TD CLASS="l">3431</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3432</TD><TD>            if (Transaction.inTransaction())</TD></TR><TR><TD CLASS="l">3433</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3434</TD><TD>                Transaction.rollback();</TD></TR><TR CLASS="z"><TD CLASS="l">3435</TD><TD>                log.alarm(</TD></TR><TR CLASS="z"><TD CLASS="l">3436</TD><TD>                        msg().add(&#34;Rollback back cxl/re for &#34;).add(&#34;order&#34;, cancelRequest.orderId));</TD></TR><TR><TD CLASS="l">3437</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3438</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3439</TD><TD>        return replacedOrder.getOrderId();</TD></TR><TR><TD CLASS="l"><A NAME="62">3440</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3441</TD><TD> </TD></TR><TR><TD CLASS="l">3442</TD><TD>    private void setCOAEligibilityFlag(BaseOHSContext context, Order newOrder)</TD></TR><TR><TD CLASS="l">3443</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3444</TD><TD>        if (newOrder.getProductType() == ProductTypes.STRATEGY) {</TD></TR><TR CLASS="z"><TD CLASS="l">3445</TD><TD>            OrderIdStruct orderIdStruct = newOrder.getOrderId();</TD></TR><TR CLASS="z"><TD CLASS="l">3446</TD><TD>            String firmAcronym = orderIdStruct.executingOrGiveUpFirm.firmNumber;</TD></TR><TR CLASS="z"><TD CLASS="l">3447</TD><TD>            String exchangeAcronym =  orderIdStruct.executingOrGiveUpFirm.exchange;</TD></TR><TR CLASS="z"><TD CLASS="l">3448</TD><TD>            String sessionName = context.getSession();</TD></TR><TR><TD CLASS="l">3449</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">3450</TD><TD>            int classKeyForTheFirstOptionLegofTheStrategy = getOrderClassKey(newOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">3451</TD><TD>            int classKeyForTheTheStrategy = newOrder.getClassKey();</TD></TR><TR><TD CLASS="l">3452</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">3453</TD><TD>            char originCode = newOrder.getOrderOriginType();</TD></TR><TR><TD CLASS="l">3454</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">3455</TD><TD>            BasePropertyKey keyWithFirstOptionLegClass = RoutingPropertyKeyHelper.buildCOAEligibilityKey(sessionName,firmAcronym, exchangeAcronym,classKeyForTheFirstOptionLegofTheStrategy,originCode);</TD></TR><TR CLASS="z"><TD CLASS="l">3456</TD><TD>            BasePropertyKey keyWithStrategyClass = RoutingPropertyKeyHelper.buildCOAEligibilityKey(sessionName,firmAcronym, exchangeAcronym,classKeyForTheTheStrategy,originCode);</TD></TR><TR CLASS="z"><TD CLASS="l">3457</TD><TD>            Boolean isCoaEligible = getRoutingPropertyService().isCOAEligible(keyWithFirstOptionLegClass, keyWithStrategyClass);</TD></TR><TR CLASS="z"><TD CLASS="l">3458</TD><TD>            String stringifiedCoaEligible = &#34;N&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">3459</TD><TD>            if (isCoaEligible != null &amp;&amp; isCoaEligible) {</TD></TR><TR CLASS="z"><TD CLASS="l">3460</TD><TD>                stringifiedCoaEligible = &#34;Y&#34;;</TD></TR><TR><TD CLASS="l">3461</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3462</TD><TD>            newOrder.setCoaEligibiltyIndicator(stringifiedCoaEligible);</TD></TR><TR><TD CLASS="l">3463</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3464</TD><TD>    }</TD></TR><TR><TD CLASS="l">3465</TD><TD>    </TD></TR><TR><TD CLASS="l">3466</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3467</TD><TD>     * This method ensures that we get the first option leg's classkey.</TD></TR><TR><TD CLASS="l">3468</TD><TD>     * This is because the &#34;legs&#34; inherit the routing property of the underlying </TD></TR><TR><TD CLASS="l">3469</TD><TD>     * options class </TD></TR><TR><TD CLASS="l">3470</TD><TD>     * &lt;p&gt;</TD></TR><TR><TD CLASS="l">3471</TD><TD>     * Note:</TD></TR><TR><TD CLASS="l">3472</TD><TD>     * This has to be readdressed when we merge with cross products or</TD></TR><TR><TD CLASS="l">3473</TD><TD>     * when there is a necessity to set the routing property based on the complex class itself</TD></TR><TR><TD CLASS="l">3474</TD><TD>     * &lt;p&gt;</TD></TR><TR><TD CLASS="l">3475</TD><TD>     */</TD></TR><TR><TD CLASS="l">3476</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="33">3477</A></TD><TD>    private int getOrderClassKey(Order p_newOrder)</TD></TR><TR><TD CLASS="l">3478</TD><TD>    {</TD></TR><TR><TD CLASS="l">3479</TD><TD>        try</TD></TR><TR><TD CLASS="l">3480</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3481</TD><TD>            LegOrderDetail[] legs = p_newOrder.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">3482</TD><TD>            if(legs != null)</TD></TR><TR><TD CLASS="l">3483</TD><TD>            {</TD></TR><TR><TD CLASS="l">3484</TD><TD>                //Get the first option Product from the legs.</TD></TR><TR CLASS="z"><TD CLASS="l">3485</TD><TD>                for (LegOrderDetail detail : legs)</TD></TR><TR><TD CLASS="l">3486</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3487</TD><TD>                    ProductData prodData = getProductData(detail.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">3488</TD><TD>                    if(prodData.getProductType() == ProductTypes.OPTION)</TD></TR><TR><TD CLASS="l">3489</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">3490</TD><TD>                        return prodData.getClassKey();</TD></TR><TR><TD CLASS="l">3491</TD><TD>                    }</TD></TR><TR><TD CLASS="l">3492</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">3493</TD><TD>                log.info(MsgBuilder.get().add(&#34;Unable to find Option leg in complex Order Will use the Order classKey:&#34;).add(p_newOrder));               </TD></TR><TR><TD CLASS="l">3494</TD><TD>            }</TD></TR><TR><TD CLASS="l">3495</TD><TD>            else</TD></TR><TR><TD CLASS="l">3496</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3497</TD><TD>                log.alarm(MsgBuilder.get().add(&#34;There are no legs, unable to get the Class Key.&#34;).add(&#34;Order&#34;, p_newOrder));</TD></TR><TR><TD CLASS="l">3498</TD><TD>            }</TD></TR><TR><TD CLASS="l">3499</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3500</TD><TD>        catch(Exception dve)</TD></TR><TR><TD CLASS="l">3501</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3502</TD><TD>            log.alarm(MsgBuilder.get().add(&#34;Unable to get the Class Key.&#34;).add(&#34;Order&#34;, p_newOrder).add(dve));</TD></TR><TR><TD CLASS="l">3503</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3504</TD><TD>        return p_newOrder.getClassKey();</TD></TR><TR><TD CLASS="l"><A NAME="3e">3505</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3506</TD><TD>    </TD></TR><TR><TD CLASS="l">3507</TD><TD>    protected RoutingPropertyService getRoutingPropertyService()</TD></TR><TR><TD CLASS="l">3508</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3509</TD><TD>        if (routingPropertyService != null)</TD></TR><TR CLASS="z"><TD CLASS="l">3510</TD><TD>          return routingPropertyService;</TD></TR><TR><TD CLASS="l">3511</TD><TD> </TD></TR><TR><TD CLASS="l">3512</TD><TD>        try</TD></TR><TR><TD CLASS="l">3513</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3514</TD><TD>            RoutingPropertyServiceHome serviceHome = (RoutingPropertyServiceHome)HomeFactory.getInstance().findHome(RoutingPropertyServiceHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">3515</TD><TD>            routingPropertyService = serviceHome.find();</TD></TR><TR><TD CLASS="l">3516</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3517</TD><TD>        catch( CBOELoggableException e )</TD></TR><TR><TD CLASS="l">3518</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3519</TD><TD>            Log.exception(&#34;Failed to find FirmPropertyService&#34;, e);</TD></TR><TR><TD CLASS="l">3520</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3521</TD><TD>        return routingPropertyService;</TD></TR><TR><TD CLASS="l">3522</TD><TD>    }            </TD></TR><TR><TD CLASS="l">3523</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3524</TD><TD>     * Creates default strategy leg entry structs when they are not specified on the order.</TD></TR><TR><TD CLASS="l">3525</TD><TD>     *</TD></TR><TR><TD CLASS="l">3526</TD><TD>     * @throws SystemException</TD></TR><TR><TD CLASS="l">3527</TD><TD>     * @throws</TD></TR><TR><TD CLASS="l"><A NAME="1e">3528</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">3529</TD><TD>    private LegOrderEntryStructV2[] createLegEntries(final OrderStruct strategyOrder)</TD></TR><TR><TD CLASS="l">3530</TD><TD>            throws DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">3531</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3532</TD><TD>        final List&lt;ProductLegData&gt; strategyLegs = getStrategyLegs(strategyOrder.productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3533</TD><TD>        if (log.isDebugOn())</TD></TR><TR><TD CLASS="l">3534</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3535</TD><TD>            log.debug(</TD></TR><TR CLASS="z"><TD CLASS="l">3536</TD><TD>                    msg().add(&#34;Creating default legs for order&#34;).add(&#34;orderId&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">3537</TD><TD>                            strategyOrder.orderId).add(&#34;for&#34;).add(&#34;productKey&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">3538</TD><TD>                            strategyOrder.productKey));</TD></TR><TR><TD CLASS="l">3539</TD><TD>        }</TD></TR><TR><TD CLASS="l">3540</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3541</TD><TD>        final int len = strategyLegs.size();</TD></TR><TR CLASS="z"><TD CLASS="l">3542</TD><TD>        final LegOrderEntryStructV2[] legEntries = new LegOrderEntryStructV2[len];</TD></TR><TR CLASS="z"><TD CLASS="l">3543</TD><TD>        for (int i = 0; i &lt; len; i++)</TD></TR><TR><TD CLASS="l">3544</TD><TD>        {   </TD></TR><TR CLASS="z"><TD CLASS="l">3545</TD><TD>            legEntries[i] = new LegOrderEntryStructV2();</TD></TR><TR><TD CLASS="l">3546</TD><TD>            // in order to support buy/write, need to blindly get productKey from strategy impl...</TD></TR><TR CLASS="z"><TD CLASS="l">3547</TD><TD>            legEntries[i].legOrderEntry = new LegOrderEntryStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">3548</TD><TD>            legEntries[i].legOrderEntry.productKey = strategyLegs.get(i).getProductKey();</TD></TR><TR CLASS="z"><TD CLASS="l">3549</TD><TD>            legEntries[i].legOrderEntry.clearingFirm = strategyOrder.legOrderDetails[i].clearingFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">3550</TD><TD>            legEntries[i].legOrderEntry.coverage = strategyOrder.legOrderDetails[i].coverage;</TD></TR><TR CLASS="z"><TD CLASS="l">3551</TD><TD>            legEntries[i].legOrderEntry.mustUsePrice = strategyOrder.legOrderDetails[i].mustUsePrice;</TD></TR><TR CLASS="z"><TD CLASS="l">3552</TD><TD>            legEntries[i].legOrderEntry.positionEffect = strategyOrder.legOrderDetails[i].positionEffect;</TD></TR><TR><TD CLASS="l">3553</TD><TD>            </TD></TR><TR><TD CLASS="l">3554</TD><TD>            // fill the side from product definition</TD></TR><TR CLASS="z"><TD CLASS="l">3555</TD><TD>            legEntries[i].side = StrategyLegHelper.deriveStrategyOrderLegSide(strategyOrder.side, strategyLegs.get(i).getSide());</TD></TR><TR><TD CLASS="l">3556</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3557</TD><TD>        return legEntries;</TD></TR><TR><TD CLASS="l">3558</TD><TD>        </TD></TR><TR><TD CLASS="l">3559</TD><TD>    }</TD></TR><TR><TD CLASS="l">3560</TD><TD>    </TD></TR><TR><TD CLASS="l">3561</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3562</TD><TD>     * Creates default strategy leg entry structs when they are not specified on the order.</TD></TR><TR><TD CLASS="l">3563</TD><TD>     *</TD></TR><TR><TD CLASS="l">3564</TD><TD>     * @throws SystemException</TD></TR><TR><TD CLASS="l">3565</TD><TD>     * @throws</TD></TR><TR><TD CLASS="l"><A NAME="1f">3566</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">3567</TD><TD>    private LegOrderEntryStructV2[] createNewLegEntries(final OrderStruct strategyOrder)</TD></TR><TR><TD CLASS="l">3568</TD><TD>            throws DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">3569</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3570</TD><TD>        final int len = strategyOrder.legOrderDetails.length;</TD></TR><TR CLASS="z"><TD CLASS="l">3571</TD><TD>        final LegOrderEntryStructV2[] legEntries = new LegOrderEntryStructV2[len];</TD></TR><TR CLASS="z"><TD CLASS="l">3572</TD><TD>        for (int i = 0; i &lt; len; i++)</TD></TR><TR><TD CLASS="l">3573</TD><TD>        {   </TD></TR><TR CLASS="z"><TD CLASS="l">3574</TD><TD>            legEntries[i] = new LegOrderEntryStructV2();</TD></TR><TR CLASS="z"><TD CLASS="l">3575</TD><TD>            legEntries[i].legOrderEntry = new LegOrderEntryStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">3576</TD><TD>            legEntries[i].legOrderEntry.productKey = strategyOrder.legOrderDetails[i].productKey;</TD></TR><TR CLASS="z"><TD CLASS="l">3577</TD><TD>            legEntries[i].legOrderEntry.clearingFirm = strategyOrder.legOrderDetails[i].clearingFirm;</TD></TR><TR CLASS="z"><TD CLASS="l">3578</TD><TD>            legEntries[i].legOrderEntry.coverage = strategyOrder.legOrderDetails[i].coverage;</TD></TR><TR CLASS="z"><TD CLASS="l">3579</TD><TD>            legEntries[i].legOrderEntry.mustUsePrice = strategyOrder.legOrderDetails[i].mustUsePrice;</TD></TR><TR CLASS="z"><TD CLASS="l">3580</TD><TD>            legEntries[i].legOrderEntry.positionEffect = strategyOrder.legOrderDetails[i].positionEffect;</TD></TR><TR CLASS="z"><TD CLASS="l">3581</TD><TD>            legEntries[i].side = strategyOrder.legOrderDetails[i].side;</TD></TR><TR CLASS="z"><TD CLASS="l">3582</TD><TD>            legEntries[i] = convertSellSideIndicatorOfNonStockLeg(legEntries[i]);</TD></TR><TR><TD CLASS="l">3583</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3584</TD><TD>        return legEntries;</TD></TR><TR><TD CLASS="l">3585</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="1d">3586</A></TD><TD>    </TD></TR><TR><TD CLASS="l">3587</TD><TD>    private LegOrderEntryStructV2 convertSellSideIndicatorOfNonStockLeg(LegOrderEntryStructV2 legEntriesV2) </TD></TR><TR><TD CLASS="l">3588</TD><TD>        throws DataValidationException, SystemException </TD></TR><TR><TD CLASS="l">3589</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3590</TD><TD>        if ( (legEntriesV2.side == Sides.SELL_SHORT) || (legEntriesV2.side == Sides.SELL_SHORT_EXEMPT))</TD></TR><TR><TD CLASS="l">3591</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3592</TD><TD>            ProductData legProductData = getProductData(legEntriesV2.legOrderEntry.productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">3593</TD><TD>            if (!ProductTypeResolver.isStockType(legProductData.getProductType()))</TD></TR><TR><TD CLASS="l">3594</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3595</TD><TD>                legEntriesV2.side = Sides.SELL;    </TD></TR><TR><TD CLASS="l">3596</TD><TD>            }</TD></TR><TR><TD CLASS="l">3597</TD><TD>        }</TD></TR><TR><TD CLASS="l">3598</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3599</TD><TD>        return legEntriesV2;</TD></TR><TR><TD CLASS="l">3600</TD><TD>    }</TD></TR><TR><TD CLASS="l">3601</TD><TD>    </TD></TR><TR><TD CLASS="l">3602</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3603</TD><TD>     * Retrieve short sale marking firm property</TD></TR><TR><TD CLASS="l"><A NAME="5e">3604</A></TD><TD>     * @return true/false to indicator whether short sale indicator is turned on</TD></TR><TR><TD CLASS="l">3605</TD><TD>     */</TD></TR><TR><TD CLASS="l">3606</TD><TD>    private boolean retrieveShortSaleMarkingFirmProperty(OrderStruct order) </TD></TR><TR><TD CLASS="l">3607</TD><TD>    {   </TD></TR><TR CLASS="z"><TD CLASS="l">3608</TD><TD>        String sessionName = order.sessionNames[0];</TD></TR><TR CLASS="z"><TD CLASS="l">3609</TD><TD>        String firmNumber = order.orderId.executingOrGiveUpFirm.firmNumber;</TD></TR><TR CLASS="z"><TD CLASS="l">3610</TD><TD>        if(firmNumber == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">3611</TD><TD>            Log.alarm(&#34;unknown firmNumber in retrieveShortSaleMarkingFirmProperty for order: &#34; + </TD></TR><TR CLASS="z"><TD CLASS="l">3612</TD><TD>                    order.orderId.branch + &#34;:&#34; + order.orderId.branchSequenceNumber + &#34;:&#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">3613</TD><TD>                    order.orderId.correspondentFirm + &#34;:&#34; + order.orderId.orderDate + &#34;:&#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">3614</TD><TD>                    order.orderId.highCboeId + &#34;:&#34; + order.orderId.lowCboeId);</TD></TR><TR CLASS="z"><TD CLASS="l">3615</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">3616</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3617</TD><TD>        String exchangeAcronym = order.orderId.executingOrGiveUpFirm.exchange;</TD></TR><TR CLASS="z"><TD CLASS="l">3618</TD><TD>        BasePropertyKey key = new SessionFirmKey(</TD></TR><TR CLASS="z"><TD CLASS="l">3619</TD><TD>                FirmPropertyTypeImpl.SHORT_SALE_MARKING.getName(),</TD></TR><TR CLASS="z"><TD CLASS="l">3620</TD><TD>                sessionName,firmNumber,exchangeAcronym);</TD></TR><TR><TD CLASS="l">3621</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3622</TD><TD>        return firmPropertyService.getShortSaleMarking(key);</TD></TR><TR><TD CLASS="l">3623</TD><TD> </TD></TR><TR><TD CLASS="l">3624</TD><TD>    }</TD></TR><TR><TD CLASS="l">3625</TD><TD> </TD></TR><TR><TD CLASS="l">3626</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3627</TD><TD>     * Gets the strategy legs from the trading product.</TD></TR><TR><TD CLASS="l">3628</TD><TD>     *</TD></TR><TR><TD CLASS="l">3629</TD><TD>     * @return legs of product or empty array if there is an error</TD></TR><TR><TD CLASS="l">3630</TD><TD>     * @throws SystemException</TD></TR><TR><TD CLASS="l">3631</TD><TD>     * @throws NotFoundException</TD></TR><TR><TD CLASS="l">3632</TD><TD>     */</TD></TR><TR><TD CLASS="l">3633</TD><TD>    private List&lt;ProductLegData&gt; getStrategyLegs(final int productKey)</TD></TR><TR><TD CLASS="l">3634</TD><TD>            throws DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">3635</TD><TD>    {</TD></TR><TR><TD CLASS="l"><A NAME="42">3636</A></TD><TD> </TD></TR><TR><TD CLASS="l">3637</TD><TD>        ProductData prodData;</TD></TR><TR><TD CLASS="l">3638</TD><TD>        try</TD></TR><TR><TD CLASS="l">3639</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3640</TD><TD>            prodData = productDataCache.getProductData(productKey);</TD></TR><TR><TD CLASS="l">3641</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3642</TD><TD>        catch (NotFoundException e)</TD></TR><TR><TD CLASS="l">3643</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3644</TD><TD>            throw ExceptionBuilder.dataValidationException(</TD></TR><TR CLASS="z"><TD CLASS="l">3645</TD><TD>                    msg().add(&#34;Product for strategy order could not be found: &#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3646</TD><TD>                            e.details.message).end(), DataValidationCodes.INVALID_STRATEGY);</TD></TR><TR><TD CLASS="l">3647</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3648</TD><TD>        List&lt;ProductLegData&gt; legs = prodData.getLegs();</TD></TR><TR CLASS="z"><TD CLASS="l">3649</TD><TD>        if (legs == null)</TD></TR><TR><TD CLASS="l">3650</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3651</TD><TD>            throw ExceptionBuilder.dataValidationException(</TD></TR><TR CLASS="z"><TD CLASS="l">3652</TD><TD>                    &#34;Legs for strategy order could not be found&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">3653</TD><TD>                    DataValidationCodes.INVALID_STRATEGY);</TD></TR><TR><TD CLASS="l">3654</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3655</TD><TD>        return legs;</TD></TR><TR><TD CLASS="l">3656</TD><TD>    }</TD></TR><TR><TD CLASS="l">3657</TD><TD> </TD></TR><TR><TD CLASS="l">3658</TD><TD> </TD></TR><TR><TD CLASS="l">3659</TD><TD>     private Order validateCancelReplace(final CancelRequestStruct cancelRequest,</TD></TR><TR><TD CLASS="l">3660</TD><TD>            final OrderStruct anOrderStruct, final LegOrderEntryStructV2[] legEntries,</TD></TR><TR><TD CLASS="l">3661</TD><TD>            final OrderIdStruct orderId, String userId) throws SystemException,</TD></TR><TR><TD CLASS="l">3662</TD><TD>            NotAcceptedException, DataValidationException, AuthorizationException,</TD></TR><TR><TD CLASS="l">3663</TD><TD>            CommunicationException, TransactionFailedException</TD></TR><TR><TD CLASS="l"><A NAME="7c">3664</A></TD><TD>    {</TD></TR><TR><TD CLASS="l">3665</TD><TD>        final int quantity;</TD></TR><TR><TD CLASS="l">3666</TD><TD> </TD></TR><TR><TD CLASS="l">3667</TD><TD>        // ignore quantity in cancel request if all is being cancelled.</TD></TR><TR CLASS="z"><TD CLASS="l">3668</TD><TD>        if (cancelRequest.cancelType == OrderCancelTypes.CANCEL_ALL_QUANTITY)</TD></TR><TR><TD CLASS="l">3669</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3670</TD><TD>            quantity = 0;</TD></TR><TR><TD CLASS="l">3671</TD><TD>        }</TD></TR><TR><TD CLASS="l">3672</TD><TD>        else</TD></TR><TR><TD CLASS="l">3673</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3674</TD><TD>            quantity = cancelRequest.quantity;</TD></TR><TR><TD CLASS="l">3675</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3676</TD><TD>        if (log.isDebugOn())</TD></TR><TR><TD CLASS="l">3677</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3678</TD><TD>            log.debug(</TD></TR><TR CLASS="z"><TD CLASS="l">3679</TD><TD>                    msg().add(&#34;cx/re&#34;).add(&#34;orderId&#34;, orderId).add(&#34;for&#34;).add(&#34;quantity&#34;, quantity)</TD></TR><TR CLASS="z"><TD CLASS="l">3680</TD><TD>                            .add(&#34;contracts&#34;));</TD></TR><TR><TD CLASS="l">3681</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3682</TD><TD>        cxlRepValidator.validateOrderId(orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3683</TD><TD>        TradableValidationContext validationContext = new TradableValidationContext(legEntries==null?0:legEntries.length, true, false);</TD></TR><TR CLASS="z"><TD CLASS="l">3684</TD><TD>        cxlRepValidator.isValidOrder(anOrderStruct, legEntries, validationContext, false);</TD></TR><TR CLASS="z"><TD CLASS="l">3685</TD><TD>        final Order originalOrder = cxlRepValidator.findOrderByOrderId(orderId, false);</TD></TR><TR><TD CLASS="l">3686</TD><TD>        </TD></TR><TR><TD CLASS="l">3687</TD><TD>        //this is a special check done up-infront for the ExpressOrders.</TD></TR><TR><TD CLASS="l">3688</TD><TD>        //Cancel/Replace is not supported if either the original Order, or</TD></TR><TR><TD CLASS="l">3689</TD><TD>        //the Replaced order or both are of type express Order. Throws the</TD></TR><TR><TD CLASS="l">3690</TD><TD>        //Datavalidation exception with error code of Invalid contingency type for cancel/Re.</TD></TR><TR CLASS="z"><TD CLASS="l">3691</TD><TD>        cxlRepValidator.validateCancelReplaceForContingencies(originalOrder, anOrderStruct);</TD></TR><TR><TD CLASS="l">3692</TD><TD> </TD></TR><TR><TD CLASS="l">3693</TD><TD>        //Cancel-Replace is not supported if the Original Order was non-Quote Like </TD></TR><TR><TD CLASS="l">3694</TD><TD>        //and Replacement Order is Quote Like.</TD></TR><TR CLASS="z"><TD CLASS="l">3695</TD><TD>        validateCancelReplaceIOrder(originalOrder, anOrderStruct);   </TD></TR><TR><TD CLASS="l">3696</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">3697</TD><TD>        cxlRepValidator.validateProductState(originalOrder.getActiveSession(), originalOrder.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">3698</TD><TD>        cancelRequest.orderId = originalOrder.getOrderId();</TD></TR><TR CLASS="z"><TD CLASS="l">3699</TD><TD>        cxlRepValidator.validateCancelReplaceForContingencies(originalOrder, anOrderStruct);</TD></TR><TR><TD CLASS="l">3700</TD><TD>        </TD></TR><TR><TD CLASS="l">3701</TD><TD>        /* For Manual Quote, Cancel/Replace is not supported if either the original Order, </TD></TR><TR><TD CLASS="l">3702</TD><TD>         * or the Replaced order or both are of type Manual Quote Order. */</TD></TR><TR CLASS="z"><TD CLASS="l">3703</TD><TD>        cxlRepValidator.validateCancelReplaceForManualQuote(originalOrder, anOrderStruct);</TD></TR><TR><TD CLASS="l">3704</TD><TD>        </TD></TR><TR><TD CLASS="l">3705</TD><TD>        // If Order is Linkage Order, only P orders are sup ported. PA and S orders are invalid</TD></TR><TR><TD CLASS="l">3706</TD><TD>        // orders.</TD></TR><TR CLASS="z"><TD CLASS="l">3707</TD><TD>        if (originalOrder.isLinkageOrder())</TD></TR><TR><TD CLASS="l">3708</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3709</TD><TD>            final MsgBuilder msg = msg().add(&#34;Cancel replace for Linkage orders is not supported.&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3710</TD><TD>                    .add(&#34;orderId&#34;, orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3711</TD><TD>            log.client(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">3712</TD><TD>            throw ExceptionBuilder.notAcceptedException(msg.end(),</TD></TR><TR CLASS="z"><TD CLASS="l">3713</TD><TD>                    DataValidationCodes.INVALID_ORIGIN_TYPE);</TD></TR><TR><TD CLASS="l">3714</TD><TD>        }</TD></TR><TR><TD CLASS="l">3715</TD><TD> </TD></TR><TR><TD CLASS="l">3716</TD><TD>        // Replacement for auction response order must have the same contingency type</TD></TR><TR CLASS="z"><TD CLASS="l">3717</TD><TD>        if ((originalOrder.isAuctionResponse() &amp;&amp; !isAuctionResponse(anOrderStruct))</TD></TR><TR CLASS="z"><TD CLASS="l">3718</TD><TD>                || (!originalOrder.isAuctionResponse() &amp;&amp; isAuctionResponse(anOrderStruct)))</TD></TR><TR><TD CLASS="l">3719</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3720</TD><TD>            final MsgBuilder msg = msg().add(&#34;Both canceled and replacement order's &#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3721</TD><TD>                    &#34;contingency type should be AUCTION_RESPONSE : &#34;).add(&#34;cxlOrderId&#34;, orderId)</TD></TR><TR CLASS="z"><TD CLASS="l">3722</TD><TD>                    .add(&#34;repOrderId&#34;, anOrderStruct.orderId);</TD></TR><TR CLASS="z"><TD CLASS="l">3723</TD><TD>            log.client(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">3724</TD><TD>            throw ExceptionBuilder.dataValidationException(msg.end(),</TD></TR><TR CLASS="z"><TD CLASS="l">3725</TD><TD>                    DataValidationCodes.INVALID_CONTINGENCY_TYPE);</TD></TR><TR><TD CLASS="l">3726</TD><TD>        }</TD></TR><TR><TD CLASS="l">3727</TD><TD> </TD></TR><TR><TD CLASS="l">3728</TD><TD>        // Replacement must be for same session.</TD></TR><TR CLASS="z"><TD CLASS="l">3729</TD><TD>        if (!anOrderStruct.activeSession.equals(originalOrder.getActiveSession()))</TD></TR><TR><TD CLASS="l">3730</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3731</TD><TD>            log.client(msg().add(&#34;cx/re session name mismatch&#34;).add(&#34;originalSess&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">3732</TD><TD>                            originalOrder.getActiveSession()).add(&#34;,&#34;).add(&#34;requestedSess&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">3733</TD><TD>                            anOrderStruct.activeSession));</TD></TR><TR CLASS="z"><TD CLASS="l">3734</TD><TD>            throw ExceptionBuilder.dataValidationException(msg().add(&#34;Order &#34;).add(orderId).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3735</TD><TD>                    &#34; not in same session as replacement order&#34;).end(),</TD></TR><TR CLASS="z"><TD CLASS="l">3736</TD><TD>                    DataValidationCodes.INVALID_SESSION);</TD></TR><TR><TD CLASS="l">3737</TD><TD>        }</TD></TR><TR><TD CLASS="l">3738</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3739</TD><TD>        if ((originalOrder.getRemainingQuantity() == 0) || (originalOrder.getState() == OrderStates.CANCEL))</TD></TR><TR><TD CLASS="l">3740</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3741</TD><TD>            log.client(msg().add(&#34;Order &#34;, orderId).add(&#34; already filled or canceled&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">3742</TD><TD>            throw ExceptionBuilder.dataValidationException(msg().add(&#34;Order&#34;, orderId).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3743</TD><TD>                    &#34;already filled or canceled&#34;).end(), DataValidationCodes.INVALID_QUANTITY);</TD></TR><TR><TD CLASS="l">3744</TD><TD>        }</TD></TR><TR><TD CLASS="l">3745</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3746</TD><TD>        if (originalOrder.isStrategy())</TD></TR><TR><TD CLASS="l">3747</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3748</TD><TD>            LegOrderDetail[] legs = originalOrder.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">3749</TD><TD>            for (LegOrderDetail aLeg : legs) </TD></TR><TR><TD CLASS="l">3750</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3751</TD><TD>                if (aLeg.getLeavesQuantity() == 0)  </TD></TR><TR><TD CLASS="l">3752</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">3753</TD><TD>                    log.client(msg().add(&#34;Strategy order &#34;, originalOrder.getOrderId())</TD></TR><TR CLASS="z"><TD CLASS="l">3754</TD><TD>                            .add(&#34; has ratio mismatch with no cancellable quantity remaining.&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">3755</TD><TD>                    throw ExceptionBuilder.dataValidationException(msg().add(&#34;Strategy order &#34;, originalOrder.getOrderId())</TD></TR><TR CLASS="z"><TD CLASS="l">3756</TD><TD>                            .add(&#34; has ratio mismatch with no cancellable quantity remaining.&#34;).end(), DataValidationCodes.INVALID_QUANTITY);</TD></TR><TR><TD CLASS="l">3757</TD><TD>                }</TD></TR><TR><TD CLASS="l">3758</TD><TD>            }</TD></TR><TR><TD CLASS="l">3759</TD><TD>        }</TD></TR><TR><TD CLASS="l">3760</TD><TD> </TD></TR><TR><TD CLASS="l">3761</TD><TD>        // If Firm Order throw an exception</TD></TR><TR CLASS="z"><TD CLASS="l">3762</TD><TD>        if (originalOrder.isFirmMatchOrder())</TD></TR><TR><TD CLASS="l">3763</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3764</TD><TD>            throw ExceptionBuilder.notAcceptedException(msg().add(</TD></TR><TR CLASS="z"><TD CLASS="l">3765</TD><TD>                    &#34;CancelReplace Request for Match Side of &#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3766</TD><TD>                    &#34;Internalized Orders are not allowed.&#34;).add(&#34;orderId&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">3767</TD><TD>                    originalOrder.getOrderId()).end(), NotAcceptedCodes.INVALID_REQUEST);</TD></TR><TR><TD CLASS="l">3768</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3769</TD><TD>        return originalOrder;</TD></TR><TR><TD CLASS="l"><A NAME="7d">3770</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3771</TD><TD>     </TD></TR><TR><TD CLASS="l">3772</TD><TD>     private void validateCancelReplaceIOrder(Order originalOrder, OrderStruct replacedOrderStruct) throws DataValidationException</TD></TR><TR><TD CLASS="l">3773</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">3774</TD><TD>         boolean replacementOrderQuoteLike = orderHome.isOrderOriginLikeQuote(replacedOrderStruct.orderOriginType, replacedOrderStruct.activeSession);</TD></TR><TR CLASS="z"><TD CLASS="l">3775</TD><TD>         if(!originalOrder.treatedLikeQuote() &amp;&amp; replacementOrderQuoteLike)</TD></TR><TR><TD CLASS="l">3776</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">3777</TD><TD>             throw ExceptionBuilder.dataValidationException((&#34;Non-Quote Like Order cannot be Cancel/Replaced with Quote Like Order&#34;),</TD></TR><TR CLASS="z"><TD CLASS="l">3778</TD><TD>                                                              DataValidationCodes.INVALID_ORIGIN_TYPE);</TD></TR><TR><TD CLASS="l">3779</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="4a">3780</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">3781</TD><TD> </TD></TR><TR><TD CLASS="l">3782</TD><TD>    private boolean isAuctionResponse(final OrderStruct orderStruct)</TD></TR><TR><TD CLASS="l">3783</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3784</TD><TD>        if (log.isDebugOn())</TD></TR><TR><TD CLASS="l">3785</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3786</TD><TD>            log.debug(</TD></TR><TR CLASS="z"><TD CLASS="l">3787</TD><TD>                    msg().add(&#34;:isAuctionResponse&#34;).add(&#34;orderStruct.contingency.type&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">3788</TD><TD>                            orderStruct.contingency.type));</TD></TR><TR><TD CLASS="l">3789</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3790</TD><TD>        return (orderStruct.contingency.type == ContingencyTypes.AUCTION_RESPONSE);</TD></TR><TR><TD CLASS="l">3791</TD><TD>    }</TD></TR><TR><TD CLASS="l">3792</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="23">3793</A></TD><TD>    private void executeCxlReOrderWorkflow(CancelReplaceContext p_context)</TD></TR><TR><TD CLASS="l">3794</TD><TD>    throws CommunicationException, SystemException, AuthorizationException,</TD></TR><TR><TD CLASS="l">3795</TD><TD>    DataValidationException, TransactionFailedException, NotAcceptedException</TD></TR><TR><TD CLASS="l">3796</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3797</TD><TD>        IWorkflowStatelessExecutor&lt;CancelReplaceContext&gt; workflowExcecutor = null;</TD></TR><TR CLASS="z"><TD CLASS="l">3798</TD><TD>        if (p_context.getOrder().getLocation().equals(p_context.getRoutingParams().source))</TD></TR><TR><TD CLASS="l">3799</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3800</TD><TD>            workflowExcecutor = this.cancelReplaceFromOwnerOMTWorkflow.getStatelessExecutor();</TD></TR><TR><TD CLASS="l">3801</TD><TD>        }</TD></TR><TR><TD CLASS="l">3802</TD><TD>        else</TD></TR><TR><TD CLASS="l">3803</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3804</TD><TD>            workflowExcecutor = this.cancelReplaceFromNonOwnerOMTWorkflow.getStatelessExecutor();</TD></TR><TR><TD CLASS="l">3805</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3806</TD><TD>        workflowExcecutor.autoExecute(p_context);</TD></TR><TR CLASS="z"><TD CLASS="l">3807</TD><TD>        if (p_context.getException() != null)</TD></TR><TR><TD CLASS="l">3808</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3809</TD><TD>            if (p_context.inTransaction())</TD></TR><TR CLASS="z"><TD CLASS="l">3810</TD><TD>                p_context.rollbackTransaction();</TD></TR><TR><TD CLASS="l">3811</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3812</TD><TD>            Order replacedOrder = p_context.getReplacementOrder();</TD></TR><TR><TD CLASS="l">3813</TD><TD>            try</TD></TR><TR><TD CLASS="l">3814</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3815</TD><TD>                p_context.startTransaction();</TD></TR><TR CLASS="z"><TD CLASS="l">3816</TD><TD>                OrderHome orderHome = replacedOrder.getMyHome();</TD></TR><TR CLASS="z"><TD CLASS="l">3817</TD><TD>                orderHome.delete(replacedOrder);</TD></TR><TR CLASS="z"><TD CLASS="l">3818</TD><TD>                p_context.commitTransaction();</TD></TR><TR><TD CLASS="l">3819</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3820</TD><TD>            catch (Exception excp)</TD></TR><TR><TD CLASS="l">3821</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3822</TD><TD>                log.alarm(</TD></TR><TR CLASS="z"><TD CLASS="l">3823</TD><TD>                        msg().add(&#34;Failed to delete the Order, Order ID: &#34;).add(</TD></TR><TR CLASS="z"><TD CLASS="l">3824</TD><TD>                                replacedOrder.getOrderIdString()));</TD></TR><TR><TD CLASS="l">3825</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3826</TD><TD>            maybeThrow(p_context);</TD></TR><TR><TD CLASS="l">3827</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3828</TD><TD>        Order order = p_context.getReplacementOrder();</TD></TR><TR CLASS="z"><TD CLASS="l">3829</TD><TD>        ArrayList&lt;OrderHistoryCommonInfo&gt; orderHistoryCommonInfoList = new ArrayList &lt;OrderHistoryCommonInfo&gt; ();</TD></TR><TR CLASS="z"><TD CLASS="l">3830</TD><TD>        OrderHistoryCommonInfo orderHistoryCommonInfo = p_context.getOrderHistoryCommonInfo(order.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">3831</TD><TD>        orderHistoryCommonInfoList.add(orderHistoryCommonInfo);</TD></TR><TR CLASS="z"><TD CLASS="l">3832</TD><TD>        if(order.isStrategy())</TD></TR><TR><TD CLASS="l">3833</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3834</TD><TD>            LegOrderDetail[] legs = order.getLegOrderDetails();</TD></TR><TR CLASS="z"><TD CLASS="l">3835</TD><TD>            for(int i=0; i &lt; legs.length; i++)</TD></TR><TR><TD CLASS="l">3836</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3837</TD><TD>                OrderHistoryCommonInfo orderHistoryCommonInfoLegs = p_context.getOrderHistoryCommonInfo(legs[i].getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">3838</TD><TD>                orderHistoryCommonInfoList.add(orderHistoryCommonInfoLegs);</TD></TR><TR><TD CLASS="l">3839</TD><TD>            }</TD></TR><TR><TD CLASS="l">3840</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3841</TD><TD>        if(order.getContingencyType() == ContingencyTypes.AUCTION_RESPONSE)</TD></TR><TR><TD CLASS="l">3842</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3843</TD><TD>            order.publishNewOrder(orderHistoryCommonInfoList);</TD></TR><TR><TD CLASS="l">3844</TD><TD>        }</TD></TR><TR><TD CLASS="l">3845</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="e">3846</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3847</TD><TD> </TD></TR><TR><TD CLASS="l">3848</TD><TD>    public void acceptMessageRoute(String p_userId, String p_sessionName, String p_newLocation, long p_msgId) throws SystemException, CommunicationException, DataValidationException, TransactionFailedException, NotAcceptedException, AuthorizationException</TD></TR><TR><TD CLASS="l">3849</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3850</TD><TD>        log().info(msg().add(&#34;entering MOMDI.acceptMessageRoute &#34;));</TD></TR><TR><TD CLASS="l">3851</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3852</TD><TD>        getNetworkInstrumentor().incrementOmtMessageRouteReceived(1);</TD></TR><TR><TD CLASS="l">3853</TD><TD> </TD></TR><TR><TD CLASS="l">3854</TD><TD>        try</TD></TR><TR><TD CLASS="l">3855</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3856</TD><TD>            RoutedMessage routedMsg = routedMessageHome.findByMessageIdentifier(p_msgId);</TD></TR><TR CLASS="z"><TD CLASS="l">3857</TD><TD>            String oldLocation = routedMsg.getLocation();</TD></TR><TR CLASS="z"><TD CLASS="l">3858</TD><TD>            if ((routedMsg == null) || (routedMsg.isProcessed()) || oldLocation.compareToIgnoreCase(p_userId) != 0)  {</TD></TR><TR CLASS="z"><TD CLASS="l">3859</TD><TD>               throw ExceptionBuilder.notAcceptedException(MsgBuilder.get()</TD></TR><TR CLASS="z"><TD CLASS="l">3860</TD><TD>                        .add(&#34;Specified route message does not exist/is processed. &#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">3861</TD><TD>                        .add(&#34;Route message id&#34;, p_msgId).end(), NotAcceptedCodes.INVALID_REQUEST);</TD></TR><TR><TD CLASS="l">3862</TD><TD>            }</TD></TR><TR><TD CLASS="l">3863</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">3864</TD><TD>            if (oldLocation.equalsIgnoreCase(p_newLocation)) {</TD></TR><TR CLASS="z"><TD CLASS="l">3865</TD><TD>                return;</TD></TR><TR><TD CLASS="l">3866</TD><TD>            }</TD></TR><TR><TD CLASS="l">3867</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3868</TD><TD>            RemoveMessageContext context = new RemoveMessageContext(p_newLocation, p_userId);</TD></TR><TR CLASS="z"><TD CLASS="l">3869</TD><TD>            Order order = orderHome.findOrderFromCacheOrDB(routedMsg.getOrderDbId());</TD></TR><TR CLASS="z"><TD CLASS="l">3870</TD><TD>            if (order == null)</TD></TR><TR><TD CLASS="l">3871</TD><TD>            {</TD></TR><TR><TD CLASS="l">3872</TD><TD>                //OrderId orderStruct = new OrderId(order.getOrderId());</TD></TR><TR CLASS="z"><TD CLASS="l">3873</TD><TD>                final MsgBuilder msg = msg().add(&#34;MOMDI.acceptDirectRoute, Order not found : &#34;</TD></TR><TR CLASS="z"><TD CLASS="l">3874</TD><TD>                        + routedMsg.getOrderDbId());</TD></TR><TR CLASS="z"><TD CLASS="l">3875</TD><TD>                log().alarm(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">3876</TD><TD>                throw ExceptionBuilder.notAcceptedException(msg.end(), NotFoundCodes.RESOURCE_DOESNT_EXIST);</TD></TR><TR><TD CLASS="l">3877</TD><TD>            }</TD></TR><TR><TD CLASS="l">3878</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3879</TD><TD>            OrderRoutingParameterStruct routingParam = new OrderRoutingParameterStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">3880</TD><TD>            routingParam.source = p_userId;</TD></TR><TR CLASS="z"><TD CLASS="l">3881</TD><TD>            routingParam.sourceType = findLocationType(p_userId);</TD></TR><TR CLASS="z"><TD CLASS="l">3882</TD><TD>            routingParam.destination = p_newLocation;</TD></TR><TR CLASS="z"><TD CLASS="l">3883</TD><TD>            routingParam.destinationType = findLocationType(p_newLocation);</TD></TR><TR CLASS="z"><TD CLASS="l">3884</TD><TD>            context.setRoutingParams(routingParam);</TD></TR><TR CLASS="z"><TD CLASS="l">3885</TD><TD>            context.setOrder(order);</TD></TR><TR CLASS="z"><TD CLASS="l">3886</TD><TD>            context.setRoutedMessage(routedMsg);</TD></TR><TR><TD CLASS="l">3887</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">3888</TD><TD>            this.messageRouteOMT.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l">3889</TD><TD>            if (context.getException() != null)</TD></TR><TR><TD CLASS="l">3890</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3891</TD><TD>                maybeThrow(context);</TD></TR><TR><TD CLASS="l">3892</TD><TD>            }</TD></TR><TR><TD CLASS="l">3893</TD><TD>            else</TD></TR><TR><TD CLASS="l">3894</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">3895</TD><TD>                getNetworkInstrumentor().incrementOmtMessageRouteSent(1);</TD></TR><TR><TD CLASS="l">3896</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">3897</TD><TD>        } catch (TransactionFailedException e) {</TD></TR><TR><TD CLASS="l">3898</TD><TD>            // should be handled in the workflow: Defensive check</TD></TR><TR CLASS="z"><TD CLASS="l">3899</TD><TD>            log.alarm(msg().add(&#34;TransactionFailedException on acceptMessageRoute: &#34;).add(e));</TD></TR><TR><TD CLASS="l">3900</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">3901</TD><TD>        catch (Exception e)</TD></TR><TR><TD CLASS="l">3902</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">3903</TD><TD>            log.alarm(msg().add(&#34;Exception on acceptMessageRoute: &#34;).add(e));</TD></TR><TR><TD CLASS="l">3904</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="6d">3905</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3906</TD><TD> </TD></TR><TR><TD CLASS="l">3907</TD><TD>    public void setMarketMakerQuoteService(MarketMakerQuoteService p_marketMakerQuoteService)</TD></TR><TR><TD CLASS="l">3908</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3909</TD><TD>        this.marketMakerQuoteService = p_marketMakerQuoteService;</TD></TR><TR CLASS="z"><TD CLASS="l">3910</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="79">3911</A></TD><TD> </TD></TR><TR><TD CLASS="l">3912</TD><TD>    private void testARException(OrderIdStruct p_struct)  throws SystemException, CommunicationException, DataValidationException,</TD></TR><TR><TD CLASS="l">3913</TD><TD>        TransactionFailedException, AuthorizationException</TD></TR><TR><TD CLASS="l">3914</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3915</TD><TD>        String orderBranch = p_struct.branch;</TD></TR><TR CLASS="z"><TD CLASS="l">3916</TD><TD>        if (exceptionTypeAR!=null &amp;&amp; orderBranchAR!=null &amp;&amp; orderBranchAR.equals(orderBranch)){</TD></TR><TR CLASS="z"><TD CLASS="l">3917</TD><TD>            if (exceptionTypeAR.equals(&#34;SE&#34;)){</TD></TR><TR CLASS="z"><TD CLASS="l">3918</TD><TD>                throw ExceptionBuilder.systemException(&#34;testing AR command SystemException&#34;, 0 );</TD></TR><TR><TD CLASS="l">3919</TD><TD>            } else</TD></TR><TR CLASS="z"><TD CLASS="l">3920</TD><TD>            if (exceptionTypeAR.equals(&#34;CE&#34;)){</TD></TR><TR CLASS="z"><TD CLASS="l">3921</TD><TD>                throw ExceptionBuilder.communicationException(&#34;testing AR command CommunicationException&#34;, 0 );</TD></TR><TR><TD CLASS="l">3922</TD><TD>            } else</TD></TR><TR CLASS="z"><TD CLASS="l">3923</TD><TD>            if (exceptionTypeAR.equals(&#34;TFE&#34;)){</TD></TR><TR CLASS="z"><TD CLASS="l">3924</TD><TD>                throw ExceptionBuilder.transactionFailedException(&#34;testing AR command TransactionFailedException&#34;, 0 );</TD></TR><TR><TD CLASS="l">3925</TD><TD>            } else</TD></TR><TR CLASS="z"><TD CLASS="l">3926</TD><TD>            if (exceptionTypeAR.equals(&#34;DVE&#34;)){</TD></TR><TR CLASS="z"><TD CLASS="l">3927</TD><TD>                throw ExceptionBuilder.dataValidationException(&#34;testing AR command DataValidationException&#34;, 0 );</TD></TR><TR><TD CLASS="l">3928</TD><TD>            } else</TD></TR><TR CLASS="z"><TD CLASS="l">3929</TD><TD>            if (exceptionTypeAR.equals(&#34;AE&#34;)){</TD></TR><TR CLASS="z"><TD CLASS="l">3930</TD><TD>                throw ExceptionBuilder.authorizationException(&#34;testing AR command AuthorizationException&#34;, 0 );</TD></TR><TR><TD CLASS="l">3931</TD><TD>            } else</TD></TR><TR CLASS="z"><TD CLASS="l">3932</TD><TD>            if (exceptionTypeAR.equals(&#34;NPE&#34;)){</TD></TR><TR CLASS="z"><TD CLASS="l">3933</TD><TD>                throw new NullPointerException(&#34;testing AR command NullPointerException&#34;);</TD></TR><TR><TD CLASS="l">3934</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">3935</TD><TD>                exceptionTypeAR =null;</TD></TR><TR><TD CLASS="l">3936</TD><TD>            }</TD></TR><TR><TD CLASS="l">3937</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="6f">3938</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3939</TD><TD> </TD></TR><TR><TD CLASS="l">3940</TD><TD>    public void setOrderBranchAR(String p_orderBranch)</TD></TR><TR><TD CLASS="l">3941</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3942</TD><TD>       this.orderBranchAR = p_orderBranch ;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="65">3943</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3944</TD><TD> </TD></TR><TR><TD CLASS="l">3945</TD><TD>    public void setExceptionType(String p_exceptionType)</TD></TR><TR><TD CLASS="l">3946</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3947</TD><TD>        this.exceptionTypeAR = p_exceptionType ;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="6b">3948</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3949</TD><TD> </TD></TR><TR><TD CLASS="l">3950</TD><TD>    public void setManualReportHandlerHome(ManualReportHandlerHome p_manualReportHandlerHome)</TD></TR><TR><TD CLASS="l">3951</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3952</TD><TD>        manualReportHandlerHome = p_manualReportHandlerHome;</TD></TR><TR CLASS="z"><TD CLASS="l">3953</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="f">3954</A></TD><TD> </TD></TR><TR><TD CLASS="l">3955</TD><TD>    public void acceptOMTSessionClose(String p_userId)</TD></TR><TR><TD CLASS="l">3956</TD><TD>    {</TD></TR><TR><TD CLASS="l">3957</TD><TD>        // Do nothing here.</TD></TR><TR CLASS="z"><TD CLASS="l">3958</TD><TD>    }</TD></TR><TR><TD CLASS="l">3959</TD><TD> </TD></TR><TR><TD CLASS="l">3960</TD><TD>    /*</TD></TR><TR><TD CLASS="l">3961</TD><TD>     * Send text message to HD receipients for messages received</TD></TR><TR><TD CLASS="l"><A NAME="5f">3962</A></TD><TD>     * from PAR and where PAR doesn't own the Order.</TD></TR><TR><TD CLASS="l">3963</TD><TD>     */</TD></TR><TR><TD CLASS="l">3964</TD><TD>    private void sendMessageToHelpDesk(String p_subject, String messageText)</TD></TR><TR><TD CLASS="l">3965</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3966</TD><TD>        DateTimeStruct currentDateTime = DateWrapper.convertToDateTime(System.currentTimeMillis());</TD></TR><TR CLASS="z"><TD CLASS="l">3967</TD><TD>        adminTextMessageServiceHome.find().acceptTextMessage(p_subject, messageText, currentDateTime);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="61">3968</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">3969</TD><TD> </TD></TR><TR><TD CLASS="l">3970</TD><TD>    public void setAdminTextMessageServiceHome(AdminTextMessageServiceHome p_adminTextMessageServiceHome)</TD></TR><TR><TD CLASS="l">3971</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3972</TD><TD>        adminTextMessageServiceHome = p_adminTextMessageServiceHome;</TD></TR><TR CLASS="z"><TD CLASS="l">3973</TD><TD>    }</TD></TR><TR><TD CLASS="l">3974</TD><TD> </TD></TR><TR><TD CLASS="l">3975</TD><TD>    /**</TD></TR><TR><TD CLASS="l">3976</TD><TD>     * This method will calculate max execution volume and verify that all tradable leg volumes are in</TD></TR><TR><TD CLASS="l">3977</TD><TD>     * original ratio</TD></TR><TR><TD CLASS="l">3978</TD><TD>     *</TD></TR><TR><TD CLASS="l">3979</TD><TD>     * @param data - TPF message</TD></TR><TR><TD CLASS="l">3980</TD><TD>     * @param offset - message offset</TD></TR><TR><TD CLASS="l">3981</TD><TD>     * @param sessionStrategy - session strategy object associated with this complex order</TD></TR><TR><TD CLASS="l">3982</TD><TD>     *</TD></TR><TR><TD CLASS="l">3983</TD><TD>     * @return int - maximum execution volume for the order</TD></TR><TR><TD CLASS="l">3984</TD><TD>     *</TD></TR><TR><TD CLASS="l">3985</TD><TD>     * @throws TPFOrderException - if tradable volumes are not found for some legs or not in the original ratio</TD></TR><TR><TD CLASS="l">3986</TD><TD>     * @throws SystemException - the if leg is not found in the session strategy struct</TD></TR><TR><TD CLASS="l">3987</TD><TD>     * @throws DataValidationException</TD></TR><TR><TD CLASS="l"><A NAME="1a">3988</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">3989</TD><TD>    private int calculateMaximumExecutionVolume( int[] legMaxExecutionVolumes, LegOrderDetail[] p_legEntryDetails, int orderOriginalQuantity)</TD></TR><TR><TD CLASS="l">3990</TD><TD>    throws DataValidationException</TD></TR><TR><TD CLASS="l">3991</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">3992</TD><TD>        int maximumExecutionVolume = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3993</TD><TD>        int legMaxTradableVolume = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3994</TD><TD>        int legExecutionVolume = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3995</TD><TD>        int legRatio = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">3996</TD><TD>        if (0 &gt;= orderOriginalQuantity) {</TD></TR><TR CLASS="z"><TD CLASS="l">3997</TD><TD>            String message = &#34;calculateMaximumExecutionVolume : &#34; + &#34;the original quantity of the order cannot be 0.&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">3998</TD><TD>            throw ExceptionBuilder.dataValidationException(message, DataValidationCodes.INVALID_QUANTITY);</TD></TR><TR><TD CLASS="l">3999</TD><TD>        }</TD></TR><TR><TD CLASS="l">4000</TD><TD>            </TD></TR><TR><TD CLASS="l">4001</TD><TD>        // we may have up to 4 legs (tradable volumes)</TD></TR><TR CLASS="z"><TD CLASS="l">4002</TD><TD>        for (int i = 0; i &lt; p_legEntryDetails.length; i++)</TD></TR><TR><TD CLASS="l">4003</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4004</TD><TD>            legMaxTradableVolume = legMaxExecutionVolumes[i];</TD></TR><TR><TD CLASS="l">4005</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4006</TD><TD>            if( legMaxTradableVolume == 0 )</TD></TR><TR><TD CLASS="l">4007</TD><TD>            {</TD></TR><TR><TD CLASS="l">4008</TD><TD>                // tradeable volumes are not specified</TD></TR><TR CLASS="z"><TD CLASS="l">4009</TD><TD>                if( maximumExecutionVolume == 0 )</TD></TR><TR><TD CLASS="l">4010</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">4011</TD><TD>                    return 0;</TD></TR><TR><TD CLASS="l">4012</TD><TD>                }</TD></TR><TR><TD CLASS="l">4013</TD><TD>                else</TD></TR><TR><TD CLASS="l">4014</TD><TD>                {</TD></TR><TR><TD CLASS="l">4015</TD><TD>                    // the tradeable volume information is missing for the leg</TD></TR><TR CLASS="z"><TD CLASS="l">4016</TD><TD>                    String message = &#34;calculateMaximumExecutionVolume : &#34; + &#34;Leg max tradable volume is not specified for leg [&#34; + (i + 1)</TD></TR><TR CLASS="z"><TD CLASS="l">4017</TD><TD>                            + &#34;]&#34; ;</TD></TR><TR CLASS="z"><TD CLASS="l">4018</TD><TD>                    throw ExceptionBuilder.dataValidationException(message,</TD></TR><TR CLASS="z"><TD CLASS="l">4019</TD><TD>                            DataValidationCodes.INVALID_STRATEGY_LEG);</TD></TR><TR><TD CLASS="l">4020</TD><TD>                }</TD></TR><TR><TD CLASS="l">4021</TD><TD>            }</TD></TR><TR><TD CLASS="l">4022</TD><TD>            /*</TD></TR><TR><TD CLASS="l">4023</TD><TD>             * BIG assumption; That PAR will always give the legs back in the same order</TD></TR><TR><TD CLASS="l">4024</TD><TD>             * as it was Sent</TD></TR><TR><TD CLASS="l">4025</TD><TD>             */</TD></TR><TR CLASS="z"><TD CLASS="l">4026</TD><TD>            legRatio = p_legEntryDetails[i].getOriginalQuantity() / orderOriginalQuantity;</TD></TR><TR><TD CLASS="l">4027</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4028</TD><TD>            if( legMaxTradableVolume % legRatio != 0 )</TD></TR><TR><TD CLASS="l">4029</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">4030</TD><TD>                String message =  &#34;calculateMaximumExecutionVolume : &#34; + &#34;Leg [&#34; + (i + 1) + &#34;] has tradable volume [&#34; + legMaxTradableVolume</TD></TR><TR CLASS="z"><TD CLASS="l">4031</TD><TD>                        + &#34;] which is not a proper multiple of the leg ratio [&#34; + legRatio + &#34;]&#34; ;</TD></TR><TR CLASS="z"><TD CLASS="l">4032</TD><TD>                throw ExceptionBuilder.dataValidationException(message,</TD></TR><TR CLASS="z"><TD CLASS="l">4033</TD><TD>                        DataValidationCodes.INVALID_STRATEGY_LEG);</TD></TR><TR><TD CLASS="l">4034</TD><TD>            }</TD></TR><TR><TD CLASS="l">4035</TD><TD> </TD></TR><TR><TD CLASS="l">4036</TD><TD>            // Validate that the tradeable volume / ratio ( = maximumExecutionVolume )</TD></TR><TR><TD CLASS="l">4037</TD><TD>            // is the same for all legs:</TD></TR><TR><TD CLASS="l">4038</TD><TD>            //</TD></TR><TR CLASS="z"><TD CLASS="l">4039</TD><TD>            if (0 != legRatio) {</TD></TR><TR CLASS="z"><TD CLASS="l">4040</TD><TD>                legExecutionVolume = legMaxTradableVolume / legRatio;</TD></TR><TR><TD CLASS="l">4041</TD><TD>            }</TD></TR><TR><TD CLASS="l">4042</TD><TD>            else {</TD></TR><TR CLASS="z"><TD CLASS="l">4043</TD><TD>                legExecutionVolume = 0;</TD></TR><TR><TD CLASS="l">4044</TD><TD>            }</TD></TR><TR><TD CLASS="l">4045</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4046</TD><TD>            if( maximumExecutionVolume == 0 )</TD></TR><TR><TD CLASS="l">4047</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">4048</TD><TD>                maximumExecutionVolume = legExecutionVolume;</TD></TR><TR><TD CLASS="l">4049</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4050</TD><TD>            else if( maximumExecutionVolume != legExecutionVolume )</TD></TR><TR><TD CLASS="l">4051</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">4052</TD><TD>                String message = &#34;calculateMaximumExecutionVolume : &#34; + &#34;Leg [&#34; + (i + 1) + &#34;] has execution volume [&#34; + legExecutionVolume</TD></TR><TR CLASS="z"><TD CLASS="l">4053</TD><TD>                        + &#34;] which is not the same as maximum execution volume [&#34; + maximumExecutionVolume + &#34;]&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">4054</TD><TD>                throw ExceptionBuilder.dataValidationException(message,</TD></TR><TR CLASS="z"><TD CLASS="l">4055</TD><TD>                        DataValidationCodes.INVALID_STRATEGY_LEG);</TD></TR><TR><TD CLASS="l">4056</TD><TD>            }</TD></TR><TR><TD CLASS="l">4057</TD><TD>        }</TD></TR><TR><TD CLASS="l">4058</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4059</TD><TD>        return maximumExecutionVolume;</TD></TR><TR><TD CLASS="l"><A NAME="28">4060</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4061</TD><TD>    </TD></TR><TR><TD CLASS="l">4062</TD><TD>    private String getCancelReportMessageText(Order order, OrderRoutingParameterStruct p_orderRoutingStruct,  ManualCancelReportStruct[] p_manualCancelReportStruct,int p_simpleVolume, int[] p_complexVolume )</TD></TR><TR><TD CLASS="l">4063</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="29">4064</A></TD><TD>        return getStandardMessageText(order,p_orderRoutingStruct,order.getOrderId().lowCboeId,order.getOrderId().highCboeId,&#34;Cancel Report&#34;,p_simpleVolume,p_complexVolume)  ;</TD></TR><TR><TD CLASS="l">4065</TD><TD>    }</TD></TR><TR><TD CLASS="l">4066</TD><TD>    private String getCancelReportSubject( OrderRoutingParameterStruct p_orderRoutingStruct)</TD></TR><TR><TD CLASS="l">4067</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="43">4068</A></TD><TD>        return getStandardSubjectText(p_orderRoutingStruct,&#34;Cancel Report&#34;);</TD></TR><TR><TD CLASS="l">4069</TD><TD>    }</TD></TR><TR><TD CLASS="l">4070</TD><TD>    private String getTaTBMessageText(Order order, OrderRoutingParameterStruct p_orderRoutingStruct,OrderIdStruct p_orderID ,String msgType, int p_simpleVolume, int[] p_complexVolume)</TD></TR><TR><TD CLASS="l">4071</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="44">4072</A></TD><TD>        return getStandardMessageText(order,p_orderRoutingStruct,p_orderID.lowCboeId,p_orderID.highCboeId,msgType,p_simpleVolume,p_complexVolume)  ;</TD></TR><TR><TD CLASS="l">4073</TD><TD>    }</TD></TR><TR><TD CLASS="l">4074</TD><TD>    private String getTradeAllTradeBook( OrderRoutingParameterStruct p_orderRoutingStruct,String msgType)</TD></TR><TR><TD CLASS="l">4075</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4076</TD><TD>        return getStandardSubjectText(p_orderRoutingStruct,msgType);</TD></TR><TR><TD CLASS="l"><A NAME="38">4077</A></TD><TD>    }    </TD></TR><TR><TD CLASS="l">4078</TD><TD>    private String getPrintRequestMessageText(Order order, OrderRoutingParameterStruct p_orderRoutingStruct,OrderIdStruct p_orderID ,int p_simpleVolume, int[] p_complexVolume )</TD></TR><TR><TD CLASS="l">4079</TD><TD>    {</TD></TR><TR><TD CLASS="l">4080</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="39">4081</A></TD><TD>        return getStandardMessageText(order,p_orderRoutingStruct,p_orderID.lowCboeId,p_orderID.highCboeId,&#34;Print Request&#34;,p_simpleVolume,p_complexVolume)  ;</TD></TR><TR><TD CLASS="l">4082</TD><TD>    }</TD></TR><TR><TD CLASS="l">4083</TD><TD>    private String getPrintRequestSubject( OrderRoutingParameterStruct p_orderRoutingStruct)</TD></TR><TR><TD CLASS="l">4084</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4085</TD><TD>        return getStandardSubjectText(p_orderRoutingStruct,&#34;Print Request&#34;);</TD></TR><TR><TD CLASS="l"><A NAME="47">4086</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4087</TD><TD>    private String getVolumeChangeMessageText(Order order, OrderRoutingParameterStruct p_orderRoutingStruct,OrderIdStruct p_orderID ,int p_simpleVolume, int[] p_complexVolume )</TD></TR><TR><TD CLASS="l">4088</TD><TD>    {</TD></TR><TR><TD CLASS="l">4089</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">4090</TD><TD>        return getStandardMessageText(order,p_orderRoutingStruct,p_orderID.lowCboeId,p_orderID.highCboeId ,&#34;Volume Change&#34;,p_simpleVolume,p_complexVolume)  ;</TD></TR><TR><TD CLASS="l"><A NAME="48">4091</A></TD><TD>        </TD></TR><TR><TD CLASS="l">4092</TD><TD>    }</TD></TR><TR><TD CLASS="l">4093</TD><TD>    private String getVolumeChangeSubject( OrderRoutingParameterStruct p_orderRoutingStruct)</TD></TR><TR><TD CLASS="l">4094</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4095</TD><TD>        return getStandardSubjectText(p_orderRoutingStruct,&#34;Volume Change&#34;);</TD></TR><TR><TD CLASS="l"><A NAME="40">4096</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4097</TD><TD>    </TD></TR><TR><TD CLASS="l">4098</TD><TD>    private String getStandardMessageText(Order order, OrderRoutingParameterStruct p_orderRoutingStruct,int cboeLow, int cboeHigh ,String msgType, int p_simpleVolume, int[] p_complexVolume)</TD></TR><TR><TD CLASS="l">4099</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4100</TD><TD>        String routingSource  = OrderLocation.findOrderLocationEnum(p_orderRoutingStruct.sourceType).toString();</TD></TR><TR CLASS="z"><TD CLASS="l">4101</TD><TD>        String orderSource = OrderLocation.findOrderLocationEnum( order.getLocationType()).toString();</TD></TR><TR><TD CLASS="l">4102</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">4103</TD><TD>        String msg = msgType + &#34; received From Par Location=&#34;  + p_orderRoutingStruct.source   + &#34; LocationType=&#34; + p_orderRoutingStruct.sourceType + &#34;(&#34; +  routingSource +&#34;) &#34; </TD></TR><TR CLASS="z"><TD CLASS="l">4104</TD><TD>        + &#34;CboeDirect showing Order at Location=&#34;  + order.getLocation() + &#34; LocationType=&#34;  +  order.getLocationType() + &#34;(&#34; + orderSource + &#34;) &#34;  </TD></TR><TR CLASS="z"><TD CLASS="l">4105</TD><TD>        + &#34;CBOE High/Low = &#34; </TD></TR><TR CLASS="z"><TD CLASS="l">4106</TD><TD>        + cboeLow +&#34;/&#34; + cboeHigh</TD></TR><TR CLASS="z"><TD CLASS="l">4107</TD><TD>        + &#34; Order Id =&#34; </TD></TR><TR CLASS="z"><TD CLASS="l">4108</TD><TD>        + order.getOrderIdString()</TD></TR><TR CLASS="z"><TD CLASS="l">4109</TD><TD>        + &#34; ORS ID =&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">4110</TD><TD>        + order.getOrsId()</TD></TR><TR CLASS="z"><TD CLASS="l">4111</TD><TD>        + &#34;, with quantities :&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">4112</TD><TD>        + getQuantitiesString(order, p_simpleVolume, p_complexVolume)</TD></TR><TR CLASS="z"><TD CLASS="l">4113</TD><TD>        + &#34;, OHS BC = &#34; </TD></TR><TR CLASS="z"><TD CLASS="l">4114</TD><TD>        + getCommonConfig().getRouteName();</TD></TR><TR><TD CLASS="l">4115</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="41">4116</A></TD><TD>        return msg;</TD></TR><TR><TD CLASS="l">4117</TD><TD>    }</TD></TR><TR><TD CLASS="l">4118</TD><TD>    private String getStandardSubjectText( OrderRoutingParameterStruct p_orderRoutingStruct, String msgType)</TD></TR><TR><TD CLASS="l">4119</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4120</TD><TD>        String routingSource  = OrderLocation.findOrderLocationEnum(p_orderRoutingStruct.sourceType).toString();</TD></TR><TR CLASS="z"><TD CLASS="l">4121</TD><TD>        String theSubject = &#34;Rejected &#34; + msgType + &#34; From &#34;  + routingSource + &#34; &#34; + p_orderRoutingStruct.source;</TD></TR><TR CLASS="z"><TD CLASS="l">4122</TD><TD>        return theSubject;</TD></TR><TR><TD CLASS="l"><A NAME="14">4123</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4124</TD><TD>    </TD></TR><TR><TD CLASS="l">4125</TD><TD>    public void adminForcedLogoffParWorkstation(Order p_order)</TD></TR><TR><TD CLASS="l">4126</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4127</TD><TD>        if(!FFStatusQuery.getInstance().isCurrentFFStatusMaster()){</TD></TR><TR CLASS="z"><TD CLASS="l">4128</TD><TD>          return; // if it is not master - ignore this   </TD></TR><TR><TD CLASS="l">4129</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4130</TD><TD>        OrderContext context = new OrderContext();</TD></TR><TR CLASS="z"><TD CLASS="l">4131</TD><TD>        context.setOrder(p_order);</TD></TR><TR CLASS="z"><TD CLASS="l">4132</TD><TD>        OrderRoutingParameterStruct routingParam = new OrderRoutingParameterStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">4133</TD><TD>        String source =  OrderLocation.OHS.toString();</TD></TR><TR CLASS="z"><TD CLASS="l">4134</TD><TD>        short sourceType = OrderLocation.OHS.getOrderLocation();</TD></TR><TR CLASS="z"><TD CLASS="l">4135</TD><TD>        routingParam.source = source;</TD></TR><TR CLASS="z"><TD CLASS="l">4136</TD><TD>        routingParam.sourceType = sourceType;   </TD></TR><TR CLASS="z"><TD CLASS="l">4137</TD><TD>        routingParam.destinationType = OrderLocations.UNSPECIFIED;</TD></TR><TR CLASS="z"><TD CLASS="l">4138</TD><TD>        routingParam.destination = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">4139</TD><TD>        context.setRoutingParams(routingParam);</TD></TR><TR CLASS="z"><TD CLASS="l">4140</TD><TD>        context.setRouteReason(OHSRoutingReason.FORCED_LOGOFF_PAR.getOHSRoutingReason());</TD></TR><TR CLASS="z"><TD CLASS="l">4141</TD><TD>        context.setRouteDescription(ManualActivityHelper.getManualRouteDescription(ActivityTypes.FORCED_LOGOFF_PAR));</TD></TR><TR CLASS="z"><TD CLASS="l">4142</TD><TD>        this.forcedLogoffPARWorkflow.getStatelessExecutor().autoExecute(context);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="15">4143</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4144</TD><TD>    </TD></TR><TR><TD CLASS="l">4145</TD><TD>    private boolean approveDirectRerouteFromOHS(Order p_order, String destination)</TD></TR><TR><TD CLASS="l">4146</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4147</TD><TD>        if (p_order.getLocationType() == OrderLocation.OHS.ordinal()) {</TD></TR><TR CLASS="z"><TD CLASS="l">4148</TD><TD>            RoutedMessage[] manualFillTimeout = routedMessageHome.findCurrentByOrderAndMessageType(</TD></TR><TR CLASS="z"><TD CLASS="l">4149</TD><TD>                    RoutedMessageType.MANUAL_FILL_TIMEOUT, p_order.getUniqueId());</TD></TR><TR CLASS="z"><TD CLASS="l">4150</TD><TD>            RoutedMessage[] manualFillRejects = routedMessageHome.findCurrentByOrderAndMessageType(</TD></TR><TR CLASS="z"><TD CLASS="l">4151</TD><TD>                    RoutedMessageType.MANUAL_FILL_REJECT, p_order.getUniqueId());</TD></TR><TR CLASS="z"><TD CLASS="l">4152</TD><TD>            RoutedMessage[] manualOrderTimeouts = routedMessageHome.findCurrentByOrderAndMessageType(</TD></TR><TR CLASS="z"><TD CLASS="l">4153</TD><TD>                    RoutedMessageType.MANUAL_ORDER_TIMEOUT, p_order.getUniqueId());       </TD></TR><TR CLASS="z"><TD CLASS="l">4154</TD><TD>            if (manualFillTimeout.length &gt; 0 || manualFillRejects.length &gt; 0 || manualOrderTimeouts.length &gt; 0)</TD></TR><TR><TD CLASS="l">4155</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">4156</TD><TD>                if (destination.equals(OMTRouteDestinations.TE) || destination.equals(OMTRouteDestinations.CROWD) ||</TD></TR><TR CLASS="z"><TD CLASS="l">4157</TD><TD>                        Pattern.matches(PAR_PATTERN, destination) || destination.contains(&#34;:W&#34;)) {</TD></TR><TR CLASS="z"><TD CLASS="l">4158</TD><TD>                    return false;</TD></TR><TR><TD CLASS="l">4159</TD><TD>                }    </TD></TR><TR><TD CLASS="l">4160</TD><TD>            }    </TD></TR><TR><TD CLASS="l">4161</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4162</TD><TD>        return true;</TD></TR><TR><TD CLASS="l"><A NAME="60">4163</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">4164</TD><TD>    </TD></TR><TR><TD CLASS="l">4165</TD><TD>    private void sendTSB(OrderIdStruct p_orderId, Order p_order)</TD></TR><TR><TD CLASS="l">4166</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4167</TD><TD>        if(p_order.isStrategy()) {</TD></TR><TR><TD CLASS="l">4168</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">4169</TD><TD>                tsbQueue.sendTSB(p_orderId, p_order);</TD></TR><TR><TD CLASS="l">4170</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">4171</TD><TD>            catch (Exception exe) {</TD></TR><TR CLASS="z"><TD CLASS="l">4172</TD><TD>                log().info(MsgBuilder.get().add(&#34;Failed to Enqueue TSB: &#34;).add(&#34;Order&#34;, p_order).add(exe));</TD></TR><TR><TD CLASS="l">4173</TD><TD> </TD></TR><TR><TD CLASS="l">4174</TD><TD>            }</TD></TR><TR><TD CLASS="l">4175</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4176</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="76">4177</A></TD><TD>    </TD></TR><TR><TD CLASS="l">4178</TD><TD>    </TD></TR><TR><TD CLASS="l">4179</TD><TD>    public final void setTSBQueueImpl(TSBQueue p_tsbQueue)</TD></TR><TR><TD CLASS="l">4180</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4181</TD><TD>        tsbQueue = p_tsbQueue;</TD></TR><TR CLASS="z"><TD CLASS="l">4182</TD><TD>    }</TD></TR><TR><TD CLASS="l">4183</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="4c">4184</A></TD><TD>    private boolean isNewBOBLinkage(String sessionName, int productClassKey, int productKey) throws SystemException</TD></TR><TR><TD CLASS="l">4185</TD><TD>    {</TD></TR><TR><TD CLASS="l">4186</TD><TD>        try</TD></TR><TR><TD CLASS="l">4187</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4188</TD><TD>            BasePropertyKey theKey = FirmPropertyKeyHelper.buildSessionClassKeyEnableNewBOB(sessionName, productClassKey);</TD></TR><TR CLASS="z"><TD CLASS="l">4189</TD><TD>            return getFirmPropertyService().getEnableNewBOB(theKey, productKey);</TD></TR><TR><TD CLASS="l">4190</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4191</TD><TD>        catch(Exception e)</TD></TR><TR><TD CLASS="l">4192</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4193</TD><TD>            log.alarm(msg().add(&#34;MOMSDI.isNewBOBLinkage: Exception while retrieving New BOB Firm Property for key obtained using &#34; + productClassKey).add(e));</TD></TR><TR><TD CLASS="l">4194</TD><TD>        }        </TD></TR><TR><TD CLASS="l">4195</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4196</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">4197</TD><TD>    }</TD></TR><TR><TD CLASS="l">4198</TD><TD>    </TD></TR><TR><TD CLASS="l">4199</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="5d">4200</A></TD><TD>    public void publishReroutedOrderBackToOMTOnException(RemoveOrderContext context) throws SystemException, CommunicationException, </TD></TR><TR><TD CLASS="l">4201</TD><TD>                                                                                         DataValidationException, AuthorizationException</TD></TR><TR><TD CLASS="l">4202</TD><TD>    {</TD></TR><TR><TD CLASS="l">4203</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">4204</TD><TD>        OrderRoutingParameterStruct routingParam = new OrderRoutingParameterStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">4205</TD><TD>        OrderContext orderContext = (OrderContext) context;</TD></TR><TR CLASS="z"><TD CLASS="l">4206</TD><TD>        Order order = orderContext.getOrder();</TD></TR><TR><TD CLASS="l">4207</TD><TD>        try</TD></TR><TR><TD CLASS="l">4208</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4209</TD><TD>        orderContext.startTransaction();</TD></TR><TR><TD CLASS="l">4210</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">4211</TD><TD>        routingParam.source = OrderLocation.OHS.description;</TD></TR><TR CLASS="z"><TD CLASS="l">4212</TD><TD>        routingParam.sourceType = OrderLocation.OHS.getOrderLocation();</TD></TR><TR CLASS="z"><TD CLASS="l">4213</TD><TD>        routingParam.destination = orderContext.getRoutingParams().source;</TD></TR><TR CLASS="z"><TD CLASS="l">4214</TD><TD>        routingParam.destinationType = orderContext.getRoutingParams().sourceType;</TD></TR><TR><TD CLASS="l">4215</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">4216</TD><TD>        OrderLocation destOrderLocation = OrderLocation.findOrderLocationEnum(orderContext.getRoutingParams().sourceType);</TD></TR><TR><TD CLASS="l">4217</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">4218</TD><TD>        orderContext.setRoutingParams(routingParam);</TD></TR><TR CLASS="z"><TD CLASS="l">4219</TD><TD>        RoutingParameterV2Struct routingParamV2 = new RoutingParameterV2Struct();  </TD></TR><TR CLASS="z"><TD CLASS="l">4220</TD><TD>        routingParamV2.sourceType = routingParam.sourceType;</TD></TR><TR CLASS="z"><TD CLASS="l">4221</TD><TD>        routingParamV2.source = routingParam.source;</TD></TR><TR CLASS="z"><TD CLASS="l">4222</TD><TD>        routingParamV2.destinations = new String[] {routingParam.destination };</TD></TR><TR CLASS="z"><TD CLASS="l">4223</TD><TD>        String routeDescription = &#34;Failed to Re-Route the order to &#34; + order.getLocation();</TD></TR><TR><TD CLASS="l">4224</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">4225</TD><TD>        order.setLocation(routingParam.destination);</TD></TR><TR CLASS="z"><TD CLASS="l">4226</TD><TD>        order.setLocationType(routingParam.destinationType);</TD></TR><TR><TD CLASS="l">4227</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">4228</TD><TD>        RoutedMessage routedMsg = routedMessageHome.createOrderMessage(order.getOrderId(), </TD></TR><TR CLASS="z"><TD CLASS="l">4229</TD><TD>                                                   routingParam.destination, </TD></TR><TR CLASS="z"><TD CLASS="l">4230</TD><TD>                                                   destOrderLocation,  </TD></TR><TR CLASS="z"><TD CLASS="l">4231</TD><TD>                                                   OHSRoutingReason.LINKAGE_ROUTE,</TD></TR><TR CLASS="z"><TD CLASS="l">4232</TD><TD>                                                   routeDescription);</TD></TR><TR><TD CLASS="l">4233</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">4234</TD><TD>        RouteReasonStruct routeReason = new RouteReasonStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">4235</TD><TD>        routeReason.routeReason = OHSRoutingReason.ALL_ROUTING_ATTEMPT_FAILED.getOHSRoutingReason();</TD></TR><TR CLASS="z"><TD CLASS="l">4236</TD><TD>        routeReason.routeDescription = routeDescription;</TD></TR><TR CLASS="z"><TD CLASS="l">4237</TD><TD>        routeReason.messageId = routedMsg.getIdentifier();</TD></TR><TR CLASS="z"><TD CLASS="l">4238</TD><TD>        routeReason.routeTime = DateWrapper.convertToDateTime(routedMsg.getLastRouteTime());</TD></TR><TR CLASS="z"><TD CLASS="l">4239</TD><TD>        OrderRoutingStruct[] ordersWithRoute = new OrderRoutingStruct[1];</TD></TR><TR CLASS="z"><TD CLASS="l">4240</TD><TD>        ordersWithRoute[0] = new OrderRoutingStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">4241</TD><TD>        ordersWithRoute[0].order = order.getStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">4242</TD><TD>        ordersWithRoute[0].order.state = orderStateMapping(order);</TD></TR><TR CLASS="z"><TD CLASS="l">4243</TD><TD>        ordersWithRoute[0].routeReason = routeReason;</TD></TR><TR CLASS="z"><TD CLASS="l">4244</TD><TD>        orderRoutingPublisher.acceptOrders(routingParamV2, ordersWithRoute);</TD></TR><TR CLASS="z"><TD CLASS="l">4245</TD><TD>        order.getOrderHistoryHome().createHistoryOrderRouted(order, order.getRemainingQuantity(), orderContext.getOrderHistoryCommonInfo(order.getPrimitiveProductKey()));</TD></TR><TR CLASS="z"><TD CLASS="l">4246</TD><TD>        orderContext.commitTransaction();</TD></TR><TR><TD CLASS="l">4247</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4248</TD><TD>        catch(TransactionFailedException tranExp)</TD></TR><TR><TD CLASS="l">4249</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4250</TD><TD>        log.info(MsgBuilder.get().add(&#34;Failed to publish to OMT: &#34;).add(orderContext.getRoutingParams().source).add(&#34;Order&#34;, order).add(&#34;due to transaction failed&#34;).add(tranExp));</TD></TR><TR><TD CLASS="l">4251</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">4252</TD><TD>        catch(Exception exp)</TD></TR><TR><TD CLASS="l">4253</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">4254</TD><TD>        log.info(MsgBuilder.get().add(&#34;Failed to publish to OMT: &#34;).add(orderContext.getRoutingParams().source).add(&#34;Order&#34;, order).add(exp));</TD></TR><TR><TD CLASS="l">4255</TD><TD>        }    </TD></TR><TR CLASS="z"><TD CLASS="l">4256</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="52">4257</A></TD><TD> </TD></TR><TR><TD CLASS="l">4258</TD><TD>    </TD></TR><TR><TD CLASS="l">4259</TD><TD>    private short orderStateMapping(Order theOrder)</TD></TR><TR><TD CLASS="l">4260</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">4261</TD><TD>        if (theOrder.getState() == InternalOrderStates.ROUTED_AWAY) {</TD></TR><TR CLASS="z"><TD CLASS="l">4262</TD><TD>            return orderStateLocationMapper.getOrderStatesExt(theOrder.getLocationType()).getOrderStateExt();</TD></TR><TR><TD CLASS="l">4263</TD><TD>        }</TD></TR><TR><TD CLASS="l">4264</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">4265</TD><TD>            return theOrder.getState();</TD></TR><TR><TD CLASS="l">4266</TD><TD>        }        </TD></TR><TR><TD CLASS="l">4267</TD><TD>    }</TD></TR><TR><TD CLASS="l">4268</TD><TD> </TD></TR><TR><TD CLASS="l">4269</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="nv">[<A HREF="../Coverage.html">all classes</A>][<A HREF="1b.html">com.cboe.ohs.receivers.oms</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://www.eclemma.org/support.html">EMMA 2.0.5312 EclEmma Fix 2</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>