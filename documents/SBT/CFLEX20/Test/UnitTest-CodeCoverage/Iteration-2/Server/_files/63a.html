<HTML><HEAD><META CONTENT="text/html; charset=ISO-8859-1" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Mon May 16 15:10:41 CDT 2011)</TH></TR><TR><TD CLASS="nv">[<A HREF="../coverage.html">all classes</A>][<A HREF="5a.html">com.cboe.businessServices.tradeService</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">StrategyTradeServiceHelper.java</SPAN>]</H2><TABLE CELLSPACING="0" WIDTH="100%"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>StrategyTradeServiceHelper.java</TD><TD CLASS="h">50%  (1/2)</TD><TD CLASS="h">5%   (4/87)</TD><TD CLASS="h">2%   (45/2647)</TD><TD CLASS="h">3%   (17.8/619)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">StrategyTradeServiceHelper$LegComponentReturnType</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/98)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#0">&lt;static initializer&gt;</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/84)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">StrategyTradeServiceHelper$LegComponentReturnType (String, int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">valueOf (String): StrategyTradeServiceHelper$LegComponentReturnType</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">values (): StrategyTradeServiceHelper$LegComponentReturnType []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#5">StrategyTradeServiceHelper</A></TD><TD>100% (1/1)</TD><TD CLASS="h">5%   (4/83)</TD><TD CLASS="h">2%   (45/2549)</TD><TD CLASS="h">3%   (17.8/617)</TD></TR><TR><TD CLASS="f"><A HREF="#5">StrategyTradeServiceHelper (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7">addToLegProductSessionMap (Map, String, Integer): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/27)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#8">calculateTradePriceForLegs (DerivedQuote, TradingProduct, Price, HashSet): St...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#9">calculateTradePriceForLegs (TradingProduct, Price, Set, AllocationContext): S...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#a">calculateTradePriceForLegs (TradingProduct, Price, Set, AllocationContext, Pr...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#b">calculateTradePriceForLegs (TradingProduct, Price, Set, boolean): StrategyLeg...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#c">canTradeBookedSpreadWithNonContingent (OrderBook, Side, DerivedQuote): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#d">canTradeWithLegMaxContingency (Side, Price, int, int, DerivedQuote): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#e">canTradeWithLegMinContingency (Side, Price, int, int, DerivedQuote): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#f">canTradeWithLegNonContingency (Side, Price, int, DerivedQuote): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#10">combineNBBOVolumeFromExchanges (ExchangeVolumeStruct [], int, String): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/41)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#11">convert (TradingProduct): ProductStaticInfo</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/43)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#12">convert (int): ProductStaticInfo</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#13">convert (int, TradingProduct): ProductStaticInfo</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#14">convertLegs (List): ProductStaticInfo []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#15">convertLegs (TradingProduct): ProductStaticInfo []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/44)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#16">copyLegMarkets (BestPriceStruct): OrderBookSideStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/67)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#17">copyLegMarkets (OrderBookSideStruct, Side): BestPriceStruct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/63)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR><TD CLASS="f"><A HREF="#18">createLegTradeContainer (Side, Price, int, int, TradingProduct, DerivedQuote)...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/28)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#19">createLegTradeContainerWithContingency (Side, Price, int, int, TradingProduct...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/74)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR><TD CLASS="f"><A HREF="#1a">createLegTradeContainerWithNonContingency (Side, Price, int, TradingProduct, ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/37)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1b">createProcessStrategyLegsCommand (Order, Broker, DerivedQuote, TradingProduct...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#1c">createStrategyLegTradePrices (TradingProduct, Price []): StrategyLegTradePric...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/66)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1d">getActiveSessionName (ProductClassData): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/28)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#1e">getBestBookContingentPriceOnSide (OrderBook, Side): Price</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1f">getBestBookPriceOnSide (OrderBook, Side): Price</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#20">getBestBookQuantityOnSide (OrderBook, Side): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#21">getBestDerivedTradableOnSide (DerivedQuote, Side): Tradable</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#22">getBestLegMarketsStructs (TradingProduct): OrderBookSummaryStruct []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/141)</TD><TD CLASS="h">0%   (0/32)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#23">getCachedDerivedQuote (TradingProduct): DerivedQuote</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/19)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#24">getContractSize (int): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#25">getCurrentMarketCacheHome (): CurrentMarketCacheHomeImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#26">getDerivedQuote (TradingProduct, BestPriceStruct [], BestPriceStruct []): Der...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#27">getDerivedQuotePriceOnSide (DerivedQuote, Side): Price</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#28">getDerivedQuoteQuantityOnSide (DerivedQuote, Side): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#29">getDerivedQuoteWithNBBO (TradingProduct): DerivedQuote</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/19)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#2a">getDerivedQuoteWithouRefreshLegMarkets (TradingProduct, OrderBookSummaryStruc...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/39)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2b">getDerivedTradableOnSide (DerivedQuote, Side): Tradable</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#2c">getExchangeForSession (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2d">getFirstOptionLegClassKey (TradingProduct): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#2e">getLegMarkets (LegKeyParameters []): LegMarketDetailStruct []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/133)</TD><TD CLASS="h">0%   (0/24)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2f">getLocalNBBOVolume (ExchangeVolumeStruct [], String): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/29)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#30">getLocalOrd (): OrderRoutingDestination</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#31">getMarketDataHome (): MarketDataHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#32">getMarketDataServiceHome (): MarketDataServiceHomeImpl</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/18)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#33">getMarketDataServiceRoutingHome (): MarketDataServiceHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/18)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#34">getMaxBestVcQuantity (MarketVolumeStruct []): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/43)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#35">getMaxContingencyDerivedTradableOnSide (DerivedQuote, Side): Tradable</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#36">getMinContingencyDerivedTradableOnSide (DerivedQuote, Side): Tradable</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#37">getNonContingencyDerivedTradableOnSide (DerivedQuote, Side): Tradable</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#38">getORDRoutingProxy (): OrderRoutingDestination</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#39">getOhsOmsProxy (): OHSOrderMaintenanceService</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#3a">getOrderIdHome (): OrderIdGeneratorHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/18)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3b">getOrderRelationshipHome (): OrderRelationshipService</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#3c">getOrderRoutingParameterStructForSpreadEnalbed (TradingProduct): OrderRouting...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/55)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3d">getProductClassData (int): ProductClassData</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#3e">getProductData (int): ProductData</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3f">getProductDataCacheHome (): ProductDataCacheHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/18)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#40">getReportingClassData (int): ReportingClassData</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#41">getSmallestLegComponentByRatio (LegKeyParameters [], short, StrategyTradeServ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/155)</TD><TD CLASS="h">0%   (0/43)</TD></TR><TR><TD CLASS="f"><A HREF="#42">getStrategyLegTradeContainer (OrderBook, Side, DerivedQuote): StrategyLegTrad...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#43">getStrategyLegTradeContainer (Side, Price, int, int, TradingProduct, DerivedQ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/63)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#44">getStrategyLegTradeContainer (TradingProduct, DerivedQuote, Tradable): Strate...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#45">getTotalNonVcSize (MarketVolumeStruct []): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/44)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#46">getTradePriceForOtherSide (Price): Price</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#47">getTradeReportHome (): TradeReportHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#48">getTradeService (TradingProduct): TradeService</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/19)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#49">getTradingProduct (int): TradingProduct</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/36)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#4a">getTradingProductHome (): TradingProductHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4b">getTradingSessionHome (): TradingSessionHome</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#4c">getUniqueSessionProducts (LegKeyParameters [], Map, Map): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/31)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4d">isLeggingAllowed (TradingProduct, List): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/62)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR><TD CLASS="f"><A HREF="#4e">isOutSideDerivedQuote (Price, Side, DerivedQuote): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4f">isStrategyLegNBBO (Order, TradingProduct, DerivedQuote): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/101)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR><TD CLASS="f"><A HREF="#50">legBestBookHasContingentOnSide (OrderBook, Side): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#51">legsHaveOnlyContingentOnTop (TradingProduct, DerivedQuote): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#52">mapProdToLeg (Map, Integer, int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/29)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#53">refreshLegsCurrentMarketCache (OrderBookSummaryStruct []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/86)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR><TD CLASS="f"><A HREF="#54">refreshQuoteWithEquityLegsUpdate (DerivedQuote): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#55">getDerivedQuote (TradingProduct): DerivedQuote</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">29%  (8/28)</TD><TD CLASS="h">43%  (3.8/9)</TD></TR><TR><TD CLASS="f"><A HREF="#56">&lt;static initializer&gt;</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (25/25)</TD><TD>100% (12/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#57">getPrecision (): double</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#58">isNonDerivitive (short): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (10/10)</TD><TD>100% (1/1)</TD></TR></TABLE><P></P><TABLE CLASS="s" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="l">1</TD><TD>package com.cboe.businessServices.tradeService;</TD></TR><TR><TD CLASS="l">2</TD><TD> </TD></TR><TR><TD CLASS="l">3</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">4</TD><TD>import java.util.HashMap;</TD></TR><TR><TD CLASS="l">5</TD><TD>import java.util.HashSet;</TD></TR><TR><TD CLASS="l">6</TD><TD>import java.util.List;</TD></TR><TR><TD CLASS="l">7</TD><TD>import java.util.Map;</TD></TR><TR><TD CLASS="l">8</TD><TD>import java.util.Set;</TD></TR><TR><TD CLASS="l">9</TD><TD> </TD></TR><TR><TD CLASS="l">10</TD><TD>import com.cboe.businessServices.allocationService.AllocationContextImpl;</TD></TR><TR><TD CLASS="l">11</TD><TD>import com.cboe.businessServices.marketDataService.MarketDataServiceHomeImpl;</TD></TR><TR><TD CLASS="l">12</TD><TD>import com.cboe.businessServices.tradeService.spreadCalculator.SpreadTradeLegPriceCalculator;</TD></TR><TR><TD CLASS="l">13</TD><TD>import com.cboe.domain.util.DateWrapper;</TD></TR><TR><TD CLASS="l">14</TD><TD>import com.cboe.domain.util.MarketDataStructBuilder;</TD></TR><TR><TD CLASS="l">15</TD><TD>import com.cboe.domain.util.PriceFactory;</TD></TR><TR><TD CLASS="l">16</TD><TD>import com.cboe.domain.util.ProductStructBuilder;</TD></TR><TR><TD CLASS="l">17</TD><TD>import com.cboe.domain.util.SideFactory;</TD></TR><TR><TD CLASS="l">18</TD><TD>import com.cboe.domain.util.StrategyLegTradeContainer;</TD></TR><TR><TD CLASS="l">19</TD><TD>import com.cboe.domain.util.StructBuilder;</TD></TR><TR><TD CLASS="l">20</TD><TD>import com.cboe.domain.util.TradingSessionNameHelper;</TD></TR><TR><TD CLASS="l">21</TD><TD>import com.cboe.exceptions.DataValidationException;</TD></TR><TR><TD CLASS="l">22</TD><TD>import com.cboe.exceptions.NotFoundException;</TD></TR><TR><TD CLASS="l">23</TD><TD>import com.cboe.exceptions.SpreadProcessingException;</TD></TR><TR><TD CLASS="l">24</TD><TD>import com.cboe.exceptions.SystemException;</TD></TR><TR><TD CLASS="l">25</TD><TD>import com.cboe.idl.cmiConstants.ProductTypes;</TD></TR><TR><TD CLASS="l">26</TD><TD>import com.cboe.idl.cmiConstants.Sides;</TD></TR><TR><TD CLASS="l">27</TD><TD>import com.cboe.idl.cmiConstants.VolumeTypes;</TD></TR><TR><TD CLASS="l">28</TD><TD>import com.cboe.idl.cmiErrorCodes.DataValidationCodes;</TD></TR><TR><TD CLASS="l">29</TD><TD>import com.cboe.idl.cmiMarketData.CurrentMarketStruct;</TD></TR><TR><TD CLASS="l">30</TD><TD>import com.cboe.idl.cmiMarketData.ExchangeVolumeStruct;</TD></TR><TR><TD CLASS="l">31</TD><TD>import com.cboe.idl.cmiMarketData.MarketVolumeStruct;</TD></TR><TR><TD CLASS="l">32</TD><TD>import com.cboe.idl.cmiMarketData.NBBOStruct;</TD></TR><TR><TD CLASS="l">33</TD><TD>import com.cboe.idl.cmiMarketData.CurrentMarketStructV2;</TD></TR><TR><TD CLASS="l">34</TD><TD>import com.cboe.idl.constants.OrderLocations;</TD></TR><TR><TD CLASS="l">35</TD><TD>import com.cboe.idl.legMarketData.LegMarketDetailStruct;</TD></TR><TR><TD CLASS="l">36</TD><TD>import com.cboe.idl.order.OrderBookSideStruct;</TD></TR><TR><TD CLASS="l">37</TD><TD>import com.cboe.idl.order.OrderBookSummaryStruct;</TD></TR><TR><TD CLASS="l">38</TD><TD>import com.cboe.idl.order.OrderRoutingParameterStruct;</TD></TR><TR><TD CLASS="l">39</TD><TD>import com.cboe.idl.cmiProduct.ProductKeysStruct;</TD></TR><TR><TD CLASS="l">40</TD><TD>import com.cboe.idl.session.TradingSessionStruct;</TD></TR><TR><TD CLASS="l">41</TD><TD>import com.cboe.infrastructureServices.foundationFramework.HomeFactory;</TD></TR><TR><TD CLASS="l">42</TD><TD>import com.cboe.infrastructureServices.foundationFramework.exceptionHandling.CBOELoggableException;</TD></TR><TR><TD CLASS="l">43</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.Log;</TD></TR><TR><TD CLASS="l">44</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.RouteNameHelper;</TD></TR><TR><TD CLASS="l">45</TD><TD>import com.cboe.interfaces.businessServices.AllocationContext;</TD></TR><TR><TD CLASS="l">46</TD><TD>import com.cboe.interfaces.businessServices.MarketDataServiceHome;</TD></TR><TR><TD CLASS="l">47</TD><TD>import com.cboe.interfaces.businessServices.OrderRoutingDestination;</TD></TR><TR><TD CLASS="l">48</TD><TD>import com.cboe.interfaces.businessServices.OrderRoutingDestinationHome;</TD></TR><TR><TD CLASS="l">49</TD><TD>import com.cboe.interfaces.businessServices.TradeService;</TD></TR><TR><TD CLASS="l">50</TD><TD>import com.cboe.interfaces.businessServices.TradeServiceHome;</TD></TR><TR><TD CLASS="l">51</TD><TD>import com.cboe.interfaces.domain.AuctionInternal;</TD></TR><TR><TD CLASS="l">52</TD><TD>import com.cboe.interfaces.domain.BestBook;</TD></TR><TR><TD CLASS="l">53</TD><TD>import com.cboe.interfaces.domain.BestPriceStruct;</TD></TR><TR><TD CLASS="l">54</TD><TD>import com.cboe.interfaces.domain.Broker;</TD></TR><TR><TD CLASS="l">55</TD><TD>import com.cboe.interfaces.domain.DerivedQuote;</TD></TR><TR><TD CLASS="l">56</TD><TD>import com.cboe.interfaces.domain.LegOrderDetail;</TD></TR><TR><TD CLASS="l">57</TD><TD>import com.cboe.interfaces.domain.Order;</TD></TR><TR><TD CLASS="l">58</TD><TD>import com.cboe.interfaces.domain.OrderBook;</TD></TR><TR><TD CLASS="l">59</TD><TD>import com.cboe.interfaces.domain.OrderIdGeneratorHome;</TD></TR><TR><TD CLASS="l">60</TD><TD>import com.cboe.interfaces.domain.Price;</TD></TR><TR><TD CLASS="l">61</TD><TD>import com.cboe.interfaces.domain.Side;</TD></TR><TR><TD CLASS="l">62</TD><TD>import com.cboe.interfaces.domain.StrategyLegTradePrice;</TD></TR><TR><TD CLASS="l">63</TD><TD>import com.cboe.interfaces.domain.Tradable;</TD></TR><TR><TD CLASS="l">64</TD><TD>import com.cboe.interfaces.domain.TradeReportHome;</TD></TR><TR><TD CLASS="l">65</TD><TD>import com.cboe.interfaces.domain.TradingProduct;</TD></TR><TR><TD CLASS="l">66</TD><TD>import com.cboe.interfaces.domain.TradingProductHome;</TD></TR><TR><TD CLASS="l">67</TD><TD>import com.cboe.interfaces.domain.TradingStrategyLeg;</TD></TR><TR><TD CLASS="l">68</TD><TD>import com.cboe.interfaces.domain.marketData.MarketDataHome;</TD></TR><TR><TD CLASS="l">69</TD><TD>import com.cboe.interfaces.domain.session.TradingSessionHome;</TD></TR><TR><TD CLASS="l">70</TD><TD>import com.cboe.interfaces.internalBusinessServices.OrderRelationshipService;</TD></TR><TR><TD CLASS="l">71</TD><TD>import com.cboe.interfaces.internalBusinessServices.OrderRelationshipServiceHome;</TD></TR><TR><TD CLASS="l">72</TD><TD>import com.cboe.interfaces.orderHandlingServices.OHSOrderMaintenanceService;</TD></TR><TR><TD CLASS="l">73</TD><TD>import com.cboe.interfaces.orderHandlingServices.OHSOrderMaintenanceServiceHome;</TD></TR><TR><TD CLASS="l">74</TD><TD>import com.cboe.interfaces.productData.ProductClassData;</TD></TR><TR><TD CLASS="l">75</TD><TD>import com.cboe.interfaces.productData.ProductData;</TD></TR><TR><TD CLASS="l">76</TD><TD>import com.cboe.interfaces.productData.ProductDataCacheHome;</TD></TR><TR><TD CLASS="l">77</TD><TD>import com.cboe.interfaces.productData.ProductLegData;</TD></TR><TR><TD CLASS="l">78</TD><TD>import com.cboe.interfaces.productData.ReportingClassData;</TD></TR><TR><TD CLASS="l">79</TD><TD>import com.cboe.internalBusinessServices.productStateService.LegKeyParameters;</TD></TR><TR><TD CLASS="l">80</TD><TD>import com.cboe.internalBusinessServices.productStateService.ProductStaticInfo;</TD></TR><TR><TD CLASS="l">81</TD><TD>import com.cboe.internalBusinessServices.productStateService.SpreadKeyParameters;</TD></TR><TR><TD CLASS="l">82</TD><TD>import com.cboe.internalBusinessServices.productStateService.TradingProductImpl;</TD></TR><TR><TD CLASS="l">83</TD><TD>import com.cboe.server.util.ConfigurationGroupHelper;</TD></TR><TR><TD CLASS="l">84</TD><TD>import com.cboe.util.ExceptionBuilder;</TD></TR><TR><TD CLASS="l">85</TD><TD>import com.cboe.interfaces.productData.CurrentMarketCache;</TD></TR><TR><TD CLASS="l">86</TD><TD>import com.cboe.interfaces.productData.CurrentMarketCacheHome;</TD></TR><TR><TD CLASS="l">87</TD><TD>import com.cboe.businessServices.marketDataService.CurrentMarketCacheHomeImpl;</TD></TR><TR><TD CLASS="l">88</TD><TD>import com.cboe.businessServices.orderBookService.OrderBookImpl;</TD></TR><TR><TD CLASS="l"><A NAME="5">89</A></TD><TD>/*</TD></TR><TR><TD CLASS="l">90</TD><TD>*   UD 02/17/05 ...</TD></TR><TR><TD CLASS="l"><A NAME="56">91</A></TD><TD>*   Helper methods for spread trading that don't use instance variables from trade service. </TD></TR><TR><TD CLASS="l">92</TD><TD>*/</TD></TR><TR CLASS="z"><TD CLASS="l">93</TD><TD>public class StrategyTradeServiceHelper</TD></TR><TR><TD CLASS="l">94</TD><TD>{  </TD></TR><TR CLASS="c"><TD CLASS="l">95</TD><TD>   private static volatile OrderRoutingDestination ordRP = null;</TD></TR><TR CLASS="c"><TD CLASS="l">96</TD><TD>   private static volatile OrderRoutingDestination localOrd = null;</TD></TR><TR CLASS="c"><TD CLASS="l">97</TD><TD>   private static volatile OHSOrderMaintenanceService omsRP = null;</TD></TR><TR CLASS="c"><TD CLASS="l">98</TD><TD>   private static volatile OrderIdGeneratorHome orderIdHome = null;</TD></TR><TR CLASS="c"><TD CLASS="l">99</TD><TD>   private static volatile OrderRelationshipService ors = null;</TD></TR><TR CLASS="c"><TD CLASS="l">100</TD><TD>   private static volatile TradeReportHome tradeReportHome = null;</TD></TR><TR CLASS="c"><TD CLASS="l">101</TD><TD>   private static volatile ProductDataCacheHome productCacheHome = null;</TD></TR><TR CLASS="c"><TD CLASS="l">102</TD><TD>   private static volatile TradingSessionHome tradingSessionHome = null;</TD></TR><TR CLASS="c"><TD CLASS="l">103</TD><TD>   private static volatile MarketDataHome marketDataHome = null;</TD></TR><TR CLASS="c"><TD CLASS="l">104</TD><TD>   private static volatile MarketDataServiceHomeImpl marketDataServiceHome = null;</TD></TR><TR CLASS="c"><TD CLASS="l">105</TD><TD>   private static volatile MarketDataServiceHome marketDataServiceRoutingHome = null;</TD></TR><TR><TD CLASS="l"><A NAME="55">106</A></TD><TD>   private static volatile CurrentMarketCacheHomeImpl CurrentMarketCacheHome;</TD></TR><TR CLASS="c"><TD CLASS="l">107</TD><TD>   private static volatile TradingProductHome cachedTradingProductHome = null;</TD></TR><TR><TD CLASS="l">108</TD><TD>    </TD></TR><TR><TD CLASS="l">109</TD><TD>   public static final DerivedQuote getDerivedQuote(TradingProduct product) {</TD></TR><TR CLASS="c"><TD CLASS="l">110</TD><TD>        DerivedQuote derivedQ = null;</TD></TR><TR><TD CLASS="l">111</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">112</TD><TD>            derivedQ = product.getDerivedQuote();</TD></TR><TR><TD CLASS="l">113</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">114</TD><TD>        catch (DataValidationException dve) {</TD></TR><TR><TD CLASS="l">115</TD><TD>          //derived quote can not be calculated. return null;</TD></TR><TR CLASS="z"><TD CLASS="l">116</TD><TD>            if(dve.details != null)</TD></TR><TR><TD CLASS="l">117</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">118</TD><TD>                Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Failed to calculate derived quote, return null for DQ: &#34;+dve.details.message);</TD></TR><TR><TD CLASS="l">119</TD><TD>            }</TD></TR><TR><TD CLASS="l">120</TD><TD>        }</TD></TR><TR><TD CLASS="l">121</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">122</TD><TD>        catch (Exception e) {</TD></TR><TR><TD CLASS="l">123</TD><TD>          //derived quote can not be calculated. return null;</TD></TR><TR CLASS="z"><TD CLASS="l">124</TD><TD>                Log.exception(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Failed to calculate derived quote, return null for DQ: &#34;, e);</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="86% line coverage (6 out of 7 instructions)">125</TD><TD TITLE="86% line coverage (6 out of 7 instructions)">        }        </TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="26">126</A></TD><TD>        return derivedQ;</TD></TR><TR><TD CLASS="l">127</TD><TD>    }</TD></TR><TR><TD CLASS="l">128</TD><TD>    </TD></TR><TR><TD CLASS="l">129</TD><TD>   public static final DerivedQuote getDerivedQuote(TradingProduct product, BestPriceStruct[] definedSideLegMarkets, BestPriceStruct[] oppositeSideLegMarkets) {</TD></TR><TR CLASS="z"><TD CLASS="l">130</TD><TD>       DerivedQuote derivedQ = null;</TD></TR><TR><TD CLASS="l">131</TD><TD>       try {</TD></TR><TR CLASS="z"><TD CLASS="l">132</TD><TD>           derivedQ = product.getDerivedQuote(definedSideLegMarkets, oppositeSideLegMarkets);</TD></TR><TR><TD CLASS="l">133</TD><TD>       }</TD></TR><TR CLASS="z"><TD CLASS="l">134</TD><TD>       catch (DataValidationException dve) {</TD></TR><TR><TD CLASS="l">135</TD><TD>         //derived quote can not be calculated. return null;</TD></TR><TR CLASS="z"><TD CLASS="l">136</TD><TD>           if(dve.details != null)</TD></TR><TR><TD CLASS="l">137</TD><TD>           {</TD></TR><TR CLASS="z"><TD CLASS="l">138</TD><TD>               Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Failed to calculate derived quote, return null for DQ: &#34;+dve.details.message);</TD></TR><TR><TD CLASS="l">139</TD><TD>           }</TD></TR><TR><TD CLASS="l">140</TD><TD>       }</TD></TR><TR><TD CLASS="l">141</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">142</TD><TD>       catch (Exception e) {</TD></TR><TR><TD CLASS="l">143</TD><TD>         //derived quote can not be calculated. return null;</TD></TR><TR CLASS="z"><TD CLASS="l">144</TD><TD>               Log.exception(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Failed to calculate derived quote, return null for DQ: &#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">145</TD><TD>       }        </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="29">146</A></TD><TD>       return derivedQ;</TD></TR><TR><TD CLASS="l">147</TD><TD>   }</TD></TR><TR><TD CLASS="l">148</TD><TD>    </TD></TR><TR><TD CLASS="l">149</TD><TD>   public static final DerivedQuote getDerivedQuoteWithNBBO(TradingProduct product) {</TD></TR><TR CLASS="z"><TD CLASS="l">150</TD><TD>       DerivedQuote derivedQ = null;</TD></TR><TR><TD CLASS="l">151</TD><TD>       try {</TD></TR><TR CLASS="z"><TD CLASS="l">152</TD><TD>           derivedQ = product.getDerivedQuoteWithNBBO();</TD></TR><TR><TD CLASS="l">153</TD><TD>       }</TD></TR><TR CLASS="z"><TD CLASS="l">154</TD><TD>       catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">155</TD><TD>           Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Failed to calculate derived quote, return null for DQ: &#34;+e.getMessage());</TD></TR><TR><TD CLASS="l">156</TD><TD>           //derived quote can not be calculated. ruturn null;</TD></TR><TR CLASS="z"><TD CLASS="l">157</TD><TD>       }        </TD></TR><TR CLASS="z"><TD CLASS="l">158</TD><TD>       return derivedQ;</TD></TR><TR><TD CLASS="l">159</TD><TD>   }</TD></TR><TR><TD CLASS="l">160</TD><TD>   </TD></TR><TR><TD CLASS="l"><A NAME="54">161</A></TD><TD>   public static final void refreshQuoteWithEquityLegsUpdate(DerivedQuote dq)</TD></TR><TR><TD CLASS="l">162</TD><TD>   {</TD></TR><TR><TD CLASS="l">163</TD><TD>        try</TD></TR><TR><TD CLASS="l">164</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">165</TD><TD>            dq.refreshQuoteWithEquityLegsUpdate();</TD></TR><TR><TD CLASS="l">166</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">167</TD><TD>        catch (Exception e)</TD></TR><TR><TD CLASS="l">168</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">169</TD><TD>            Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Failed to refreshQuoteWithEquityLegsUpdate, return null for DQ: &#34;+e.getMessage());</TD></TR><TR CLASS="z"><TD CLASS="l">170</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">171</TD><TD>   }</TD></TR><TR><TD CLASS="l">172</TD><TD>   </TD></TR><TR><TD CLASS="l"><A NAME="27">173</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">174</TD><TD>    * get the derived quote price on the given side</TD></TR><TR><TD CLASS="l">175</TD><TD>    */</TD></TR><TR><TD CLASS="l">176</TD><TD>    public static Price getDerivedQuotePriceOnSide(DerivedQuote derivedQuote, Side aSide){</TD></TR><TR CLASS="z"><TD CLASS="l">177</TD><TD>       return getDerivedTradableOnSide(derivedQuote, aSide).getPrice();</TD></TR><TR><TD CLASS="l">178</TD><TD>    }</TD></TR><TR><TD CLASS="l">179</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="28">180</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">181</TD><TD>    * get the derived quote quantity on the given side</TD></TR><TR><TD CLASS="l">182</TD><TD>    */</TD></TR><TR><TD CLASS="l">183</TD><TD>    public static int getDerivedQuoteQuantityOnSide(DerivedQuote derivedQuote, Side aSide){</TD></TR><TR CLASS="z"><TD CLASS="l">184</TD><TD>        return getDerivedTradableOnSide(derivedQuote, aSide).getQuantity();</TD></TR><TR><TD CLASS="l"><A NAME="21">185</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">186</TD><TD> </TD></TR><TR><TD CLASS="l">187</TD><TD>    public static Tradable getBestDerivedTradableOnSide(DerivedQuote derivedQuote, Side aSide)</TD></TR><TR><TD CLASS="l">188</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">189</TD><TD>        Tradable result = getMaxContingencyDerivedTradableOnSide(derivedQuote, aSide);</TD></TR><TR CLASS="z"><TD CLASS="l">190</TD><TD>        if (! result.getPrice().isNoPrice()) {</TD></TR><TR CLASS="z"><TD CLASS="l">191</TD><TD>            return result;</TD></TR><TR><TD CLASS="l">192</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">193</TD><TD>        result = getMinContingencyDerivedTradableOnSide(derivedQuote,aSide);</TD></TR><TR CLASS="z"><TD CLASS="l">194</TD><TD>        if (! result.getPrice().isNoPrice()) {</TD></TR><TR CLASS="z"><TD CLASS="l">195</TD><TD>            return result;</TD></TR><TR><TD CLASS="l">196</TD><TD>        }</TD></TR><TR><TD CLASS="l">197</TD><TD>       </TD></TR><TR CLASS="z"><TD CLASS="l">198</TD><TD>        return getNonContingencyDerivedTradableOnSide(derivedQuote, aSide);</TD></TR><TR><TD CLASS="l">199</TD><TD>    }</TD></TR><TR><TD CLASS="l">200</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="37">201</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">202</TD><TD>    * get non contingency derived tradable from a derived quote on the given side</TD></TR><TR><TD CLASS="l">203</TD><TD>    */</TD></TR><TR><TD CLASS="l">204</TD><TD>    public static Tradable getNonContingencyDerivedTradableOnSide(DerivedQuote derivedQuote, Side aSide){</TD></TR><TR CLASS="z"><TD CLASS="l">205</TD><TD>        if (aSide.isAsDefinedSide()){</TD></TR><TR CLASS="z"><TD CLASS="l">206</TD><TD>               return derivedQuote.getBid();</TD></TR><TR><TD CLASS="l">207</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">208</TD><TD>        return derivedQuote.getAsk();</TD></TR><TR><TD CLASS="l">209</TD><TD>    }</TD></TR><TR><TD CLASS="l">210</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="35">211</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">212</TD><TD>    * get max contingency derived tradable from a derived quote on the given side</TD></TR><TR><TD CLASS="l">213</TD><TD>    */</TD></TR><TR><TD CLASS="l">214</TD><TD>    public static Tradable getMaxContingencyDerivedTradableOnSide(DerivedQuote derivedQuote, Side aSide){</TD></TR><TR CLASS="z"><TD CLASS="l">215</TD><TD>        if (aSide.isAsDefinedSide()){</TD></TR><TR CLASS="z"><TD CLASS="l">216</TD><TD>               return derivedQuote.getMaxContingencyBid();</TD></TR><TR><TD CLASS="l">217</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">218</TD><TD>        return derivedQuote.getMaxContingencyAsk();</TD></TR><TR><TD CLASS="l">219</TD><TD>    }</TD></TR><TR><TD CLASS="l">220</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="36">221</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">222</TD><TD>    * get min contingency derived tradable from a derived quote on the given side</TD></TR><TR><TD CLASS="l">223</TD><TD>    */</TD></TR><TR><TD CLASS="l">224</TD><TD>    public static Tradable getMinContingencyDerivedTradableOnSide(DerivedQuote derivedQuote, Side aSide){</TD></TR><TR CLASS="z"><TD CLASS="l">225</TD><TD>        if (aSide.isAsDefinedSide()){</TD></TR><TR CLASS="z"><TD CLASS="l">226</TD><TD>               return derivedQuote.getMinContingencyBid();</TD></TR><TR><TD CLASS="l">227</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">228</TD><TD>        return derivedQuote.getMinContingencyAsk();</TD></TR><TR><TD CLASS="l">229</TD><TD>    }</TD></TR><TR><TD CLASS="l">230</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="1f">231</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">232</TD><TD>    * get the best book price on the given side</TD></TR><TR><TD CLASS="l">233</TD><TD>    */</TD></TR><TR><TD CLASS="l">234</TD><TD>    public static Price getBestBookPriceOnSide(OrderBook anOrderBook, Side aSide){</TD></TR><TR CLASS="z"><TD CLASS="l">235</TD><TD>        BestBook bestBook = anOrderBook.getBestBook();</TD></TR><TR CLASS="z"><TD CLASS="l">236</TD><TD>        if (aSide.isAsDefinedSide() || aSide.isBuySide()){</TD></TR><TR CLASS="z"><TD CLASS="l">237</TD><TD>               return bestBook.getNonContingentBidPrice();</TD></TR><TR><TD CLASS="l">238</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">239</TD><TD>        return bestBook.getNonContingentAskPrice();</TD></TR><TR><TD CLASS="l">240</TD><TD>    }</TD></TR><TR><TD CLASS="l">241</TD><TD>    </TD></TR><TR><TD CLASS="l">242</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="1e">243</A></TD><TD>    * UD 02/15/05 ... </TD></TR><TR><TD CLASS="l">244</TD><TD>    * get the best book contingent price on the given side</TD></TR><TR><TD CLASS="l">245</TD><TD>    */</TD></TR><TR><TD CLASS="l">246</TD><TD>    public static Price getBestBookContingentPriceOnSide(OrderBook anOrderBook, Side aSide){</TD></TR><TR CLASS="z"><TD CLASS="l">247</TD><TD>        BestBook bestBook = anOrderBook.getBestBook();</TD></TR><TR CLASS="z"><TD CLASS="l">248</TD><TD>        if (aSide.isAsDefinedSide() || aSide.isBuySide()){</TD></TR><TR CLASS="z"><TD CLASS="l">249</TD><TD>               return bestBook.getContingentBidPrice();</TD></TR><TR><TD CLASS="l">250</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">251</TD><TD>        return bestBook.getContingentAskPrice();</TD></TR><TR><TD CLASS="l">252</TD><TD>    }</TD></TR><TR><TD CLASS="l">253</TD><TD>    </TD></TR><TR><TD CLASS="l">254</TD><TD>    /**</TD></TR><TR><TD CLASS="l">255</TD><TD>     * determine if a spread-to-leg-non-contingency trade can happen given</TD></TR><TR><TD CLASS="l">256</TD><TD>     * 1. spreads are on a side</TD></TR><TR><TD CLASS="l"><A NAME="f">257</A></TD><TD>     * 2. spread are at a price</TD></TR><TR><TD CLASS="l">258</TD><TD>     * 3. spreads' min quantity.</TD></TR><TR><TD CLASS="l">259</TD><TD>     */</TD></TR><TR><TD CLASS="l">260</TD><TD>    private static boolean canTradeWithLegNonContingency(Side side, Price price, int minQuantity, DerivedQuote derivedQuote){</TD></TR><TR CLASS="z"><TD CLASS="l">261</TD><TD>        Side otherSide = side.getOtherSide();</TD></TR><TR CLASS="z"><TD CLASS="l">262</TD><TD>        Price derivedPrice = getDerivedQuotePriceOnSide(derivedQuote, otherSide);</TD></TR><TR CLASS="z"><TD CLASS="l">263</TD><TD>        int derivedQuantity = getDerivedQuoteQuantityOnSide(derivedQuote, otherSide);</TD></TR><TR CLASS="z"><TD CLASS="l">264</TD><TD>        return derivedQuantity &gt; 0 &amp;&amp; side.areTwoPricesTradable(price, derivedPrice) &amp;&amp;</TD></TR><TR><TD CLASS="l">265</TD><TD>               derivedQuantity &gt;= minQuantity;</TD></TR><TR><TD CLASS="l">266</TD><TD>    }</TD></TR><TR><TD CLASS="l">267</TD><TD>    </TD></TR><TR><TD CLASS="l">268</TD><TD>    /**</TD></TR><TR><TD CLASS="l">269</TD><TD>     * determine if a spread-to-leg-max-contingency trade can happen given</TD></TR><TR><TD CLASS="l">270</TD><TD>     * 1. spreads are on a side</TD></TR><TR><TD CLASS="l">271</TD><TD>     * 2. spread are at a price</TD></TR><TR><TD CLASS="l"><A NAME="d">272</A></TD><TD>     * 3. spreads' max quantity</TD></TR><TR><TD CLASS="l">273</TD><TD>     * 4. spreads' min quantity.</TD></TR><TR><TD CLASS="l">274</TD><TD>    */</TD></TR><TR><TD CLASS="l">275</TD><TD>    private static boolean canTradeWithLegMaxContingency(Side side, Price price, int maxQuantity, int minQuantity, DerivedQuote derivedQuote){</TD></TR><TR CLASS="z"><TD CLASS="l">276</TD><TD>           Side otherSide = side.getOtherSide();</TD></TR><TR CLASS="z"><TD CLASS="l">277</TD><TD>           Tradable contingencyDT = getMaxContingencyDerivedTradableOnSide(derivedQuote, otherSide);</TD></TR><TR CLASS="z"><TD CLASS="l">278</TD><TD>           Price derivedPrice = contingencyDT.getPrice();</TD></TR><TR CLASS="z"><TD CLASS="l">279</TD><TD>           int derivedQuantity = contingencyDT.getMaxQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">280</TD><TD>           return derivedQuantity &gt; 0 &amp;&amp; side.areTwoPricesTradable(price, derivedPrice) &amp;&amp;</TD></TR><TR><TD CLASS="l">281</TD><TD>                   maxQuantity &gt;= derivedQuantity &amp;&amp;</TD></TR><TR><TD CLASS="l">282</TD><TD>                   derivedQuantity &gt;= minQuantity;</TD></TR><TR><TD CLASS="l">283</TD><TD>    }</TD></TR><TR><TD CLASS="l">284</TD><TD>    </TD></TR><TR><TD CLASS="l">285</TD><TD>    /**</TD></TR><TR><TD CLASS="l">286</TD><TD>     * determine if a spread-to-leg-min-contingency trade can happen given</TD></TR><TR><TD CLASS="l">287</TD><TD>     * 1. spreads are on a side</TD></TR><TR><TD CLASS="l">288</TD><TD>     * 2. spread are at a price</TD></TR><TR><TD CLASS="l">289</TD><TD>     * 3. spreads' max quantity</TD></TR><TR><TD CLASS="l"><A NAME="e">290</A></TD><TD>     * 4. spreads' min quantity.</TD></TR><TR><TD CLASS="l">291</TD><TD>    */</TD></TR><TR><TD CLASS="l">292</TD><TD>    private static boolean canTradeWithLegMinContingency(Side side, Price price, int maxQuantity, int minQuantity, DerivedQuote derivedQuote)</TD></TR><TR><TD CLASS="l">293</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">294</TD><TD>        Side otherSide = side.getOtherSide();</TD></TR><TR CLASS="z"><TD CLASS="l">295</TD><TD>        Tradable contingencyDT = getMinContingencyDerivedTradableOnSide(derivedQuote, otherSide);</TD></TR><TR CLASS="z"><TD CLASS="l">296</TD><TD>        Price derivedPrice = contingencyDT.getPrice();</TD></TR><TR CLASS="z"><TD CLASS="l">297</TD><TD>        int derivedQuantity = contingencyDT.getMinQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">298</TD><TD>        return derivedQuantity &gt; 0 &amp;&amp; side.areTwoPricesTradable(price, derivedPrice) &amp;&amp;</TD></TR><TR><TD CLASS="l">299</TD><TD>               maxQuantity &gt;= derivedQuantity &amp;&amp;</TD></TR><TR><TD CLASS="l">300</TD><TD>               derivedQuantity &gt;= minQuantity;</TD></TR><TR><TD CLASS="l">301</TD><TD>    }</TD></TR><TR><TD CLASS="l">302</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="2b">303</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">304</TD><TD>    * get derived tradable from a derived quote on the given side</TD></TR><TR><TD CLASS="l">305</TD><TD>    */</TD></TR><TR><TD CLASS="l">306</TD><TD>    public static Tradable getDerivedTradableOnSide(DerivedQuote derivedQuote, Side aSide){</TD></TR><TR CLASS="z"><TD CLASS="l">307</TD><TD>        if (aSide.isAsDefinedSide() || aSide.isBuySide()){</TD></TR><TR CLASS="z"><TD CLASS="l">308</TD><TD>               return derivedQuote.getBid();</TD></TR><TR><TD CLASS="l">309</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">310</TD><TD>        return derivedQuote.getAsk();</TD></TR><TR><TD CLASS="l">311</TD><TD>    }</TD></TR><TR><TD CLASS="l">312</TD><TD>    </TD></TR><TR><TD CLASS="l">313</TD><TD>    /**</TD></TR><TR><TD CLASS="l">314</TD><TD>    * Return a price with sign flipped. When a trade happens, one side of the trade</TD></TR><TR><TD CLASS="l"><A NAME="46">315</A></TD><TD>    * will pay out money (the price for this side is a negative), and the other side</TD></TR><TR><TD CLASS="l">316</TD><TD>    * will receive money (the price for this side is a positive).</TD></TR><TR><TD CLASS="l">317</TD><TD>    */</TD></TR><TR><TD CLASS="l">318</TD><TD>    public static Price getTradePriceForOtherSide(Price oneSidePrice){</TD></TR><TR CLASS="z"><TD CLASS="l">319</TD><TD>        if ( ! oneSidePrice.isValuedPrice()){</TD></TR><TR CLASS="z"><TD CLASS="l">320</TD><TD>               return oneSidePrice;</TD></TR><TR><TD CLASS="l">321</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">322</TD><TD>        return PriceFactory.createValuedPrice (-1 * oneSidePrice.toDouble());</TD></TR><TR><TD CLASS="l">323</TD><TD>    }</TD></TR><TR><TD CLASS="l">324</TD><TD>    </TD></TR><TR><TD CLASS="l">325</TD><TD>    /*</TD></TR><TR><TD CLASS="l">326</TD><TD>    *   UD ... 02/11/05</TD></TR><TR><TD CLASS="l">327</TD><TD>    *   Returns the leg trade container that contains trade information </TD></TR><TR><TD CLASS="l">328</TD><TD>    *   for the incoming spread order that can trade with the legs.</TD></TR><TR><TD CLASS="l"><A NAME="44">329</A></TD><TD>    */</TD></TR><TR><TD CLASS="l">330</TD><TD>    public static StrategyLegTradeContainer getStrategyLegTradeContainer(TradingProduct product, DerivedQuote derivedQuote, Tradable incomingTradable)</TD></TR><TR><TD CLASS="l">331</TD><TD>    throws DataValidationException</TD></TR><TR><TD CLASS="l">332</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">333</TD><TD>        Side side = incomingTradable.getSide();</TD></TR><TR CLASS="z"><TD CLASS="l">334</TD><TD>        Price price = incomingTradable.getPrice();</TD></TR><TR CLASS="z"><TD CLASS="l">335</TD><TD>        int maxQuantity = incomingTradable.getQuantityAllowed();</TD></TR><TR CLASS="z"><TD CLASS="l">336</TD><TD>        int minQuantity = incomingTradable.getMinQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">337</TD><TD>        return getStrategyLegTradeContainer(side,price,maxQuantity,minQuantity,product,derivedQuote);</TD></TR><TR><TD CLASS="l">338</TD><TD>    }</TD></TR><TR><TD CLASS="l">339</TD><TD> </TD></TR><TR><TD CLASS="l">340</TD><TD>    /**</TD></TR><TR><TD CLASS="l">341</TD><TD>    * Note: the following parameters are for spread tradables</TD></TR><TR><TD CLASS="l">342</TD><TD>    * 1. spreads are on a side</TD></TR><TR><TD CLASS="l">343</TD><TD>    * 2. spread are at a price</TD></TR><TR><TD CLASS="l">344</TD><TD>    * 3. spreads' max quantity</TD></TR><TR><TD CLASS="l">345</TD><TD>    * 4. spreads' min quantity.</TD></TR><TR><TD CLASS="l">346</TD><TD>    */</TD></TR><TR><TD CLASS="l"><A NAME="43">347</A></TD><TD>    public static StrategyLegTradeContainer getStrategyLegTradeContainer(</TD></TR><TR><TD CLASS="l">348</TD><TD>            Side side, Price price, int maxQuantity, int minQuantity, TradingProduct product, DerivedQuote derivedQuote)</TD></TR><TR><TD CLASS="l">349</TD><TD>    throws DataValidationException</TD></TR><TR><TD CLASS="l">350</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">351</TD><TD>        if (derivedQuote == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">352</TD><TD>            return new StrategyLegTradeContainer();</TD></TR><TR><TD CLASS="l">353</TD><TD>        }</TD></TR><TR><TD CLASS="l">354</TD><TD>        StrategyLegTradeContainer legTradeContainer;</TD></TR><TR CLASS="z"><TD CLASS="l">355</TD><TD>        legTradeContainer = createLegTradeContainer(side, price, maxQuantity, minQuantity, product, derivedQuote);</TD></TR><TR><TD CLASS="l">356</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">357</TD><TD>        if (Log.isDebugOn() &amp;&amp; (legTradeContainer != null))</TD></TR><TR><TD CLASS="l">358</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">359</TD><TD>                Side tSide= null;</TD></TR><TR CLASS="z"><TD CLASS="l">360</TD><TD>                if(legTradeContainer.getTradable() != null ) tSide = legTradeContainer.getTradable().getSide();</TD></TR><TR CLASS="z"><TD CLASS="l">361</TD><TD>            Log.debug (&#34;StrategyLegTradeContainer: &#34; + &#34;Product=&#34; + product.getProductKey() +</TD></TR><TR><TD CLASS="l">362</TD><TD>                    &#34;, side=&#34; + tSide + </TD></TR><TR><TD CLASS="l">363</TD><TD>                    &#34;, Qty=&#34; + legTradeContainer.getQuantity() + </TD></TR><TR><TD CLASS="l">364</TD><TD>                    &#34;, prices=&#34; + legTradeContainer.getLegPrices() + &#34;, price=&#34; + legTradeContainer.getTradablePrice() + </TD></TR><TR><TD CLASS="l">365</TD><TD>                    &#34;, useContingentBest=&#34; + legTradeContainer.getUseContingentBest());</TD></TR><TR><TD CLASS="l">366</TD><TD>        }</TD></TR><TR><TD CLASS="l">367</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">368</TD><TD>        return legTradeContainer;</TD></TR><TR><TD CLASS="l">369</TD><TD>    }</TD></TR><TR><TD CLASS="l">370</TD><TD> </TD></TR><TR><TD CLASS="l">371</TD><TD>    /**</TD></TR><TR><TD CLASS="l">372</TD><TD>    * Determine if  booked spread is tradable against non contingent legs.</TD></TR><TR><TD CLASS="l"><A NAME="42">373</A></TD><TD>    */</TD></TR><TR><TD CLASS="l">374</TD><TD>    public static StrategyLegTradeContainer getStrategyLegTradeContainer(OrderBook aBook, Side tradeSide, DerivedQuote derivedQuote)</TD></TR><TR><TD CLASS="l">375</TD><TD>    throws DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">376</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">377</TD><TD>        Price tradablePrice = getBestBookPriceOnSide(aBook, tradeSide);</TD></TR><TR CLASS="z"><TD CLASS="l">378</TD><TD>        int tradableQuantity = getBestBookQuantityOnSide(aBook, tradeSide);</TD></TR><TR CLASS="z"><TD CLASS="l">379</TD><TD>        int minQuantity = tradableQuantity &gt; 0 ? 1 : 0;</TD></TR><TR CLASS="z"><TD CLASS="l">380</TD><TD>        return getStrategyLegTradeContainer(tradeSide, tradablePrice, tradableQuantity, minQuantity, (TradingProductImpl)aBook.getTradingProduct(), derivedQuote);</TD></TR><TR><TD CLASS="l">381</TD><TD>    }</TD></TR><TR><TD CLASS="l">382</TD><TD> </TD></TR><TR><TD CLASS="l">383</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="20">384</A></TD><TD>    * get the best book price on the given side</TD></TR><TR><TD CLASS="l">385</TD><TD>    */</TD></TR><TR><TD CLASS="l">386</TD><TD>    public static int getBestBookQuantityOnSide(OrderBook anOrderBook, Side aSide)</TD></TR><TR><TD CLASS="l">387</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">388</TD><TD>        BestBook bestBook = anOrderBook.getBestBook();</TD></TR><TR CLASS="z"><TD CLASS="l">389</TD><TD>        if (aSide.isAsDefinedSide() || aSide.isBuySide()){</TD></TR><TR CLASS="z"><TD CLASS="l">390</TD><TD>            return bestBook.getNonContingentBidQuantity();</TD></TR><TR><TD CLASS="l">391</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">392</TD><TD>        return bestBook.getNonContingentAskQuantity();</TD></TR><TR><TD CLASS="l">393</TD><TD>    }</TD></TR><TR><TD CLASS="l">394</TD><TD>    </TD></TR><TR><TD CLASS="l">395</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="c">396</A></TD><TD>    * Determine if  booked spread is tradable against non contingent legs.  </TD></TR><TR><TD CLASS="l">397</TD><TD>    */</TD></TR><TR><TD CLASS="l">398</TD><TD>    public static boolean canTradeBookedSpreadWithNonContingent(OrderBook aBook, Side tradeSide, DerivedQuote derivedQuote)</TD></TR><TR><TD CLASS="l">399</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">400</TD><TD>        Side otherSide = tradeSide.getOtherSide();</TD></TR><TR CLASS="z"><TD CLASS="l">401</TD><TD>        Price tradablePrice = getBestBookPriceOnSide(aBook, tradeSide);</TD></TR><TR CLASS="z"><TD CLASS="l">402</TD><TD>        Price derivedPrice = getDerivedQuotePriceOnSide(derivedQuote, otherSide);</TD></TR><TR CLASS="z"><TD CLASS="l">403</TD><TD>        int derivedQuantity = getDerivedTradableOnSide(derivedQuote, otherSide).getQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">404</TD><TD>        int tradableQuantity = getBestBookQuantityOnSide(aBook, tradeSide);</TD></TR><TR CLASS="z"><TD CLASS="l">405</TD><TD>        return tradeSide.areTwoPricesTradable(tradablePrice, derivedPrice) &amp;&amp; derivedQuantity &gt; 0 &amp;&amp; tradableQuantity &gt; 0;</TD></TR><TR><TD CLASS="l">406</TD><TD>    }</TD></TR><TR><TD CLASS="l">407</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="50">408</A></TD><TD>    /*</TD></TR><TR><TD CLASS="l">409</TD><TD>    */</TD></TR><TR><TD CLASS="l">410</TD><TD>    public static boolean legBestBookHasContingentOnSide(OrderBook orderBook, Side aSide)</TD></TR><TR><TD CLASS="l">411</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">412</TD><TD>        BestBook legBestBook = orderBook.getBestBook();</TD></TR><TR CLASS="z"><TD CLASS="l">413</TD><TD>        return legBestBook.getContingentQuantityMax(aSide) &gt; 0 || legBestBook.getContingentQuantityMin(aSide) &gt; 0 ;</TD></TR><TR><TD CLASS="l">414</TD><TD>    }</TD></TR><TR><TD CLASS="l">415</TD><TD>    </TD></TR><TR><TD CLASS="l">416</TD><TD>    /*</TD></TR><TR><TD CLASS="l">417</TD><TD>    *   UD 02/11/05 ...</TD></TR><TR><TD CLASS="l">418</TD><TD>    *   Saves trade information if a spread order can trade with legs.</TD></TR><TR><TD CLASS="l">419</TD><TD>    *   Considers first contingent orders then non contingent orders</TD></TR><TR><TD CLASS="l">420</TD><TD>    *</TD></TR><TR><TD CLASS="l">421</TD><TD>    * Note: the following parameters are for spread tradables</TD></TR><TR><TD CLASS="l">422</TD><TD>    * 1. spreads are on a side</TD></TR><TR><TD CLASS="l">423</TD><TD>    * 2. spread are at a price</TD></TR><TR><TD CLASS="l">424</TD><TD>    * 3. spreads' max quantity</TD></TR><TR><TD CLASS="l">425</TD><TD>    * 4. spreads' min quantity.</TD></TR><TR><TD CLASS="l">426</TD><TD>    */</TD></TR><TR><TD CLASS="l"><A NAME="18">427</A></TD><TD>    private static StrategyLegTradeContainer createLegTradeContainer(</TD></TR><TR><TD CLASS="l">428</TD><TD>            Side side, Price price, int maxQuantity, int minQuantity, TradingProduct product, DerivedQuote derivedQuote)</TD></TR><TR><TD CLASS="l">429</TD><TD>    throws DataValidationException</TD></TR><TR><TD CLASS="l">430</TD><TD>    {        </TD></TR><TR CLASS="z"><TD CLASS="l">431</TD><TD>        StrategyLegTradeContainer legTradeContainer = null;</TD></TR><TR CLASS="z"><TD CLASS="l">432</TD><TD>        if (legsHaveOnlyContingentOnTop(product, derivedQuote)) {</TD></TR><TR CLASS="z"><TD CLASS="l">433</TD><TD>            legTradeContainer = createLegTradeContainerWithContingency(side,price,maxQuantity,minQuantity,product,derivedQuote);</TD></TR><TR><TD CLASS="l">434</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">435</TD><TD>        if (legTradeContainer == null ||</TD></TR><TR><TD CLASS="l">436</TD><TD>            ! legTradeContainer.getCanTradeWithLegs()) //either no contingent on top or can not trade with contingency</TD></TR><TR><TD CLASS="l">437</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">438</TD><TD>            legTradeContainer = createLegTradeContainerWithNonContingency(side, price, minQuantity, product, derivedQuote);</TD></TR><TR><TD CLASS="l">439</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">440</TD><TD>        return legTradeContainer;</TD></TR><TR><TD CLASS="l">441</TD><TD>    }        </TD></TR><TR><TD CLASS="l">442</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="19">443</A></TD><TD>    private static StrategyLegTradeContainer createLegTradeContainerWithContingency(</TD></TR><TR><TD CLASS="l">444</TD><TD>            Side side, Price price, int maxQuantity, int minQuantity, TradingProduct product, DerivedQuote derivedQuote)</TD></TR><TR><TD CLASS="l">445</TD><TD>    throws DataValidationException</TD></TR><TR><TD CLASS="l">446</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">447</TD><TD>        StrategyLegTradeContainer legTradeContainer = new StrategyLegTradeContainer();</TD></TR><TR><TD CLASS="l">448</TD><TD>        Price[] prices;</TD></TR><TR CLASS="z"><TD CLASS="l">449</TD><TD>        Side otherSide = side.getOtherSide();</TD></TR><TR CLASS="z"><TD CLASS="l">450</TD><TD>        if (canTradeWithLegMaxContingency(side, price, maxQuantity, minQuantity ,derivedQuote)){</TD></TR><TR CLASS="z"><TD CLASS="l">451</TD><TD>            legTradeContainer.setTradable(getMaxContingencyDerivedTradableOnSide(derivedQuote, otherSide));</TD></TR><TR CLASS="z"><TD CLASS="l">452</TD><TD>            legTradeContainer.setQuantity(legTradeContainer.getTradable().getMaxQuantity());</TD></TR><TR CLASS="z"><TD CLASS="l">453</TD><TD>            prices = derivedQuote.getMaxContingencyLegPrices(otherSide);</TD></TR><TR CLASS="z"><TD CLASS="l">454</TD><TD>            legTradeContainer.setLegPrices(createStrategyLegTradePrices(product,prices));</TD></TR><TR CLASS="z"><TD CLASS="l">455</TD><TD>            legTradeContainer.setUseContingentBest(true);</TD></TR><TR CLASS="z"><TD CLASS="l">456</TD><TD>            legTradeContainer.setCanTradeWithLegs(true);</TD></TR><TR><TD CLASS="l">457</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">458</TD><TD>        else if (canTradeWithLegMinContingency(side, price, maxQuantity, minQuantity ,derivedQuote)) {</TD></TR><TR CLASS="z"><TD CLASS="l">459</TD><TD>            legTradeContainer.setTradable(getMinContingencyDerivedTradableOnSide(derivedQuote, otherSide));</TD></TR><TR CLASS="z"><TD CLASS="l">460</TD><TD>            legTradeContainer.setQuantity(legTradeContainer.getTradable().getMaxQuantity());</TD></TR><TR CLASS="z"><TD CLASS="l">461</TD><TD>            prices = derivedQuote.getMinContingencyLegPrices(otherSide);</TD></TR><TR CLASS="z"><TD CLASS="l">462</TD><TD>            legTradeContainer.setLegPrices(createStrategyLegTradePrices(product,prices));</TD></TR><TR CLASS="z"><TD CLASS="l">463</TD><TD>            legTradeContainer.setUseContingentBest(true);</TD></TR><TR CLASS="z"><TD CLASS="l">464</TD><TD>            legTradeContainer.setCanTradeWithLegs(true);</TD></TR><TR><TD CLASS="l">465</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">466</TD><TD>        return legTradeContainer;</TD></TR><TR><TD CLASS="l">467</TD><TD>    }</TD></TR><TR><TD CLASS="l">468</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="1a">469</A></TD><TD>    private static StrategyLegTradeContainer createLegTradeContainerWithNonContingency(</TD></TR><TR><TD CLASS="l">470</TD><TD>            Side side, Price price, int minQuantity, TradingProduct product, DerivedQuote derivedQuote)</TD></TR><TR><TD CLASS="l">471</TD><TD>    throws DataValidationException</TD></TR><TR><TD CLASS="l">472</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">473</TD><TD>        StrategyLegTradeContainer legTradeContainer = new StrategyLegTradeContainer();</TD></TR><TR><TD CLASS="l">474</TD><TD>        Price[] prices;</TD></TR><TR CLASS="z"><TD CLASS="l">475</TD><TD>        Side otherSide = side.getOtherSide();</TD></TR><TR CLASS="z"><TD CLASS="l">476</TD><TD>        if (canTradeWithLegNonContingency(side, price, minQuantity ,derivedQuote)){</TD></TR><TR CLASS="z"><TD CLASS="l">477</TD><TD>            legTradeContainer.setTradable(getDerivedTradableOnSide(derivedQuote, otherSide));</TD></TR><TR CLASS="z"><TD CLASS="l">478</TD><TD>            legTradeContainer.setQuantity(legTradeContainer.getTradable().getQuantity());</TD></TR><TR CLASS="z"><TD CLASS="l">479</TD><TD>            prices = derivedQuote.getNonContingencyLegPrices(otherSide);</TD></TR><TR CLASS="z"><TD CLASS="l">480</TD><TD>            legTradeContainer.setLegPrices(createStrategyLegTradePrices(product, prices));</TD></TR><TR CLASS="z"><TD CLASS="l">481</TD><TD>            legTradeContainer.setCanTradeWithLegs(true);</TD></TR><TR><TD CLASS="l">482</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">483</TD><TD>        return legTradeContainer;</TD></TR><TR><TD CLASS="l">484</TD><TD>    }</TD></TR><TR><TD CLASS="l">485</TD><TD> </TD></TR><TR><TD CLASS="l">486</TD><TD>   /**</TD></TR><TR><TD CLASS="l">487</TD><TD>    * Return true if one of the leg's book has only contingent order on top    </TD></TR><TR><TD CLASS="l"><A NAME="51">488</A></TD><TD>    */</TD></TR><TR><TD CLASS="l">489</TD><TD>    private static boolean legsHaveOnlyContingentOnTop(TradingProduct product, DerivedQuote derivedQuote)</TD></TR><TR><TD CLASS="l">490</TD><TD>    throws DataValidationException</TD></TR><TR><TD CLASS="l">491</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">492</TD><TD>        if(!product.isStrategy()) {</TD></TR><TR CLASS="z"><TD CLASS="l">493</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">494</TD><TD>        }        </TD></TR><TR CLASS="z"><TD CLASS="l">495</TD><TD>        boolean result = derivedQuote.isVCOnlyOnTop();</TD></TR><TR CLASS="z"><TD CLASS="l">496</TD><TD>       return result;</TD></TR><TR><TD CLASS="l">497</TD><TD>   }</TD></TR><TR><TD CLASS="l">498</TD><TD>    /**</TD></TR><TR><TD CLASS="l">499</TD><TD>    * create StrategyLegTradePrices</TD></TR><TR><TD CLASS="l">500</TD><TD>    */</TD></TR><TR><TD CLASS="l">501</TD><TD>    public static StrategyLegTradePrice[] createStrategyLegTradePrices(TradingProduct aSpreadProd, Price[] aLegPrices)</TD></TR><TR><TD CLASS="l"><A NAME="1c">502</A></TD><TD>    throws DataValidationException</TD></TR><TR><TD CLASS="l">503</TD><TD>    {</TD></TR><TR><TD CLASS="l">504</TD><TD>        try</TD></TR><TR><TD CLASS="l">505</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">506</TD><TD>            final ProductStaticInfo spreadInfo = ((TradingProductImpl)aSpreadProd).getProdInfo();</TD></TR><TR CLASS="z"><TD CLASS="l">507</TD><TD>            if (spreadInfo.type != ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">508</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">509</TD><TD>                throw ExceptionBuilder.dataValidationException(&#34;NewSpreadTradePriceCalculator&gt;&gt;Product is not a strategy&#34;, 0);</TD></TR><TR><TD CLASS="l">510</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">511</TD><TD>            final StrategyLegTradePrice[] result = new StrategyLegTradePrice[spreadInfo.spreadParams.legs.length];</TD></TR><TR CLASS="z"><TD CLASS="l">512</TD><TD>            for (int i = 0; i &lt; spreadInfo.spreadParams.legs.length; i++)</TD></TR><TR><TD CLASS="l">513</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">514</TD><TD>                result[i] = new StrategyLegTradePriceImpl(spreadInfo.spreadParams.legs[i], aLegPrices[i]);</TD></TR><TR><TD CLASS="l">515</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">516</TD><TD>            return result;</TD></TR><TR><TD CLASS="l">517</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">518</TD><TD>        catch (NotFoundException ne)</TD></TR><TR><TD CLASS="l">519</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">520</TD><TD>            Log.exception(ne);</TD></TR><TR CLASS="z"><TD CLASS="l">521</TD><TD>            throw ExceptionBuilder.dataValidationException(&#34;Could not locate leg product informaion&#34;, 0);</TD></TR><TR><TD CLASS="l">522</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">523</TD><TD>        catch (SystemException se)</TD></TR><TR><TD CLASS="l">524</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">525</TD><TD>            Log.exception(se);</TD></TR><TR CLASS="z"><TD CLASS="l">526</TD><TD>            throw ExceptionBuilder.dataValidationException(&#34;Could not create leg price due to SystemException -- &#34;+se.getMessage(), 0);</TD></TR><TR><TD CLASS="l">527</TD><TD>        }</TD></TR><TR><TD CLASS="l">528</TD><TD>    }</TD></TR><TR><TD CLASS="l">529</TD><TD>    </TD></TR><TR><TD CLASS="l">530</TD><TD>    public static final StrategyLegTradePrice[] calculateTradePriceForLegs(</TD></TR><TR><TD CLASS="l">531</TD><TD>        DerivedQuote dq, TradingProduct aSpreadProd, Price aSpreadTradePrice, HashSet&lt;Integer&gt; aParticipantsQuantities)</TD></TR><TR><TD CLASS="l"><A NAME="8">532</A></TD><TD>    throws SpreadProcessingException,DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">533</TD><TD>    {</TD></TR><TR><TD CLASS="l">534</TD><TD>        try</TD></TR><TR><TD CLASS="l">535</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">536</TD><TD>            final AllocationContext context = new AllocationContextImpl();</TD></TR><TR><TD CLASS="l">537</TD><TD>            /*</TD></TR><TR><TD CLASS="l">538</TD><TD>             * The following piece of code is to create a new instance of the Derived quote and cache it.</TD></TR><TR><TD CLASS="l">539</TD><TD>             * This will make sure whatever DerivedQuote object that is set in the context </TD></TR><TR><TD CLASS="l">540</TD><TD>             * will not be cleared.</TD></TR><TR><TD CLASS="l">541</TD><TD>             *</TD></TR><TR><TD CLASS="l">542</TD><TD>             * Introduced a &#34;clear&#34; method in Derived quote to minimize object creation and hence</TD></TR><TR><TD CLASS="l">543</TD><TD>             * this &#34;logic?&#34; is needed to make sure what is set in the context is not cleared.</TD></TR><TR><TD CLASS="l">544</TD><TD>             */</TD></TR><TR><TD CLASS="l">545</TD><TD>            try</TD></TR><TR><TD CLASS="l">546</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">547</TD><TD>                context.setContext(AllocationContext.CURRENT_DQ, dq);</TD></TR><TR CLASS="z"><TD CLASS="l">548</TD><TD>                aSpreadProd.resetDerivedQuote();</TD></TR><TR><TD CLASS="l">549</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">550</TD><TD>            catch (Exception e)</TD></TR><TR><TD CLASS="l">551</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">552</TD><TD>                Log.exception(&#34;Unable to create DQ: &#34;,  e);</TD></TR><TR CLASS="z"><TD CLASS="l">553</TD><TD>                Log.alarm(&#34;Unable to set Derived quote in the context, setting the that is passed in&#34;);</TD></TR><TR><TD CLASS="l">554</TD><TD>                //context.setContext(AllocationContext.CURRENT_DQ, dq);</TD></TR><TR CLASS="z"><TD CLASS="l">555</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">556</TD><TD>            return SpreadTradeLegPriceCalculator.getInstance().calculateTradePriceForLegs((TradingProductImpl)aSpreadProd, aSpreadTradePrice, aParticipantsQuantities, context);</TD></TR><TR><TD CLASS="l">557</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">558</TD><TD>        catch (NotFoundException ne)</TD></TR><TR><TD CLASS="l">559</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">560</TD><TD>            Log.exception(ne);</TD></TR><TR CLASS="z"><TD CLASS="l">561</TD><TD>            throw ExceptionBuilder.dataValidationException(&#34;Could not locate leg product informaion&#34;, 0);</TD></TR><TR><TD CLASS="l">562</TD><TD>        }</TD></TR><TR><TD CLASS="l">563</TD><TD>    }</TD></TR><TR><TD CLASS="l">564</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="b">565</A></TD><TD>    public static final StrategyLegTradePrice[] calculateTradePriceForLegs(</TD></TR><TR><TD CLASS="l">566</TD><TD>            TradingProduct aSpreadProd, Price aSpreadTradePrice, Set&lt;Integer&gt; aParticipantsQuantities, boolean isTBForCOB)</TD></TR><TR><TD CLASS="l">567</TD><TD>        throws SpreadProcessingException,DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">568</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">569</TD><TD>            AllocationContext context = null;</TD></TR><TR CLASS="z"><TD CLASS="l">570</TD><TD>            if(isTBForCOB)</TD></TR><TR><TD CLASS="l">571</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">572</TD><TD>                    context = new AllocationContextImpl();</TD></TR><TR CLASS="z"><TD CLASS="l">573</TD><TD>                    context.setContext(AllocationContext.BYPASS_PENNY_BETTER_CHECK, new Boolean(&#34;true&#34;));</TD></TR><TR><TD CLASS="l">574</TD><TD>            }</TD></TR><TR><TD CLASS="l">575</TD><TD>        try</TD></TR><TR><TD CLASS="l">576</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">577</TD><TD>           return SpreadTradeLegPriceCalculator.getInstance().calculateTradePriceForLegs((TradingProductImpl)aSpreadProd, aSpreadTradePrice, aParticipantsQuantities, context);</TD></TR><TR><TD CLASS="l">578</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">579</TD><TD>        catch (NotFoundException ne)</TD></TR><TR><TD CLASS="l">580</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">581</TD><TD>            Log.exception(ne);</TD></TR><TR CLASS="z"><TD CLASS="l">582</TD><TD>            throw ExceptionBuilder.dataValidationException(&#34;Could not locate leg product informaion&#34;, 0);</TD></TR><TR><TD CLASS="l">583</TD><TD>        }</TD></TR><TR><TD CLASS="l">584</TD><TD>    }</TD></TR><TR><TD CLASS="l">585</TD><TD>    </TD></TR><TR><TD CLASS="l">586</TD><TD>    public static final StrategyLegTradePrice[] calculateTradePriceForLegs(</TD></TR><TR><TD CLASS="l">587</TD><TD>            TradingProduct aSpreadProd, Price aSpreadTradePrice, Set&lt;Integer&gt; aParticipantsQuantities, AllocationContext context)</TD></TR><TR><TD CLASS="l"><A NAME="9">588</A></TD><TD>        throws SpreadProcessingException,DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">589</TD><TD>    {</TD></TR><TR><TD CLASS="l">590</TD><TD>        try</TD></TR><TR><TD CLASS="l">591</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">592</TD><TD>            return SpreadTradeLegPriceCalculator.getInstance().calculateTradePriceForLegs((TradingProductImpl)aSpreadProd, aSpreadTradePrice, aParticipantsQuantities, context);</TD></TR><TR><TD CLASS="l">593</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">594</TD><TD>        catch (NotFoundException ne)</TD></TR><TR><TD CLASS="l">595</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">596</TD><TD>            Log.exception(ne);</TD></TR><TR CLASS="z"><TD CLASS="l">597</TD><TD>            throw ExceptionBuilder.dataValidationException(&#34;Could not locate leg product informaion&#34;, 0);</TD></TR><TR><TD CLASS="l">598</TD><TD>        }</TD></TR><TR><TD CLASS="l">599</TD><TD>    }</TD></TR><TR><TD CLASS="l">600</TD><TD>    </TD></TR><TR><TD CLASS="l">601</TD><TD>    public static final StrategyLegTradePrice[] calculateTradePriceForLegs(</TD></TR><TR><TD CLASS="l">602</TD><TD>            TradingProduct aSpreadProd, Price startingPrice, Set&lt;Integer&gt; aParticipantsQuantities, AllocationContext context,</TD></TR><TR><TD CLASS="l">603</TD><TD>            Price endPrice, int direction)</TD></TR><TR><TD CLASS="l"><A NAME="a">604</A></TD><TD>        throws SpreadProcessingException,DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">605</TD><TD>    {</TD></TR><TR><TD CLASS="l">606</TD><TD>        try</TD></TR><TR><TD CLASS="l">607</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">608</TD><TD>            return SpreadTradeLegPriceCalculator.getInstance().calculateTradePriceForLegs((TradingProductImpl)aSpreadProd, startingPrice, aParticipantsQuantities, context, endPrice, direction);</TD></TR><TR><TD CLASS="l">609</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">610</TD><TD>        catch (NotFoundException ne)</TD></TR><TR><TD CLASS="l">611</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">612</TD><TD>            Log.exception(ne);</TD></TR><TR CLASS="z"><TD CLASS="l">613</TD><TD>            throw ExceptionBuilder.dataValidationException(&#34;Could not locate leg product informaion&#34;, 0);</TD></TR><TR><TD CLASS="l">614</TD><TD>        }</TD></TR><TR><TD CLASS="l">615</TD><TD>    }</TD></TR><TR><TD CLASS="l">616</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="57">617</A></TD><TD>    private static final double epsilon = 0.000001;</TD></TR><TR><TD CLASS="l">618</TD><TD>    </TD></TR><TR><TD CLASS="l">619</TD><TD>    public static final double getPrecision()</TD></TR><TR><TD CLASS="l">620</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l">621</TD><TD>        return epsilon;</TD></TR><TR><TD CLASS="l">622</TD><TD>    }</TD></TR><TR><TD CLASS="l">623</TD><TD>    </TD></TR><TR><TD CLASS="l">624</TD><TD>    /**</TD></TR><TR><TD CLASS="l">625</TD><TD>     * determine if a price is outside the derived quote</TD></TR><TR><TD CLASS="l">626</TD><TD>     *</TD></TR><TR><TD CLASS="l">627</TD><TD>     * Note: DerivedQuote has two sides: AsDefined and Opposite sides. The prices for</TD></TR><TR><TD CLASS="l">628</TD><TD>     * both sides are represented by signed number. Negative means a debt. And positive</TD></TR><TR><TD CLASS="l">629</TD><TD>     * means a credit. Let b the price for AsDefined side, and a the price for Opposite</TD></TR><TR><TD CLASS="l">630</TD><TD>     * side. It is assumed that: b + a &gt; 0. (If b + a &lt;= 0, then the derived quote is crossed).</TD></TR><TR><TD CLASS="l">631</TD><TD>     *</TD></TR><TR><TD CLASS="l">632</TD><TD>     * 1. A price p for AsDefined side is said to be outside the derived quote if</TD></TR><TR><TD CLASS="l">633</TD><TD>     *    p &lt; -a, or p &gt; b</TD></TR><TR><TD CLASS="l">634</TD><TD>     * 2. A price p for Opposite side is said to be outside the derived quote if</TD></TR><TR><TD CLASS="l"><A NAME="4e">635</A></TD><TD>     *    p &lt; -b, or p &gt; a</TD></TR><TR><TD CLASS="l">636</TD><TD>     */</TD></TR><TR><TD CLASS="l">637</TD><TD>     public static final boolean isOutSideDerivedQuote(Price aPrice, Side aSide, DerivedQuote aDerivedQuote)</TD></TR><TR><TD CLASS="l">638</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">639</TD><TD>         return aDerivedQuote.isOutDerivedQuote(aPrice, aSide);</TD></TR><TR><TD CLASS="l"><A NAME="38">640</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">641</TD><TD>                 </TD></TR><TR><TD CLASS="l">642</TD><TD>     public static final OrderRoutingDestination getORDRoutingProxy()</TD></TR><TR><TD CLASS="l">643</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">644</TD><TD>         OrderRoutingDestinationHome ordRPHome = null;</TD></TR><TR CLASS="z"><TD CLASS="l">645</TD><TD>         if (ordRP == null) {</TD></TR><TR><TD CLASS="l">646</TD><TD>             try</TD></TR><TR><TD CLASS="l">647</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">648</TD><TD>                 ordRPHome = (OrderRoutingDestinationHome) HomeFactory.getInstance().findHome(OrderRoutingDestinationHome.ROUTING_PROXY_HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">649</TD><TD>                 if (ordRPHome == null)</TD></TR><TR><TD CLASS="l">650</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">651</TD><TD>                     Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get RoutingPrxyORDHome&#34;);</TD></TR><TR><TD CLASS="l">652</TD><TD>                 }</TD></TR><TR><TD CLASS="l">653</TD><TD>                 else</TD></TR><TR><TD CLASS="l">654</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">655</TD><TD>                     ordRP = ordRPHome.find();</TD></TR><TR><TD CLASS="l">656</TD><TD>                 }</TD></TR><TR><TD CLASS="l">657</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">658</TD><TD>             catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">659</TD><TD>                 Log.exception(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get RoutingPrxyORD&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">660</TD><TD>             }</TD></TR><TR><TD CLASS="l">661</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">662</TD><TD>         return ordRP;</TD></TR><TR><TD CLASS="l"><A NAME="30">663</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">664</TD><TD>     </TD></TR><TR><TD CLASS="l">665</TD><TD>     public static final OrderRoutingDestination getLocalOrd()</TD></TR><TR><TD CLASS="l">666</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">667</TD><TD>         OrderRoutingDestinationHome ordHome = null;</TD></TR><TR CLASS="z"><TD CLASS="l">668</TD><TD>         if (localOrd == null) {</TD></TR><TR><TD CLASS="l">669</TD><TD>             try</TD></TR><TR><TD CLASS="l">670</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">671</TD><TD>                 ordHome = (OrderRoutingDestinationHome) HomeFactory.getInstance().findHome(OrderRoutingDestinationHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">672</TD><TD>                 if (ordHome == null)</TD></TR><TR><TD CLASS="l">673</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">674</TD><TD>                     Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get ORDHome&#34;);</TD></TR><TR><TD CLASS="l">675</TD><TD>                 }</TD></TR><TR><TD CLASS="l">676</TD><TD>                 else</TD></TR><TR><TD CLASS="l">677</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">678</TD><TD>                     localOrd = ordHome.find();</TD></TR><TR><TD CLASS="l">679</TD><TD>                 }</TD></TR><TR><TD CLASS="l">680</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">681</TD><TD>             catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">682</TD><TD>                 Log.exception(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get local ORD&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">683</TD><TD>             }</TD></TR><TR><TD CLASS="l">684</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">685</TD><TD>         return localOrd;</TD></TR><TR><TD CLASS="l"><A NAME="39">686</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">687</TD><TD>     </TD></TR><TR><TD CLASS="l">688</TD><TD>     public static final OHSOrderMaintenanceService getOhsOmsProxy()</TD></TR><TR><TD CLASS="l">689</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">690</TD><TD>         OHSOrderMaintenanceServiceHome omsRPHome = null;</TD></TR><TR CLASS="z"><TD CLASS="l">691</TD><TD>         if (omsRP == null) {</TD></TR><TR><TD CLASS="l">692</TD><TD>             try</TD></TR><TR><TD CLASS="l">693</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">694</TD><TD>                 omsRPHome = (OHSOrderMaintenanceServiceHome) HomeFactory.getInstance().findHome(OHSOrderMaintenanceServiceHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">695</TD><TD>                 if (omsRPHome == null)</TD></TR><TR><TD CLASS="l">696</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">697</TD><TD>                     Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get OMSRPHome&#34;);</TD></TR><TR><TD CLASS="l">698</TD><TD>                 }</TD></TR><TR><TD CLASS="l">699</TD><TD>                 else</TD></TR><TR><TD CLASS="l">700</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">701</TD><TD>                     omsRP = omsRPHome.find();</TD></TR><TR><TD CLASS="l">702</TD><TD>                 }</TD></TR><TR><TD CLASS="l">703</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">704</TD><TD>             catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">705</TD><TD>                 Log.exception(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get local OMSRP&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">706</TD><TD>             }</TD></TR><TR><TD CLASS="l">707</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">708</TD><TD>         return omsRP;</TD></TR><TR><TD CLASS="l"><A NAME="3a">709</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">710</TD><TD>     </TD></TR><TR><TD CLASS="l">711</TD><TD>     public static final OrderIdGeneratorHome getOrderIdHome()</TD></TR><TR><TD CLASS="l">712</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">713</TD><TD>         if (orderIdHome == null) {</TD></TR><TR><TD CLASS="l">714</TD><TD>             try</TD></TR><TR><TD CLASS="l">715</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">716</TD><TD>                 orderIdHome = (OrderIdGeneratorHome) HomeFactory.getInstance().findHome(OrderIdGeneratorHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">717</TD><TD>                 if (orderIdHome == null)</TD></TR><TR><TD CLASS="l">718</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">719</TD><TD>                     Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get OrderIdGeneratorHome&#34;);</TD></TR><TR><TD CLASS="l">720</TD><TD>                 }</TD></TR><TR><TD CLASS="l">721</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">722</TD><TD>             catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">723</TD><TD>                 Log.exception(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get OrderIdGeneratorHome&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">724</TD><TD>             }</TD></TR><TR><TD CLASS="l">725</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">726</TD><TD>         return orderIdHome;</TD></TR><TR><TD CLASS="l"><A NAME="3b">727</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">728</TD><TD>     </TD></TR><TR><TD CLASS="l">729</TD><TD>     public static final OrderRelationshipService getOrderRelationshipHome()</TD></TR><TR><TD CLASS="l">730</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">731</TD><TD>         OrderRelationshipServiceHome orsh = null;</TD></TR><TR CLASS="z"><TD CLASS="l">732</TD><TD>         if (ors == null) {</TD></TR><TR><TD CLASS="l">733</TD><TD>             try</TD></TR><TR><TD CLASS="l">734</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">735</TD><TD>                 orsh = (OrderRelationshipServiceHome) HomeFactory.getInstance().findHome(OrderRelationshipServiceHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">736</TD><TD>                 if (orsh == null)</TD></TR><TR><TD CLASS="l">737</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">738</TD><TD>                     Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get OrderRelationshipServiceHome&#34;);</TD></TR><TR><TD CLASS="l">739</TD><TD>                 }</TD></TR><TR><TD CLASS="l">740</TD><TD>                 else</TD></TR><TR><TD CLASS="l">741</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">742</TD><TD>                     ors = orsh.find();</TD></TR><TR><TD CLASS="l">743</TD><TD>                 }</TD></TR><TR><TD CLASS="l">744</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">745</TD><TD>             catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">746</TD><TD>                 Log.exception(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get OrderRelationshipService&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">747</TD><TD>             }</TD></TR><TR><TD CLASS="l">748</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">749</TD><TD>         return ors;</TD></TR><TR><TD CLASS="l">750</TD><TD>     }</TD></TR><TR><TD CLASS="l">751</TD><TD>     </TD></TR><TR><TD CLASS="l">752</TD><TD>     /**</TD></TR><TR><TD CLASS="l">753</TD><TD>      * Retrieves the &lt;code&gt;TradeService&lt;/code&gt;</TD></TR><TR><TD CLASS="l">754</TD><TD>      *</TD></TR><TR><TD CLASS="l"><A NAME="48">755</A></TD><TD>      * @return                     TradeService</TD></TR><TR><TD CLASS="l">756</TD><TD>      * @since              Increment 3a</TD></TR><TR><TD CLASS="l">757</TD><TD>      */</TD></TR><TR><TD CLASS="l">758</TD><TD>     public static final TradeService getTradeService(TradingProduct product) {</TD></TR><TR CLASS="z"><TD CLASS="l">759</TD><TD>         TradeService aTradeService = null;    </TD></TR><TR><TD CLASS="l">760</TD><TD>         try {</TD></TR><TR CLASS="z"><TD CLASS="l">761</TD><TD>                 TradeServiceHome tradeServiceHome = (TradeServiceHome) HomeFactory.getInstance().findHome(TradeServiceHome.HOME_NAME);</TD></TR><TR CLASS="z"><TD CLASS="l">762</TD><TD>                 if (tradeServiceHome != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">763</TD><TD>                     aTradeService = tradeServiceHome.find(product);</TD></TR><TR><TD CLASS="l">764</TD><TD>                 }</TD></TR><TR><TD CLASS="l">765</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">766</TD><TD>             catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">767</TD><TD>                 Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Unable to get TradeService&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">768</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="47">769</A></TD><TD>         return aTradeService;</TD></TR><TR><TD CLASS="l">770</TD><TD>     }</TD></TR><TR><TD CLASS="l">771</TD><TD>     </TD></TR><TR><TD CLASS="l">772</TD><TD>     public static final TradeReportHome getTradeReportHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">773</TD><TD>         if (tradeReportHome == null)</TD></TR><TR><TD CLASS="l">774</TD><TD>        {</TD></TR><TR><TD CLASS="l">775</TD><TD>            try</TD></TR><TR><TD CLASS="l">776</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">777</TD><TD>                tradeReportHome = (TradeReportHome) HomeFactory.getInstance().findHome(TradeReportHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">778</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">779</TD><TD>            catch (Exception e)</TD></TR><TR><TD CLASS="l">780</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">781</TD><TD>                Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Cannot find TradeReport home: &#34; + e);</TD></TR><TR CLASS="z"><TD CLASS="l">782</TD><TD>            }</TD></TR><TR><TD CLASS="l">783</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">784</TD><TD>        return tradeReportHome;</TD></TR><TR><TD CLASS="l">785</TD><TD>    }</TD></TR><TR><TD CLASS="l">786</TD><TD>     </TD></TR><TR><TD CLASS="l">787</TD><TD>    /////////////////////////////////////////////////////////////</TD></TR><TR><TD CLASS="l"><A NAME="15">788</A></TD><TD>     </TD></TR><TR><TD CLASS="l">789</TD><TD>     public static final ProductStaticInfo[] convertLegs(TradingProduct spread)</TD></TR><TR><TD CLASS="l">790</TD><TD>     throws NotFoundException, SystemException, DataValidationException</TD></TR><TR><TD CLASS="l">791</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">792</TD><TD>             TradingStrategyLeg[] legDefs = spread.getStrategyLegs();</TD></TR><TR><TD CLASS="l">793</TD><TD> </TD></TR><TR><TD CLASS="l">794</TD><TD>         TradingProduct tp;</TD></TR><TR CLASS="z"><TD CLASS="l">795</TD><TD>         ProductStaticInfo[] prods = new ProductStaticInfo[legDefs.length];</TD></TR><TR><TD CLASS="l">796</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">797</TD><TD>         for (int i = 0; i &lt; legDefs.length; i++)</TD></TR><TR><TD CLASS="l">798</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">799</TD><TD>             tp = legDefs[i].getTradingProduct();</TD></TR><TR CLASS="z"><TD CLASS="l">800</TD><TD>             if (spread.hasProductLock())</TD></TR><TR><TD CLASS="l">801</TD><TD>             {</TD></TR><TR><TD CLASS="l">802</TD><TD>             }</TD></TR><TR><TD CLASS="l">803</TD><TD>             else</TD></TR><TR><TD CLASS="l">804</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">805</TD><TD>                 prods[i] = convert(tp);</TD></TR><TR><TD CLASS="l">806</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">807</TD><TD>             if (prods[i] == null)</TD></TR><TR CLASS="z"><TD CLASS="l">808</TD><TD>                 prods[i] = convert(legDefs[i].getProductKey(), tp);</TD></TR><TR><TD CLASS="l">809</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">810</TD><TD>         return prods;</TD></TR><TR><TD CLASS="l">811</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="14">812</A></TD><TD> </TD></TR><TR><TD CLASS="l">813</TD><TD>     public static final ProductStaticInfo[] convertLegs(List&lt;ProductLegData&gt; legDefs)</TD></TR><TR><TD CLASS="l">814</TD><TD>     throws NotFoundException, SystemException, DataValidationException</TD></TR><TR><TD CLASS="l">815</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">816</TD><TD>         ProductStaticInfo[] prods = new ProductStaticInfo[legDefs.size()];</TD></TR><TR><TD CLASS="l">817</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">818</TD><TD>         for (int i = 0; i &lt; legDefs.size(); i++)</TD></TR><TR><TD CLASS="l">819</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">820</TD><TD>             prods[i] = convert(legDefs.get(i).getProductKey());</TD></TR><TR><TD CLASS="l">821</TD><TD>         }</TD></TR><TR><TD CLASS="l">822</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">823</TD><TD>         return prods;</TD></TR><TR><TD CLASS="l">824</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="11">825</A></TD><TD> </TD></TR><TR><TD CLASS="l">826</TD><TD>     public static final ProductStaticInfo convert(TradingProduct tp)</TD></TR><TR><TD CLASS="l">827</TD><TD>     throws NotFoundException, SystemException, DataValidationException</TD></TR><TR><TD CLASS="l">828</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">829</TD><TD>         if (tp == null) return null;</TD></TR><TR><TD CLASS="l">830</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">831</TD><TD>         ProductData prodData = getProductData(tp.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">832</TD><TD>         ProductClassData classData = getProductClassData(prodData.getClassKey());</TD></TR><TR><TD CLASS="l">833</TD><TD>         //ReportingClassData rptClass = getReportingClassData(prodData.getRptClassKey());</TD></TR><TR CLASS="z"><TD CLASS="l">834</TD><TD>         ProductStaticInfo prod = new ProductStaticInfo(tp, prodData, classData); //, rptClass);</TD></TR><TR><TD CLASS="l">835</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">836</TD><TD>         String[] sessionName = TradingSessionNameHelper.getConfiguredSessionNames();</TD></TR><TR><TD CLASS="l">837</TD><TD>         </TD></TR><TR><TD CLASS="l">838</TD><TD>//         Log.information(&#34;StrategyTradeServiceHelper: convert(). Session name for product: &#34; + tp.getProductKey() + </TD></TR><TR><TD CLASS="l">839</TD><TD>//                 &#34;/&#34; + tp.getTradingClass().getProductType() + &#34; is &#34; + (sessionName != null ? sessionName[0] : &#34;NULL!&#34;));</TD></TR><TR><TD CLASS="l">840</TD><TD>         </TD></TR><TR CLASS="z"><TD CLASS="l">841</TD><TD>         prod.setActiveSessionAndExchange(sessionName[0], getExchangeForSession(sessionName[0]));</TD></TR><TR><TD CLASS="l">842</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">843</TD><TD>         if (prod.type == ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">844</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">845</TD><TD>             prod.spreadParams = new SpreadKeyParameters(prod, tp);</TD></TR><TR><TD CLASS="l">846</TD><TD>         }</TD></TR><TR><TD CLASS="l">847</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">848</TD><TD>         return prod;</TD></TR><TR><TD CLASS="l">849</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="12">850</A></TD><TD> </TD></TR><TR><TD CLASS="l">851</TD><TD>     public static final ProductStaticInfo convert(int prodKey)</TD></TR><TR><TD CLASS="l">852</TD><TD>     throws NotFoundException, SystemException, DataValidationException</TD></TR><TR><TD CLASS="l">853</TD><TD>     {       </TD></TR><TR CLASS="z"><TD CLASS="l">854</TD><TD>         return convert(prodKey, null);</TD></TR><TR><TD CLASS="l">855</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="13">856</A></TD><TD> </TD></TR><TR><TD CLASS="l">857</TD><TD>     private static final ProductStaticInfo convert(int prodKey, TradingProduct tradingProduct)</TD></TR><TR><TD CLASS="l">858</TD><TD>     throws NotFoundException, SystemException, DataValidationException</TD></TR><TR><TD CLASS="l">859</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">860</TD><TD>         ProductData prodData = getProductData(prodKey);</TD></TR><TR CLASS="z"><TD CLASS="l">861</TD><TD>         ProductClassData classData = getProductClassData(prodData.getClassKey());</TD></TR><TR><TD CLASS="l">862</TD><TD>         //ReportingClassData rptClass = getReportingClassData(prodData.getRptClassKey());</TD></TR><TR CLASS="z"><TD CLASS="l">863</TD><TD>         ProductStaticInfo prod = new ProductStaticInfo(tradingProduct, prodData, classData); //, rptClass);</TD></TR><TR><TD CLASS="l">864</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">865</TD><TD>         if (prod.type == ProductTypes.STRATEGY)</TD></TR><TR><TD CLASS="l">866</TD><TD>         {</TD></TR><TR><TD CLASS="l">867</TD><TD>               //prod.spreadParams = new SpreadKeyParameters(prodData);</TD></TR><TR CLASS="z"><TD CLASS="l">868</TD><TD>             throw ExceptionBuilder.dataValidationException(&#34;Currently no support for spread which are not in the same session as its parent!!&#34;, 0);</TD></TR><TR><TD CLASS="l">869</TD><TD>         }</TD></TR><TR><TD CLASS="l">870</TD><TD>         </TD></TR><TR CLASS="z"><TD CLASS="l">871</TD><TD>         final String sessionName = getActiveSessionName(classData);</TD></TR><TR CLASS="z"><TD CLASS="l">872</TD><TD>         prod.setActiveSessionAndExchange(sessionName, getExchangeForSession(sessionName));</TD></TR><TR><TD CLASS="l">873</TD><TD>         </TD></TR><TR CLASS="z"><TD CLASS="l">874</TD><TD>         return prod;</TD></TR><TR><TD CLASS="l"><A NAME="2c">875</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">876</TD><TD>     </TD></TR><TR><TD CLASS="l">877</TD><TD>     private static String getExchangeForSession(String p_sessionName)</TD></TR><TR><TD CLASS="l">878</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">879</TD><TD>         TradingSessionStruct rval = TradingSessionNameHelper.getSession(p_sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">880</TD><TD>         return rval != null ? rval.exchangeAcronym : &#34;&#34;;</TD></TR><TR><TD CLASS="l">881</TD><TD>         </TD></TR><TR><TD CLASS="l">882</TD><TD>         // return TradingSessionNameHelper.getSession(p_sessionName).exchangeAcronym;</TD></TR><TR><TD CLASS="l"><A NAME="2e">883</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">884</TD><TD> </TD></TR><TR><TD CLASS="l">885</TD><TD>     public static final LegMarketDetailStruct[] getLegMarkets(LegKeyParameters[] legs) throws SystemException</TD></TR><TR><TD CLASS="l">886</TD><TD>     {        </TD></TR><TR CLASS="z"><TD CLASS="l">887</TD><TD>         LegMarketDetailStruct[] legMarkets = new LegMarketDetailStruct[legs.length];</TD></TR><TR CLASS="z"><TD CLASS="l">888</TD><TD>         LegMarketDetailStruct[] tempLM = null;</TD></TR><TR CLASS="z"><TD CLASS="l">889</TD><TD>         List&lt;Integer&gt; tempList = null;</TD></TR><TR><TD CLASS="l">890</TD><TD>         </TD></TR><TR CLASS="z"><TD CLASS="l">891</TD><TD>         Map&lt;String, List&lt;Integer&gt;&gt; legProductSessionMap = new HashMap&lt;String, List&lt;Integer&gt;&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">892</TD><TD>         Map&lt;Integer, List&lt;Integer&gt;&gt; legProdKeys = new HashMap&lt;Integer, List&lt;Integer&gt;&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">893</TD><TD>         getUniqueSessionProducts(legs, legProductSessionMap, legProdKeys);</TD></TR><TR><TD CLASS="l">894</TD><TD>         </TD></TR><TR CLASS="z"><TD CLASS="l">895</TD><TD>         for (String sessionName : legProductSessionMap.keySet())</TD></TR><TR><TD CLASS="l">896</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">897</TD><TD>             tempList = legProductSessionMap.get(sessionName);</TD></TR><TR><TD CLASS="l">898</TD><TD>             </TD></TR><TR CLASS="z"><TD CLASS="l">899</TD><TD>             int[] temp = new int[tempList.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">900</TD><TD>             int i = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">901</TD><TD>             for (Integer key : tempList)</TD></TR><TR><TD CLASS="l">902</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">903</TD><TD>                 temp[i] = key;</TD></TR><TR CLASS="z"><TD CLASS="l">904</TD><TD>                 i++;</TD></TR><TR><TD CLASS="l">905</TD><TD>             }</TD></TR><TR><TD CLASS="l">906</TD><TD>             try</TD></TR><TR><TD CLASS="l">907</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">908</TD><TD>                 tempLM = getMarketDataServiceRoutingHome().find().getLegMarketDetailForProducts(</TD></TR><TR><TD CLASS="l">909</TD><TD>                         sessionName, temp);</TD></TR><TR><TD CLASS="l">910</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">911</TD><TD>             catch (Exception e)</TD></TR><TR><TD CLASS="l">912</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">913</TD><TD>                 Log.exception(&#34;Failed to get current markets for session=&#34; + sessionName</TD></TR><TR><TD CLASS="l">914</TD><TD>                         + &#34;; product keys=&#34; + tempList, e);</TD></TR><TR CLASS="z"><TD CLASS="l">915</TD><TD>                 throw ExceptionBuilder.systemException(&#34;Failed to get current markets for session=&#34; + sessionName</TD></TR><TR><TD CLASS="l">916</TD><TD>                         + &#34;; product keys=&#34; + tempList, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">917</TD><TD>             }</TD></TR><TR><TD CLASS="l">918</TD><TD>             </TD></TR><TR CLASS="z"><TD CLASS="l">919</TD><TD>             for (i = 0; i &lt; temp.length; i++)</TD></TR><TR><TD CLASS="l">920</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">921</TD><TD>                 tempList = legProdKeys.get(temp[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">922</TD><TD>                 for (Integer legIndex : tempList)</TD></TR><TR><TD CLASS="l">923</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">924</TD><TD>                     legMarkets[legIndex] = tempLM[i];</TD></TR><TR><TD CLASS="l">925</TD><TD>                 }</TD></TR><TR><TD CLASS="l">926</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">927</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">928</TD><TD>         return legMarkets;</TD></TR><TR><TD CLASS="l">929</TD><TD>     }</TD></TR><TR><TD CLASS="l">930</TD><TD>     </TD></TR><TR><TD CLASS="l"><A NAME="4c">931</A></TD><TD>     private static final void getUniqueSessionProducts(LegKeyParameters[] legs, Map&lt;String, List&lt;Integer&gt;&gt; legProductSessionMap, Map&lt;Integer, List&lt;Integer&gt;&gt; legProdKeys )</TD></TR><TR><TD CLASS="l">932</TD><TD>     throws SystemException</TD></TR><TR><TD CLASS="l">933</TD><TD>     {</TD></TR><TR><TD CLASS="l">934</TD><TD>         String legSession;</TD></TR><TR CLASS="z"><TD CLASS="l">935</TD><TD>         for (int i = 0; i &lt; legs.length; i++)</TD></TR><TR><TD CLASS="l">936</TD><TD>         { </TD></TR><TR CLASS="z"><TD CLASS="l">937</TD><TD>             legSession = legs[i].legProd.getActiveSession();</TD></TR><TR CLASS="z"><TD CLASS="l">938</TD><TD>             mapProdToLeg(legProdKeys, legs[i].legProd.productKeyInteger, i);</TD></TR><TR CLASS="z"><TD CLASS="l">939</TD><TD>             addToLegProductSessionMap(legProductSessionMap, legSession, legs[i].legProd.productKeyInteger);</TD></TR><TR><TD CLASS="l">940</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="52">941</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">942</TD><TD>     </TD></TR><TR><TD CLASS="l">943</TD><TD>     private static final void mapProdToLeg(Map&lt;Integer, List&lt;Integer&gt;&gt; legProdKeys, Integer prodKey, int legIndex)</TD></TR><TR><TD CLASS="l">944</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">945</TD><TD>         List&lt;Integer&gt; legList = legProdKeys.get(prodKey);</TD></TR><TR CLASS="z"><TD CLASS="l">946</TD><TD>         if (legList == null)</TD></TR><TR><TD CLASS="l">947</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">948</TD><TD>             legList = new ArrayList&lt;Integer&gt;(1);</TD></TR><TR CLASS="z"><TD CLASS="l">949</TD><TD>             legProdKeys.put(prodKey, legList);</TD></TR><TR><TD CLASS="l">950</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">951</TD><TD>         if (legList.contains(legIndex))</TD></TR><TR><TD CLASS="l">952</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">953</TD><TD>             return;</TD></TR><TR><TD CLASS="l">954</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">955</TD><TD>         legList.add(legIndex);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="7">956</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">957</TD><TD>     </TD></TR><TR><TD CLASS="l">958</TD><TD>     private static final void addToLegProductSessionMap(Map&lt;String, List&lt;Integer&gt;&gt; legProductSessionMap, String sessionName, Integer prodKey)</TD></TR><TR><TD CLASS="l">959</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">960</TD><TD>         List&lt;Integer&gt; keyList = legProductSessionMap.get(sessionName);</TD></TR><TR CLASS="z"><TD CLASS="l">961</TD><TD>         if (keyList == null)</TD></TR><TR><TD CLASS="l">962</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">963</TD><TD>             keyList = new ArrayList&lt;Integer&gt;(1);</TD></TR><TR CLASS="z"><TD CLASS="l">964</TD><TD>             legProductSessionMap.put(sessionName, keyList);</TD></TR><TR><TD CLASS="l">965</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">966</TD><TD>         if (keyList.contains(prodKey))</TD></TR><TR><TD CLASS="l">967</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">968</TD><TD>             return;</TD></TR><TR><TD CLASS="l">969</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">970</TD><TD>         keyList.add(prodKey);</TD></TR><TR CLASS="z"><TD CLASS="l">971</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="25">972</A></TD><TD>     </TD></TR><TR><TD CLASS="l">973</TD><TD>     public static final CurrentMarketCacheHomeImpl getCurrentMarketCacheHome()</TD></TR><TR><TD CLASS="l">974</TD><TD>     throws SystemException</TD></TR><TR><TD CLASS="l">975</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">976</TD><TD>         if (CurrentMarketCacheHome == null)             </TD></TR><TR><TD CLASS="l">977</TD><TD>         {</TD></TR><TR><TD CLASS="l">978</TD><TD>             try</TD></TR><TR><TD CLASS="l">979</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">980</TD><TD>                 CurrentMarketCacheHome = (CurrentMarketCacheHomeImpl) HomeFactory.getInstance().findHome(</TD></TR><TR><TD CLASS="l">981</TD><TD>                         CurrentMarketCacheHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">982</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">983</TD><TD>             catch (Exception e)</TD></TR><TR><TD CLASS="l">984</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">985</TD><TD>                 Log.exception(&#34;DerivedQuoteUtil: Failed to instantiate CurrentMarketCacheHome...&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">986</TD><TD>                 throw ExceptionBuilder.systemException(&#34;STSH: Failed to instantiate CurrentMarketCacheHome...&#34;, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">987</TD><TD>             }</TD></TR><TR><TD CLASS="l">988</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">989</TD><TD>         return CurrentMarketCacheHome;</TD></TR><TR><TD CLASS="l">990</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="32">991</A></TD><TD> </TD></TR><TR><TD CLASS="l">992</TD><TD>     public static final MarketDataServiceHomeImpl getMarketDataServiceHome()</TD></TR><TR><TD CLASS="l">993</TD><TD>     throws SystemException</TD></TR><TR><TD CLASS="l">994</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">995</TD><TD>         if (marketDataServiceHome == null)             </TD></TR><TR><TD CLASS="l">996</TD><TD>         {</TD></TR><TR><TD CLASS="l">997</TD><TD>             try</TD></TR><TR><TD CLASS="l">998</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">999</TD><TD>                 marketDataServiceHome = (MarketDataServiceHomeImpl) HomeFactory.getInstance().findHome(</TD></TR><TR><TD CLASS="l">1000</TD><TD>                         MarketDataServiceHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">1001</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1002</TD><TD>             catch (Exception e)</TD></TR><TR><TD CLASS="l">1003</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1004</TD><TD>                 Log.exception(&#34;DerivedQuoteUtil: Failed to instantiate MarketDataServiceHome...&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">1005</TD><TD>                 throw ExceptionBuilder.systemException(&#34;DerivedQuoteUtil: Failed to instantiate MarketDataServiceRoutingProxyHome...&#34;, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">1006</TD><TD>             }</TD></TR><TR><TD CLASS="l">1007</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1008</TD><TD>         return marketDataServiceHome;</TD></TR><TR><TD CLASS="l">1009</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="33">1010</A></TD><TD> </TD></TR><TR><TD CLASS="l">1011</TD><TD>     public static final MarketDataServiceHome getMarketDataServiceRoutingHome()</TD></TR><TR><TD CLASS="l">1012</TD><TD>     throws SystemException</TD></TR><TR><TD CLASS="l">1013</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1014</TD><TD>         if (marketDataServiceRoutingHome == null)             </TD></TR><TR><TD CLASS="l">1015</TD><TD>         {</TD></TR><TR><TD CLASS="l">1016</TD><TD>             try</TD></TR><TR><TD CLASS="l">1017</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1018</TD><TD>                 marketDataServiceRoutingHome = (MarketDataServiceHome) HomeFactory.getInstance().findHome(</TD></TR><TR><TD CLASS="l">1019</TD><TD>                         MarketDataServiceHome.ROUTING_PROXY_HOME_NAME);</TD></TR><TR><TD CLASS="l">1020</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1021</TD><TD>             catch (Exception e)</TD></TR><TR><TD CLASS="l">1022</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1023</TD><TD>                 Log.exception(&#34;DerivedQuoteUtil: Failed to instantiate MarketDataServiceRoutingProxyHome...&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">1024</TD><TD>                 throw ExceptionBuilder.systemException(&#34;DerivedQuoteUtil: Failed to instantiate MarketDataServiceRoutingProxyHome...&#34;, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">1025</TD><TD>             }</TD></TR><TR><TD CLASS="l">1026</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="31">1027</A></TD><TD>         return marketDataServiceRoutingHome;</TD></TR><TR><TD CLASS="l">1028</TD><TD>     }</TD></TR><TR><TD CLASS="l">1029</TD><TD>     </TD></TR><TR><TD CLASS="l">1030</TD><TD>     public static final MarketDataHome getMarketDataHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">1031</TD><TD>         if (marketDataHome == null) {</TD></TR><TR><TD CLASS="l">1032</TD><TD>             try {</TD></TR><TR CLASS="z"><TD CLASS="l">1033</TD><TD>                 marketDataHome = (MarketDataHome) HomeFactory.getInstance().findHome(MarketDataHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">1034</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1035</TD><TD>             catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1036</TD><TD>                 Log.alarm(&#34;Unable to get home for market data: &#34; + e);</TD></TR><TR CLASS="z"><TD CLASS="l">1037</TD><TD>             }</TD></TR><TR><TD CLASS="l">1038</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1039</TD><TD>         return marketDataHome;</TD></TR><TR><TD CLASS="l">1040</TD><TD>     }</TD></TR><TR><TD CLASS="l">1041</TD><TD>     </TD></TR><TR><TD CLASS="l">1042</TD><TD>     public static final ProcessStrategyLegsCommand createProcessStrategyLegsCommand(Order strategyOrder,</TD></TR><TR><TD CLASS="l">1043</TD><TD>             Broker broker, DerivedQuote derivedQuote, TradingProduct strategyProd, AuctionInternal auction)</TD></TR><TR><TD CLASS="l"><A NAME="1b">1044</A></TD><TD>     throws DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">1045</TD><TD>     {</TD></TR><TR><TD CLASS="l">1046</TD><TD>         try</TD></TR><TR><TD CLASS="l">1047</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1048</TD><TD>             return new ProcessStrategyLegsCommand(strategyOrder,</TD></TR><TR><TD CLASS="l">1049</TD><TD>                     derivedQuote, (TradingProductImpl)strategyProd, auction);</TD></TR><TR><TD CLASS="l">1050</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1051</TD><TD>         catch (NotFoundException ne)</TD></TR><TR><TD CLASS="l">1052</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1053</TD><TD>             Log.exception(ne);</TD></TR><TR CLASS="z"><TD CLASS="l">1054</TD><TD>             throw ExceptionBuilder.dataValidationException(&#34;Could not locate leg product informaion&#34;, 0);</TD></TR><TR><TD CLASS="l">1055</TD><TD>         }</TD></TR><TR><TD CLASS="l">1056</TD><TD>     }</TD></TR><TR><TD CLASS="l">1057</TD><TD>     </TD></TR><TR><TD CLASS="l">1058</TD><TD>     ////////////////////////////////////////////////</TD></TR><TR><TD CLASS="l"><A NAME="24">1059</A></TD><TD>     </TD></TR><TR><TD CLASS="l">1060</TD><TD>     public static final int getContractSize(int reportingClassKey)</TD></TR><TR><TD CLASS="l">1061</TD><TD>     throws NotFoundException, SystemException</TD></TR><TR><TD CLASS="l">1062</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1063</TD><TD>         ReportingClassData reportingClass = getReportingClassData(reportingClassKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1064</TD><TD>         return reportingClass.getContractSize();</TD></TR><TR><TD CLASS="l">1065</TD><TD>     }</TD></TR><TR><TD CLASS="l">1066</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="1d">1067</A></TD><TD>     public static final String getActiveSessionName(ProductClassData productClass) throws SystemException</TD></TR><TR><TD CLASS="l">1068</TD><TD>     {</TD></TR><TR><TD CLASS="l">1069</TD><TD>         //CRITICALFIX</TD></TR><TR><TD CLASS="l">1070</TD><TD>         String legSession;</TD></TR><TR CLASS="z"><TD CLASS="l">1071</TD><TD>         if (productClass.getSessionNames().length==0)</TD></TR><TR><TD CLASS="l">1072</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1073</TD><TD>             throw ExceptionBuilder.systemException(</TD></TR><TR><TD CLASS="l">1074</TD><TD>                 &#34;No session for leg product &#34;+productClass.getClassKey()</TD></TR><TR><TD CLASS="l">1075</TD><TD>                 +&#34; / &#34;+productClass.getClassSymbol(), 0);</TD></TR><TR><TD CLASS="l">1076</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1077</TD><TD>         legSession = productClass.getSessionNames()[0];</TD></TR><TR CLASS="z"><TD CLASS="l">1078</TD><TD>         return legSession;</TD></TR><TR><TD CLASS="l">1079</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="34">1080</A></TD><TD> </TD></TR><TR><TD CLASS="l">1081</TD><TD>     </TD></TR><TR><TD CLASS="l">1082</TD><TD>     public static final int getMaxBestVcQuantity(MarketVolumeStruct[] categorizedVolume)</TD></TR><TR><TD CLASS="l">1083</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1084</TD><TD>         if (categorizedVolume == null) return 0;</TD></TR><TR><TD CLASS="l">1085</TD><TD>         //TODO: The way cross product leg trading is implemented makes this MIN/MAX not necessary</TD></TR><TR><TD CLASS="l">1086</TD><TD>         //      but need total review of the DQ implementation. Leave it as 0 for now</TD></TR><TR><TD CLASS="l">1087</TD><TD>         //TODO: leave it out for now, because the following code exists in BestBook.getContingent***QuantityMax</TD></TR><TR><TD CLASS="l">1088</TD><TD>         //      and we do not want to have the logic in 2 places</TD></TR><TR><TD CLASS="l">1089</TD><TD>         //Besides, we do not have MIN quantity here anyway, just mock it up to the same 0 as MIN quantities</TD></TR><TR CLASS="z"><TD CLASS="l">1090</TD><TD>         int maxQty = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1091</TD><TD>         for (int i=0; i&lt;categorizedVolume.length; i++)</TD></TR><TR><TD CLASS="l">1092</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1093</TD><TD>             if (categorizedVolume[i].volumeType == VolumeTypes.AON)</TD></TR><TR><TD CLASS="l">1094</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1095</TD><TD>                 maxQty +=categorizedVolume[i].quantity;</TD></TR><TR><TD CLASS="l">1096</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1097</TD><TD>             else if (categorizedVolume[i].volumeType == VolumeTypes.FOK)</TD></TR><TR><TD CLASS="l">1098</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1099</TD><TD>                 maxQty +=categorizedVolume[i].quantity;</TD></TR><TR><TD CLASS="l">1100</TD><TD>             }</TD></TR><TR><TD CLASS="l">1101</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1102</TD><TD>         return maxQty;</TD></TR><TR><TD CLASS="l"><A NAME="45">1103</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">1104</TD><TD>     </TD></TR><TR><TD CLASS="l">1105</TD><TD>     public static final int getTotalNonVcSize(MarketVolumeStruct[] categorizedVolume)</TD></TR><TR><TD CLASS="l">1106</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1107</TD><TD>         if (categorizedVolume == null) return 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1108</TD><TD>         int totalQty = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1109</TD><TD>         for (int i=0; i&lt;categorizedVolume.length; i++)</TD></TR><TR><TD CLASS="l">1110</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1111</TD><TD>             if (categorizedVolume[i].volumeType == VolumeTypes.AON)</TD></TR><TR><TD CLASS="l">1112</TD><TD>             {</TD></TR><TR><TD CLASS="l">1113</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1114</TD><TD>             else if (categorizedVolume[i].volumeType == VolumeTypes.FOK)</TD></TR><TR><TD CLASS="l">1115</TD><TD>             {</TD></TR><TR><TD CLASS="l">1116</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1117</TD><TD>             else if (categorizedVolume[i].volumeType == VolumeTypes.ODD_LOT)</TD></TR><TR><TD CLASS="l">1118</TD><TD>             {</TD></TR><TR><TD CLASS="l">1119</TD><TD>             }</TD></TR><TR><TD CLASS="l">1120</TD><TD>             else</TD></TR><TR><TD CLASS="l">1121</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1122</TD><TD>                 totalQty +=categorizedVolume[i].quantity;</TD></TR><TR><TD CLASS="l">1123</TD><TD>             }</TD></TR><TR><TD CLASS="l">1124</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1125</TD><TD>         return totalQty;</TD></TR><TR><TD CLASS="l"><A NAME="10">1126</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">1127</TD><TD>     </TD></TR><TR><TD CLASS="l">1128</TD><TD>     public static final int combineNBBOVolumeFromExchanges(ExchangeVolumeStruct[] exchangeVols, int localNBBOSize, String localExchange)</TD></TR><TR><TD CLASS="l">1129</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1130</TD><TD>         int vol = localNBBOSize==-1 ? 0 : localNBBOSize;</TD></TR><TR CLASS="z"><TD CLASS="l">1131</TD><TD>         if (exchangeVols == null) return vol;</TD></TR><TR CLASS="z"><TD CLASS="l">1132</TD><TD>         for (ExchangeVolumeStruct exVol : exchangeVols)</TD></TR><TR><TD CLASS="l">1133</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1134</TD><TD>             if (localNBBOSize&gt;=0 &amp;&amp; exVol.exchange == localExchange)</TD></TR><TR CLASS="z"><TD CLASS="l">1135</TD><TD>                 continue;</TD></TR><TR CLASS="z"><TD CLASS="l">1136</TD><TD>             vol += exVol.volume;</TD></TR><TR><TD CLASS="l">1137</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1138</TD><TD>         return vol;</TD></TR><TR><TD CLASS="l"><A NAME="2f">1139</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">1140</TD><TD>     </TD></TR><TR><TD CLASS="l">1141</TD><TD>     public static final int getLocalNBBOVolume(ExchangeVolumeStruct[] exchangeVols, String localExchange)</TD></TR><TR><TD CLASS="l">1142</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1143</TD><TD>         if (exchangeVols == null) return 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1144</TD><TD>         for (ExchangeVolumeStruct exVol : exchangeVols)</TD></TR><TR><TD CLASS="l">1145</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1146</TD><TD>             if (exVol.exchange == localExchange)</TD></TR><TR CLASS="z"><TD CLASS="l">1147</TD><TD>                return exVol.volume;</TD></TR><TR><TD CLASS="l">1148</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1149</TD><TD>         return 0;</TD></TR><TR><TD CLASS="l">1150</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="3f">1151</A></TD><TD>     </TD></TR><TR><TD CLASS="l">1152</TD><TD>     public static final ProductDataCacheHome getProductDataCacheHome()</TD></TR><TR><TD CLASS="l">1153</TD><TD>     throws SystemException</TD></TR><TR><TD CLASS="l">1154</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1155</TD><TD>         if (productCacheHome == null)</TD></TR><TR><TD CLASS="l">1156</TD><TD>         {</TD></TR><TR><TD CLASS="l">1157</TD><TD>             try</TD></TR><TR><TD CLASS="l">1158</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1159</TD><TD>                 productCacheHome = (ProductDataCacheHome)HomeFactory.getInstance().findHome(ProductDataCacheHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">1160</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1161</TD><TD>             catch (CBOELoggableException e)</TD></TR><TR><TD CLASS="l">1162</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1163</TD><TD>                 Log.exception(&#34;DerivedQuoteUtil: Failed to instantiate ProductCacheHome...&#34;, e);</TD></TR><TR CLASS="z"><TD CLASS="l">1164</TD><TD>                 throw ExceptionBuilder.systemException(&#34;DerivedQuoteUtil: Failed to instantiate ProductCacheHome...&#34;, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">1165</TD><TD>             }</TD></TR><TR><TD CLASS="l">1166</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1167</TD><TD>         return productCacheHome;</TD></TR><TR><TD CLASS="l">1168</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="3e">1169</A></TD><TD> </TD></TR><TR><TD CLASS="l">1170</TD><TD>     public static final ProductData getProductData(int prodKey)</TD></TR><TR><TD CLASS="l">1171</TD><TD>     throws NotFoundException, SystemException</TD></TR><TR><TD CLASS="l">1172</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1173</TD><TD>         return getProductDataCacheHome().find().getProductData(prodKey);</TD></TR><TR><TD CLASS="l">1174</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="3d">1175</A></TD><TD> </TD></TR><TR><TD CLASS="l">1176</TD><TD>     public static final ProductClassData getProductClassData(int classKey)</TD></TR><TR><TD CLASS="l">1177</TD><TD>     throws NotFoundException, SystemException</TD></TR><TR><TD CLASS="l">1178</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1179</TD><TD>         return getProductDataCacheHome().find().getProductClassData(classKey);</TD></TR><TR><TD CLASS="l">1180</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="40">1181</A></TD><TD> </TD></TR><TR><TD CLASS="l">1182</TD><TD>     public static final ReportingClassData getReportingClassData(int reportingClassKey)</TD></TR><TR><TD CLASS="l">1183</TD><TD>     throws NotFoundException, SystemException</TD></TR><TR><TD CLASS="l">1184</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="4b">1185</A></TD><TD>         return getProductDataCacheHome().find().getReportingClassData(reportingClassKey);</TD></TR><TR><TD CLASS="l">1186</TD><TD>     }</TD></TR><TR><TD CLASS="l">1187</TD><TD> </TD></TR><TR><TD CLASS="l">1188</TD><TD>     public static final TradingSessionHome getTradingSessionHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">1189</TD><TD>         if (tradingSessionHome == null) {</TD></TR><TR><TD CLASS="l">1190</TD><TD>             try {</TD></TR><TR CLASS="z"><TD CLASS="l">1191</TD><TD>                 tradingSessionHome = (TradingSessionHome) HomeFactory.getInstance().findHome(TradingSessionHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">1192</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1193</TD><TD>             catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1194</TD><TD>                 Log.alarm(&#34;Unable to get home for session element classes: &#34; + e);</TD></TR><TR CLASS="z"><TD CLASS="l">1195</TD><TD>             }</TD></TR><TR><TD CLASS="l">1196</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1197</TD><TD>         return tradingSessionHome;</TD></TR><TR><TD CLASS="l"><A NAME="58">1198</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">1199</TD><TD>     </TD></TR><TR><TD CLASS="l">1200</TD><TD>     public static final boolean isNonDerivitive(short prodType)</TD></TR><TR><TD CLASS="l">1201</TD><TD>     {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="0">1202</A></TD><TD>         return prodType == ProductTypes.EQUITY || prodType == ProductTypes.INDEX;</TD></TR><TR><TD CLASS="l">1203</TD><TD>     }</TD></TR><TR><TD CLASS="l">1204</TD><TD>     </TD></TR><TR><TD CLASS="l">1205</TD><TD>     </TD></TR><TR CLASS="z"><TD CLASS="l">1206</TD><TD>     public static enum LegComponentReturnType {SMALL_RATIO,LARGE_RATIO,EQUITY_RATIO,INDEX_RATIO,</TD></TR><TR CLASS="z"><TD CLASS="l">1207</TD><TD>                                                SMALL_PRODKEY,LARGE_PRODKEY,EQUITY_PRODKEY,INDEX_PRODKEY};</TD></TR><TR><TD CLASS="l">1208</TD><TD> </TD></TR><TR><TD CLASS="l">1209</TD><TD>     public static double getSmallestLegComponentByRatio(LegKeyParameters[] legInfo, short legType, LegComponentReturnType legComponent)</TD></TR><TR><TD CLASS="l"><A NAME="41">1210</A></TD><TD>     {</TD></TR><TR><TD CLASS="l">1211</TD><TD>         //Depending on what legType and component is passed in</TD></TR><TR><TD CLASS="l">1212</TD><TD>         //the returning int will be what was ordered</TD></TR><TR><TD CLASS="l">1213</TD><TD>         </TD></TR><TR CLASS="z"><TD CLASS="l">1214</TD><TD>         double equityLegRatio = Double.MIN_VALUE;</TD></TR><TR CLASS="z"><TD CLASS="l">1215</TD><TD>         int equityLegKey = Integer.MIN_VALUE;</TD></TR><TR CLASS="z"><TD CLASS="l">1216</TD><TD>         double indexLegRatio = Double.MIN_VALUE;</TD></TR><TR CLASS="z"><TD CLASS="l">1217</TD><TD>         int indexLegKey = Integer.MIN_VALUE;</TD></TR><TR CLASS="z"><TD CLASS="l">1218</TD><TD>         double smallestOptionLegRatio = Double.MAX_VALUE;</TD></TR><TR CLASS="z"><TD CLASS="l">1219</TD><TD>         int smallestOptionLegKey = Integer.MIN_VALUE;</TD></TR><TR CLASS="z"><TD CLASS="l">1220</TD><TD>         double largestOptionLegRatio = Double.MIN_VALUE;</TD></TR><TR CLASS="z"><TD CLASS="l">1221</TD><TD>         int largestOptionLegKey = Integer.MIN_VALUE;</TD></TR><TR><TD CLASS="l">1222</TD><TD>         </TD></TR><TR CLASS="z"><TD CLASS="l">1223</TD><TD>         double component = 0.0d;</TD></TR><TR><TD CLASS="l">1224</TD><TD>         </TD></TR><TR CLASS="z"><TD CLASS="l">1225</TD><TD>         for (LegKeyParameters leg : legInfo)</TD></TR><TR><TD CLASS="l">1226</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1227</TD><TD>             if (leg.legProd.type == ProductTypes.OPTION)</TD></TR><TR><TD CLASS="l">1228</TD><TD>             {        </TD></TR><TR CLASS="z"><TD CLASS="l">1229</TD><TD>                 if (largestOptionLegRatio &lt; leg.legRatioQuantity)</TD></TR><TR><TD CLASS="l">1230</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">1231</TD><TD>                     largestOptionLegRatio = leg.legRatioQuantity;</TD></TR><TR CLASS="z"><TD CLASS="l">1232</TD><TD>                     largestOptionLegKey = leg.legProd.key;</TD></TR><TR><TD CLASS="l">1233</TD><TD>                 }</TD></TR><TR><TD CLASS="l">1234</TD><TD>                 </TD></TR><TR CLASS="z"><TD CLASS="l">1235</TD><TD>                 if (smallestOptionLegRatio &gt; leg.legRatioQuantity)                </TD></TR><TR><TD CLASS="l">1236</TD><TD>                 {</TD></TR><TR CLASS="z"><TD CLASS="l">1237</TD><TD>                     smallestOptionLegRatio = leg.legRatioQuantity;</TD></TR><TR CLASS="z"><TD CLASS="l">1238</TD><TD>                     smallestOptionLegKey = leg.legProd.key;</TD></TR><TR><TD CLASS="l">1239</TD><TD>                 }</TD></TR><TR><TD CLASS="l">1240</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1241</TD><TD>             else if (leg.legProd.type == ProductTypes.EQUITY)</TD></TR><TR><TD CLASS="l">1242</TD><TD>             {</TD></TR><TR><TD CLASS="l">1243</TD><TD>                 //use legPriceRatio due to equity ratio quantity is represented in 100's</TD></TR><TR CLASS="z"><TD CLASS="l">1244</TD><TD>                 equityLegRatio = leg.getLegPriceRatio();</TD></TR><TR CLASS="z"><TD CLASS="l">1245</TD><TD>                 equityLegKey = leg.legProd.key;</TD></TR><TR><TD CLASS="l">1246</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1247</TD><TD>             else if (leg.legProd.type == ProductTypes.INDEX)</TD></TR><TR><TD CLASS="l">1248</TD><TD>             {</TD></TR><TR><TD CLASS="l">1249</TD><TD>                 //use legPriceRatio due to equity ratio quantity is represented in 100's</TD></TR><TR CLASS="z"><TD CLASS="l">1250</TD><TD>                 indexLegRatio = leg.getLegPriceRatio();</TD></TR><TR CLASS="z"><TD CLASS="l">1251</TD><TD>                 indexLegKey = leg.legProd.key;</TD></TR><TR><TD CLASS="l">1252</TD><TD>             }</TD></TR><TR><TD CLASS="l">1253</TD><TD>         }</TD></TR><TR><TD CLASS="l">1254</TD><TD>         </TD></TR><TR CLASS="z"><TD CLASS="l">1255</TD><TD>         if (legType == ProductTypes.OPTION)</TD></TR><TR><TD CLASS="l">1256</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1257</TD><TD>             if (legComponent == LegComponentReturnType.SMALL_PRODKEY)</TD></TR><TR><TD CLASS="l">1258</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1259</TD><TD>                 component = smallestOptionLegKey;</TD></TR><TR><TD CLASS="l">1260</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1261</TD><TD>             else if (legComponent == LegComponentReturnType.SMALL_RATIO)</TD></TR><TR><TD CLASS="l">1262</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1263</TD><TD>                 component = smallestOptionLegRatio; </TD></TR><TR><TD CLASS="l">1264</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1265</TD><TD>             else if (legComponent == LegComponentReturnType.LARGE_PRODKEY)</TD></TR><TR><TD CLASS="l">1266</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1267</TD><TD>                 component = largestOptionLegKey;</TD></TR><TR><TD CLASS="l">1268</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1269</TD><TD>             else if (legComponent == LegComponentReturnType.LARGE_RATIO)</TD></TR><TR><TD CLASS="l">1270</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1271</TD><TD>                 component = largestOptionLegRatio; </TD></TR><TR><TD CLASS="l">1272</TD><TD>             }</TD></TR><TR><TD CLASS="l">1273</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1274</TD><TD>         else  if (legType == ProductTypes.EQUITY)</TD></TR><TR><TD CLASS="l">1275</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1276</TD><TD>             if (legComponent == LegComponentReturnType.EQUITY_PRODKEY)</TD></TR><TR><TD CLASS="l">1277</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1278</TD><TD>                 component = equityLegKey;</TD></TR><TR><TD CLASS="l">1279</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1280</TD><TD>             else if (legComponent == LegComponentReturnType.EQUITY_RATIO)</TD></TR><TR><TD CLASS="l">1281</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1282</TD><TD>                 component = equityLegRatio; </TD></TR><TR><TD CLASS="l">1283</TD><TD>             } </TD></TR><TR><TD CLASS="l">1284</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1285</TD><TD>         else  if (legType == ProductTypes.INDEX)</TD></TR><TR><TD CLASS="l">1286</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1287</TD><TD>             if (legComponent == LegComponentReturnType.INDEX_PRODKEY)</TD></TR><TR><TD CLASS="l">1288</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1289</TD><TD>                 component = indexLegKey;</TD></TR><TR><TD CLASS="l">1290</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1291</TD><TD>             else if (legComponent == LegComponentReturnType.INDEX_RATIO)</TD></TR><TR><TD CLASS="l">1292</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1293</TD><TD>                 component = indexLegRatio; </TD></TR><TR><TD CLASS="l">1294</TD><TD>             } </TD></TR><TR><TD CLASS="l">1295</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1296</TD><TD>       return component;</TD></TR><TR><TD CLASS="l">1297</TD><TD>     }</TD></TR><TR><TD CLASS="l">1298</TD><TD>     </TD></TR><TR><TD CLASS="l">1299</TD><TD>     </TD></TR><TR><TD CLASS="l">1300</TD><TD>     /**</TD></TR><TR><TD CLASS="l">1301</TD><TD>      * check if any of the strategy leg is NBBO</TD></TR><TR><TD CLASS="l">1302</TD><TD>      * @param auction</TD></TR><TR><TD CLASS="l">1303</TD><TD>      * @param product</TD></TR><TR><TD CLASS="l">1304</TD><TD>      * @param dq</TD></TR><TR><TD CLASS="l">1305</TD><TD>      * @return</TD></TR><TR><TD CLASS="l">1306</TD><TD>      * @throws DataValidationException</TD></TR><TR><TD CLASS="l">1307</TD><TD>      */</TD></TR><TR><TD CLASS="l">1308</TD><TD>     public static boolean isStrategyLegNBBO(Order order, TradingProduct product, DerivedQuote dq)</TD></TR><TR><TD CLASS="l"><A NAME="4f">1309</A></TD><TD>         throws DataValidationException, SystemException</TD></TR><TR><TD CLASS="l">1310</TD><TD>     {</TD></TR><TR><TD CLASS="l">1311</TD><TD>         try</TD></TR><TR><TD CLASS="l">1312</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1313</TD><TD>             BestPriceStruct[][] legMarkets = dq.getDQLegMarkets();</TD></TR><TR CLASS="z"><TD CLASS="l">1314</TD><TD>             ProductStaticInfo spreadInfo = ((TradingProductImpl)product).getProdInfo();</TD></TR><TR CLASS="z"><TD CLASS="l">1315</TD><TD>             Side orderSide = order.getSide(); </TD></TR><TR CLASS="z"><TD CLASS="l">1316</TD><TD>             for (int i=0; i&lt;spreadInfo.spreadParams.legs.length; i++)</TD></TR><TR><TD CLASS="l">1317</TD><TD>             {</TD></TR><TR CLASS="z"><TD CLASS="l">1318</TD><TD>                 if (orderSide.isAsDefinedSide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1319</TD><TD>                     if (spreadInfo.spreadParams.legs[i].legSide.isAsDefinedSide() || spreadInfo.spreadParams.legs[i].legSide.isBuySide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1320</TD><TD>                         if (!legMarkets[1][i].isNBBO) return false;</TD></TR><TR><TD CLASS="l">1321</TD><TD>                     } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1322</TD><TD>                         if (!legMarkets[0][i].isNBBO) return false;</TD></TR><TR><TD CLASS="l">1323</TD><TD>                     }</TD></TR><TR><TD CLASS="l">1324</TD><TD>                 } else {  // order is opposite side</TD></TR><TR CLASS="z"><TD CLASS="l">1325</TD><TD>                     if (spreadInfo.spreadParams.legs[i].legSide.isAsDefinedSide() || spreadInfo.spreadParams.legs[i].legSide.isBuySide()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1326</TD><TD>                         if (!legMarkets[0][i].isNBBO) return false;</TD></TR><TR><TD CLASS="l">1327</TD><TD>                     } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1328</TD><TD>                         if (!legMarkets[1][i].isNBBO) return false;</TD></TR><TR><TD CLASS="l">1329</TD><TD>                     }</TD></TR><TR><TD CLASS="l">1330</TD><TD>                 }  </TD></TR><TR><TD CLASS="l">1331</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1332</TD><TD>         }catch(NotFoundException e){</TD></TR><TR CLASS="z"><TD CLASS="l">1333</TD><TD>             Log.exception(e);</TD></TR><TR CLASS="z"><TD CLASS="l">1334</TD><TD>             throw ExceptionBuilder.dataValidationException(&#34;Could not locate leg product informaion&#34;, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">1335</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1336</TD><TD>         return true;</TD></TR><TR><TD CLASS="l">1337</TD><TD>     }</TD></TR><TR><TD CLASS="l">1338</TD><TD>     </TD></TR><TR><TD CLASS="l">1339</TD><TD>     /**</TD></TR><TR><TD CLASS="l">1340</TD><TD>      * Gets the reference to the Derived Quote calculated using cached NBBO data for given product.</TD></TR><TR><TD CLASS="l">1341</TD><TD>      * @author Cognizant Technology Solutions</TD></TR><TR><TD CLASS="l"><A NAME="23">1342</A></TD><TD>      * @param product</TD></TR><TR><TD CLASS="l">1343</TD><TD>      * @return</TD></TR><TR><TD CLASS="l">1344</TD><TD>      */     </TD></TR><TR><TD CLASS="l">1345</TD><TD>     public static final DerivedQuote getCachedDerivedQuote(TradingProduct product) {</TD></TR><TR CLASS="z"><TD CLASS="l">1346</TD><TD>         DerivedQuote derivedQ = null;</TD></TR><TR><TD CLASS="l">1347</TD><TD>         try {</TD></TR><TR CLASS="z"><TD CLASS="l">1348</TD><TD>             derivedQ = product.getCachedDerivedQuote();</TD></TR><TR><TD CLASS="l">1349</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1350</TD><TD>         catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1351</TD><TD>             Log.alarm(&#34;StrategyTradeServiceHelper &gt;&gt;&gt; Failed to calculate derived quote with cached NBBO data, return null for DQ: &#34;+e.getMessage());</TD></TR><TR><TD CLASS="l">1352</TD><TD>             //derived quote can not be calculated. return null;</TD></TR><TR CLASS="z"><TD CLASS="l">1353</TD><TD>         }        </TD></TR><TR CLASS="z"><TD CLASS="l">1354</TD><TD>         return derivedQ;</TD></TR><TR><TD CLASS="l"><A NAME="2d">1355</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">1356</TD><TD>     </TD></TR><TR><TD CLASS="l">1357</TD><TD>     public static int getFirstOptionLegClassKey(TradingProduct tradingProduct)</TD></TR><TR><TD CLASS="l">1358</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1359</TD><TD>         TradingStrategyLeg[] legs = tradingProduct.getStrategyLegs();</TD></TR><TR CLASS="z"><TD CLASS="l">1360</TD><TD>         for (TradingStrategyLeg leg : legs) {</TD></TR><TR CLASS="z"><TD CLASS="l">1361</TD><TD>             if (leg.getTradingProduct().getTradingClass().getProductType() == ProductTypes.OPTION) {</TD></TR><TR CLASS="z"><TD CLASS="l">1362</TD><TD>                 return leg.getTradingProduct().getTradingClass().getProductClassKey();</TD></TR><TR><TD CLASS="l">1363</TD><TD>             }          </TD></TR><TR><TD CLASS="l">1364</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1365</TD><TD>         return 0;</TD></TR><TR><TD CLASS="l"><A NAME="3c">1366</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">1367</TD><TD>     </TD></TR><TR><TD CLASS="l">1368</TD><TD>     public static OrderRoutingParameterStruct getOrderRoutingParameterStructForSpreadEnalbed(TradingProduct tradingProduct)</TD></TR><TR><TD CLASS="l">1369</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1370</TD><TD>         TradingStrategyLeg[] legs = tradingProduct.getStrategyLegs();</TD></TR><TR CLASS="z"><TD CLASS="l">1371</TD><TD>         int classKey = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1372</TD><TD>         for (TradingStrategyLeg leg : legs) {</TD></TR><TR CLASS="z"><TD CLASS="l">1373</TD><TD>             if (leg.getTradingProduct() != null &amp;&amp; leg.getTradingProduct().getTradingClass().getProductType() == ProductTypes.OPTION) {</TD></TR><TR CLASS="z"><TD CLASS="l">1374</TD><TD>                 classKey = leg.getTradingProduct().getTradingClass().getProductClassKey();</TD></TR><TR CLASS="z"><TD CLASS="l">1375</TD><TD>                 break;</TD></TR><TR><TD CLASS="l">1376</TD><TD>             }          </TD></TR><TR><TD CLASS="l">1377</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1378</TD><TD>         OrderRoutingParameterStruct orderRouting = new OrderRoutingParameterStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1379</TD><TD>         orderRouting.sourceType = OrderLocations.TE;</TD></TR><TR CLASS="z"><TD CLASS="l">1380</TD><TD>         orderRouting.source = RouteNameHelper.getRouteName();</TD></TR><TR><TD CLASS="l">1381</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1382</TD><TD>         orderRouting.destination = ConfigurationGroupHelper.getRouteNameForClass(classKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1383</TD><TD>         orderRouting.destinationType = OrderLocations.TE;</TD></TR><TR><TD CLASS="l">1384</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1385</TD><TD>         return orderRouting;</TD></TR><TR><TD CLASS="l">1386</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="22">1387</A></TD><TD>     </TD></TR><TR><TD CLASS="l">1388</TD><TD>     public static OrderBookSummaryStruct[] getBestLegMarketsStructs(TradingProduct tradingProduct) </TD></TR><TR><TD CLASS="l">1389</TD><TD>         throws DataValidationException</TD></TR><TR><TD CLASS="l">1390</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1391</TD><TD>         DerivedQuote dq = getDerivedQuote(tradingProduct);</TD></TR><TR CLASS="z"><TD CLASS="l">1392</TD><TD>         if (dq == null)</TD></TR><TR CLASS="z"><TD CLASS="l">1393</TD><TD>             return new OrderBookSummaryStruct[0];</TD></TR><TR CLASS="z"><TD CLASS="l">1394</TD><TD>         BestPriceStruct[] bestLegMarketsAtDefinedSide = dq.getBestLetMarketsAtDefinedSide();</TD></TR><TR CLASS="z"><TD CLASS="l">1395</TD><TD>         BestPriceStruct[] bestLegMarketsAtOppositeSide = dq.getBestLetMarketsAtOppositeSide();</TD></TR><TR><TD CLASS="l">1396</TD><TD>         // convert BestPriceStruct to IDL struct</TD></TR><TR CLASS="z"><TD CLASS="l">1397</TD><TD>         if (bestLegMarketsAtDefinedSide == null || bestLegMarketsAtDefinedSide.length == 0)</TD></TR><TR CLASS="z"><TD CLASS="l">1398</TD><TD>             return new OrderBookSummaryStruct[0];</TD></TR><TR CLASS="z"><TD CLASS="l">1399</TD><TD>         OrderBookSummaryStruct[] orderBookSummaryStructs = new OrderBookSummaryStruct[bestLegMarketsAtDefinedSide.length];</TD></TR><TR CLASS="z"><TD CLASS="l">1400</TD><TD>         OrderBookSideStruct sideStruct = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1401</TD><TD>         for (int i=0; i&lt;bestLegMarketsAtDefinedSide.length; i++)</TD></TR><TR><TD CLASS="l">1402</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1403</TD><TD>             orderBookSummaryStructs[i] = new OrderBookSummaryStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1404</TD><TD>             sideStruct = copyLegMarkets(bestLegMarketsAtDefinedSide[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">1405</TD><TD>             orderBookSummaryStructs[i].definedSideLegs = sideStruct;</TD></TR><TR CLASS="z"><TD CLASS="l">1406</TD><TD>             sideStruct = copyLegMarkets(bestLegMarketsAtOppositeSide[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">1407</TD><TD>             orderBookSummaryStructs[i].oppositeSideLegs = sideStruct;</TD></TR><TR CLASS="z"><TD CLASS="l">1408</TD><TD>             TradingStrategyLeg legs[] = tradingProduct.getStrategyLegs();</TD></TR><TR CLASS="z"><TD CLASS="l">1409</TD><TD>             for (int j=0; j&lt;legs.length; j++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1410</TD><TD>                 if (sideStruct.productKey != legs[j].getProductKey())</TD></TR><TR CLASS="z"><TD CLASS="l">1411</TD><TD>                     continue;</TD></TR><TR CLASS="z"><TD CLASS="l">1412</TD><TD>                 TradingProduct legProduct = legs[j].getTradingProduct();</TD></TR><TR CLASS="z"><TD CLASS="l">1413</TD><TD>                 if (legProduct == null) {  // equity</TD></TR><TR><TD CLASS="l">1414</TD><TD>                     //CurrentMarketStruct emptyCurrentMarketStruct = StructBuilder.buildCurrentMarketStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1415</TD><TD>                     ProductKeysStruct keysStruct = ProductStructBuilder.buildProductKeysStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1416</TD><TD>                     CurrentMarketStruct emptyCurrentMarketStruct = MarketDataStructBuilder.buildCurrentMarketStruct(keysStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">1417</TD><TD>                     orderBookSummaryStructs[i].legBestMarekt = emptyCurrentMarketStruct;</TD></TR><TR CLASS="z"><TD CLASS="l">1418</TD><TD>                     orderBookSummaryStructs[i].legBestLimitMarket = emptyCurrentMarketStruct;</TD></TR><TR CLASS="z"><TD CLASS="l">1419</TD><TD>                     orderBookSummaryStructs[i].nbboStruct = MarketDataStructBuilder.buildNBBOStruct(keysStruct);</TD></TR><TR CLASS="z"><TD CLASS="l">1420</TD><TD>                 } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1421</TD><TD>                     OrderBookImpl legOrderBook = (OrderBookImpl)legProduct.getOrderBook();</TD></TR><TR CLASS="z"><TD CLASS="l">1422</TD><TD>                     orderBookSummaryStructs[i].legBestMarekt = legOrderBook.toBestMarket(legOrderBook.isLegalMarket());</TD></TR><TR CLASS="z"><TD CLASS="l">1423</TD><TD>                     orderBookSummaryStructs[i].legBestLimitMarket = legOrderBook.toBestLimitMarket(legOrderBook.isLegalMarket());</TD></TR><TR CLASS="z"><TD CLASS="l">1424</TD><TD>                     orderBookSummaryStructs[i].nbboStruct = legProduct.getNBBO(legProduct.getTradingClass().getSessionName());</TD></TR><TR><TD CLASS="l">1425</TD><TD>                 }</TD></TR><TR><TD CLASS="l">1426</TD><TD>             }</TD></TR><TR><TD CLASS="l">1427</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1428</TD><TD>         return orderBookSummaryStructs;</TD></TR><TR><TD CLASS="l">1429</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="2a">1430</A></TD><TD>     </TD></TR><TR><TD CLASS="l">1431</TD><TD>     public static DerivedQuote getDerivedQuoteWithouRefreshLegMarkets(TradingProduct tradingProduct, OrderBookSummaryStruct[] legMarkets)</TD></TR><TR><TD CLASS="l">1432</TD><TD>     {</TD></TR><TR><TD CLASS="l">1433</TD><TD>         // convert IDL struct to BestPriceStruct</TD></TR><TR CLASS="z"><TD CLASS="l">1434</TD><TD>         BestPriceStruct[] definedSideLegMarkets = new BestPriceStruct[legMarkets.length];</TD></TR><TR CLASS="z"><TD CLASS="l">1435</TD><TD>         BestPriceStruct[] oppositeSideLegMarkets = new BestPriceStruct[legMarkets.length];</TD></TR><TR CLASS="z"><TD CLASS="l">1436</TD><TD>         for (int i=0; i&lt;legMarkets.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1437</TD><TD>             definedSideLegMarkets[i] = copyLegMarkets(legMarkets[i].definedSideLegs, SideFactory.getAsDefinedSide());</TD></TR><TR CLASS="z"><TD CLASS="l">1438</TD><TD>             oppositeSideLegMarkets[i] =  copyLegMarkets(legMarkets[i].oppositeSideLegs, SideFactory.getOppositeSide());</TD></TR><TR><TD CLASS="l">1439</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1440</TD><TD>         return getDerivedQuote(tradingProduct, definedSideLegMarkets, oppositeSideLegMarkets);</TD></TR><TR><TD CLASS="l">1441</TD><TD>     }</TD></TR><TR><TD CLASS="l"><A NAME="53">1442</A></TD><TD>     </TD></TR><TR><TD CLASS="l">1443</TD><TD>     public static void refreshLegsCurrentMarketCache(OrderBookSummaryStruct[] legMarkets) </TD></TR><TR><TD CLASS="l">1444</TD><TD>         throws SystemException</TD></TR><TR><TD CLASS="l">1445</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1446</TD><TD>         ArrayList&lt;CurrentMarketStruct&gt; bestMarketsList = new ArrayList&lt;CurrentMarketStruct&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1447</TD><TD>         ArrayList&lt;CurrentMarketStruct&gt; bestLimitMarketsList = new ArrayList&lt;CurrentMarketStruct&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1448</TD><TD>         ArrayList&lt;NBBOStruct&gt; nbboList = new ArrayList&lt;NBBOStruct&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1449</TD><TD>         for (int i=0; i&lt; legMarkets.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1450</TD><TD>             if (legMarkets[i].legBestMarekt.productKeys.productKey == 0)  // ignore no update leg</TD></TR><TR CLASS="z"><TD CLASS="l">1451</TD><TD>                 continue;</TD></TR><TR CLASS="z"><TD CLASS="l">1452</TD><TD>             bestMarketsList.add(legMarkets[i].legBestMarekt);</TD></TR><TR CLASS="z"><TD CLASS="l">1453</TD><TD>             bestLimitMarketsList.add(legMarkets[i].legBestLimitMarket);</TD></TR><TR CLASS="z"><TD CLASS="l">1454</TD><TD>             nbboList.add(legMarkets[i].nbboStruct);</TD></TR><TR><TD CLASS="l">1455</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1456</TD><TD>         CurrentMarketStruct[] bestMarkets = new CurrentMarketStruct[bestMarketsList.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">1457</TD><TD>         CurrentMarketStruct[] bestLimitMarkets = new CurrentMarketStruct[bestLimitMarketsList.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">1458</TD><TD>         NBBOStruct[] nbbos = new NBBOStruct[nbboList.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">1459</TD><TD>         bestMarketsList.toArray(bestMarkets);</TD></TR><TR CLASS="z"><TD CLASS="l">1460</TD><TD>         bestLimitMarketsList.toArray(bestLimitMarkets);</TD></TR><TR CLASS="z"><TD CLASS="l">1461</TD><TD>         nbboList.toArray(nbbos);</TD></TR><TR CLASS="z"><TD CLASS="l">1462</TD><TD>         getCurrentMarketCacheHome().acceptCurrentMarketsForLegs(null, bestMarkets, bestLimitMarkets, nbbos, new CurrentMarketStructV2[0], new CurrentMarketStruct[0], new CurrentMarketStruct[0]);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="16">1463</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">1464</TD><TD>     </TD></TR><TR><TD CLASS="l">1465</TD><TD>     public static OrderBookSideStruct copyLegMarkets(BestPriceStruct bestPriceStruct)</TD></TR><TR><TD CLASS="l">1466</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1467</TD><TD>         OrderBookSideStruct sideStruct = new OrderBookSideStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1468</TD><TD>         sideStruct.bestContingencyMaxVol = bestPriceStruct.bvcqMax;</TD></TR><TR CLASS="z"><TD CLASS="l">1469</TD><TD>         sideStruct.bestContingencyMinVol = bestPriceStruct.bvcqMin;</TD></TR><TR CLASS="z"><TD CLASS="l">1470</TD><TD>         sideStruct.bestPrice = bestPriceStruct.bp.toStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1471</TD><TD>         sideStruct.bestPriceQuantity = bestPriceStruct.bq;</TD></TR><TR CLASS="z"><TD CLASS="l">1472</TD><TD>         sideStruct.bestVolumeContingencyIsOnTop = bestPriceStruct.bvcOnTop;</TD></TR><TR CLASS="z"><TD CLASS="l">1473</TD><TD>         sideStruct.bestVolumeContingencyOnlyOnTop = bestPriceStruct.bvcOnlyOnTop;</TD></TR><TR CLASS="z"><TD CLASS="l">1474</TD><TD>         sideStruct.bestVolumeContingencyPrice = bestPriceStruct.bvc.toStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1475</TD><TD>         sideStruct.isNBBO = bestPriceStruct.isNBBO;</TD></TR><TR CLASS="z"><TD CLASS="l">1476</TD><TD>         sideStruct.isVolumeContingencyNBBO = bestPriceStruct.isVcNBBO;</TD></TR><TR CLASS="z"><TD CLASS="l">1477</TD><TD>         sideStruct.lastSale = bestPriceStruct.lastSale.toStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1478</TD><TD>         sideStruct.nbbo = bestPriceStruct.nbbo.toStruct();</TD></TR><TR CLASS="z"><TD CLASS="l">1479</TD><TD>         sideStruct.nbboVol = bestPriceStruct.nbboVol;</TD></TR><TR CLASS="z"><TD CLASS="l">1480</TD><TD>         sideStruct.side = bestPriceStruct.side.toSideValue();</TD></TR><TR CLASS="z"><TD CLASS="l">1481</TD><TD>         sideStruct.productKey = bestPriceStruct.productKey;</TD></TR><TR CLASS="z"><TD CLASS="l">1482</TD><TD>         return sideStruct;</TD></TR><TR><TD CLASS="l"><A NAME="17">1483</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">1484</TD><TD>     </TD></TR><TR><TD CLASS="l">1485</TD><TD>     public static BestPriceStruct copyLegMarkets(OrderBookSideStruct sideStruct, Side side)</TD></TR><TR><TD CLASS="l">1486</TD><TD>     {</TD></TR><TR CLASS="z"><TD CLASS="l">1487</TD><TD>         BestPriceStruct bestPriceStruct = new BestPriceStruct(side);</TD></TR><TR CLASS="z"><TD CLASS="l">1488</TD><TD>         bestPriceStruct.bvcqMax = sideStruct.bestContingencyMaxVol;</TD></TR><TR CLASS="z"><TD CLASS="l">1489</TD><TD>         bestPriceStruct.bvcqMin = sideStruct.bestContingencyMinVol;</TD></TR><TR CLASS="z"><TD CLASS="l">1490</TD><TD>         bestPriceStruct.bp = PriceFactory.create(sideStruct.bestPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">1491</TD><TD>         bestPriceStruct.bq = sideStruct.bestPriceQuantity;</TD></TR><TR CLASS="z"><TD CLASS="l">1492</TD><TD>         bestPriceStruct.bvcOnTop = sideStruct.bestVolumeContingencyIsOnTop;</TD></TR><TR CLASS="z"><TD CLASS="l">1493</TD><TD>         bestPriceStruct.bvcOnlyOnTop = sideStruct.bestVolumeContingencyOnlyOnTop;</TD></TR><TR CLASS="z"><TD CLASS="l">1494</TD><TD>         bestPriceStruct.bvc = PriceFactory.create(sideStruct.bestVolumeContingencyPrice);</TD></TR><TR CLASS="z"><TD CLASS="l">1495</TD><TD>         bestPriceStruct.isNBBO = sideStruct.isNBBO;</TD></TR><TR CLASS="z"><TD CLASS="l">1496</TD><TD>         bestPriceStruct.isVcNBBO = sideStruct.isVolumeContingencyNBBO;</TD></TR><TR CLASS="z"><TD CLASS="l">1497</TD><TD>         bestPriceStruct.lastSale = PriceFactory.create(sideStruct.lastSale);</TD></TR><TR CLASS="z"><TD CLASS="l">1498</TD><TD>         bestPriceStruct.nbbo = PriceFactory.create(sideStruct.nbbo);</TD></TR><TR CLASS="z"><TD CLASS="l">1499</TD><TD>         bestPriceStruct.nbboVol = sideStruct.nbboVol;</TD></TR><TR CLASS="z"><TD CLASS="l">1500</TD><TD>         bestPriceStruct.productKey = sideStruct.productKey;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="49">1501</A></TD><TD>         return bestPriceStruct;</TD></TR><TR><TD CLASS="l">1502</TD><TD>     }</TD></TR><TR><TD CLASS="l">1503</TD><TD>     </TD></TR><TR><TD CLASS="l">1504</TD><TD>     protected static TradingProduct getTradingProduct(int productKey) throws DataValidationException {</TD></TR><TR CLASS="z"><TD CLASS="l">1505</TD><TD>         TradingProductHome tradingProductHome = getTradingProductHome();</TD></TR><TR><TD CLASS="l">1506</TD><TD>         try</TD></TR><TR><TD CLASS="l">1507</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1508</TD><TD>             if (tradingProductHome != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1509</TD><TD>                 TradingProduct tradingProduct = tradingProductHome.findByKey(productKey);</TD></TR><TR CLASS="z"><TD CLASS="l">1510</TD><TD>                 if (tradingProduct != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1511</TD><TD>                     return tradingProduct;</TD></TR><TR><TD CLASS="l">1512</TD><TD>                 }</TD></TR><TR><TD CLASS="l">1513</TD><TD>             }</TD></TR><TR><TD CLASS="l">1514</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1515</TD><TD>         catch (NotFoundException e)</TD></TR><TR><TD CLASS="l">1516</TD><TD>         {</TD></TR><TR CLASS="z"><TD CLASS="l">1517</TD><TD>             throw ExceptionBuilder.dataValidationException(&#34;Broker unable to find trading product for product: &#34; + productKey,</TD></TR><TR><TD CLASS="l">1518</TD><TD>                     DataValidationCodes.INVALID_PRODUCT);</TD></TR><TR CLASS="z"><TD CLASS="l">1519</TD><TD>         }</TD></TR><TR><TD CLASS="l">1520</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1521</TD><TD>         throw ExceptionBuilder.dataValidationException(&#34;Broker unable to find trading product for product: &#34; + productKey,</TD></TR><TR><TD CLASS="l"><A NAME="4a">1522</A></TD><TD>                                                        DataValidationCodes.INVALID_PRODUCT);</TD></TR><TR><TD CLASS="l">1523</TD><TD>     }</TD></TR><TR><TD CLASS="l">1524</TD><TD>     </TD></TR><TR><TD CLASS="l">1525</TD><TD>     protected static TradingProductHome getTradingProductHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">1526</TD><TD>         if (cachedTradingProductHome == null) {</TD></TR><TR><TD CLASS="l">1527</TD><TD>             try {</TD></TR><TR CLASS="z"><TD CLASS="l">1528</TD><TD>                 cachedTradingProductHome = (TradingProductHome) HomeFactory.getInstance().findHome(TradingProductHome.HOME_NAME);</TD></TR><TR><TD CLASS="l">1529</TD><TD>             }</TD></TR><TR CLASS="z"><TD CLASS="l">1530</TD><TD>             catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1531</TD><TD>                 Log.alarm(&#34;BrokerProcessorBase &gt;&gt;&gt; Exception occured finding TradingProductHome&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1532</TD><TD>             }</TD></TR><TR><TD CLASS="l">1533</TD><TD>         }</TD></TR><TR CLASS="z"><TD CLASS="l">1534</TD><TD>         return cachedTradingProductHome;</TD></TR><TR><TD CLASS="l"><A NAME="4d">1535</A></TD><TD>     }</TD></TR><TR><TD CLASS="l">1536</TD><TD>     </TD></TR><TR><TD CLASS="l">1537</TD><TD>    public static boolean isLeggingAllowed(TradingProduct product, List&lt;Tradable&gt; orders)</TD></TR><TR><TD CLASS="l">1538</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1539</TD><TD>        boolean isLeggingAllowed = false;</TD></TR><TR CLASS="z"><TD CLASS="l">1540</TD><TD>        if(product.getShortSellTriggerMode())</TD></TR><TR><TD CLASS="l">1541</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1542</TD><TD>                for(Tradable tradable : orders)</TD></TR><TR><TD CLASS="l">1543</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">1544</TD><TD>                    Order order = (Order)tradable;</TD></TR><TR CLASS="z"><TD CLASS="l">1545</TD><TD>                    for(LegOrderDetail  legDetail : order.getLegOrderDetails())</TD></TR><TR><TD CLASS="l">1546</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">1547</TD><TD>                            TradingProduct tradingProduct = null ;</TD></TR><TR><TD CLASS="l">1548</TD><TD>                            try</TD></TR><TR><TD CLASS="l">1549</TD><TD>                            {</TD></TR><TR CLASS="z"><TD CLASS="l">1550</TD><TD>                                tradingProduct = getTradingProduct(legDetail.getProductKey());</TD></TR><TR CLASS="z"><TD CLASS="l">1551</TD><TD>                            }catch (DataValidationException dve){</TD></TR><TR CLASS="z"><TD CLASS="l">1552</TD><TD>                            }</TD></TR><TR CLASS="z"><TD CLASS="l">1553</TD><TD>                            if(tradingProduct == null &amp;&amp; legDetail.getSideValue() == Sides.BUY)</TD></TR><TR><TD CLASS="l">1554</TD><TD>                            {</TD></TR><TR CLASS="z"><TD CLASS="l">1555</TD><TD>                                    isLeggingAllowed = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1556</TD><TD>                                break;</TD></TR><TR><TD CLASS="l">1557</TD><TD>                            }</TD></TR><TR><TD CLASS="l">1558</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">1559</TD><TD>                }</TD></TR><TR><TD CLASS="l">1560</TD><TD>        }</TD></TR><TR><TD CLASS="l">1561</TD><TD>        else {</TD></TR><TR CLASS="z"><TD CLASS="l">1562</TD><TD>            isLeggingAllowed = true;</TD></TR><TR><TD CLASS="l">1563</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1564</TD><TD>        if(!isLeggingAllowed)</TD></TR><TR><TD CLASS="l">1565</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">1566</TD><TD>            Log.information(&#34;BrokerProcessorSpreadImpl(): tradewithLeg can't trade with leg because short sell trigger mode is ON&#34;);</TD></TR><TR><TD CLASS="l">1567</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1568</TD><TD>        return isLeggingAllowed;</TD></TR><TR><TD CLASS="l">1569</TD><TD> </TD></TR><TR><TD CLASS="l">1570</TD><TD>     }</TD></TR><TR><TD CLASS="l">1571</TD><TD> </TD></TR><TR><TD CLASS="l">1572</TD><TD>  </TD></TR><TR><TD CLASS="l">1573</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="nv">[<A HREF="../coverage.html">all classes</A>][<A HREF="5a.html">com.cboe.businessServices.tradeService</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.0.5312</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>