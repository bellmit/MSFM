<HTML><HEAD><META CONTENT="text/html; charset=ISO-8859-1" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Mon May 16 15:10:41 CDT 2011)</TH></TR><TR><TD CLASS="nv">[<A HREF="../coverage.html">all classes</A>][<A HREF="5e.html">com.cboe.businessServices.allocationService</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">SALAllocationStrategy.java</SPAN>]</H2><TABLE CELLSPACING="0" WIDTH="100%"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>SALAllocationStrategy.java</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/14)</TD><TD CLASS="h">0%   (0/1034)</TD><TD CLASS="h">0%   (0/214)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">SALAllocationStrategy</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/14)</TD><TD CLASS="h">0%   (0/1034)</TD><TD CLASS="h">0%   (0/214)</TD></TR><TR><TD CLASS="f"><A HREF="#0">&lt;static initializer&gt;</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">SALAllocationStrategy (AllocationAlgorithm): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#3">addToQCappedTradables (Tradable, long): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4">allocate (TradingClass, TradableList, int, AllocationContext): ParticipantList</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/224)</TD><TD CLASS="h">0%   (0/38)</TD></TR><TR><TD CLASS="f"><A HREF="#5">allocateToGroupsWithLR (ArrayList, AllocationAlgorithmGroup): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/42)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6">doBetterOfQMAorDpmComplexRightsAllocation (ParticipantList, int, TradingClass...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/100)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR><TD CLASS="f"><A HREF="#7">doBetterOfQMAorPreferredMMAllocation (ParticipantList, int, TradingClass, All...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/98)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">findGroupsWithLargerDPMAllocations (AllocationAlgorithmGroup, AllocationAlgor...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/93)</TD><TD CLASS="h">0%   (0/21)</TD></TR><TR><TD CLASS="f"><A HREF="#9">getCapDetails (AllocationContext): HashMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/53)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a">getPreferredAllocationForQMA (AllocationAlgorithmGroup): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/55)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR><TD CLASS="f"><A HREF="#b">getPrefferdSizeUsingRighsGroupAllocation (AllocationAlgorithmGroup, Allocatio...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/54)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">groupTradablesByPriority (TradableList, List, TradingClass, ParticipantList, ...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/243)</TD><TD CLASS="h">0%   (0/55)</TD></TR><TR><TD CLASS="f"><A HREF="#d">isDPMItem (Tradable, TradingClass): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#e">isEDPMItem (Tradable, TradingClass): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/2)</TD></TR></TABLE><P></P><TABLE CLASS="s" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="l">1</TD><TD>package com.cboe.businessServices.allocationService;</TD></TR><TR><TD CLASS="l">2</TD><TD> </TD></TR><TR><TD CLASS="l">3</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">4</TD><TD>import java.util.Enumeration;</TD></TR><TR><TD CLASS="l">5</TD><TD>import java.util.HashMap;</TD></TR><TR><TD CLASS="l">6</TD><TD>import java.util.Iterator;</TD></TR><TR><TD CLASS="l">7</TD><TD>import java.util.List;</TD></TR><TR><TD CLASS="l">8</TD><TD>import java.util.Map;</TD></TR><TR><TD CLASS="l">9</TD><TD> </TD></TR><TR><TD CLASS="l">10</TD><TD>import com.cboe.businessServices.tradeService.ParticipantListImpl;</TD></TR><TR><TD CLASS="l">11</TD><TD>import com.cboe.businessServices.tradeService.ParticipantListSortedImpl;</TD></TR><TR><TD CLASS="l">12</TD><TD>import com.cboe.businessServices.tradeService.SALParticipantItemImpl;</TD></TR><TR><TD CLASS="l">13</TD><TD>import com.cboe.infrastructureServices.foundationFramework.utilities.Log;</TD></TR><TR><TD CLASS="l">14</TD><TD>import com.cboe.interfaces.businessServices.AllocationAlgorithm;</TD></TR><TR><TD CLASS="l">15</TD><TD>import com.cboe.interfaces.businessServices.AllocationContext;</TD></TR><TR><TD CLASS="l">16</TD><TD>import com.cboe.interfaces.domain.ParticipantItem;</TD></TR><TR><TD CLASS="l">17</TD><TD>import com.cboe.interfaces.domain.ParticipantList;</TD></TR><TR><TD CLASS="l">18</TD><TD>import com.cboe.interfaces.domain.Tradable;</TD></TR><TR><TD CLASS="l">19</TD><TD>import com.cboe.interfaces.domain.TradableList;</TD></TR><TR><TD CLASS="l">20</TD><TD>import com.cboe.interfaces.domain.TradingClass;</TD></TR><TR><TD CLASS="l">21</TD><TD> </TD></TR><TR><TD CLASS="l">22</TD><TD>/**</TD></TR><TR><TD CLASS="l">23</TD><TD> * This class implements SAL Auction Allocation Strategy</TD></TR><TR><TD CLASS="l">24</TD><TD> *  This Allocation algorithms allocate in following way -</TD></TR><TR><TD CLASS="l">25</TD><TD> *      - first; allocate customer</TD></TR><TR><TD CLASS="l">26</TD><TD> *      - second; allocate the tradables by originally topOfBookQuoters -</TD></TR><TR><TD CLASS="l">27</TD><TD> *          - if PreferredMM specified and present at this price point, allocate betterOfPreferredOrQMA</TD></TR><TR><TD CLASS="l">28</TD><TD> *          - if No PreferredMM present, then allocate using betterOfDpmComplexOrQMA</TD></TR><TR><TD CLASS="l">29</TD><TD> *      - third; allocate the tradables by non topOfBookQuoters when Auction started using CUMA</TD></TR><TR><TD CLASS="l">30</TD><TD> *      - fourth; allocate contingenent</TD></TR><TR><TD CLASS="l">31</TD><TD> */</TD></TR><TR><TD CLASS="l">32</TD><TD> </TD></TR><TR><TD CLASS="l">33</TD><TD>public class SALAllocationStrategy extends AbstractAllocationStrategy</TD></TR><TR><TD CLASS="l"><A NAME="0">34</A></TD><TD>{</TD></TR><TR CLASS="z"><TD CLASS="l">35</TD><TD>    private PreferredMMRightsAllocationAlgorithm preferredMMAllocationAlgorithm = new PreferredMMRightsAllocationAlgorithm();</TD></TR><TR CLASS="z"><TD CLASS="l">36</TD><TD>    private QMAAllocationAlgorithm qmaAllocationAlgorithm = new QMAAllocationAlgorithm();</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2">37</A></TD><TD>    private DpmComplexRightsAllocationAlgorithm dpmComplexRightsAllocationAlgorithm = new DpmComplexRightsAllocationAlgorithm();</TD></TR><TR CLASS="z"><TD CLASS="l">38</TD><TD>    protected static AllocationAlgorithm reserveOrderAlgorithm = null;</TD></TR><TR><TD CLASS="l">39</TD><TD> </TD></TR><TR><TD CLASS="l">40</TD><TD>    public SALAllocationStrategy(AllocationAlgorithm p_reserveOrderAlgorithm)</TD></TR><TR CLASS="z"><TD CLASS="l">41</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">42</TD><TD>        reserveOrderAlgorithm = p_reserveOrderAlgorithm;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="4">43</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">44</TD><TD> </TD></TR><TR><TD CLASS="l">45</TD><TD>    public ParticipantList allocate(TradingClass tradingClass, TradableList tradables, int quantity, AllocationContext context)</TD></TR><TR><TD CLASS="l">46</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">47</TD><TD>        ParticipantListImpl resultList = new ParticipantListImpl();</TD></TR><TR CLASS="z"><TD CLASS="l">48</TD><TD>        ParticipantList customerPL = new ParticipantListSortedImpl();</TD></TR><TR CLASS="z"><TD CLASS="l">49</TD><TD>        ParticipantList nonCustomerQCappedTradables = new ParticipantListImpl();</TD></TR><TR CLASS="z"><TD CLASS="l">50</TD><TD>        ParticipantList nonCustomerTradables = new ParticipantListImpl();</TD></TR><TR CLASS="z"><TD CLASS="l">51</TD><TD>        ParticipantList volumeContingencyPL = new ParticipantListImpl();</TD></TR><TR CLASS="z"><TD CLASS="l">52</TD><TD>        ParticipantList reserveOrderPL = new ParticipantListImpl();</TD></TR><TR><TD CLASS="l">53</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">54</TD><TD>        List preferredMMList = context.getPreferredFirm();</TD></TR><TR CLASS="z"><TD CLASS="l">55</TD><TD>        boolean atleastOnePreferredMMPresent = groupTradablesByPriority(tradables, preferredMMList, tradingClass, customerPL,</TD></TR><TR><TD CLASS="l">56</TD><TD>                                                    nonCustomerQCappedTradables, nonCustomerTradables, volumeContingencyPL, context);</TD></TR><TR CLASS="z"><TD CLASS="l">57</TD><TD>        if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">58</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">59</TD><TD>            Log.debug(&#34;SALAllocationStrategy::allocate, preferredMMPresent?&#34; + atleastOnePreferredMMPresent +</TD></TR><TR><TD CLASS="l">60</TD><TD>                        &#34;, total participants=&#34; + tradables.size() + &#34; -&gt; customers:&#34; + customerPL.size() + &#34;, preferredMMs:&#34; + preferredMMList.size() +</TD></TR><TR><TD CLASS="l">61</TD><TD>                        &#34;, qmaParticipants:&#34; + nonCustomerQCappedTradables.size() + &#34;, cumaParticipants:&#34; + nonCustomerTradables.size() +</TD></TR><TR><TD CLASS="l">62</TD><TD>                        &#34;, contingentParticipants:&#34; + volumeContingencyPL.size() + &#34; volumeConstraint=&#34; + quantity);</TD></TR><TR><TD CLASS="l">63</TD><TD>        }</TD></TR><TR><TD CLASS="l">64</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">65</TD><TD>        int allocatedQuantity = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">66</TD><TD>        int qty = 0;</TD></TR><TR><TD CLASS="l">67</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">68</TD><TD>        allocatedQuantity = doOrderedAllocation(customerPL, quantity, tradingClass);</TD></TR><TR CLASS="z"><TD CLASS="l">69</TD><TD>            quantity = quantity - allocatedQuantity; </TD></TR><TR><TD CLASS="l">70</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">71</TD><TD>        if (atleastOnePreferredMMPresent)</TD></TR><TR><TD CLASS="l">72</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">73</TD><TD>            qty = doBetterOfQMAorPreferredMMAllocation(nonCustomerQCappedTradables, quantity, tradingClass, context);</TD></TR><TR><TD CLASS="l">74</TD><TD>        }</TD></TR><TR><TD CLASS="l">75</TD><TD>        else</TD></TR><TR><TD CLASS="l">76</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">77</TD><TD>            qty = doBetterOfQMAorDpmComplexRightsAllocation(nonCustomerQCappedTradables, quantity, tradingClass, context);</TD></TR><TR><TD CLASS="l">78</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">79</TD><TD>        allocatedQuantity = allocatedQuantity + qty;</TD></TR><TR CLASS="z"><TD CLASS="l">80</TD><TD>        quantity = quantity - qty;</TD></TR><TR><TD CLASS="l">81</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">82</TD><TD>               qty = doCUMAAllocation(nonCustomerTradables, quantity, tradingClass, context);</TD></TR><TR CLASS="z"><TD CLASS="l">83</TD><TD>               allocatedQuantity = allocatedQuantity + qty;</TD></TR><TR CLASS="z"><TD CLASS="l">84</TD><TD>               quantity = quantity - qty;</TD></TR><TR><TD CLASS="l">85</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">86</TD><TD>        groupReserveOrders(new ParticipantList[] {customerPL, nonCustomerQCappedTradables, nonCustomerTradables, volumeContingencyPL}, reserveOrderPL);</TD></TR><TR CLASS="z"><TD CLASS="l">87</TD><TD>        qty = doReserveAllocation(reserveOrderAlgorithm, reserveOrderPL, quantity, tradingClass);</TD></TR><TR CLASS="z"><TD CLASS="l">88</TD><TD>        allocatedQuantity = allocatedQuantity + qty;</TD></TR><TR CLASS="z"><TD CLASS="l">89</TD><TD>        quantity = quantity - qty;</TD></TR><TR><TD CLASS="l">90</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">91</TD><TD>               qty = doVolumeContingencyAllocation(volumeContingencyPL, quantity, tradingClass);</TD></TR><TR CLASS="z"><TD CLASS="l">92</TD><TD>               allocatedQuantity = allocatedQuantity + qty;</TD></TR><TR CLASS="z"><TD CLASS="l">93</TD><TD>               quantity = quantity - qty;</TD></TR><TR><TD CLASS="l">94</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">95</TD><TD>        merge(resultList, customerPL);</TD></TR><TR CLASS="z"><TD CLASS="l">96</TD><TD>        merge(resultList, nonCustomerQCappedTradables);</TD></TR><TR CLASS="z"><TD CLASS="l">97</TD><TD>        merge(resultList, nonCustomerTradables);</TD></TR><TR CLASS="z"><TD CLASS="l">98</TD><TD>        merge(resultList, volumeContingencyPL);</TD></TR><TR><TD CLASS="l">99</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">100</TD><TD>        if (resultList.size() &gt; 0)</TD></TR><TR><TD CLASS="l">101</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">102</TD><TD>            resultList.getLastParticipant().linkParticipant(null);</TD></TR><TR><TD CLASS="l">103</TD><TD>        }</TD></TR><TR><TD CLASS="l">104</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">105</TD><TD>        if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">106</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">107</TD><TD>            Log.debug(&#34;SALAllocationStrategy::allocate returning resultList &#34; + resultList);</TD></TR><TR><TD CLASS="l">108</TD><TD>        }</TD></TR><TR><TD CLASS="l">109</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">110</TD><TD>        return resultList;</TD></TR><TR><TD CLASS="l"><A NAME="9">111</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">112</TD><TD> </TD></TR><TR><TD CLASS="l">113</TD><TD>    protected HashMap getCapDetails(AllocationContext context)</TD></TR><TR><TD CLASS="l">114</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">115</TD><TD>        HashMap capDetails = null;</TD></TR><TR CLASS="z"><TD CLASS="l">116</TD><TD>        if (null != context){</TD></TR><TR CLASS="z"><TD CLASS="l">117</TD><TD>            Object cap = context.getContext(AllocationContext.CAP_QUANTITY_BY_ACR);</TD></TR><TR CLASS="z"><TD CLASS="l">118</TD><TD>            if (null != cap){</TD></TR><TR CLASS="z"><TD CLASS="l">119</TD><TD>                capDetails = (HashMap) cap;</TD></TR><TR><TD CLASS="l">120</TD><TD>            }</TD></TR><TR><TD CLASS="l">121</TD><TD>        }</TD></TR><TR><TD CLASS="l">122</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">123</TD><TD>        if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">124</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">125</TD><TD>            StringBuffer toStr = new StringBuffer(&#34;SALAllocationStrategy::getCapDetails, found &#34; + capDetails.size() + &#34; qmaParticipants: &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">126</TD><TD>            Iterator iter = capDetails.keySet().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">127</TD><TD>            while(iter.hasNext()){</TD></TR><TR CLASS="z"><TD CLASS="l">128</TD><TD>                toStr.append((String)iter.next()).append(&#34;, &#34;);</TD></TR><TR><TD CLASS="l">129</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">130</TD><TD>            Log.debug(toStr.toString());</TD></TR><TR><TD CLASS="l">131</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">132</TD><TD>        return capDetails;</TD></TR><TR><TD CLASS="l">133</TD><TD>    }</TD></TR><TR><TD CLASS="l">134</TD><TD> </TD></TR><TR><TD CLASS="l">135</TD><TD>    private boolean groupTradablesByPriority(TradableList tradableList,</TD></TR><TR><TD CLASS="l">136</TD><TD>                                          List preferredList,</TD></TR><TR><TD CLASS="l">137</TD><TD>                                          TradingClass tradingClass,</TD></TR><TR><TD CLASS="l">138</TD><TD>                                          ParticipantList customerTradables,</TD></TR><TR><TD CLASS="l">139</TD><TD>                                          ParticipantList nonCustomerQCappedTradables,</TD></TR><TR><TD CLASS="l"><A NAME="c">140</A></TD><TD>                                          ParticipantList nonCustomerTradables,</TD></TR><TR><TD CLASS="l">141</TD><TD>                                          ParticipantList volumeContingencyTradables,</TD></TR><TR><TD CLASS="l">142</TD><TD>                                          AllocationContext context)</TD></TR><TR><TD CLASS="l">143</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">144</TD><TD>        HashMap capDetails = getCapDetails(context);</TD></TR><TR CLASS="z"><TD CLASS="l">145</TD><TD>        long auctionStartTime = ((Long)context.getContext(AllocationContext.AUCTION_START_TIME)).longValue();</TD></TR><TR CLASS="z"><TD CLASS="l">146</TD><TD>        String affiliatedFirmAtThisPricePoint = NO_PREFERRED_MM;</TD></TR><TR CLASS="z"><TD CLASS="l">147</TD><TD>        if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">148</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">149</TD><TD>            Log.debug(&#34;SALAllocationStrategy::groupTradablesByPriority total participants:&#34; + tradableList.size());</TD></TR><TR><TD CLASS="l">150</TD><TD>        }</TD></TR><TR><TD CLASS="l">151</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">152</TD><TD>        Map&lt;String, Integer&gt; remainingCapQtyMap = new HashMap&lt;String, Integer&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">153</TD><TD>                for (int i = 0, n = tradableList.size(); i &lt; n; i++)</TD></TR><TR><TD CLASS="l">154</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">155</TD><TD>                Tradable tradable = tradableList.get(i);</TD></TR><TR CLASS="z"><TD CLASS="l">156</TD><TD>                ParticipantItem participantItem = new SALParticipantItemImpl(tradable, 0);</TD></TR><TR><TD CLASS="l">157</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">158</TD><TD>            if (tradable.hasVolumeContingency()) // Contingency Tradables</TD></TR><TR><TD CLASS="l">159</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">160</TD><TD>                volumeContingencyTradables.addElement(participantItem);</TD></TR><TR><TD CLASS="l">161</TD><TD>            }</TD></TR><TR><TD CLASS="l">162</TD><TD>            else</TD></TR><TR><TD CLASS="l">163</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">164</TD><TD>                if (tradable.treatedLikeCustomer()) // Customer Order</TD></TR><TR><TD CLASS="l">165</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">166</TD><TD>                    customerTradables.addElement(participantItem);</TD></TR><TR><TD CLASS="l">167</TD><TD>                }</TD></TR><TR><TD CLASS="l">168</TD><TD>                else</TD></TR><TR><TD CLASS="l">169</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">170</TD><TD>                    String acrKey = getAllocationGroupId(tradable.getOriginatorAcronym());</TD></TR><TR CLASS="z"><TD CLASS="l">171</TD><TD>                    boolean isPMM = false;</TD></TR><TR><TD CLASS="l">172</TD><TD>                    //there can be only one preferred mm selected at a price point in allocation, even though multiples present</TD></TR><TR CLASS="z"><TD CLASS="l">173</TD><TD>                    if (affiliatedFirmAtThisPricePoint.equals(NO_PREFERRED_MM))</TD></TR><TR><TD CLASS="l">174</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">175</TD><TD>                        isPMM = isPreferred(preferredList, tradable);</TD></TR><TR CLASS="z"><TD CLASS="l">176</TD><TD>                        affiliatedFirmAtThisPricePoint = isPMM==true ? getAffiliatedFirm(tradable.getOriginatorAcronym()) : affiliatedFirmAtThisPricePoint;</TD></TR><TR><TD CLASS="l">177</TD><TD>                    }</TD></TR><TR><TD CLASS="l">178</TD><TD>                    else</TD></TR><TR><TD CLASS="l">179</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">180</TD><TD>                        isPMM = isThisAcrPreferred(tradable.getOriginatorAcronym().acronym, affiliatedFirmAtThisPricePoint);</TD></TR><TR><TD CLASS="l">181</TD><TD>                    }</TD></TR><TR><TD CLASS="l">182</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">183</TD><TD>                    boolean isDPM = isDPMItem(tradable, tradingClass);</TD></TR><TR CLASS="z"><TD CLASS="l">184</TD><TD>                    boolean isEDPM = isEDPMItem(tradable, tradingClass);</TD></TR><TR><TD CLASS="l">185</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">186</TD><TD>                    markParticipantItem(participantItem, isPMM, isDPM, isEDPM);</TD></TR><TR CLASS="z"><TD CLASS="l">187</TD><TD>                    participantItem.setAllowedQuantity(tradable.getDisplayQuantity());</TD></TR><TR><TD CLASS="l">188</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">189</TD><TD>                    if (capDetails.containsKey(acrKey)) //i.e. this user had quote in the mkt before auction</TD></TR><TR><TD CLASS="l">190</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">191</TD><TD>                        if (addToQCappedTradables(tradable, auctionStartTime)) //a special case, look at the comment of method</TD></TR><TR><TD CLASS="l">192</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">193</TD><TD>                            nonCustomerQCappedTradables.addElement(participantItem);</TD></TR><TR CLASS="z"><TD CLASS="l">194</TD><TD>                            continue;</TD></TR><TR><TD CLASS="l">195</TD><TD>                        }</TD></TR><TR><TD CLASS="l">196</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">197</TD><TD>                        Integer anInt = (Integer)remainingCapQtyMap.get(acrKey);</TD></TR><TR CLASS="z"><TD CLASS="l">198</TD><TD>                        int leftQtyToReachCap = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">199</TD><TD>                        int participantQtyToUse = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">200</TD><TD>                        int tradableRemainingQty = 0;</TD></TR><TR><TD CLASS="l">201</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">202</TD><TD>                        if (null != anInt){</TD></TR><TR CLASS="z"><TD CLASS="l">203</TD><TD>                            leftQtyToReachCap = anInt.intValue();</TD></TR><TR><TD CLASS="l">204</TD><TD>                        }else{</TD></TR><TR CLASS="z"><TD CLASS="l">205</TD><TD>                            leftQtyToReachCap = ((Integer)capDetails.get(acrKey)).intValue();</TD></TR><TR><TD CLASS="l">206</TD><TD>                        }</TD></TR><TR><TD CLASS="l">207</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">208</TD><TD>                        if (leftQtyToReachCap &gt; 0)</TD></TR><TR><TD CLASS="l">209</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">210</TD><TD>                            participantQtyToUse = tradable.getDisplayQuantity() &gt; leftQtyToReachCap ?</TD></TR><TR><TD CLASS="l">211</TD><TD>                                                    leftQtyToReachCap : tradable.getDisplayQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">212</TD><TD>                            participantItem.setAllowedQuantity(participantQtyToUse);//override default</TD></TR><TR><TD CLASS="l">213</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">214</TD><TD>                            nonCustomerQCappedTradables.addElement(participantItem);</TD></TR><TR><TD CLASS="l">215</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">216</TD><TD>                            Integer updatedLeftQtyToReachCapInt = new Integer(leftQtyToReachCap - participantQtyToUse);</TD></TR><TR CLASS="z"><TD CLASS="l">217</TD><TD>                            remainingCapQtyMap.put(acrKey, updatedLeftQtyToReachCapInt);</TD></TR><TR><TD CLASS="l">218</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">219</TD><TD>                            tradableRemainingQty = tradable.getDisplayQuantity() - participantQtyToUse;</TD></TR><TR CLASS="z"><TD CLASS="l">220</TD><TD>                            if (tradableRemainingQty &gt; 0)</TD></TR><TR><TD CLASS="l">221</TD><TD>                            {</TD></TR><TR CLASS="z"><TD CLASS="l">222</TD><TD>                                participantItem = new SALParticipantItemImpl(tradable, 0);</TD></TR><TR CLASS="z"><TD CLASS="l">223</TD><TD>                                participantItem.setAllowedQuantity(tradableRemainingQty);</TD></TR><TR CLASS="z"><TD CLASS="l">224</TD><TD>                                markParticipantItem(participantItem, isPMM, isDPM, isEDPM);</TD></TR><TR><TD CLASS="l">225</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">226</TD><TD>                                nonCustomerTradables.addElement(participantItem);</TD></TR><TR><TD CLASS="l">227</TD><TD>                            }</TD></TR><TR CLASS="z"><TD CLASS="l">228</TD><TD>                        }</TD></TR><TR><TD CLASS="l">229</TD><TD>                        else//for this Acronym the cap is fulfilled, this participant should be allocated using CUMA.</TD></TR><TR><TD CLASS="l">230</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">231</TD><TD>                            nonCustomerTradables.addElement(participantItem);</TD></TR><TR><TD CLASS="l">232</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">233</TD><TD>                    }</TD></TR><TR><TD CLASS="l">234</TD><TD>                    else //Acronym did not have quote on TOB</TD></TR><TR><TD CLASS="l">235</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">236</TD><TD>                        if (addToQCappedTradables(tradable, auctionStartTime))//a special case, look at the comment of method</TD></TR><TR><TD CLASS="l">237</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">238</TD><TD>                            nonCustomerQCappedTradables.addElement(participantItem);</TD></TR><TR><TD CLASS="l">239</TD><TD>                        }</TD></TR><TR><TD CLASS="l">240</TD><TD>                        else</TD></TR><TR><TD CLASS="l">241</TD><TD>                        {</TD></TR><TR CLASS="z"><TD CLASS="l">242</TD><TD>                            nonCustomerTradables.addElement(participantItem);</TD></TR><TR><TD CLASS="l">243</TD><TD>                        }</TD></TR><TR><TD CLASS="l">244</TD><TD>                    }</TD></TR><TR><TD CLASS="l">245</TD><TD>                }</TD></TR><TR><TD CLASS="l">246</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">247</TD><TD>            if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">248</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">249</TD><TD>                Log.debug(&#34;SALAllocationStrategy::groupTradablesByPriority ParticipantItem created:&#34; + participantItem);</TD></TR><TR><TD CLASS="l">250</TD><TD>            }</TD></TR><TR><TD CLASS="l">251</TD><TD>        }</TD></TR><TR><TD CLASS="l">252</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">253</TD><TD>        return !affiliatedFirmAtThisPricePoint.equals(NO_PREFERRED_MM);</TD></TR><TR><TD CLASS="l">254</TD><TD>    }</TD></TR><TR><TD CLASS="l">255</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="3">256</A></TD><TD>//The nonQ nonICM order size will not be considered to calculate the QMA cap for responders.</TD></TR><TR><TD CLASS="l">257</TD><TD>//The nonQ nonICM order sitting at top of book before SAL auction started, should be considered for QMA allocation at that price point.</TD></TR><TR><TD CLASS="l">258</TD><TD>    private boolean addToQCappedTradables(Tradable tradable, long auctionStartTime)</TD></TR><TR><TD CLASS="l">259</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">260</TD><TD>        if (!tradable.treatedLikeQuote() &amp;&amp; tradable.isBooked() &amp;&amp; (tradable.getBookedTime() &lt; auctionStartTime))//recd before SAL started</TD></TR><TR><TD CLASS="l">261</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">262</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">263</TD><TD>        }</TD></TR><TR><TD CLASS="l">264</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">265</TD><TD>        return false;</TD></TR><TR><TD CLASS="l">266</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="7">267</A></TD><TD> </TD></TR><TR><TD CLASS="l">268</TD><TD>    private int doBetterOfQMAorPreferredMMAllocation(ParticipantList participantList, int quantity,</TD></TR><TR><TD CLASS="l">269</TD><TD>                                                     TradingClass tradingClass, AllocationContext context)</TD></TR><TR><TD CLASS="l">270</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">271</TD><TD>        int allocatedQuantity = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">272</TD><TD>        if ((!participantList.isEmpty()) &amp;&amp; (quantity &gt; 0))</TD></TR><TR><TD CLASS="l">273</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">274</TD><TD>            AllocationAlgorithmGroup allocByRights = preferredMMAllocationAlgorithm.calculateAllocation(participantList, quantity, tradingClass, context);</TD></TR><TR CLASS="z"><TD CLASS="l">275</TD><TD>            AllocationAlgorithmGroup allocByQMA = qmaAllocationAlgorithm.calculateAllocation(participantList, quantity, tradingClass, context);</TD></TR><TR CLASS="z"><TD CLASS="l">276</TD><TD>            int preferredAllocQty = getPrefferdSizeUsingRighsGroupAllocation(allocByRights, allocByQMA);</TD></TR><TR CLASS="z"><TD CLASS="l">277</TD><TD>            if (preferredAllocQty &gt; 0)</TD></TR><TR><TD CLASS="l">278</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">279</TD><TD>                allocatedQuantity = preferredMMAllocationAlgorithm.allocate(participantList, preferredAllocQty, tradingClass, context);</TD></TR><TR CLASS="z"><TD CLASS="l">280</TD><TD>                quantity = quantity - allocatedQuantity;</TD></TR><TR CLASS="z"><TD CLASS="l">281</TD><TD>                if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">282</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">283</TD><TD>                    Log.debug(&#34;SALAllocationStrategy::doBetterOfQMAorPreferredMMAllocation, applied Preferred Allocation. allocatedQty: &#34; + allocatedQuantity);</TD></TR><TR><TD CLASS="l">284</TD><TD>                }</TD></TR><TR><TD CLASS="l">285</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">286</TD><TD>                if (quantity &gt; 0)//QMA Rest of them.</TD></TR><TR><TD CLASS="l">287</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">288</TD><TD>                    allocatedQuantity += qmaAllocationAlgorithm.allocate(participantList, quantity, tradingClass, context);</TD></TR><TR CLASS="z"><TD CLASS="l">289</TD><TD>                    if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">290</TD><TD>                    {</TD></TR><TR CLASS="z"><TD CLASS="l">291</TD><TD>                        Log.debug(&#34;SALAllocationStrategy::doBetterOfQMAorPreferredMMAllocation, applied Preferred and then QMA Allocation. combinedAllocatedQty: &#34; + allocatedQuantity);</TD></TR><TR><TD CLASS="l">292</TD><TD>                    }</TD></TR><TR><TD CLASS="l">293</TD><TD>                }</TD></TR><TR><TD CLASS="l">294</TD><TD>            }</TD></TR><TR><TD CLASS="l">295</TD><TD>            else//QMA is better</TD></TR><TR><TD CLASS="l">296</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">297</TD><TD>                allocatedQuantity = qmaAllocationAlgorithm.allocate(participantList, quantity, tradingClass, context);</TD></TR><TR CLASS="z"><TD CLASS="l">298</TD><TD>                if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">299</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">300</TD><TD>                    Log.debug(&#34;SALAllocationStrategy::doBetterOfQMAorPreferredMMAllocation, applied only QMA Allocation. allocatedQty: &#34; + allocatedQuantity);</TD></TR><TR><TD CLASS="l">301</TD><TD>                }</TD></TR><TR><TD CLASS="l">302</TD><TD>            }</TD></TR><TR><TD CLASS="l">303</TD><TD>        }</TD></TR><TR><TD CLASS="l">304</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">305</TD><TD>        return allocatedQuantity;</TD></TR><TR><TD CLASS="l">306</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="6">307</A></TD><TD> </TD></TR><TR><TD CLASS="l">308</TD><TD>    private int doBetterOfQMAorDpmComplexRightsAllocation(ParticipantList participantList, int quantity,</TD></TR><TR><TD CLASS="l">309</TD><TD>                                                          TradingClass tradingClass, AllocationContext context)</TD></TR><TR><TD CLASS="l">310</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">311</TD><TD>        int allocatedQuantity = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">312</TD><TD>        int qToBeAllocated = quantity;</TD></TR><TR CLASS="z"><TD CLASS="l">313</TD><TD>        if ((!participantList.isEmpty()) &amp;&amp; (quantity &gt; 0))</TD></TR><TR><TD CLASS="l">314</TD><TD>        {</TD></TR><TR><TD CLASS="l">315</TD><TD>            AllocationAlgorithmGroup allocByQma;</TD></TR><TR><TD CLASS="l">316</TD><TD>            ArrayList groupsWithLR;</TD></TR><TR><TD CLASS="l">317</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">318</TD><TD>            AllocationAlgorithmGroup allocByRights = dpmComplexRightsAllocationAlgorithm.calculateAllocation(participantList, qToBeAllocated,</TD></TR><TR><TD CLASS="l">319</TD><TD>                                                                                                    tradingClass, context);</TD></TR><TR CLASS="z"><TD CLASS="l">320</TD><TD>            Enumeration participantEnum = participantList.elements();</TD></TR><TR CLASS="z"><TD CLASS="l">321</TD><TD>            boolean doCompare = allocByRights.getAllocatedQuantity() &gt; 0;</TD></TR><TR><TD CLASS="l">322</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">323</TD><TD>            while ( doCompare &amp;&amp; participantEnum.hasMoreElements())</TD></TR><TR><TD CLASS="l">324</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">325</TD><TD>                allocByQma = qmaAllocationAlgorithm.calculateAllocation(participantList, qToBeAllocated, tradingClass, context);</TD></TR><TR CLASS="z"><TD CLASS="l">326</TD><TD>                groupsWithLR = findGroupsWithLargerDPMAllocations(allocByRights,allocByQma);</TD></TR><TR CLASS="z"><TD CLASS="l">327</TD><TD>                if (groupsWithLR.size() &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">328</TD><TD>                    allocatedQuantity = allocateToGroupsWithLR(groupsWithLR, allocByRights);</TD></TR><TR CLASS="z"><TD CLASS="l">329</TD><TD>                    qToBeAllocated = qToBeAllocated - allocatedQuantity;</TD></TR><TR><TD CLASS="l">330</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">331</TD><TD>                doCompare = groupsWithLR.size() &gt; 0;</TD></TR><TR><TD CLASS="l">332</TD><TD>            }</TD></TR><TR><TD CLASS="l">333</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">334</TD><TD>            participantEnum = participantList.elements();</TD></TR><TR CLASS="z"><TD CLASS="l">335</TD><TD>            if (qToBeAllocated &gt; 0 &amp;&amp; participantEnum.hasMoreElements()){</TD></TR><TR CLASS="z"><TD CLASS="l">336</TD><TD>                allocatedQuantity += qmaAllocationAlgorithm.allocate(participantList, qToBeAllocated, tradingClass, context);</TD></TR><TR><TD CLASS="l">337</TD><TD>            }</TD></TR><TR><TD CLASS="l">338</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">339</TD><TD>            if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">340</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">341</TD><TD>                Log.debug(&#34;SALAllocationStrategy::doBetterOfQMAorDpmComplexRightsAllocation, quantityToAllocate:&#34; + quantity +</TD></TR><TR><TD CLASS="l">342</TD><TD>                            &#34; after allocation allocatedQty:&#34; + allocatedQuantity);</TD></TR><TR><TD CLASS="l">343</TD><TD>            }</TD></TR><TR><TD CLASS="l">344</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">345</TD><TD>            return allocatedQuantity;</TD></TR><TR><TD CLASS="l"><A NAME="8">346</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">347</TD><TD> </TD></TR><TR><TD CLASS="l">348</TD><TD>    private ArrayList findGroupsWithLargerDPMAllocations(AllocationAlgorithmGroup aGroupRights, AllocationAlgorithmGroup aGroupByQMA)</TD></TR><TR><TD CLASS="l">349</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">350</TD><TD>        ArrayList result = new ArrayList();</TD></TR><TR CLASS="z"><TD CLASS="l">351</TD><TD>        Iterator keys = aGroupByQMA.getSubGroups().keySet().iterator();</TD></TR><TR><TD CLASS="l">352</TD><TD>        Object key;</TD></TR><TR><TD CLASS="l">353</TD><TD>        int qFromRights;</TD></TR><TR><TD CLASS="l">354</TD><TD>        int qFromQMA;</TD></TR><TR><TD CLASS="l">355</TD><TD>        AllocationAlgorithmGroup group1;</TD></TR><TR><TD CLASS="l">356</TD><TD>        AllocationAlgorithmGroup group2;</TD></TR><TR CLASS="z"><TD CLASS="l">357</TD><TD>        while (keys.hasNext())</TD></TR><TR><TD CLASS="l">358</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">359</TD><TD>            key = keys.next();</TD></TR><TR CLASS="z"><TD CLASS="l">360</TD><TD>            group1 = aGroupRights.getSubGroups(key);</TD></TR><TR CLASS="z"><TD CLASS="l">361</TD><TD>            group2 = aGroupByQMA.getSubGroups(key);</TD></TR><TR CLASS="z"><TD CLASS="l">362</TD><TD>            if (group1 == null){</TD></TR><TR CLASS="z"><TD CLASS="l">363</TD><TD>                qFromRights = 0;</TD></TR><TR><TD CLASS="l">364</TD><TD>            }</TD></TR><TR><TD CLASS="l">365</TD><TD>            else {</TD></TR><TR CLASS="z"><TD CLASS="l">366</TD><TD>                qFromRights = group1.getAllocatedQuantity();</TD></TR><TR><TD CLASS="l">367</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">368</TD><TD>            if (group2 == null){</TD></TR><TR CLASS="z"><TD CLASS="l">369</TD><TD>                qFromQMA = 0;</TD></TR><TR><TD CLASS="l">370</TD><TD>            }</TD></TR><TR><TD CLASS="l">371</TD><TD>            else {</TD></TR><TR CLASS="z"><TD CLASS="l">372</TD><TD>                qFromQMA = group2.getAllocatedQuantity();</TD></TR><TR><TD CLASS="l">373</TD><TD>            }</TD></TR><TR><TD CLASS="l">374</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">375</TD><TD>            if (qFromRights==0){</TD></TR><TR CLASS="z"><TD CLASS="l">376</TD><TD>                continue;</TD></TR><TR><TD CLASS="l">377</TD><TD>            }</TD></TR><TR><TD CLASS="l">378</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">379</TD><TD>            if (qFromRights &gt;= qFromQMA){</TD></TR><TR CLASS="z"><TD CLASS="l">380</TD><TD>                if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">381</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">382</TD><TD>                    Log.debug(&#34;SALAllocationStrategy::findGroupsWithLargerDPMAllocations, rights[&#34; + qFromRights + &#34;] &gt;= QMA[&#34; + qFromQMA +</TD></TR><TR><TD CLASS="l">383</TD><TD>                                &#34;] for key:&#34; + key);</TD></TR><TR><TD CLASS="l">384</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">385</TD><TD>                result.add(key);</TD></TR><TR><TD CLASS="l">386</TD><TD>            }</TD></TR><TR><TD CLASS="l">387</TD><TD>            else</TD></TR><TR><TD CLASS="l">388</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">389</TD><TD>                if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">390</TD><TD>                {</TD></TR><TR CLASS="z"><TD CLASS="l">391</TD><TD>                    Log.debug(&#34;SALAllocationStrategy::findGroupsWithLargerDPMAllocations, rights[&#34; + qFromRights + &#34;] &lt; QMA[&#34; + qFromQMA +</TD></TR><TR><TD CLASS="l">392</TD><TD>                                &#34;] for key:&#34; + key + &#34; skipping it, it will be allocated using QMA&#34;);</TD></TR><TR><TD CLASS="l">393</TD><TD>                }</TD></TR><TR><TD CLASS="l">394</TD><TD>            }</TD></TR><TR><TD CLASS="l">395</TD><TD>        }</TD></TR><TR><TD CLASS="l">396</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">397</TD><TD>        return result;</TD></TR><TR><TD CLASS="l"><A NAME="5">398</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">399</TD><TD> </TD></TR><TR><TD CLASS="l">400</TD><TD>    private int allocateToGroupsWithLR(ArrayList groupWithLR, AllocationAlgorithmGroup allocationByRights)</TD></TR><TR><TD CLASS="l">401</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">402</TD><TD>        Iterator groupIdItr = groupWithLR.iterator();</TD></TR><TR><TD CLASS="l">403</TD><TD>        String groupId;</TD></TR><TR><TD CLASS="l">404</TD><TD>        AllocationAlgorithmGroup tmpGroup;</TD></TR><TR><TD CLASS="l">405</TD><TD>        int quantity;</TD></TR><TR CLASS="z"><TD CLASS="l">406</TD><TD>        int totalAllocated = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">407</TD><TD>        while (groupIdItr.hasNext())</TD></TR><TR><TD CLASS="l">408</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">409</TD><TD>            groupId = (String) groupIdItr.next();</TD></TR><TR CLASS="z"><TD CLASS="l">410</TD><TD>            tmpGroup = allocationByRights.getSubGroups(groupId);</TD></TR><TR CLASS="z"><TD CLASS="l">411</TD><TD>            quantity = tmpGroup.getAllocatedQuantity();</TD></TR><TR CLASS="z"><TD CLASS="l">412</TD><TD>            UMAAllocationAlgorithmAllocator.applyUMAAllocation(tmpGroup, quantity, 1.0); // equally distribution</TD></TR><TR CLASS="z"><TD CLASS="l">413</TD><TD>            totalAllocated = totalAllocated + quantity;</TD></TR><TR><TD CLASS="l">414</TD><TD>        }</TD></TR><TR><TD CLASS="l">415</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">416</TD><TD>        if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">417</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">418</TD><TD>            Log.debug(&#34;SALAllocationStrategy::allocateToGroupsWithLR totalAllocated:&#34; + totalAllocated);</TD></TR><TR><TD CLASS="l">419</TD><TD>        }</TD></TR><TR><TD CLASS="l">420</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">421</TD><TD>        return totalAllocated;</TD></TR><TR><TD CLASS="l"><A NAME="b">422</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">423</TD><TD> </TD></TR><TR><TD CLASS="l">424</TD><TD>    private int getPrefferdSizeUsingRighsGroupAllocation(AllocationAlgorithmGroup aGroupRights, AllocationAlgorithmGroup aGroupByQMA)</TD></TR><TR><TD CLASS="l">425</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">426</TD><TD>        int qFromQMA = getPreferredAllocationForQMA(aGroupByQMA);</TD></TR><TR CLASS="z"><TD CLASS="l">427</TD><TD>        int qFromRights = aGroupRights == null ? 0:aGroupRights.getAllocatedQuantity();</TD></TR><TR><TD CLASS="l">428</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">429</TD><TD>        if (qFromRights &gt;= qFromQMA)</TD></TR><TR><TD CLASS="l">430</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">431</TD><TD>            if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">432</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">433</TD><TD>                Log.debug(&#34;SALAllocationStrategy::getPrefferdSizeUsingRighsGroupAllocation rights[&#34; + qFromRights + &#34;] &gt;= QMA[&#34; + qFromQMA + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">434</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">435</TD><TD>            return qFromRights;</TD></TR><TR><TD CLASS="l">436</TD><TD>        }</TD></TR><TR><TD CLASS="l">437</TD><TD>        else</TD></TR><TR><TD CLASS="l">438</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">439</TD><TD>            if (Log.isDebugOn())</TD></TR><TR><TD CLASS="l">440</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">441</TD><TD>                Log.debug(&#34;SALAllocationStrategy::getPrefferdSizeUsingRighsGroupAllocation rights[&#34; + qFromRights + &#34;] &lt; QMA[&#34; + qFromQMA + &#34;]&#34; +</TD></TR><TR><TD CLASS="l">442</TD><TD>                            &#34;, it will be allocated using QMA &#34;);</TD></TR><TR><TD CLASS="l">443</TD><TD>            }</TD></TR><TR><TD CLASS="l">444</TD><TD>        }</TD></TR><TR><TD CLASS="l">445</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">446</TD><TD>        return 0;</TD></TR><TR><TD CLASS="l"><A NAME="d">447</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">448</TD><TD> </TD></TR><TR><TD CLASS="l">449</TD><TD>    public boolean isDPMItem(Tradable tradable, TradingClass tradingClass)</TD></TR><TR><TD CLASS="l">450</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">451</TD><TD>        boolean result = ( tradable.treatedLikeQuote()  || tradable .isAuctionResponse()) &amp;&amp;</TD></TR><TR><TD CLASS="l">452</TD><TD>                                                tradingClass.isDPM(tradable.getOriginatorAcronym());</TD></TR><TR CLASS="z"><TD CLASS="l">453</TD><TD>        return result;</TD></TR><TR><TD CLASS="l"><A NAME="e">454</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">455</TD><TD> </TD></TR><TR><TD CLASS="l">456</TD><TD>    public boolean isEDPMItem(Tradable tradable, TradingClass tradingClass)</TD></TR><TR><TD CLASS="l">457</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">458</TD><TD>        boolean result = ( tradable.treatedLikeQuote()  || tradable .isAuctionResponse()) &amp;&amp;</TD></TR><TR><TD CLASS="l">459</TD><TD>                                                tradingClass.isEDPM(tradable.getOriginatorAcronym());</TD></TR><TR CLASS="z"><TD CLASS="l">460</TD><TD>        return result;</TD></TR><TR><TD CLASS="l"><A NAME="a">461</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">462</TD><TD> </TD></TR><TR><TD CLASS="l">463</TD><TD>    private int getPreferredAllocationForQMA(AllocationAlgorithmGroup topGroup)</TD></TR><TR><TD CLASS="l">464</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">465</TD><TD>        int rtn = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">466</TD><TD>        HashMap umaGroups = topGroup.getSubGroups();</TD></TR><TR CLASS="z"><TD CLASS="l">467</TD><TD>        Iterator keys = umaGroups.keySet().iterator();</TD></TR><TR><TD CLASS="l">468</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">469</TD><TD>        while(keys.hasNext())</TD></TR><TR><TD CLASS="l">470</TD><TD>        {</TD></TR><TR CLASS="z"><TD CLASS="l">471</TD><TD>            Object key = keys.next();</TD></TR><TR CLASS="z"><TD CLASS="l">472</TD><TD>            AllocationAlgorithmGroup umaGroup = (AllocationAlgorithmGroup) umaGroups.get(key);</TD></TR><TR><TD CLASS="l">473</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">474</TD><TD>            HashMap leafGroups = umaGroup.getSubGroups();</TD></TR><TR CLASS="z"><TD CLASS="l">475</TD><TD>            Iterator leafKeys = leafGroups.keySet().iterator();</TD></TR><TR><TD CLASS="l">476</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">477</TD><TD>            while (leafKeys.hasNext())</TD></TR><TR><TD CLASS="l">478</TD><TD>            {</TD></TR><TR CLASS="z"><TD CLASS="l">479</TD><TD>                key = leafKeys.next();</TD></TR><TR CLASS="z"><TD CLASS="l">480</TD><TD>                AllocationAlgorithmGroup leafGroup = (AllocationAlgorithmGroup) leafGroups.get(key);</TD></TR><TR CLASS="z"><TD CLASS="l">481</TD><TD>                if (leafGroup.isLeafGroup() &amp;&amp; leafGroup.getParticipantItem().isItemPreferred()){</TD></TR><TR CLASS="z"><TD CLASS="l">482</TD><TD>                    rtn += umaGroup.getAllocatedQuantity();   //get the umagroup allocation qty and skip rest leaf group check for this umagroup</TD></TR><TR CLASS="z"><TD CLASS="l">483</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">484</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">485</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">486</TD><TD>        }</TD></TR><TR><TD CLASS="l">487</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">488</TD><TD>        return rtn;</TD></TR><TR><TD CLASS="l">489</TD><TD>    }    </TD></TR><TR><TD CLASS="l">490</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="nv">[<A HREF="../coverage.html">all classes</A>][<A HREF="5e.html">com.cboe.businessServices.allocationService</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.0.5312</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>